<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN">
<html>
  <head>
    <meta http-equiv="Content-type" content="text/html;charset=UTF-8">
    <title>Smalltalk.Sources.5.5k</title>
	<link rel="stylesheet" type="text/css" href="font.css"/>
  </head>
  <body>
    <div class="line left">
<span class="small">&rsquo;From Smalltalk 5.5k XM November 24 on 22 November 1980 at 2:57:08 am.&rsquo;<br></span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large">"Object"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;Object&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: nil<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;&rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>Object is the superclass of all classes.  It is an abstract class, meaning that it has no state, and its main function is to provide a foundation message protocol for its subclasses.  Three instances of this class are defined: nil, true, and false.</span></div>
<div class="line left">
<span class="bold large"><br>Comparison</span></div>
<div class="line left">
<span class="bold small">≤ x </span><span class="small">[⇑self&gt;x≡false]</span></div>
<div class="line left">
<span class="bold small">≡ x </span><span class="small">[⇑self≡x </span><span class="italic small">"In case this is reached by perform:"</span><span class="small">] primitive: 4</span></div>
<div class="line left">
<span class="bold small">≠ x </span><span class="small">[⇑self=x≡false]</span></div>
<div class="line left">
<span class="bold small">≥ x </span><span class="small">[⇑self&lt;x≡false]</span></div>
<div class="line left">
<span class="bold small">= x </span><span class="small">[⇑self≡x]</span></div>
<div class="line left">
<span class="bold small">and⦂ x </span><span class="small">[self⇒[⇑x eval] ⇑false]</span></div>
<div class="line left">
<span class="bold small">and: x </span><span class="small">[self⇒[⇑x] ⇑false]</span></div>
<div class="line left">
<span class="bold small">empty </span><span class="small">[⇑self length = 0]</span></div>
<div class="line left">
<span class="bold small">eqv: x </span><span class="small">[x⇒[⇑self] ⇑self≡false]</span></div>
<div class="line left">
<span class="bold small">or⦂ x </span><span class="small">[self⇒[⇑true] ⇑x eval]</span></div>
<div class="line left">
<span class="bold small">or: x </span><span class="small">[self⇒[⇑true] ⇑x]</span></div>
<div class="line left">
<span class="bold small">sameAs: object<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑self≡object]</span></div>
<div class="line left">
<span class="bold small">xor: x </span><span class="small">[x⇒[⇑self≡false] ⇑self]</span></div>
<div class="line left">
<span class="bold large"><br>Classification</span></div>
<div class="line left">
<span class="bold small">class </span><span class="small">[user croak] primitive: 27</span></div>
<div class="line left">
<span class="bold small">is: x </span><span class="small">[⇑self class≡x]</span></div>
<div class="line left">
<span class="bold small">Is: x  </span><span class="small">"Is the class x a superclass or class of self"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self class ≡ x ⇒[⇑true]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑self class Isa: x]</span></div>
<div class="line left">
<span class="bold small">isArray<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑false]</span></div>
<div class="line left">
<span class="bold small">isnt: x </span><span class="small">[⇑(self class≡x) ≡ false]</span></div>
<div class="line left">
<span class="bold small">Isnt: x<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑(self Is: x)≡false]</span></div>
<div class="line left">
<span class="bold small">isNumber<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑false]</span></div>
<div class="line left">
<span class="bold large"><br>Construction</span></div>
<div class="line left">
<span class="bold small">, x </span><span class="small">| v<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[v &larr; Vector new: 2.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">v◦1 &larr; self. v◦2 &larr; x.  ⇑v]</span></div>
<div class="line left">
<span class="bold small">asParagraph </span><span class="small">[⇑self asString asParagraph]</span></div>
<div class="line left">
<span class="bold small">asStream </span><span class="small">[⇑self asVector asStream]</span></div>
<div class="line left">
<span class="bold small">asVector </span><span class="small">| v<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self≡nil⇒[⇑Vector new: 0]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">v &larr; Vector new: 1. v◦1 &larr; self. ⇑v]</span></div>
<div class="line left">
<span class="bold small">copy</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"create new copy of self"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self is: Object⇒[⇑self]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑self class copy: self]</span></div>
<div class="line left">
<span class="bold small">inVector </span><span class="small">| vec<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"Return me as the sole element of a new Vector."</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">vec &larr; Vector new: 1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">vec◦1 &larr; self.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑vec]</span></div>
<div class="line left">
<span class="bold small">recopy</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"recursively copy whole structure"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self is: Object⇒[⇑self]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑self class recopy: self]</span></div>
<div class="line left">
<span class="bold large"><br>Aspects</span></div>
<div class="line left">
<span class="bold small">asOop </span><span class="small">[user croak] primitive: 46</span></div>
<div class="line left">
<span class="bold small">canunderstand: selector<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑self class canunderstand: selector]</span></div>
<div class="line left">
<span class="bold small">error: s </span><span class="small">[⇑user notify: s]</span></div>
<div class="line left">
<span class="bold small">fields<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"Return an Array of all my field names or many of my subscripts."</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self class is: VariableLengthClass⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self length ≤ 50⇒ [⇑1 to: self length]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ (1 to: 20) concat: (self length-20 to: self length)]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑self class instvars]</span></div>
<div class="line left">
<span class="bold small">hash </span><span class="small">[user croak] primitive: 46</span></div>
<div class="line left">
<span class="bold small">inspect<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[user leaveTop; restartup: (InspectWindow new of: self)]</span></div>
<div class="line left">
<span class="bold small">inspectfield: n</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"used by variable panes"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self class is: VariableLengthClass⇒ [⇑self◦(self fields◦n)]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑self instfield: n]</span></div>
<div class="line left">
<span class="bold small">instfield: n </span><span class="small">[user croak] primitive: 38</span></div>
<div class="line left">
<span class="bold small">instfield: n &larr; val </span><span class="small">[user croak] primitive: 39</span></div>
<div class="line left">
<span class="bold small">instfields </span><span class="small">| vec size  i<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"Return an Array of all my field values or many of my elements."</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self class is: VariableLengthClass⇒ [⇑self◦self fields]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">size &larr; self class instsize.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">vec &larr; Vector new: size.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: size do⦂ [vec◦i &larr; self instfield: i].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑vec]</span></div>
<div class="line left">
<span class="bold small">itself </span></div>
<div class="line left">
<span class="bold small">ref: index<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑FieldReference new object: self offset: index]</span></div>
<div class="line left">
<span class="bold small">subError </span><span class="small">[self error: &rsquo;message not defined by subclass&rsquo;]</span></div>
<div class="line left">
<span class="bold small">title<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑self class title + &rsquo;.&rsquo; + self asOop base8]</span></div>
<div class="line left">
<span class="bold large"><br>Printing</span></div>
<div class="line left">
<span class="bold small">asFullString </span><span class="small">| strm<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[strm &larr; (String new: 20) asStream.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self fullprinton: strm. ⇑strm contents]</span></div>
<div class="line left">
<span class="bold small">asString </span><span class="small">| strm<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[strm &larr; (String new: 16) asStream.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self printon: strm. ⇑strm contents]</span></div>
<div class="line left">
<span class="bold small">filout </span><span class="small">| file<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑user displayoffwhile⦂ <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[file &larr; dp0 file: self title asFileName.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self fullprinton: file.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">file close]]</span></div>
<div class="line left">
<span class="bold small">fullprint </span><span class="small">| strm<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[strm &larr; Stream default. self fullprinton: strm.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user show: strm contents]</span></div>
<div class="line left">
<span class="bold small">fullprinton: strm<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self≡nil⇒ [strm append: &rsquo;nil&rsquo;]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self≡false⇒ [strm append: &rsquo;false&rsquo;]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self≡true⇒ [strm append: &rsquo;true&rsquo;]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self class print: self on: strm]</span></div>
<div class="line left">
<span class="bold small">print<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[user show: self asString]</span></div>
<div class="line left">
<span class="bold small">printon: strm </span><span class="small">| t [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">strm append: [self≡nil⇒ [&rsquo;nil&rsquo;]; ≡false⇒ [&rsquo;false&rsquo;]; ≡true⇒ [&rsquo;true&rsquo;]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">t &larr; self class title.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">strm append: [&rsquo;AEIO&rsquo; has: t◦1⇒ [&rsquo;an &rsquo;] &rsquo;a &rsquo;].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">t]]</span></div>
<div class="line left">
<span class="bold large"><br>Compiler Defaults</span></div>
<div class="line left">
<span class="bold small">ⓢ code<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑Generator new evaluate: code asStream in: false to: self notifying: self]</span></div>
<div class="line left">
<span class="bold small">argsOff: stack<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self⇒ [stack pop: 1]]</span></div>
<div class="line left">
<span class="bold small">asRemoteCode: generator<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑ParsedRemote new expr: self]</span></div>
<div class="line left">
<span class="bold small">emitForEffect: code on: stack</span></div>
<div class="line left">
<span class="bold small">emitForTruth: trueSkip falsity: falseSkip into: code on: stack<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self emitForValue: code on: stack.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(trueSkip jmpSize + falseSkip) emitBfp: code on: stack.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">trueSkip emitJmp: code on: stack]</span></div>
<div class="line left">
<span class="bold small">emitForValue: code on: stack</span></div>
<div class="line left">
<span class="bold small">emitsLoad<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑false]</span></div>
<div class="line left">
<span class="bold small">emittedReceiver<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑false]</span></div>
<div class="line left">
<span class="bold small">emittedVariable<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑false]</span></div>
<div class="line left">
<span class="bold small">findMacros: macros compilerTemps: compilerTemps</span></div>
<div class="line left">
<span class="bold small">firstPush<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑¬1]</span></div>
<div class="line left">
<span class="bold small">interactive<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑false]</span></div>
<div class="line left">
<span class="bold small">isField<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑false]</span></div>
<div class="line left">
<span class="bold small">notify: errorString at: position in: stream<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑self notify: errorString at: position in: stream for: self class]</span></div>
<div class="line left">
<span class="bold small">notify: errorString at: position in: stream for: class </span><span class="small">| syntaxWindow<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[NotifyFlag⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[syntaxWindow &larr; SyntaxWindow new of: errorString at: position in: stream for: class from: thisContext sender.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">thisContext sender &larr; nil.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user restartup: syntaxWindow]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> user notify: errorString. ⇑false]</span></div>
<div class="line left">
<span class="bold small">printon: strm indent: level precedence: p forValue: v decompiler: decompiler</span></div>
<div class="line left">
<span class="bold small">remote: generator</span></div>
<div class="line left">
<span class="bold small">returns<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑false]</span></div>
<div class="line left">
<span class="bold small">sizeForEffect: nextPush <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑0]</span></div>
<div class="line left">
<span class="bold small">sizeForTruth: trueSkip falsity: falseSkip<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">| jump<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[jump &larr; trueSkip jmpSize.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑self sizeForValue + (jump+falseSkip) bfpSize + jump]</span></div>
<div class="line left">
<span class="bold small">sizeForValue<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑0]</span></div>
<div class="line left">
<span class="bold large"><br>System Primitives</span></div>
<div class="line left">
<span class="bold small">error </span><span class="small">| sender op n args i</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"after compiling execute: nil installError.  "<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[sender &larr; thisContext sender.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">op &larr; sender thisop.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">n &larr; op numArgs.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">args &larr; Vector new: n.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i from: (n to: 1 by: ¬1) do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[args◦i &larr; sender pop].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑self messageNotUnderstood: op withArgs: args from: sender]</span></div>
<div class="line left">
<span class="bold small">installError </span><span class="small">| code old<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[code &larr; Object md method: ↪error.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">old &larr; SpecialOops◦1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">old asOop≠(mem◦3)⇒ [user notify: &rsquo;Object installError failed&rsquo;]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">Top critical⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[mem◦3 &larr; code asOop.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">SpecialOops◦1 &larr; code]]</span></div>
<div class="line left">
<span class="bold small">messageNotUnderstood: op withArgs: args from: sender<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[thisContext sender &larr; sender.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user notify: &rsquo;Message not understood: &rsquo;+op]</span></div>
<div class="line left">
<span class="bold small">nail </span><span class="small">[user croak] primitive: 31</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"Nail me in core and return my core address"</span></div>
<div class="line left">
<span class="bold small">perform: selector </span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"Send the unary message, selector, to self"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[selector mustTake: 0. ⇑self performDangerously: selector]</span></div>
<div class="line left">
<span class="bold small">perform: selector with: arg1 </span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"Send the 1-argument message, selector, to self"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[selector mustTake: 1. ⇑self performDangerously: selector with: arg1]</span></div>
<div class="line left">
<span class="bold small">perform: selector with: arg1 with: arg2 </span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"Send the 2-argument message, selector, to self"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[selector mustTake: 2. ⇑self performDangerously: selector with: arg1 with: arg2]</span></div>
<div class="line left">
<span class="bold small">perform: selector with: arg1 with: arg2 with: arg3 </span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"Send the 3-argument message, selector, to self"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[selector mustTake: 3. ⇑self performDangerously: selector with: arg1 with: arg2 with: arg3]</span></div>
<div class="line left">
<span class="bold small">perform: selector withArgs: vec<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[selector mustTake: vec length.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑self performDangerously: selector withArgs: vec]</span></div>
<div class="line left">
<span class="bold small">performDangerously: selector </span><span class="italic small">"Send self the message, selector; it had better be unary"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[user notify: &rsquo;can&rsquo;&rsquo;t perform: nil&rsquo;] primitive: 102</span></div>
<div class="line left">
<span class="bold small">performDangerously: selector with: arg1  </span><span class="italic small">"selector had better take 1 arg"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[user notify: &rsquo;can&rsquo;&rsquo;t perform: nil with:&rsquo;] primitive: 102</span></div>
<div class="line left">
<span class="bold small">performDangerously: selector with: arg1 with: arg2  </span><span class="italic small">"selector had better take 2 args"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[user notify: &rsquo;can&rsquo;&rsquo;t perform: nil with:with:&rsquo;] primitive: 102</span></div>
<div class="line left">
<span class="bold small">performDangerously: selector with: arg1 with: arg2 with: arg3  </span><span class="italic small">"selector had better take 3 args"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[user notify: &rsquo;can&rsquo;&rsquo;t perform: nil with:with:with:&rsquo;] primitive: 102</span></div>
<div class="line left">
<span class="bold small">performDangerously: selector withArgs: vec<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[vec length=0⇒ [⇑self performDangerously: selector];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=1⇒ [⇑self performDangerously: selector with: vec◦1];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=2⇒ [⇑self performDangerously: selector with: vec◦1 with: vec◦2];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=3⇒ [⇑self performDangerously: selector with: vec◦1 with: vec◦2 with: vec◦3]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user notify: &rsquo;More than 3 args for perform:&rsquo;]</span></div>
<div class="line left">
<span class="bold small">PTR </span><span class="small">[] primitive: 46</span></div>
<div class="line left">
<span class="bold small">refct </span><span class="small">[user croak] primitive: 45</span></div>
<div class="line left">
<span class="bold small">startup</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"loopless scheduling"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self firsttime⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[while⦂ self eachtime do⦂ [].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑self lasttime]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑false]</span></div>
<div class="line left">
<span class="bold small">swap⦂ variable </span><span class="small">| x  </span><span class="italic small">"assign me to variable and return its old value"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[x &larr; variable value. variable value &larr; self. ⇑x]</span></div>
<div class="line left">
<span class="bold small">unNail </span><span class="small">[user croak] primitive: 32</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"Release me from being nailed"</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪Object under: &rsquo;Kernel Classes&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"Class"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;Class&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: Object<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;title</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">"&lt;String&gt; for identification, printing"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">myinstvars "&lt;String&gt; partnames for compiling, printing"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">instsize "&lt;Integer&gt; for storage management"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">messagedict "&lt;MessageDict&gt; for communication, compiling"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">classvars "&lt;Dictionary/nil&gt; compiler checks here"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">superclass "&lt;Class&gt; for execution of inherited behavior"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">environment "&lt;Vector of SymbolTables&gt; for external refs"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fieldtype&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;lastClass lastSelector lastParagraph &rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">veryspecial: 1;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>Classes are the molecules of Smalltalk.  The instance fields specify the number and naming of fields for each instance, and the messages define the protocol with which these objects may be communicated.  Classes inherit the fields and message protocol of their superclass.  Locally defined messages will override inherited ones of the same name, and overriden ones may be accessed through the use of super in place of self.  A typical class definition looks like:<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">Class new title: &rsquo;CodeEditor&rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">subclassof: Window;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">fields: &rsquo;pared class selector&rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">declare: &rsquo;editmenu&rsquo;<br>This ordering is required, though the subclassof: and declare: messages are optional.  A class definition may be re-executed but, if the fields: clause has changed, all instances of the old class will become obsolete (they will fail to respond to any messages).</span></div>
<div class="line left">
<span class="bold large"><br>Initialization</span></div>
<div class="line left">
<span class="bold small">abstract<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self fields: nullString]</span></div>
<div class="line left">
<span class="bold small">bytesize: n</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"non-pointer declaration"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self≠self realself⇒[self realself bytesize: n]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">fieldtype &larr; 32+ [n=8⇒ [8] 16]]</span></div>
<div class="line left">
<span class="bold small">classInit</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"gets propagated to a dummy instance"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self new classInit]</span></div>
<div class="line left">
<span class="bold small">copyof: oldClass subclassof: newSubClass<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[title &larr; oldClass title.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> self subclassof: newSubClass.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> classvars &larr; oldClass classvars.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> environment &larr; oldClass environment.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> self newFieldsForSubClass: oldClass myinstvars]</span></div>
<div class="line left">
<span class="bold small">declare: v </span><span class="small">| var recom</span><span class="bold small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self≠self realself⇒[self realself declare: v]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> [classvars≡nil⇒[classvars &larr; SymbolTable init]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> v is: String⇒[self declare: v asVector]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> recom &larr; false.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> [v is: Vector⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[for⦂ var from: v do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[(Smalltalk has: var) or: (Undeclared has: var)⇒[recom &larr; true]]]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">  (Smalltalk has: v) or: (Undeclared has: v)⇒[recom &larr; true]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> [recom⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[user notify: &rsquo;Methods recompile if you proceed, global became local&rsquo;]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> [v is: Vector⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[for⦂ var from: v do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[classvars insert: var with: nil]]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">  classvars insert: v with: nil].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> recom⇒[self compileall]]</span></div>
<div class="line left">
<span class="bold small">environment &larr; environment </span><span class="small">[] </span><span class="italic small">"for resetting to reread sharing clauses"</span></div>
<div class="line left">
<span class="bold small">fields: myinstvars </span><span class="small">| r a b s h</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"list of instance variables"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[messagedict &larr; MessageDict init.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> r &larr; self realself.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">a &larr; self instvars.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">h&larr; HashSet init.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ s from: a do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[h has: s⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[user notify: s+&rsquo; is used already (maybe in superclass)&rsquo;]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">h insert: s].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> self=r⇒[self initClass]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> a=(b&larr; r instvars)⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[r environment&larr; nil; myinstvars&larr; myinstvars; subclassof: superclass]<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> [r howMany&gt;0⇒[user notify: &rsquo;All &rsquo;+title+&rsquo;s become obsolete if you proceed...&rsquo;]].<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> classvars &larr; r classvars.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> messagedict &larr; r md copy.<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> </span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[a length≤b length or⦂ a◦(1 to: b length)≠b⇒</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"just adding new inst fields"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[user notify: title+ &rsquo; methods recompile if you proceed...&rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> self compileall]].<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> r md init.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> self fixSubClassesOf: r.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> r obsolete.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> Smalltalk◦title unique &larr; self.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> self initClass]</span></div>
<div class="line left">
<span class="bold small">fixSubClassesOf: oldClass </span><span class="small">| n subClass<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[for⦂ n from: user classNames do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[subClass &larr; Smalltalk◦n.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> subClass superclass≡oldClass⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[Class new copyof: subClass subclassof: self]]]</span></div>
<div class="line left">
<span class="bold small">initClass<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[fieldtype &larr; 16.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">instsize &larr; self instvars length.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">instsize&gt;256⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[user notify: &rsquo;too many instance variables&rsquo;]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self organization]</span></div>
<div class="line left">
<span class="bold small">myinstvars &larr; myinstvars</span></div>
<div class="line left">
<span class="bold small">newFieldsForSubClass: myinstvars </span><span class="small">| r a b</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"list of instance variables"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[messagedict &larr; MessageDict init.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> r &larr; self realself.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> self=r⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[user notify: &rsquo;problem in class redefinition. See coment at end of method&rsquo;]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> (a&larr; self instvars)=(b&larr; r instvars)⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[user notify: &rsquo;problem in class redefinition. See coment at end of method&rsquo;]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> [r howMany&gt;0⇒[user cr show: &rsquo;All &rsquo;+title+&rsquo;s are obsolete.&rsquo;]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> classvars &larr; r classvars.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> messagedict &larr; r md copy.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> r md init.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> </span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[a length≤b length or⦂ a◦(1 to: b length)≠b⇒</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"changing inst fields"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[user cr show: title+ &rsquo; recompiled.&rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> self compileall]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> self fixSubClassesOf: r.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> r obsolete.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> Smalltalk◦title unique &larr; self.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> self initClass]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"Regarding the notifys in this method: It is my understanding<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> that this method will only be invoked when the conditions<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> leading to the notifys are false. If I&rsquo;m available, I&rsquo;d like to see<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> any case that results in notification.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">Dave Robson"<br></span></div>
<div class="line left">
<span class="bold small">obsolete</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"invalidate further communication"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[title &larr; &rsquo;AnObsolete&rsquo;+title.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">classvars &larr; nil.</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"recycle class variables"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">messagedict close.</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"invalidate and recycle local messages"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">environment &larr; self.</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"keep me around for old instances"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">superclass &larr; Object.</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"invalidate superclass messages"</span><span class="small">]<br></span></div>
<div class="line left">
<span class="bold small">realself </span><span class="small">[⇑Smalltalk◦title unique]</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"as opposed to possible filin ghost"</span></div>
<div class="line left">
<span class="bold small">rename: newtitle<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">| name newname oldclass category<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[name &larr; title unique.  newname &larr; newtitle unique.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[Smalltalk has: newname⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[oldclass &larr; Smalltalk◦newname.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user notify: &rsquo;All &rsquo; + newtitle + &rsquo;s will become obsolete if you proceed&rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">oldclass obsolete]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">category &larr; SystemOrganization invert: name.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">AllClassNames &larr; AllClassNames insertSorted: newname.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">SystemOrganization classify: newname under: category].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">Smalltalk delete: name.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">AllClassNames &larr; AllClassNames delete: name.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">SystemOrganization delete: name.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">title &larr; newtitle.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">Smalltalk declare: newname as: self]<br></span></div>
<div class="line left">
<span class="bold small">sharing: table<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self≠self realself⇒[self realself sharing: table]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">environment &larr; environment asVector , table]</span></div>
<div class="line left">
<span class="bold small">subclassof: superclass<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[(superclass isnt: Class) and⦂ (superclass isnt: VariableLengthClass)⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[user notify: &rsquo;Superclass is not yet defined or not a Class&rsquo;]]</span></div>
<div class="line left">
<span class="bold small">title: title<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self title: (title &larr; title unique) insystem: Smalltalk]</span></div>
<div class="line left">
<span class="bold small">title: name insystem: system </span><span class="small">| cl<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[superclass &larr; Object.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[system has: name⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[cl &larr; (system◦name) class.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">cl≡self class⇒ [⇑self]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user notify: name + &rsquo; will change from a &rsquo; + cl title + &rsquo; to a &rsquo; + self class title + &rsquo; if you proceed...&rsquo;]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">system declare: name as: self.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">AllClassNames &larr; AllClassNames insertSorted: name.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">SystemOrganization classify: name under: &rsquo;As yet unclassified&rsquo;]</span></div>
<div class="line left">
<span class="bold small">title: t subclassof: s fields: f declare: d<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[t◦1≠((t◦1) asUppercase)⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[user notify: &rsquo;Please capitalize each word in class title: &rsquo; + t. ⇑false]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self title: t; subclassof: s; fields: f; declare: d]</span></div>
<div class="line left">
<span class="bold small">veryspecial: n</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"inaccessible fields"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[instsize &larr; self instvars length + n]</span></div>
<div class="line left">
<span class="bold large"><br>Access to parts</span></div>
<div class="line left">
<span class="bold small">◦x </span><span class="small">[⇑classvars◦x]</span></div>
<div class="line left">
<span class="bold small">◦x &larr; val </span><span class="small">[⇑classvars◦x &larr; val]</span></div>
<div class="line left">
<span class="bold small">fieldNamesInto: collector<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[[superclass≡nil⇒ [] superclass fieldNamesInto: collector].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑(Reader new of: myinstvars) readInto: collector]</span></div>
<div class="line left">
<span class="bold small">instsize<br></span><span class="small">[</span><span class="italic small">"Return the number of user accessable instance fields (self instvars length)."</span><span class="small"><br>⇑[fieldtype≥32⇒ [0] <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self≡Class⇒ [instsize-1]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self≡VariableLengthClass ⇒[instsize-20]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">instsize]]</span></div>
<div class="line left">
<span class="bold small">instvars<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑self fieldNamesInto: FieldNameCollector default]</span></div>
<div class="line left">
<span class="bold small">invertRef: refs </span><span class="small">"Refs may be a vector (to allow batching)" <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">| cl env source ref inv sym t<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[refs isnt: Vector⇒ [⇑(self invert: refs inVector)◦1]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">env &larr; (self wholeEnvironment concat: (Undeclared, Smalltalk)) asStream.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">source &larr; Dictionary init.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑refs transform⦂ ref to⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[cl &larr; self. env reset.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">until⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[(sym &larr; env next)≡false⇒ [inv &larr; &rsquo;unknown &rsquo; concat: ref asOop base8]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[cl≠nil and⦂ sym≡cl classvars⇒ [t &larr; cl title. cl &larr; cl superclass] t &larr; false].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(inv &larr; sym invertRef: ref)≡false⇒ [false]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[t⇒ []<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> t &larr; source lookup: sym⇒ []<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> source insert: sym with: (t &larr; Smalltalk invert: sym)].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">inv &larr; (t concat: &rsquo; &rsquo;) concat: inv]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> do⦂ [].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">inv]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">Isa: x  </span><span class="italic small">"is x on my superclass chain?"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[superclass ≡ x ⇒[⇑true]; ≡ nil ⇒[⇑false]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑superclass Isa: x]</span></div>
<div class="line left">
<span class="bold small">md </span><span class="small">[⇑messagedict]</span></div>
<div class="line left">
<span class="bold small">myinstvars<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑myinstvars]</span></div>
<div class="line left">
<span class="bold small">superclass </span><span class="small">[⇑superclass]</span></div>
<div class="line left">
<span class="bold small">title </span><span class="small">[⇑title]</span></div>
<div class="line left">
<span class="bold large"><br>Organization</span></div>
<div class="line left">
<span class="bold small">classvars </span><span class="small">[⇑classvars]</span></div>
<div class="line left">
<span class="bold small">clean </span><span class="small">| name</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"release unreferenced classvars"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[for⦂ name from: classvars do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[name≠↪ClassOrganization and⦂ (classvars ref: name) refct=1⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[classvars delete: name]]]</span></div>
<div class="line left">
<span class="bold small">environment<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑environment]</span></div>
<div class="line left">
<span class="bold small">organization </span><span class="small">| o<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[classvars ≡ nil⇒[self declare: ↪ClassOrganization]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">o &larr; classvars lookup: ↪ClassOrganization.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">o is: ClassOrganizer⇒[⇑o]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">o &larr; ClassOrganizer new init: messagedict contents sort.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">classvars insert: ↪ClassOrganization with: o.  ⇑o]</span></div>
<div class="line left">
<span class="bold small">wholeEnvironment<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑(classvars asVector concat: environment asVector) concat:<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[superclass≡nil⇒ [↪()] superclass wholeEnvironment]]</span></div>
<div class="line left">
<span class="bold large"><br>Editing</span></div>
<div class="line left">
<span class="bold small">ed: selector </span><span class="small">| c s<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[c&larr; self code: selector. user clearshow: c.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ (s&larr; user request: &rsquo;substitute: &rsquo;) do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[c &larr; c subst: s for: (user request: &rsquo;for: &rsquo;).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user clearshow: c]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self understands: c]</span></div>
<div class="line left">
<span class="bold small">edit: selector </span><span class="small">| para s v<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[para &larr;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[selector=↪ClassOrganization⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self organization asParagraph]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">messagedict has: selector⇒[self code: selector]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nullString asParagraph].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self edit: selector para: para formerly: false]</span></div>
<div class="line left">
<span class="bold small">edit: selector para: para formerly: oldpara<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[user leaveTop.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user restartup: (CodeWindow new class: self selector: selector para: para formerly: oldpara)]</span></div>
<div class="line left">
<span class="bold small">execute: code</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"disposable methods"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self understands: &rsquo;doit [⇑&rsquo; + code + &rsquo;]&rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑self new doit]</span></div>
<div class="line left">
<span class="bold large"><br>Message access</span></div>
<div class="line left">
<span class="bold small">archiveOn: file changesOnly: ch </span><span class="small">| org m [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">this should be called only by the system releaser<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">(via </span><span class="bold small">UserView file:classes:changesOnly:</span><span class="italic small">) !!!<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">if you want to archive your own classes (useful only if you have stable code<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">and intend to clean up afterwards with a vmem write), see Steve.<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">write comment and method text on a FileStream for some file.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">ch⇒ [write only changes (non-remote String/Paraagraphs)] write everything</span><span class="small">"<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user cr; show: title.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">org &larr; self organization.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["</span><span class="italic small">org globalComment always yields a String, so a small kludge is in order</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">ch and⦂ (org globalCommentItself is: RemoteParagraph)⇒ []<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">org globalComment &larr;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(RemoteParagraph new on: file) fromString: org globalComment].<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">archive in category&alphabetical rather than hash order (messagedict)</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ m from: org do⦂ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">ch and⦂ ((messagedict code: m) is: RemoteParagraph)⇒ []<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">messagedict code: m &larr;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(RemoteParagraph new on: file) fromParagraph: (self code: m).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">ch⇒ [user space; show: m]]]</span></div>
<div class="line left">
<span class="bold small">bytesof: sel<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑(messagedict method: sel) asBytes]</span></div>
<div class="line left">
<span class="bold small">canUnderstand: selector<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[messagedict has: selector⇒ [⇑self]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">superclass≡nil⇒ [⇑false]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑superclass canUnderstand: selector]</span></div>
<div class="line left">
<span class="bold small">canunderstand: selector<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑messagedict has: selector]</span></div>
<div class="line left">
<span class="bold small">code: sel </span><span class="small">[ <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">last paragraph returned is cached (mainly for NotifyWindows)</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[sel ≡ lastSelector and⦂ self ≡ lastClass ⇒ []<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">lastParagraph &larr; ([<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">sel = ↪ClassOrganization ⇒ [self organization]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">if left shift key is down, decompile</span><span class="small">"</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user leftShiftKey⇒ [self decompile: sel]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">Paragraph or RemoteParagraph</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">messagedict code: sel]) asParagraph.<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">lastClass &larr; self.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">lastSelector &larr; sel].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑lastParagraph]</span></div>
<div class="line left">
<span class="bold small">compileall </span><span class="small">| s c "does not modify code, just compiles it"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[for⦂ s from: messagedict do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[c &larr; messagedict code: s.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> self understands: c asParagraph.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> messagedict code: s &larr; c "leave it as a remote paragraph"].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> self≡Object⇒[nil installError]]<br></span><span class="italic small">"to recompile the whole system (check out big changes) execute:<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">| n [for⦂ n from: AllClassNames do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">[user show: n; cr. (Smalltalk◦n) compileall.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">Changes init. MessageDict new freeMethods]] "</span></div>
<div class="line left">
<span class="bold small">copy: sel from: class<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self copy: sel from: class classified: nil]</span></div>
<div class="line left">
<span class="bold small">copy: sel from: class classified: cat </span><span class="small">"Useful when modifying an existing class"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">| s code<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[sel is: Vector⇒ [for⦂ s from: sel do⦂ [self copy: s from: class classified: cat]]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">sel is: String⇒ [self copy: (class organization category: sel) from: class classified: cat]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">code &larr; class code: sel.  code≡nil⇒ []<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[cat≡nil⇒ [cat &larr; class organization invert: sel]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[messagedict has: sel⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[code text=(self code: sel) text⇒ []<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user notify: title+&rsquo; &rsquo;+sel+&rsquo; will be redefined if you proceed.&rsquo;]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self understands: code classified: cat]</span></div>
<div class="line left">
<span class="bold small">decompile: t1 <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑user displayoffwhile⦂ [Decompiler new decompile: t1 class: self]]</span></div>
<div class="line left">
<span class="bold small">derstands: selector </span><span class="small">| c</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"overstands?  undersits? - forget it"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[selector is: Vector⇒[for⦂ c from: selector do⦂ [self derstands: c]]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(messagedict has: selector)≡false⇒[] <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">messagedict &larr; messagedict delete: selector.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self organization delete: selector.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">lastClass &larr; lastSelector &larr; lastParagraph &larr; nil.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[Changes has: (c&larr;title+&rsquo; &rsquo;+selector)⇒ [Changes delete: c]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">Changes insert: (c&larr;&rsquo;~&rsquo;+c).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑c]</span></div>
<div class="line left">
<span class="bold small">describe: method on: strm </span><span class="small">| sel cls  </span><span class="italic small">"append mclass and selector"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[cls &larr; self.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">until⦂ [cls≡nil⇒ [cls&larr;self. sel&larr;↪?] sel &larr; cls md invert: method] do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[cls &larr; cls superclass].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">strm append: cls title; space; append: sel]</span></div>
<div class="line left">
<span class="bold small">install: name method: method literals: literals<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold small">code: code backpointers: backpointers | c<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[messagedict &larr; messagedict insert: name method: method<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">literals: literals code: code makeBoldPattern backpointers: backpointers.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">lastClass &larr; self.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">lastSelector &larr; name.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">lastParagraph &larr; code.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">Changes insert: (c&larr;title+&rsquo; &rsquo;+name).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">Changes has: (c&larr;&rsquo;~&rsquo;+c)⇒[Changes delete: c]]</span></div>
<div class="line left">
<span class="bold small">messages </span><span class="small">[⇑messagedict contents , ↪ClassOrganization]</span></div>
<div class="line left">
<span class="bold small">method: sel<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑messagedict methodorfalse: sel]</span></div>
<div class="line left">
<span class="bold small">notify: errorString at: position in: stream<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑self notify: errorString at: position in: stream for: self]</span></div>
<div class="line left">
<span class="bold small">selectors</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"Return a Vector of all my selectors."</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑self messages]</span></div>
<div class="line left">
<span class="bold small">shrink </span><span class="small">[messagedict &larr; messagedict shrink]</span></div>
<div class="line left">
<span class="bold small">space </span><span class="small">| a s<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[s &larr; 0. for⦂ a from: messagedict do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[s &larr; s + (messagedict method: a) length]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑s]</span></div>
<div class="line left">
<span class="bold small">textLocal </span><span class="small">| s [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">makes comment and methods local</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s &larr; self organization.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s globalComment &larr; s globalComment.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ s from: messagedict do⦂ [messagedict code: s &larr; self code: s]]</span></div>
<div class="line left">
<span class="bold small">understands: code </span><span class="small">| selector old</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"install method"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑self understands: code classified: &rsquo;As yet unclassified&rsquo;]</span></div>
<div class="line left">
<span class="bold small">understands: code classified: heading</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"compile and install method"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑Generator new compile: code asParagraph<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">in: self under: heading notifying: self]</span></div>
<div class="line left">
<span class="bold small">whosends: selector </span><span class="small">| s l a<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[s &larr; Stream default.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ a from: messagedict do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[for⦂ l from: (messagedict literals: a) do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[selector≡l⇒[s append: a; space]]]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑s contents]</span></div>
<div class="line left">
<span class="bold large"><br>Instance access</span></div>
<div class="line left">
<span class="bold small">allInstances </span><span class="small">[⇑self allInstancesEver notNil]</span></div>
<div class="line left">
<span class="bold small">allInstancesEver </span><span class="small">| indx vec PCLs i </span><span class="italic small">"returns a vector containing all instances of this class mixed with nils"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"Works for all classes.  Some additional instances may be created after the<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">vector is filled but before you get to use it."</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">PCLs &larr; Vmem pclassesOf: self.  </span><span class="italic small">"vector of PCLs"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">vec &larr; Vector new: 128*PCLs length.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: PCLs length do⦂ <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[(vec◦[i-1*128+1 to: i*128]) all&larr; PCLs◦i].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">thisContext destroyAndReturn: (self fromFreelist: Class instsize fill: vec)]</span></div>
<div class="line left">
<span class="bold small">copy: inst </span><span class="small">| t i<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[t &larr; self new.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: self instsize do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[t instfield: i &larr; inst instfield: i]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑t]</span></div>
<div class="line left">
<span class="bold small">default<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑self new default]</span></div>
<div class="line left">
<span class="bold small">fromFreelist: i fill: vec </span><span class="italic small">"i = zero order index of freelist in class instance.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">vec = vector in pclasses of all possible instances."</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[user croak] primitive: 60</span></div>
<div class="line left">
<span class="bold small">howMany </span><span class="small">| v </span><span class="italic small">"how many instances of this class are in use now?"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[v &larr; self allInstancesEver.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">thisContext destroyAndReturn: v length-(v count: nil)]</span></div>
<div class="line left">
<span class="bold small">init</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"init and default get propagated to instances"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑self new init]</span></div>
<div class="line left">
<span class="bold small">init: n</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"init and default get propagated to instances"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑self new init: n]</span></div>
<div class="line left">
<span class="bold small">instfield:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold small"> i</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"prevent user from getting freelist"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[i &gt; Class instsize ⇒[user notify: &rsquo;arg too big&rsquo;]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑super instfield: i]</span></div>
<div class="line left">
<span class="bold small">new </span><span class="small">[user croak] primitive: 28</span></div>
<div class="line left">
<span class="bold small">new: length </span><span class="small">"To allow fixed-length classes to simulate variable-length ones"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑self new init: length] "By convention"</span></div>
<div class="line left">
<span class="bold small">print: inst on: strm </span><span class="small">| ivars i<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ivars &larr; self instvars.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">strm append: &rsquo;(&rsquo;; append: title; append: &rsquo; new &rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: instsize do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[strm append: ivars◦i; append: &rsquo;: &rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">print: (inst instfield: i); space]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">strm append: &rsquo;)&rsquo;]</span></div>
<div class="line left">
<span class="bold small">printon: strm<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[strm append: &rsquo;Class &rsquo; + title]</span></div>
<div class="line left">
<span class="bold small">recopy: inst </span><span class="small">| t i<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[t &larr; self new.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: self instsize do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[t instfield: i &larr; (inst instfield: i) recopy]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑t]</span></div>
<div class="line left">
<span class="bold large"><br>Filin and Filout</span></div>
<div class="line left">
<span class="bold small">asFollows </span><span class="small">| s heading selector p [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self≠self realself⇒[self realself asFollows]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">heading &larr; &rsquo;As yet unclassified&rsquo;.<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">handles Bravo or Press (Smalltalk generated) files</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ ((p &larr; FilinSource nextParagraph) and⦂ (s &larr; p text) ≠ &rsquo;&rsquo;) do⦂ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[s◦1 = 015⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">throw away initial cr before comment and headings</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s &larr; s copy: 2 to: s length]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">p runs◦2<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">= 2 "</span><span class="italic small">italic</span><span class="small">"⇒ [self organization globalComment &larr; s];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">= 0121 "</span><span class="bold large">5, bold</span><span class="small">"⇒ [heading &larr; s]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self canunderstand: (<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">selector &larr; self understands: p classified: heading)⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user show: selector; space. messagedict purge: selector]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user show: &rsquo;(an uncompiled method) &rsquo;]]</span></div>
<div class="line left">
<span class="bold small">changelist: cat </span><span class="small">[⇑title unique, (self organization category: cat)]</span></div>
<div class="line left">
<span class="bold small">definition </span><span class="small">| strm</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"return a string that defines me (Class new title etc.)"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[strm &larr; (String new: 50) asStream.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self printdefon: strm.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑strm contents]</span></div>
<div class="line left">
<span class="bold small">endCategoryOn: pstrm</span></div>
<div class="line left">
<span class="bold small">endChangesOn: pstrm<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[pstrm print: &rsquo;&rsquo; asParagraph]</span></div>
<div class="line left">
<span class="bold small">filout </span><span class="small">[user displayoffwhile⦂ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(dp1 file: title+&rsquo;.st.&rsquo;) filoutclass: self.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self noChanges]]</span></div>
<div class="line left">
<span class="bold small">filoutCategory: cat<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[(dp1 file: (title+&rsquo;-&rsquo;+cat+&rsquo;.st&rsquo;) asFileName) filout: (self changelist: cat)]</span></div>
<div class="line left">
<span class="bold small">filoutOrganization</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"So we can merge separate work on organization"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[user show: title; cr.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user displayoffwhile⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[(dp0 file: title+&rsquo;.org.&rsquo;)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">append: title+&rsquo; organization fromParagraph:&rsquo;; cr;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">append: self organization asParagraph text asString;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">append: &rsquo;asParagraph&rsquo;; close]]</span></div>
<div class="line left">
<span class="bold small">noChanges </span><span class="small">| s t<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[t&larr; title+&rsquo; *&rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ s from: Changes contents do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[(s◦1=126 "~" and⦂ (t match: s◦(2 to: s length)))<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> or⦂ (t match: s)⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[Changes delete: s]]]</span></div>
<div class="line left">
<span class="bold small">paraprinton: strm</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"Strm is actually a ParagraphPrinter"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">| para frame s heading org<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[para &larr; (&rsquo;"&rsquo;+title+&rsquo;"&rsquo;) asParagraph.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">para maskrunsunder: 0361 to: 0121.</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"Font &larr; 5, Bold"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">frame &larr; strm defaultframe.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">strm frame &larr; 15000⌾frame origin y rect: 20000⌾frame corner y.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">strm print: para.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">strm frame &larr; frame.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">strm print: ((self definition+&rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">asFollows&rsquo;) asParagraph maskrunsunder: 0361 to: 0121).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">org &larr; self organization.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">strm print: (&rsquo;<br>&rsquo;+org globalComment) asParagraph allItalic.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ heading from: org categories do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self printCategory: heading on: strm]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self endChangesOn: strm.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">strm print: (&rsquo;SystemOrganization classify: ↪&rsquo;+title+&rsquo; under: &rsquo;&rsquo;&rsquo;+<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(SystemOrganization invert: title unique)+&rsquo;&rsquo;&rsquo;.&rsquo;) asParagraph.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self ≡ Class or: self ≡ VariableLengthClass⇒ [] self canunderstand: ↪classInit⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[strm print: (title+&rsquo; classInit&rsquo;) asParagraph]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">printCategory: s on: pstrm </span><span class="small">| sel<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self startCategory: s on: pstrm.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ sel from: (self organization category: s) do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self printMethod: sel on: pstrm].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self endCategoryOn: pstrm]</span></div>
<div class="line left">
<span class="bold small">printdefon: strm </span><span class="small">| s</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"print my definition on strm"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[strm append: self class title;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">append: &rsquo; new title: &rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"title is probably unique, but make sure. then we want it as a &rsquo;String&rsquo; "<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">print: title unique asString.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">strm cr; tab; append: &rsquo;subclassof: &rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">append: [superclass≡nil⇒[&rsquo;nil&rsquo;] superclass title].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">strm cr; tab; append: &rsquo;fields: &rsquo;; print: myinstvars.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">strm cr; tab; append: &rsquo;declare: &rsquo;&rsquo;&rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ s from: classvars contents do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[s=↪ClassOrganization⇒[]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">strm append: s; space]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">strm append: &rsquo;&rsquo;&rsquo;&rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[fieldtype=16⇒[]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">strm semicrtab; append: &rsquo;bytesize: &rsquo;; print: fieldtype-32].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[instsize = (s&larr; self instvars) length⇒[]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">strm semicrtab; append: &rsquo;veryspecial: &rsquo;; print: instsize-s length].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[environment≡nil⇒[]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ s from: environment do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[strm semicrtab; append: &rsquo;sharing: &rsquo;; append: (Smalltalk invert: s)]]]</span></div>
<div class="line left">
<span class="bold small">printMethod: sel on: pstrm<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[pstrm print: (self code: sel).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">messagedict purge: sel]</span></div>
<div class="line left">
<span class="bold small">printout </span><span class="small">[user displayoffwhile⦂ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(dp0 file: title+&rsquo;.press.&rsquo;) printoutclass: self]]</span></div>
<div class="line left">
<span class="bold small">printoutCategory: cat<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[(dp0 file: (title+&rsquo;-&rsquo;+cat+&rsquo;.press&rsquo;) asFileName) printout: (self changelist: cat)]</span></div>
<div class="line left">
<span class="bold small">readfrom: strm </span><span class="small">[⇑self readfrom: strm format: nil]</span></div>
<div class="line left">
<span class="bold small">readfrom: strm format: f </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑self new readfrom: strm format: f]</span></div>
<div class="line left">
<span class="bold small">startCategory: s on: pstrm<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[pstrm print: ((&rsquo;<br>&rsquo;+s) asParagraph maskrunsunder: 0361 to: 0121).</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"Font 5, Bold"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">startChangesOn: pstrm<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[pstrm print: ((&rsquo;<br>&rsquo;+title+&rsquo; asFollows&rsquo;) asParagraph maskrunsunder: 0361 to: 0121).</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"Font 5, Bold"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold large"><br>System Organization</span></div>
<div class="line left">
<span class="bold small">category </span><span class="small">[⇑SystemOrganization invert: self title unique]</span></div>
<div class="line left">
<span class="bold small">category: cat<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[cat is: String ⇒[SystemOrganization add: self title unique under: cat]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user notify: &rsquo;Category name must be a String&rsquo;]</span></div>
<div class="line left">
<span class="bold small">moveFromCat: cat1 to: cat2<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[(cat1 is: String) and⦂ (cat2 is: String) ⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[SystemOrganization move: self title unique from: cat1 to: cat2]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user notify: &rsquo;Category name must be a String&rsquo;]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪Class under: &rsquo;Kernel Classes&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"Context"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;Context&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: Object<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;sender "&lt;Context&gt; from which this message was sent"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">receiver "&lt;Object&gt; to which this message was sent"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">keep "&lt;true, nil&gt; nil means reclaimable"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">method "&lt;String&gt;, the encoded method"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">tempframe "&lt;Vector&gt; to hold temporaries and a stack"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">pc "&lt;Integer&gt; marks progress of execution in method"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">stackptr "&lt;Integer&gt; offset of stack top in tempframe"&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;arrayFld positionFld limitFld &rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>A context keeps track of the progress of a method</span></div>
<div class="line left">
<span class="bold large"><br>Initialization</span></div>
<div class="line left">
<span class="bold small">cleancopy<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑Context new<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">sender: sender<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">receiver: receiver<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">method: method<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">tempframe: tempframe copy<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pc: pc<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">stackptr: stackptr]</span></div>
<div class="line left">
<span class="bold small">copy<br></span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ Context new<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">sender: sender<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">receiver: receiver<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">method: method<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">tempframe: tempframe<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pc: pc<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">stackptr: stackptr<br>]</span></div>
<div class="line left">
<span class="bold small">sender: sender receiver: receiver<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold small">method: method tempframe: tempframe pc: pc stackptr: stackptr</span></div>
<div class="line left">
<span class="bold large"><br>Access to parts</span></div>
<div class="line left">
<span class="bold small">caller </span><span class="small">[⇑sender]<br></span></div>
<div class="line left">
<span class="bold small">getPT: i  </span><span class="small">[ ⇑ tempframe◦i ]</span></div>
<div class="line left">
<span class="bold small">mclass </span><span class="small">| selector mclass</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"return the class in which method was found"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[sender ≡ nil ⇒ [⇑receiver class]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">selector &larr; self selector.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">mclass &larr; receiver class.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">until⦂ mclass ≡ nil do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[(mclass method: selector) ≡ method ⇒ [⇑mclass]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">mclass &larr; mclass superclass].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑receiver class]</span></div>
<div class="line left">
<span class="bold small">method<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑method]</span></div>
<div class="line left">
<span class="bold small">pc </span><span class="small">[⇑pc]</span></div>
<div class="line left">
<span class="bold small">receiver<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑receiver]</span></div>
<div class="line left">
<span class="bold small">selector </span><span class="small">| mclass selector</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"return the selector for my method"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[selector &larr; sender thisop.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">selector◦(1~19)=&rsquo;performDangerously:&rsquo;⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[mclass &larr; receiver class.</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"special work for perform"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">until⦂ [mclass ≡ nil or⦂ (selector&larr;mclass md invert: method)] do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[mclass &larr; mclass superclass]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">selector≡false⇒[⇑↪confused] ⇑selector]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑selector]</span></div>
<div class="line left">
<span class="bold small">sender </span><span class="small">[⇑sender]</span></div>
<div class="line left">
<span class="bold small">sender&larr; sender </span><span class="small">[]</span></div>
<div class="line left">
<span class="bold small">setPT: i to: n  </span><span class="small">[ tempframe◦i &larr; n ]</span></div>
<div class="line left">
<span class="bold small">stackIndex </span><span class="italic small">"Return the subscript in tempframe of my top of stack."</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑stackptr+1]</span></div>
<div class="line left">
<span class="bold small">swapSender: coroutine </span><span class="small">| oldSender<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[oldSender &larr; sender. sender &larr; coroutine. ⇑oldSender]</span>&nbsp;&nbsp;&nbsp;&nbsp;</div>
<div class="line left">
<span class="bold small">tempframe<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑tempframe]</span></div>
<div class="line left">
<span class="bold small">totalPT </span><span class="small">[⇑ (method◦5)+1 ]</span></div>
<div class="line left">
<span class="bold large"><br>Control structures</span></div>
<div class="line left">
<span class="bold small">for⦂ var1 from: expr1 with⦂ var2 from: expr2 do⦂ stmt </span><span class="small">| s1 s2<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[s1 &larr; expr1 asStream. s2 &larr; expr2 asStream.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ [(var1 value &larr; s1 next) and⦂ (var2 value &larr; s2 next)] do⦂ stmt eval]<br></span></div>
<div class="line left">
<span class="bold large"><br>Debugging</span></div>
<div class="line left">
<span class="bold small">debug </span><span class="small">| t v<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self print.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ [user cr. t &larr; user request: &rsquo;*&rsquo;] do⦂  </span><span class="italic small">"until ctrl-d"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[v &larr; Generator new evaluate: t asStream in: false to: self notifying: nil.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">↪debugret=v⇒[self print] v print]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑↪debugret]</span></div>
<div class="line left">
<span class="bold small">printon: strm </span><span class="small">| mc<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"Print the selector which invoked this Context<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">  and the class in which code was found for that selector"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> mc &larr; self mclass.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> strm append: mc title. sender≡nil⇒ []<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> [receiver is: mc⇒[] strm append: &rsquo;(&rsquo;+receiver class title+&rsquo;)&rsquo;].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> strm append: &rsquo;⇒&rsquo;; print: self selector]</span></div>
<div class="line left">
<span class="bold small">restartWith: method<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[tempframe &larr; tempframe copy: 1 to: method◦3.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self restart]</span></div>
<div class="line left">
<span class="bold small">stack </span><span class="small">| a strm<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"Return a Vector of me and all my derivative contexts."</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">strm &larr; (Vector new: 20) asStream.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">strm next &larr; a &larr; self.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">when user notifty is fixed,</span><span class="small"> a sender </span><span class="italic small">can become</span><span class="small"> a caller"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">until⦂ (a&larr;a sender)≡nil do⦂ [strm next &larr; a].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑strm contents.]</span></div>
<div class="line left">
<span class="bold small">thisop </span><span class="small">| a</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"return the message selector just sent"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[a &larr; method◦pc.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">a≥0320⇒ [⇑self litof: a-0320]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">a≥0260⇒ [⇑SpecialOops◦(10+a-0260)]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">method◦(pc-1)=0214⇒ [⇑self litof: a]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑↪confused]</span></div>
<div class="line left">
<span class="bold small">trace </span><span class="small">| strm a<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[strm &larr; Stream default. self printon: strm.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">a &larr; sender. until⦂ a≡nil do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[strm cr. a printon: strm. a &larr; a sender]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑strm contents]</span></div>
<div class="line left">
<span class="bold small">variableNamesInto: dest with: block </span><span class="small">| class selector parser<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"For each method variable name, call<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">dest declaration: block name: string asArg: &lt;true or false&gt;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">If cant find source code, call dest notify: "</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">class &larr; self mclass.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">selector &larr; class md invert: method⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[parser &larr; Parser new from: (class code: selector) asStream to: dest.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">parser pattern: block; temporaries: block; terminate]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">dest notify: &rsquo;thisContext is not running a currently defined method&rsquo;]</span></div>
<div class="line left">
<span class="bold small">verifyFrames  </span><span class="small">| c </span><span class="italic small">"be sure frames on stack aren&rsquo;t nil"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[c &larr; self.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> until⦂ c≡nil do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[c tempframe≡nil⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[user notify: &rsquo;Sorry, that stack has been released -- proceeding is impossible&rsquo;; restart]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> c &larr; c sender]]</span></div>
<div class="line left">
<span class="bold large"><br>Simulation</span></div>
<div class="line left">
<span class="bold small">docode: code toclass: class </span><span class="small">| i v<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[[(i&larr;code◦2)≠ 0 ⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[i = 1  ⇒ [⇑self];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">= 30 ⇒ [v &larr; self pop. v push: self. ⇑v];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">= 40 ⇒ [v &larr; self pop instfield: code◦5 + 1. ⇑self push: v];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">= 41 ⇒ [user notify: &rsquo;Field&larr; primitive unimplemented&rsquo;];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">= 87 ⇒ [⇑ receiver "PriorityInterrupt run: newContext"];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">= 101 ⇒ [user notify: &rsquo;Doprimitive unimplemented&rsquo;];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">= 102 ⇒ [⇑self performing: code◦4 toclass: tempframe◦(stackptr+1)]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> (v &larr; self doprimitive: code) ≡ ↪failed ⇒[]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> stackptr &larr; stackptr-(code◦4+1). ⇑self push: v]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> ⇑self newToRun: code]</span></div>
<div class="line left">
<span class="bold small">dojump: displacement<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[pc &larr; pc+displacement]</span></div>
<div class="line left">
<span class="bold small">dopop<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[stackptr &larr; stackptr-1]</span></div>
<div class="line left">
<span class="bold small">doprimitive: code<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑↪failed] primitive: 101</span></div>
<div class="line left">
<span class="bold small">doremotereturn </span><span class="small">| t f<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[t &larr; self pop. f &larr; self pop. ⇑f push: t]</span></div>
<div class="line left">
<span class="bold small">doreturn </span><span class="small">| t<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[t &larr; tempframe◦(stackptr+1). tempframe &larr; nil. ⇑sender push: t]</span></div>
<div class="line left">
<span class="bold small">dostore </span><span class="small">| byte<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[byte &larr; method◦(pc&larr; pc+1).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> byte&lt;020⇒ [self smashField: byte];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">&lt;040⇒ [self smashTemp: byte-020];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">&lt;0100⇒ [user notify: &rsquo;Store into literal&rsquo;];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">&lt;0160⇒ [self smashLitInd: byte-0100];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">&lt;0170⇒ [self instfield: (byte-0157) &larr; tempframe◦(stackptr+1)];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=0210⇒ [self smashField: self nextByte];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=0211⇒ [self smashTemp: self nextByte];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=0213⇒ [self smashLitInd: self nextByte]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> user notify: &rsquo;Illegal store&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">dosuper </span><span class="small">| byte<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[byte &larr; self nextByte.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[byte=0214⇒ [byte &larr; self nextByte+0320]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">byte&lt;0260⇒ [user notify: &rsquo;non-selector after super&rsquo;]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑self sendmess: nil byte: byte toclass: <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(self litof: method◦6-8/2) value superclass]</span></div>
<div class="line left">
<span class="bold small">doUnique </span><span class="small">| r e "cause ◦ &larr; to be done for a UniqueString inside str: inside intern:"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[r &larr; tempframe◦(2+stackptr). "receiver"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"already know class is UniqueString"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">e &larr; &rsquo;bad special message in super&rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(method ≡ (UniqueString md method: ↪str:)) ≡ false ⇒[user notify: e]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"ours, now put result of str: on the stack"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self push: (r &larr; r str: tempframe◦1 "arg").<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">method◦(method length) ≠ 0203 "return" ⇒[user notify: e]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"trick this method into returning"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pc &larr; method length -1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑self]</span></div>
<div class="line left">
<span class="bold small">help<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["Here is how to use the Smalltalk simulator.<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">thisContext runsimulated⦂ [ </span><span class="bold small">place here the code you to simulate</span><span class="small"> ].<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">Some classes in Smalltalk may not be subclassed.  Some messages<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">may not be overridden.  initSimulator tells the details. "]</span></div>
<div class="line left">
<span class="bold small">initSimulator </span><span class="small">| i "these class variables of Context are used by instfield: to simulate what the microcode does to objects."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["  Context declare: &rsquo;positionFld arrayFld limitFld&rsquo;.    "<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"Rules:  There may not be a subclass of Integer.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(This is so +, -, &lt;, &gt;, ≤, ≥, =, ≠ may not be overridden).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">The following messages may NOT be redefined by any class.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">≡ (from class Object).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">class (from class Object).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">The following messages may NOT be redefined by any VariableLengthClass.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">length (from Vector, String)"<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">i &larr; Stream instvars.  "We need to peek inside instances of Stream"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">positionFld &larr; i find: &rsquo;position&rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">arrayFld &larr; i find: &rsquo;array&rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">limitFld &larr; i find: &rsquo;limit&rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">litof: a<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑(method word: a+4) asObject]</span></div>
<div class="line left">
<span class="bold small">newToRun: code </span><span class="small">| r v i</span><span class="bold small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[r &larr; self pop. v &larr; Vector new: code◦3.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> for⦂ i from: (code◦4 to: 1 by: ¬1) do⦂ "Move args to new tframe"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[v◦i &larr; tempframe◦(2+(stackptr &larr; stackptr-1)).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">tempframe◦(stackptr+2) &larr; nil</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"Nil args on caller&rsquo;s stack"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> ⇑self class new sender: self receiver: r method: code<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">tempframe: v pc: code◦6 stackptr: code◦5 - 1. "Allocate a new Context"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">nextByte<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑method◦(pc &larr; pc+1)]</span></div>
<div class="line left">
<span class="bold small">nonEmptyStack<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑(stackptr≠¬1)]</span></div>
<div class="line left">
<span class="bold small">performing: nargs toclass: class </span><span class="small">| i sel<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[i &larr; stackptr-nargs.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">sel &larr; tempframe◦(i+1).</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"Selector is first arg"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ i&lt;stackptr do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[tempframe◦(i+1) &larr; tempframe◦(i+2).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">i &larr; i+1].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">stackptr &larr; stackptr-1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑self sendmess: sel byte: 0320 toclass: class]</span></div>
<div class="line left">
<span class="bold small">pop<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑tempframe◦(2+ (stackptr&larr; stackptr-1))]</span></div>
<div class="line left">
<span class="bold small">push: n </span><span class="small">"Push n on top of stack"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[tempframe◦(1+(stackptr&larr;stackptr+1)) &larr; n]</span></div>
<div class="line left">
<span class="bold small">pushField: i<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[tempframe◦(1+(stackptr&larr;stackptr+1)) &larr; receiver instfield: i+1]</span></div>
<div class="line left">
<span class="bold small">pushLit: i<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[tempframe◦(1+(stackptr&larr;stackptr+1)) &larr; (method word: i+4) asObject]</span></div>
<div class="line left">
<span class="bold small">pushLitInd: i<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[tempframe◦(1+(stackptr&larr;stackptr+1)) &larr; (method word: i+4) asObject value]</span></div>
<div class="line left">
<span class="bold small">pushTemp: i<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[tempframe◦(1+(stackptr&larr;stackptr+1)) &larr; tempframe◦(i+1)]</span></div>
<div class="line left">
<span class="bold small">restart<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[pc &larr; method◦6. stackptr &larr; method◦5-1]</span></div>
<div class="line left">
<span class="bold small">runsimulated⦂ cntxt </span><span class="small">| ctx b i "To use the simulator say...<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">thisContext runsimulated⦂ [your code]. "<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["turn off use of BitBlt by Strings"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">b &larr; String◦↪StringBlter.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">String◦↪StringBlter &larr; false.<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">cntxt push: self.  ctx &larr; cntxt.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">until⦂ ctx≡self do⦂ [ctx &larr; ctx step].<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"restore state of StringBlter"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">String◦↪StringBlter &larr; b.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑self pop]</span></div>
<div class="line left">
<span class="bold small">sendmess: sel byte: byte toclass: class </span><span class="small">| cl code</span><span class="bold small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[cl &larr; class.  until⦂ cl≡nil do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[[byte&lt;0320⇒ "Is it a special message?"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self specialmess: byte toclass: cl⇒ [⇑self] "Can we perform it?"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> sel &larr; SpecialOops◦(byte-0246)] "Send the special message selector"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">  sel≡nil⇒ [sel &larr; self litof: byte-0320]]. "Send the selector from the literals"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> code &larr; cl md methodorfalse: sel⇒ [⇑self docode: code toclass: cl]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">  </span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> cl &larr; cl superclass]. "Try up the superclass chain"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> user notify: (&rsquo;Simulated message not understood: &rsquo; concat: sel asString)]</span></div>
<div class="line left">
<span class="bold small">simulate⦂ cntxt<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[cntxt push: thisContext.  ⇑cntxt inspect]</span></div>
<div class="line left">
<span class="bold small">smashField: i<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[receiver instfield: i+1 &larr; tempframe◦(stackptr+1)]</span></div>
<div class="line left">
<span class="bold small">smashLitInd: i<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[(self litof: i) value &larr; tempframe◦(stackptr+1)]</span></div>
<div class="line left">
<span class="bold small">smashTemp: i<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[tempframe◦(i+1) &larr; tempframe◦(stackptr+1)]</span></div>
<div class="line left">
<span class="bold small">specialmess: byte toclass: class </span><span class="small">| "Return false if cannot do it here, else do exactly what the microcode does."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[byte&lt;0270⇒  "+, -, &lt;, &gt;, ≤, ≥, =, ≠"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑self specialmess: byte toclassInteger: class];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">&lt;0300⇒[⇑false];  "unused"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">&lt;0304⇒   " ◦, ◦&larr;, next, next&larr; "<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑self specialmess: byte toclassArray: class];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=0304⇒ "length"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ [class≡String⇒[] class≡Vector⇒[] ⇑false]. self push: (self pop length)];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=0305⇒ "≡"  [self push: self pop≡self pop]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑false]</span></div>
<div class="line left">
<span class="bold small">specialmess: byte toclassArray: class </span><span class="small">| r n d i s l easy "cause ◦, ◦&larr;, next, next&larr;  to happen"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[d &larr; stackptr.  r &larr; self pop.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[byte=0301 or⦂ byte=0303 ⇒[n &larr; self pop]]. " ◦&larr; or next&larr; "<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[byte&lt;0302⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[   " ◦ or ◦&larr; "<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[class≡Vector⇒[] class≡String⇒[] stackptr &larr; d. ⇑false].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">i &larr; self pop. l &larr; r length]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">class≡Stream⇒ " next or next&larr; "<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[s &larr; r. i &larr; (s instfield: positionFld)+1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">l &larr; (s instfield: limitFld). r &larr; (s instfield: arrayFld).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> [r class≡Vector⇒[]; ≡String⇒[]; ≡Interval⇒[] stackptr &larr; d. ⇑false].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">stackptr &larr; d. ⇑false].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">easy &larr; [r class≡Vector⇒[true]; ≡String⇒[true]; ≡Interval⇒[true] false].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[(i class ≡ Integer) and⦂ (l class ≡ Integer)⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[1≤i and⦂ i≤l⇒  " bounds check "<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[[easy ⇒[byte=0301 or⦂ byte=0303⇒ "in the easy case, we cheat for speed"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[r◦i &larr; n]  " ◦&larr; or next&larr; "<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">n &larr; r◦i]  " ◦ or next "<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"subclass of Vector or String"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">byte=0301 or⦂ byte =0303 ⇒[r instfield: i &larr; n] " ◦&larr; or next&larr; "<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">n &larr; r instfield: i].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> self push: n.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> [byte&gt;0301⇒[s instfield: positionFld &larr; i]]. ⇑self]]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">stackptr &larr; d. ⇑false]</span></div>
<div class="line left">
<span class="bold small">specialmess: byte toclassInteger: class </span><span class="small">| r n "If class is Integer, do arithmetic"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[class ≡ Integer⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[r &larr; self pop. n &larr; self pop.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> r class ≡ Integer⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑self push: [byte<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=0260⇒ [r+n];  =0261⇒ [r-n];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=0262⇒ [r&lt;n];  =0263⇒ [r&gt;n]; =0264⇒ [r≤n];  =0265⇒ [r≥n];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=0266⇒ [r=n];  =0267⇒ [r≠n]]]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> stackptr &larr; stackptr+2. ⇑false]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑false]</span></div>
<div class="line left">
<span class="bold small">step </span><span class="small">| byte t "Execute the next byte code and return the current Context"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[byte &larr; method◦(pc &larr; pc+1).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑[byte&lt;0200⇒ "load"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[byte&lt;020⇒ [self pushField: byte];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">&lt;040⇒ [self pushTemp: byte-020];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">&lt;0100⇒ [self pushLit: byte-040];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">&lt;0160⇒ [self pushLitInd: byte-0100];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">&lt;0170⇒ [self push: (self instfield: byte-0160+1)]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> self push: SpecialOops◦(byte-0170+2)];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">&lt;0220⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[byte=0200⇒ [self dostore; dopop];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=0201⇒ [self dostore];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=0202⇒ [self dopop];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=0203⇒ [self doreturn];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=0204⇒ [self doremotereturn];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=0205⇒ [self push: self];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=0206⇒ [self dosuper];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=0210⇒ [self pushField: self nextByte];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=0211⇒ [self pushTemp: self nextByte];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=0212⇒ [self pushLit: self nextByte];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=0213⇒ [self pushLitInd: self nextByte];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=0214⇒ [self sendmess: nil byte: self nextByte+0320<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> toclass: (tempframe◦(stackptr+1)) class]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> user notify: &rsquo;Unimplemented instruction code&rsquo;];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">&lt;0260⇒ "jump"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[t &larr; [byte&lt;0240⇒[(byte land: 7)+1]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"short, just mask off bfp bit for displacement"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> (byte land: 7)-4*256+self nextByte].</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"long, calculate displacement"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[(byte land: 010)≠0⇒[self pop≡false⇒[self dojump: t]]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"bfp, do branch if top is false"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> self dojump: t].</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"unconditional, do the branch"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> self sendmess: nil byte: byte toclass: (tempframe◦(stackptr+1)) class]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold large"><br>Remote evaluation</span></div>
<div class="line left">
<span class="bold small">eval </span><span class="small">[user croak] primitive: 30</span></div>
<div class="line left">
<span class="bold small">remoteCopy<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">| tResult</span><span class="bold small"><br></span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">tResult &larr; RemoteContext new<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">sender: sender<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">receiver: receiver<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">method: method<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">tempframe: tempframe<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pc: pc+2<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">stackptr: stackptr.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">tResult initialize.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ tResult<br>]</span></div>
<div class="line left">
<span class="bold large"><br>Interpretation</span></div>
<div class="line left">
<span class="bold small">have: receiver interpret: method<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"Warning -- someone must be holding methodⓢ literals."</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"Warning -- do not call as self have:interpret: or cycle will result"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">tempframe &larr; (Vector new: method◦3).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self restart. ⇑self interpretFor: thisContext sender]</span></div>
<div class="line left">
<span class="bold small">interpret: objectCode with: tframe<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"interpret in new context with tempframe tframe"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"Warning -- someone must be holding objectCodeⓢ literals."</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"Warning -- do not call as self interpret:with: or cycle will result"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑(Context new<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">sender: nil receiver: receiver<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">method: objectCode tempframe: tframe<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pc: objectCode◦6 stackptr: objectCode◦5-1)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">  interpretFor: thisContext sender]</span></div>
<div class="line left">
<span class="bold small">interpretFor: sender  </span><span class="italic small">"resume execution"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[PriorityInterrupt new run: self]</span></div>
<div class="line left">
<span class="bold large"><br>Deallocation</span></div>
<div class="line left">
<span class="bold small">destroyAndReturn: value<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[thisContext sender &larr; sender.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">tempframe all &larr; nil.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑value]</span></div>
<div class="line left">
<span class="bold small">eraseFully<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[tempframe≡nil⇒ []<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">tempframe all &larr; nil. tempframe &larr; nil]</span></div>
<div class="line left">
<span class="bold small">release | s</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"release frames to break cycles"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ [tempframe≡nil⇒[] tempframe all&larr; nil. tempframe &larr; nil].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">receiver&larr; nil.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">sender≡nil⇒[] <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">not sure if this works correctly</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"[sender Isnt: Context⇒[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">until⦂ (sender Is: Context) do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[s&larr; sender instfield: 1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">sender instfield: 5&larr; nil.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s≡nil⇒[⇑self] sender&larr; s]]]."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">sender release]</span></div>
<div class="line left">
<span class="bold small">releaseFully </span><span class="small">| c </span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"nullify frames to break cycles"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[c &larr; self.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> until⦂ c≡nil do⦂ [c eraseFully. c &larr; c sender]]</span></div>
<div class="line left">
<span class="bold small">releaseTo: pContext<br></span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">sender ≡ pContext ⇒ [ sender &larr; nil. ]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">sender releaseTo: pContext.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">sender &larr; nil.<br>]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪Context under: &rsquo;Kernel Classes&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"RemoteContext"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;RemoteContext&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: Context<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo; <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fSavedPC<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fSavedStackptr<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;&rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>CONTEXT FOR REMOTE CODE</span></div>
<div class="line left">
<span class="bold large"><br>REMOTE CONTEXT</span></div>
<div class="line left">
<span class="bold small">caller<br></span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ tempframe ◦ (fSavedStackptr+2)<br>]</span></div>
<div class="line left">
<span class="bold small">cleancopy<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">| tResult<br>[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">tResult &larr; RemoteContext new<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">sender: sender<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">receiver: receiver<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">method: method<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">tempframe: tempframe copy<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pc: pc<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">stackptr: stackptr.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">tResult initialize.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ tResult<br>]</span></div>
<div class="line left">
<span class="bold small">initialize<br></span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">fSavedPC &larr; pc.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">fSavedStackptr &larr; stackptr.<br>]</span></div>
<div class="line left">
<span class="bold small">releaseTo: pContext<br></span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">tempframe ◦ (fSavedStackptr+2) ≡ pContext ⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ tempframe ◦ (fSavedStackptr+2) &larr; nil. ]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">tempframe ◦ (fSavedStackptr+2) releaseTo: pContext.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">tempframe ◦ (fSavedStackptr+2) &larr; nil.<br>]</span></div>
<div class="line left">
<span class="bold small">restart<br></span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pc &larr; fSavedPC.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">stackptr &larr; fSavedStackptr.<br>]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪RemoteContext under: &rsquo;Kernel Classes&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"UserView"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;UserView&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: Object<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;screenrect "&lt;Rectangle&gt; current screen size"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">vtab "&lt;Integer=0mod2&gt; offset from hardware top"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">htab "&lt;Integer=0mod16&gt; offset from hardware left"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">scale "&lt;Integer=1 or 2&gt; 2 means double bits mode"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">color "&lt;Integer=0 or 1&gt; 1 means reverse field"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">projectWindow "my representative in an overview"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">disp "&lt;dispframe&gt; default message stream"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">sched "&lt;Vector&gt; Windows in this view"&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;currentCursor mxoffset myoffset screenMenu &rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>This is a melting-pot, incorporating the notions of user interaction (mouse, keyboard), display context (current screen view), and global operations (reading the clock, leaving the system).</span></div>
<div class="line left">
<span class="bold large"><br>Mouse, Cursor, Keys</span></div>
<div class="line left">
<span class="bold small">anybug </span><span class="small">[⇑self buttons &gt;0 or⦂ (mem◦0177100) &lt; 0]</span></div>
<div class="line left">
<span class="bold small">anykeys </span><span class="small">[⇑self keyset&gt;0]</span></div>
<div class="line left">
<span class="bold small">bluebug </span><span class="small">[⇑self buttons=2]</span></div>
<div class="line left">
<span class="bold small">buttons<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑7-(mem◦0177030 land: 7)]</span></div>
<div class="line left">
<span class="bold small">currentCursor </span><span class="small">[⇑currentCursor]</span></div>
<div class="line left">
<span class="bold small">currentCursor: c </span><span class="small">| coff oldpt [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">oldpt &larr; self mp.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">currentCursor &larr; c.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">coff &larr; c offset.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">mxoffset &larr; coff x - htab.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">myoffset &larr; coff y - vtab.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self cursorloc &larr; oldpt]</span></div>
<div class="line left">
<span class="bold small">cursorloc &larr; pt <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[mem◦0424 &larr; pt x - mxoffset*scale.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">mem◦0425 &larr; pt y - myoffset*scale]</span></div>
<div class="line left">
<span class="bold small">kbck </span><span class="small">| t<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[t &larr; self rawkbck⇒[⇑kbMap◦t] self purgealittle. ⇑false ]</span></div>
<div class="line left">
<span class="bold small">kbd </span><span class="small">[until⦂ self rawkbck do⦂ [self purgealittle]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑kbMap◦self rawkbd]</span></div>
<div class="line left">
<span class="bold small">kbd: char<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"stuff char into the event queue"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[char is: String ⇒[char &larr; char◦1]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">Events next &larr;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">UserEvent new<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">x:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self x</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"event x"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">y:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self y</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"event y"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">type:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">1</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"2=up, 1=down"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">stroke:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(kbMap find: char)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"1-336"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">elapsed:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">Events</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">elapsedtime</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"1-32767 sixtieths of a sec"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">time:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">Events time + Events elapsedtime.]</span></div>
<div class="line left">
<span class="bold small">kbdnext </span><span class="small">| event</span><span class="bold small"> </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"returns next character (mapped) if any; otherwise false"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(event &larr; Events dequeue) or⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(event &larr; Events primitiveDequeue)] do⦂ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">event isKbdDown⇒ [⇑kbMap◦event stroke]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"self rawkbck⇒ [⇑kbMap◦Events next stroke]"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑false]</span></div>
<div class="line left">
<span class="bold small">keyset<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"Fix a bug in sysdefs."</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑037 - ((mem◦0177030 lshift: ¬3) land: 037)]</span></div>
<div class="line left">
<span class="bold small">leftShiftKey </span><span class="small">["left shift key down?" ⇑(mem◦0177036 land: 0100) = 0]</span></div>
<div class="line left">
<span class="bold small">mp<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[scale=2⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑Point new<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">x: mem◦0424 + mxoffset / 2<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">y: mem◦0425 + myoffset / 2]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑Point new<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">x: mem◦0424 + mxoffset<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">y: mem◦0425 + myoffset]</span></div>
<div class="line left">
<span class="bold small">mpnext </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">return next mouse point if red button or tablet is down; otherwise false</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self redbug⇒ [⇑self mp]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑false]</span></div>
<div class="line left">
<span class="bold small">nobug<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑self anybug ≡ false]</span></div>
<div class="line left">
<span class="bold small">rawkbck </span><span class="small">| event</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"flush event queue until down keyboard event or queue empty."</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[while⦂ (event &larr; Events peek) do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[event isKbdDown ⇒[⇑event stroke] Events next].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑false</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"if queue empty, return false"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">rawkbd </span><span class="small">| stroke<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[until⦂ (stroke &larr; self rawkbck) do⦂ [].</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"wait for activity"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">Events next.  ⇑stroke</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"if key down, pop queue and return stroke"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">redbug </span><span class="small">[⇑self buttons=4 or⦂ (mem◦0177100) &lt; 0]</span></div>
<div class="line left">
<span class="bold small">tablet </span><span class="small">[⇑(mem◦0177100) ≠ 0]</span></div>
<div class="line left">
<span class="bold small">tabletabsolute </span><span class="small">[mem◦0126 &larr; 1]</span></div>
<div class="line left">
<span class="bold small">tabletbug </span><span class="small">[⇑(mem◦0177100) &lt; 0]</span></div>
<div class="line left">
<span class="bold small">tabletrelative </span><span class="small">[mem◦0126 &larr; ¬1]</span></div>
<div class="line left">
<span class="bold small">waitbug<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[until⦂ self anybug do⦂ [] ⇑self mp]</span></div>
<div class="line left">
<span class="bold small">waitclickbug<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self waitnobug. ⇑self waitbug]</span></div>
<div class="line left">
<span class="bold small">waitnobug<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[while⦂ self anybug do⦂ [] ⇑self mp]</span></div>
<div class="line left">
<span class="bold small">waitnokey </span><span class="small">[until⦂ self keyset=0 do⦂ [self rawkbck]]</span></div>
<div class="line left">
<span class="bold small">x </span><span class="small">[⇑mem◦0426 - htab</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"cursorx, horiz tab adjusted"</span><span class="small">]</span></div>
<div class="line left">
<span class="bold small">y </span><span class="small">[⇑mem◦0427 - vtab</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"cursory, vert tab adjusted"</span><span class="small">]</span></div>
<div class="line left">
<span class="bold small">yellowbug </span><span class="small">[⇑self buttons=1]</span></div>
<div class="line left">
<span class="bold large"><br>Screen Views</span></div>
<div class="line left">
<span class="bold small">bugScreenMenu<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["see classInit"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">screenMenu bug<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=1⇒[projectWindow≡nil⇒[] projectWindow runParent];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=2⇒[user quit];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=3⇒[self restartup: ProjectWindow init];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=4⇒[self restartup: BrowseWindow default];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=5⇒[self restartup: (CodeWindow new class: UserView selector: ↪workspace<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">para: (UserView code: ↪workspace) formerly: false)];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=6⇒[user displayoffwhile⦂ [self reclaim]]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">color: color scale: scale</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self install]</span></div>
<div class="line left">
<span class="bold small">copyIn: p<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑UserView new<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">screenrect: screenrect copy<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">vtab: vtab htab: htab scale: scale color: color<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">projectWindow: p<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">disp: disp sched: ↪()]</span></div>
<div class="line left">
<span class="bold small">displayoffwhile⦂ expr </span><span class="small">| t v<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["t &larr; mem◦0420. mem◦0420 &larr; 0."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">t &larr; mem◦067. mem◦067 &larr; 58 "disp text frame maxY/2 ?".<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">v &larr; expr eval.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">mem◦067 "0420" &larr; t. ⇑v]</span></div>
<div class="line left">
<span class="bold small">install<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self screenextent: screenrect extent tab: htab⌾vtab]</span></div>
<div class="line left">
<span class="bold small">projectWindow </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[projectWindow≡nil⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[projectWindow &larr; ProjectWindow new.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">projectWindow userview: self changes: Changes parent: projectWindow]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑projectWindow]</span></div>
<div class="line left">
<span class="bold small">reconfigure </span><span class="small">[] primitive: 62</span></div>
<div class="line left">
<span class="bold small">restoredisplay<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[mem◦0420 &larr; 060. mem◦067 &larr; screenrect height/2]</span></div>
<div class="line left">
<span class="bold small">screenextent: extent tab: tab </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">mem◦065 &larr;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(color*040000)+[scale=2⇒[0100000] 0]+(tab x/16*0400)+(extent x/16|2).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">mem◦067 &larr; extent y*scale/2.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">mem◦063 &larr; 1 max: tab y/2.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">htab &larr; tab x|16.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">vtab &larr; mem◦063*2.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">screenrect &larr; 0⌾0 rect: (extent x|32)⌾(extent y|2).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self currentCursor: currentCursor;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">reconfigure; restore]</span></div>
<div class="line left">
<span class="bold small">screenrect </span><span class="small">[⇑screenrect]</span></div>
<div class="line left">
<span class="bold small">screenrect: screenrect vtab: vtab htab: htab scale: scale color: color projectWindow: projectWindow disp: disp sched: sched</span></div>
<div class="line left">
<span class="bold large"><br>Window Scheduling</span></div>
<div class="line left">
<span class="bold small">leaveTop</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">leave the top window if there is one</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[sched length=0⇒[]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(sched◦1) leave]</span></div>
<div class="line left">
<span class="bold small">promote: window<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[sched promote: window]</span></div>
<div class="line left">
<span class="bold small">restart </span><span class="small">| i <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[[Events ≡ nil ⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[Events &larr; EventQueue init. </span><span class="italic small">"Top init3.  initialize Event queue and Time interrupt"</span><span class="small">]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">NormalCursor topage1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self restart⦂ [user run]]</span></div>
<div class="line left">
<span class="bold small">restart⦂ code </span><span class="small">| u<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[u &larr; code cleancopy. u sender &larr; nil.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">thisContext sender releaseFully.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">thisContext sender &larr; nil.</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">code &larr; nil. </span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"release caller chain"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">MessageDict new freeMethods.</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"release held code"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">disp frame flash.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ true do⦂ [u eval]]</span></div>
<div class="line left">
<span class="bold small">restartup: window<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ </span><span class="italic small">"Equivalent to schedule new window, restart, and redbug in window, except firsttime is already done."</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">thisContext sender releaseFully. thisContext sender &larr; nil.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">NormalCursor topage1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self schedule: window.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">thisContext tempframe all &larr; nil.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self run: true]</span></div>
<div class="line left">
<span class="bold small">restore </span><span class="small">| w<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[screenrect clear.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[projectWindow≡nil⇒[] projectWindow putTitle].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ w from: (sched length to: 1 by: ¬1) do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[(sched◦w) show]]</span></div>
<div class="line left">
<span class="bold small">run<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self run: false]</span></div>
<div class="line left">
<span class="bold small">run: topFlag </span><span class="small">| i w forward</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"topFlag means sched◦1 already is awake"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[forward &larr; [topFlag⇒ [w&larr;sched◦1. while⦂ w eachtime do⦂ []. w lasttime] true].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ true do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[i&larr;0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">until⦂ [(i&larr;i+1)&gt;sched length⇒[]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">w&larr; [forward⇒[sched◦i] sched◦(sched length+1-i)].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">w firsttime] do⦂ []<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">i&gt;sched length⇒</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"check for bug in empty space"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[user yellowbug⇒[self bugScreenMenu]]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">sched promote: w.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ w eachtime do⦂ []<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">forward&larr; w lasttime]]</span></div>
<div class="line left">
<span class="bold small">sched </span><span class="small">[⇑sched]</span></div>
<div class="line left">
<span class="bold small">schedule: window<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[sched≡nil⇒[sched &larr; window inVector]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">sched &larr; window inVector concat: sched]</span></div>
<div class="line left">
<span class="bold small">scheduleOnBottom: window<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[sched≡nil⇒[sched &larr; window asVector]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">sched &larr; sched concat: window asVector]</span></div>
<div class="line left">
<span class="bold small">topWindow </span><span class="small">[⇑sched◦1]</span></div>
<div class="line left">
<span class="bold small">unschedule: window </span><span class="small">| t<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[0&lt;(t&larr; sched find: window)⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[sched &larr; sched◦(1 to: t-1) concat: sched◦(t+1 to: sched length)]]</span></div>
<div class="line left">
<span class="bold large"><br>Notify Window</span></div>
<div class="line left">
<span class="bold small">notifier: titleString level: lev interrupt: flag<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"Restore the full display.  Schedule a one-paned window to notify the user that errorString happened."</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self restoredisplay.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">NotifyFlag≡false⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[disp cr;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">append: &rsquo;NotifyFlag is false...&rsquo;; cr;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">append: &rsquo; top-blank shows stack, user restart aborts,&rsquo;; cr;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">append: &rsquo; tempframe shows args, ctrl-d proceeds&rsquo;; cr;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">append: titleString; cr; show.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(Top◦lev) debug. ⇑false]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑NotifyWindow new of: titleString level: lev interrupt: flag]</span></div>
<div class="line left">
<span class="bold small">notifier: titleString stack: stack interrupt: flag<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"Restore the full display.  Schedule a one-paned window to notify the user that errorString happened."</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self restoredisplay.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">NotifyFlag≡false⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[disp cr;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">append: &rsquo;NotifyFlag is false...&rsquo;; cr;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">append: &rsquo; sender debug shows stack, user restart aborts,&rsquo;; cr;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">append: &rsquo; tempframe shows args, ctrl-d proceeds&rsquo;; cr;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">append: titleString; cr; show.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">stack debug. ⇑false]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑NotifyWindow new of: titleString stack: stack interrupt: flag]</span></div>
<div class="line left">
<span class="bold small">notify: errorString </span><span class="small">| notifyWindow<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"Create a notify window looking at the Context stack"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">notifyWindow &larr; self notifier: errorString stack: thisContext sender interrupt: false.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">notifyWindow⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[thisContext sender &larr; nil.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> Top currentPriority=1⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self restartup: notifyWindow]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> self scheduleOnBottom: notifyWindow.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> Top errorReset]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑nil]</span></div>
<div class="line left">
<span class="bold large"><br>Dialog Window</span></div>
<div class="line left">
<span class="bold small">clear</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"clear disp of debris and characters"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[disp clear]</span></div>
<div class="line left">
<span class="bold small">clearshow: str<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[disp clear; append: str; show]</span></div>
<div class="line left">
<span class="bold small">cr </span><span class="small">[disp cr]</span></div>
<div class="line left">
<span class="bold small">croak<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self notify: &rsquo;A primitive has failed.&rsquo;]</span></div>
<div class="line left">
<span class="bold small">ev<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[disp ev]</span></div>
<div class="line left">
<span class="bold small">frame</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"return rectangle of dialogue window"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑disp text frame]</span></div>
<div class="line left">
<span class="bold small">newdisp </span><span class="italic small">"for when some class associated with running Dispframe  changed"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self unschedule: disp.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">disp &larr; Dispframe new rect: (8⌾0 rect: 150⌾96).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self schedule: disp ; clearshow: &rsquo;New Dialogue window created.<br>&rsquo;]</span></div>
<div class="line left">
<span class="bold small">newdisploc: origin and: corner </span><span class="italic small">"for moving disp"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"user newdisploc: 8⌾0 and: 150⌾96"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(disp text frame inset: ¬2⌾¬2) clear.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">disp text frame &larr; origin rect: corner.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">disp show]</span></div>
<div class="line left">
<span class="bold small">next &larr; x </span><span class="small">["simulate a Vector Stream"</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">disp cr; print: x; show]</span></div>
<div class="line left">
<span class="bold small">print: x </span><span class="small">[disp print: x; show]</span></div>
<div class="line left">
<span class="bold small">read </span><span class="small">[⇑disp read]</span></div>
<div class="line left">
<span class="bold small">request: s</span><span class="small">[⇑disp request: s]</span></div>
<div class="line left">
<span class="bold small">show </span><span class="small">[disp outline; show]</span></div>
<div class="line left">
<span class="bold small">show: str<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[disp append: str; show]</span></div>
<div class="line left">
<span class="bold small">space<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[disp space]</span></div>
<div class="line left">
<span class="bold small">tab </span><span class="small">[disp tab]</span></div>
<div class="line left">
<span class="bold large"><br>Time</span></div>
<div class="line left">
<span class="bold small">convertTime: s returnSecs: format </span><span class="small">| d dd t dfirst dlast m570 m571 [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">s is total seconds from midnight Jan 1 1901 GMT (Greenwich mean time).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">see maxc &lt;AltoDocs&gt;AltoTime.Press for details</span><span class="small">"<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">time zone specific parameters</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">m570 &larr; mem◦0570. m571 &larr; mem◦0571.<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">adjust for time zone</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s &larr; s + (([m570 ≥ 0⇒ ["</span><span class="italic small">west</span><span class="small">" ¬1] "</span><span class="italic small">east</span><span class="small">" 1]) * (<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(3600 * ("</span><span class="italic small">hours</span><span class="small">" m570 bits: (1 to: 4))) +<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(60 * ("</span><span class="italic small">additonal minutes</span><span class="small">" m571 bits: (1 to: 6))))).<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">t &larr; s intdiv: 86400.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">current day (in local standard time)</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">d &larr; Date new fromDays: t◦1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[format⇒ [] t &larr; Time new fromSeconds: t◦2].<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">check for DST. correct DST parameters for nonleap years and<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">round to previous Sunday if necessary</span><span class="small">"<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">day of the year on or before which DST takes effect</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">dfirst &larr; m570 land: 0777 "bits: (7 to: 15)".<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[[dfirst = 366⇒ ["</span><span class="italic small">DST not in effect</span><span class="small">" false]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(dd &larr; d day) ≥ (dfirst &larr; dfirst + d leap - 1)⇒ [<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">day of the year on or before which DST ends</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">dlast &larr; (m571 land: 0777 "bits: (7 to: 15)") + d leap - 1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">dd &lt; dlast "</span><span class="italic small">if false, definitely after</span><span class="small">" and⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">dd &lt; ((Date new day: dlast year: d year) previous: 6) day]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">possibly earlier than or at beginning of range</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">dd ≥ ((Date new day: dfirst year: d year) previous: 6) day]⇒ [<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">daylight savings time in effect. add an hour</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">format⇒ [s &larr; s + 3600]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">t hours = 23⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">d &larr; d+1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">t hours: 0]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">t hours: t hours+1]].<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">return either total seconds or Date and Time</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">format⇒ [⇑s] ⇑d,t]</span></div>
<div class="line left">
<span class="bold small">dateAndTime: secs </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">secs is a String of 4 characters representing seconds (in GMT) since Jan 1 1901.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">convert it to a LargeInteger (rawtotalsecs:), then return a Vector (Date, Time),<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">which is corrected for local time zone and daylight savings</span><span class="small">"<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑self convertTime: (self rawtotalsecs: secs) returnSecs: false]</span></div>
<div class="line left">
<span class="bold small">now </span><span class="small">[⇑self dateAndTime: self timewords]</span></div>
<div class="line left">
<span class="bold small">rawtotalsecs </span><span class="small">[⇑self rawtotalsecs: self timewords]</span></div>
<div class="line left">
<span class="bold small">rawtotalsecs: secs </span><span class="small">| s [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">secs is a String of 4 characters representing seconds (in GMT) since Jan 1 1901.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">copy (in reverse order) to a Natural string, then return a LargeInteger"<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s &larr; Natural new: 4.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s◦1 &larr; secs◦4.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s◦2 &larr; secs◦3.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s◦3 &larr; secs◦2.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s◦4 &larr; secs◦1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑LargeInteger new bytes: s neg: false]</span></div>
<div class="line left">
<span class="bold small">ticks </span><span class="small">"Return the 38.08-millisecond interval timer"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑mem◦0430]</span></div>
<div class="line left">
<span class="bold small">time </span><span class="small">[⇑self now◦2]</span></div>
<div class="line left">
<span class="bold small">time⦂ expr </span><span class="small">| t<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[t &larr; self ticks.  expr eval.  ⇑self ticks-t]</span></div>
<div class="line left">
<span class="bold small">timewords </span><span class="small">| s [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">seconds (in GMT) since Jan 1 1901: as a String</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s &larr; String new: 4.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s word: 1 &larr; mem◦0572; word: 2 &larr; mem◦0573.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑s]</span></div>
<div class="line left">
<span class="bold small">today </span><span class="small">[⇑self now◦1]</span></div>
<div class="line left">
<span class="bold small">totalsecs </span><span class="small">[⇑self totalsecs: self timewords]</span></div>
<div class="line left">
<span class="bold small">totalsecs: secs </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">convert from GMT to local and correct for Daylight Savings</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑self convertTime: (self rawtotalsecs: secs) returnSecs: true]</span></div>
<div class="line left">
<span class="bold large"><br>Changes</span></div>
<div class="line left">
<span class="bold small">changedCategories </span><span class="small">| titles space str<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["return a vector of the names of class categories which have been changed"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">space &larr; &rsquo; &rsquo;◦1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">titles &larr; HashSet new init.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ str from: Changes contents do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[titles insert: (<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">SystemOrganization invert: ((Stream new of: str) upto: space) unique)].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑titles contents<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">changedClasses </span><span class="small">| titles space str<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["return a vector of the names of classes which have been changed"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">space &larr; &rsquo; &rsquo;◦1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">titles &larr; HashSet new init.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ str from: Changes contents do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[titles insert: ((Stream new of: str) upto: space). "class title"].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑titles contents<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">changedMessages </span><span class="small">[⇑Changes contents sort]</span></div>
<div class="line left">
<span class="bold small">noChanges </span><span class="small">[Changes init]</span></div>
<div class="line left">
<span class="bold large"><br>System quit/resume</span></div>
<div class="line left">
<span class="bold small">backup   </span><span class="italic small">"back up smalltalk on ivy and resume"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ivy open; delete: &rsquo;small.boot&rsquo;; store: &rsquo;small.boot&rsquo;; close]</span></div>
<div class="line left">
<span class="bold small">hasXM<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["return true if this is XM Smalltalk"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑(mem◦0147)≠0 </span><span class="italic small">"1 for XM, 0 for normal"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">InLd: fileid  "write out the core image, then load in OS"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[user notify: &rsquo;file problem&rsquo;] primitive: 85</span></div>
<div class="line left">
<span class="bold small">overlay: fileid </span><span class="small">| t [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">dp0 stampBoot.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self releaseExternalViews.<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">put the ethernet to sleep</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[E≡nil⇒ [] E sleep].<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">turn off display during quit/resume</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">t &larr; mem◦0420. mem◦0420 &larr; 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self InLd: fileid.<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">we start here after a resume</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">mem◦0420 &larr; t.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ user keyset&gt;0 do⦂ [user show: &rsquo;The keyset is stuck&rsquo;; cr]]</span></div>
<div class="line left">
<span class="bold small">quit <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self quitFrom: self </span><span class="italic small">"yup"</span><span class="small">]</span></div>
<div class="line left">
<span class="bold small">quitFrom: controller<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self overlay: ↪(0 0 0 0 0).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self hasXM⇒[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">screenrect clear.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">controller restore]]</span></div>
<div class="line left">
<span class="bold small">quitThen: str </span><span class="small">| rem rest ["</span><span class="italic small">quit, then have OS execute str</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">rem &larr; (dp0 file: &rsquo;rem.cm&rsquo;) readonly.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">rest &larr; rem next: rem length.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">rem readwrite; reset; append: str; cr; append: rest; close.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self quit]</span></div>
<div class="line left">
<span class="bold small">quitThen: s continue: r </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[s⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">something for O.S. to do</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(dp0 oldFile: &rsquo;rem.cm.&rsquo;) settoend;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">append: s; append: &rsquo;; &rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">append: [r⇒ [&rsquo;Resume.~ small.boot&rsquo;] &rsquo;Quit.~; Resume.~ small.boot&rsquo;];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">cr; flush]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self quit]</span></div>
<div class="line left">
<span class="bold small">releaseExternalViews </span><span class="small">| t [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">close some things that we know about, everything else gets released</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">Sources close. dp0 close. dp1 close.<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">release (obsolete) some external views, usually File related</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ t from: externalViews length to: 1 by: ¬1 do⦂ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(externalViews◦t) release. externalViews◦t &larr; nil].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">externalViews reset]</span></div>
<div class="line left">
<span class="bold small">Swat </span><span class="small">[] primitive: 90</span></div>
<div class="line left">
<span class="bold large"><br>Misc System Stuff</span></div>
<div class="line left">
<span class="bold small">classInit </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">screenMenu &larr; Menu new string:<br>&rsquo;exit to overview<br>quit<br>open a subview<br>open a browser<br>open a workspace<br>reclaim&rsquo;]</span></div>
<div class="line left">
<span class="bold small">classNames</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"an alphabetized Vector of all Smalltalk class titles uniqued"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">| classes x c<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">AllClassNames≡nil⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">classes &larr; (Vector new: 20) asStream.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ x from: Smalltalk do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">c &larr; Smalltalk ◦ x.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(c is: Class) or⦂ (c is: VariableLengthClass)⇒ [classes next &larr; x].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">AllClassNames &larr; classes contents sort.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑AllClassNames<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">file: file classes: classes changesOnly: ch </span><span class="small">| cl [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">called by </span><span class="bold small">UserView release</span><span class="italic small"> to write just changes or entire system on a<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">new file.  also, see comment in </span><span class="bold small">Class archiveOn:changesOnly:</span><span class="small">.</span><span class="italic small"><br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">write class comment and message text onto a </span><span class="bold small">FileStream</span><span class="italic small"> (which could refer<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">to an </span><span class="bold small">AltoFile, ILFile</span><span class="italic small">, etc.). either just changes or everything are<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">written and replaced with </span><span class="bold small">RemoteParagraph</span><span class="italic small"> references</span><span class="small">"<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ch⇒ [file settoend] file reset].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">file readwriteshorten.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ cl from: classes do⦂ [Smalltalk◦cl archiveOn: file changesOnly: ch].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">file close; readonly]</span></div>
<div class="line left">
<span class="bold small">growSmalltalk: numberofdiskpages<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">for preemptive growth of Small.boot on disk</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[dp0 growSmalltalkBy: numberofdiskpages]</span></div>
<div class="line left">
<span class="bold small">initCompiler  </span><span class="italic small">"Initialize shared variables of parser and generators"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">| code sel c t<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">Smalltalk declare: ↪(TokenCodes ByteCodes).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[TokenCodes≡nil⇒ [TokenCodes&larr;SymbolTable new init: 32]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ByteCodes≡nil⇒ [ByteCodes&larr;SymbolTable new init: 32. Integer sharing: ByteCodes]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">TokenCodes<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">declare:<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">↪(aRightBrack aPeriod </span><span class="italic small">"First 2 in this order"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">aLeftPar aSemicolon aCondArrow aHand aReturnArrow<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">aLeftBrack aRightPar aLeftArrow<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">aBinary </span><span class="italic small">"All above must be less, all below must be greater"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">aNumber aString </span><span class="italic small">"All below must be in that order"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">aKeyword aGibberish aColon aDigit aWord)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">as:<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">↪(1 2<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">3 4 5 6 7<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">8 9 10<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">20<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">30 31<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">41 42 43 44 45<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">ByteCodes<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">declare:<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">↪(toLoadField toLoadTemp toLoadLit toLoadLitInd<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">toLoadCtxt toLoadTempframe<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">toLoadConst toLoad0 toLoad1 toLoadSelf toLoadNil toLoadFalse toLoadTrue<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">toSmashPop toSmash toPop toReturn toEnd toLoadThisCtxt toSuper<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">toShortJmp toShortBfp toLongJmp toLongBfp<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">toPlus toMinus toGtr toGeq toNext toEq toNew toAsStream<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">toSendLit)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">as:<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">↪(0 16 32 64<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">112 116<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">120 121 122 113 125 126 127<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">128 129 130 131 132 133 134<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">144 152 160 168<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">176 177 179 181 194 197 203 207<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">208).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">c &larr; Dictionary new init: 16.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">c insertall: ↪(&rsquo;self&rsquo; &rsquo;thisContext&rsquo; &rsquo;super&rsquo; &rsquo;nil&rsquo; &rsquo;false&rsquo; &rsquo;true&rsquo;)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">with: ↪(113 133 134 125 126 127).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">ByteCodes declare: ↪stdPrimaries as: c.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">c &larr; Dictionary new init: 64.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">code &larr; 175.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ sel from: SpecialOops ◦(10 to: SpecialOops length) do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ </span><span class="italic small">"Atoms not wanted here -- only strings and characters"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">code &larr; code+1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">sel≡nil ⇒ []<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">sel &larr; [sel length=1 and⦂ (sel◦1) isletter ≡ false ⇒ [sel◦1] sel asString].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">c insert: sel with: code.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">ByteCodes declare: ↪stdSelectors as: c.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">c &larr; Dictionary new init: 8.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">c insertall: ↪(&rsquo;while⦂do⦂&rsquo; &rsquo;until⦂do⦂&rsquo; &rsquo;for⦂to:do⦂&rsquo; &rsquo;for⦂from:do⦂&rsquo; &rsquo;for⦂from:to:by:do⦂&rsquo; &rsquo;for⦂from:to:do⦂&rsquo; &rsquo;if⦂then⦂else⦂&rsquo; &rsquo;if⦂then⦂&rsquo;)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">with: ↪(whiledo:args: untildo:args: fortodo:args: forfromdo:args: forfromtobydo:args: forfromtodo:args: ifthenelse:args: ifthen:args:).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">ByteCodes declare: ↪inLineMsgs as: c.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ t from: ↪((toLoadFieldLong 0210) (toLoadTempLong 0211) (toLoadLitLong 0212)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(toLoadLitIndLong 0213) (toSendLitLong 0214)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(codeLoadField 0400) (codeLoadTemp 01000) (codeLoadLit 01400)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(codeLoadLitInd 02000) (codeSendLit 02400)) do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ByteCodes declare: t◦1 as: t◦2]]</span></div>
<div class="line left">
<span class="bold small">oopsToFile </span><span class="small">| a c i t s cs f ts<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[f &larr; dp0 file: &rsquo;oops&rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">cs &larr; user classNames transform⦂ a to⦂ Smalltalk◦a.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">t &larr; cs transform⦂ a to⦂ a asOop.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">ts &larr; t permutationToSort.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i from: ts do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[f append: (t◦i) base8; tab; append: (cs◦i) title; cr].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ c from: cs◦ts do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[f cr; append: c title; cr.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s &larr; c md contents.</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"selectors"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">t &larr; s transform⦂ a to⦂ (c md method: a) asOop.  </span><span class="italic small">"method oops"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i from: t permutationToSort do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[f tab; append: (t◦i) base8; tab; append: s◦i; cr]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user show: c title; cr]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">f close]</span></div>
<div class="line left">
<span class="bold small">printCrossReference: classNames on: f </span><span class="small">| dict m md frame l each s class<br>"user displayoffwhile⦂ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user printCrossReference: user classNames<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">on: (dp0 file: &rsquo;CrossReference.Press&rsquo;)].<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user classNames<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(SystemOrganization category: &rsquo;xyz&rsquo;)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">↪(class1 class2)"<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[dict &larr; Dictionary init: 200.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ m to: 32 do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[dict insert: SpecialOops◦(9+m) with: ↪((Primitives) ()) copy].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">classNames transform⦂ each to⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[user show: each; space.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">md&larr; (Smalltalk◦each) md.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ m from: md do⦂</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"Tally all the UniqueString literals"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[s&larr; dict lookup: m⇒[] dict insert: m with: (s&larr; ↪(()()) copy)].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s◦1 has: each⇒[] s◦1&larr; s◦1, each.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ l from: (md literals: m) do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[l is: UniqueString⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[s&larr; dict lookup: l⇒[] dict insert: l with: (s&larr; ↪(()()) copy)].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s◦2 has: each⇒[] s◦2&larr; s◦2, (each,m)]]]].<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">f&larr; f asPressPrinter.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">f stamp.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">frame&larr; f defaultframe.</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"Print the messages out sorted"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ m from: dict contents sort do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[user show: m; space.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">f frame&larr; frame.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">md&larr; dict◦m.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s&larr; (String new: 200) asStream.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s append: m; append: [(md◦1) length=0⇒[&rsquo; ( - undefined -  &rsquo;] &rsquo; (&rsquo;].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ l from: (md◦1) sort do⦂ [s append: l; append: &rsquo;, &rsquo;].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s skip: ¬2; append: &rsquo;)&rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">f print: (s contents asParagraph maskrun: 1 to: m length under: 1 to: 1).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">f frame&larr; (frame minX+500)⌾frame minY rect: frame corner.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s reset.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[md◦1 has: ↪Primitives⇒[s append: &rsquo;untallied.&rsquo;. md◦2&larr; ↪()]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(md◦2) length=0⇒[s append: &rsquo;- unreferenced -&rsquo;]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">class&larr; ↪-.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ l from: (md◦2) sort do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[l◦1=class⇒[s append: &rsquo;, &rsquo;]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[class≠↪-⇒[s cr]]. s append: &rsquo;(&rsquo;; append: l◦1; append: &rsquo;) &rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">class&larr; l◦1].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s append: l◦2].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">f print: s contents asParagraph].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">f close; toPrinter]</span></div>
<div class="line left">
<span class="bold small">purgealittle </span><span class="small">[] primitive: 89</span></div>
<div class="line left">
<span class="bold small">reclaim </span><span class="small">| c cl cv</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">" Should only be called from bugScreenMenu !! "<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[user cr; show: &rsquo;Reclaiming... &rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">cl&larr; CodePane, ScrollBar, PanedWindow, ListPane, Generator, Parser, BitImage, Document, DocumentEditor, Image.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">cv&larr; Context allInstances.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user print: cv length.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ c from: cv do⦂ [cl has: c mclass⇒[c release]]. cv all&larr; nil.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user show: &rsquo; reduced to &rsquo; + Context howMany asString + &rsquo;.&rsquo;]</span></div>
<div class="line left">
<span class="bold small">release </span><span class="small">| m [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">prepare to release this version</span><span class="small"> (</span><span class="small bold underline">after</span><span class="small"> editing </span><span class="bold small">UserView version</span><span class="small">)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">and possibly copying Sources file (see </span><span class="bold small">writeSources:</span><span class="small">)"<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(m&larr; Undeclared contents) length&gt;0⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[user notify: &rsquo;Undeclared contains &rsquo;+ m asString]<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user displayoffwhile⦂ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">either create a new Sources file (write all messages) or append only changes</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">m &larr; Sources directory checkName:<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">&rsquo;&lt;Smalltalk&gt;Smalltalk.Sources.&rsquo; + user versionName.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"for repeated releases in same version.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">should also work for Sources local (if renamed)"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user writeSources: [m = Sources name⇒ [Sources] Sources directory file: m].<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">make workspace local</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">UserView md code: ↪workspace &larr; UserView code: ↪workspace.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user writeChangedMessages: (phylum file: &rsquo;&lt;Smalltalk&gt;ChangedMessages&rsquo;).].<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user noChanges. user releaseMessage.]</span></div>
<div class="line left">
<span class="bold small">releaseMessage </span><span class="small">[user clearshow: &rsquo;Welcome to &rsquo; + user version]</span></div>
<div class="line left">
<span class="bold small">systemStartup </span><span class="italic small">"To do after system flush and installation of new core image"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[Top top.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">Window classInit.<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"The following screen extent seems to really fill the screen in x,<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">the Alto Hardware Manual to the contrary notwithstanding."</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self hasXM⇒ ["</span><span class="italic small">XM</span><span class="small">" self screenextent: 640⌾800 tab: 0⌾2]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self screenextent: 640⌾480 tab: 0⌾50].<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">Sources release. dp0 release. dp1 release.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self releaseExternalViews.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[E≡nil⇒ [] "</span><span class="italic small">ignore broadcasts</span><span class="small">" E broadcastFilter: true].<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(VirtualMemory new) thisvmem.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">Vmem afterBirth]</span></div>
<div class="line left">
<span class="bold small">systemworkspace1</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">for system releasers only!!!<br><br>this has been partitioned into three workspaces for editing convenience:<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">systemworkspace1<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">steps 0-4: general comments, handling Sources, creating a release.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">systemworkspace2<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">steps 5-7: doing a vmem write or surgery, storing finished files on Phylum<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">systemworkspace3<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">step 8: after a release, e.g. updating press files</span><span class="small"><br><br><br></span><span class="bold small">0.</span><span class="italic small"> This boot file should be named small.boot for vmem writing, surgery, and command file purposes.  If you made changes to the Sources disk be sure to update the current versions of (Xm)Smalltalk.Run, (Xm)Smalltalk.Syms, and (Xm)Byterp.mb on [Ivy]&lt;Smalltalk&gt;. This procedure works best on a Dorado for speed and disk space reasons, and it also can be done on an Alto (double disk O.S. required for vmem write).  Microcode changes (including making non-xm versions) must(?) be done on an Alto.  Step 5 (vmem writing) assumes enough space for another boot file.  To turn off display during execution, hold down left shift key while selecting &rsquo;doit&rsquo;.<br><br>For those who want to vmem write their own versions, do not execute steps 4, 7 or 8 without further editing of file and directory names. </span><span class="small italic underline">Underlined items</span><span class="italic small"> are typical values and normally must be edited to be useful.<br><br></span><span class="small"><br></span><span class="bold small">1.</span><span class="italic small"> to create an xm version:  filin changes and selected goodies. Undeclared must be empty for release to work (step 4). copy the categories of classes which have changed to systemworkspace3 (for later printing) and recompile it.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">dp0 filin: ↪(&rsquo;</span><span class="small underline">changes.st</span><span class="small">&rsquo;).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">phylum filin: ↪(&rsquo;&lt;Small-goodies&gt;</span><span class="small underline">xx.st</span><span class="small">&rsquo;).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">Undeclared contents inVector, user changedCategories<br><br><br></span><span class="bold small">2.</span><span class="italic small"> update version number/letter and comments in UserView version<br><br><br></span><span class="bold small">3.</span><span class="italic small"> the Sources file will be ordinarily be created in step 4. if only a few changes are involved, it may be somewhat faster to copy the old sources file to the new sources file (this step). then step 4 will only append changes.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">phylum store: Sources reset as: &rsquo;Smalltalk.Sources.&rsquo; + user versionName.<br><br></span><span class="italic small"><br></span><span class="bold small">4. </span><span class="italic small">checks Undeclared, writes all or appends changed messages to Sources file, updates ChangedMessages, inits Changes, puts up greeting, and sets the default user name & password. note: this is only to be executed for releasing the Smalltalk system itself (supply the proper password!!). if you plan to do a vmem write next, better to do this as first line of step 5.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user releaseExternalViews.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">phylum name: &rsquo;Smalltalk&rsquo; password: &rsquo;</span><span class="small underline">password</span><span class="small">&rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user release.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">phylum name: &rsquo;Smalltalk-User&rsquo; password: &rsquo;Smalltalk&rsquo;.<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">to write out the sources for a private version, specify which directory to use (don&rsquo;t leave Smalltalk as the default) and which categories and/or classes are to be included.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">| c classes. user releaseExternalViews. classes &larr; (Vector new: 50) asStream.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">phylum name: &rsquo;</span><span class="small underline">name</span><span class="small">&rsquo; password: &rsquo;</span><span class="small underline">password</span><span class="small">&rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ c from: ↪(</span><span class="small underline">&rsquo;category1&rsquo; class1</span><span class="small">) do⦂ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">c is: String⇒ [classes append: (SystemOrganization category: c)]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">classes next &larr; c].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user file: (phylum file: &rsquo;</span><span class="small underline">&lt;ddd&gt;xx</span><span class="small">.Sources.&rsquo; + user versionName)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">classes: classes contents changesOnly: false.<br>"</span></div>
<div class="line left">
<span class="bold small">systemworkspace2</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">for system releasers only!!!<br><br><br></span><span class="bold small">5.</span><span class="italic small"> if no surgery or vmem write involved, skip to step 7. start here with an xm version to make a non-xm version.  specify option below:<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">1 vmem write (includes xm surgery)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">2 xm surgery<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">3 non-xm surgery<br>to make things totally automatic, edit in your valid Maxc name and password, otherwise Ftp will ask you later. in the case of surgery only, at the end you will have to hit a key after safing.<br></span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">| option prefix dir file.<br>option &larr; </span><span class="small underline">1</span><span class="small">.<br>dir &larr; phylum asFtpDirectory.<br>dir directoryName: &rsquo;Smalltalk-76&rsquo;.<br>prefix &larr; [option=3⇒ [&rsquo;&rsquo;] &rsquo;Xm&rsquo;].<br>for⦂ file from: ↪(&rsquo;Smalltalk.Run&rsquo; &rsquo;Smalltalk.Syms&rsquo; &rsquo;Byterp.Mb&rsquo;) do⦂ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">dir retrieve: prefix + file as: file].<br>dir closeThen: ([option=1⇒ [&rsquo;delete oldsmall.boot;<br>copy newsmall.boot &larr; small.boot; &rsquo;] &rsquo;&rsquo;]) + <br>&rsquo;ftp maxc Login/c </span><span class="small underline">yourname yourpassword</span><span class="small"> directory/c alto retrieve/c packmu.run ramload.run;<br>Resume small.boot;<br>Ramload/N Byterp.mb/F 1000/A;<br>Smalltalk.run&rsquo;.<br><br>option=1⇒ [(VirtualMemory new) giveBirth3. user quit]<br>Vmem ramwrite: (dp0 oldFile: &rsquo;byterp.mb&rsquo;).<br>Vmem surgery: (dp0 oldFile: &rsquo;Smalltalk.run&rsquo;).<br><br><br></span><span class="bold small">6</span><span class="italic small">. after a successful vmem write or surgery, execute this (selecting here is tricky or type in a Dispframe)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user systemStartup.<br><br><br></span><span class="bold small">7</span><span class="italic small">. edit lastversion (and Smalltalk password) and execute the following, then close this window (clean up screen for non-xm?), and quit. it then renames old versions of files, stores new versions of files, e.g. remote XmSmall.Boot becomes XmSmall.Boot.5.5g and local Small.Boot becomes remote XmSmall.Boot<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">| lastversion dir file remotefile.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">lastversion &larr; &rsquo;</span><span class="small underline">5.5j</span><span class="small">&rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">dir &larr; phylum asFtpDirectory.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">dir login: &rsquo;Smalltalk&rsquo; password: &rsquo;</span><span class="small underline">password</span><span class="small">&rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ file from: ↪(&rsquo;Small.Boot&rsquo; &rsquo;Smalltalk.Syms&rsquo;) do⦂ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">remotefile &larr; ([user hasXM⇒ [&rsquo;Xm&rsquo;] &rsquo;&rsquo;]) + file.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">dir rename: remotefile newName: remotefile + &rsquo;.&rsquo; + lastversion;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">store: file as: remotefile].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(dp0 file: &rsquo;rem.cm&rsquo;) append: dir commands; cr; close.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user releaseMessage.<br>"</span></div>
<div class="line left">
<span class="bold small">systemworkspace3</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">for system releasers only!!!<br></span><span class="small"><br><br></span><span class="bold small">8.</span><span class="italic small"> to update press files for system categories or cross reference listing directly on Phylum, browse or spawn this window.  edit pf to specify a list of system categories to print, usually from step 1, e.g. user changedCategories: ↪(&rsquo;Basic Data Structures&rsquo; ...) or SystemOrganization categories (for all); delete toPrinter if you don&rsquo;t want the press files printed. edit xref to be user classNames if you want to generate a cross reference listing.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> | pf xref cat.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pf &larr; </span><span class="small underline">↪  (&rsquo;Text Objects&rsquo; &rsquo;Kernel Classes&rsquo; &rsquo;Press File Support&rsquo; &rsquo;IFS File System&rsquo; &rsquo;Alto File System&rsquo; &rsquo;Panes and Menus&rsquo; &rsquo;Files&rsquo; &rsquo;Juniper&rsquo; &rsquo;Windows&rsquo; &rsquo;Graphical Objects&rsquo; &rsquo;Numbers&rsquo; &rsquo;Basic Data Structures&rsquo; )</span><span class="small">.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">xref &larr; </span><span class="small underline">↪()</span><span class="small">.<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user releaseExternalViews.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">phylum name: &rsquo;Smalltalk&rsquo; password: &rsquo;</span><span class="small underline">password</span><span class="small">&rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ cat from: pf do⦂ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">((phylum file: (cat + &rsquo;.Press&rsquo;) asFileName) asPressPrinter) stamp;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">printclass: (SystemOrganization category: cat); close</span><span class="small underline">; toPrinter</span><span class="small">].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">xref empty⇒ []<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user printCrossReference: xref on: (phylum file: &rsquo;CrossReference.Press&rsquo;).<br>"</span></div>
<div class="line left">
<span class="bold small">version </span><span class="small">[⇑&rsquo;Smalltalk </span><span class="bold small">5.5k</span><span class="small"> &rsquo; + [user hasXM⇒ [&rsquo;XM &rsquo;] &rsquo;&rsquo;] + &rsquo;</span><span class="bold small">November 24</span><span class="small">&rsquo;]<br>"user version<br><br>low level disk address calculations are more general (necessary for 14-sector Dorado/Dolphin file systems)<br>better error recovery for broken and timed out Leaf connections<br>AltoFileDirectory disk page allocation/deallocation bugs fixed<br>miscellaneous printing fixes<br>Juniper fixes (2)<br>goodie: again-del-forget.st<br>create/write dates on boot file are updated at quit time<br>primitives for reading/writing 3K CRAM<br>Phylum account changes <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">default Leaf connection is logged in to &lt;Smalltalk-User&gt;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">system release uses [Phylum]&lt;Smalltalk-76&gt; instead of [Ivy]&lt;Smalltalk&gt;<br>see UserView workspace for logging into your account on Phylum, changing default printer -- for information on [Phylum]&lt;Smalltalk&gt;Release-5.5k.Bravo, .Press<br><br></span><span class="bold small">September 3, 5.5j<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">duplicate packet fix<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">fixes to ether (routing table, name lookup, phylum, Int32), printer names,<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">files, UserView time messages, context simulation,<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">replace in BitBlt & Paragraph, NotifyWindow cleanup,<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">Class code: always decompiles with left shift key, window printing fixes,<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">SystemOrganization globalComment contains no nulls<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">the following changes files were included:<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[phylum]&lt;small-goodies&gt;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">5.5i.changes.st, notifychange.st, window-print-changes.st<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[phylum]&lt;findit&gt;5.5i.more.changes.st<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[maxc]&lt;dolbec&gt;int32change.st<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[maxc&gt;ingalls&gt;fixes.st<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ivy]&lt;kaehler&gt;context-simulation.st<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ivy]&lt;borning&gt;context-changes.st<br><br></span><span class="bold small">May 1, 5.5i<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">obscure file bugs eliminated; version features added (goody: File-version.st).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">Ifs multiple connections fixed; Ifs error numbers looked up in Ifs.Errors.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">duplicate packets eliminated at lowest level.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">Int32 primitive fix. Juniper retransmit parameters increased<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">Integer compare: LargeInteger now works<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">CodePane/FilePane &rsquo;print&rsquo; (within a CodeWindow) now prints entire Paragraph<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">rather than only part within window<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">ScrollBars hide during CodePane </span><span class="italic small">again & cancel</span><span class="small">. </span><span class="italic small">cancel</span><span class="small"> saves your old text, so<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">an immediate </span><span class="italic small">undo</span><span class="small"> will replace the current selection with your previous text.<br><br></span><span class="bold small">April 11, 5.5h<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">Alto file names limited to 39 characters (&rsquo;somestring&rsquo; asFileName will fix<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">name, truncating if necessary). other misc. file, ether, simulator fixes.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">BitBlt fixed so that BitRects don&rsquo;t lose their bits<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">BitBlt used to speedup reading&writing files, sending Press files to printers<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">ParagraphScanner puts underlining into Press files<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">printer names updated (PressFile classInit). hashing-changes.st included.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">after font cataclysm, get new version of Fonts.Widths before printing<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">system release procedure modified<br><br></span><span class="bold small">March 6, 5.5g</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">ether, file, vmem writing fixes.  cursor clipping on screen boundary.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">BitBlt used for String growing, copying, replacing<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">goodies included: display-off-after-notify.st, CodePane-doit.st,<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">context-simfix2.st, ILchanges.st, string-changes.st<br><br>see [Phylum]&lt;Smalltalk&gt; for the following files.  () surround an optional prefix or suffix.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">Document.Press<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">mini-guide to Smalltalk system and user interface<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">VersionHistory<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">information about versions up to 5.5g<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">ChangedMessages<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">a list of  messages which have changed<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">xxx.Press<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">press file for CrossReference or for system category &rsquo;xxx&rsquo; in current version<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">to save paper, consider consulting the LRG alcove copies<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(Xm)Small.Boot(.version)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(Xm)Smalltalk.Syms(.version)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">older versions of .Boot and .Syms are explicitly named.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">Smalltalk.Sources.version<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">all Smalltalk.Sources (including the current one) are explicitly named<br><br>[Phylum]&lt;Small-Goodies&gt; contains miscellaneous bug fixes and new features (and even some documentation: goodies.bravo, .press) offered by the community of Smalltalk Users.<br>"</span></div>
<div class="line left">
<span class="bold small">versionName </span><span class="small">| s [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s &larr; self version asStream.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"skip Smalltalk"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s skipTo: 040.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"return version identification, e.g. 5.5f"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑s upto: 040]</span></div>
<div class="line center">
<span class="bold small">workspace<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[user notify: &rsquo;Not meant to be executed&rsquo;]<br>"<br></span><span class="giant monospace">XEROX</span><span class="small"> - </span><span class="bold small">Learning Research Group</span><span class="small"><br> <br>user screenextent: 640⌾580 tab: 0⌾50.<br>NotifyFlag &larr; true.</span><span class="italic small"><br></span><span class="small">Changes init.<br>user changedMessages<br>user changedClasses<br>user changedCategories<br>Undeclared contents<br></span><span class="italic small"><br>to set the default printer</span><span class="small"><br>PrinterName&larr;&rsquo;Menlo&rsquo;.<br>PrinterName&larr;(PressFile new) selectPrinter: PrinterName.<br><br></span><span class="italic small">to change phylum to access your account<br></span><span class="small">user releaseExternalViews. phylum name: &rsquo;name&rsquo; password: &rsquo;password&rsquo;.<br><br>dp0 filin: ↪(&rsquo;Changes.st&rsquo;).<br>(dp0 file: &rsquo;changes.st&rsquo;) filout.<br>(dp0 file: &rsquo;xxx&rsquo;) edit.<br>dp0 pressfilin: ↪(&rsquo;xxx.press&rsquo;).<br>(dp0 filesMatching: &rsquo;*.st&rsquo;) sort<br>dp0 list. dp0 freePages<br>dp0 delete: &rsquo;old&rsquo;<br>dp0 rename: &rsquo;old&rsquo; newName: &rsquo;new&rsquo;<br><br></span><span class="italic small">for reinitializing Sources and phylum<br></span><span class="small">Sources release. phylum release. Sources reopen.<br><br></span><span class="italic small">to make Smalltalk Sources local</span><span class="small"><br> | s. s &larr; &rsquo;Smalltalk.Sources.&rsquo;.<br>(phylum asFtpDirectory) retrieve: &rsquo;&lt;Smalltalk&gt;&rsquo; + s + user versionName as: s; close.<br>Sources on: (dp0 file: s).<br><br></span><span class="italic small">to switch back to remote Sources</span><span class="small"><br>Sources close; on: (phylum file: &rsquo;&lt;Smalltalk&gt;Smalltalk.Sources.&rsquo; + user versionName).<br><br><br></span><span class="italic small">to filin a remote Smalltalk file</span><span class="small"><br>phylum filin: ↪(&rsquo;&lt;Small-goodies&gt;xxx.st&rsquo;).<br><br></span><span class="italic small">to print a remote/local press file</span><span class="small"><br>(phylum pressfile: &rsquo;&lt;Smalltalk&gt;xxx.press&rsquo;) toPrinter.<br>(dp0 pressfile: &rsquo;xxx.press&rsquo;) toPrinter: &rsquo;Lilac&rsquo;.<br><br>File noChanges.<br>BitRect new fromuser; edit.<br>user schedule: (defaultBitRectEditor newframe).<br><br>DocumentEditor new defaultdocument: &rsquo;test&rsquo;.<br>DocumentEditor new init: (Document new fromPress: &rsquo;test.document&rsquo;).<br><br></span><span class="italic small"><br></span><span class="small">user releaseExternalViews.<br>E sleep. E kill. E &larr; nil.<br>E &larr; Etherworld new. E broadcastFilter: true. E wakeup.<br>Sources reopen.<br><br></span><span class="italic small">for primary Smalltalk access to file servers and printers at other sites.<br>substitute yourserver for phylum above, compile this workspace<br></span><span class="small">PrinterName &larr; &rsquo;name-of-your-printer&rsquo;.<br>Smalltalk declare: ↪yourserver.<br>yourserver &larr; ILFileDirectory new directory: &rsquo;name-of-your-server&rsquo;.<br>yourserver name: &rsquo;Smalltalk-User&rsquo; password: &rsquo;Smalltalk&rsquo;.<br>Sources on: (yourserver file: &rsquo;&lt;Smalltalk&gt;Smalltalk.Sources.&rsquo; + user versionName).<br>Changes init.<br><br>user Swat.<br>"</span></div>
<div class="line left">
<span class="bold small">writeChangedMessages: ChangedMessages </span><span class="small">| class m ms [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"append changed messages to a file (usually on [phylum])"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">ChangedMessages settoend; cr; cr; asParagraphPrinter stamp.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">class &larr; &rsquo;&rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ m from: user changedMessages do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ms&larr; m asStream.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(ms upto: 040)=class⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ChangedMessages append: &rsquo;, &rsquo;; append: (ms upto: 040)]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">ChangedMessages cr; append: m.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">class&larr; m asStream upto: 040].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">ChangedMessages close]</span></div>
<div class="line left">
<span class="bold small">writeSources: newSources </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"write a new Sources file (usually on [phylum]Smalltalk.Sources.xxx<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(i.e. xxx = user versionName))<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">if it&rsquo;s a new file or empty, write all Sources. otherwise it better be a copy of<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">the previous Sources file (only changes will be appended. do the copy with ftp)"<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user file: newSources classes: SystemOrganization<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">changesOnly: (newSources end ≡ false).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">Sources close.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">Sources &larr; newSources]<br></span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪UserView under: &rsquo;Kernel Classes&rsquo;.</span></div>
<div class="line left">
<span class="small">UserView classInit</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"VariableLengthClass"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;VariableLengthClass&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: Class<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;&rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">veryspecial: 20;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>I am a class whose instances have numbered elements instead of named fields.</span></div>
<div class="line left">
<span class="bold large"><br>Initialization</span></div>
<div class="line left">
<span class="bold small">classInit</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"gets propagated to a dummy instance"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[(self new: 1) classInit]</span></div>
<div class="line left">
<span class="bold large"><br>Instance access</span></div>
<div class="line left">
<span class="bold small">allInstances </span><span class="small">[user notify: &rsquo;use allInstances: instead to specify the length range&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"the length ranges are 0,1,2,3,4,5,6,7,8 individually and groups 9 (to 16), 17 (to 32), 33 (to 64), 65, 129, 257, 513, 1025, 2049, and 4197"</span><span class="small">]</span></div>
<div class="line left">
<span class="bold small">allInstances: len </span><span class="small">[⇑(self allInstancesEver: len) notNil]</span></div>
<div class="line left">
<span class="bold small">allInstancesEver: len </span><span class="small">| indx vec PCLs i </span><span class="italic small">"returns a vector containing all instances of this class and length mixed with nils"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"for large lengths, instances come in groups with lengths within a single power of 2"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">PCLs &larr; Vmem pclassesOf: self length: len.  </span><span class="italic small">"vector of PCLs"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">vec &larr; Vector new: 128*PCLs length.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: PCLs length do⦂ <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[(vec◦[i-1*128+1 to: i*128]) all&larr; PCLs◦i].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">thisContext destroyAndReturn:<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(self fromFreelist: (Vmem freelistOffset: len) fill: vec)]</span></div>
<div class="line left">
<span class="bold small">copy: inst </span><span class="small">| t i<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[t &larr; self new: inst length.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: inst length do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[t◦i &larr; inst◦i]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑t]</span></div>
<div class="line left">
<span class="bold small">howMany: len </span><span class="small">| v </span><span class="italic small">"how many instances of this class and length are in use now?"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[v &larr; self allInstancesEver: len.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">thisContext destroyAndReturn: v length - (v count: nil)]</span></div>
<div class="line left">
<span class="bold small">new<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[user notify: &rsquo;use new: &lt;Integer=length&gt; here.&rsquo;]</span></div>
<div class="line left">
<span class="bold small">new: length<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[length&gt;16384 ⇒[user notify: length asString+<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">&rsquo; is too big a String&rsquo;]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">length&gt;8192 ⇒[user notify: length asString+<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">&rsquo; is too big a Vector&rsquo;]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">length&lt;0 ⇒[user notify: length asString+<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">&rsquo; -- negative length is invalid&rsquo;]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑self new: length asInteger] primitive: 29</span></div>
<div class="line left">
<span class="bold small">recopy: inst </span><span class="small">| t i<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[t &larr; self new: inst length.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: inst length do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[t◦i &larr; (inst◦i) recopy]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑t]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪VariableLengthClass under: &rsquo;Kernel Classes&rsquo;.</span></div>
    <div class="line left">
<span class="small">&rsquo;From Smalltalk 5.5k XM November 24 on 22 November 1980 at 2:57:08 am.&rsquo;<br></span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large">"Natural"</span></div>
<div class="line left">
<span class="bold large">VariableLengthClass new title: &rsquo;Natural&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: String<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;Naturalzero &rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">bytesize: 8;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>A Natural consists of digits between 0 and 255. Accessing beyond the end gives zeroes. This Class is intended to be used by people who implement nicer numbers such as LargeInteger or Rational, thus some of the messages are hard to use because they smash existing Naturals. These messages are only used on Naturals that were created by the programmer using the message.<br>Since we want to eventually have the result of a LargeInteger operation to return a SmallInteger if possible, Natural numbers do not respond to the same set of arithmetic messages as Integers. All of the messages for Natural numbers are preceeded by "nat".</span></div>
<div class="line left">
<span class="bold large"><br>Arithmetic</span></div>
<div class="line left">
<span class="bold small">natadd: arg </span><span class="small">| shorter longer i z sum<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["returns a Natural number"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">z &larr; MachineDouble init.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self length &lt; arg length  ⇒ [longer &larr; arg. shorter &larr; self]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">longer &larr; self. shorter &larr; arg].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">sum &larr; Natural new: (longer length).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: longer length do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[z increaseby: longer ◦ i. z increaseby: shorter ◦ i.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">sum ◦ i &larr; z extract].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[z low ≠ 0 ⇒ [ sum &larr; sum growby: 1. sum last &larr; z low]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑sum]</span></div>
<div class="line left">
<span class="bold small">natcompare: arg </span><span class="small">| i len<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"speeded up for Integer args, same speed for LargeInteger (Natural) args"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[len &larr; self length.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">arg length &lt; len⇒ [⇑3]; &gt; len⇒[⇑1]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i from: len to: 1 by: ¬1 do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[(arg◦i) &lt; (self◦i)⇒[⇑3];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">&gt; (self◦i)⇒[⇑1]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑2]</span></div>
<div class="line left">
<span class="bold small">natdiv: arg </span><span class="small">| quo rem ql d div dh dnh z z2 dl q i j k l carry digit flag<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["returns a vector of (quotient, remainder)"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">l &larr; ((self length) - (arg length) + 1).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[l≤0 ⇒[⇑(Naturalzero, self)]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">d &larr; 8 - (arg last hibit).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">rem &larr; self natnormalize: d. "makes a copy and shifts"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">div &larr; arg natnormalize: d. "shifts so high order word is &gt;127"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">quo &larr; Natural new: l.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">dl &larr; div length - 1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">ql &larr; l.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">dh &larr; div◦dl.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">dnh &larr; [dl=1 ⇒[0](div◦(dl-1))].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">z &larr; MachineDouble init.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">z2 &larr; MachineDouble new.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ k to: ql do⦂</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"maintain quo*arg+rem=self"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[j &larr; rem length + 1 - k.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">z high &larr; rem◦j.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[z high = dh ⇒ [q &larr; ¬1]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">z low &larr; rem◦(j-1).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">q &larr; z mdiv: dh.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">z low &larr; [j&lt;3⇒[0]rem◦(j-2)].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">z2 gets: q mtimes: dnh.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">flag &larr; true.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ ((z &lt; z2) and⦂ flag) do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[q &larr; q unsignedadd: ¬1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> z2 decreaseby: dnh.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> [z2 high &lt; dh ⇒ [flag &larr; false]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">z2 high &larr; z2 high - dh]]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">l &larr; j - dl.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">z2 init.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">carry &larr; 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: div length do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[z gets: q mtimes: (div◦i).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">z2 increaseby: rem◦l.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">z2 decreaseby: carry.  "subtract q * div from rem"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">z2 decreaseby: z low.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">carry &larr; z high.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">rem◦l &larr; z2 extract.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">l &larr; l+1].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[z2 low = 255 ⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[q &larr; q unsignedadd: ¬1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">l &larr; j - dl.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">z init.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: div length do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[z increaseby: rem◦l.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">z increaseby: (div◦i).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">rem◦l &larr; z extract.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">l &larr; l+1]]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">quo◦(quo length + 1 - k) &larr; q.].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">rem &larr; rem natunnormalize: d lookfirst: dl.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[quo last = 0 ⇒ [ql&lt;2⇒[]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">quo &larr; quo growby: ¬1]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑(quo,rem)]</span></div>
<div class="line left">
<span class="bold small">natdivideandCarry: arg extra: pair </span><span class="small">| i len z<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["arg is an integer &lt; 256 - returns remainder, smashes self to quotient - pair is a 2-vector of len (index of high order non-zero word in self) and a MachineDouble - be careful!!!"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">z &larr; pair ◦ 2.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">z high &larr; 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">len &larr; pair ◦ 1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i from: len to: 1 by: ¬1 do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[z low &larr; self ◦i.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self ◦ i &larr; (z mdiv: arg)].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self ◦ len = 0 ⇒[len &larr; len - 1. len=0⇒[len &larr; 1]]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pair ◦ 1 &larr; len.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑z high]</span></div>
<div class="line left">
<span class="bold small">natnormalize: n </span><span class="small">| x i r f digit<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["n is the number of bits to shift by. The Natural number returned will be written over repeatedly, so we must make a new one."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">r &larr; (Natural new: (self length+1)).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">x &larr; 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">f &larr; n-8.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: r length do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[digit &larr; self ◦i.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">r◦i &larr; (digit lshift: n) lor: x.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">x &larr; digit lshift: f.].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑r]</span></div>
<div class="line left">
<span class="bold small">natsubtract: arg </span><span class="small">| shorter longer i z sum sl al ng lastdigit<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["returns an Integer that is created by this operation"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> sl &larr; self length. al &larr; arg length.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> z &larr; MachineDouble init.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> [sl = al ⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[i &larr; sl.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ (((self ◦i)=(arg◦i)) and⦂ (i&gt;1)) do⦂ [i &larr; i - 1].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">sl &larr; i.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self◦i unsignedlessthan: arg◦i ⇒[longer &larr; arg. ng &larr; true. shorter &larr; self]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">longer &larr; self. shorter &larr; arg. ng &larr; false]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">  sl &lt; al  ⇒ [longer &larr; arg. shorter &larr; self. ng &larr; true. sl &larr; al]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">  longer &larr; self. shorter &larr; arg. ng &larr; false].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> sum &larr; Natural new: longer length. lastdigit &larr; 1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> for⦂ i to: longer length do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[z increaseby: longer ◦ i. z decreaseby: shorter ◦ i.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> (sum ◦ i &larr; z extract)≠0⇒[lastdigit&larr;i]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> [lastdigit=longer length⇒[] z &larr; (Natural new: lastdigit).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: lastdigit do⦂ [z◦i &larr; sum◦i]. sum &larr; z].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> ⇑LargeInteger new bytes: sum neg: ng]</span></div>
<div class="line left">
<span class="bold small">nattimes: arg </span><span class="small">| prod z pl carry digit i j k<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[[((self length) = 1) and⦂ ((self◦1) = 0) ⇒ [⇑Naturalzero]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pl &larr; (self length) + arg length.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">prod &larr; (Natural new: pl).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">z &larr; MachineDouble new.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: pl do⦂ [prod ◦ i &larr; 0].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: self length do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[k &larr; i - 1. carry &larr; 0. digit &larr; self ◦ i.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">digit ≠ 0 ⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[for⦂ j to: arg length do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[z gets: digit mtimes: (arg ◦ j).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">z increaseby: carry. k &larr; k + 1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">z increaseby: (prod ◦ k).  "k=i+j-1"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">prod◦k&larr; z low.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">carry &larr; z high]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">prod◦(k+1)&larr;carry]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(prod◦pl) = 0 ⇒ [⇑ prod growby: ¬1]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑prod]</span></div>
<div class="line left">
<span class="bold small">natunnormalize: n lookfirst: a </span><span class="small">| x i r f digit<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[n &larr; 0 - n.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">x &larr; 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">f &larr; n+8.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">i &larr; a.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">digit &larr; self◦i.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ ((((digit lshift: n) lor: x)=0) and⦂ (i≠1)) do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[x &larr; digit lshift: f.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">i &larr; i - 1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">digit &larr; self ◦ i].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">r &larr; (Natural new: i).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">a &larr; i.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">x &larr; (self◦1) lshift: n.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: a do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[digit &larr; self ◦ (i+1).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">r◦i &larr; (digit lshift: f) lor: x.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">x &larr; digit lshift: n.].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑r]</span></div>
<div class="line left">
<span class="bold large"><br>As yet unclassified</span></div>
<div class="line left">
<span class="bold small">◦ n<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[super length &lt; n ⇒ [⇑0]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> ⇑(super◦n)]</span></div>
<div class="line left">
<span class="bold small">asInteger<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self length=1⇒[⇑self◦1]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> ⇑LargeInteger new bytes: self neg: false]</span></div>
<div class="line left">
<span class="bold small">classInit<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[Naturalzero&larr;Natural new: 1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> Naturalzero◦1&larr;0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> ⇑self]</span></div>
<div class="line left">
<span class="bold small">isLarge<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑false]</span></div>
<div class="line left">
<span class="bold small">printon: strm </span><span class="small">[self printon: strm base: 10]</span></div>
<div class="line left">
<span class="bold small">printon: strm base: b </span><span class="small">| p z n b2 x "only works if b≤10"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[p &larr; Stream default.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">z &larr; (self length, MachineDouble new).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">n &larr; Natural new: super length.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">b2 &larr; b*b.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self copyto: n.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">until⦂ (((z ◦ 1) = 1) and⦂ ((n◦1)&lt;b2)) do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[x &larr; (n natdivideandCarry: b2 extra: z).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> p next&larr; (x\b)+060.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> p next&larr; (x/b)+060].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(n◦1) printon: strm base: b.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">strm append: p contents reverse]</span></div>
<div class="line left">
<span class="bold small">species<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑Natural]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪Natural under: &rsquo;Numbers&rsquo;.</span></div>
<div class="line left">
<span class="small">Natural classInit</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"Number"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;Number&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: Object<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;&rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>Numbers in general</span></div>
<div class="line left">
<span class="bold large"><br>Arithmetic</span></div>
<div class="line left">
<span class="bold small">≠ arg<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑((self=arg) ≡ false)]</span></div>
<div class="line left">
<span class="bold small">&lt; n </span><span class="small">[⇑self - n &lt; 0]</span></div>
<div class="line left">
<span class="bold small">= n </span><span class="small">[⇑self - n = 0]</span></div>
<div class="line left">
<span class="bold small">&gt; n </span><span class="small">[⇑self - n &gt; 0]</span></div>
<div class="line left">
<span class="bold small">abs </span><span class="small">[self&lt;0⇒[⇑self * ¬1]]</span></div>
<div class="line left">
<span class="bold small">between: min and: max<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑[min≤self and⦂ self≤max]]</span></div>
<div class="line left">
<span class="bold small">compare: i<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self &lt; i⇒ [⇑1]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self = i⇒ [⇑2]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑3]</span></div>
<div class="line left">
<span class="bold small">factorial  </span><span class="italic small">"I only work for positive integer values"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self=0⇒[⇑1]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑self * (self-1) factorial]</span></div>
<div class="line left">
<span class="bold small">log2 </span><span class="small">| i cnt </span><span class="italic small">"floor of log base 2"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self &lt; 0 ⇒[⇑(self * ¬1) log2]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self &lt; 1 ⇒[⇑((self/self) / self) log2 * ¬1]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">i &larr; 1. cnt &larr; 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ self ≥ i do⦂ [i &larr; i+i. cnt &larr; cnt+1].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑cnt-1]</span></div>
<div class="line left">
<span class="bold small">max: arg<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self&lt;arg⇒[⇑arg]]</span></div>
<div class="line left">
<span class="bold small">min: arg<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self&gt;arg⇒[⇑arg]]</span></div>
<div class="line left">
<span class="bold small">sign<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑[self=0⇒ [0]; &lt;0⇒ [¬1] 1]]</span></div>
<div class="line left">
<span class="bold large"><br>Conversions</span></div>
<div class="line left">
<span class="bold small">asPoint<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"Return a Point with me as both coordinates."</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑self ⌾ self]</span></div>
<div class="line left">
<span class="bold small">asPtX </span><span class="italic small">"pretend to be a Point for Point +-*/"</span></div>
<div class="line left">
<span class="bold small">asPtY </span><span class="italic small">"pretend to be a Point for Point +-*/"</span></div>
<div class="line left">
<span class="bold small">asRectangle<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"Return a Rectangle with me as all coordinates."</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑self ⌾ self rect: self ⌾ self]</span></div>
<div class="line left">
<span class="bold small">asRectCorner </span><span class="italic small">"pretend to be a Rectangle for Rectangle +-*/"</span></div>
<div class="line left">
<span class="bold small">asRectOrigin </span><span class="italic small">"pretend to be a Rectangle for Rectangle +-*/"</span></div>
<div class="line left">
<span class="bold small">base8 </span><span class="small">| s<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[s &larr; Stream default. s append: &rsquo;0&rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self printon: s base: 8. ⇑s contents]</span></div>
<div class="line left">
<span class="bold small">base: b </span><span class="small">| s<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[s &larr; Stream default.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self printon: s base: b. ⇑s contents]</span></div>
<div class="line left">
<span class="bold small">printon: strm </span><span class="small">[self printon: strm base: 10]</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"default print radix"</span></div>
<div class="line left">
<span class="bold large"><br>Subscripts</span></div>
<div class="line left">
<span class="bold small">cansubscript: a<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑self asInteger cansubscript: a]</span></div>
<div class="line left">
<span class="bold small">subscripts: a<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑a◦self asInteger]</span></div>
<div class="line left">
<span class="bold small">subscripts: a &larr; val<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑a◦self asInteger &larr; val]</span></div>
<div class="line left">
<span class="bold large"><br>Intervals, Points</span></div>
<div class="line left">
<span class="bold small">⌾ y<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑Point new x: self y: y]</span></div>
<div class="line left">
<span class="bold small">for: n </span><span class="small">[⇑Interval new from: self to: self+(n-1) by: 1]</span></div>
<div class="line left">
<span class="bold small">to: x<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑Interval new from: self to: x by: 1]</span></div>
<div class="line left">
<span class="bold small">to: x by: y<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑Interval new from: self to: x by: y]</span></div>
<div class="line left">
<span class="bold small">within: int </span><span class="small">[⇑int start ≤ self and⦂ self ≤ int stop]</span></div>
<div class="line left">
<span class="bold small">~ x</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"synonym for </span><span class="bold small">to:</span><span class="small"> "</span><span class="bold small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑Interval new from: self to: x by: 1]</span></div>
<div class="line left">
<span class="bold large"><br>Compatibility</span></div>
<div class="line left">
<span class="bold small">isLarge<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑false]</span></div>
<div class="line left">
<span class="bold small">isNumber</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪Number under: &rsquo;Numbers&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"Date"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;Date&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: Number<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;day year&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;monthnames secsinday &rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>Implements dates. (Steve Weyer)</span></div>
<div class="line left">
<span class="bold large"><br>Initialization</span></div>
<div class="line left">
<span class="bold small">classInit </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">monthnames &larr; ↪(<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">January February March April May June<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">July August September October November December).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">secsinday &larr; 24*60*60]</span></div>
<div class="line left">
<span class="bold large"><br>Setting state</span></div>
<div class="line left">
<span class="bold small">day: day month: month year: year </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[year &lt; 100⇒ [year &larr; 1900 + year]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(month &larr; self whichmonth: month)≡false⇒ [user notify: &rsquo;illegal month&rsquo;]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">day &lt; 1 or⦂ day &gt; (self daysinmonth: month)⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user notify: &rsquo;illegal day in month&rsquo;]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">day &larr; day + (self monthday: month)]</span></div>
<div class="line left">
<span class="bold small">day: day year: year </span><span class="small">| d<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[while⦂ day &gt; (d &larr; self daysinyear) do⦂ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">year &larr; year + 1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">day &larr; day - d].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ day ≤ 0 do⦂ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">year &larr; year - 1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">day &larr; day + self daysinyear].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">default </span><span class="small">["</span><span class="italic small">today</span><span class="small">" ⇑user now◦1]</span></div>
<div class="line left">
<span class="bold small">fromDays: d </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">d = days since Jan 1 1901. There are 1461 days in a 4-year cycle.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">2000 is a leap year, so no extra correction is necessary.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">day:year: will fix things up</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">d &larr; d asInteger intdiv: 1461.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self day: 1+ (d◦2) asSmall year: 1901+ ((d◦1) asSmall *4)]</span></div>
<div class="line left">
<span class="bold large"><br>Aspects</span></div>
<div class="line left">
<span class="bold small">asSeconds </span><span class="small">"Seconds since the beginning of time (local time)" [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑secsinday * (self - (Date new day: 1 year: 1901))]</span></div>
<div class="line left">
<span class="bold small">day </span><span class="small">[⇑day]</span></div>
<div class="line left">
<span class="bold small">dayinmonth </span><span class="small">[⇑day - (self monthday: self month)]</span></div>
<div class="line left">
<span class="bold small">dayinyear </span><span class="small">[⇑day]</span></div>
<div class="line left">
<span class="bold small">daysinmonth </span><span class="small">[⇑self daysinmonth: self month]</span></div>
<div class="line left">
<span class="bold small">daysinmonth: m </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑↪(31 28 31 30 31 30 31 31 30 31 30 31)◦m + [m=2⇒ [self leap] 0]]</span></div>
<div class="line left">
<span class="bold small">daysinyear </span><span class="small">[⇑365 + self leap]</span></div>
<div class="line left">
<span class="bold small">daysleft </span><span class="small">[⇑self daysinyear - day]</span></div>
<div class="line left">
<span class="bold small">day&larr; day</span></div>
<div class="line left">
<span class="bold small">hash </span><span class="small">[⇑(year lshift: 3) lxor: day]</span></div>
<div class="line left">
<span class="bold small">leap </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">year \ 4 = 0⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">year \ 100 = 0⇒ [year \ 400 = 0⇒ [⇑1] ⇑0]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑1]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑0]</span></div>
<div class="line left">
<span class="bold small">month </span><span class="small">| m leap [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">leap &larr; self leap.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ m from: 12 to: 1 by: ¬1 do⦂ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(↪(0 31 59 90 120 151 181 212 243 273 304 334)◦m +<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[m &gt; 2⇒ [leap] 0] "self monthday: m") &lt; day⇒ [⇑m]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user notify: &rsquo;illegal month&rsquo;]</span></div>
<div class="line left">
<span class="bold small">monthday: m </span><span class="italic small">"Return first day-in-year of m&rsquo;th month"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑↪(0 31 59 90 120 151 181 212 243 273 304 334)◦m +<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[m &gt; 2⇒ [self leap] 0]]</span></div>
<div class="line left">
<span class="bold small">monthname </span><span class="small">[⇑monthnames◦self month]</span></div>
<div class="line left">
<span class="bold small">weekday </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑↪(Tuesday Wednesday Thursday Friday Saturday Sunday Monday)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">◦self weekdayIndex]</span></div>
<div class="line left">
<span class="bold small">weekdayIndex | a d </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[day ≤ (self monthday: 3)⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">a &larr; year-1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">d &larr; 306]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">a &larr; year.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">d &larr; ¬59 - self leap].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"Tuesday=1,..., Monday=7"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑d + day + a + (a/4) + (a/400) - (a/100) \ 7 + 1]</span></div>
<div class="line left">
<span class="bold small">whichmonth: m </span><span class="small">| a </span><span class="italic small">"M may be a (partial) month name, or a number.  Return the month number, or false"</span><span class="small"> [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">m Is: String⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">m &larr; m + &rsquo;*&rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ a to: 12 do⦂ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"first partial match"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">m match: monthnames◦a⇒ [⇑a]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑false]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> ⇑m ≥ 1 and⦂ m ≤ 12]</span></div>
<div class="line left">
<span class="bold small">year </span><span class="small">[⇑year]</span></div>
<div class="line left">
<span class="bold small">year&larr; year</span></div>
<div class="line left">
<span class="bold large"><br>Arithmetic</span></div>
<div class="line left">
<span class="bold small">+ days </span><span class="small">| t [</span><span class="bold small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">days &larr; day + days.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">t &larr; Date new.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">days &gt; 0 and⦂ days &lt; 366⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">same year</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">t day &larr; days; year &larr; year.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑t]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑t day: days year: year]</span></div>
<div class="line left">
<span class="bold small">- date<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[date is: Date⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">year = date year⇒ [⇑day - date day]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑(year-1 / 4) - (date year / 4) +<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">day + date daysleft + (year-1 - date year * 365)]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑self + (0 - date)]</span></div>
<div class="line left">
<span class="bold small">&lt; date </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">year = date year⇒ [⇑day &lt; date day]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑year &lt; date year]</span></div>
<div class="line left">
<span class="bold small">= date </span><span class="small">[⇑day = date day and⦂ year = date year]</span></div>
<div class="line left">
<span class="bold small">&gt; date </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">year = date year⇒ [⇑day &gt; date day]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑year &gt; date year]</span></div>
<div class="line left">
<span class="bold small">previous: di </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"e.g. previous: 6 (Sunday) returns Date which is previous closest Sunday.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">note: di=self weekdayIndex returns self+0"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑self + (0 - (7 + self weekdayIndex - di \ 7))]</span></div>
<div class="line left">
<span class="bold large"><br>Printing and reading</span></div>
<div class="line left">
<span class="bold small">from: s </span><span class="small">[self readfrom: s asVector "asSet" viewer format: nil]</span></div>
<div class="line left">
<span class="bold small">printon: strm </span><span class="small">[self printon: strm format: ↪(1 2 3 040 3 1)]</span></div>
<div class="line left">
<span class="bold small">printon: strm format: f </span><span class="small">| i m [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">f is print format.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">1-3</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">positions to print day,month,year respectively<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">4</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">character separator<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">5</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">month format (1 month #, 2 first 3 chars, 3 entire name)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">6</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">year format (1 year #, 2 year #\100)</span><span class="small">"<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">m &larr; self month.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: 3 do⦂ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[f◦i<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=1⇒ [day - (self monthday: m) printon: strm];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=2⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">f◦5<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=1⇒ [m printon: strm];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=2⇒ [strm append: monthnames◦m◦(1 to: 3)]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">strm append: monthnames◦m]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">([f◦6=1⇒ [year] year\100]) printon: strm].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">i&lt;3⇒ [strm next &larr; f◦4 "</span><span class="italic small">separator</span><span class="small">"]]]</span></div>
<div class="line left">
<span class="bold small">readfrom: strm<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self readfrom: strm format: ↪(1 2 3)]</span></div>
<div class="line left">
<span class="bold small">readfrom: strm format: order </span><span class="small">| dmy i [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">strm ∢ ↪today⇒ [⇑self default]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[order ≡ nil⇒ [order &larr; ↪(1 2 3)]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">dmy &larr; Vector new: 3.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: 3 "dmy length" do⦂ [dmy◦(order◦i) &larr; strm next].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self day: dmy◦1 month: dmy◦2 year: dmy◦3]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪Date under: &rsquo;Numbers&rsquo;.</span></div>
<div class="line left">
<span class="small">Date classInit</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"Float"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;Float&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: Number<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;halfpi sqrt2 twopi fourthpi degreesPerRadian pi radiansPerDegree ln2 &rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">bytesize: 16;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">veryspecial: 3;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>These floating-point numbers are good for about 8 or 9 digits of accuracy, and the range is between plus and minus 10&uarr;4000.  Here are some valid floating-point examples:<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">8.0   13.3   0.3   2.5e6   1.27e¬300   ¬12.987654e2412<br>Mainly: use shift-minus, no imbedded blanks, little e for tens power, and a digit on both sides of the decimal point.</span></div>
<div class="line left">
<span class="bold large"><br>Arithmetic</span></div>
<div class="line left">
<span class="bold small">≤ arg<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑self≤arg asFloat] primitive: 73</span></div>
<div class="line left">
<span class="bold small">≠ arg<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑self≠arg asFloat] primitive: 76</span></div>
<div class="line left">
<span class="bold small">≥ arg<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑self≥arg asFloat] primitive: 75</span></div>
<div class="line left">
<span class="bold small">* arg<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑self*arg asFloat] primitive: 69</span></div>
<div class="line left">
<span class="bold small">+ arg<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑self+arg asFloat] primitive: 67</span></div>
<div class="line left">
<span class="bold small">- arg<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑self-arg asFloat] primitive: 68</span></div>
<div class="line left">
<span class="bold small">/ arg<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[0.0=arg⇒[user notify: &rsquo;Attempt to divide by 0.0&rsquo;]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑self/arg asFloat] primitive: 70</span></div>
<div class="line left">
<span class="bold small">&lt; arg<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑self&lt;arg asFloat] primitive: 71</span></div>
<div class="line left">
<span class="bold small">= arg<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[arg isNumber⇒ [⇑self = arg asFloat] ⇑false] primitive: 72</span></div>
<div class="line left">
<span class="bold small">&gt; arg<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑self&gt;arg asFloat] primitive: 74</span></div>
<div class="line left">
<span class="bold small">hash </span><span class="small">[⇑(self fpart * 100) asInteger lxor: self ipart asInteger]</span></div>
<div class="line left">
<span class="bold small">near: n </span><span class="small">[⇑self near: n within: 1.0e¬4]</span></div>
<div class="line left">
<span class="bold small">near: n within: eps </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"for testing near equality, e.g. error convergence"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑(self - n) abs ≤ eps]</span></div>
<div class="line left">
<span class="bold small">negated </span><span class="small">[⇑0.0-self]</span></div>
<div class="line left">
<span class="bold small">sameAs: arg  </span><span class="italic small">"arg assumed to be of same class as self"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑self=arg]</span></div>
<div class="line left">
<span class="bold small">\ arg</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"By analogy with integers"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self&lt;0.0⇒[⇑(self/arg) ipart+1.0*arg+self]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑self-((self/arg) ipart*arg)]</span></div>
<div class="line left">
<span class="small">| arg</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"By analogy with integers"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑(self/arg) ipart*arg]</span></div>
<div class="line left">
<span class="bold large"><br>Conversion</span></div>
<div class="line left">
<span class="bold small">asDegrees</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"self assumed to be in radians"</span><span class="bold small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑self / radiansPerDegree]</span></div>
<div class="line left">
<span class="bold small">asDirection </span><span class="small">[⇑self cos ⌾ self sin]</span></div>
<div class="line left">
<span class="bold small">asFloat</span></div>
<div class="line left">
<span class="bold small">asInteger</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"Return an Integer = self ipart"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑self asLarge] primitive: 78</span></div>
<div class="line left">
<span class="bold small">asLarge </span><span class="small">| me digits nat i "convert to LargeInteger"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self&lt;0⇒[⇑(0.0-self) asLarge negated]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> digits &larr; Stream default.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> [self=0.0⇒[digits next&larr; 0]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">  me &larr; self ipart.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">  while⦂ me≥1 do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[digits next &larr; (me\256.0) asInteger.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> </span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> me &larr; me/256.0]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> digits &larr; digits contents.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> nat &larr; Natural new: digits length.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> for⦂ i to: digits length do⦂ [nat◦i &larr; digits◦i].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> ⇑LargeInteger new bytes: nat neg: false]<br></span></div>
<div class="line left">
<span class="bold small">asRadians</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"self assumed to be in degrees"</span><span class="bold small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑self * radiansPerDegree]</span></div>
<div class="line left">
<span class="bold small">copy </span><span class="small">[⇑self]</span></div>
<div class="line left">
<span class="bold small">fpart </span><span class="small">[user croak] primitive: 77</span></div>
<div class="line left">
<span class="bold small">ipart</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"Returns a Float with zero fractional part"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑self-self fpart]</span></div>
<div class="line left">
<span class="bold small">recopy </span><span class="small">[⇑self]</span></div>
<div class="line left">
<span class="bold small">round<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑(self + [self &lt; 0⇒ [¬0.5] 0.5]) asInteger]</span></div>
<div class="line left">
<span class="bold large"><br>Math functions</span></div>
<div class="line left">
<span class="bold small">arctan </span><span class="small">| theta term y eps i  "return angle in degrees good to .02 degrees."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self = 1.0 ⇒ [⇑ 45.0].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> self = ¬1.0 ⇒ [⇑ ¬45.0].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> [self*self &gt;1.0 ⇒[theta &larr; halfpi. y &larr; ¬1.0/(self*self).  term &larr; ¬1.0/(self abs).]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">theta &larr; 0.0. y &larr; 0.0 - (self*self).  term &larr; self abs].<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">i &larr; 1.  eps &larr; 0.0001. <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ term abs &gt; eps do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[theta &larr; theta + term.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> term &larr; term*y*(i asFloat)/((i+2) asFloat).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> i &larr; i+2].<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">theta &larr; (self sign asFloat)*theta* 360.0 / twopi.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ theta] </span></div>
<div class="line left">
<span class="bold small">cos  </span><span class="italic small">"for angles in radians"</span><span class="bold small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self&lt;0.0⇒[⇑(self+halfpi) sin]</span><span class="italic small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑(halfpi-self) sin]</span></div>
<div class="line left">
<span class="bold small">exp </span><span class="small">| a n1 x x2 P Q [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"see Computer Approximations, pp. 96-104, p. 205 (EXPB 1065)"<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self abs &gt; 9212.0 "1.0e4001 ln"⇒ [user notify: &rsquo;exp overflow&rsquo;]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">x &larr; self / ln2.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(n1 &larr; Float new "2.0 ipow: x asInteger")<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">instfield: 1 &larr; x asInteger * 2.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[(x &larr; x fpart) ≥ 0.5⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">n1 &larr; n1 * sqrt2.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">x &larr; x - 0.5]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">x2 &larr; x*x.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"compute 2.0 power: x"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">P &larr; Q &larr; 0.0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"↪(0.25250428525576241933744e4 0.28875563776168927289e2) reverse copy"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ a from: ↪(28.875564 2525.0429) do⦂ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">P &larr; (P*x2) + a].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"↪(0.72857336028361108885189e4 0.375021654220866600213e3 0.1e1) reverse copy"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ a from: ↪(1.0 375.02165 7285.7336) do⦂ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">Q &larr; (Q*x2) + a].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑n1 * ((Q + (x*P))/(Q - (x*P)))]</span></div>
<div class="line left">
<span class="bold small">ipow: x</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"fixed powers in log n steps"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[x=0⇒ [⇑1.0]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">x=1⇒ [⇑self]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">x&gt;1⇒ [⇑((self*self) ipow: x/2)*(self ipow: x\2)]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑1.0/(self ipow: 0-x)]</span></div>
<div class="line left">
<span class="bold small">ln </span><span class="small">| a x x2 n P [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"see Computer Approximations, pp. 105-111, p. 227 (LOGE 2663)"<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self ≤ 0.0⇒ [user notify: &rsquo;ln not valid for &rsquo; + self asString]<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">x &larr; self + 0.0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"exponent"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">n &larr; ln2 * (((x instfield: 1) / 2) asFloat - 0.5).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"mantissa between 0.5 and 1.0".<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">x instfield: 1 &larr; 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">x &larr; x * sqrt2.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">x &larr; (x - 1.0) / (x + 1.0).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">x2 &larr; x*x.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">P &larr; 0.0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"↪(0.2000000000046727e1 0.666666635059382 0.4000059794795<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">0.28525381498 0.2376245609) reverse copy"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ a from: ↪(0.23762456 0.28525381 0.40000598 0.66666664 2.0) do⦂ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">P &larr; (P*x2) + a].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑n + (x * P)]</span></div>
<div class="line left">
<span class="bold small">log: base </span><span class="small">[⇑self ln / base asFloat ln]</span></div>
<div class="line left">
<span class="bold small">neg</span><span class="small bold italic"> </span><span class="italic small">"Obsolete - use </span><span class="bold small">negated,</span><span class="italic small"> which is uniform for all Numbers"</span><span class="bold small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑self negated]</span></div>
<div class="line left">
<span class="bold small">sin </span><span class="small">| x x2 sum const  </span><span class="italic small">"for angles in radians"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self&lt;0.0⇒[⇑self negated sin negated];</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">" normalize to 0≤self≤(pi/4) "</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">&gt;twopi⇒[⇑(self\twopi) sin];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">&gt;pi⇒[⇑(self-pi) sin negated];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">&gt;halfpi⇒[⇑(pi-self) sin]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">sum &larr; x &larr; self.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">x2 &larr; x*x.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ const from:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"Now compute the series"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">↪(¬0.1666666664 0.0083333315 ¬1.98409e¬4 2.7526e¬6 ¬2.39e¬8)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">do⦂ [sum &larr; const*(x &larr; x*x2)+sum]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑sum]</span></div>
<div class="line left">
<span class="bold small">sqrt </span><span class="small">| guess i<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self≤0.0⇒[self=0.0⇒[⇑0.0] user notify: &rsquo;sqrt invalid for x&lt;0.&rsquo;]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">guess &larr; self+0.0.</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"copy x"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">guess instfield: 1 &larr; (guess instfield: 1)/4*2.</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"and halve expt for first guess"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: 5 do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[guess &larr; (self-(guess*guess)) / (guess*2.0) + guess]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑guess]</span></div>
<div class="line left">
<span class="bold small">tan </span><span class="small">| x x2 sum const  </span><span class="italic small">"for angles in radians"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self&lt;0.0⇒[⇑self negated tan negated];</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">" normalize to 0≤self≤(pi/4) "</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">&gt;pi⇒[⇑(self\pi) tan];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">&gt;halfpi⇒[⇑(self-halfpi) tan negated];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">&gt;fourthpi⇒[⇑1.0/(halfpi-self) tan]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">sum &larr; x &larr; self.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">x2 &larr; x*x.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ const from:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"Now compute the series"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">↪(0.3333314036 0.1333923995 0.0533740603 0.0245650893 0.0029005250 0.0095168091)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">do⦂ [sum &larr; const*(x &larr; x*x2)+sum]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑sum]</span></div>
<div class="line left">
<span class="bold large"><br>Printing</span></div>
<div class="line left">
<span class="bold small">absprinton: strm digits: digits   </span><span class="italic small">"print me using digits significant figures"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">| fuzz x exp q i<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"x is myself normalized to [1.0, 10.0), exp is my exponent"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">exp &larr; [self&lt;1.0⇒ [0-(10.0/self epart: 10.0)] self epart: 10.0].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">x &larr; self/(10.0 ipow: exp).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"round the last digit to be printed"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">fuzz &larr; 10.0 ipow: 1-digits.  x &larr; 0.5*fuzz+x.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"check if rounding has unnormalized x"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[x≥10.0⇒[x&larr;x/10.0.  exp&larr;exp+1]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[exp&lt;6 and⦂ exp&gt;¬4⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[q &larr; 0.</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"decimal notation"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">exp&lt;0⇒ [strm append: &rsquo;0.0000&rsquo;◦(1 to: 1-exp)]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">q &larr; exp. exp &larr; 0].</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"scientific notation"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">use fuzz to track significance"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ x≥fuzz do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[i &larr; x asInteger.  strm next &larr; 060+i.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">x &larr; x-i * 10.0.  fuzz &larr; fuzz*10.0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">exp &larr; exp-1.  exp=¬1⇒ [strm append: &rsquo;.&rsquo;]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">append additional zeros if necessary</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ exp≥¬1 do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[strm next &larr; 060.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">exp &larr; exp-1.  exp=¬1⇒ [strm append: &rsquo;.&rsquo;]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">q≠0⇒[strm append: &rsquo;e&rsquo;; print: q]]</span></div>
<div class="line left">
<span class="bold small">epart: base </span><span class="small">| x</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"gives floor log.base self"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self&lt;base⇒ [⇑0]</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"self assumed positive"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self&lt;(base*base)⇒ [⇑1]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">x &larr; 2*(self epart: base*base).</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"binary recursion like ipow"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑x + ((self/(base ipow: x)) epart: base)]</span></div>
<div class="line left">
<span class="bold small">printon: strm<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self printon: strm digits: 8]</span></div>
<div class="line left">
<span class="bold small">printon: strm digits: digits   </span><span class="italic small">"print me using digits significant figures"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self&gt;0.0⇒[self absprinton: strm digits: digits]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self=0.0⇒[strm append: &rsquo;0.0&rsquo;]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">strm append: &rsquo;¬&rsquo;. (0.0-self) absprinton: strm digits: digits]</span></div>
<div class="line left">
<span class="bold small">roundTo: d<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑(self/d+[self&lt;0.0⇒[¬0.5] 0.5]) ipart*d]</span></div>
<div class="line left">
<span class="bold large"><br>Initialization</span></div>
<div class="line left">
<span class="bold small">classInit </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">constants from Computer Approximations, pp. 182-183</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pi = 3.14159265358979323846264338327950288<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pi/2 = 1.57079632679489661923132169163975144<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pi/4 = 0.78539816339744830961566084581987572<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pi*2 = 6.28318530717958647692528676655900576<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pi/180 = 0.01745329251994329576923690768488612<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">2.0 ln = 0.69314718055994530941723212145817657<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">2.0 sqrt = 1.41421356237309504880168872420969808"<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pi &larr; 3.141592654.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">halfpi &larr; pi/2.0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">fourthpi &larr; pi/4.0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">twopi &larr; pi*2.0.<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">radiansPerDegree &larr; pi/180.0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">degreesPerRadian &larr; 180.0/pi.<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">ln2 &larr;0.6931471806.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">sqrt2 &larr; 1.414213562]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪Float under: &rsquo;Numbers&rsquo;.</span></div>
<div class="line left">
<span class="small">Float classInit</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"Integer"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;Integer&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: Number<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;digitbuffer &rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">bytesize: 16;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">veryspecial: 1;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">sharing: BitMasks;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">sharing: ByteCodes;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>Integers are 16-bit numbers, stored in two-s complement form.  The allowable range is from ¬32768 to +32767.  You can type them in octal by typing a leading zero, as in 0377.</span></div>
<div class="line left">
<span class="bold large"><br>Arithmetic</span></div>
<div class="line left">
<span class="bold small">≤ arg </span><span class="small">| t</span><span class="bold small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[t &larr; arg asInteger.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> t isLarge⇒[⇑t neg ≡ false]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> ⇑self ≤ t]</span></div>
<div class="line left">
<span class="bold small">≠ arg </span><span class="small">| t</span><span class="bold small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[arg isNumber⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> [t &larr; arg asInteger.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">  t isLarge⇒[⇑true]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">  ⇑self ≠ t]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> ⇑true]</span></div>
<div class="line left">
<span class="bold small">≥ arg </span><span class="small">| t</span><span class="bold small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[t &larr; arg asInteger.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> t isLarge⇒[⇑t neg]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> ⇑self ≥ t]</span></div>
<div class="line left">
<span class="bold small">* arg </span><span class="small">| t</span><span class="bold small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[arg is: Integer⇒[⇑self asLarge*arg]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> t &larr; arg asInteger.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> t isLarge⇒[⇑self asLarge*arg]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> ⇑self*t] primitive: 21</span></div>
<div class="line left">
<span class="bold small">+ arg </span><span class="small">| t</span><span class="bold small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[arg is: Integer⇒[⇑self asLarge+arg]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> t &larr; arg asInteger.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> t isLarge⇒[⇑self asLarge+arg]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> ⇑self + t]</span></div>
<div class="line left">
<span class="bold small">- arg </span><span class="small">| t</span><span class="bold small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[arg is: Integer⇒[⇑self asLarge-arg]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> t &larr; arg asInteger.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> t isLarge⇒[⇑self asLarge-arg]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> ⇑self - t]</span></div>
<div class="line left">
<span class="bold small">/ arg<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[0=arg⇒[user notify: &rsquo;Attempt to divide by 0&rsquo;]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> arg isLarge⇒[⇑self asLarge/arg]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> ⇑self / arg asInteger] primitive: 22</span></div>
<div class="line left">
<span class="bold small">&lt; arg </span><span class="small">| t</span><span class="bold small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[t &larr; arg asInteger.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> t isLarge⇒[t neg ≡ false]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> ⇑self &lt; t]</span></div>
<div class="line left">
<span class="bold small">= arg </span><span class="small">| t</span><span class="bold small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[arg isNumber⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> [t &larr; arg asInteger.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">  t isLarge⇒[⇑false]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">  ⇑self = t]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> ⇑false]</span></div>
<div class="line left">
<span class="bold small">&gt; arg </span><span class="small">| t</span><span class="bold small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[t &larr; arg asInteger.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> t isLarge⇒[⇑t neg]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> ⇑self &gt; t]</span></div>
<div class="line left">
<span class="bold small">compare: arg </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">arg is: Integer⇒ [self &lt; arg⇒ [⇑1]; = arg⇒ [⇑2] ⇑3]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑self natcompare: arg bytes "4 - (arg bytes natcompare: self)"]</span></div>
<div class="line left">
<span class="bold small">even<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑(self land: 1) = 0]</span></div>
<div class="line left">
<span class="bold small">intdiv: arg<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[arg is: Integer ⇒[⇑(self/arg),(self\arg)]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> arg is: LargeInteger ⇒ [⇑self asLarge intdiv: arg]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user notify: &rsquo;I give up&rsquo;]</span></div>
<div class="line left">
<span class="bold small">negate<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑0-self]</span></div>
<div class="line left">
<span class="bold small">negated </span><span class="small">[⇑0-self]</span></div>
<div class="line left">
<span class="bold small">sameAs: arg  </span><span class="italic small">"arg assumed to be of same class as self"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑self=arg]</span></div>
<div class="line left">
<span class="bold small">unsignedadd: y<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["treat numbers as unsigned 8-bit quantities."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑((self + y) land: 0377)]</span></div>
<div class="line left">
<span class="bold small">unsignedlessthan: y<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["treat numbers as unsigned 8-bit quantities."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑self &lt; y]</span></div>
<div class="line left">
<span class="bold small">\ arg</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"mod"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[0=arg⇒[user notify: &rsquo;Attempt to divide by 0&rsquo;]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> arg isLarge⇒[⇑self asLarge\arg]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> ⇑self \ arg asInteger] primitive: 26</span></div>
<div class="line left">
<span class="small">| arg</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"truncate"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑self/arg*arg]</span></div>
<div class="line left">
<span class="bold large"><br>Bit Manipulation</span></div>
<div class="line left">
<span class="bold small">allmask: b </span><span class="small">[⇑b = (self land: b)]</span></div>
<div class="line left">
<span class="bold small">anymask: b </span><span class="small">[⇑0 ≠ (self land: b)]</span></div>
<div class="line left">
<span class="bold small">bits: int </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"int is an Interval:  0 is leftmost bit, 15 is rightmost"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑self field: (int length "width" * 16) +<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">15 - int stop "displacement from right"]</span></div>
<div class="line left">
<span class="bold small">field: fld </span><span class="small">| t</span><span class="bold small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[t &larr; fld asInteger.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> t isLarge⇒[user notify: &rsquo;Field descriptor too large&rsquo;]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> ⇑self field: t] primitive: 36</span></div>
<div class="line left">
<span class="bold small">field: fld &larr; val </span><span class="small">| t</span><span class="bold small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[t &larr; fld asInteger.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> t isLarge⇒[user notify: &rsquo;Field descriptor too large&rsquo;]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> ⇑self field: t &larr; val asSmall] primitive: 37</span></div>
<div class="line left">
<span class="bold small">hash </span><span class="italic small">"used to find large integers in dictionaries"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑self]</span></div>
<div class="line left">
<span class="bold small">hibit </span><span class="small">| i<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[for⦂ i to: 16 do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[(self land: (biton◦(17-i)))≠0⇒[⇑17-i]]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑0]</span></div>
<div class="line left">
<span class="bold small">land: arg<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑self land: arg asSmall] primitive: 23</span></div>
<div class="line left">
<span class="bold small">lor: arg<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑self lor: arg asSmall] primitive: 24</span></div>
<div class="line left">
<span class="bold small">lshift: arg<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑self lshift: arg asSmall] primitive: 25</span></div>
<div class="line left">
<span class="bold small">lxor: arg<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑self lxor: arg asSmall] primitive: 35</span></div>
<div class="line left">
<span class="bold small">nomask: b </span><span class="small">[⇑0 = (self land: b)]</span></div>
<div class="line left">
<span class="bold large"><br>Conversion</span></div>
<div class="line left">
<span class="bold small">asFloat </span><span class="small">[user croak] primitive: 34</span></div>
<div class="line left">
<span class="bold small">asInteger </span><span class="small">[⇑self]</span></div>
<div class="line left">
<span class="bold small">asLarge </span><span class="small">| me digits "convert to LargeInteger"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[me &larr; self bytes.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">digits &larr; Natural new: me length.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">digits◦1 &larr; me◦1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[digits length = 2 ⇒ [digits◦2 &larr; me◦2]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑LargeInteger new bytes: digits neg: self neg]</span></div>
<div class="line left">
<span class="bold small">asNatural </span><span class="small">| t<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[t &larr; Natural new: self length.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> t◦1&larr;self◦1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> [t length &gt; 1 ⇒ [t◦2&larr;self◦2]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> ⇑t]</span></div>
<div class="line left">
<span class="bold small">asObject </span><span class="small">[user croak] primitive: 81</span></div>
<div class="line left">
<span class="bold small">asSmall</span></div>
<div class="line left">
<span class="bold small">inString </span><span class="small">| t<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[t &larr; String new: 1. t◦1 &larr; self. ⇑t]</span></div>
<div class="line left">
<span class="bold small">oneToMeAsStream</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"used by for-loops"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑Stream new of: (Interval new from: 1 to: self by: 1)]</span></div>
<div class="line left">
<span class="bold small">unique<br></span><span class="small">[<br>⇑ self inString unique.<br>]<br></span></div>
<div class="line left">
<span class="bold small">unsigned </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self &lt; 0⇒ [⇑65536.0 + self asFloat]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑self asFloat]</span></div>
<div class="line left">
<span class="bold large"><br>Subscripts</span></div>
<div class="line left">
<span class="bold small">cansubscript: a<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑self≥1 and⦂ self≤a length]</span></div>
<div class="line left">
<span class="bold small">instfield:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold small"> i</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"small integer gives trouble"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[i = 1 ⇒[⇑self] user notify: &rsquo;arg too big&rsquo;]</span></div>
<div class="line left">
<span class="bold small">subscripts: a<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self cansubscript: a⇒[⇑a◦self]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user notify: &rsquo;Subscript out of bounds: &rsquo; + self asString]</span></div>
<div class="line left">
<span class="bold small">subscripts: a &larr; val </span><span class="small">| t</span><span class="bold small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self cansubscript: a⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[t &larr; val asInteger.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> (a is: String) and⦂ (t isnt: Integer)⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[user notify: &rsquo;Improper store (non-char into String?)&rsquo;]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> ⇑a◦self &larr; t]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user notify: &rsquo;Subscript out of bounds: &rsquo; + self asString]</span></div>
<div class="line left">
<span class="bold large"><br>Printing</span></div>
<div class="line left">
<span class="bold small">absprinton: strm </span><span class="small">| rem<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[rem &larr; self\10.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self&gt;9⇒ [self/10 absprinton: strm]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">strm next &larr; rem+060]</span></div>
<div class="line left">
<span class="bold small">printon: strm<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self&lt;0⇒[self=¬32768⇒[strm append: &rsquo;¬32768&rsquo;]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">strm append:&rsquo;¬&rsquo;. (0-self) printon: strm base: 10]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self printon: strm base: 10]</span></div>
<div class="line left">
<span class="bold small">printon: strm base: b </span><span class="small">| rem i x<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[[0&gt;(x&larr;self)⇒[i &larr; 1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">digitbuffer◦1 &larr; 040000\b*2+self-0100000\b. </span><span class="italic small">"get it?"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">x &larr; (040000/b*2+(self-0100000/b))]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">i &larr; 0].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ x≥b do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[digitbuffer◦(i&larr;i+1) &larr; x\b.  x &larr; x/b].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">strm next &larr; 060+x.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ i≠0 do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[strm next &larr; 060+(digitbuffer◦i).  i &larr; i-1].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold large"><br>Characters</span></div>
<div class="line left">
<span class="bold small">asLowercase<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[0101 ≤ self⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self ≤ 0132⇒ [⇑self + 040]]]</span></div>
<div class="line left">
<span class="bold small">asUppercase<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[0141 ≤ self⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self ≤ 0172⇒ [⇑self - 040]]]</span></div>
<div class="line left">
<span class="bold small">compareChar: c </span><span class="small">| a<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"⇑self asLowercase compare: c asLowercase"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">a&larr; self.    </span><span class="italic small">"written in-line for speed"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[0101≤a⇒[a≤0132⇒[a&larr;a+040]]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[0101≤c⇒[c≤0132⇒[c&larr;c+040]]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">a&lt;c⇒[⇑1] a=c⇒[⇑2] ⇑3]</span></div>
<div class="line left">
<span class="bold small">isalphanumeric<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self isletter⇒[⇑true]</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"lower-case"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑self isdigit]</span></div>
<div class="line left">
<span class="bold small">isdigit <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self ≥ 060⇒</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">" 0 "</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑self ≤ 071]</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">" 9 "</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑false]</span></div>
<div class="line left">
<span class="bold small">isletter<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self ≥ 0141⇒</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">" a "</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑self ≤ 0172]</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">" z "</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self ≥ 0101⇒</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">" A "</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑self ≤ 0132]</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">" Z "</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑false]</span></div>
<div class="line left">
<span class="bold small">tokenish</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"test for token-chars"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self isletter⇒[⇑true]</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"lower-case"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> self isdigit⇒[⇑true]</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"digits"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> ⇑&rsquo;¬.:⦂&rsquo; has: self]</span></div>
<div class="line left">
<span class="bold large"><br>Copying and Purging</span></div>
<div class="line left">
<span class="bold small">copy </span><span class="small">[⇑self]</span></div>
<div class="line left">
<span class="bold small">purge </span><span class="small">[user croak] primitive: 44</span></div>
<div class="line left">
<span class="bold small">recopy </span><span class="small">[⇑self]</span></div>
<div class="line left">
<span class="bold large"><br>Initialization</span></div>
<div class="line left">
<span class="bold small">classInit </span><span class="italic small">"Initialize the digit buffer"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[digitbuffer &larr; String new: 16]</span></div>
<div class="line left">
<span class="bold large"><br>Compiler Bytecodes</span></div>
<div class="line left">
<span class="bold small">asCompilerCode  </span><span class="small">"</span><span class="italic small">I am a byte code.  Return the corresponding compiler code</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self&lt;16⇒[⇑self+codeLoadField  "</span><span class="italic small">inst field</span><span class="small">"];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">&lt;32⇒[⇑self-16+codeLoadTemp  "</span><span class="italic small">temp</span><span class="small">"];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">&lt;64⇒[⇑self-32+codeLoadLit  "</span><span class="italic small">literal</span><span class="small">"];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">&lt;111⇒[⇑self-64+codeLoadLitInd  "</span><span class="italic small">indirect literal</span><span class="small">"];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">&lt;208⇒[⇑self  "</span><span class="italic small">context relative or constant ... not all values here are legal</span><span class="small">"];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">&lt;256⇒[⇑self-208+codeSendLit  "</span><span class="italic small">selector</span><span class="small">"]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user notify: &rsquo;unexpected byte&rsquo;]</span></div>
<div class="line left">
<span class="bold small">asRemoteCode: generator<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self&lt;256⇒ [⇑super asRemoteCode: generator]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(self land: 0177400)≤codeLoadTemp⇒ [⇑ParsedFieldReference new var: self];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=codeLoadLitInd⇒ [⇑ParsedObjectReference new var: self]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑super asRemoteCode: generator]</span></div>
<div class="line left">
<span class="bold small">bfpSize<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑[self&lt;0⇒ [2]; &gt;8⇒ [2] 1]]</span></div>
<div class="line left">
<span class="bold small">emitBfp: code on: stack<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[stack pop: 1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">0=self⇒ [code next &larr; toPop]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">1≤self and⦂ self≤8⇒ [code next &larr; self+toShortBfp-1] </span><span class="italic small">"short bfp"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">code emitLong: toLongBfp by: self]</span></div>
<div class="line left">
<span class="bold small">emitBytes: code  </span><span class="small">| c t</span><span class="bold small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self&lt;256⇒ [code next &larr; self]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">c &larr; self lshift: ¬8. t &larr; self land: 0377.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">↪(16 16 32 48 48)◦c &gt; t⇒ [code next &larr; ↪(0 16 32 64 208)◦c+t]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">code next &larr; toLoadFieldLong+c-1; next &larr; t]</span></div>
<div class="line left">
<span class="bold small">emitForValue: code on: stack<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[[self=toSuper⇒ [code next &larr; toLoadSelf] self emitBytes: code].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">stack push: 1]</span></div>
<div class="line left">
<span class="bold small">emitJmp: code on: stack<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[0=self⇒ []<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">1≤self and⦂ self≤8⇒ [code next &larr; self+toShortJmp-1] </span><span class="italic small">"short jmp"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">code emitLong: toLongJmp by: self]</span></div>
<div class="line left">
<span class="bold small">emitsLoad<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self&lt;256⇒ [⇑self&lt;toSmashPop] ⇑self&lt;codeSendLit]</span></div>
<div class="line left">
<span class="bold small">emittedVariable<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[[self&lt;256⇒[self≤toSuper] self&lt;codeSendLit]⇒[] ⇑false]</span></div>
<div class="line left">
<span class="bold small">findMacros: macros compilerTemps: compilerTemps </span><span class="small">| i j assignment<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self&lt;codeLoadTemp or⦂ self&gt;(codeLoadTemp+255)⇒[]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">this temp is not compiler-generated</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">j &larr; self-codeLoadTemp+1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">compilerTemps◦j≡false⇒[]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">compilerTemps◦j≡nil⇒[compilerTemps◦j &larr; false]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">The temp isn&rsquo;t compiler-generated after all!!  Nil out the macro</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i from: macros position to: 2 by: ¬2 do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[assignment &larr; macros◦(i-1) ◦ (macros◦i).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">assignment var=self⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[macros◦i &larr; nil.  macros◦(i-1) &larr; nil.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">compilerTemps◦j &larr; false.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑nil]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user notify: &rsquo;couldnt find bad macro&rsquo;]</span></div>
<div class="line left">
<span class="bold small">firstPush</span></div>
<div class="line left">
<span class="bold small">isField<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑self≥codeLoadField and⦂ self&lt;codeLoadTemp]</span></div>
<div class="line left">
<span class="bold small">jmpSize<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑[self=0⇒ [0]; &lt;0⇒ [2]; &gt;8⇒ [2] 1]]</span></div>
<div class="line left">
<span class="bold small">printon: strm indent: level precedence: p forValue: v decompiler: decompiler<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[v≡false⇒[]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self&lt;112⇒[user notify: &rsquo;unknown code&rsquo;];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">&lt;128⇒[strm append: ↪(&rsquo;sender&rsquo; &rsquo;self&rsquo; &rsquo;?&rsquo; &rsquo;?&rsquo; &rsquo;?&rsquo; &rsquo;?&rsquo; &rsquo;?&rsquo; &rsquo;?&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">&rsquo;¬1&rsquo; &rsquo;0&rsquo; &rsquo;1&rsquo; &rsquo;2&rsquo; &rsquo;10&rsquo; &rsquo;nil&rsquo; &rsquo;false&rsquo; &rsquo;true&rsquo;)◦(self-111)];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=133⇒[strm append: &rsquo;thisContext&rsquo;];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=134⇒[strm append: &rsquo;super&rsquo;];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">&lt;167⇒[user notify: &rsquo;unknown code&rsquo;];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">&lt;208⇒[strm append: SpecialOops◦(self-166)];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">&lt;256⇒[user notify: &rsquo;unknown code&rsquo;];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">&lt;512⇒[strm append: (decompiler instvar: self)];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">&lt;768⇒[strm append: (decompiler temp: self)];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">&lt;1024⇒[strm append: (decompiler literal: self)];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">&lt;1280⇒[strm append: (decompiler literalIndirect: self)]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">strm append: (decompiler selector: self)]</span></div>
<div class="line left">
<span class="bold small">sizeForValue<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self&lt;256 or⦂</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">↪(16 16 32 48 48)◦(self lshift: ¬8) &gt; (self land: 0177)⇒ [⇑1]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑2]</span></div>
<div class="line left">
<span class="bold large"><br>LargeInteger Compatability</span></div>
<div class="line left">
<span class="bold small">◦ n | t<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["behave like a Natural"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">n = 1 ⇒ [self &lt; 0 ⇒ [⇑((((self land: 0377) lxor: 0377) + 1) land: 0377)]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑self land: 0377]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">n = 2 ⇒ [self &lt; 0 ⇒ [t &larr; ((self lshift: ¬8) lxor: 0377).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(self land: 0377) = 0 ⇒[⇑((t+1) land: 0377)]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑t]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ self lshift: ¬8]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑0]</span></div>
<div class="line left">
<span class="bold small">bytes<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["behave like a LargeInteger - negative integers behave like positive naturals"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑self]</span></div>
<div class="line left">
<span class="bold small">isInt<br></span></div>
<div class="line left">
<span class="bold small">last<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑self◦self length]</span></div>
<div class="line left">
<span class="bold small">length<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["behave like a Natural"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(self ≥ 256) or⦂ (self ≤ ¬256) ⇒ [⇑2]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑1]</span></div>
<div class="line left">
<span class="bold small">natcompare: arg </span><span class="small">| i len [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">len &larr; self length.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">arg length &lt; len⇒[⇑3]; &gt; len⇒[⇑1]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i from: len to: 1 by: ¬1 do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[(self◦i)&gt;(arg◦i)⇒[⇑3];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">&lt;(arg◦i)⇒[⇑1]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑2]</span></div>
<div class="line left">
<span class="bold small">natnormalize: n </span><span class="small">| x i r f digit<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["n is the number of bits to shift by. The Natural number returned will be written over repeatedly, so we must make a new one."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">r &larr; (Natural new: (self length+1)).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">x &larr; 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">f &larr; n-8.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: r length do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[digit &larr; self ◦i.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">r◦i &larr; (digit lshift: n) lor: x.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">x &larr; digit lshift: f.].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑r]</span></div>
<div class="line left">
<span class="bold small">neg<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["behave like a LargeInteger"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(self &lt; 0)⇒[⇑true]⇑false]</span></div>
<div class="line left">
<span class="bold large"><br>As yet unclassified</span></div>
<div class="line left">
<span class="bold small">asInt32 </span><span class="small">[⇑ Int32 new high: 0 low: self]</span></div>
<div class="line left">
<span class="bold small">between: min and: max<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑self≥min and⦂ self≤max]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪Integer under: &rsquo;Numbers&rsquo;.</span></div>
<div class="line left">
<span class="small">Integer classInit</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"LargeInteger"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;LargeInteger&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: Number<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;bytes</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">"A Natural number (digits are 0 to 255)"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large"> neg</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">"The sign" &rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;&rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>LargeInteger is a class of Numbers with integral values of arbitrary precision. The values are stored as a Natural number that has digits between 0 and 255. The real work is done in Natural, which uses MachineDouble for single digit calculations. The first element of bytes contains the lowest precision digit.<br>All of the Bit Manipulation messages behave like the integer is represented in twos complement and then truncates the number to 16 bits before operating upon it. The value is always a Small integer.</span></div>
<div class="line left">
<span class="bold large"><br>Access</span></div>
<div class="line left">
<span class="bold small">bit: index </span><span class="small">| byte<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"Return bit number i in the binary representation of this number. Bit number 1 is the low order bit"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[byte &larr; bytes◦(1+((index-1)/8)).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> ⇑(byte lshift: (0-((index-1)\8))) land: 1]</span></div>
<div class="line left">
<span class="bold small">bytes<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑bytes]</span></div>
<div class="line left">
<span class="bold small">bytes: bytes neg: neg<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[while⦂ bytes isLarge do⦂ [bytes&larr;bytes bytes]]</span></div>
<div class="line left">
<span class="bold small">hibit<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"Return the index of the high order bit of the binary representation of this number"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑bytes last hibit+(8*(bytes length-1))]</span></div>
<div class="line left">
<span class="bold small">neg<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑neg]</span></div>
<div class="line left">
<span class="bold small">neg &larr; neg </span><span class="small">|  "Smashes sign - be careful!"</span></div>
<div class="line left">
<span class="bold large"><br>Arithmetic</span></div>
<div class="line left">
<span class="bold small">≤ arg </span><span class="small">[(self compare: arg)&lt;3⇒[⇑self] ⇑false]</span></div>
<div class="line left">
<span class="bold small">≥ arg </span><span class="small">[(self compare: arg)&gt;1⇒[⇑self] ⇑false]</span></div>
<div class="line left">
<span class="bold small">* arg </span><span class="small">| as r<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["take care of sign. Arithmetic is done in Natural numbers. <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">if arg is Small, it behaves as a LargeInteger."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">as &larr; arg neg.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">r &larr; bytes nattimes: arg bytes.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑LargeInteger new bytes: r neg: ((neg≡as)≡false)]</span></div>
<div class="line left">
<span class="bold small">+ arg </span><span class="small">| as r<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["take care of sign. Arithmetic is done in Natural numbers. <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">if arg is Small, it behaves as a LargeInteger."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">as &larr; arg neg.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">neg ≡ as ⇒[r&larr;bytes natadd: arg bytes. ⇑LargeInteger new bytes: r neg: neg]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">r &larr; bytes natsubtract: arg bytes.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">neg ⇒ [⇑ r negate].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑r]</span></div>
<div class="line left">
<span class="bold small">- arg </span><span class="small">| as r<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["take care of sign. Arithmetic is done in Natural numbers. <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">if arg is Small, it behaves as a LargeInteger."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">as &larr; arg neg.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">neg ≡ as ⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[r &larr; bytes natsubtract: arg bytes.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">neg ⇒ [⇑ r neg&larr; (r neg ≡ false)].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑r]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">r&larr;bytes natadd: arg bytes.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑LargeInteger new bytes: r neg: neg]</span></div>
<div class="line left">
<span class="bold small">/ arg<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑(self intdiv: arg)◦1]</span></div>
<div class="line left">
<span class="bold small">&lt; arg </span><span class="small">[(self compare: arg)=1⇒[⇑self] ⇑false]</span></div>
<div class="line left">
<span class="bold small">= arg<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[arg isNumber⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[(self compare: arg)=2⇒[⇑self] ⇑false]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> ⇑false]</span></div>
<div class="line left">
<span class="bold small">&gt; arg </span><span class="small">[(self compare: arg)=3⇒[⇑self] ⇑false]</span></div>
<div class="line left">
<span class="bold small">abs </span><span class="small">"Return the positive magnitude (absolute value) of this LargeInteger"</span><span class="bold small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑LargeInteger new bytes: bytes neg: false]</span></div>
<div class="line left">
<span class="bold small">compare: arg </span><span class="small">| i a<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[[(((bytes length = 1) and⦂ (bytes◦1=0)) and⦂ (arg bytes length =1)) and⦂ (arg bytes◦1=0)⇒[⇑2]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">neg⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[arg neg⇒[⇑arg bytes natcompare: bytes] ⇑1]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">arg neg⇒[⇑3]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑bytes natcompare: arg bytes]</span></div>
<div class="line left">
<span class="bold small">even </span><span class="small">| <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑(((bytes ◦ 1) land: 1) = 0)]</span></div>
<div class="line left">
<span class="bold small">intdiv: arg </span><span class="small">| quo rem ng qr z<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["returns a vector of (quotient, remainder)"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">qr &larr; bytes natdiv: arg bytes.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">quo &larr; qr◦1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">rem &larr; (qr◦2) asInteger.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">ng &larr; (neg≡arg neg)≡false.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[quo last = 0 ⇒ [quo length&lt;2⇒[]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">quo &larr; quo growby: ¬1]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">qr◦1&larr;(LargeInteger new bytes: quo neg: ng).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">qr◦2 &larr; [ng and⦂ 0≠rem⇒ [arg abs-rem] rem].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑qr]</span></div>
<div class="line left">
<span class="bold small">negate<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑LargeInteger new bytes: bytes neg: (neg≡false)]</span></div>
<div class="line left">
<span class="bold small">negated<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑LargeInteger new bytes: bytes neg: neg≡false]</span></div>
<div class="line left">
<span class="bold small">\ arg<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑(self intdiv: arg)◦2]</span></div>
<div class="line left">
<span class="bold large"><br>Conversion</span></div>
<div class="line left">
<span class="bold small">asFloat</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"Built for comfort, not for speed"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑self asString asFloat]</span></div>
<div class="line left">
<span class="bold small">asInteger<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[bytes length&gt;2⇒[⇑self]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> self≤077777 and: self≥0100000⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑self asSmall]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> ⇑self]</span></div>
<div class="line left">
<span class="bold small">asLarge</span></div>
<div class="line left">
<span class="bold small">asSmall </span><span class="small">| t<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[t &larr; (bytes◦1).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> [bytes length &gt; 1 ⇒ [t &larr; (t field: 0210 &larr; (bytes◦2))]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> neg ⇒[t = ¬32768⇒[⇑¬32768] ⇑0-t]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> ⇑t]</span></div>
<div class="line left">
<span class="bold small">isLarge</span></div>
<div class="line left">
<span class="bold large"><br>Printing</span></div>
<div class="line left">
<span class="bold small">printon: strm base: b<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[[neg ⇒ [strm append: &rsquo;¬&rsquo;]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bytes printon: strm base: b]</span></div>
<div class="line left">
<span class="bold large"><br>Bit Manipulation</span></div>
<div class="line left">
<span class="bold small">allmask: b </span><span class="small">[⇑b = (self land: b)]</span></div>
<div class="line left">
<span class="bold small">anymask: b </span><span class="small">[⇑0 ≠ (self land: b)]</span></div>
<div class="line left">
<span class="bold small">field: n<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑self asSmall field: n]</span></div>
<div class="line left">
<span class="bold small">field: n &larr; val<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑self asSmall field: n &larr; val]</span></div>
<div class="line left">
<span class="bold small">hash </span><span class="small">[⇑bytes hash]</span></div>
<div class="line left">
<span class="bold small">land: n<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑self asSmall land: n]</span></div>
<div class="line left">
<span class="bold small">lshift: n<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑self asSmall lshift: n]</span></div>
<div class="line left">
<span class="bold small">nomask: b </span><span class="small">[⇑0 = (self land: b)]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪LargeInteger under: &rsquo;Numbers&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"MachineDouble"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;MachineDouble&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: Number<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;high low&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;low4 low8 high4 high8 &rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>MachineDouble is intended to be used by people who are implementing multiple precision arithmetic. It is hard to use - be careful! These are not ordinary numbers.<br>A MachineDouble behaves like a double precision register on an 8-bit machine. Accessing and setting the high and low words of the register are legitimate. Extract returns the low word and shifts the register right by one word, while propagating the sign. This turns out to be very convenient for addition and subtraction to propagate carries and borrows. Sometimes it does too much, but it is faster than using two other messages. Arithmetic is all unsigned, but decreaseby:, when answer is negative, uses twos complement notation to represent borrows.<br>On the NoteTaker, each half of the MachineDouble will be a complete 15-bit unsigned quantity. Obtaining the low or high half may return a negative number that should be considered to be positive (unsigned). The unsignedadd: and unsignedlessthan: messages to integers allow such numbers to be used without creating large integers.<br>This class will be Nova-coded soon.</span></div>
<div class="line left">
<span class="bold large"><br>Access</span></div>
<div class="line left">
<span class="bold small">extract </span><span class="small">| x<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["returns low, moves high down and propagates sign."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">x &larr; low.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">low &larr; high.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">high &larr; [(low land: 0200)=0 ⇒[0] 0377].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑x]</span></div>
<div class="line left">
<span class="bold small">high<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑high]</span></div>
<div class="line left">
<span class="bold small">high &larr; high<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑self]</span></div>
<div class="line left">
<span class="bold small">low<br>   </span><span class="small">[⇑low]</span></div>
<div class="line left">
<span class="bold small">low &larr; low<br>   </span><span class="small">[⇑self]</span></div>
<div class="line left">
<span class="bold large"><br>Arithmetic</span></div>
<div class="line left">
<span class="bold small">&lt; arg<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[high = arg high⇒[⇑low &lt; arg low]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑high &lt; arg high]</span></div>
<div class="line left">
<span class="bold small">decreaseby: y </span><span class="small">| x "y is a positive &lt;256 integer"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[x &larr; low - y.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[x &lt; 0 ⇒[high &larr; (high-1) land: 0377]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">low &larr; x land: 0377.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑self]</span></div>
<div class="line left">
<span class="bold small">gets: x mtimes: y </span><span class="small">| xh xl yh yl p1 p2<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["x and y are 8-bit positive #&rsquo;s.<br>      Does single precision unsigned multiplication<br>      returning a double precision result."<br>    xh &larr; x field: high4.<br>    xl &larr; x field: low4.<br>    yh &larr; y field: high4.<br>    yl &larr; y field: low4.<br>    low &larr; yl * xl.<br>    high &larr; yh * xh.<br>    p2 &larr; yh * xl.<br>    p1 &larr; (p2 + (yl * xh)).<br>    high &larr; high + (p1 lshift: ¬4).<br>    low &larr; ((p1 land: 017) lshift: 4) + low.<br>    [low ≥ 256 ⇒ [high &larr; high + 1. low &larr; low - 256.]].<br>    ⇑self]</span></div>
<div class="line left">
<span class="bold small">increaseby: y </span><span class="small">| x "y is a positive &lt;256 integer"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[x &larr; low + y.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[x &gt; 255 ⇒[high &larr; (high+1) land: 0377]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">low &larr; x land: 0377.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑self]</span></div>
<div class="line left">
<span class="bold small">mdiv: y </span><span class="small">| x<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["Ignores y high (assumes it to be zero. Also assumes that y &gt; x high.<br>      This does a single precision unsigned divide into a double precision dividend<br>      that results in a single precision quotient (returned) and<br>      a single precision remainder(placed in self high)."<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">high &lt; 128 ⇒ [x &larr; (high lshift: 8) + low.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">high &larr; x\y.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑x/y.]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">high &gt; y ⇒ [user notify: &rsquo;illegal MachineDouble division&rsquo;]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">x &larr; ((high lshift: 1) + (low lshift: ¬7)) - y.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">high &larr; x lshift: ¬1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">low &larr; (low field: 027 &larr; x).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑((self mdiv: y) + 128)]</span></div>
<div class="line left">
<span class="bold large"><br>As yet unclassified</span></div>
<div class="line left">
<span class="bold small">asInt </span><span class="small">| n i "may return a negative number"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑((high lshift: 8) lor: low)]</span></div>
<div class="line left">
<span class="bold small">classInit<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["low4 is a field description for the low order 4 bits of an Integer<br>      high4 is a field description for the high order 4 bits of an 8-bit Integer"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">low4 &larr; 0100.<br>    high4 &larr; 0104]</span></div>
<div class="line left">
<span class="bold small">init<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[low &larr; 0. high &larr; 0. ⇑self]</span></div>
<div class="line left">
<span class="bold small">printon: strm </span><span class="small">| <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[strm append: &rsquo;[MachineDouble 0&rsquo;.<br>     high printon: strm base: 8.<br>     strm append: &rsquo; 0&rsquo;.<br>     low printon: strm base: 8.<br>     strm append: &rsquo;]&rsquo;]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪MachineDouble under: &rsquo;Numbers&rsquo;.</span></div>
<div class="line left">
<span class="small">MachineDouble classInit</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"Time"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;Time&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: Object<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;h m s&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;&rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>Implements times of day.  Still needs a lot of work.  (Steve Weyer)</span></div>
<div class="line left">
<span class="bold large"><br>Setting state</span></div>
<div class="line left">
<span class="bold small">default </span><span class="small">["</span><span class="italic small">right now</span><span class="small">" ⇑user now◦2]</span></div>
<div class="line left">
<span class="bold small">fromSeconds: sec </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"seconds since midnight (adjusted for time zone and DST)"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">sec &larr; sec asInteger intdiv: 3600.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">h &larr; (sec◦1) asSmall.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">sec &larr; (sec◦2) asSmall.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">m &larr; sec / 60.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s &larr; sec \ 60]</span></div>
<div class="line left">
<span class="bold small">hours: h</span></div>
<div class="line left">
<span class="bold small">minutes: m</span></div>
<div class="line left">
<span class="bold small">seconds: s</span></div>
<div class="line left">
<span class="bold large"><br>Printing</span></div>
<div class="line left">
<span class="bold small">printon: strm </span><span class="italic small">"Format is h:mm:ss am/pm"</span><span class="small"> [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">strm print: [h&gt;12⇒[h-12]; &lt;1⇒[12] h];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">append: [m &lt; 10⇒ [&rsquo;:0&rsquo;] &rsquo;:&rsquo;]; print: m;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">append: [s &lt; 10⇒ [&rsquo;:0&rsquo;] &rsquo;:&rsquo;]; print: s;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">space append: [h&lt;12⇒[&rsquo;am&rsquo;] &rsquo;pm&rsquo;]]</span></div>
<div class="line left">
<span class="bold large"><br>Aspects</span></div>
<div class="line left">
<span class="bold small">asSeconds </span><span class="small">[⇑3600 * h + (60*m+s)]</span></div>
<div class="line left">
<span class="bold small">hours </span><span class="small">[⇑h]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪Time under: &rsquo;Numbers&rsquo;.</span></div>
    <div class="line left">
<span class="small">&rsquo;From Smalltalk 5.5k XM November 24 on 22 November 1980 at 2:57:08 am.&rsquo;<br></span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large">"Array"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;Array&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: Object<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;&rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>Array is an abstract class in the sense that it has no state, and instantiation is consequently not meaningful.  However it defines the default message set inherited by its subclasses, notably String, Vector, and UniqueString.  Notice that subscripting is not done here, except to handle the exceptional cases such as subscripting by other types as in a◦(1 to: 3).</span></div>
<div class="line left">
<span class="bold large"><br>Reading and Writing</span></div>
<div class="line left">
<span class="bold small">◦ x<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑x subscripts: self]</span></div>
<div class="line left">
<span class="bold small">◦ x &larr; val<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑x subscripts: self &larr; val]</span></div>
<div class="line left">
<span class="bold small">&lt; v </span><span class="italic small">"for sorting vectors by first element"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑(self◦1)&lt;(v◦1)]</span></div>
<div class="line left">
<span class="bold small">= arg </span><span class="small">| x<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[arg isArray⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self length ≠ arg length⇒ [⇑false]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ x to: self length do⦂ <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[(self◦x) = (arg◦x)⇒ [] ⇑false]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑true]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑false]</span></div>
<div class="line left">
<span class="bold small">&gt; v </span><span class="italic small">"for sorting vectors by first element"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑(self◦1)&gt;(v◦1)]</span></div>
<div class="line left">
<span class="bold small">all &larr; val </span><span class="small">| i<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[for⦂ i to: self length do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self◦i &larr; val]]</span></div>
<div class="line left">
<span class="bold small">last<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑self◦self length]</span></div>
<div class="line left">
<span class="bold small">last &larr; val<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑self◦self length &larr; val]</span></div>
<div class="line left">
<span class="bold small">length  </span><span class="small">[user notify: &rsquo;message not understood.&rsquo;]</span></div>
<div class="line left">
<span class="bold large"><br>Copying and Altering</span></div>
<div class="line left">
<span class="bold small">+ arg </span><span class="small">[⇑self concat: arg]</span></div>
<div class="line left">
<span class="bold small">concat: arg </span><span class="small">| x s [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">x &larr; self species new: self length + arg length.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self copyto: (s &larr; x asStream).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">arg copyto: s.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑x]</span></div>
<div class="line left">
<span class="bold small">copy<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑self copy: 1 to: self length]</span></div>
<div class="line left">
<span class="bold small">copy: a to: b<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑self copy: a to: b to: (self species new: b-a+1)]</span></div>
<div class="line left">
<span class="bold small">copy: a to: b to: t </span><span class="small">| i s me<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[s &larr; t asStream.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">me &larr; Stream new of: self from: a to: b.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i from: a to: b do⦂</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"general code wont stop at false"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[s next &larr; me next]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑t]</span></div>
<div class="line left">
<span class="bold small">copyto: t<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑self copy: 1 to: self length to: t]</span></div>
<div class="line left">
<span class="bold small">delete: obj </span><span class="small">| s each<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[s &larr; (self species new: self length) asStream.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ each from: self do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[obj=each⇒[] s next&larr; each]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ s contents]</span></div>
<div class="line left">
<span class="bold small">grow </span><span class="small">[⇑self growto: (4 max: self length*2)]</span></div>
<div class="line left">
<span class="bold small">growby: n </span><span class="small">[⇑self growto: self length + n]</span></div>
<div class="line left">
<span class="bold small">growto: n </span><span class="small">[⇑self "copyto:" copy: 1 to: self length to: (self species new: n)]</span></div>
<div class="line left">
<span class="bold small">insertNonDescending: x</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"self is assumed to be sorted"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑self insertSorted: x]</span></div>
<div class="line left">
<span class="bold small">insertSorted: x </span><span class="small">| a c i</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"self is assumed to be sorted"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[i &larr; self findSorted: x.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">c &larr; (a &larr; self species new: self length+1) asStream.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self◦(1 to: i) copyto: c. c next &larr; x. self◦(i+1 to: self length) copyto: c.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑a]</span></div>
<div class="line left">
<span class="bold small">notNil </span><span class="small">| t i  </span><span class="italic small">"copy self (which contains no falses) removing all nils"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[t &larr; (self species new: (self length-(self count: nil))) asStream.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i from: self do⦂ [i≡nil ⇒[] t next&larr; i].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑t asArray]<br></span></div>
<div class="line left">
<span class="bold small">replace: a to: b by: s </span><span class="small">| x xs<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[x &larr; self species new: self length+s length -(1+b-a).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">xs &larr; x asStream.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self copy: 1 to: a-1 to: xs.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s copy: 1 to: s length to: xs.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self copy: b+1 to: self length to: xs.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑x]</span></div>
<div class="line left">
<span class="bold small">without: index </span><span class="small">| s me i  </span><span class="italic small">"if index in range, return self without ◦index"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[index cansubscript: self⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[s &larr; (self species new: self length-1) asStream.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">me &larr; self asStream.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: self length do⦂ [i=index⇒ [me next] s next &larr; me next].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑s asArray]]</span></div>
<div class="line left">
<span class="bold large"><br>Searching</span></div>
<div class="line left">
<span class="bold small">all⦂ variable suchThat⦂ expr </span><span class="small">| s i x  </span><span class="italic small">"a copy of some of me"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[s &larr; (self species new: self length) asStream.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: self length do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[x &larr; self◦i. variable value &larr; x.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">expr eval⇒ [s next &larr; x]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑s contents]</span></div>
<div class="line left">
<span class="bold small">count: x </span><span class="small">| i n<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[n&larr;0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: self length do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[x=(self◦i)⇒ [n&larr;n+1]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑n]</span></div>
<div class="line left">
<span class="bold small">find⦂ x suchThat⦂ predicate </span><span class="small">| i<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[for⦂ i to: self length do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[x value &larr; self◦i. predicate eval⇒ [⇑i]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑0]</span></div>
<div class="line left">
<span class="bold small">find: x </span><span class="small">| i<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[for⦂ i to: self length do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self◦i=x⇒ [⇑i]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑0]</span></div>
<div class="line left">
<span class="bold small">findnon: x </span><span class="small">| i<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[for⦂ i to: self length do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self◦i≠x⇒ [⇑i]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑0]</span></div>
<div class="line left">
<span class="bold small">findSorted: x </span><span class="small">| lo mid hi</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">" returns index of largest element ≤ x "<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[hi &larr; self length+1.  lo &larr; 1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ lo &lt; hi do⦂</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"binary search; self must be sorted"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self◦(mid&larr;lo+hi/2) &gt; x⇒[hi &larr; mid]  lo &larr; mid+1].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑hi-1]</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">" 0≤result≤length "</span></div>
<div class="line left">
<span class="bold small">first⦂ x suchThat⦂ predicate </span><span class="small">| i<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[for⦂ i to: self length do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[x value &larr; self◦i. predicate eval⇒ [⇑self◦i]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑false]</span></div>
<div class="line left">
<span class="bold small">has: x </span><span class="small">[⇑(self find: x)≠0]</span></div>
<div class="line left">
<span class="bold large"><br>Permutation</span></div>
<div class="line left">
<span class="bold small">permutationToSort<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"Return a Vector, permutation, such that self◦permutation is sorted nondescending.  Do not alter self."</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑((self◦((1 to: self length) copy)) sort: 1 to: self length) map.]</span></div>
<div class="line left">
<span class="bold small">promote: t </span><span class="small">| n<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[n &larr; self find: t. n=0⇒ []<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self◦(n to: 2 by: ¬1) &larr; self◦(n-1 to: 1 by: ¬1).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self◦1 &larr; t]</span></div>
<div class="line left">
<span class="bold small">reverse</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑Substring new data: self map: (self length to: 1 by: ¬1)]</span></div>
<div class="line left">
<span class="bold small">sort<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"Permute my elements so they are sorted nondescending.  Note: if I am a substring, only my map will be permuted.  In certain situations, this may not be what you expect."</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self sort: 1 to: self length.]</span></div>
<div class="line left">
<span class="bold small">sort: i to: j </span><span class="small">| di dij dj tt ij k l n<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"Sort elements i through j of self to be nondescending."</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"The prefix d means the data at."</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(n&larr;j+1-i)≤1⇒ [</span><span class="italic small">"Nothing to sort."</span><span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"Sort di,dj."</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">di &larr; self◦i. dj &larr; self◦j.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[di&gt;dj⇒ [self swap: i with: j. tt&larr;di. di&larr;dj. dj&larr;tt]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">n=2⇒ [</span><span class="italic small">"They are the only two elements."</span><span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">ij &larr; (i+j) lshift: ¬1. </span><span class="italic small">"ij is the midpoint of i and j."</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"Sort di,dij,dj.  Make dij be their median."</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">dij &larr; self◦ij.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[di&gt;dij⇒ [self swap: i with: ij. dij&larr;di] dj&lt;dij⇒ [self swap: j with: ij. dij&larr;dj]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">n=3⇒ [</span><span class="italic small">"They are the only three elements."</span><span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"Find k&gt;i and l&lt;j such that dk,dij,dl are in reverse order.  Swap k and l.  Repeat this procedure until j and k pass each other."</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">k &larr; i. l &larr; j.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ self◦(l&larr;l-1) &gt; dij do⦂ [].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ self◦(k&larr;k+1) &lt; dij do⦂ [].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">k≤l<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self swap: k with: l].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"Now l&lt;k (either 1 or 2 less), and di through dl are all less than dk through dj.  Sort those two segments."</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self sort: i to: l.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self sort: k to: j.]</span></div>
<div class="line left">
<span class="bold small">swap: i with: j </span><span class="small">| t<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[t &larr; self◦i. self◦i &larr; self◦j. self◦j &larr; t]</span></div>
<div class="line left">
<span class="bold large"><br>Conversion</span></div>
<div class="line left">
<span class="bold small">asSet </span><span class="small">[⇑Set new of: self to: self length]</span></div>
<div class="line left">
<span class="bold small">asStream<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑Stream new of: self]</span></div>
<div class="line left">
<span class="bold small">frequencies </span><span class="small">| d x  </span><span class="italic small">"return a sorted vector ((freq item) (freq item) ...)"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[d &larr; Dictionary new init: 64.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ x from: self do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[d tally: x].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑d asInvertedVector sort]</span></div>
<div class="line left">
<span class="bold small">sum </span><span class="small">[⇑self sumTo: 0]</span></div>
<div class="line left">
<span class="bold small">sumTo: subTotal </span><span class="small">| x</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"add all my elements to this subTotal (usually 0 or 0.0)"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[for⦂ x from: self do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[subTotal&larr; subTotal+x].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑subTotal]</span></div>
<div class="line left">
<span class="bold small">transform⦂ each to⦂ expr </span><span class="small">| s i  </span><span class="italic small">"a copy of me with each element transformed"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[s &larr; (self species new: self length) asStream.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: self length do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[each value &larr; self◦i. s next &larr; expr eval].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑s asArray]</span></div>
<div class="line left">
<span class="bold small">viewer </span><span class="small">[⇑SetReader new of: self]</span></div>
<div class="line left">
<span class="bold large"><br>Mapping</span></div>
<div class="line left">
<span class="bold small">cansubscript: a </span><span class="small">| i<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[for⦂ i from: self do⦂ [i cansubscript: a⇒ [] ⇑false]]</span></div>
<div class="line left">
<span class="bold small">subscripts: x</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"subarrays"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑Substring new data: x map: self]</span></div>
<div class="line left">
<span class="bold small">subscripts: x &larr; val</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"subrange replacement"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self length≠val length⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[user notify: &rsquo;lengths not commensurate&rsquo;]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">val copyto: (Substring new data: x map: self).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑val]</span></div>
<div class="line left">
<span class="bold large"><br>Compatibility</span></div>
<div class="line left">
<span class="bold small">isArray</span></div>
<div class="line left">
<span class="bold small">isIntervalBy1<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑false]</span></div>
<div class="line left">
<span class="bold small">species<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑Vector]</span></div>
<div class="line left">
<span class="bold large"><br>Comparing</span></div>
<div class="line left">
<span class="bold small">hash </span><span class="italic small">"make sure = arrays hash =ly"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self length=0⇒[⇑17171]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑(self◦1) hash + (self◦self length) hash]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪Array under: &rsquo;Basic Data Structures&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"FieldReference"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;FieldReference&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: Object<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;object offset&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;&rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>I reference a field of an instance</span></div>
<div class="line left">
<span class="bold large"><br>Initialization</span></div>
<div class="line left">
<span class="bold small">object: object offset: offset</span></div>
<div class="line left">
<span class="bold large"><br>Indirection</span></div>
<div class="line left">
<span class="bold small">eval <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑object instfield: offset]</span></div>
<div class="line left">
<span class="bold small">value </span><span class="small">[⇑object instfield: offset]</span></div>
<div class="line left">
<span class="bold small">value &larr; value<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[object instfield: offset &larr; value. ⇑value]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪FieldReference under: &rsquo;Basic Data Structures&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"Interval"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;Interval&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: Array<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;start stop step length&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;&rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>I am an arithmetic progression from start in steps of step, not exceeding stop</span></div>
<div class="line left">
<span class="bold large"><br>Initialization</span></div>
<div class="line left">
<span class="bold small">from: start to: stop by: step<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[length &larr; 1+(stop-start/step).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">step&lt;0⇒[start&lt;stop⇒[length&larr; 0]]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">stop&lt;start⇒[length&larr; 0]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold large"><br>Reading and Writing</span></div>
<div class="line left">
<span class="bold small">◦ x<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[x is: Integer⇒[x&lt;1⇒ [⇑nil]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">x&gt;length⇒ [⇑nil]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑start+(step*(x-1))]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑super◦x]</span></div>
<div class="line left">
<span class="bold small">◦ x &larr; val<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[user notify: &rsquo;Intervals are not for writing into&rsquo;]</span></div>
<div class="line left">
<span class="bold small">length </span><span class="small">[⇑length]</span></div>
<div class="line left">
<span class="bold small">start </span><span class="small">[⇑start]</span></div>
<div class="line left">
<span class="bold small">stop </span><span class="small">[⇑stop]</span></div>
<div class="line left">
<span class="bold large"><br>Compatibility</span></div>
<div class="line left">
<span class="bold small">= int </span><span class="small">[⇑start = int start and⦂ (stop = int stop and⦂ length = int length)]</span></div>
<div class="line left">
<span class="bold small">cansubscript: a<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑length≤0 or⦂ ((start cansubscript: a) and⦂ (length-1*step+start cansubscript: a))]</span></div>
<div class="line left">
<span class="bold small">hash </span><span class="small">[⇑(((start lshift: 2) lxor: stop) lshift: 1) lxor: length]</span></div>
<div class="line left">
<span class="bold small">isIntervalBy1<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑step=1]</span></div>
<div class="line left">
<span class="bold large"><br>Random Numbers</span></div>
<div class="line left">
<span class="bold small">random</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"See Lehmers linear congruential method, Knuth Vol. 1:<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">modulus m=2&uarr;16<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">a=27181 odd, and 5 = a mod 8<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">c=13849 odd, and c/m around 0.21132"</span><span class="bold small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[step&larr; (13849 + (27181*step)) asSmall.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑(start + ((length asFloat*(32768.0+step))/65536.0)) asSmall]</span></div>
<div class="line left">
<span class="bold small">randomInit </span><span class="small">[self randomInit: mem◦0430]</span></div>
<div class="line left">
<span class="bold small">randomInit: x</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"Call with const to get repeatable sequence"</span><span class="bold small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[step&larr; x.</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"step holds the current state"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">start is: Float⇒[length&larr;stop-start]</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"for Float intervals"</span><span class="small">]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪Interval under: &rsquo;Basic Data Structures&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"ObjectReference"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;ObjectReference&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: Object<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;object&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;&rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>I am an indirect reference</span></div>
<div class="line left">
<span class="bold large"><br>Initialization</span></div>
<div class="line left">
<span class="bold small">object: object</span></div>
<div class="line left">
<span class="bold large"><br>Indirection</span></div>
<div class="line left">
<span class="bold small">eval <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑object]</span></div>
<div class="line left">
<span class="bold small">value </span><span class="small">[⇑object]</span></div>
<div class="line left">
<span class="bold small">value &larr; object<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑object]</span></div>
<div class="line left">
<span class="bold large"><br>Conversion</span></div>
<div class="line left">
<span class="bold small">printon: strm<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[strm append: &rsquo;-&gt;&rsquo;; print: object]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪ObjectReference under: &rsquo;Basic Data Structures&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"RunVector"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;RunVector&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: Array<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo; min max starts values offset&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;&rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>RunVectors compactly store data which tends to be constant over much<br>of its domain.  They may have any range of subscript, but must be stored<br>into consecutively.</span></div>
<div class="line left">
<span class="bold large"><br>Reading and writing</span></div>
<div class="line left">
<span class="bold small">◦i | index</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[index&larr; starts findSorted: i.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">offset&larr; i-(starts◦index).</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"distance into run"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑values◦index]</span></div>
<div class="line left">
<span class="bold small">◦i&larr; val<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[offset&larr; 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">min≡nil⇒[min&larr; max&larr; i. starts&larr; i inVector. values&larr; val inVector]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">i-1≠max⇒[user notify: &rsquo;RunVectors must be loaded sequentially&rsquo;. ⇑val]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">max&larr; i.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">val=values last⇒[offset&larr; i-starts last. ⇑val]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">starts&larr; starts , i.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">values&larr; values , val. ⇑val]<br></span></div>
<div class="line left">
<span class="bold small">length </span><span class="small">[max≡nil⇒[⇑0]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑max-min+1]</span></div>
<div class="line left">
<span class="bold small">max </span><span class="small">[⇑max]</span></div>
<div class="line left">
<span class="bold small">min </span><span class="small">[⇑min]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪RunVector under: &rsquo;Basic Data Structures&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"Stream"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;Stream&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: Object<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;array position limit&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;&rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>Streams provide fast sequential access to arrays (implemented in microcode for Strings and Vectors).  A subclass can handle end conditions if desired (disk files do this).</span></div>
<div class="line left">
<span class="bold large"><br>Initialization</span></div>
<div class="line left">
<span class="bold small">close<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[limit&larr; position. position&larr; 0]</span></div>
<div class="line left">
<span class="bold small">default<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self of: (String new: 16)]</span></div>
<div class="line left">
<span class="bold small">of: array<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[position &larr; 0. limit &larr; array length]</span></div>
<div class="line left">
<span class="bold small">of: array from: pos to: lim </span><span class="small">| len</span><span class="bold small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[limit &larr; [lim &gt; (len &larr; array length)⇒ [len] lim].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">position &larr; [pos≤1⇒ [0] pos-1]]</span></div>
<div class="line left">
<span class="bold small">release </span><span class="small">[array &larr; nil]</span></div>
<div class="line left">
<span class="bold large"><br>Sequential reading and writing</span></div>
<div class="line left">
<span class="bold small">∢ x </span><span class="small">| y<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[y&larr; self next⇒</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"peek for matching element"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[x=y⇒ [⇑y]</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"gobble it if found"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">position &larr; position-1. ⇑false]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑false]</span></div>
<div class="line left">
<span class="bold small">append: x </span><span class="small">| i</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"Array arg"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[for⦂ i from: x do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self next &larr; i].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑x]</span></div>
<div class="line left">
<span class="bold small">dequeue</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"use it as a FIFO"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑self dequeue: 1]</span></div>
<div class="line left">
<span class="bold small">dequeue: n </span><span class="small">| t<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[position&lt;n⇒ [⇑false]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">t &larr; (array◦(1 to: n)) copy.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">array◦(1 to: position-n) &larr; array◦(n+1 to: position).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">position &larr; position-n. ⇑t]</span></div>
<div class="line left">
<span class="bold small">integerScan </span><span class="small">| sign base maxdigit c val [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"get the next Integer or LargeInteger (Float?) from a Stream.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">copied from String asInteger"<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">sign&larr; [self∢025⇒[¬1] 1].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">base&larr; [self∢060⇒[8] 10].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">maxdigit&larr; 060+base.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">val&larr; 0.<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ ((c &larr; self next) and⦂ (c ≥ 060 and⦂ c &lt; maxdigit)) do⦂ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">val&larr; val*base+(c-060)].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[c⇒ [self skip: ¬1]].<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"Some special maneuvering to keep 01ddddd and ¬32768 (and nothing else)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">from overflowing."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">base=8 and⦂ (val&gt;077777 and⦂ (sign=1 and⦂ val&lt;65536))⇒[⇑val asSmall]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑(val*sign) asInteger]</span></div>
<div class="line left">
<span class="bold small">into: x </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"generate an error if the Stream is exhausted before x is filled"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑self into: x endError: true]</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: justify">
<span class="bold small">into: x endError: err </span><span class="small">| i t len [</span><span class="italic small">"Array result"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">i &larr; 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">len &larr; x length.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"read until count or stream is exhausted"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ (i &lt; len and⦂ (t &larr; self next)) do⦂ [x◦(i&larr;i+1) &larr;t].<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">err⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">t⇒ [⇑x]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user notify: &rsquo;only read first &rsquo; + i asString]<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"return number that were read"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑i]</span></div>
<div class="line left">
<span class="bold small">next</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"simple result"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self myend⇒ [⇑self pastend]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑array◦(position &larr; position+1)] primitive: 17</span></div>
<div class="line left">
<span class="bold small">next: n </span><span class="small">[⇑self into: (array species new: n) endError: true]</span></div>
<div class="line left">
<span class="bold small">next: n from: strm </span><span class="small">[for⦂ n to: n do⦂ [self next &larr; strm next]]</span></div>
<div class="line left">
<span class="bold small">next: n &larr; v </span><span class="small">[for⦂ n to: n do⦂ [self next &larr; v]]</span></div>
<div class="line left">
<span class="bold small">nextNumber: n </span><span class="small">| i s t [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">return next n characters s as a positive Integer or LargeInteger</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s &larr; false.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">scan for first non-zero byte, then collect rest appropriately</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: n do⦂ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">t &larr; self next.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s⇒ ["</span><span class="italic small">more LargeInteger: reverse order of significance</span><span class="small">" s◦(n+1-i) &larr; t]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">i=n⇒ [⇑t]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">t=0⇒ []<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">i ≤ (n-2) or⦂ "i=n-1" (t land: 0200) ≠ 0⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">LargeInteger of 2 or more bytes</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s &larr; Natural new: n+1-i.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s last &larr; t]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">positive Integer</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑(t lshift: 8) + self next].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑LargeInteger new bytes: s neg: false]</span></div>
<div class="line left">
<span class="bold small">nextNumber: n &larr; v </span><span class="small">| vlen [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">write a positive Integer or LargeInteger as n characters</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">v &larr; v bytes.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">vlen &larr; v length.<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[n &lt; vlen⇒ [user notify: &rsquo;number too big&rsquo;];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">&gt; vlen⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">pad beginning with 0&rsquo;s</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self next: n - vlen &larr; 0]].<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">vlen = 1⇒ [self next &larr; v]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">vlen = 2 and⦂ (v is: Integer)⇒ [self nextword &larr; v]<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">LargeInteger (assume pos, no negative convention)</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self append: v reverse]</span></div>
<div class="line left">
<span class="bold small">nextPoint </span><span class="small">| x [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">x &larr; self nextword.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑Point new x: x y: self nextword]</span></div>
<div class="line left">
<span class="bold small">nextPoint&larr;p </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self nextword &larr; p x;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nextword &larr; p y]</span></div>
<div class="line left">
<span class="bold small">nextString </span><span class="small">| len [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑self into: (String new: [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(len &larr; self next)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">&lt;192⇒[len]</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"up to 191 chars (BCPL compat)"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">len-192*256 + self next]) endError: true]</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"up to 16383 chars"</span></div>
<div class="line left">
<span class="bold small">nextString&larr; s </span><span class="small">| len [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[(len &larr; s length) &lt; 192⇒[self next&larr; len]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self next&larr; len/256+192; next&larr; len\256].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self append: s.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑s]</span></div>
<div class="line left">
<span class="bold small">nextword </span><span class="small">| hi lo<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[hi &larr; self next⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[lo &larr; self next⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑(hi lshift: 8)+lo]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑false]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑false]</span></div>
<div class="line left">
<span class="bold small">nextword&larr; val<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self next&larr; val lshift: ¬8.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self next&larr; val land: 0377. ⇑val]</span></div>
<div class="line left">
<span class="bold small">next &larr; x</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"simple arg"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self myend⇒ [⇑self pastend &larr; x]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑array◦(position &larr; position+1) &larr; x] primitive: 18</span></div>
<div class="line left">
<span class="bold small">padNext </span><span class="small">["make position even (on word boundary), returning padding character if any"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">position even⇒ [⇑false]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑self next]</span></div>
<div class="line left">
<span class="bold small">padNext&larr; c </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">position even⇒ [⇑false]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑self next&larr; c]</span></div>
<div class="line left">
<span class="bold small">peek </span><span class="small">| x<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[x&larr; self next⇒ [position &larr; position-1.  ⇑x]</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"peek at next element"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑false]</span></div>
<div class="line left">
<span class="bold small">pop</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"use it as a LIFO"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[position&lt;1⇒ [⇑false]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">position &larr; position-1. ⇑array◦(position+1)]</span></div>
<div class="line left">
<span class="bold small">pop: n </span><span class="small">| t<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[position&lt;n⇒ [⇑false]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">t &larr; self last: n.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">position &larr; position-n. ⇑t]</span></div>
<div class="line left">
<span class="bold small">upto: x </span><span class="small">| y s<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[s &larr; (String new: 250) asStream.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ y from: self do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[y=x⇒[⇑s contents]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s next &larr; y].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑s contents]</span></div>
<div class="line left">
<span class="bold large"><br>Test and alter position</span></div>
<div class="line left">
<span class="bold small">empty</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"for"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑position=0]</span></div>
<div class="line left">
<span class="bold small">end<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑position≥limit]</span></div>
<div class="line left">
<span class="bold small">limit<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑limit]</span></div>
<div class="line left">
<span class="bold small">loc</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"synonym for compiler"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑position]</span></div>
<div class="line left">
<span class="bold small">myend<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑position≥limit]</span></div>
<div class="line left">
<span class="bold small">pastend<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑false]</span></div>
<div class="line left">
<span class="bold small">pastend &larr; x<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[array &larr; array grow. limit &larr; array length.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑self next &larr; x]</span></div>
<div class="line left">
<span class="bold small">position<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑position]</span></div>
<div class="line left">
<span class="bold small">position&larr; position</span></div>
<div class="line left">
<span class="bold small">reset<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[position &larr; 0]</span></div>
<div class="line left">
<span class="bold small">settoend </span><span class="small">[position&larr; limit]</span></div>
<div class="line left">
<span class="bold small">skip: x<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[position &larr; position+x]</span></div>
<div class="line left">
<span class="bold small">skipTo: x </span><span class="small">| y [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ y from: self do⦂ [y=x⇒[⇑true]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑false]</span></div>
<div class="line left">
<span class="bold small">skipwords: w </span><span class="small">[self skip: 2*w]</span></div>
<div class="line left">
<span class="bold small">wordposition </span><span class="small">[⇑self position/2]</span></div>
<div class="line left">
<span class="bold small">wordposition&larr; w </span><span class="small">[self position&larr; w*2]</span></div>
<div class="line left">
<span class="bold large"><br>Static reading and writing</span></div>
<div class="line left">
<span class="bold small">◦ x<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑array◦x]</span></div>
<div class="line left">
<span class="bold small">◦ x &larr; val<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑array◦x &larr; val]</span></div>
<div class="line left">
<span class="bold small">contents </span><span class="small">[⇑array copy: 1 to: position]</span></div>
<div class="line left">
<span class="bold small">first<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[position ≠ 0 ⇒ [⇑array◦1] ⇑nil]</span></div>
<div class="line left">
<span class="bold small">insert: x </span><span class="small">| i  </span><span class="italic small">"treat as LIFO queue, insert in front"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["</span><span class="italic small">grow array if necessary</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> [position=limit⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[array&larr;array grow.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">limit&larr;array length]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: position do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[array◦(position-i+2) &larr; array◦(position-i+1)].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">array◦1 &larr; x.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">position&larr;position+1]</span></div>
<div class="line left">
<span class="bold small">last<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[position≠ 0 ⇒ [⇑array◦position] ⇑nil]</span></div>
<div class="line left">
<span class="bold small">last: n<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑(array◦(position-n+1 to: position)) copy]</span></div>
<div class="line left">
<span class="bold small">rest </span><span class="small">[⇑array copy: position+1 to: limit]</span></div>
<div class="line left">
<span class="bold large"><br>Character printing</span></div>
<div class="line left">
<span class="bold small">cr<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self next &larr; 015]</span></div>
<div class="line left">
<span class="bold small">crtab: n </span><span class="small">| i</span><span class="bold small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self next&larr;13.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: n do⦂ [self next&larr;9]]</span></div>
<div class="line left">
<span class="bold small">print: obj<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[obj printon: self]</span></div>
<div class="line left">
<span class="bold small">semicrtab<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self append: &rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">&rsquo;]</span></div>
<div class="line left">
<span class="bold small">space<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self next &larr; 040]</span></div>
<div class="line left">
<span class="bold small">tab<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self next &larr; 011]</span></div>
<div class="line left">
<span class="bold large"><br>Coercions</span></div>
<div class="line left">
<span class="bold small">asArray<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑array]</span></div>
<div class="line left">
<span class="bold small">asReadStream </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"an alternative to Set/SetReader.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">create another Stream which reads the contents of this one"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑Stream new of: array from: 1 to: position]</span></div>
<div class="line left">
<span class="bold small">asStream</span></div>
<div class="line left">
<span class="bold small">asVector </span><span class="italic small">"Convert a string to a vector of tokens"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑(Reader new of: self) read]</span></div>
<div class="line left">
<span class="bold small">viewer </span><span class="small">[⇑SetReader new of: array from: 1 to: position]</span></div>
<div class="line left">
<span class="bold large"><br>Compiler object code</span></div>
<div class="line left">
<span class="bold small">emitLong: jmpOrBfp by: dist<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[[dist&lt;0⇒ [dist&larr;dist+1024]; &gt;1023⇒ [dist&larr;¬1] jmpOrBfp&larr;jmpOrBfp+4].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">dist&lt;0⇒ [user notify: &rsquo;A block compiles more than 1K bytes of code&rsquo;]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self next &larr; dist/256 + jmpOrBfp. self next &larr; dist\256]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪Stream under: &rsquo;Basic Data Structures&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"PQueue"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;PQueue&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: Stream<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;readposition&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;&rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>A PQueue is a First In First Out list of objects implemented as an array and a read pointer and write pointer. PQueue is a subclass of Stream and uses Streamⓢstandard method for inserting a new item (next&larr;, i.e. Streamⓢposition is the write pointer). A PQueue also has a read pointer which it uses for accessing objects with the messages next or dequeue (which are identical). All messages to a PQueue that change its state are declared as critical sections to avoid race conditions</span></div>
<div class="line left">
<span class="bold large"><br>FIFO access</span></div>
<div class="line left">
<span class="bold small">dequeue: num </span><span class="small">| n<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[Top critical⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[position-readposition &lt; num ⇒ [n &larr; false]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> n &larr; (array◦(readposition+1 to: readposition + num)) copy.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> readposition &larr; readposition + num].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> ⇑n]</span></div>
<div class="line left">
<span class="bold small">length </span><span class="small">| l<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[Top critical⦂ [l &larr; position-readposition]. ⇑l]</span></div>
<div class="line left">
<span class="bold small">myend </span><span class="small">[⇑true]</span></div>
<div class="line left">
<span class="bold small">next </span><span class="small">| n<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[Top critical⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[readposition≥position⇒ [readposition&larr;position&larr;0. n &larr; false]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> n &larr; array◦(readposition &larr; readposition+1)].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> ⇑n] primitive: 98</span></div>
<div class="line left">
<span class="bold small">pastend &larr; x</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold small"> </span><span class="small">| n i</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"simple arg"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[Top critical⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[position≥limit⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[readposition=0⇒[super pastend &larr; x]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> n &larr; position-readposition.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> for⦂ i to: n do⦂ [array◦i &larr; array◦(readposition+i)].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> readposition &larr; 0. position &larr; n.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> self next &larr; x]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> array◦(position &larr; position+1) &larr; x].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> ⇑x]</span></div>
<div class="line left">
<span class="bold small">peek </span><span class="small">| n<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[Top critical⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[readposition≥position⇒ [readposition&larr;position&larr;0. n &larr; false]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> n &larr; array◦(readposition + 1)].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> ⇑n]</span></div>
<div class="line left">
<span class="bold small">skip: x<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[Top critical⦂ [readposition &larr; readposition+x]]</span></div>
<div class="line left">
<span class="bold large"><br>LIFO access</span></div>
<div class="line left">
<span class="bold small">push: x</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"treat as LIFO queue"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[Top critical⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[readposition &gt; 0 ⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[array◦readposition &larr; x.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> readposition &larr; readposition - 1]</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"readpositon &gt; 0, just jam it in"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> self insert: x]]</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"otherwise insert on front"</span></div>
<div class="line left">
<span class="bold large"><br>Stream protocol</span></div>
<div class="line left">
<span class="bold small">contents </span><span class="small">| n<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[Top critical⦂ [n &larr; (array◦(readposition+1 to: position)) copy]. ⇑n]</span></div>
<div class="line left">
<span class="bold small">empty </span><span class="small">| l<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[Top critical⦂ [l &larr; readposition≥position]. ⇑l] primitive: 99</span></div>
<div class="line left">
<span class="bold small">end </span><span class="small">| n<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[Top critical⦂ [n &larr; readposition≥position]. ⇑n]</span></div>
<div class="line left">
<span class="bold small">of: array<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[Top critical⦂ [position &larr; 0. readposition &larr; 0. limit &larr; array length]]</span></div>
<div class="line left">
<span class="bold small">of: array from: position to: limit<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[user notify: &rsquo;of:from:to: is not appropriate for PQueues&rsquo;]</span></div>
<div class="line left">
<span class="bold small">reset<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[Top critical⦂ [readposition &larr; position &larr; 0]]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪PQueue under: &rsquo;Basic Data Structures&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"Queue"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;Queue&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: Stream<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;readposition&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;&rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>A Queue is a First In First Out list of objects implemented as an array and a read pointer and write pointer. Queue is a subclass of Stream and uses Streamⓢstandard method for inserting a new item (next&larr;, i.e. Streamⓢposition is the write pointer). A Queue also has a read pointer which it uses for accessing objects with the messages next or dequeue (which are identical)</span></div>
<div class="line left">
<span class="bold large"><br>FIFO access</span></div>
<div class="line left">
<span class="bold small">deQ1 </span><span class="small">| n</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"A noninterruptable dequeue"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[Top critical⦂ [n &larr; self dequeue].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> ⇑n]</span></div>
<div class="line left">
<span class="bold small">dequeue<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[readposition≥position⇒ [readposition&larr;position&larr;0. ⇑false]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> ⇑array◦(readposition &larr; readposition+1)]</span></div>
<div class="line left">
<span class="bold small">dequeue: num </span><span class="small">| n<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[position-readposition &lt; num ⇒ [⇑false]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> n &larr; (array◦(readposition+1 to: readposition + num)) copy.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> readposition &larr; readposition + num.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> ⇑n]</span></div>
<div class="line left">
<span class="bold small">enQ1: n</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"A noninterruptable enqueue"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[Top critical⦂ [super next&larr; n].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> ⇑n]</span></div>
<div class="line left">
<span class="bold small">length<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑position-readposition]</span></div>
<div class="line left">
<span class="bold small">next<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[readposition≥position⇒ [readposition&larr;position&larr;0. ⇑false]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> ⇑array◦(readposition &larr; readposition+1)]</span></div>
<div class="line left">
<span class="bold small">peek<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[readposition≥position⇒ [readposition&larr;position&larr;0. ⇑false]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> ⇑array◦(readposition + 1)]</span></div>
<div class="line left">
<span class="bold small">skip: x<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[readposition &larr; readposition+x]</span></div>
<div class="line left">
<span class="bold large"><br>LIFO access</span></div>
<div class="line left">
<span class="bold small">push: x</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"treat as LIFO queue"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[readposition &gt; 0 ⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[array◦readposition &larr; x.  readposition &larr; readposition - 1]</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"readpositon &gt; 0, just jam it in"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self insert: x]</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"otherwise insert on front"</span></div>
<div class="line left">
<span class="bold large"><br>Stream protocol</span></div>
<div class="line left">
<span class="bold small">contents<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑(array◦(readposition+1 to: position)) copy]</span></div>
<div class="line left">
<span class="bold small">empty<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑readposition≥position]</span></div>
<div class="line left">
<span class="bold small">end<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑readposition≥position]</span></div>
<div class="line left">
<span class="bold small">of: array<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[position &larr; 0. readposition &larr; 0. limit &larr; array length]</span></div>
<div class="line left">
<span class="bold small">of: array from: position to: limit<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[user notify: &rsquo;of:from:to: is not appropriate for Queues&rsquo;]</span></div>
<div class="line left">
<span class="bold small">pastend &larr; x </span><span class="small">| n<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[readposition=0⇒[⇑super pastend &larr; x]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> n &larr; position-readposition.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> array◦(1 to: n) &larr; array◦(readposition+1 to: position).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> readposition &larr; 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> position &larr; n.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> ⇑self next &larr; x]</span></div>
<div class="line left">
<span class="bold small">reset<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[readposition &larr; position &larr; 0]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪Queue under: &rsquo;Basic Data Structures&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"Set"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;Set&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: Stream<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;views&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;&rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>For storing/collecting, read by a SetReader.<br>Use no messages from Stream except of:, empty, next&larr;, contents, space, nextword&larr;</span></div>
<div class="line left">
<span class="bold large"><br>Initialization</span></div>
<div class="line left">
<span class="bold small">default </span><span class="small">[self vector: 8]</span></div>
<div class="line left">
<span class="bold small">of: array to: position </span><span class="small">[limit &larr; array length]</span></div>
<div class="line left">
<span class="bold small">string: limit </span><span class="small">[self of: (String new: limit)]</span></div>
<div class="line left">
<span class="bold small">vector: limit </span><span class="small">[self of: (Vector new: limit)]</span></div>
<div class="line left">
<span class="bold large"><br>Index operations</span></div>
<div class="line left">
<span class="bold small">◦i </span><span class="small">[⇑array◦("self checkIndex:" i)]</span></div>
<div class="line left">
<span class="bold small">◦i &larr; val </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">position+1 = i⇒ [self next &larr; val]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑array◦("self checkIndex:" i) &larr; val]</span></div>
<div class="line left">
<span class="bold small">deleteI: i </span><span class="small">| v j<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">v &larr; self◦i.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ j from: i to: position-1 do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[array◦j &larr; array◦(j+1)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">array◦position &larr; nil.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">position &larr; position-1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑v<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">deleteI: i to: j</span><span class="small">| n k<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">n &larr; j-i+1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ k from: i to: position-n do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[array◦k &larr; array◦(k+n)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ k from: position-n+1 to: position do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[array◦k &larr; nil<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">position &larr; position-n.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">insertI: i value: v </span><span class="small">| old j <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[i &gt; position ⇒ [ self next &larr; v ]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">old&larr;array.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[position = limit⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[limit&larr; limit+(10 max: limit/4).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">array &larr; array species new: limit.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ j to: i-1 do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[array◦j &larr; old◦j<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ j from: position  to: i by: ¬1 do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[array◦(j+1) &larr; old◦j<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">array◦i &larr; v.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">position  &larr; position +1<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold large"><br>Value operations</span></div>
<div class="line left">
<span class="bold small">add: x  </span><span class="small">[self next &larr; x]</span></div>
<div class="line left">
<span class="bold small">append: x  </span><span class="small">[for⦂ x from: x do⦂ [self next &larr; x]]</span></div>
<div class="line left">
<span class="bold small">delete: x </span><span class="small">| i [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: position do⦂ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">array◦i ≡ x⇒ [⇑self deleteI: i]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑false]</span></div>
<div class="line left">
<span class="bold small">find: v </span><span class="small">| i [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: position do⦂ [array◦i = v⇒ [⇑i]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑0]</span></div>
<div class="line left">
<span class="bold small">has: x </span><span class="small">[⇑(self find: x) &gt; 0]</span></div>
<div class="line left">
<span class="bold small">insert: x </span><span class="small">[(self find: x) = 0⇒ [self next&larr; x]]</span></div>
<div class="line left">
<span class="bold large"><br>Viewing</span></div>
<div class="line left">
<span class="bold small">asSet</span></div>
<div class="line left">
<span class="bold small">asStream </span><span class="small">[⇑self viewer]</span></div>
<div class="line left">
<span class="bold small">copy </span><span class="small">[⇑self viewer copy]</span></div>
<div class="line left">
<span class="bold small">initView: v </span><span class="small">[⇑v of: array to: position]</span></div>
<div class="line left">
<span class="bold small">length </span><span class="small">[⇑position]</span></div>
<div class="line left">
<span class="bold small">notViewed: v </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">views delete: v;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">empty⇒ [views &larr; nil]]</span></div>
<div class="line left">
<span class="bold small">printon: strm </span><span class="small">| t [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">strm append: &rsquo;a Set: &rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">array is: String⇒ [strm append: self]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ t from: self do⦂ [strm space; print: t]]</span></div>
<div class="line left">
<span class="bold small">species </span><span class="small">[⇑array species]</span></div>
<div class="line left">
<span class="bold small">viewer </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑SetReader new of: array from: 1 to: position<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"self viewRange: 1 to: position"]</span></div>
<div class="line left">
<span class="bold small">viewer: v </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[views≡nil⇒ [views &larr; Set default]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">views next &larr; v]</span></div>
<div class="line left">
<span class="bold small">viewRange: i to: j </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑"self viewer:" (<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">SetReader new of: array from: (i "max: 1") to: (j "min: position"))]</span></div>
<div class="line left">
<span class="bold large"><br>Private</span></div>
<div class="line left">
<span class="bold small">checkIndex: i </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">i ≥ 1 and⦂ i ≤ position⇒ [⇑i]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑user notify: &rsquo;illegal index&rsquo;]</span></div>
<div class="line left">
<span class="bold small">grow </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"self grown and reset. returns another Set with old contents"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑self growby: (10 max: limit/4)]</span></div>
<div class="line left">
<span class="bold small">growby: n | old </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"grow and reset self. return old Set for copying"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">old &larr; Set new of: array to: position.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self of: (array species new: limit+n) to: 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑old]</span></div>
<div class="line left">
<span class="bold small">next </span><span class="small">[user notify: &rsquo;no direct reading of a Set&rsquo;]</span></div>
<div class="line left">
<span class="bold small">pastend &larr; x </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑[self append: self grow; next &larr; x]]</span></div>
<div class="line left">
<span class="bold large"><br>Arithmetic operations</span></div>
<div class="line left">
<span class="bold small">dotproduct: s </span><span class="small">| i dotproduct<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["dot product of two sets ... sets must be of equal length"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">dotproduct &larr; 0.0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self length = s length ⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: position do⦂ [dotproduct &larr; dotproduct + ((s◦i)*(self◦i))].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ dotproduct  <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user notify: &rsquo;dot product undefined...sets are not of equal length&rsquo;. <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">product: s </span><span class="small">| product i<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["product of two sets ... sets must be of equal length"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">product &larr; Set new default.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self length = s length ⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: position do⦂ [product add: (s◦i)*(self◦i)].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ product<br>  <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user notify: &rsquo;product undefined...sets are not of equal length&rsquo;. <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">summation</span><span class="small">| i summation<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["sum of the values in the set"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">summation &larr; 0.0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: position do⦂ [summation &larr; summation + (self◦i)].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ summation<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪Set under: &rsquo;Basic Data Structures&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"SetReader"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;SetReader&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: Stream<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;&rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>Read a Set; no edits occur to set. (see Steve for ISetReader (interruptible))<br>Inherit of:from:to:, next, next:, end, pastend, skip:, ∢, asStream, viewer</span></div>
<div class="line left">
<span class="bold large"><br>Initialization</span></div>
<div class="line left">
<span class="bold small">of: array from: position for: n </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">position &larr; position-1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">limit &larr; position+n]</span></div>
<div class="line left">
<span class="bold large"><br>Reading</span></div>
<div class="line left">
<span class="bold small">asSet </span><span class="small">[⇑self copy]</span></div>
<div class="line left">
<span class="bold small">copy </span><span class="small">"yield contents all at once as a Set" [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑[Set new of: (array species new: limit-position); append: self]]</span></div>
<div class="line left">
<span class="bold small">length </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"how much left"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑limit-position]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪SetReader under: &rsquo;Basic Data Structures&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"String"</span></div>
<div class="line left">
<span class="bold large">VariableLengthClass new title: &rsquo;String&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: Array<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;StringBlter &rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">bytesize: 8;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>I am an array of bytes, integers between 0 and 255 usually representing ascii characters</span></div>
<div class="line left">
<span class="bold large"><br>Reading and Writing</span></div>
<div class="line left">
<span class="bold small">all&larr; val </span><span class="small">[self fill: 1 to: self length with: val]</span></div>
<div class="line left">
<span class="bold small">fill: a to: b with: val </span><span class="small">| i [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"eventually use BitBlt?"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i from: a to: b do⦂ [self◦i &larr; val]]</span></div>
<div class="line left">
<span class="bold small">length </span><span class="small">[⇑self length </span><span class="italic small">"In case this is reached by perform:"</span><span class="small">]</span></div>
<div class="line left">
<span class="bold small">word: x</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"read word in String"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑self◦(x+x) + (self◦(x+x-1) lshift: 8)]</span></div>
<div class="line left">
<span class="bold small">word: x &larr; y</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"write word in String"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self◦(x+x-1) &larr; y lshift: ¬8.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self◦(x+x) &larr; y land: 0377. ⇑y]</span></div>
<div class="line left">
<span class="bold large"><br>Copying and Altering</span></div>
<div class="line left">
<span class="bold small">concat: s </span><span class="small">| len [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(len &larr; self length) + s length &gt; 20 and⦂ (s Is: String)⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"this concatenates more quickly if BitBlt is used"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑self replace: len+1 to: len by: s from: 1 to: s length]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑super concat: s]</span></div>
<div class="line left">
<span class="bold small">copy: a to: b </span><span class="small">[⇑(self species new: 1+b-a) copy: 1 to: 1+b-a with: self from: a to: b]</span></div>
<div class="line left">
<span class="bold small">copy: a to: b with: s from: c to: d </span><span class="small">| i [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">like replace, except in place. self◦(a to: b) &larr; s◦(c to: d).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">use BitBlt unless size too small, StringBlter≡false, or index/sizes too large</span><span class="small">"<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(b-a &gt; 12 and⦂ StringBlter) and⦂ (<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">BitBlt new stringCopy: self from: a to: b with: s from: c to: d)⇒ []<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self ≡ s and⦂ (c &lt; a and⦂ d ≥ a)⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">overlap of second range with below first in same string.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">copy in reverse order: self◦(b to: a by: ¬1) &larr; self◦(d to: c by: ¬1)</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i from: b-a to: 0 by: ¬1 do⦂ [self◦(a+i) &larr; self◦(c+i)]]<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s copy: c to: d to: (Stream new of: self from: a to: b)]</span>&nbsp;&nbsp;&nbsp;&nbsp;</div>
<div class="line left">
<span class="bold small">findString: str startingAt: start </span><span class="small">| i t<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[str length=0⇒[⇑0] t&larr; str◦1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i from: start to: self length-str length+1 do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self◦i=t⇒[self◦(i to: i+str length-1)=str⇒[⇑i]]]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑0]</span></div>
<div class="line left">
<span class="bold small">growto: n </span><span class="small">| len [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[(len &larr; self length) ≤ n⇒ [] len &larr; n].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑(self species new: n) copy: 1 to: len with: self from: 1 to: len]</span></div>
<div class="line left">
<span class="bold small">recopy<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑self copy]</span></div>
<div class="line left">
<span class="bold small">replace: a to: b by: s <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[s Is: String ⇒[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑self replace: a to: b by: s from: 1 to: s length]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑self replace: a to: b by: s asArray from: 1 to: s position]</span></div>
<div class="line left">
<span class="bold small">replace: a to: b by: r from: c to: d </span><span class="small">| s t [</span><span class="bold small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s &larr; self species new: self length + (d-c) - (b-a).<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">use BitBlt unless StringBlter≡false or index/sizes too large</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">StringBlter and⦂ (<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">BitBlt new stringReplace: s with: self from: a to: b and: r from: c to: d)⇒ [⇑s]<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">see Array concat:</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">t &larr; Stream new of: s.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self copy: 1 to: a-1 to: t.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">r copy: c to: d to: t.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self copy: b+1 to: self length to: t.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑s]</span></div>
<div class="line left">
<span class="bold small">subst: repl for: key </span><span class="small">| key1 i nskip result<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[nskip &larr; 0. key1 &larr; key◦1. result &larr; Stream default.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: self length do⦂</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">" the Boyer Slow string replacement "</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[nskip&gt;0⇒ [nskip &larr; nskip-1]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self◦i = key1⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self◦(i to: (self length min: i+key length-1)) = key⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[result append: repl. nskip &larr; key length-1]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">result next&larr; self◦i]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">result next&larr; self◦i]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑result contents]</span></div>
<div class="line left">
<span class="bold large"><br>Comparison</span></div>
<div class="line left">
<span class="bold small">- s </span><span class="small">| i c ldiff</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"Return a negative, zero, or positive integer as I compare &lt; = or &gt; s"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"The collation sequence is ascii with case differences ignored."</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(ldiff &larr; self length-s length) &lt; 0⇒ [self length] s length] do⦂ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(c&larr; UpperCase◦(self◦i + 1) -(UpperCase◦(s◦i + 1)))<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">≠0⇒ [⇑c]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ldiff]</span></div>
<div class="line left">
<span class="bold small">&lt; s<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"Return true iff I collate before s.  The collation sequence is ascii with case differences ignored."</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑(self compare: s) = 1]</span></div>
<div class="line left">
<span class="bold small">&gt; s<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"Return true iff I collate after s.  The collation sequence is ascii with case differences ignored."</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑(self compare: s) = 3]</span></div>
<div class="line left">
<span class="bold small">compare: s </span><span class="small">| i len lcomp u1 u2 [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">lcomp &larr; [self length &lt; (len &larr; s length)⇒ [len &larr; self length. 1]; =len⇒ [2] 3].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: len do⦂ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(u1 &larr; UpperCase◦(self◦i + 1)) = (u2 &larr; UpperCase◦(s◦i + 1))⇒ []<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">u1 &lt; u2⇒ [⇑1]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑3]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑lcomp]</span></div>
<div class="line left">
<span class="bold small">hash </span><span class="small">| l m<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[[(l&larr; m&larr; self length)≤2⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[l=2⇒[m&larr;3]; =1⇒[⇑((self◦1) land: 0177)*0152] ⇑052525]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> ⇑(self◦1)*060+(self◦(m-1)+l)]</span></div>
<div class="line left">
<span class="bold small">match: text </span><span class="small">| star pound pattern scanning p t back [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">star &larr; 052 "*".  pound &larr; 043 "#".<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pattern &larr; self asStream.  text &larr; text asStream.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">scanning &larr; false.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ true do⦂ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(p &larr; pattern next)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=star⇒ [pattern end⇒ [⇑true] scanning &larr; pattern position]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(t &larr; text next)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">≡false⇒ [⇑t≡p]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">p≡false⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">scanning⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">back &larr; scanning - pattern position.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pattern skip: back. text skip: back]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑false]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">UpperCase◦(t+1) = (UpperCase◦(p+1)) or⦂ p=pound⇒ []<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">scanning⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">back &larr; scanning - pattern position.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pattern skip: back. text skip: back+1]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑false]]</span></div>
<div class="line left">
<span class="bold small">systemRehash </span><span class="small">| dicts d left loop<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["change the meaning of hash for Strings"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">String understands:</span><span class="bold small"><br></span><span class="small">&rsquo;</span><span class="bold small">hash </span><span class="small">| l m<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[[(l&larr; m&larr; self length)≤2⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[l=2⇒[m&larr;3]; =1⇒[⇑((self◦1) land: 0177)*0152] ⇑052525]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> ⇑(self◦1)*060+(self◦(m-1)+l)]&rsquo;.<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"rehash the atom table"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> ↪a rehash.<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"rehash all dictionaries which have strings in them"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> dicts &larr; HashSet allInstances+Dictionary allInstances<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">+SymbolTable allInstances.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> for⦂ d from: dicts do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[left &larr; d objects asStream. loop &larr; left next.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> while⦂ loop do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[loop is: String⇒[d rehash. loop &larr; false]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> loop &larr; left next]]]</span></div>
<div class="line left">
<span class="bold large"><br>Conversion</span></div>
<div class="line left">
<span class="bold small">asBytes </span><span class="small">| s c<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[s &larr; Stream default.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ c from: self do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[s append: c base8; space]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑s contents]</span></div>
<div class="line left">
<span class="bold small">asDecimalDigits </span><span class="italic small">"Not asInteger, because the result may be a Float if it&rsquo;s too big"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">| strm sign c val<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[strm&larr; Stream new of: self.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">sign&larr; strm∢025.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">val&larr; [self length&gt;4⇒[0.0]0].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ c from: strm do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[c&lt;060 or: c&gt;071⇒[user notify: self + &rsquo; isn&rsquo;&rsquo;t a valid integer&rsquo;]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">val&larr; val*10+(c-060)]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">sign⇒[⇑val*¬1]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑val]</span></div>
<div class="line left">
<span class="bold small">asFileName </span><span class="small">[⇑dp0 checkName: self fixing: true]</span></div>
<div class="line left">
<span class="bold small">asFloat </span><span class="small">| strm int frac exp<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[strm&larr; Stream new of: self.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">int&larr; strm upto: 056.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">frac&larr; strm upto: 0145.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">exp&larr; strm rest asInteger - frac length.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">int&larr; (int concat: frac) asDecimalDigits asFloat.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">exp=0⇒[⇑int];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">&gt;0⇒[⇑int*(10.0 ipow: exp)].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑int/(10.0 ipow: 0-exp)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">asInteger </span><span class="small">| strm sign base maxdigit c val<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[strm&larr; Stream new of: self.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">sign&larr; [strm∢025⇒[¬1]1].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">base&larr; [strm∢060⇒[8]10]. maxdigit&larr; 060+base.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">val&larr; 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ c from: strm do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[c&lt;060 or: c≥maxdigit⇒[user notify: self + &rsquo; isn&rsquo;&rsquo;t a valid Integer&rsquo;]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">val&larr; val*base+(c-060)]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"Some special maneuvering to keep 01ddddd and ¬32768 (and nothing else) from overflowing."</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[val&gt;077777⇒[base=8⇒[sign=1⇒[val&lt;65536⇒[⇑val asSmall]]]]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑(val*sign) asInteger]</span></div>
<div class="line left">
<span class="bold small">asLarge </span><span class="small">"convert to a LargeInteger"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">| neg i large large10<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[[self◦1=025⇒[neg&larr;true] neg&larr;false].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> large &larr; 0 asLarge. large10 &larr; 10 asLarge.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> for⦂ i from: [neg⇒[2]1] to: self length do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[large &larr; (large*large10)+(self◦i-060)].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> neg⇒[⇑large negated] ⇑large]</span></div>
<div class="line left">
<span class="bold small">asParagraph<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑Paragraph new text: self alignment: 0]</span></div>
<div class="line left">
<span class="bold small">asUppercase </span><span class="small">| s c<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[s &larr; Stream default.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ c from: self do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[s next &larr; UpperCase◦(c+1)]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑s contents]</span></div>
<div class="line left">
<span class="bold small">asVector<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑self asStream asVector]</span></div>
<div class="line left">
<span class="bold small">base8: i  </span><span class="italic small">"word: i  in base 8 as a String"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑(self word: i) base8]</span></div>
<div class="line left">
<span class="bold small">hasBeenUniqued<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑↪a hasInterned: self]</span></div>
<div class="line left">
<span class="bold small">printon: strm </span><span class="small">| x</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"print inside string quotes"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[strm next&larr; 047.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ x from: self do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[strm next&larr; x.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">x=047⇒[strm next&larr; x]]</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"imbedded quotes get doubled"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">strm next&larr; 047]</span></div>
<div class="line left">
<span class="bold small">unique </span><span class="small">| u</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"copy and intern"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑↪a intern: self]</span></div>
<div class="line left">
<span class="bold large"><br>Compatibility</span></div>
<div class="line left">
<span class="bold small">species<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑String]</span></div>
<div class="line left">
<span class="bold large"><br>System primitives</span></div>
<div class="line left">
<span class="bold small">lock </span><span class="small">[] primitive: 31</span></div>
<div class="line left">
<span class="bold small">unlock </span><span class="small">[] primitive: 32</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪String under: &rsquo;Basic Data Structures&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"Substring"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;Substring&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: Array<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;data map&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;&rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>I am an array that consists of a set of elements (specified by map) of an array (data)</span></div>
<div class="line left">
<span class="bold large"><br>Initialization</span></div>
<div class="line left">
<span class="bold small">data: data map: map</span></div>
<div class="line left">
<span class="bold large"><br>Reading and Writing</span></div>
<div class="line left">
<span class="bold small">◦ x<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑data◦(map◦x)]</span></div>
<div class="line left">
<span class="bold small">◦ x &larr; val<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑data◦(map◦x) &larr; val]</span></div>
<div class="line left">
<span class="bold small">length<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑map length]</span></div>
<div class="line left">
<span class="bold small">map<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"Return my map."</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑map]</span></div>
<div class="line left">
<span class="bold large"><br>Copying and Altering</span></div>
<div class="line left">
<span class="bold small">swap: i with: j </span><span class="small">| t<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"By permuting my map (a writable Array), swap elements i and j."</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">t &larr; map◦i. map◦i &larr; map◦j. map◦j &larr; t.]</span></div>
<div class="line left">
<span class="bold large"><br>Conversion</span></div>
<div class="line left">
<span class="bold small">asStream<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[map isIntervalBy1⇒</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"direct stream for simple substrings"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑Stream new of: data from: map start to: map stop]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑Stream new of: self from: 1 to: map length]</span></div>
<div class="line left">
<span class="bold large"><br>Compatability</span></div>
<div class="line left">
<span class="bold small">species<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑data species]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪Substring under: &rsquo;Basic Data Structures&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"UniqueString"</span></div>
<div class="line left">
<span class="bold large">VariableLengthClass new title: &rsquo;UniqueString&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: String<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;&rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">bytesize: 8;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>I am a string that is unequal to every other instance of my subclass</span></div>
<div class="line left">
<span class="bold large"><br>Initialization</span></div>
<div class="line left">
<span class="bold small">classInit </span><span class="small">| i a v</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"make up table of 1-char atoms"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[v &larr; Vector new: 128. a &larr; String new: 1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: 128 do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[a◦1 &larr; i-1. v◦i &larr; a unique]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">UST1 &larr; v]</span></div>
<div class="line left">
<span class="bold small">hasInterned: s </span><span class="small">| h i v n<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"⇑false if String s hasnt been interned, else ⇑s unique"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[s length=1⇒[s◦1&lt;128⇒[⇑UST1◦(s◦1+1)]]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">h&larr; s hash.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">v &larr; USTable◦(h\USTable length+1).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">i&larr; h\v length+1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ n to: v length do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[v◦i≡nil⇒</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑false]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[s length=(v◦i) length⇒ [s=(v◦i)⇒[⇑v◦i]]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">i&larr; [i=v length⇒[1] i+1]]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user notify: &rsquo;USTable is jammed&rsquo;]</span></div>
<div class="line left">
<span class="bold small">intern: s </span><span class="small">| h i j v n</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[s length=1⇒[s◦1&lt;128⇒[⇑UST1◦(s◦1+1)]]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">h&larr; [s is: String⇒[s hash] s stringhash].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">v &larr; USTable◦(h\USTable length+1).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">i&larr; h\v length+1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ n to: v length do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[v◦i≡nil⇒</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"empty slot"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[n&larr; ¬4.  for⦂ j from: v do⦂ [j≡nil⇒ [n &larr; n+4]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">n &lt; v length⇒</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"grow bucket if &gt; 3/4 full"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[USTable◦(h\USTable length+1) &larr; Vector new: 2*v length.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ n from: v do⦂</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"rehash all its contents"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[n≡nil⇒ [] self intern: n]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑self intern: s]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑v◦i &larr; [s is: UniqueString⇒[s]</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"install new entry"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(UniqueString new: s length) str: s]]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[s length=(v◦i) length⇒ [s=(v◦i)⇒[⇑v◦i]]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">i&larr; [i=v length⇒[1] i+1]]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user notify: &rsquo;USTable is jammed&rsquo;]</span></div>
<div class="line left">
<span class="bold small">rehash </span><span class="small">| oldTable v i<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[oldTable &larr; USTable.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> USTable &larr; Vector new: oldTable length.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> for⦂ i to: USTable length do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[USTable◦i &larr; Vector new: 4].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> for⦂ v from: oldTable do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[for⦂ i from: v do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[i≡nil⇒[] self intern: i]]]</span></div>
<div class="line left">
<span class="bold small">str: s </span><span class="small">| j<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[for⦂ j to: s length do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[super◦j &larr; s◦j]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑self]</span></div>
<div class="line left">
<span class="bold small">unique</span></div>
<div class="line left">
<span class="bold large"><br>Reading and Writing</span></div>
<div class="line left">
<span class="bold small">◦x &larr; val<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[user notify: &rsquo;UniqueStrings are not for writing into&rsquo;]</span></div>
<div class="line left">
<span class="bold large"><br>Selectors</span></div>
<div class="line left">
<span class="bold small">isarrow</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold small"> </span><span class="italic small">"ends with &larr;"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self length≤1⇒ [⇑false]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑self◦self length=95]</span></div>
<div class="line left">
<span class="bold small">isinfix </span><span class="small">| x<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self length≠1⇒ [⇑false]  ⇑(self◦1) isletter≡false]</span></div>
<div class="line left">
<span class="bold small">iskeyword </span><span class="small">| x</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"ends with colon"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self length≤1⇒ [⇑false]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">x &larr; self◦self length.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">x=072⇒[⇑true] ⇑x=03]</span></div>
<div class="line left">
<span class="bold small">isuneval </span><span class="small">| x</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"ends with open colon"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑self◦self length=03]</span></div>
<div class="line left">
<span class="bold small">keywords  </span><span class="small">"</span><span class="italic small">return a vector of the keywords that compose me</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">| result strm i l char colon ocolon<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[&rsquo;◦&larr;&rsquo;=self⇒[⇑↪(&rsquo;◦&rsquo; &rsquo;&larr;&rsquo;)]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">result&larr;(Vector new: 10) asStream.  strm&larr;Stream default.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">colon&larr;&rsquo;:&rsquo;◦1.  ocolon&larr;&rsquo;⦂&rsquo;◦1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">i&larr;1.  l&larr;self length.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ i≤l do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[char&larr;self◦i.  strm append: char.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> [(char=colon or⦂ char=ocolon) or⦂ i=l⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[result next&larr; strm contents.  strm reset]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">i&larr;i+1].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑result contents]</span></div>
<div class="line left">
<span class="bold small">mustTake: nargs </span><span class="italic small">"fatal error if I am not a selector that takes nargs arguments"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self numArgs≠nargs⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[user notify: self + &rsquo; does not take &rsquo; + nargs asString + &rsquo; arguments&rsquo;]]</span></div>
<div class="line left">
<span class="bold small">numArgs  </span><span class="small">| len n i </span><span class="italic small">"the number of arguments I take when I am a selector"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[len &larr; self length.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">len=1⇒ [⇑[(self◦1) isletter⇒ [0] 1]]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">n &larr; 0. </span><span class="italic small">"count colons, dots, and arrows"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: len do⦂ [self◦i=072⇒ [n&larr;n+1]; =03⇒ [n&larr;n+1]; =0137⇒[n&larr;n+1]; =07⇒[n&larr;n+1]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑n]</span></div>
<div class="line left">
<span class="bold large"><br>Comparison</span></div>
<div class="line left">
<span class="bold small">= x </span><span class="small">[⇑self≡x]</span></div>
<div class="line left">
<span class="bold small">hash </span><span class="small">[] primitive: 46</span></div>
<div class="line left">
<span class="bold small">stringhash<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑super hash]</span></div>
<div class="line left">
<span class="bold large"><br>Compatibility</span></div>
<div class="line left">
<span class="bold small">copy </span><span class="small">[⇑self]</span></div>
<div class="line left">
<span class="bold small">recopy </span><span class="small">[⇑self]</span></div>
<div class="line left">
<span class="bold small">species<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑String]</span></div>
<div class="line left">
<span class="bold large"><br>Conversion</span></div>
<div class="line left">
<span class="bold small">asString<br></span><span class="small">[⇑super copy]</span></div>
<div class="line left">
<span class="bold small">printon: strm<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[strm append: self]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪UniqueString under: &rsquo;Basic Data Structures&rsquo;.</span></div>
<div class="line left">
<span class="small">UniqueString classInit</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"Vector"</span></div>
<div class="line left">
<span class="bold large">VariableLengthClass new title: &rsquo;Vector&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: Array<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;&rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>Vector is a VariableLengthClass.  The length of a Vector may not be less than 0,<br>nor may it be greater than 8196.  <br>A field of a Vector may contain any other object.<br>A new Vector contains nil in every field.  <br>To create a new Vector of length 8, say:<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">Vector new: 8<br><br>Microcode Primitives<br>◦ x   "subscript"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">[0 &gt; x or: x &gt; self length ⇒[user notify: &rsquo;Subscript out of bounds&rsquo;]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">x class ≡ Integer ⇒[Return the xth element of the Vector]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">⇑ super ◦ x]<br>◦ x &larr; val  "assign value to element"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">[0 &gt; x or: x &gt; self length ⇒[user notify: &rsquo;Subscript out of bounds&rsquo;]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">x class ≡ Integer ⇒[Store the value val as the xth element. ⇑val]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">⇑ super ◦ x &larr; val]</span></div>
<div class="line left">
<span class="bold large"><br>Reading and Writing</span></div>
<div class="line left">
<span class="bold small">length </span><span class="italic small">"This is actually done in microcode"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑self length </span><span class="italic small">"perform: needs this"</span><span class="small">]</span></div>
<div class="line left">
<span class="bold large"><br>Copying and Altering</span></div>
<div class="line left">
<span class="bold small">, x </span><span class="small">| v<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[v &larr; self growby: 1.</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"use a stream if youre in a hurry"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">v last &larr; x. ⇑v]</span></div>
<div class="line left">
<span class="bold large"><br>Searching</span></div>
<div class="line left">
<span class="bold small">max</span><span class="small">| biggest i<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[biggest &larr; self◦1.</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"return largest value in a vector"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: self length do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[(self◦i) &gt; biggest ⇒[biggest &larr; self◦i]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> ⇑biggest]</span></div>
<div class="line left">
<span class="bold large"><br>Conversion</span></div>
<div class="line left">
<span class="bold small">asVector</span></div>
<div class="line left">
<span class="bold small">printon: strm </span><span class="small">| i<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[strm append: &rsquo;(&rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: self length do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[strm print: self◦i; space]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">strm append: &rsquo;)&rsquo; ]</span></div>
<div class="line left">
<span class="bold large"><br>System primitives</span></div>
<div class="line left">
<span class="bold small">nail </span><span class="small">[user croak] primitive: 31</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"Nail me in core and return my core address"</span></div>
<div class="line left">
<span class="bold small">unNail </span><span class="small">[user croak] primitive: 32</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"Release me from being nailed"</span></div>
<div class="line left">
<span class="bold large"><br>Compiler argument list</span></div>
<div class="line left">
<span class="bold small">argsOff: stack<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[stack pop: self length]</span></div>
<div class="line left">
<span class="bold small">emitForValue: code on: stack  </span><span class="small">| x<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[for⦂ x from: self do⦂ [x emitForValue: code on: stack]]</span></div>
<div class="line left">
<span class="bold small">firstPush<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑(self◦1) firstPush]</span></div>
<div class="line left">
<span class="bold small">remote: generator  </span><span class="small">| x<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[for⦂ x from: self do⦂ [x remote: generator]]</span></div>
<div class="line left">
<span class="bold small">sizeForValue  </span><span class="small">| size x<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[size &larr; 0. for⦂ x from: self do⦂ [size &larr; size+ x sizeForValue]. ⇑size]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪Vector under: &rsquo;Basic Data Structures&rsquo;.</span></div>
    <div class="line left">
<span class="small">&rsquo;From Smalltalk 5.5k XM November 24 on 22 November 1980 at 2:57:08 am.&rsquo;<br></span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large">"ClassOrganizer"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;ClassOrganizer&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: Object<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;globalComment commentVector groupVector&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;default &rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>ClassOrganizers contain the formatting information for printing classes.  Each String in commentVector describes a category comprising the messages contained in the Vector which is the corresponding entry in groupVector.</span></div>
<div class="line left">
<span class="bold large"><br>Initialization</span></div>
<div class="line left">
<span class="bold small">classInit<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[default &larr; &rsquo;As yet unclassified&rsquo;]</span></div>
<div class="line left">
<span class="bold small">init: sortedVec<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self globalComment &larr; &rsquo;This class has not yet been commented&rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">commentVector &larr; &rsquo;As yet unclassified&rsquo; inVector.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">groupVector &larr; sortedVec inVector]</span></div>
<div class="line left">
<span class="bold large"><br>Access to parts</span></div>
<div class="line left">
<span class="bold small">asStream </span><span class="small">| v t<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[v &larr; Stream new of: (Vector new: 200).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ t from: groupVector do⦂ [v append: t].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑v contents asStream]</span></div>
<div class="line left">
<span class="bold small">categories </span><span class="small">[⇑commentVector]</span></div>
<div class="line left">
<span class="bold small">category: str </span><span class="small">| i<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[i &larr; commentVector find: str.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">i=0⇒[user notify: &rsquo;No such category: &rsquo;+str]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑groupVector◦i]</span></div>
<div class="line left">
<span class="bold small">classify: selector under: heading </span><span class="small">| s h n<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[selector is: Vector⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[for⦂ s from: selector do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self classify: s under: heading]]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s &larr; commentVector find: heading.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s&gt;0 and⦂ (groupVector◦s has: selector)⇒[⇑self]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[h &larr; self invert: selector⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[heading=default⇒[⇑self]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> </span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> n &larr; commentVector find: h.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> groupVector◦n &larr; groupVector◦n delete: selector]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[s=0⇒ [s &larr; self insert: heading]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">groupVector◦s &larr; groupVector◦s insertSorted: selector.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">n &larr; commentVector find: default.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">n&gt;0 and⦂ (groupVector◦n) length=0⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self deleteCategory: n]]</span></div>
<div class="line left">
<span class="bold small">delete: selector </span><span class="small">| i</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"delete this from all categories"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[for⦂ i to: groupVector length do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[groupVector◦i has: selector⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[groupVector◦i &larr; (groupVector◦i) delete: selector.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(groupVector◦i) length=0 and⦂ commentVector◦i=default⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self deleteCategory: i]]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]]</span></div>
<div class="line left">
<span class="bold small">deleteCategory: index<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[groupVector &larr; groupVector without: index.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">commentVector &larr; commentVector without: index]</span></div>
<div class="line left">
<span class="bold small">globalComment </span><span class="small">[⇑globalComment asParagraph text]</span></div>
<div class="line left">
<span class="bold small">globalCommentItself </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">used only by </span><span class="bold small">Class archiveOn:changesOnly:</span><span class="small">" ⇑globalComment]</span></div>
<div class="line left">
<span class="bold small">globalComment &larr; globalComment </span><span class="small">"</span><span class="italic small">String or RemoteParagraph</span><span class="small">"</span></div>
<div class="line left">
<span class="bold small">has: sel </span><span class="small">| t<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[for⦂ t from: groupVector do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[t has: sel⇒[⇑true]]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑false]</span></div>
<div class="line left">
<span class="bold small">insert: heading </span><span class="small">| di dgroup hi  </span><span class="italic small">"force default category to end, delete if empty"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[[(di&larr;commentVector find: default)&gt;0⇒ [dgroup &larr; groupVector◦di]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">commentVector &larr; (commentVector without: di), heading.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">groupVector &larr; (groupVector without: di), (Vector new: 0).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">hi &larr; commentVector length.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">di=0 or⦂ dgroup length=0⇒ [⇑hi]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">commentVector &larr; commentVector, default.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">groupVector &larr; groupVector, dgroup.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑hi]</span></div>
<div class="line left">
<span class="bold small">invert: selector </span><span class="small">| i<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[for⦂ i to: groupVector length do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[groupVector◦i has: selector⇒[⇑commentVector◦i]]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑false]</span></div>
<div class="line left">
<span class="bold large"><br>Conversion to text</span></div>
<div class="line left">
<span class="bold small">asParagraph </span><span class="small">| s i<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[s &larr; Stream default.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s print: self globalComment.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: commentVector length do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[s cr; print: ((commentVector◦i) inVector concat: groupVector◦i)]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑s contents asParagraph]</span></div>
<div class="line left">
<span class="bold small">fromParagraph: para </span><span class="small">| t i j g<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[user displayoffwhile⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[t &larr; para asVector.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self globalComment &larr; t◦1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">commentVector &larr; Vector new: t length-1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">groupVector &larr; Vector new: t length-1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: t length-1 do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[g &larr; t◦(i+1).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">commentVector◦i &larr; g◦1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">until⦂ 0=(j&larr; g find: ↪&larr;) do⦂</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"reconstitute &larr; suffixes"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[g &larr; g replace: j-1 to: j by: (g◦(j-1)+&rsquo;&larr;&rsquo;) unique inVector]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">groupVector◦i &larr; (g copy: 2 to: g length) sort]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪ClassOrganizer under: &rsquo;Sets and Dictionaries&rsquo;.</span></div>
<div class="line left">
<span class="small">ClassOrganizer classInit</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"Dict"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;Dict&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: Object<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;&rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>a model for dictionary-index classes</span></div>
<div class="line left">
<span class="bold large"><br>Initialize</span></div>
<div class="line left">
<span class="bold small">init: initialSize </span><span class="small">"</span><span class="italic small">default is to ignore</span><span class="small">"</span></div>
<div class="line left">
<span class="bold large"><br>Name-Value Access</span></div>
<div class="line left">
<span class="bold small">◦ name </span><span class="small">| entry ["</span><span class="italic small">find</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">entry &larr; self find: name⇒ [⇑entry value]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑false]</span></div>
<div class="line left">
<span class="bold small">◦ name &larr; value </span><span class="small">[ "</span><span class="italic small">replace or insert</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑self write: (self newEntry name: name value: value)]</span></div>
<div class="line left">
<span class="bold small">insert: name with: value </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑self insert: (self newEntry name: name value: value)]</span></div>
<div class="line left">
<span class="bold small">lookup: name </span><span class="small">[⇑self◦name]</span></div>
<div class="line left">
<span class="bold small">replace: name with: value </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑self replace: (self newEntry name: name value: value)]</span></div>
<div class="line left">
<span class="bold large"><br>Entry Access</span></div>
<div class="line left">
<span class="bold small">contents </span><span class="small">[⇑self match: &rsquo;*&rsquo;]</span></div>
<div class="line left">
<span class="bold small">create: entry </span><span class="small">[⇑self insert: entry]</span></div>
<div class="line left">
<span class="bold small">delete: entry </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self Find: (entry &larr; self makeEntry: entry)⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self Delete: entry.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑entry]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑self error: &rsquo;not deleted (not found)&rsquo; entry: entry]</span></div>
<div class="line left">
<span class="bold small">exists: entry </span><span class="small">["</span><span class="italic small">doesn&rsquo;t initialize too much</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑self Find: (self makeEntry: entry)]</span></div>
<div class="line left">
<span class="bold small">find: entry </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self Find: (entry &larr; self makeEntry: entry)⇒ [⇑self found: entry]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑self error: &rsquo;not found&rsquo; entry: entry]</span></div>
<div class="line left">
<span class="bold small">found: entry </span><span class="small">["</span><span class="italic small">found, fill it in from dictionary</span><span class="small">" ⇑self nextEntry: entry]</span></div>
<div class="line left">
<span class="bold small">get: entry </span><span class="small">["</span><span class="italic small">find or insert</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self Find: (entry &larr; self makeEntry: entry)⇒ [⇑self found: entry]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self Insert: entry.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑entry]</span></div>
<div class="line left">
<span class="bold small">insert: entry </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self Find: (entry &larr; self makeEntry: entry)⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑self error: &rsquo;not inserted (already found)&rsquo; entry: entry]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self Insert: entry.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑entry]</span></div>
<div class="line left">
<span class="bold small">list </span><span class="small">[self list: &rsquo;*&rsquo;]</span></div>
<div class="line left">
<span class="bold small">list: entries </span><span class="small">[self match: entries to: user]</span></div>
<div class="line left">
<span class="bold small">match: entries </span><span class="small">| set [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">set &larr; Set new vector: 50.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self match: entries to: set.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑set contents]</span></div>
<div class="line left">
<span class="bold small">match: entries to: strm </span><span class="small">| entry nentries [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">return a Set of entries which match those in entries<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">(can include exact values and patterns and ranges)</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[(entries is: Vector) or⦂ (entries Is: Set)⇒ [] entries &larr; entries inVector].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nentries &larr; Set new vector: entries length.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ entry from: entries do⦂ [nentries next &larr; self makeEntry: entry].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑self Match: nentries to: strm]</span></div>
<div class="line left">
<span class="bold small">read: entry </span><span class="small">[⇑self find: entry]</span></div>
<div class="line left">
<span class="bold small">rename: entry newName: name </span><span class="small">| nentry ["not tested"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self Find: (nentry &larr; self makeEntry: name)⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑self error: &rsquo;already exists&rsquo; error: nentry]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self Find: (entry &larr; self makeEntry: entry)⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self Rename: entry from: nentry.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑entry]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑self error: &rsquo;not found&rsquo; entry: entry]</span></div>
<div class="line left">
<span class="bold small">replace: entry </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self Find: (entry &larr; self makeEntry: entry)⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self Replace: entry.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑entry]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑self error: &rsquo;not replaced (not found)&rsquo; entry: entry]</span></div>
<div class="line left">
<span class="bold small">retrieve: entry </span><span class="small">[⇑self find: entry "match:?"]</span></div>
<div class="line left">
<span class="bold small">store: entry </span><span class="small">[⇑self write: entry]</span></div>
<div class="line left">
<span class="bold small">write: entry </span><span class="small">["</span><span class="italic small">replace or insert</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self Find: (entry &larr; self makeEntry: entry)⇒ [self Replace: entry]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self Insert: entry].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑entry]</span></div>
<div class="line left">
<span class="bold large"><br>Stream Access</span></div>
<div class="line left">
<span class="bold small">append: dict </span><span class="small">| entry [for⦂ entry from: dict do⦂ [self write: entry]]</span></div>
<div class="line left">
<span class="bold small">asStream </span><span class="small">"</span><span class="italic small">leave position where it is</span><span class="small">"</span></div>
<div class="line left">
<span class="bold small">next </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">return next entry or false</span><span class="small">" <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑self nextEntry: self newEntry]</span></div>
<div class="line left">
<span class="bold small">position </span><span class="small">["</span><span class="italic small">current position (name)</span><span class="small">" self subError]</span></div>
<div class="line left">
<span class="bold small">position &larr; name </span><span class="small">[⇑self Position &larr; self makeEntry: name]</span></div>
<div class="line left">
<span class="bold small">Position &larr; entry </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">position to name, or position to insert place and return false if not found.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">subclass had better define position&larr; or Position&larr; (preferably)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">otherwise circularity results!!!</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑self position &larr; entry name]</span></div>
<div class="line left">
<span class="bold small">reset </span><span class="small">["</span><span class="italic small">position to beginning</span><span class="small">" self subError]</span></div>
<div class="line left">
<span class="bold large"><br>Entry Creation</span></div>
<div class="line left">
<span class="bold small">entryClass </span><span class="small">["</span><span class="italic small">a subclass of DictionaryEntry</span><span class="small">" self subError]</span></div>
<div class="line left">
<span class="bold small">makeEntry: entry </span><span class="small">"</span><span class="italic small">entry or name</span><span class="small">" | cl [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">cl &larr; self entryClass.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">cl≡false or⦂ (entry Is: cl)⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"entry should not be converted or is the correct type" ⇑entry]<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"convert entry from a name to an entry with that name"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑self newEntry name: entry]</span></div>
<div class="line left">
<span class="bold small">newEntry </span><span class="small">[⇑[(self entryClass new) dictionary: self; init]]</span></div>
<div class="line left">
<span class="bold small">nextEntry: entry </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">return next name and value in entry, or false.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">if insert or delete occurs after previous next, may be problem</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑entry]</span></div>
<div class="line left">
<span class="bold large"><br>Entry Operations</span></div>
<div class="line left">
<span class="bold small">Delete: entry </span><span class="small">["</span><span class="italic small">entry found (next), delete it</span><span class="small">" self subError]</span></div>
<div class="line left">
<span class="bold small">entrySize: entry </span><span class="small">["</span><span class="italic small">storage size of entry, constant or variable</span><span class="small">" self subError]</span></div>
<div class="line left">
<span class="bold small">error: e entry: entry </span><span class="small">["entry error: e" ⇑false]</span></div>
<div class="line left">
<span class="bold small">Find: entry </span><span class="small">["</span><span class="italic small">is entry in dictionary?</span><span class="small">" ⇑self Position &larr; entry]</span></div>
<div class="line left">
<span class="bold small">Insert: entry </span><span class="small">["</span><span class="italic small">entry not found, insert it (next)</span><span class="small">" self subError]</span></div>
<div class="line left">
<span class="bold small">Match: entries to: strm </span><span class="small">| entry pat ents [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">default (unordered) is to compare entire dictionary with entries</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self reset.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ entry from: self do⦂ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">ents &larr; entries asStream.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ (ents and⦂ (pat &larr; ents next)) do⦂ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pat match: entry⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">ents &larr; false.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">strm next &larr; entry<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]]]</span></div>
<div class="line left">
<span class="bold small">Rename: entry from: nentry </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self Delete: entry; Insert: (entry name: nentry name)]</span></div>
<div class="line left">
<span class="bold small">Replace: entry </span><span class="small">["</span><span class="italic small">entry found (next), replace it&rsquo;s value</span><span class="small">" self subError]</span></div>
<div class="line left">
<span class="bold large"><br>File-Based dictionary</span></div>
<div class="line left">
<span class="bold small">close </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self obsolete⇒ []<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">possible cleanup before a release</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self file⇒ [self file close]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self release]</span></div>
<div class="line left">
<span class="bold small">file </span><span class="small">["</span><span class="italic small">return my file</span><span class="small">" ⇑false]</span></div>
<div class="line left">
<span class="bold small">obsolete </span><span class="small">["</span><span class="italic small">is my information obsolete (should I regenerate it)?</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self file⇒ [⇑self file obsolete]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑false]</span></div>
<div class="line left">
<span class="bold small">open</span></div>
<div class="line left">
<span class="bold small">release </span><span class="small">"</span><span class="italic small">obsolete and deallocate storage, especially if connected to an external view,<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">e.g. a File</span><span class="small">" [self file⇒ [self file release]]</span></div>
<div class="line left">
<span class="bold small">reopen </span><span class="small">["</span><span class="italic small">reinitialize, especially if a File is involved</span><span class="small">" self open]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪Dict under: &rsquo;Sets and Dictionaries&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"DictionaryEntry"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;DictionaryEntry&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: Object<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;&rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>a model for entries --what to retrieve with and store in dictionaries</span></div>
<div class="line left">
<span class="bold large"><br>Initialize</span></div>
<div class="line left">
<span class="bold small">dictionary: dict</span></div>
<div class="line left">
<span class="bold small">init</span></div>
<div class="line left">
<span class="bold small">name: name</span></div>
<div class="line left">
<span class="bold large"><br>Other</span></div>
<div class="line left">
<span class="bold small">dictionary </span><span class="small">["</span><span class="italic small">what dictionary did I come from?</span><span class="small">" ⇑false]</span></div>
<div class="line left">
<span class="bold small">match: entry </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">does self (some kind of pattern) match entry?</span><span class="small">" self subError] </span></div>
<div class="line left">
<span class="bold large"><br>Filing</span></div>
<div class="line left">
<span class="bold small">fileSize </span><span class="small">["</span><span class="italic small">size in characters for filing</span><span class="small">" self subError]</span></div>
<div class="line left">
<span class="bold small">readFrom: file </span><span class="small">["</span><span class="italic small">inverse of </span><span class="bold small">storeOn:</span><span class="small">" self subError]</span></div>
<div class="line left">
<span class="bold small">storeOn: file </span><span class="small">["store </span><span class="bold small">self</span><span class="small"> as </span><span class="bold small">fileSize</span><span class="small"> characters on </span><span class="bold small">file</span><span class="small">" self subError]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪DictionaryEntry under: &rsquo;Sets and Dictionaries&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"HashSet"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;HashSet&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: Object<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;objects&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;&rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>HashSets are pure sets of objects with no associated values.  However, since they allow callers to determine the location of objects in the hash table, subclasses such as Dictionary and MessageDict can provide parallel tables to hold values.  Such subclasses must intercept growto: and reorder their own tables then.</span></div>
<div class="line left">
<span class="bold large"><br>Initialization</span></div>
<div class="line left">
<span class="bold small">copy </span><span class="italic small">"⇑ a copy of me"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑self class new copyfrom: self]</span></div>
<div class="line left">
<span class="bold small">copyfrom: hset </span><span class="italic small">"take on state of hset"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[objects &larr; hset objects copy]</span></div>
<div class="line left">
<span class="bold small">init<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self init: 4]</span></div>
<div class="line left">
<span class="bold small">init: size<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[objects &larr; Vector new: (size max: 2)]</span></div>
<div class="line left">
<span class="bold large"><br>Access to parts</span></div>
<div class="line left">
<span class="bold small">asStream<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑self contents asStream]</span></div>
<div class="line left">
<span class="bold small">contents </span><span class="small">| obj strm<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[strm &larr; (Vector new: objects length) asStream.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ obj from: objects do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[obj≡nil⇒[] strm next&larr; obj]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑strm contents]</span></div>
<div class="line left">
<span class="bold small">size </span><span class="small">[⇑objects length]</span></div>
<div class="line left">
<span class="bold large"><br>Searching</span></div>
<div class="line left">
<span class="bold small">find: obj </span><span class="small">| i</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"⇑index if found, else false"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[i &larr; self findornil: obj.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">objects◦i=obj⇒[⇑i] ⇑false]</span></div>
<div class="line left">
<span class="bold small">findorerror: name </span><span class="small">| i<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[i &larr; self findornil: name.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">objects◦i=name⇒ [⇑i]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"allow the user to put a correct value into i"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user notify: name asString+&rsquo; cannot be found&rsquo;. ⇑i]</span></div>
<div class="line left">
<span class="bold small">has: obj<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑objects◦(self findornil: obj)=obj]</span></div>
<div class="line left">
<span class="bold large"><br>Insertion and deletion</span></div>
<div class="line left">
<span class="bold small">delete: obj </span><span class="small">| i j l<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[obj is: Vector⇒[for⦂ i from: obj do⦂ [self delete: i]]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">i&larr; self findorerror: obj.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">objects◦i&larr; nil.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">l&larr; objects length.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">until⦂ objects◦(i&larr; [i=l⇒[1] i+1])≡nil do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[i=(j&larr; self findornil: objects◦i)⇒[]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self swap: i with: j]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">insert: obj </span><span class="small">| i<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self findorinsert: obj. ⇑obj]</span></div>
<div class="line left">
<span class="bold small">insertall: objs </span><span class="small">| x<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[for⦂ x from: objs do⦂ [self insert: x]]</span></div>
<div class="line left">
<span class="bold large"><br>Growing and shrinking</span></div>
<div class="line left">
<span class="bold small">packprobes </span><span class="small">| tot n l i obj t</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"⇑(fullness, avg #probes)"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[tot &larr; n &larr; 0. l &larr; objects length.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: l do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[(obj&larr; objects◦i)≡nil⇒[]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">t &larr; obj hash \ l.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">tot &larr; tot + [i &lt; t⇒ [l - t + i] i - t].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">n&larr; n+1]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">n=0⇒[⇑(1,1)]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑((n asFloat/l) , (tot asFloat/n))]<br></span><span class="italic small">"Class md packprobes(0.4921875 2.53968255 )"</span></div>
<div class="line left">
<span class="bold small">shrink </span><span class="small">| table oldtable<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[oldtable &larr; self.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">table &larr; oldtable growto: (2 max: oldtable size/2).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">until⦂ table size=oldtable size do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[(oldtable size-table size) print.  user show: &rsquo; &rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">oldtable &larr; table.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">table &larr; oldtable growto: (2 max: oldtable size/2)]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑table]</span></div>
<div class="line left">
<span class="bold large"><br>Private</span></div>
<div class="line left">
<span class="bold small">findorinsert: obj </span><span class="small">| i</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"insert if not found, "</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[i &larr; self findornil: obj.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">objects◦i=obj⇒[⇑i]  </span><span class="italic small">"found it"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self sparse⇒[objects◦i &larr; obj. ⇑i]  </span><span class="italic small">"insert if room"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self growto: objects length*2.</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"grow"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑self findorinsert: obj </span><span class="italic small">"and insert"</span><span class="small">]</span></div>
<div class="line left">
<span class="bold small">findornil: obj </span><span class="small">| i loc</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"⇑index if found or available slot"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[loc &larr; obj hash\objects length.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: objects length do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[loc &larr; [loc=objects length⇒[1] loc+1].</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">objects◦loc ≡ nil⇒ [⇑loc]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">objects◦loc = obj⇒ [⇑loc]]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑1 </span><span class="italic small">"table full - caller must check for hit"</span><span class="small">]</span></div>
<div class="line left">
<span class="bold small">growto: t1 </span><span class="small">| t2 t3  "faster insert for growing"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[t2 &larr; self class new init: t1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[t1 &lt; objects length ⇒[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ t3 from: self do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[t2 insert: t3]]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ t3 from: self do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[t2 rawinsert: t3]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">objects &larr; t2 objects]</span></div>
<div class="line left">
<span class="bold small">objects </span><span class="small">[⇑objects]</span></div>
<div class="line left">
<span class="bold small">objects&larr; objects</span></div>
<div class="line left">
<span class="bold small">rawinsert: t1 </span><span class="small">| t2 "assumes there </span><span class="bold small">is</span><span class="small"> room for the new one"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[t2 &larr; self findornil: t1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">objects ◦ t2 &larr; t1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑t2]</span></div>
<div class="line left">
<span class="bold small">rehash </span><span class="small">| i copy<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[copy &larr; HashSet new init: self size.</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"create a copy"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: objects length do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[objects◦i≡nil⇒[]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> copy insert: objects◦i]</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"hash each entry into it"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">objects &larr; copy objects]</span></div>
<div class="line left">
<span class="bold small">sparse </span><span class="small">| i n<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"⇑true if (1 max: 1/4 of table) is nil"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">n &larr; objects length.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: objects length do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[objects◦i≡nil⇒[(n&larr;n-4)≤0⇒[⇑true]]]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑false]</span></div>
<div class="line left">
<span class="bold small">swap: i with: j<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[objects swap: i with: j]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪HashSet under: &rsquo;Sets and Dictionaries&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"Dictionary"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;Dictionary&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: HashSet<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;values&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;&rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>Dictionaries are sets with associated values.  They are very handy but not terribly efficient.  Most of their work is done by HashSet.</span></div>
<div class="line left">
<span class="bold large"><br>Initialization</span></div>
<div class="line left">
<span class="bold small">copyfrom: dict<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self objects &larr; dict objects copy.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">values &larr; dict values copy]</span></div>
<div class="line left">
<span class="bold small">init: size<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[values &larr; Vector new: size. super init: size]</span></div>
<div class="line left">
<span class="bold large"><br>Searching</span></div>
<div class="line left">
<span class="bold small">◦ name<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑values◦(self findorerror: name)]</span></div>
<div class="line left">
<span class="bold small">◦ name &larr; val<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑values◦(self findorerror: name) &larr; val]</span></div>
<div class="line left">
<span class="bold small">lookup: name </span><span class="small">| x<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[x &larr; self find: name⇒ [⇑values◦x] ⇑false]</span></div>
<div class="line left">
<span class="bold large"><br>Inserting and Deleting</span></div>
<div class="line left">
<span class="bold small">clean </span><span class="small">| name</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"release unreferenced entries"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[for⦂ name from: self do⦂</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"slick, huh"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[(self◦name) refct = 1 ⇒ [self delete: name]]]</span></div>
<div class="line left">
<span class="bold small">delete: name<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[name is: Vector⇒[super delete: name]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">values◦(self findorerror: name)&larr; nil.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">super delete: name]</span></div>
<div class="line left">
<span class="bold small">insert: name with: value<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self insert: name.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">values◦(self findorerror: name) &larr; value]</span></div>
<div class="line left">
<span class="bold small">insertall: names</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"default value is nil"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self insertall: names with: (Vector new: names length)]</span></div>
<div class="line left">
<span class="bold small">insertall: names with: vals </span><span class="small">| i</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"insert many entries"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[for⦂ i to: names length do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self insert: names◦i with: vals◦i]]</span></div>
<div class="line left">
<span class="bold small">tally: name </span><span class="small">| x<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[x &larr; self find: name⇒ [⇑values◦x&larr; values◦x+1]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self insert: name with: 1. ⇑1]</span></div>
<div class="line left">
<span class="bold small">with: names values: vals </span><span class="small">| i<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[for⦂ i to: names length do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self insert: names◦i with: vals◦i]]</span></div>
<div class="line left">
<span class="bold large"><br>Private</span></div>
<div class="line left">
<span class="bold small">growto: size </span><span class="small">| name copy<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[copy &larr; self class new init: size.</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"create a copy of the new size"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ name from: self do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[copy insert: name with: self◦name]</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"hash each entry into it"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self copyfrom: copy]</span></div>
<div class="line left">
<span class="bold small">rehash </span><span class="small">| i copy<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[copy &larr; Dictionary new init: self size.</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"create a copy"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: objects length do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[objects◦i≡nil⇒[]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> copy insert: objects◦i with: values◦i]</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"hash each entry into it"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self copyfrom: copy]</span></div>
<div class="line left">
<span class="bold small">swap: i with: j<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[values swap: i with: j.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">super swap: i with: j]</span></div>
<div class="line left">
<span class="bold small">values </span><span class="small">[⇑values]</span></div>
<div class="line left">
<span class="bold large"><br>Inversion</span></div>
<div class="line left">
<span class="bold small">asInvertedVector </span><span class="small">| s i v  </span><span class="italic small">"in form ((value, object), ...)"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[s &larr; (Vector new: objects length) asStream.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: objects length do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[objects◦i≡nil⇒ []<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">v &larr; Vector new: 2. v◦1&larr;values◦i. v◦2&larr;objects◦i.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s next &larr; v].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑s contents]</span></div>
<div class="line left">
<span class="bold small">invert<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑self invertto: (Dictionary new init: objects length)]</span></div>
<div class="line left">
<span class="bold small">invert: obj </span><span class="small">| i<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[for⦂ i to: values length do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[values◦i=obj⇒ [⇑objects◦i]]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑false]</span></div>
<div class="line left">
<span class="bold small">invertto: dict </span><span class="small">| i<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[for⦂ i to: objects length do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[objects◦i≡nil⇒ []<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">dict insert: values◦i with: objects◦i].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑dict]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪Dictionary under: &rsquo;Sets and Dictionaries&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"MessageDict"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;MessageDict&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: HashSet<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;methods "&lt;Vector of Strings&gt; which are the compiled methods for each message"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">literals "&lt;Vector of Vectors&gt; which hold pointers to literals used in the methods"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">code "&lt;Vector of Strings&gt; which are the source text for each message"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">backpointers "&lt;Vector of Vectors&gt; which are the tables of text location vs pc for each message"&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;&rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>MessageDicts hold the source code and compiled methods for each message to a class.  The source code is a packed paragraph (see Paragraph packIntoString).  The methods contain pointers to literals, and must be specially freed.  If a method is being executed during its redefinition, its release must be delayed (its literals gets held in CodeKeeper).  Finally, MessageDicts must be copied to be grown, so that current use is not disturbed.</span></div>
<div class="line left">
<span class="bold large"><br>Initialization</span></div>
<div class="line left">
<span class="bold small">copyfrom: dict<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self objects &larr; dict objects copy.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">methods &larr; dict methods copy.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">code &larr; dict code copy]</span></div>
<div class="line left">
<span class="bold small">init: size<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[methods &larr; Vector new: size.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">code &larr; Vector new: size.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">super init: size]</span></div>
<div class="line left">
<span class="bold large"><br>Inserting and Deleting</span></div>
<div class="line left">
<span class="bold small">close </span><span class="small">| i</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"recycle all code and literals pointed to"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[for⦂ i to: methods length do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[methods◦i≡nil⇒[]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self freeMethod: methods◦i]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self init]</span></div>
<div class="line left">
<span class="bold small">delete: name </span><span class="small">| i<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[i &larr; self findorerror: name.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self freeMethod: methods◦i.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">methods◦i&larr; code◦i&larr; nil.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">super delete: name]</span></div>
<div class="line left">
<span class="bold small">insert: name method: m literals: l<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold small">code: c backpointers: b </span><span class="small">| i copy<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[i &larr; self find: name⇒</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"if name is already there"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self freeMethod: methods◦i.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self holdLiterals: l.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">methods◦i &larr; m. code◦i &larr; c]</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"then insert it, and return self"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">copy &larr; [self sparse⇒[self] <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self growto: methods length*2].</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"Otherwise, copy if necessary"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">copy objects◦(copy findornil: name) &larr; name.</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"and insert"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑copy insert: name method: m literals: l<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">code: c backpointers: b]</span></div>
<div class="line left">
<span class="bold small">purge: sel </span><span class="small">[</span><span class="italic small">"demand purging invalidates checkpointing"</span><span class="small">]</span></div>
<div class="line left">
<span class="bold large"><br>Access to parts</span></div>
<div class="line left">
<span class="bold small">code<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑code]</span></div>
<div class="line left">
<span class="bold small">code: name<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑code◦(self findorerror: name)]</span></div>
<div class="line left">
<span class="bold small">code: name &larr; str<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑code◦(self findorerror: name) &larr; str]</span></div>
<div class="line left">
<span class="bold small">invert: method </span><span class="small">| i<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[for⦂ i to: methods length do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[methods◦i≡method⇒ [⇑objects◦i]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑false]</span></div>
<div class="line left">
<span class="bold small">literals: name<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑self literalsIn: methods◦(self findorerror: name)]</span></div>
<div class="line left">
<span class="bold small">method: name<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑methods◦(self findorerror: name)]</span></div>
<div class="line left">
<span class="bold small">methodorfalse: name </span><span class="small">| i<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[i &larr; self find: name⇒[⇑methods◦i] ⇑false]</span></div>
<div class="line left">
<span class="bold small">methods<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑methods]</span></div>
<div class="line left">
<span class="bold large"><br>Code aspect of Strings</span></div>
<div class="line left">
<span class="bold small">freeLiterals: v </span><span class="small">| m i t</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"lower refct of all literals"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[v length=0⇒[]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">m &larr; v nail.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: v length do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[t &larr; mem◦(m+i-1). v◦i &larr; nil. mem◦(m+i-1) &larr; t]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">v unNail]</span></div>
<div class="line left">
<span class="bold small">freeMethod: m </span><span class="small">| v c i t</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"method pointed to by some vector (dict or keeper)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">and (upon entry) by m.  If any other owners, refct will be &gt;2.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">*Expects Interpreter to nil args on callers stack*"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[m refct&gt;2⇒[MethodKeeper next&larr; m]</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"keep it"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">v&larr; self literalsIn: m.</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"free its literals"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">v length=0⇒[]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">c &larr; v nail.</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"fasten seat belts"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: v length do⦂</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"lower refct of each literal"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[t &larr; mem◦(c+i-1). v◦i &larr; nil. mem◦(c+i-1) &larr; t]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">v unNail]</span></div>
<div class="line left">
<span class="bold small">freeMethods </span><span class="small">| v i</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"Free kept methods no longer used"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[v&larr; MethodKeeper contents.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">MethodKeeper&larr; (Vector new: 10) asStream.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: v length do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self freeMethod: v◦i]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">holdLiterals: v </span><span class="small">| m i t</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"raise refct of all literals"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[v≡nil⇒[] v length=0⇒[]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">m &larr; v nail.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: v length do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[t &larr; v◦i. mem◦(m+i-1) &larr; ¬1. v◦i &larr; t]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">v unNail]</span></div>
<div class="line left">
<span class="bold small">holdMethods: v </span><span class="small">| i </span><span class="italic small">"a random insertion just to make it legal form"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[for⦂ i to: v length do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self insert: i method: v◦i literals: nil code: nil backpointers: nil]]</span></div>
<div class="line left">
<span class="bold small">literalsIn: method </span><span class="small">| i v</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"return the literal vector imbedded in this method"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[method≡nil⇒[⇑Vector new: 0]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">method length&lt;8⇒[⇑Vector new: 0]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">method◦2=41⇒[⇑Vector new: 0]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">v &larr; Vector new: method◦6-6/2.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: v length do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[v◦i &larr; (method word: 3+i) asObject]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑v]</span></div>
<div class="line left">
<span class="bold large"><br>Private</span></div>
<div class="line left">
<span class="bold small">growto: size </span><span class="small">| name copy i<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[copy &larr; MessageDict new init: size.</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"create a copy of the new size"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ name from: self do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[i &larr; self findorerror: name.</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"hash each entry into it"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">copy &larr; copy insert: name method: methods◦i<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">literals: [literals≡nil⇒[nil] literals◦i]  code: code◦i backpointers: nil]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑copy]</span></div>
<div class="line left">
<span class="bold small">swap: i with: j<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[methods swap: i with: j.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">code swap: i with: j.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">super swap: i with: j]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪MessageDict under: &rsquo;Sets and Dictionaries&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"SymbolTable"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;SymbolTable&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: Dictionary<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;&rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>I associate each of my objects with an object reference</span></div>
<div class="line left">
<span class="bold large"><br>Access to parts</span></div>
<div class="line left">
<span class="bold small">ref: name<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑super◦name]</span></div>
<div class="line left">
<span class="bold small">ref: name &larr; val<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑super◦name &larr; val]</span></div>
<div class="line left">
<span class="bold large"><br>Searching</span></div>
<div class="line left">
<span class="bold small">◦ name<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑(super◦name) value]</span></div>
<div class="line left">
<span class="bold small">allCallsOn: selector from: classNames </span><span class="small">| className s w cl sel<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[[selector is: Vector⇒ [] selector &larr; selector inVector].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s &larr; Stream default.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user displayoffwhile⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[for⦂ className from: classNames do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[cl &larr; self◦className.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ sel from: selector do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[w &larr; cl whosends: sel. w length=0⇒ []<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s append: className; append: &rsquo;⇒&rsquo;; append: w asString; cr]]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑s contents]</span></div>
<div class="line left">
<span class="bold small">allRefs  </span><span class="italic small">"what methods reference my variables (I am probably &rsquo;Undeclared&rsquo;)"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑self allRefsTo: self contents from: user classNames]</span></div>
<div class="line left">
<span class="bold small">allRefsTo: symbol from: classNames </span><span class="small">| s<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[[symbol is: Vector⇒ [] symbol &larr; symbol inVector].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑Smalltalk allCallsOn: (symbol transform⦂ s to⦂ (self ref: s)) from: classNames]</span></div>
<div class="line left">
<span class="bold small">invert: obj </span><span class="small">| i<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[for⦂ i to: values length do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[nil≡(values◦i)⇒[]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">obj ≡ (values◦i) value ⇒[⇑objects◦i]]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑false]</span></div>
<div class="line left">
<span class="bold small">invertRef: obj </span><span class="small">| i<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[for⦂ i to: values length do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[obj≡(values◦i)⇒[⇑objects◦i]]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑false]</span></div>
<div class="line left">
<span class="bold small">lookup: name </span><span class="small">| r<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[r&larr;super lookup: name⇒[⇑r value] ⇑false]</span></div>
<div class="line left">
<span class="bold small">lookupRef: name<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑super lookup: name]</span></div>
<div class="line left">
<span class="bold large"><br>Insertion</span></div>
<div class="line left">
<span class="bold small">◦ name &larr; x<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑(super◦name) value &larr; x]</span></div>
<div class="line left">
<span class="bold small">declare: name</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"Take ref(s) and value(s) from Undeclared, if name(s) there"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self declare: name from: Undeclared]</span></div>
<div class="line left">
<span class="bold small">declare: name as: x </span><span class="small">| a s<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[name is: Vector⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[s &larr; x asStream. for⦂ a from: name do⦂ [self declare: a as: s next]]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self declare: name.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self◦name &larr; x]</span></div>
<div class="line left">
<span class="bold small">declare: name from: symTab </span><span class="small">| a </span><span class="italic small">"take name(s), ref(s) and value(s) from symTab"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[name is: Vector⇒ [for⦂ a from: name do⦂ [self declare: a from: symTab]]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self has: name⇒ []<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">symTab has: name⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[super insert: name with: (symTab ref: name).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">symTab delete: name]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self insert: name with: nil]</span></div>
<div class="line left">
<span class="bold small">define: name as: x</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"synonym"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑self declare: name as: x]</span></div>
<div class="line left">
<span class="bold small">insert: name with: x<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self has: name⇒[]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">super insert: name with: ObjectReference new].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self◦name &larr; x]</span></div>
<div class="line left">
<span class="bold small">insert: name withref: ref<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[super insert: name with: ref]</span></div>
<div class="line left">
<span class="bold large"><br>Growing and shrinking</span></div>
<div class="line left">
<span class="bold small">growto: size </span><span class="small">| name copy<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[copy &larr; self class new init: size.</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"create a copy of the new size"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ name from: self do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[copy insert: name withref: (self ref: name)]</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"hash each entry into it"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self copyfrom: copy]</span></div>
<div class="line left">
<span class="bold small">rehash </span><span class="small">| i copy<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[copy &larr; SymbolTable new init: self size.</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"create a copy"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: objects length do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[objects◦i≡nil⇒[]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> copy insert: objects◦i withref: values◦i]</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"hash each entry into it"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self copyfrom: copy]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪SymbolTable under: &rsquo;Sets and Dictionaries&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"SystemOrganizer"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;SystemOrganizer&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: ClassOrganizer<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;&rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>Provides an organization for the classes in the system just as ClassOrganizer organizes the messages within a class.  (In fact, the only difference is the filout/printing messages.)</span></div>
<div class="line left">
<span class="bold large"><br>Filout and printing</span></div>
<div class="line left">
<span class="bold small">filoutAll </span><span class="small">| cat<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[for⦂ cat from: commentVector do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self filoutCategory: cat]]</span></div>
<div class="line left">
<span class="bold small">filoutCategory: cat </span><span class="small">| all a [user displayoffwhile⦂ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">all &larr; self superclassOrder: cat.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(dp1 file: (cat+&rsquo;.st.&rsquo;) asFileName) filoutclass: all.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ a from: all do⦂ [(Smalltalk◦a) noChanges]]]</span></div>
<div class="line left">
<span class="bold small">printAll </span><span class="small">| cat<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[for⦂ cat from: commentVector do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self printCategory: cat]]</span></div>
<div class="line left">
<span class="bold small">printCategory: cat </span><span class="small">[user displayoffwhile⦂ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(dp0 file: (cat+&rsquo;.press&rsquo;) asFileName) printoutclass: (self superclassOrder: cat)]]</span></div>
<div class="line left">
<span class="bold small">superclassOrder: cat </span><span class="small">| all lis a i c sup  "Arrange classes in superclass order so they can be filed in"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[lis&larr; (self category: cat) copy. all &larr; (Vector new: lis length) asStream.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ lis length&gt;0 do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[i&larr; 1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">until⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[a&larr; lis◦i. sup&larr; c&larr; Smalltalk◦a.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">until⦂ "Make sure it doesn&rsquo;t have an as yet unprinted superclass"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[sup&larr; sup superclass.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">sup≡nil⇒[true]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">lis has: sup title unique]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">do⦂ [].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">sup≡nil]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">do⦂ [i&larr; i+1].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">all next &larr; a.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">lis&larr; lis delete: a].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑all contents]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪SystemOrganizer under: &rsquo;Sets and Dictionaries&rsquo;.</span></div>
    <div class="line left">
<span class="small">&rsquo;From Smalltalk 5.5k XM November 24 on 22 November 1980 at 2:57:08 am.&rsquo;<br></span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large">"Cursor"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;Cursor&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: Object<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;bitstr offset&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;&rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>I am a 16 x 16 dot matrix suitable for use as the Alto hardware cursor</span></div>
<div class="line left">
<span class="bold large"><br>Initialization</span></div>
<div class="line left">
<span class="bold small">fromString: bitstr </span><span class="small">[self fromString: bitstr offset: 0⌾0]</span></div>
<div class="line left">
<span class="bold small">fromString: bitstr offset: offset</span></div>
<div class="line left">
<span class="bold small">fromtext: str </span><span class="small">[self fromtext: str offset: 0⌾0]</span></div>
<div class="line left">
<span class="bold small">fromtext: str offset: offset </span><span class="small">| i s n c [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"Not great, but compatible with printon."</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitstr &larr; String new: 32.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s &larr; str asStream.  s next.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: 16 do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[n &larr; 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ ((c &larr; s next)=060 or⦂ c=061) do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[n &larr; (n lshift: 1)+(c-060)].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitstr word: i &larr; n]]</span></div>
<div class="line left">
<span class="bold small">offset: offset</span></div>
<div class="line left">
<span class="bold large"><br>Hardware cursor</span></div>
<div class="line left">
<span class="bold small">frompage1</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"load this cursor from the hardware locations"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[bitstr &larr; String new: 32.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">BitBlt new forCursor; sourcebase&larr; 0431; destbase &larr; bitstr; copy: storing]</span></div>
<div class="line left">
<span class="bold large"><br>Conversion</span></div>
<div class="line left">
<span class="bold small">hardcopy: pf </span><span class="small">["use current cursor position"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self hardcopy: pf at: user mp - offset]</span></div>
<div class="line left">
<span class="bold small">hardcopy: pf at: loc </span><span class="small">| rect [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"print cursor image at some point location into a presssfile"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">rect &larr; loc extent: 16⌾16.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pf setp: (pf transrect: rect) origin; bitmap: rect bits: bitstr]</span></div>
<div class="line left">
<span class="bold small">printon: strm </span><span class="small">| i<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[strm append: &rsquo;Cursor new fromtext: &rsquo;&rsquo;&rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: 16 do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[strm cr.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(bitstr word: i) printon: strm base: 2]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">strm append: &rsquo;&rsquo;&rsquo; offset: &rsquo;; print: offset; append: &rsquo;.&rsquo;]</span></div>
<div class="line left">
<span class="bold large"><br>Aspects</span></div>
<div class="line left">
<span class="bold small">offset </span><span class="small">[⇑offset]</span></div>
<div class="line left">
<span class="bold large"><br>Showing</span></div>
<div class="line left">
<span class="bold small">show</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold small"> </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"copy this cursor into the page 1 hardware locations"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">BitBlt new forCursor; destbase&larr; 0431; sourcebase &larr; bitstr; copy: storing.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user currentCursor: self<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"the following statement will copy back if we ever need to"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"BitBlt new forCursor; sourcebase&larr; 0431; destbase &larr; bitstr; copy: storing"]</span></div>
<div class="line left">
<span class="bold small">showwhile⦂ expr </span><span class="small">| oldcursor value [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">oldcursor &larr; user currentCursor.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self show.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">value &larr; expr eval.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">oldcursor show.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑value]</span></div>
<div class="line left">
<span class="bold large"><br>Compatibility</span></div>
<div class="line left">
<span class="bold small">topage1</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self show]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪Cursor under: &rsquo;Graphical Objects&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"HalfToner"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;HalfToner&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: Object<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;lines pixelsPerLine black white errorString rect vect inpix outpix nlines npix strm inset&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;&rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>This class converts ais image files to screen bits</span></div>
<div class="line left">
<span class="bold large"><br>AIS to Bits</span></div>
<div class="line left">
<span class="bold small">decode: str using: s </span><span class="small">| i j k x cascadeRight cascadeDiag val error r msk masks<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["</span><span class="italic small">Change 8-bit grey from str filling s"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> masks&larr;↪(128 64 32 16 8 4 2 1).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> cascadeRight&larr;0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> cascadeDiag&larr;errorString◦1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> i&larr;msk&larr;j&larr;k&larr;1. x&larr;0-outpix.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> s◦1&larr;0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> for⦂ i to: pixelsPerLine do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[while⦂ x&lt;0 do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[val&larr;(str◦i)-black.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[(error&larr;cascadeRight-val)≥0⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"print Black"</span><span class="small"> s◦j&larr;masks◦msk+(s◦j). (error&gt;white)⇒[error&larr;white] ]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"print White"</span><span class="small"> (error&larr;error+white)&lt;0⇒[error&larr;0] ].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">error&larr;error/2.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">val&larr;error/2.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">errorString◦k&larr;cascadeDiag+val.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">cascadeRight&larr;errorString◦(k+1)+error.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">cascadeDiag&larr;val.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[(msk&larr;msk+1)&gt;8⇒[msk&larr;1. j&larr;j+1. s◦j&larr;0] ].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">x&larr;x+inpix. k&larr;k+1].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">x&larr;x-outpix].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold small">⇑s</span><span class="small">]  primitive: 109</span></div>
<div class="line left">
<span class="bold small">doFile </span><span class="small">| str i s2 r y skipsum<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[str&larr;String new: pixelsPerLine.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">r&larr;0⌾0 rect: (pixelsPerLine*outpix/inpix)⌾1. r moveto: rect origin copy.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s2&larr;String new: 1+((pixelsPerLine*outpix)/(8*inpix)).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">vect&larr;Vector new: lines. strm reset; position&larr;2048+(inset y*npix). </span><span class="italic small">"crop top"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">i&larr;1. y&larr;0-outpix. skipsum&larr;0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ i≤lines do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[skipsum&larr;skipsum+inset x. </span><span class="italic small">"inset left"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">strm skip: skipsum. skipsum&larr;0. </span><span class="italic small">"do all tallied skips prior to next read"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">strm into: str endError: true.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">r bitsFromString: (self decode: str using: s2).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">skipsum&larr;skipsum+npix-(pixelsPerLine+inset x).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">r origin y&larr;r origin y+1. r corner y&larr;r corner y+1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[(y&larr;y+inpix)≥0⇒ </span><span class="italic small">"next line?"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[i&larr;i+1. y&larr;y-outpix.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ (y≥0 and⦂ i≤lines) do⦂ [i&larr;i+1. y&larr;y-outpix. skipsum&larr;skipsum+npix] ]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">skipsum&larr;skipsum-npix] ]. </span><span class="italic small">"not next line"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">strm close]</span></div>
<div class="line left">
<span class="bold small">intoPress: p file: f </span><span class="small">| outrect </span><span class="italic small">"Creates an external file reference"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[outrect&larr;p transrect: rect.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">p setp: (outrect origin); dots⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[p setcoding: 8 </span><span class="italic small">"byte samples"</span><span class="small"> dots: npix lines: nlines;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">setmode: 3 </span><span class="italic small">"to right and to bottom of page"</span><span class="small">;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">setwindowwidth: pixelsPerLine height: lines<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">skipdots: (inset x) skiplines: (inset y);<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">setsizewidth: (outrect width) height: (outrect height);<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">dotsfromAIS: f] ]<br>"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">|p. p&larr;dp0 pressfile: &rsquo;pix.press&rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">p pictureinit. (HalfToner new test) intoPress: p file: &rsquo;Rolfup.AIS&rsquo;. p close.<br>"</span></div>
<div class="line left">
<span class="bold small">setup | i r1 r2 inset done</span><span class="small">"set up default paramsHalfToner new doFile."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[user print: &rsquo;Black? (0-255)&rsquo;. black &larr; user read asVector◦1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> user print: &rsquo;White? (0-255)&rsquo;. white &larr; user read asVector◦1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> white &larr; white-black max: 255.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> [white&gt;255⇒[white &larr; 255]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> r1 &larr; 0⌾0 rect: pixelsPerLine⌾lines. <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> user print: &rsquo;Position whole &rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> until⦂ user anybug do⦂ [r1 moveto: user mp. r1 comp. r1 comp].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> user waitnobug. r1 comp. "show whole"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> user print: &rsquo; Show cropping &rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> r2 &larr; Rectangle new fromuser intersect: r1. r1 comp.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> inset &larr; r2 origin - r1 origin. <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> pixelsPerLine &larr; pixelsPerLine min: r2 width.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> lines &larr; lines min: r2 height.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> done &larr; false.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">until⦂ done do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> [user print: &rsquo; Position it &rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> rect &larr; Rectangle new fromuser.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> [rect width&gt;r2 width⇒["blowup" inpix &larr; 8. outpix &larr; (8*rect width/r2 width)]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"shrink" outpix &larr; 8. inpix &larr; (8*r2 width/rect width)].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> rect extent &larr; r2 extent * outpix / inpix.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> rect comp. user print: &rsquo;ok? (redbug)&rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> until⦂ user anybug do⦂ []. [user redbug⇒[done &larr; true]]. user waitnobug.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> rect comp].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> errorString &larr; String new: pixelsPerLine*outpix / inpix+1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> for⦂ i to: errorString length do⦂ [errorString◦i &larr; 0].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> ⇑inset "return inset"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold large"><br>Init/Access</span></div>
<div class="line left">
<span class="bold small">nlines </span><span class="small">[</span><span class="bold small">⇑nlines</span><span class="small">]</span></div>
<div class="line left">
<span class="bold small">npix </span><span class="small">[</span><span class="bold small">⇑npix</span><span class="small">]</span></div>
<div class="line left">
<span class="bold small">rect </span><span class="small">[</span><span class="bold small">⇑rect</span><span class="small">]</span></div>
<div class="line left">
<span class="bold small">rect&larr;rect</span></div>
<div class="line left">
<span class="bold small">setup: strm </span><span class="small">| inrect croprect<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[strm readonly.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(strm word: 2)≠1024 or⦂ (strm word: 9)≠8⇒[user notify: &rsquo;bad file&rsquo;]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nlines&larr;lines&larr;strm word: 4. npix&larr;pixelsPerLine&larr;strm nextword.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">black&larr;0. white&larr;255.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">inrect&larr;0⌾0 rect: pixelsPerLine⌾lines. inrect moveto: rect origin.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">inrect usermove; comp. </span><span class="italic small">"show whole"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">croprect&larr;rect copy. croprect moveto: inrect origin copy. croprect maxstretch: inrect.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">croprect userstretch: inrect. inrect comp.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">inset&larr;croprect origin-inrect origin.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pixelsPerLine&larr;croprect width. lines&larr;pixelsPerLine*rect height/rect width.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[rect width&gt;pixelsPerLine⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"blowup"</span><span class="small"> inpix&larr;32. outpix&larr;(32*rect width/pixelsPerLine)]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"shrink"</span><span class="small"> outpix&larr;32. inpix&larr;(32*pixelsPerLine/rect width)].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">errorString&larr;String new: pixelsPerLine*outpix/inpix+2.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">errorString all&larr;0]</span></div>
<div class="line left">
<span class="bold small">strm </span><span class="small">[</span><span class="bold small">⇑strm</span><span class="small">]</span></div>
<div class="line left">
<span class="bold small">test </span><span class="small">| files<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[files&larr;(dp0 filesMatching: &rsquo;*.ais.&rsquo;) sort.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">files empty⇒[user notify: &rsquo;no .ais files on disk&rsquo;]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">strm&larr;dp0 file: (files◦(Menu new stringFromVector: files) zbug). strm readonly.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">rect&larr;Rectangle new usersize. self setup: strm; doFile]<br>"<br>HalfToner new test.<br>"</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪HalfToner under: &rsquo;Graphical Objects&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"Turtle"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;Turtle&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: Object<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;pen ink width dir x xf y yf frame&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;&rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>Turtles can crawl around the screen drawing and printing at any angle.<br>Dont forget to send them the message init before any drawing commands.</span></div>
<div class="line left">
<span class="bold large"><br>Initialization</span></div>
<div class="line left">
<span class="bold small">erase<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[frame clear: white]</span></div>
<div class="line left">
<span class="bold small">frame </span><span class="small">[⇑frame]</span></div>
<div class="line left">
<span class="bold small">frame: frame</span></div>
<div class="line left">
<span class="bold small">init<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[pen &larr; width &larr; 1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">x&larr; y&larr; xf&larr; yf&larr; 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">frame &larr; user screenrect.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self black; home]</span></div>
<div class="line left">
<span class="bold large"><br>Pen Control</span></div>
<div class="line left">
<span class="bold small">black </span><span class="small">[ink &larr; black]</span></div>
<div class="line left">
<span class="bold small">color: ignored  </span><span class="small">"Only implemented for PressTurtle"</span></div>
<div class="line left">
<span class="bold small">ink: ink</span></div>
<div class="line left">
<span class="bold small">pen: pen</span></div>
<div class="line left">
<span class="bold small">pendn<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[pen &larr; 1]</span></div>
<div class="line left">
<span class="bold small">penup<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[pen &larr; 0]</span></div>
<div class="line left">
<span class="bold small">white </span><span class="small">[ink &larr; white]</span></div>
<div class="line left">
<span class="bold small">width </span><span class="small">[⇑width]</span></div>
<div class="line left">
<span class="bold small">width: width</span></div>
<div class="line left">
<span class="bold small">xor </span><span class="small">[ink &larr; 2]</span></div>
<div class="line left">
<span class="bold large"><br>Drawing</span></div>
<div class="line left">
<span class="bold small">fillIn⦂ expr </span><span class="small">[⇑expr eval]  "Only implemented for PressTurtle"</span></div>
<div class="line left">
<span class="bold small">go: length </span><span class="small">[user croak] primitive: 53</span></div>
<div class="line left">
<span class="bold small">goto: pt<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[pt x is: Integer⇒[user croak]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self goto: pt x asInteger⌾pt y asInteger] primitive: 54</span></div>
<div class="line left">
<span class="bold small">home</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self up; place: frame center-frame origin. xf&larr; yf&larr; 0100000]</span></div>
<div class="line left">
<span class="bold small">place </span><span class="small">[⇑x⌾y]</span></div>
<div class="line left">
<span class="bold small">place: pt </span><span class="small">| p</span><span class="bold small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[p&larr; pen. pen&larr; 0. self goto: pt. pen&larr; p]</span></div>
<div class="line left">
<span class="bold small">pointAt: pt </span><span class="small">| diff "change direction so turtle points at pt."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[diff &larr; (pt - (self place)).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> dir &larr; ((diff theta) asInteger)]<br><br></span></div>
<div class="line left">
<span class="bold small">stretchto: pt </span><span class="small">| t old<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[t &larr; Turtle init frame: frame. old &larr; x⌾y. <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">t xor; place: old; goto: pt; place: old; goto: pt]</span></div>
<div class="line left">
<span class="bold small">turn: angle<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[dir&larr; dir+angle\360]</span></div>
<div class="line left">
<span class="bold small">up</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold small"> </span><span class="small">[dir &larr; 270]</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"Point toward top of screen"</span><span class="bold small"><br></span></div>
<div class="line left">
<span class="bold large"><br>Text</span></div>
<div class="line left">
<span class="bold small">put: char font: font</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"char=ascii Integer, font=font bits (String)"</span><span class="bold small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[user croak] primitive: 56</span></div>
<div class="line left">
<span class="bold small">show: str font: font </span><span class="small">| a f</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"str=text (String), font=font number (0-9)"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[f&larr; DefaultTextStyle fonts◦(font+1).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ a from: str do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self put: a font: f]]</span></div>
<div class="line left">
<span class="bold large"><br>Examples</span></div>
<div class="line left">
<span class="bold small">dragon: n<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[n=0⇒[self go: 10]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">n&gt;0⇒[self dragon: n-1; turn: 90; dragon: 1-n]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self dragon: ¬1-n; turn: ¬90; dragon: 1+n]<br>"<br>Turtle init dragon: 8<br>"</span></div>
<div class="line left">
<span class="bold small">filberts: order side: s </span><span class="small">| i n2<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[n2&larr; 1 lshift: order-1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self penup; go: 0-n2*s; pendn.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: 4 do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self color: i-1*40.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self fillIn⦂ [self hilbert: order side: s; go: s; hilbert: order side: s; go: s].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self black; hilbert: order side: s; go: s; hilbert: order side: s; go: s.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self penup; go: n2-1*s; turn: ¬90; go: n2*s; turn: 180; pendn]]<br>"<br>Turtle init erase filberts: 3 side: 10.<br><br>user displayoffwhile⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[PressTurtle new init: &rsquo;try.press&rsquo;; filberts: 4 side: 10; close].<br>"</span></div>
<div class="line left">
<span class="bold small">hilbert: n side: s </span><span class="small">| a m<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[n=0⇒[self turn: 180]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[n&gt;0⇒[a&larr;90. m&larr;n-1] a&larr;¬90. m&larr;n+1].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self turn: a; hilbert: 0-m side: s; turn: a.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self go: s; hilbert: m side: s;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">turn: 0-a; go: s; turn: 0-a;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">hilbert: m side: s; go: s.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self turn: a; hilbert: 0-m side: s; turn: a]<br>"<br>Turtle init hilbert: 3 side: 4<br>"<br></span></div>
<div class="line left">
<span class="bold small">hilberts: n </span><span class="small">| i s<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self penup; go: 128; pendn.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: n do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[s&larr; 256 lshift: 0-i.  self color: n-i*40; width: n-i+1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self penup; go: 0-s/2; turn: ¬90; go: s/2; turn: 90; pendn.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self hilbert: i side: s; go: s; hilbert: i side: s; go: s]]<br>"<br>Turtle init erase hilberts: 5.<br><br>user displayoffwhile⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[PressTurtle new init: &rsquo;try2.press&rsquo;; hilberts: 4; close].<br>"</span></div>
<div class="line left">
<span class="bold small">mandala: npoints diameter: d </span><span class="small">| l points i j<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[l&larr; (3.14*d/npoints) asInteger.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self home; penup; turn: ¬90; go: d/2; turn: 90; go: 0-l/2.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">points&larr; Vector new: npoints.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: npoints do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[points◦i&larr; self place.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self go: l; turn: 360/npoints].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self pendn.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i from: npoints/2 to: 1 by: ¬1 do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self color: (npoints/2)-i*20\250.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ j to: npoints do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self place: points◦j; goto: points◦(j+i-1\npoints+1)]]]<br>"<br>Turtle init mandala: 30 diameter: 400<br><br>user displayoffwhile⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[PressTurtle new init: &rsquo;try.press&rsquo;; mandala: 30 diameter: 500; close.]<br>"</span></div>
<div class="line left">
<span class="bold small">spiral: n angle: a </span><span class="small">| i<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[for⦂ i to: n do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self color: i*2\256; go: i; turn: a]]<br>"<br> Turtle init spiral: 200 angle: 89; home; spiral: 200 angle: ¬89.<br><br> user displayoffwhile⦂ [(PressTurtle new init: &rsquo;try.press&rsquo;)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">spiral: 403 angle: 89;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">home; spiral: 403 angle: ¬89; close.]<br> "</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪Turtle under: &rsquo;Graphical Objects&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"PressTurtle"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;PressTurtle&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: Turtle<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;file fplace fdir filling&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;&rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>I work with Pressfile to print high resolution pictures.<br>All inputs can be floating point for high resolution.<br>Complexity is limited to about 2k lines until multiple entity lists</span></div>
<div class="line left">
<span class="bold large"><br>Initialization</span></div>
<div class="line left">
<span class="bold small">close </span><span class="small">[file page. file close]</span></div>
<div class="line left">
<span class="bold small">init: name <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[file &larr; (dp0 pressfile: name).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">filling&larr; false.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">file pictureinit. self black.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">super init]</span></div>
<div class="line left">
<span class="bold small">initwithfile: name <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[file &larr; name.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">filling&larr; false.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self black.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">super init]</span></div>
<div class="line left">
<span class="bold large"><br>Pen Control</span></div>
<div class="line left">
<span class="bold small">black <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[file brightness: 0. super black]</span></div>
<div class="line left">
<span class="bold small">blue </span><span class="small">[self color: 160]</span></div>
<div class="line left">
<span class="bold small">color: h </span><span class="small">[file hue: h; brightness: 255; saturation: 255]</span></div>
<div class="line left">
<span class="bold small">cyan </span><span class="small">[self color: 120]</span></div>
<div class="line left">
<span class="bold small">green </span><span class="small">[self color: 80]</span></div>
<div class="line left">
<span class="bold small">magenta </span><span class="small">[self color: 200]</span></div>
<div class="line left">
<span class="bold small">place </span><span class="small">[⇑fplace]</span></div>
<div class="line left">
<span class="bold small">red </span><span class="small">[self color: 0]</span></div>
<div class="line left">
<span class="bold small">up </span><span class="small">[dir&larr; 270. fdir&larr; 270.0]</span></div>
<div class="line left">
<span class="bold small">white <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[file brightness: 255.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">file saturation: 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">super white]</span></div>
<div class="line left">
<span class="bold small">yellow </span><span class="small">[self color: 40]</span></div>
<div class="line left">
<span class="bold large"><br>Drawing</span></div>
<div class="line left">
<span class="bold small">fillIn⦂ expr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"Code in expr must describe a closed figure"</span><span class="bold small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[filling&larr; true.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">file object⦂ expr eval atScreen: fplace.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">filling&larr; false]</span></div>
<div class="line left">
<span class="bold small">go: dist </span><span class="small">| old</span><span class="bold small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self goto: fplace + <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(([fdir\90.0=0.0⇒</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"optimize horiz and vert lines"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[fdir/90.0=0⇒[1.0⌾0.0];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=1⇒[0.0⌾1.0];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=2⇒[¬1.0⌾0.0];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=3⇒[0.0⌾¬1.0]]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">fdir asRadians asDirection])*dist)]</span></div>
<div class="line left">
<span class="bold small">goto: p </span><span class="small">| old</span><span class="bold small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[old&larr; fplace.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">fplace &larr; p x asFloat ⌾ p y asFloat.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">super goto: fplace x round ⌾ fplace y round.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">filling⇒[file objectGotoScreen: fplace pen: pen]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pen=1⇒[file drawlinefromscreen: old to: fplace width: 0.46875*width]]</span></div>
<div class="line left">
<span class="bold small">turn: angle </span><span class="small">[fdir&larr; fdir+angle\360.0]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪PressTurtle under: &rsquo;Graphical Objects&rsquo;.</span></div>
    <div class="line left">
<span class="small">&rsquo;From Smalltalk 5.5k XM November 24 on 22 November 1980 at 2:57:08 am.&rsquo;<br></span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large">"Dispframe"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;Dispframe&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: Stream<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;text&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;prompt doit &rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>I am a dialog window</span></div>
<div class="line left">
<span class="bold large"><br>Initialization</span></div>
<div class="line left">
<span class="bold small">classInit </span><span class="small">[prompt &larr; &rsquo;&#64257;&rsquo;◦1. doit &larr; &rsquo;&rsquo;◦1]</span></div>
<div class="line left">
<span class="bold small">frame &larr; r<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[text para: nil frame: r]</span></div>
<div class="line left">
<span class="bold small">init<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[text &larr; Textframe new.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self of: (String new: 16)]</span></div>
<div class="line left">
<span class="bold small">rect: r<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self init; frame &larr; r; clear]</span></div>
<div class="line left">
<span class="bold large"><br>Scheduler</span></div>
<div class="line left">
<span class="bold small">eachtime </span><span class="small">| t<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[text window has: user mp⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[user kbck⇒[t&larr; self kbd⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ [t≡nil⇒[] self space; print: nilⓢ t].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self prompt]]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> user bluebug⇒ [⇑false]]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user anybug⇒[⇑false]]</span></div>
<div class="line left">
<span class="bold small">firsttime<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[text window has: user mp⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self outline; prompt]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑false]</span></div>
<div class="line left">
<span class="bold small">lasttime<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ [self last=prompt⇒[self skip: ¬2; show]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑user bluebug≡false]</span></div>
<div class="line left">
<span class="bold small">leave</span></div>
<div class="line left">
<span class="bold large"><br>Dialog</span></div>
<div class="line left">
<span class="bold small">ev </span><span class="small">| t<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[while⦂ [self cr. t &larr; self request: &rsquo;&rsquo;] do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self space; print: nil ⓢt]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑false]</span></div>
<div class="line left">
<span class="bold small">kbd </span><span class="small">| n t</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"false if user pauses, nil if ctrl-d, all input since prompt if "</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[while⦂ user kbck do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[t &larr; user kbd.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">t=132⇒ [self append: &rsquo;done.&rsquo;; show. ⇑nil]; </span><span class="italic small">"ctl-d for done"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=8⇒ [self last=prompt⇒[] self skip: ¬1]; </span><span class="italic small">"backspace"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=30⇒ [n &larr; array◦(position to: 1 by:¬1) find: prompt.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">n=0⇒[self append: &rsquo;lost beginning&rsquo;; prompt]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">t&larr; self last: n-1. self next&larr; doit; show. ⇑t];</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> </span><span class="italic small">"do-it (LF)"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=145⇒ [self last=prompt⇒[] self skip: ¬1.</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"ctl-w for backspace word"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ (position&gt;0 and: self last tokenish) do⦂ [self skip: ¬1]];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=151⇒[self reset; prompt] </span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"ctl-x clears frame"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self next &larr; t]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self show. ⇑false]</span></div>
<div class="line left">
<span class="bold small">prompt </span><span class="small">[self cr; next&larr; prompt; show]</span></div>
<div class="line left">
<span class="bold small">read </span><span class="small">| t</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"false if ctrl-d, all input since prompt if "</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self next&larr; prompt; show.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">until⦂ [user kbck⇒[t&larr; self kbd] false] do⦂ []<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">t≡nil⇒[⇑false] ⇑t]</span></div>
<div class="line left">
<span class="bold small">request: s</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"false if ctrl-d, all input since prompt if "</span><span class="bold small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self append: s. ⇑self read]</span></div>
<div class="line left">
<span class="bold large"><br>Image</span></div>
<div class="line left">
<span class="bold small">clear<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self reset. self show]</span></div>
<div class="line left">
<span class="bold small">moveto: pt<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[(text window inset: ¬2⌾¬2) dragto: pt-(¬2⌾¬2)]</span></div>
<div class="line left">
<span class="bold small">outline<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[text window outline: 2]</span></div>
<div class="line left">
<span class="bold small">show </span><span class="small">| t [</span><span class="bold small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">text show: self contents.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">until⦂ text lastshown≥ position do⦂ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">position &lt; (t &larr; text scrolln: 1)⇒ []<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">t &larr; array copy: t+1 to: position.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">text show: t.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">position &larr; 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self append: t.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"self dequeue: (text scrolln: 1).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">text show: self contents"]]</span></div>
<div class="line left">
<span class="bold large"><br>Access to Parts</span></div>
<div class="line left">
<span class="bold small">frame<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑text frame]</span></div>
<div class="line left">
<span class="bold small">text<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑text]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪Dispframe under: &rsquo;Text Objects&rsquo;.</span></div>
<div class="line left">
<span class="small">Dispframe classInit</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"Paragraph"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;Paragraph&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: Array<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;text runs alignment&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;&rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>Paragraphs implement pretty text.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">text is a String of the ascii characters.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">alignment specifies how the paragraph should be justified.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">runs is a String of run-coded format information.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">odd byte is run length (≤255)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">following byte is 16*format number +<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">1*bold 2*italic 4*underline 8*strikeout<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">longer runs are made from several of length 255.</span></div>
<div class="line left">
<span class="bold large"><br>Initialization of parts</span></div>
<div class="line left">
<span class="bold small">copy </span><span class="small">[⇑self class new text: text runs: runs alignment: alignment]</span></div>
<div class="line left">
<span class="bold small">text: text<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[alignment &larr; 0]</span></div>
<div class="line left">
<span class="bold small">text: text alignment: alignment</span></div>
<div class="line left">
<span class="bold small">text: text runs: runs alignment: alignment</span></div>
<div class="line left">
<span class="bold large"><br>Normal access</span></div>
<div class="line left">
<span class="bold small">◦x </span><span class="small">[⇑text◦x]</span></div>
<div class="line left">
<span class="bold small">asParagraph </span><span class="small">[⇑self]</span></div>
<div class="line left">
<span class="bold small">asStream </span><span class="small">[⇑text asStream]</span></div>
<div class="line left">
<span class="bold small">asVector </span><span class="small">[⇑text asVector]</span></div>
<div class="line left">
<span class="bold small">copy: a to: b</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">Return a copied subrange of this paragraph</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑self class new<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">text: (text copy: a to: b)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">runs: (self run: a to: b)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">alignment: alignment]</span></div>
<div class="line left">
<span class="bold small">findString: str startingAt: start<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑text findString: str startingAt: start]</span></div>
<div class="line left">
<span class="bold small">length </span><span class="small">[⇑text length]</span></div>
<div class="line left">
<span class="bold small">replace: a to: b by: c   </span><span class="small">[</span><span class="italic small">"alters self - doesnt copy"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[runs≡nil and⦂ (c isnt: self class)⇒[]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">runs &larr; self runcat: (self run: 1 to: a-1)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">and: [c is: self class⇒ [c runs]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self makerun: c length val: [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">runs empty⇒[0]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">runs◦((self runfind: b)◦1+1)]]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">and: (self run: b+1 to: text length)].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">text &larr; text replace: a to: b by: [c is: self class⇒[c text] c]]</span></div>
<div class="line left">
<span class="bold small">subst: x for: y </span><span class="italic small">"runs are not supported yet here"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑text subst: x for: y]</span></div>
<div class="line left">
<span class="bold small">text </span><span class="small">[⇑text]</span></div>
<div class="line left">
<span class="bold small">textStyle </span><span class="small">[⇑DefaultTextStyle]</span></div>
<div class="line left">
<span class="bold large"><br>Text alignment</span></div>
<div class="line left">
<span class="bold small">alignment </span><span class="small">[⇑alignment]</span></div>
<div class="line left">
<span class="bold small">alignment &larr; alignment</span></div>
<div class="line left">
<span class="bold small">center </span><span class="small">[alignment &larr; 2]</span></div>
<div class="line left">
<span class="bold small">flushleft </span><span class="small">[alignment &larr; 0]</span></div>
<div class="line left">
<span class="bold small">flushright </span><span class="small">[alignment &larr; 4]</span></div>
<div class="line left">
<span class="bold small">justify </span><span class="small">[alignment &larr; 1]</span></div>
<div class="line left">
<span class="bold large"><br>Manipulation of format runs</span></div>
<div class="line left">
<span class="bold small">allBold </span><span class="small">[self maskrunsunder: 1 to: 1]</span></div>
<div class="line left">
<span class="bold small">allFont: n </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[n is: String⇒ [n &larr; (self textStyle fontnames find: n) - 1]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self maskrunsunder: 0360 to: n*16]</span></div>
<div class="line left">
<span class="bold small">allItalic </span><span class="small">[self maskrunsunder: 2 to: 2]</span></div>
<div class="line left">
<span class="bold small">makeBoldPattern </span><span class="small">| s i c<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[s &larr; text asStream.  i&larr; 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">until⦂ [c&larr; s next⇒</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">" scan to bracket, bar or comment "</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[c=91⇒[true]; =124⇒[true]; =34⇒[true]; =25⇒[true] false]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">true]</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"end"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">do⦂ [i&larr; i+1].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self maskrun: 1 to: i under: 1 to: 1]</span></div>
<div class="line left">
<span class="bold small">makerun: len val: val</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"Make up a solid run of value val"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">| str i<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[len=0⇒[⇑nullString]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">str &larr; String new: len-1/255+1*2.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i from: 1 to: str length by: 2 do⦂ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">str◦i &larr; [len&gt;255⇒[255] len].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">str◦(i+1) &larr; val.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">len &larr; len-255].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑str]</span></div>
<div class="line left">
<span class="bold small">maskrun: i to: j under: m to: val </span><span class="italic small">"Alter my runs so that the bits selected by m become val."</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">| r k</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"Maybe merge this with mergestyle"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[r &larr; self run: i to: j.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ k from: 2 to: r length by: 2 do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[r◦k &larr; (r◦k land: 0377-m) + val].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">runs &larr; self runcat: (self run: 1 to: i-1) and: r and: (self run: j+1 to: text length)]</span></div>
<div class="line left">
<span class="bold small">maskrunsunder: m to: val<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self maskrun: 1 to: text length under: m to: val]</span></div>
<div class="line left">
<span class="bold small">run: a to: b </span><span class="small">| c</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"subrange of run"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[a&gt;b⇒[⇑nullString]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">runs≡nil⇒[⇑self makerun: 1+b-a val: 0]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">a &larr; self runfind: a.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">b &larr; self runfind: b.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">c &larr; runs copy: a◦1 to: b◦1+1.</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"copy the sub-run"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[(a◦1)=(b◦1)⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[c◦1 &larr; 1+ (b◦2)-(a◦2)]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">c◦1 &larr; 1+(runs◦(a◦1))- (a◦2).</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"trim the end lengths"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">c◦(c length-1) &larr; b◦2].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑c]</span></div>
<div class="line left">
<span class="bold small">runcat: r1 and: r2 and: r3 </span><span class="small">| i r olen len oc c nr [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">concatenate and compact 3 runs</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nr &larr; Stream new of: (String new: 30).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">oc &larr; false.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: 3 do⦂ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">r &larr; [i=1⇒ [r1]; =2⇒ [r2] r3].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">r length=0⇒ []<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">r &larr; r asStream.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ (len &larr; r next) do⦂ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">c &larr; r next.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">len = 0⇒ ["</span><span class="italic small">ignore empty runs (shouldn&rsquo;t be any)</span><span class="small">"]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">oc = c⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(olen &larr; olen+len) ≤ 255⇒ []<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nr next &larr; 255; next &larr; oc.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">olen &larr; olen-255]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[oc⇒ [nr next &larr; olen; next &larr; oc] "</span><span class="italic small">first time thru</span><span class="small">"].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">olen &larr; len. oc &larr; c]].<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[oc⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">leftovers</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nr next &larr; olen; next &larr; oc]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑nr contents]</span></div>
<div class="line left">
<span class="bold small">runcat: x to: y </span><span class="small">[⇑self runcat: x and: y and: &rsquo;&rsquo;]</span></div>
<div class="line left">
<span class="bold small">runfind: index </span><span class="small">| run</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">t</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"index into run"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[run&larr;1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ (t &larr; index - (runs◦run)) &gt; 0 do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[index &larr; t. run &larr; run+2].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑run,index]</span></div>
<div class="line left">
<span class="bold small">runs</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"return runs or default if none"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[runs≡nil⇒[⇑self makerun: text length val: 0]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑runs]</span></div>
<div class="line left">
<span class="bold large"><br>Bravo conversions</span></div>
<div class="line left">
<span class="bold small">applyBravo: s at: i to: j</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">| v ch t bslash cr [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"Alter runs of characters i through j according to trailer.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">see Ibis&lt;Bravo&gt;Trailer.Memo for further info.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">some functions may not be implemented, thus parsed and ignored</span><span class="small">.<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">paragraph looks.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">implemented: justification (j), centering (c).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">ignored: left margin (l), first line left margin (d), right margin (z),<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">line leading (x), paragraph leading (e), vertical tab (y), keep (k), profile (q),<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">tab tables ( () )</span><span class="small">"<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s &larr; s asStream.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">cr &larr; 015.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bslash &larr; &rsquo;\&rsquo;◦1.<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">until⦂ (ch &larr; s next) = bslash do⦂ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">ch ≡ false or⦂ ch = cr⇒ ["</span><span class="italic small">no more</span><span class="small">" ⇑self]<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(t &larr; &rsquo;jcq&rsquo; find: ch) &gt; 0⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">t=1⇒ [self justify]; =2⇒ [self center]]<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(t &larr; &rsquo;(ldzxeyk&rsquo; find: ch) &gt; 0⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">t=1⇒ [s skipTo: &rsquo;)&rsquo;◦1]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s integerScan]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">character looks.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">implemented: font (f), bold (bB), italic (iI), underline (uU).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">ignored: graphic (g), visible (v), overstrike (s), superscript (o), tabcolor (t)"<br></span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ ((ch &larr; s next) and⦂ ch ≠ cr) do⦂ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">run length</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ch ≥ 060 and⦂ ch ≤ 071 "isdigit"⇒ [s skip: ¬1] ch = 040]⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">i &larr; i + s integerScan]<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(t &larr; &rsquo;bBiIuU&rsquo; find: ch) &gt; 0⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self maskrun: i to: j under: ↪(1 1 2 2 4 4)◦t to: ↪(1 0 2 0 4 0)◦t]<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(t &larr; &rsquo;fot&rsquo; find: ch) &gt; 0⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">new value follows</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">v &larr; s integerScan.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">t=1⇒ [self maskrun: i to: j under: 0360 to: (v lshift: 4)]]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">bravoRuns: s </span><span class="italic small">"Encode the runs in a Bravo paragraph trailer onto a Stream"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">| i old len dif new bit bits<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["assume Ctrl-Z is already there"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s append: [alignment=1⇒[&rsquo;j\g&rsquo;]; =2⇒[&rsquo;c\g&rsquo;] &rsquo;\g&rsquo;].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[runs≡nil ⇒ []<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">len &larr; 0. old &larr; 0400.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bits &larr; ↪(1 2 4).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i from: 1 to: runs length by: 2 do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[dif &larr; old lxor: (new &larr; runs◦(i+1)).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(dif land: 0367)=0 ⇒ </span><span class="italic small">"No changes"</span><span class="small"> [len &larr; len+(runs◦i)]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[i=1⇒[] len printon: s].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ bit to: 3 do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[(dif land: bits◦bit)=0 ⇒ []<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s next &larr; ([(new land: bits◦bit)≠0 ⇒ [&rsquo;biu&rsquo;] &rsquo;BIU&rsquo;])◦bit].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[(dif land: 0360)≠0 ⇒ </span><span class="italic small">"Font change"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[s append: &rsquo;f&rsquo;; print: (new lshift: ¬4); space]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">old &larr; new.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">len &larr; runs◦i.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s cr]</span></div>
<div class="line left">
<span class="bold small">fromBravo </span><span class="italic small">"Find Bravo trailers and return a copy of self with them applied"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">| newpara newtext loc i j<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[newpara &larr; self copy.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">loc &larr; 1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ (i &larr; (newtext &larr; newpara text) find: 032)≠0 do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[j &larr; newtext◦(i+1 to: newtext length) find: 015.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">newpara applyBravo: newtext◦(i+1 to: i+j) at: loc to: i-1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">newpara replace: i to: [i+j=newtext length⇒[i+j] i+j-1] by: &rsquo;&rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">loc &larr; i+1]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑newpara]</span></div>
<div class="line left">
<span class="bold small">toBravo </span><span class="small">| s [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s &larr; (String new: text length*2) asStream.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s append: text; next &larr; 032.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self bravoRuns: s.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑s contents asParagraph]</span></div>
<div class="line left">
<span class="bold large"><br>Press printing</span></div>
<div class="line left">
<span class="bold small">fromPress: press value: s </span><span class="small">| len x [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[s next=0⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">text is in DL</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">len &larr; s nextword.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">amount to skip from where we are now to end of text</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">x &larr; [s limit &gt; 255⇒ ["</span><span class="italic small">control info came from DL</span><span class="small">" s limit] "</span><span class="italic small">from EL</span><span class="small">" 0].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">press data skip: 0-x-len.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">text &larr;  press data next: len.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">press data skip: x]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">text &larr; s nextString].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">runs &larr; s nextString.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">alignment &larr; s next.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">runs empty⇒ [runs &larr; nil]]</span></div>
<div class="line left">
<span class="bold small">hideData: complete </span><span class="small">| s [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s &larr; Stream new of: (String new: 150).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s next &larr; complete.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[complete=0⇒ [s nextword &larr; text length] s nextString &larr; text].<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s nextString&larr; [runs≡nil⇒ [nullString] runs];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">next&larr; alignment.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑s contents]</span></div>
<div class="line left">
<span class="bold small">hidePress: press complete: c </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">not called by Form-Path-Image, but probably by Class printout</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">press skipcode: self pressCode data: (self hideData: c)]</span></div>
<div class="line left">
<span class="bold small">pressCode </span><span class="small">[⇑99]</span></div>
<div class="line left">
<span class="bold small">presson: press in: r </span><span class="small">[⇑self presson: press in: r style: self textStyle]</span></div>
<div class="line left">
<span class="bold small">presson: press in: r style: style </span><span class="small">| char pos s3 y chop [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"Output paragraph inside rectangle (page coordinates)"</span><span class="small"><br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"probably ParagraphScanner should handle this"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">text length &gt; 0 and⦂ text◦1 = 014⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"formfeed --&gt; page break"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑self copy: 2 to: text length]<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">y &larr; r corner y.</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"We change corner y later"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s3 &larr; ParagraphScanner new of: self to: press style: style.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s3 init in: r.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pos &larr; s3 position.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">chop &larr; [alignment=1⇒ [0] alignment].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ (y and⦂ (char &larr; s3 scan)) do⦂ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">char = 011 ⇒ [s3 tab]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">char = 040 or⦂ char = 015 ⇒</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"carriage return or exceeded max width and backed up to blank"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">y &larr; s3 printfrom: pos aligned: [char=040⇒[alignment] chop] skip: 1⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[r corner y &larr; y. s3 init in: r. pos &larr; s3 position]]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">char ≡ true ⇒[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"exceeded max width with no blanks in line"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s3 backup.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">y &larr; s3 printfrom: pos aligned: 0 skip: 0⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[r corner y &larr; y. s3 init in: r. pos &larr; s3 position]]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"user notify: &rsquo;unimplemented control char&rsquo;"</span><span class="small">].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"Put out trailing text if any"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">y and⦂ ((pos=s3 position) or⦂ (y &larr; s3 printfrom: pos aligned: chop skip: 0))⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">press append: text.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑y]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">press append: text◦(1 to: pos).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑self copy: pos + 1 to: text length]</span></div>
<div class="line left">
<span class="bold large"><br>Filing</span></div>
<div class="line left">
<span class="bold small">readFrom: file </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">text &larr; file nextString.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">runs &larr; file nextString.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">alignment &larr; file next.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">runs empty⇒ [runs &larr; nil]]</span></div>
<div class="line left">
<span class="bold small">storeOn: file </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">file nextString &larr; text.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[runs≡nil⇒ [file next &larr; 0] file nextString &larr; runs].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">file next &larr; alignment]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪Paragraph under: &rsquo;Text Objects&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"Reader"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;Reader&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: Object<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;source collector token nextchar typetbl &rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;typetable &rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>Converts a string to tokens.  The collector defines what to do for each kind of token: see TokenCollector and Compressor for examples.  (P. Deutsch)</span></div>
<div class="line left">
<span class="bold large"><br>Initialization</span></div>
<div class="line left">
<span class="bold small">classInit </span><span class="small">| strm type first last i </span><span class="italic small">"Initialize the type and mask tables"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[typetable&larr; String new: 256.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">strm&larr; Stream new of: ↪(<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">5 0 0377  </span><span class="italic small">"(initialize)"</span><span class="small"><br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">1 0101 0132  1 0141 0172  </span><span class="italic small">"upper and lower case letters"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">2 060 071  </span><span class="italic small">"digits"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">3 072 072  3 03 03  </span><span class="italic small">"colon, open colon"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">4 011 012  4 014 015  4 040 040  </span><span class="italic small">"TAB, LF, FF, CR, blank"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"5 is one-char tokens"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">6 042 042  6 031 031  </span><span class="italic small">"comment quote and ➲"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">7 047 047  </span><span class="italic small">"string quote"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">8 025 025  </span><span class="italic small">"high-minus"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">9 032 032  </span><span class="italic small">"&uarr;Z (format trailer)"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">10 036 036  </span><span class="italic small">"DOIT"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">11 050 051  </span><span class="italic small">"open and close paren"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ (type&larr; strm next) do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[first&larr; strm next. last&larr; strm next.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i from: (first+1 to: last+1) do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[typetable◦i&larr; type]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">of: s<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[typetbl&larr; typetable.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">token&larr; Stream default.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">source&larr; s asStream.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self step]</span></div>
<div class="line left">
<span class="bold large"><br>Main reader</span></div>
<div class="line left">
<span class="bold small">read<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑self readInto: TokenCollector default]</span></div>
<div class="line left">
<span class="bold small">readatom: ncolons </span><span class="small">| type s<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[token reset.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ [token next&larr; nextchar.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(nextchar&larr; source next)⇒[(type&larr; typetbl◦(nextchar+1))≤3]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">false]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[type=3⇒[ncolons&larr; ncolons+1]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s&larr; token contents.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">ncolons=0⇒[collector identifier: s];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">&gt;1⇒[collector otheratom: s].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s length=1⇒[collector otheratom: s] </span><span class="italic small">": or ⦂ alone"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s◦s length=072⇒[collector keyword: s];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=03⇒[collector keyword: s].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">collector otheratom: s. </span><span class="italic small">"Colon wasn&rsquo;t last character"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">readInto: collector </span><span class="small">| x <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[while⦂  nextchar  do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[x&larr; typetbl◦(nextchar+1).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"See classInit for the meanings of the type codes"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">x=4⇒ [collector separator: nextchar. nextchar&larr; source next];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=1⇒ [self readatom: 0];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=5⇒ [collector onechar: nextchar. nextchar&larr; source next];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=6⇒ [self upto: nextchar⇒[collector notify: &rsquo;Unmatched comment quote&rsquo;]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">collector comment: token contents];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=2⇒ [self readnum];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=11⇒ [[nextchar=050⇒[collector leftparen] collector rightparen].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nextchar&larr; source next];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=7⇒ [self upto: nextchar⇒[collector notify: &rsquo;Unmatched string quote&rsquo;]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">collector string: token contents];</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=8⇒ [self readnum];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=9⇒ [self upto: 015⇒[collector notify: &rsquo;&uarr;Z without CR&rsquo;]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">collector trailer: token contents];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=10⇒ [⇑collector contents];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=3⇒ [self readatom: 1]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑collector contents]</span></div>
<div class="line left">
<span class="bold small">readnum </span><span class="small">| val d e<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[val&larr; self rdint: 025.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nextchar=056⇒</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"check for decimal point"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self step.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nextchar≡false or⦂ nextchar isdigit≡false⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[collector integer: val.  collector onechar: 056]</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"was &lt;Integer&gt; .  "</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">d&larr; self rdint: ¬1.</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"fraction part"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[nextchar=0145⇒</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"check for e&lt;exponent&gt; "</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self step.  e&larr; self rdint: 025]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">e&larr; &rsquo;&rsquo;].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">collector float: val fraction: d exp: e]<br> </span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">collector integer: val]</span></div>
<div class="line left">
<span class="bold large"><br>Internal readers</span></div>
<div class="line left">
<span class="bold small">rdint: char </span><span class="italic small">"Read an integer, allow char as first char"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[token reset.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[nextchar=char⇒[token next&larr; char. self step]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ nextchar do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[nextchar&lt;060⇒[⇑token contents]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nextchar&gt;071⇒[⇑token contents]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">token next&larr; nextchar. nextchar&larr; source next].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑token contents]</span></div>
<div class="line left">
<span class="bold small">step<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[nextchar&larr; source next]</span></div>
<div class="line left">
<span class="bold small">upto: char </span><span class="small">| start </span><span class="italic small">"Knows about doubled &rsquo; in strings"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[start&larr; source position.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">token reset.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ (nextchar&larr; source next) do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[[nextchar=char⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self step. char≠047⇒[⇑false] nextchar≠047⇒[⇑false]]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">token next&larr; nextchar].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"Ran off end, back up."</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">source skip: start - 1 - source position.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑true]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪Reader under: &rsquo;Text Objects&rsquo;.</span></div>
<div class="line left">
<span class="small">Reader classInit</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"RemoteParagraph"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;RemoteParagraph&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: Object<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;file hipos lowpos&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;&rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>These instances refer to text stored on a file, typically residing on a remote<br>machine and accessed via the ether.  The representation has been chosen for<br>compactness, and the bias of ¬1000 keeps the two parts of the position in the<br>range of small integers (¬1024 to 1022) to reduce allocation and paging of objects.</span></div>
<div class="line left">
<span class="bold large"><br>As yet unclassified</span></div>
<div class="line left">
<span class="bold small">asParagraph </span><span class="small">[</span><span class="bold small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">file position &larr; self position.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑Paragraph new readFrom: file]</span></div>
<div class="line left">
<span class="bold small">asString </span><span class="small">[⇑self asParagraph text]</span></div>
<div class="line left">
<span class="bold small">fromParagraph: p </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">write me (only once!) on file</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self position &larr; file position.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">p storeOn: file]</span></div>
<div class="line left">
<span class="bold small">fromString: s </span><span class="small">[self fromParagraph: s asParagraph]</span></div>
<div class="line left">
<span class="bold small">on: file</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"Refer me to a specific file"</span></div>
<div class="line left">
<span class="bold small">position </span><span class="small">[⇑(hipos+1000)*2000 + (lowpos+1000)]</span></div>
<div class="line left">
<span class="bold small">position&larr; p<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[p &larr; p intdiv: 2000.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">hipos&larr; (p◦1) asInteger -1000.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">lowpos&larr; (p◦2) asInteger -1000]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪RemoteParagraph under: &rsquo;Text Objects&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"Textframe"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;Textframe&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: Object<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;frame para style reply1 reply2 window&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;&rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>I display a paragraph on the screen in a frame clipped by a window</span></div>
<div class="line left">
<span class="bold large"><br>Initialization</span></div>
<div class="line left">
<span class="bold small">para: para frame: frame<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[window&larr;frame.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">reply1&larr;reply2&larr;0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">style&larr;DefaultTextStyle]</span></div>
<div class="line left">
<span class="bold small">para: para frame: frame style: style<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[window&larr;frame.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">reply1&larr;reply2&larr;0]</span></div>
<div class="line left">
<span class="bold small">style: style</span></div>
<div class="line left">
<span class="bold large"><br>Scheduling</span></div>
<div class="line left">
<span class="bold small">aboutToFrame<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"My frame is about to change.  I dont care."</span><span class="small">]</span></div>
<div class="line left">
<span class="bold small">takeCursor<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"Move the cursor to the center of my window."</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user cursorloc &larr; window center]</span></div>
<div class="line left">
<span class="bold large"><br>Image</span></div>
<div class="line left">
<span class="bold small">asForm: pt </span><span class="small">| char ul ur f<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"put bits of character into a form -- when Form package in system"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[char &larr; self charofpt: pt. ul &larr; reply1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self ptofchar: char + 1. ur &larr; reply1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">f &larr; Form new size: ur x - ul x by: reply2 y - reply1 y.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">f translate: ul; scale: 1. ⇑f ]</span></div>
<div class="line left">
<span class="bold small">comp<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[window comp]</span></div>
<div class="line left">
<span class="bold small">copyto: path effect: effect </span><span class="small">| i oldmode</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"show clipped inside rect"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[  <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">path is: Point ⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[oldmode &larr; style mode. style mode: effect. window translateto: path. self show. style mode: oldmode.]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">path is: Path ⇒ [for⦂ i to: path length do⦂ [ self copyto: path◦i effect: effect] ]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">corner </span><span class="small">[⇑frame corner]</span></div>
<div class="line left">
<span class="bold small">displayat: path effect: effect clippedBy: cliprect</span><span class="small">| i oldmode </span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"show clipped inside rect"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[  <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">path is: Point ⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[oldmode &larr; style mode. style mode: effect. frame translateto: path. window &larr; cliprect. self show. style mode: oldmode.  ]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">path is: Path ⇒ [for⦂ i to: path length do⦂ [ self displayat: path◦i effect: effect] ]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">erase<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[(window inset: (¬2⌾¬2)) clear]</span></div>
<div class="line left">
<span class="bold small">extent </span><span class="small">[⇑frame extent]</span></div>
<div class="line left">
<span class="bold small">frame </span><span class="small">[⇑frame]</span></div>
<div class="line left">
<span class="bold small">frame &larr; frame<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"Change my frame and window."</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">window &larr; frame.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">height </span><span class="small">[⇑frame height]</span></div>
<div class="line left">
<span class="bold small">origin </span><span class="small">[⇑frame origin]</span></div>
<div class="line left">
<span class="bold small">outline<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[window border: 2 color: black]</span></div>
<div class="line left">
<span class="bold small">para </span><span class="small">[⇑para]</span></div>
<div class="line left">
<span class="bold small">showin: rect </span><span class="small">| old</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"show clipped inside rect"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[old &larr; window. window &larr; rect. self show. window &larr; old]</span></div>
<div class="line left">
<span class="bold small">size </span><span class="small">[⇑frame extent]</span></div>
<div class="line left">
<span class="bold small">style </span><span class="small">[⇑style]</span></div>
<div class="line left">
<span class="bold small">width </span><span class="small">[⇑frame width]</span></div>
<div class="line left">
<span class="bold small">window </span><span class="small">[⇑window]</span></div>
<div class="line left">
<span class="bold large"><br>Text</span></div>
<div class="line left">
<span class="bold small">charnearpt: pt </span><span class="small">[user croak] primitive: 58</span></div>
<div class="line left">
<span class="bold small">charofpt: pt </span><span class="small">[user croak] primitive: 58</span></div>
<div class="line left">
<span class="bold small">dopressjst: pt<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"For building justified lines in Press Format files<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">[reply1 x &larr; trailingbits.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">reply1 y &larr; internalspaces.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">reply2 y &larr; heightofline.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">[reply2 x &lt; 0 ⇒[linenotjustified]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">⇑lastcharinline]<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">user will have to back up in string to find last printing character<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">(at least non-space, cr, or tab)"</span><span class="small"><br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user croak] primitive: 64</span></div>
<div class="line left">
<span class="bold small">findmaxx: char<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[char is: Integer⇒[user croak]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self findmaxx: char asInteger] primitive: 63</span></div>
<div class="line left">
<span class="bold small">lastshown<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑reply1]</span></div>
<div class="line left">
<span class="bold small">lineheight<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑style lineheight]</span></div>
<div class="line left">
<span class="bold small">maxx: char<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self findmaxx: char. ⇑ reply1]</span></div>
<div class="line left">
<span class="bold small">measuretext: startx to: stopx string: string from: first to: last font: font<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["Returns character index of character immediately following character<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">causing exception condition.<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">Reply1</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">Exception code.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">1</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">Encountered space, cr, tab, or ascii 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">2</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">Crossed stopx.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">3</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">Both 1 and 2.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">4</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">Encountered last before hitting stopx or special character.<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">Reply2</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">Leftx of character causing exception condition."<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user croak] primitive: 103</span></div>
<div class="line left">
<span class="bold small">ptofchar: char<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self selectchar: char. ⇑reply1]</span></div>
<div class="line left">
<span class="bold small">ptofpt: pt<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self charnearpt: pt. ⇑reply1]</span></div>
<div class="line left">
<span class="bold small">put: para at: pt<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self put: para at: pt centered: false]</span></div>
<div class="line left">
<span class="bold small">put: para at: pt centered: center<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[para &larr; para asParagraph.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">window &larr; frame &larr; pt rect: 1000⌾1000.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self ptofchar: para length+1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">window growto: reply2 + (4⌾0).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[center⇒ [window moveby: pt-window center]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">window &larr; window inset: ¬3⌾¬2.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">window clear: white. self show]</span></div>
<div class="line left">
<span class="bold small">put: para at: pt maxextent: maxextent<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[para &larr; para asParagraph.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">window &larr; frame &larr; Rectangle new origin: pt extent: maxextent.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self findmaxx: para length+1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">window growto: reply2.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">window &larr; window inset: ¬3⌾¬2.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">window clear: white. self show]</span></div>
<div class="line left">
<span class="bold small">put: para centered: pt<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self put: para at: pt centered: true]</span></div>
<div class="line left">
<span class="bold small">rectofchar: char<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self selectchar: char. ⇑reply1 rect: reply2]</span></div>
<div class="line left">
<span class="bold small">scrolln: n<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑self charofpt: frame corner x ⌾ (frame origin y+(n*style lineheight))]</span></div>
<div class="line left">
<span class="bold small">selectchar: char<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[char is: Integer⇒[user croak]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self selectchar: char asInteger] primitive: 59</span></div>
<div class="line left">
<span class="bold small">show </span><span class="small">[user croak] primitive: 57</span></div>
<div class="line left">
<span class="bold small">show: para<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[para &larr; para asParagraph. self show]</span></div>
<div class="line left">
<span class="bold small">showline: first to: last lastx: lastx spaces: spaces trailingspaces: trailingspaces startrun: startrun firstrunlength: firstrunlength<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["For use in conjunction with </span><span class="bold small">measuretext</span><span class="small"> primitive.<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">Characters </span><span class="bold small">first</span><span class="small"> through </span><span class="bold small">last</span><span class="small"> will be displayed, clipped by the </span><span class="bold small">frame</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">and </span><span class="bold small">window</span><span class="small">.  The </span><span class="bold small">lastx</span><span class="small"> should be the lastx of </span><span class="bold small">last</span><span class="small">.  If justification<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">is on in </span><span class="bold small">para</span><span class="small"> and </span><span class="bold small">spaces</span><span class="small"> is &gt; 0, the line will be justified.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">Passing </span><span class="bold small">spaces</span><span class="small"> as 0 causes suppression of justificaton even if<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">justification is turned on in </span><span class="bold small">para</span><span class="small">; space characters will be displayed<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">normally even when </span><span class="bold small">spaces</span><span class="small"> is 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold small">Trailingspaces</span><span class="small"> is needed for justification.  </span><span class="bold small">Startrun</span><span class="small"> is an integer index<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">into the runs, indicating which run to start on.  </span><span class="bold small">Firstrunlength</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">is the number of characters remaining in run </span><span class="bold small">startrun</span><span class="small">.  Note that<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while runs in a paragraph are allocated as a string, </span><span class="bold small">startrun</span><span class="small"> will<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">be considered a word index.<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold small">maxascent</span><span class="small"> and </span><span class="bold small">maxdescent</span><span class="small"> in </span><span class="bold small">style</span><span class="small"> must be nonnil to avoid a croak."<br><br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user croak] primitive: 104</span></div>
<div class="line left">
<span class="bold large"><br>Conversion</span></div>
<div class="line left">
<span class="bold small">makeParagraph </span><span class="small">["</span><span class="italic small">simulate ListPane for hardcopy</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">para≡nil⇒ [para &larr; &rsquo;NIL !&rsquo; asParagraph]]</span></div>
<div class="line left">
<span class="bold large"><br>Printing</span></div>
<div class="line left">
<span class="bold small">hardcopy </span><span class="small">| pf [user displayoffwhile⦂ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pf &larr; dp0 pressfile: &rsquo;frame.press&rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">window hardcopy: pf.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self hardcopy: pf.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pf close; toPrinter]]</span></div>
<div class="line left">
<span class="bold small">hardcopy: pf </span><span class="small">| r first last lasty len parag left right top bottom [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[para≡nil⇒ [self makeParagraph]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">parag &larr; para asParagraph.<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">frame=window⇒ [parag presson: pf in: (pf transrect: window) style: style]<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">left &larr; frame minX max: window minX.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">right &larr; window maxX min: frame maxX.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bottom &larr; window maxY min: frame maxY.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">top &larr; window minY max: frame minY.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">lasty &larr; top + 4. "slop for char finding and making print rect larger"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">first &larr; self charofpt: left+1 ⌾ lasty.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">len &larr; parag length.<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">frame minX ≥ left and⦂ frame maxX ≤ right⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"paragraph is inset and may be scrolled"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(parag copy: first to: len) presson: pf in: (<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pf transrect: (left ⌾ top rect: right ⌾ (bottom+4))) style: style]<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">yuk, frame extends left or right so do it a line at a time for clipping</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ (first &lt; len and⦂ lasty &lt; bottom) do⦂ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">last &larr; (self charofpt: right-1 ⌾ lasty) min: len.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">r &larr; self rectofchar: last.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">lasty &larr; lasty + r height.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(parag copy: first to: last) presson: pf in:<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(pf transrect: (left ⌾ (r minY) rect: right ⌾ lasty)) style: style.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">first &larr; last+1]]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪Textframe under: &rsquo;Text Objects&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"ParagraphEditor"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;ParagraphEditor&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: TextImage<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;oldEntity sel&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;on off &rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>This version of ParagraphEditor (for use in CodePanes) is based on TextImage</span></div>
<div class="line left">
<span class="bold large"><br>Scheduling</span></div>
<div class="line left">
<span class="bold small">enter </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">begintypein &larr; false.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self show; select]</span></div>
<div class="line left">
<span class="bold small">leave </span><span class="small">[self complement: off]</span></div>
<div class="line left">
<span class="bold large"><br>Editing</span></div>
<div class="line left">
<span class="bold small">again  </span><span class="small">| many<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[many&larr; user leftShiftKey.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self fintype⇒ [Scrap &larr; Scrap text. self select]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">many⇒[while⦂ self againOnce do⦂ []]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self againOnce⇒[] frame flash]</span></div>
<div class="line left">
<span class="bold small">againOnce  </span><span class="small">| t<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[t &larr; para findString: Deletion startingAt: c2.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">t=0⇒ [⇑false]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self unselect.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">c1 &larr; t.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">c2 &larr; c1 + Deletion length.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self replace: Scrap; selectAndScroll]</span></div>
<div class="line left">
<span class="bold small">copy </span><span class="small">[Scrap &larr; self selection]</span></div>
<div class="line left">
<span class="bold small">cut </span><span class="small">[self fintype; replace: nullString; complement. Scrap &larr; Deletion]</span></div>
<div class="line left">
<span class="bold small">paste </span><span class="small">[self fintype; replace: Scrap; selectAndScroll]</span></div>
<div class="line left">
<span class="bold small">realign </span><span class="small">[self align. sel &larr; on]</span></div>
<div class="line left">
<span class="bold small">undo </span><span class="small">[self fintype; replace: Deletion; complement]</span></div>
<div class="line left">
<span class="bold large"><br>Public Messages</span></div>
<div class="line left">
<span class="bold small">contents </span><span class="small">[⇑para]</span></div>
<div class="line left">
<span class="bold small">Deletion &larr; s </span><span class="small">[Deletion &larr; s]</span></div>
<div class="line left">
<span class="bold small">fixframe: f </span><span class="small">| dy  [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">dy &larr; [frame≡nil⇒ [0] self frameoffset].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">window &larr; f copy.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">frame &larr; Rectangle new origin: window origin + (2⌾dy)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> extent: window width-4 ⌾ 9999.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑window]</span></div>
<div class="line left">
<span class="bold small">formerly </span><span class="small">[⇑oldEntity]</span></div>
<div class="line left">
<span class="bold small">formerly: oldEntity</span></div>
<div class="line left">
<span class="bold small">frame&larr; f </span><span class="small">[self fixframe: f]</span></div>
<div class="line left">
<span class="bold small">kbd </span><span class="small">| more char "key struck on the keyboard"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[c1&lt;c2 and⦂ self checklooks⇒[⇑self show complement]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">more &larr; Set new string: 16.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[begintypein⇒[] Deletion &larr; self selection. begintypein &larr; c1].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ (char &larr; user kbdnext) do⦂ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">char<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=bs⇒ ["</span><span class="italic small">backspace</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">more empty⇒ [begintypein &larr; begintypein min: (c1 &larr; 1 max: c1-1)]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">more skip: ¬1];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=cut⇒ [self fintype. [c1=c2⇒[c2&larr; c1+1 min: para length+1]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self replace: nullString; complement. Scrap &larr; Deletion. ⇑self];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=paste⇒ [⇑self paste];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=ctlw⇒ ["</span><span class="italic small">ctl-w for backspace word</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[more empty⇒ [] self replace: more. more reset. c1 &larr; c2].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">c1 &larr; 1 max: c1-1.</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ [c1&gt;1 and⦂ (para◦(c1-1)) tokenish] do⦂ [c1 &larr; c1-1].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">begintypein &larr; begintypein min: c1];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=esc⇒ ["</span><span class="italic small">select previous type-in</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[more empty⇒[self unselect]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self replace: more. c1 &larr; c2].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self fintype.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">c1 &larr; c2-Scrap length.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑self complement]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">just a normal character</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">more next&larr; char].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self replace: more.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">c1 &larr; c2.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self selectAndScroll]</span></div>
<div class="line left">
<span class="bold small">keyset</span></div>
<div class="line left">
<span class="bold small">Scrap &larr; s </span><span class="small">[Scrap &larr; s]</span></div>
<div class="line left">
<span class="bold small">scrollby: n </span><span class="small">| oldw [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">n &larr; (n * self lineheight) max: self frameoffset.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">frame moveby: 0⌾(0-n).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">n abs ≥ window height⇒ [self show; select]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">need only to reshow part of window</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">oldw &larr; window.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">window &larr; [n &lt; 0⇒ [window inset: 0⌾0 and: 0⌾(0-n)]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">window inset: 0⌾n and: 0⌾0].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">window blt: window origin - (0⌾n) mode: storing.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[n&lt;0⇒ [window corner y &larr; window origin y - n]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">window origin y &larr; window corner y - n].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self show; select.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">window &larr; oldw]</span></div>
<div class="line left">
<span class="bold small">scrollPos </span><span class="small">| t [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">t &larr; self height - self lineheight.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">t=0⇒ [⇑0.0]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑0.0 - self frameoffset / t]</span></div>
<div class="line left">
<span class="bold small">scrollTo: f </span><span class="small">[self scrollUp: self frameoffset + (f* self height) - 4]</span></div>
<div class="line left">
<span class="bold small">scrollUp: n </span><span class="small">[self scrollby: n/self lineheight]</span></div>
<div class="line left">
<span class="bold small">select: t </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self complement: off.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">c1 &larr; c2 &larr; t.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self selectAndScroll]</span></div>
<div class="line left">
<span class="bold small">selectAndScroll </span><span class="small">| l dy c1y [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">l &larr; self lineheight.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self select.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">c1y &larr; (self ptofchar: c1) y.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">dy &larr; c1y - window minY.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[dy ≥ 0⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">dy &larr; c1y + l - 1 - window maxY max: 0]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">dy≠ 0⇒ [self scrollby: (dy abs+l-1) / l * dy sign]]</span></div>
<div class="line left">
<span class="bold small">selecting </span><span class="small">| pt t [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">t &larr; self charofpt: (pt &larr; user mp).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self complement: off; fintype.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[t=c1 and⦂ c1=c2⇒ [  "bugged hairline - maybe double-bug"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ [user redbug and⦂ t=(self charofpt: user mp)]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">do⦂ [].</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"wait for unclick or drawing selection"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user redbug≡false⇒[self selectword; select. ⇑true]]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">sel &larr; on.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑super select: pt]</span></div>
<div class="line left">
<span class="bold small">selection </span><span class="small">[para text empty⇒ [⇑para copy] ⇑para copy: c1 to: c2-1]</span></div>
<div class="line left">
<span class="bold small">selectionAsStream </span><span class="small">[⇑Stream new of: para text from: c1 to: c2-1]</span></div>
<div class="line left">
<span class="bold small">show </span><span class="small">[self primshow. sel &larr; off]</span></div>
<div class="line left">
<span class="bold small">typing </span><span class="small">[self kbd]</span></div>
<div class="line left">
<span class="bold small">unselect </span><span class="small">[self complement: off]</span></div>
<div class="line left">
<span class="bold large"><br>Private</span></div>
<div class="line left">
<span class="bold small">checklooks </span><span class="small">| t val mask [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">t &larr; ↪(166 150 137 151   230 214 201 215<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">135 159 144 143 128 127 129 131 180 149<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">199 223 208 207 192 191 240 226) find: user kbck.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">t=0⇒[⇑false]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user kbd.<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[oldEntity⇒[] oldEntity &larr; para. para &larr; para copy].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">t=25⇒[para &larr; para toBravo]; "ctl-T" <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> =26⇒[para &larr; para fromBravo]. "ctl-F" <br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">val &larr; ↪(1 2 4 256   ¬1 ¬2 ¬4 256  "ctl-b i - x   B I ¬ X"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">0 16 32 48 64 80 96 112 128 144  "ctl-0 1 ... 9"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">160 176 192 208 224 240)◦t.  "ctl-shift-0 1 ... 5"<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[val=256⇒[mask&larr; 0377.  val&larr; 0]</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"reset all"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">val&lt;0⇒[mask&larr; 0-val.  val&larr; 0]</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"reset emphasis"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">val&gt;0 and⦂ val&lt;16⇒[mask&larr; val]</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"set emphasis"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">mask&larr; 0360].</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"set font"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">para maskrun: c1 to: c2-1 under: mask to: val]</span></div>
<div class="line left">
<span class="bold small">classInit </span><span class="small">[on &larr; 1. off &larr; 0]</span></div>
<div class="line left">
<span class="bold small">complement </span><span class="small">[self complement: on]</span></div>
<div class="line left">
<span class="bold small">complement: nsel </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nsel = sel⇒ ["already that way"]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nsel = on and⦂ (user rawkbck or⦂ user redbug)⇒ ["slippage"]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">sel &larr; nsel.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self reversefrom: c1 to: c2]</span></div>
<div class="line left">
<span class="bold small">frameoffset </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"a useful number"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑frame minY - window minY]</span></div>
<div class="line left">
<span class="bold small">height </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self selectchar: para length+1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑reply2 y - frame minY]</span></div>
<div class="line left">
<span class="bold small">primshow </span><span class="small">[user croak] primitive: 57</span></div>
<div class="line left">
<span class="bold small">replace: t </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[oldEntity⇒ [] oldEntity &larr; para. para &larr; para copy].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[begintypein⇒ [] Deletion &larr; self selection].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">para replace: c1 to: c2-1 by: t.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">c2 &larr; c1 + t length.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self show]</span></div>
<div class="line left">
<span class="bold small">select </span><span class="small">[self selectIn: nil]</span></div>
<div class="line left">
<span class="bold small">selectIn: w </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">sel &larr; off.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[c1≡nil⇒ [c1 &larr; c2 &larr; 1]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self complement: on]</span></div>
<div class="line left">
<span class="bold small">selectRange </span><span class="small">[⇑c1 to: c2-1]</span></div>
<div class="line left">
<span class="bold small">selectRange: r </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"self complement: off"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">c1 &larr; r start.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">c2 &larr; r stop<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"self complement: on"]</span></div>
<div class="line left">
<span class="bold small">selectword </span><span class="small">| a b dir t level open close s slen<br>[<br>"</span><span class="italic small">Select bracketed or word range, as a result of double-bug.</span><span class="small">"<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">a&larr; b&larr; dir&larr; ¬1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s &larr; para text.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">slen &larr; s length.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">level &larr; 1.<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">open &larr; &rsquo;([{&lt;&rsquo;&rsquo;"<br>&rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">close &larr; &rsquo;)]}&gt;&rsquo;&rsquo;"<br>&rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[c1≤1⇒[dir&larr;1. t&larr;c1]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">c1&gt; slen⇒[t&larr;c1-1]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">t&larr;open find: (a&larr; para◦(c1-1)). t&gt;0⇒</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">delim on left</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[dir&larr;1. b&larr;close◦t. t&larr;c1-1]</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">match to the right</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">t&larr;close find: (a&larr; para◦c1). t&gt;0⇒</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">delim on right</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[dir&larr;¬1. b&larr;open◦t. t&larr;c1]</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">match to the left</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">a&larr; ¬1. t&larr;c1].</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">no delims - select a token</span><span class="small">"<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">until⦂ (level=0 or⦂ [dir=1⇒[t≥slen] t≤1]) do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[s◦(t&larr; t+dir) = b⇒ [level&larr; level-1];</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">leaving nest</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">= a⇒ [level&larr; level+1].</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">entering nest</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">a=¬1⇒[(s◦t) tokenish⇒</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">token check goes left </span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[t=1⇒[c1&larr; dir&larr; 1. t&larr; c2]]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">dir=¬1⇒[c1 &larr; t+1. dir&larr;1. t&larr;c2-1]</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">then right</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">level&larr; 0]]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[level≠0⇒[t&larr; t+dir]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">dir=1⇒[c2&larr; t min: slen+1] c1&larr; t+1<br>]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪ParagraphEditor under: &rsquo;Text Objects&rsquo;.</span></div>
<div class="line left">
<span class="small">ParagraphEditor classInit</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"TextStyle"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;TextStyle&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: Object<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;fonts "&lt;Vector of Strings or Integers&gt; which are the fonts.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">An integer entry has a vertical offset in the high 8 bits, a 1 in<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">the 200-bit for descent, and another font number (zero-relative)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">in the bottom 4 bits"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">tabandspace "&lt;Integer&gt; =256*tabwidth + spacewidth"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">maxascent "&lt;Integer&gt; max ascent for this fontset"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">maxdescent "&lt;Integer&gt; max descent for this fontset"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">mode "&lt;Integer&gt; =0 for normal, =4 for white-on-black"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fontnames "&lt;Vector of Strings&gt; corresponding to the fonts"&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;&rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>I am a specification of how to display a paragraph.  I include a font set, a tab spacing, a space size, etc.  If I do not specify ascent and descent from the baseline, then each line displayed will adjust to its tallest characters.</span></div>
<div class="line left">
<span class="bold large"><br>Initialization</span></div>
<div class="line left">
<span class="bold small">default<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[tabandspace &larr; mode &larr; 0. self mode: 0; tab: 20; space: 5.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">fonts &larr; Vector new: 16. fontnames &larr; Vector new: 16.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self setfont: 0 name: &rsquo;CREAM10&rsquo;.</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"Put default font in font 0"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">mode<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑ mode]</span></div>
<div class="line left">
<span class="bold small">mode: mode</span></div>
<div class="line left">
<span class="bold small">space<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑ (tabandspace land: 0377)]</span></div>
<div class="line left">
<span class="bold small">space: t<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[tabandspace &larr; (tabandspace land: 0177400) + (t land: 0377)]</span></div>
<div class="line left">
<span class="bold small">tab<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑ ((tabandspace land: 0177400) lshift: ¬8)]</span></div>
<div class="line left">
<span class="bold small">tab: t<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[tabandspace &larr; (tabandspace land: 0377) + (t lshift: 8)]</span></div>
<div class="line left">
<span class="bold large"><br>Fonts</span></div>
<div class="line left">
<span class="bold small">fontfamily: n </span><span class="small">| s char<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"return the family name taken out of fontnames"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s &larr; Stream default.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ char from: fontnames ◦ n do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[char isletter⇒ [s next &larr; char]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑s contents]]</span></div>
<div class="line left">
<span class="bold small">fontnames </span><span class="small">[⇑fontnames]</span></div>
<div class="line left">
<span class="bold small">fonts </span><span class="small">[⇑fonts]</span></div>
<div class="line left">
<span class="bold small">fontsize: n </span><span class="small">| s c size<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"return size from fontname"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">size &larr; 0. s &larr; (fontnames ◦ n) asStream.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ (c &larr; s next) isletter do⦂ [].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ [size &larr; size*10 + (c - 060). c &larr; s next] do⦂ [].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑size]</span></div>
<div class="line left">
<span class="bold small">setfont: n fromfile: name<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self setfont: n name: name fromstring: (dp0 oldFile: name + &rsquo;.strike.&rsquo;) contents]</span></div>
<div class="line left">
<span class="bold small">setfont: n name: name </span><span class="small">| ucn</span><span class="bold small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[FontDict has: (ucn&larr; name asUppercase)⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self setfont: n name: ucn fromstring: FontDict◦ucn]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self setfont: n fromfile: name]</span></div>
<div class="line left">
<span class="bold small">setfont: n name: name fromstring: string<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"Should update maxascent, maxdescent"</span><span class="bold small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[fontnames◦(n+1) &larr; name asUppercase.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">fonts◦(n+1) &larr; string.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">FontDict insert: fontnames◦(n+1) with: string]</span></div>
<div class="line left">
<span class="bold small">setoffsetfont: n from: m by: d<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[fonts◦n &larr; m + [d&lt;0⇒ [0200] 0] + (d lshift: 8)]</span></div>
<div class="line left">
<span class="bold small">writeset: styleindex<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self writeset: styleindex as: fontnames◦(styleindex+1)]</span></div>
<div class="line left">
<span class="bold small">writeset: styleindex as: name</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"write out a formset on name with strike extention"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">name &larr; name + &rsquo;.strike.&rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(dp0 file: name) append: fonts◦ (styleindex+1) ; close.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold large"><br>Access</span></div>
<div class="line left">
<span class="bold small">heightofset: styleindex<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"Return height of formset in style"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑(fonts◦(styleindex+1) word: 6) +<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(fonts◦(styleindex+1) word: 7)]</span></div>
<div class="line left">
<span class="bold small">lineheight<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[((maxascent ≡ nil) or: (maxdescent ≡ nil)) ⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑((fonts◦1) word: 6) + ((fonts◦1) word: 7)]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑maxascent+maxdescent]</span></div>
<div class="line left">
<span class="bold small">maxascent<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑ maxascent ]</span></div>
<div class="line left">
<span class="bold small">maxascent: maxascent</span></div>
<div class="line left">
<span class="bold small">maxdescent<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ ⇑ maxdescent ]</span></div>
<div class="line left">
<span class="bold small">maxdescent: maxdescent</span></div>
<div class="line left">
<span class="bold small">maxwidthofset: styleindex<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"Return maximum width of formset in style"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑(fonts◦(styleindex+1) word: 4)]</span></div>
<div class="line left">
<span class="bold small">nameofset: styleindex<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"Return name of formset in style"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑(fontnames◦(styleindex+1))]</span></div>
<div class="line left">
<span class="bold small">strikeofset: styleindex<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"Return strike of formset in style"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑(fonts◦(styleindex+1))]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪TextStyle under: &rsquo;Text Objects&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"TokenCollector"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;TokenCollector&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: Object<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;sink parenstack&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;&rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>Provides standard token-collecting behavior for Reader .<br>See Reader-readInto: for more insight.  (P. Deutsch)</span></div>
<div class="line left">
<span class="bold large"><br>Initialization</span></div>
<div class="line left">
<span class="bold small">default<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self to: (Vector new: 20)]</span></div>
<div class="line left">
<span class="bold small">to: v </span><span class="italic small">"Initialize"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[sink&larr; v asStream.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">parenstack&larr; (Vector new: 5) asStream]</span></div>
<div class="line left">
<span class="bold large"><br>Finalization</span></div>
<div class="line left">
<span class="bold small">contents </span><span class="italic small">"Close all parentheses first"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[until⦂ parenstack empty do⦂ [self rightparen].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑sink contents]</span></div>
<div class="line left">
<span class="bold small">next&larr; obj </span><span class="small">[sink next&larr; obj]</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"subclasses can override easily"</span></div>
<div class="line left">
<span class="bold small">notify: errorString<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[user notify: errorString]</span></div>
<div class="line left">
<span class="bold large"><br>Constructors</span></div>
<div class="line left">
<span class="bold small">comment: s</span></div>
<div class="line left">
<span class="bold small">float: i fraction: f exp: e<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self next&larr; (i+&rsquo;.&rsquo;+f+&rsquo;e&rsquo;+e) asFloat]</span></div>
<div class="line left">
<span class="bold small">identifier: s<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self next&larr; s unique]</span></div>
<div class="line left">
<span class="bold small">integer: s<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self next&larr; s asInteger]</span></div>
<div class="line left">
<span class="bold small">keyword: s<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self next&larr; s unique]</span></div>
<div class="line left">
<span class="bold small">leftparen<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[parenstack next&larr; sink.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">sink&larr; (Vector new: 10) asStream]</span></div>
<div class="line left">
<span class="bold small">onechar: c </span><span class="small">| x<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[x&larr; String new: 1. x◦1&larr; c. self next&larr; x unique]</span></div>
<div class="line left">
<span class="bold small">otheratom: s<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self next&larr; s unique]</span></div>
<div class="line left">
<span class="bold small">rightparen<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[parenstack empty⇒[] </span><span class="italic small">"Error will be caught elsewhere"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">parenstack last next&larr; sink contents.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">sink&larr; parenstack pop]</span></div>
<div class="line left">
<span class="bold small">separator: c</span></div>
<div class="line left">
<span class="bold small">string: s<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self next&larr; s]</span></div>
<div class="line left">
<span class="bold small">trailer: s</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪TokenCollector under: &rsquo;Text Objects&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"FieldNameCollector"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;FieldNameCollector&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: TokenCollector<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;&rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>This class collects identifiers as Strings (not UniqueStrings)<br>for scanning of class field names (Class.instvars)<br>by the compiler(Generator) and debugger(VariablePane)</span></div>
<div class="line left">
<span class="bold large"><br>Valid fields</span></div>
<div class="line left">
<span class="bold small">identifier: s </span><span class="small">[sink next&larr; s]</span></div>
<div class="line left">
<span class="bold large"><br>Invalid fields</span></div>
<div class="line left">
<span class="bold small">leftparen </span><span class="small">[self next&larr; &rsquo;(&rsquo;] "just for error message"</span></div>
<div class="line left">
<span class="bold small">next&larr; value<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[user notify: &rsquo;Invalid field name: &rsquo;+value asString]</span></div>
<div class="line left">
<span class="bold small">rightparen </span><span class="small">[self next&larr; &rsquo;)&rsquo;] "just for error message"</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪FieldNameCollector under: &rsquo;Text Objects&rsquo;.</span></div>
    <div class="line left">
<span class="small">&rsquo;From Smalltalk 5.5k XM November 24 on 22 November 1980 at 2:57:08 am.&rsquo;<br></span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large">"FontWindow"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;FontWindow&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: Object<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;frame font fontht fontraster fontxtabl bitsetter char charx charwid charstr altostyle fontnumber clearframe scale boxer&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;fontmenu &rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>I am a window that displays one blown up character at a time of a strike-format font</span></div>
<div class="line left">
<span class="bold large"><br>Help</span></div>
<div class="line left">
<span class="bold small">help<br></span><span class="small">[</span><span class="italic small">"<br>**sysFontWindow is declared in the Smalltalk dictionary, and bound to the font window displayed on the screen of most system releases -- intended to provide an easy way to play around with the font editor.<br>**to create a window for editing default font 0 at middle-click:<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small"> user schedule: (sysFontWindow &larr; FontWindow new<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">altostyle: DefaultTextStyle<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">fontnumber: 1<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">at: (OriginCursor showwhile⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">[user waitbug ⇒[user mp]])).<br>**to create a new font<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">yourfont &larr; FontWindow new newfont: 16 maxcharwidth: 16 min: 0<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">max: 177 ascent: 12 kern: 0.<br><br>**to edit newly created font<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">yourtextstyle setfont: n name: yourfont.</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">**insert it into a TextStyle<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">**now create a window as above with yourtextstyle and appropriate<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">fontnumber<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small"><br><br>**examples of manual manipulation of yourfontwindow:<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">sysFontWindow setascent: 2.</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">**Deltas -- for entire font**<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">sysFontWindow setascent: ¬3.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">sysFontWindow setdescent: 2.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">sysFontWindow setdescent: ¬2.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">sysFontWindow setchar: 046.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">sysFontWindow setwidth: 5.</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">**Absolute--for char in window. <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">Useful for characters of zero width.**<br>"</span><span class="small">]</span></div>
<div class="line left">
<span class="bold large"><br>Initialization</span></div>
<div class="line left">
<span class="bold small">altostyle: altostyle fontnumber: fontnumber at: origin<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"set up an instance"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[fontmenu≡nil⇒[self init]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">scale &larr; 9. charstr &larr; String new: 1. char &larr; 65. charstr◦1 &larr; char.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitsetter &larr; BitBlt init.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">boxer &larr; Rectangle new<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">origin: 0 ⌾ 0 extent: (scale-1) ⌾ (scale-1).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">frame &larr; Rectangle  new origin: origin  extent:  scale ⌾ 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">clearframe &larr; Rectangle  new origin: origin  extent:  scale ⌾ 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self setfont: altostyle fonts◦fontnumber.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">classInit<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[fontmenu &larr; Menu new string:<br>&rsquo;strike<br>set width<br>debug<br>move<br>close&rsquo;]</span></div>
<div class="line left">
<span class="bold large"><br>Scheduler</span></div>
<div class="line left">
<span class="bold small">eachtime</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"while active"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[clearframe has: user mp⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[user redbug ⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self setbit: user mp color: black]</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"make dot black"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user yellowbug ⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self setbit: user mp color: white]</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"make dot white"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user bluebug ⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[fontmenu bug<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=1⇒[self strike];</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"put strike of font in dialogue window"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=2⇒[self setwidth];</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"grow character"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=3⇒[self updateseglength: font raster: fontraster.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self updatemaxwidth.</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"clean things up"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user notify: &rsquo;font debugging&rsquo;];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=4⇒[self frame];</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"move fontwindow"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=5⇒[clearframe clear.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self updateseglength: font raster: fontraster.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self updatemaxwidth.</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"clean things up"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user unschedule: self. ⇑false]]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user kbck⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[char &larr; user kbd. self setchar: char]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user anybug⇒[⇑false]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small"> firsttime</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"upon entry"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">clearframe has: user mp⇒[self show]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑false<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">lasttime</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"upon exit"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[]</span></div>
<div class="line left">
<span class="bold large"><br>Editing</span></div>
<div class="line left">
<span class="bold small">setascent: ascentdelta </span><span class="small">| updatedfont ascent<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> </span><span class="italic small">"ascent delta"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">ascent &larr; font word: 6.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ascent + ascentdelta &lt; 0 ⇒[ascentdelta &larr; 0 - ascent]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ascentdelta &gt; 0 ⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">updatedfont &larr; String new: (2 * fontraster * ascentdelta).</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"grow"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">updatedfont all &larr;  0.</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"fill with white"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">updatedfont &larr;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"add oldfont header and new space together"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(font◦(1 to: 18) concat: updatedfont◦(1 to: updatedfont length)).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">updatedfont &larr;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"now add on rest of old font"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(updatedfont concat: font◦(19 to: font length)).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">updatedfont &larr; (font◦(1 to: 18) concat:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"shrink"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">font◦((19 + (0 - (2 * fontraster * ascentdelta))) to: font length)).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">updatedfont word: 6 &larr; ascent + ascentdelta.</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"reset ascent word in font"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self setfont: updatedfont.</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"updatedfont now font of interest"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self updateseglength: font raster: fontraster.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">setbit: bitpoint color: color</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"turn bits on, off"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">| x y<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitpoint &larr;  bitpoint - frame origin.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> x &larr; (0 max: (charwid-1)) min: (bitpoint x/scale).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> y &larr; (0 max: (fontht-1)) min: (bitpoint y/scale).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> boxer moveto: frame origin + ((scale*x) ⌾ (scale*y)).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> boxer color: color mode: storing.</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"turn bit on/off in blowup"</span><span class="small"><br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitsetter destraster &larr; fontraster.</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"set up bitblt table."</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitsetter destx &larr; charx + x.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitsetter desty &larr; y.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitsetter destbase &larr; font; dstrike&larr; true.  </span><span class="italic small">"lock font and get core ptr"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitsetter fill: storing color: color.</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"turn bit on/off in font"</span><span class="small">]</span></div>
<div class="line left">
<span class="bold small">setchar: char<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">charstr◦1 &larr;  char.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[((font word: 2) ≤ char) and: (char ≤ (font word: 3))⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[char &larr; char - (font word: 2)]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">char &larr; ((font word: 3) - (font word: 2)) + 1].</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"char out of range"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">charx &larr; (font word: (fontxtabl+ (char))).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">charwid &larr; (font word: (fontxtabl + char+1)) - charx.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">clearframe clear.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">frame extent &larr; charwid ⌾  fontht.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">clearframe &larr;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">frame inset: ¬2 ⌾ ¬2</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"for clearing everything including outline"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">and: (charwid - (charwid * scale + 2)) ⌾ (fontht - (fontht * scale + 2)).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self show.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">setdescent: descentdelta </span><span class="small">| updatedfont descent space<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"descent delta"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">descent &larr; font word: 7.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[descent + descentdelta &lt; 0 ⇒ [ descentdelta &larr; 0 - descent]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[descentdelta &gt; 0 ⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[space &larr; String new: 2 * fontraster * descentdelta.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">space all &larr; 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">updatedfont &larr; (font ◦ (1 to: fontxtabl - 1 * 2) concat: space).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">updatedfont &larr; (self appendxtable: updatedfont).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">updatedfont &larr;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(font ◦ (1 to: ((fontxtabl - 1 * 2) + (fontraster * descentdelta * 2)))).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">updatedfont &larr; (self appendxtable: updatedfont).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">updatedfont word: 7 &larr;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">descent + descentdelta.</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"reset descent word in font"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self setfont: updatedfont.</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"updatedfont now font of interest"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self updateseglength: font raster: fontraster.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">setfont: font<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">altostyle fonts ◦ fontnumber &larr; font.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">fontraster &larr; font word: 9.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">fontht &larr; (font word: 6) + ( font word: 7).</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"ascent + descent"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">fontxtabl &larr; fontraster * fontht + 9 </span><span class="italic small">"header"</span><span class="small"> + 1 </span><span class="italic small">"for 0 addressing"</span><span class="small">.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitsetter width &larr;  1. bitsetter height &larr; 1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self setchar: charstr◦1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">setwidth </span><span class="small">| newextentx outlineframe<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"get new size"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">outlineframe &larr; clearframe inset: 1 ⌾ 1 and: 0 ⌾ 1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">OriginCursor showwhile⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[user waitbug⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[while⦂ user anybug do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[outlineframe growto:<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">((clearframe origin x + 2) +<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(newextentx &larr; (user mp x - clearframe origin x + 2) | scale))<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> ⌾ (outlineframe corner y).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">outlineframe border: 2 color: black.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">outlineframe border: 2 color: background<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">outlineframe border: 2 color: black.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self setwidth: newextentx / scale.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">setwidth: delta<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">| fontrightx newraster newxtabl newmaxwidth updatedfont i<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"change in width"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">delta &larr; delta - charwid. delta = 0 ⇒ [self show. ⇑false].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">fontrightx &larr;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">font word: (fontxtabl + ((font word: 3) - (font word: 2)) + 2).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">newraster &larr;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[(fontrightx + 15 / 16) ≠ (i &larr; (fontrightx + delta + 15 / 16)) ⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ i ] fontraster].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">newxtabl &larr; newraster * fontht + 9 </span><span class="italic small">"header"</span><span class="small"> + 1 </span><span class="italic small">"for 0 addressing"</span><span class="small">.<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">XeqCursor showwhile⦂ <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">updatedfont &larr; String new:<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(9 </span><span class="italic small">"header"</span><span class="small"> + (newraster * fontht </span><span class="italic small">"bits"</span><span class="small">)) * 2.</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"grow/shrink the bits"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: 8 do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[updatedfont word: i &larr; font word: i].</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"fill in header of new font"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">updatedfont word: 9 &larr; newraster.</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"set raster in new font"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"copy the xtable"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">updatedfont &larr; (self appendxtable: updatedfont).<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"set up to copy up to old bits of char"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitsetter destraster &larr; newraster.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitsetter destx &larr; 0. bitsetter desty &larr; 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitsetter sourcex &larr; 0. bitsetter sourcey &larr; 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitsetter width &larr; charx + charwid.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitsetter height &larr; fontht.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitsetter sourceraster &larr; fontraster.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitsetter destbase &larr; updatedfont.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitsetter sourcebase &larr; font.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitsetter sstrike&larr; true; dstrike&larr; true.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitsetter copy: storing.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"if char grown, clean out right side of char"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">delta&lt; 0 ⇒[]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitsetter destx &larr; charx + charwid.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitsetter width &larr; delta.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitsetter fill: storing color: 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"now copy remainder of font"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitsetter destx &larr; charx + charwid + delta.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitsetter width &larr; fontrightx - charx - charwid.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitsetter sourcex &larr; charx + charwid.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitsetter copy: storing.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"shift x-vals"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i from: ((char + 1)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">to: (2 + (updatedfont word: 3) - (updatedfont word: 2) </span><span class="italic small">"max"</span><span class="small">)) do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[updatedfont word: (newxtabl + i) &larr;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">delta + (updatedfont word: (newxtabl +i ))].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">clearframe clear.</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"clear out old version of character"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self setfont: updatedfont.</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"set up the new copy of the font"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self updateseglength: font raster: fontraster.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self updatemaxwidth.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold large"><br>Image</span></div>
<div class="line left">
<span class="bold small">frame<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[clearframe clear.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">frame moveto:<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(OriginCursor showwhile⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[user waitbug⇒[user mp]]).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self setchar: char.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">show </span><span class="small">|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"refresh window"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">tempframe showrun showpara<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">showrun &larr; String new: 2.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">showrun word: 1 &larr;  16 * (fontnumber-1) + 0177400.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">showpara &larr; Paragraph new text: charstr runs: showrun alignment: 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">tempframe &larr; Textframe new para: showpara frame: frame style: altostyle.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">tempframe show.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">frame blowup: (frame origin) by: scale.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold large"><br>Strike format</span></div>
<div class="line left">
<span class="bold small">appendxtable: thefont<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"put fontⓢxtable on end of a grown/shrunk font"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">thefont &larr; thefont concat: font ◦ ((fontxtabl * 2 - 1) to: font length).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑thefont.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">cufixup </span><span class="small">|  </span><span class="italic small">"Carnegie-Mellon fixup for scale compatibility"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[boxer extent &larr; (scale-1)⌾(scale-1).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">frame extent &larr; scale⌾0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">clearframe extent &larr; scale⌾0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">makecu: name scale: cuscale  </span><span class="italic small">"Put out font in Carnegie-Mellon format"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">| f svscale svchar  bitwidth i bitmover bits<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[f &larr; dp0 file: name + &rsquo;.cu.&rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self updateseglength: font raster: fontraster.  self updatemaxwidth.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">svscale &larr; scale. scale &larr; cuscale.  svchar &larr; char.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self cufixup.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">f nextword &larr; fontht*scale.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">f nextword &larr; (bitwidth &larr; (font word: 4)) * scale + 15 / 16.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bits &larr; String new: ((fontht * scale) * ((bitwidth * scale + 15)/16)) * 2.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitmover &larr; BitBlt init.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitmover destbase &larr; bits lock.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitmover destraster &larr; bitwidth * scale + 15 / 16.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitmover destx &larr; 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitmover desty &larr; 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitmover sourcebase &larr; mem◦066.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitmover sourceraster &larr; (user screenrect extent x) + 15/16.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitmover sourcex &larr; frame origin x.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitmover sourcey &larr; frame origin y.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i from: ((font word: 2) to: (font word: 3) by: 1) do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self setchar: i.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">f nextword &larr; i. f nextword &larr; charwid*scale.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitmover width &larr; (frame extent x) * scale.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitmover height &larr; (frame extent y) * scale.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bits all &larr; 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitmover copy: storing.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">f append: bits].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">f close. scale &larr; svscale. self cufixup. bits unlock. self setchar: svchar]</span></div>
<div class="line left">
<span class="bold small">newfont: fontht maxcharwidth: maxcharwidth min: min max: max ascent: ascent kern: kern<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">| raster i x<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[XeqCursor showwhile⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[raster &larr; (2 + max - min * maxcharwidth + 15)/16.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">font &larr; String new:  (3 + max - min + (fontht * raster) + 9 * 2).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">font word: 1 &larr; 0100000.</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"format: strike, simple, varwidth"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">font word: 2 &larr; min.</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"min ascii code"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">font word: 3 &larr; max.</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"max ascii code"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">font word: 4 &larr; maxcharwidth.</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"max char width"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">font word: 5 &larr; (2+max-min + 5 + (fontht*raster)).</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"segment length"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">font word: 6 &larr; ascent.</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"bits above baseline"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">font word: 7 &larr; fontht-ascent.</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"bits below baseline"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">font word: 8 &larr; kern.</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"kerning offset"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">font word: 9 &larr; raster.</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"#words per scan-line in bitmap"</span><span class="small"><br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(font◦((18 + 1) to: 2 * raster * fontht + 18)) all &larr; 0.</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"chars all white"</span><span class="small"><br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">ascent &larr; ascent min: (fontht-1).</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"keep baseline within char"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(font◦(2 * raster * ascent + 18 + 1 to:<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">ascent+1*raster*2 + 18)) all &larr; 0377.</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"put in a black baseline"</span><span class="small"><br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">x &larr; 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i  from: (raster * fontht + 9 + 1 to:<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">raster * fontht + 9 + 3 + max - min by: 1) do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[font word: i &larr; x. x &larr; x+maxcharwidth].</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"table of left x"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑font.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">strike </span><span class="small">| i</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">showstr </span><span class="italic small">"Put a strike of font into dialogue window"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[showstr &larr; String new: 128. for⦂ i to: 128 do⦂ [showstr◦i &larr;i].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user clearshow: showstr]</span></div>
<div class="line left">
<span class="bold small">updatemaxwidth </span><span class="small">| newmaxwidth i<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"update max width"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">newmaxwidth &larr; 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i from: (fontxtabl to: fontxtabl + ((font word: 3) - (font word: 2) + 1) by: 1) do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[newmaxwidth &larr; (newmaxwidth max: ((font word: i+1) - (font word: i)))].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">font word: 4 &larr; newmaxwidth.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">updateseglength: newfont raster: newraster<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"compute new segment length for a font"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">newfont word: 5 &larr;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(5</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"length, ascent, descent, kern, and raster"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">+ (newraster * fontht)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"bits"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">+ ((font word: 3 </span><span class="italic small">"max"</span><span class="small">) -<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(font word: 2</span><span class="italic small">"min"</span><span class="small">) + 2)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"xtabl"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪FontWindow under: &rsquo;Windows&rsquo;.</span></div>
<div class="line left">
<span class="small">FontWindow classInit</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"Window"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;Window&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: Object<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;frame collapsed titlepara growing exitflag &rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;titlerun border titleloc titleframe windowmenu &rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>This is a superclass for presenting windows on the screen.  Besides outlining and scheduling the frame, it includes the distribution of user events which will someday be driven by interrupts.</span></div>
<div class="line left">
<span class="bold large"><br>Initialization</span></div>
<div class="line left">
<span class="bold small">classInit</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"Window classInit"</span><span class="bold small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[border &larr; 2⌾2.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">titleframe &larr; Textframe new para: nil frame: nil.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">titleloc &larr; 3⌾(¬4-titleframe lineheight).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">titlerun &larr; String new: 2.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">titlerun word: 1 &larr; 0177401.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">windowmenu &larr; Menu new string:<br>&rsquo;under<br>frame<br>close<br>print<br>printbits<br>&rsquo;]</span></div>
<div class="line left">
<span class="bold small">reset<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[exitflag&larr;true. growing&larr;false] </span></div>
<div class="line left">
<span class="bold large"><br>Scheduling</span></div>
<div class="line left">
<span class="bold small">eachtime<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[frame has: user mp⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[user kbck⇒[⇑self kbd]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user anybug⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[user redbug⇒[⇑self redbug]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user yellowbug⇒[⇑self yellowbug]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user bluebug⇒[⇑self bluebug]]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user anykeys⇒[⇑self keyset]]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self outside⇒[]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user anybug⇒[frame has: user mp⇒[] ⇑false]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user kbck⇒[user kbd. frame flash] </span><span class="italic small">"flush typing outside"</span><span class="small">]</span></div>
<div class="line left">
<span class="bold small">firsttime<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[frame has: user mp⇒ [self reset.  ⇑self enter] ⇑false]</span></div>
<div class="line left">
<span class="bold small">lasttime<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self leave. ⇑exitflag]</span></div>
<div class="line left">
<span class="bold small">schedule </span><span class="small">[user restartup: self]</span></div>
<div class="line left">
<span class="bold large"><br>Framing</span></div>
<div class="line left">
<span class="bold small">clearTitle: color<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[(titleframe window inset: ¬2⌾¬2) clear: color]</span></div>
<div class="line left">
<span class="bold small">editTitle </span><span class="small">| pared w<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[pared&larr; ParagraphEditor new para: titlepara frame: nil.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pared formerly: false; fixframe: titleframe window+(1⌾2).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pared enter.  w&larr; titleframe window.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">until⦂ (user anybug and⦂ (w has: user mp)≡false) do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[user kbck⇒[pared typing]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user redbug⇒[w has: user mp⇒[pared selecting]]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user yellowbug⇒[w has: user mp⇒[w flash]]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">titlepara&larr; pared contents.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self showtitle]</span></div>
<div class="line left">
<span class="bold small">erase<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[(frame inset: ¬2⌾¬2) clear.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self clearTitle: background]</span></div>
<div class="line left">
<span class="bold small">fixedwidthfromuser: width </span><span class="small">| a b oldframe [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user waitnobug.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[frame≡nil⇒[] self aboutToFrame; erase].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">a &larr; OriginCursor showwhile⦂ user waitbug.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">growing &larr; true.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self frame: (frame &larr; self fixframe: (a rect: a+(width⌾32))); show.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">CornerCursor showwhile⦂ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ (a &larr; user mpnext)  do⦂ [ a x &larr; frame corner x.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[oldframe≡nil⇒ [user cursorloc &larr; a max: frame corner]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">oldframe &larr; frame copy.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self frame: (frame &larr; self fixframe: (frame growto: a));<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">moveFrom: oldframe]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">growing &larr; false.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self takeCursor]</span></div>
<div class="line left">
<span class="bold small">fixframe: f </span><span class="small">[⇑Rectangle new origin: f origin extent: (f extent max: 32⌾32)]</span></div>
<div class="line left">
<span class="bold small">frame <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ ⇑ frame ]</span></div>
<div class="line left">
<span class="bold small">frame: f<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[frame &larr; self fixframe: f]</span></div>
<div class="line left">
<span class="bold small">moveFrom: oldframe<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[(oldframe inset: ¬2) clear. self show]</span></div>
<div class="line left">
<span class="bold small">newframe<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">| a oldframe<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[user waitnobug; restoredisplay.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[frame≡nil<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇒[]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self aboutToFrame; erase].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">a &larr; OriginCursor showwhile⦂ user waitbug.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">growing &larr; true.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">frame &larr; self fixframe: (a rect: a+32).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">frame outline.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">CornerCursor showwhile⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[while⦂ (a &larr; user mpnext) do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[[oldframe≡nil<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇒ [user cursorloc &larr; a max: frame corner]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">oldframe &larr; frame copy.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">frame &larr; self fixframe: (frame growto: a).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(oldframe inset: ¬2) clear.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">frame outline]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self frame: frame.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">growing &larr; false.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self takeCursor]</span></div>
<div class="line left">
<span class="bold small">outline<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"Clear and outline me."</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">frame outline]</span></div>
<div class="line left">
<span class="bold small">show </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self outline.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">growing⇒[]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self showtitle]</span></div>
<div class="line left">
<span class="bold small">showtitle<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[[titlepara≡nil⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[titlepara&larr; Paragraph new text: self title runs: titlerun alignment: 0]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">titleframe put: titlepara at: frame origin+titleloc; outline]</span></div>
<div class="line left">
<span class="bold small">takeCursor<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"Move the cursor to my center."</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user cursorloc &larr; frame center]</span></div>
<div class="line left">
<span class="bold small">title </span><span class="small">[⇑&rsquo;Untitled&rsquo;]</span></div>
<div class="line left">
<span class="bold large"><br>Default Event responses</span></div>
<div class="line left">
<span class="bold small">aboutToFrame<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"My frame is about to change.  I dont care."</span><span class="small">]</span></div>
<div class="line left">
<span class="bold small">bluebug<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[windowmenu bug<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=1⇒[⇑exitflag &larr; false];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=2⇒[self newframe. self enter];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=3⇒[self close. self erase.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user unschedule: self. ⇑false];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=4⇒[self hardcopy];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=5⇒[self print]]</span></div>
<div class="line left">
<span class="bold small">close </span><span class="small">[]</span></div>
<div class="line left">
<span class="bold small">enter </span><span class="small">[self show]</span></div>
<div class="line left">
<span class="bold small">hardcopy </span><span class="small">[frame flash]</span></div>
<div class="line left">
<span class="bold small">kbd </span><span class="small">[user kbd. frame flash]</span></div>
<div class="line left">
<span class="bold small">keyset </span><span class="small">[frame flash]</span></div>
<div class="line left">
<span class="bold small">leave </span><span class="small">[]</span></div>
<div class="line left">
<span class="bold small">outside </span><span class="small">[titleframe window has: user mp⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[user anybug⇒[self editTitle] ⇑false]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑false]</span></div>
<div class="line left">
<span class="bold small">print<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[(dp0 pressfile: (self title + &rsquo;.press.&rsquo;) asFileName)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">screenout: frame scale: PressScale; toPrinter]</span></div>
<div class="line left">
<span class="bold small">redbug<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[frame flash]</span></div>
<div class="line left">
<span class="bold small">yellowbug<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[frame flash]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪Window under: &rsquo;Windows&rsquo;.</span></div>
<div class="line left">
<span class="small">Window classInit</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"PanedWindow"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;PanedWindow&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: Window<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;panes templates title&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;&rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>A paned window is a Window that has subwindows (panes) that are awakened and resized in unison. The instance variable templates is a set of Rectangles for the frames of the panes normalized such that the whole PanedWindow is a frame of 0⌾0 rect: 36⌾36.</span></div>
<div class="line left">
<span class="bold large"><br>Initialization</span></div>
<div class="line left">
<span class="bold small">title: title with: panes at: templates </span><span class="small">| pane<br>"The instance variable templates is a set of Rectangles for the frames of the panes normalized such that the whole PanedWindow is a frame of 0⌾0 rect: 36⌾36."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self reset.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ pane from: panes do⦂ [pane init]]</span></div>
<div class="line left">
<span class="bold large"><br>Window protocol</span></div>
<div class="line left">
<span class="bold small">close </span><span class="small">| pane<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[for⦂ pane from: panes do⦂ [pane close]]</span></div>
<div class="line left">
<span class="bold small">eachtime </span><span class="small">| pane<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[frame has: user mp⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[user bluebug⇒[⇑self bluebug]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ pane from: panes do⦂ [pane startup]]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self outside⇒[]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user anybug⇒[frame has: user mp⇒[] ⇑false]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user kbck⇒[user kbd. frame flash] </span><span class="italic small">"flush typing outside"</span><span class="small">]</span></div>
<div class="line left">
<span class="bold small">enter </span><span class="small">| pane<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[super show.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ pane from: panes do⦂ [pane windowenter]]</span></div>
<div class="line left">
<span class="bold small">erase<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self titlerect clear. super erase]</span></div>
<div class="line left">
<span class="bold small">fixframe: f<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑Rectangle new origin: f origin extent: (f extent max: 160⌾80)]</span></div>
<div class="line left">
<span class="bold small">frame: frame </span><span class="italic small">"(Re)initialize my frame, and tell my panes their locations."</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">| templateStream template pane orig ext<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[templateStream &larr; templates asStream.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">orig&larr; frame origin-1. ext&larr; frame extent+2.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ pane from: panes do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"It would be nice to have parallel fors as in MLISP."</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">template &larr; templateStream next.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pane frame &larr; (template*ext /36 + orig) inset: 1]]</span></div>
<div class="line left">
<span class="bold small">hardcopy </span><span class="small">| p<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[user displayoffwhile⦂ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">p &larr; dp0 pressfile: (self title+&rsquo;.press&rsquo;) asFileName.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self hardcopy: p.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">p close; toPrinter]]</span></div>
<div class="line left">
<span class="bold small">hardcopy: pf </span><span class="small">| pane [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self hardcopyTitle: pf.<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"print frame rectangle"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">frame hardcopy: pf.<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"print all panes"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ pane from: panes do⦂ [pane hardcopy: pf].<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"print cursor if it&rsquo;s inside"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">frame has: user mp⇒ [user currentCursor hardcopy: pf]]</span></div>
<div class="line left">
<span class="bold small">hardcopyTitle: pf </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"refresh title (since it&rsquo;s a class var)"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self showtitle.<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"draw title rectangle"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">titleframe window hardcopy: pf.<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"print title text (make frame larger)"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">titleframe para presson: pf in: (pf transrect: (<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">titleframe frame origin rect: titleframe frame corner + (999 ⌾ 2)))<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">style: titleframe style]</span></div>
<div class="line left">
<span class="bold small">kbd </span><span class="small">| pane<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[(pane &larr; self pickedpane)⇒ [⇑pane kbd]]</span></div>
<div class="line left">
<span class="bold small">keyset </span><span class="small">| pane<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[(pane &larr; self pickedpane)⇒ [⇑pane keyset]]</span></div>
<div class="line left">
<span class="bold small">leave </span><span class="small">| pane<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[for⦂ pane from: panes do⦂ [pane windowleave]]</span></div>
<div class="line left">
<span class="bold small">pickedpane </span><span class="small">| pane<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[for⦂ pane from: panes do⦂ [pane picked⇒ [⇑pane]]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">frame flash. ⇑false]</span></div>
<div class="line left">
<span class="bold small">redbug </span><span class="small">| pane<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[(pane &larr; self pickedpane)⇒ [⇑pane redbug]]</span></div>
<div class="line left">
<span class="bold small">show </span><span class="small">| pane<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[super show.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ pane from: panes do⦂ [pane outline]]</span></div>
<div class="line left">
<span class="bold small">takeCursor<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[(panes◦1) takeCursor]</span></div>
<div class="line left">
<span class="bold small">title<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑title]</span></div>
<div class="line left">
<span class="bold small">yellowbug </span><span class="small">| pane<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[(pane &larr; self pickedpane)⇒ [⇑pane yellowbug]]</span></div>
<div class="line left">
<span class="bold large"><br>Pane services</span></div>
<div class="line left">
<span class="bold small">vanish<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self close; erase. user unschedule: self.]</span></div>
<div class="line left">
<span class="bold large"><br>Private</span></div>
<div class="line left">
<span class="bold small">titlerect<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑frame origin - (2 ⌾ (DefaultTextStyle lineheight + 4)) rect: (frame corner x⌾frame origin y) + (2⌾0)]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪PanedWindow under: &rsquo;Windows&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"BrowseWindow"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;BrowseWindow&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: PanedWindow<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;stdTemplates &rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>I am a five-paned window to browse through classes.  My panes are...<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">system pane: categories of classes in the system<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">class pane: classes in the selected category<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">organization pane: categories of methods in the selected class<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">selector pane: method selectors in the selected category<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">code pane: source code of the selected method, if any, else other useful info</span></div>
<div class="line left">
<span class="bold large"><br>Initialization</span></div>
<div class="line left">
<span class="bold small">classInit<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[stdTemplates &larr; (0⌾0 rect: 10⌾14), (10⌾0 rect: 18⌾14), (18⌾0 rect: 28⌾14), (28⌾0 rect: 36⌾14), (0⌾14 rect: 36⌾36)]</span></div>
<div class="line left">
<span class="bold small">default </span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"Let the user draw a five-paned window to browse through classes."</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">| systemPane classPane orgPane selectorPane codePane<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"Create the panes."</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">systemPane &larr; SystemPane new. classPane &larr; ClassPane new.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">orgPane &larr; OrganizationPane new. selectorPane &larr; SelectorPane new.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">codePane &larr; CodePane new.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"Acquire them."</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self title: &rsquo;Classes&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">with: (systemPane, classPane, orgPane, selectorPane, codePane)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">at: stdTemplates.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self newframe; show.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"Interconnect them."</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">systemPane to: classPane. classPane from: systemPane to: orgPane.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">orgPane from: classPane to: selectorPane. selectorPane from: orgPane to: codePane.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">codePane from: selectorPane.</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"Display them."</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">systemPane update]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪BrowseWindow under: &rsquo;Windows&rsquo;.</span></div>
<div class="line left">
<span class="small">BrowseWindow classInit</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"CodeWindow"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;CodeWindow&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: PanedWindow<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;stdTemplates &rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>I am a paned window with a code pane to edit a method or a file.</span></div>
<div class="line left">
<span class="bold large"><br>Initialization</span></div>
<div class="line left">
<span class="bold small">class: class selector: selector para: para formerly: oldpara </span><span class="small">| codePane<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[codePane &larr; CodePane new class: class selector: selector para: nil.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self title: class title+ &rsquo; &rsquo; + selector with: codePane inVector at: stdTemplates.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self newframe; show.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">codePane showing: para; formerly: oldpara; from: codePane]</span></div>
<div class="line left">
<span class="bold small">classInit<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[stdTemplates &larr; (0⌾0 rect: 36⌾36) inVector]</span></div>
<div class="line left">
<span class="bold small">editTitle </span><span class="small">[titleframe window flash]</span></div>
<div class="line left">
<span class="bold small">file: file </span><span class="small">| filePane<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[filePane &larr; FilePane new file: file.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self title: file name with: filePane inVector at: stdTemplates.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self newframe; show.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">filePane showing: file contents asParagraph; from: filePane]</span></div>
<div class="line left">
<span class="bold small">hardcopy: p </span><span class="small">| pane [for⦂ pane from: panes do⦂ [pane hardcopy: p]]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪CodeWindow under: &rsquo;Windows&rsquo;.</span></div>
<div class="line left">
<span class="small">CodeWindow classInit</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"InspectWindow"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;InspectWindow&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: PanedWindow<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;variables&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;stdTemplates &rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>I am a paned window with a variable pane that displays the fields of an object and a code pane to display their values and to evaluate in their context.</span></div>
<div class="line left">
<span class="bold large"><br>Initialization</span></div>
<div class="line left">
<span class="bold small">classInit<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[stdTemplates &larr; (0⌾0 rect: 12⌾36), (12⌾0 rect: 36⌾36)]</span></div>
<div class="line left">
<span class="bold small">of: object </span><span class="small">| instanceVarPane instanceValuePane safeVec n<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[instanceVarPane &larr; VariablePane new. instanceValuePane &larr; CodePane new.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self title: object class title<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">with: (instanceVarPane, instanceValuePane) at: stdTemplates.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self newframe; show.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">instanceVarPane to: instanceValuePane.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">instanceValuePane from: instanceVarPane.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">variables &larr; (Vector new: 16) asStream.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[object class is: VariableLengthClass⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[for⦂ n from: object fields do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self identifier: n]]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">object class fieldNamesInto: self].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">safeVec &larr; Vector new: 2. safeVec all &larr; object.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">instanceVarPane names: (↪(self) concat: variables contents) values: safeVec wrt: false]</span></div>
<div class="line left">
<span class="bold small">show: object </span><span class="small">| fixedframe instanceVarPane instanceValuePane safeVec n<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[instanceVarPane &larr; VariablePane new. instanceValuePane &larr; CodePane new.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">fixedframe &larr; 400⌾450 rect: 600⌾565.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self title: object class title<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">with: (instanceVarPane, instanceValuePane) at: stdTemplates.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self frame: (self fixframe: fixedframe); show.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">instanceVarPane to: instanceValuePane.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">instanceValuePane from: instanceVarPane.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">variables &larr; (Vector new: 16) asStream.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[object class is: VariableLengthClass⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[for⦂ n from: object fields do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self identifier: n]]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">object class fieldNamesInto: self].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">safeVec &larr; Vector new: 2. safeVec all &larr; object.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">instanceVarPane names: (↪(self) concat: variables contents) values: safeVec wrt: false]</span></div>
<div class="line left">
<span class="bold large"><br>Private</span></div>
<div class="line left">
<span class="bold small">comment: s</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">called by of: via Class fieldNamesInto</span><span class="small">"</span></div>
<div class="line left">
<span class="bold small">contents</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">called by of: via Class fieldNamesInto</span><span class="small">"</span></div>
<div class="line left">
<span class="bold small">identifier: s</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">called by of: via Class fieldNamesInto</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[variables next &larr; s]</span></div>
<div class="line left">
<span class="bold small">separator: c</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">called by of: via Class fieldNamesInto</span><span class="small">"</span></div>
<div class="line left">
<span class="bold small">trailer: s</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">called by of: via Class fieldNamesInto</span><span class="small">"</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪InspectWindow under: &rsquo;Windows&rsquo;.</span></div>
<div class="line left">
<span class="small">InspectWindow classInit</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"NotifyWindow"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;NotifyWindow&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: PanedWindow<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;enoughpanes&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;bigTemplates smallFrame smallTemplates &rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>I am a paned window with one or six panes that display the context of an error or breakpoint.</span></div>
<div class="line left">
<span class="bold large"><br>Initialization</span></div>
<div class="line left">
<span class="bold small">classInit<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[smallTemplates &larr; (0⌾0 rect: 36⌾36) inVector.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bigTemplates &larr; (0⌾0 rect: 12⌾18), (12⌾0 rect: 36⌾18), (0⌾18 rect: 12⌾27), (12⌾18 rect: 36⌾27), (0⌾27 rect: 12⌾36), (12⌾27 rect: 36⌾36).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">smallFrame &larr; 204⌾366 rect: 404⌾402]</span></div>
<div class="line left">
<span class="bold small">of: titleString level: level interrupt: flag </span><span class="small">| stackPane<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[NotifyFlag &larr; false.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">stackPane &larr; StackPane new.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self title: titleString with: stackPane inVector at: smallTemplates.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">smallFrame moveto:<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[level&gt;1⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[300⌾50]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(user screenrect center-(smallFrame extent/2))].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self frame: (self fixframe: smallFrame); show.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">stackPane context: false at: level instance: false code: false;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">interrupt: flag.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">stackPane of: (Top◦level) inVector. NotifyFlag &larr; true]</span></div>
<div class="line left">
<span class="bold small">of: titleString stack: stack interrupt: flag </span><span class="small">| stackPane<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[NotifyFlag &larr; false.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">stackPane &larr; StackPane new.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self title: titleString with: stackPane inVector at: smallTemplates.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">smallFrame moveto:<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[Top currentPriority&gt;1⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[300⌾50]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(user screenrect center-(smallFrame extent/2))].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self frame: (self fixframe: smallFrame); show.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">stackPane context: false instance: false code: false; interrupt: flag.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">stackPane of: stack inVector. NotifyFlag &larr; true]</span></div>
<div class="line left">
<span class="bold large"><br>Window protocol</span></div>
<div class="line left">
<span class="bold small">aboutToFrame<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[enoughpanes &larr; panes length = 6. super aboutToFrame]</span></div>
<div class="line left">
<span class="bold small">enter </span><span class="small">| stackPane codePane contextVarPane contextValuePane instanceVarPane instanceValuePane<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[enoughpanes⇒ [super enter]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">NotifyFlag &larr; false.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"Create the remaining five panes."</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">stackPane &larr; panes◦1. codePane &larr; CodePane new.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">contextVarPane &larr; VariablePane new. contextValuePane &larr; CodePane new.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">instanceVarPane &larr; VariablePane new. instanceValuePane &larr; CodePane new.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"Create the six-paned window."</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self title: title<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">with: (stackPane, codePane, contextVarPane, contextValuePane, instanceVarPane, instanceValuePane)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">at: bigTemplates.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self frame: frame; show.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"Initialize the six panes."</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">stackPane context: contextVarPane instance: instanceVarPane code: codePane.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">codePane from: stackPane.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">contextVarPane to: contextValuePane. contextValuePane from: contextVarPane.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">instanceVarPane to: instanceValuePane. instanceValuePane from: instanceVarPane.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">stackPane select: 0; deselected; fill. enoughpanes &larr; NotifyFlag &larr; true]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪NotifyWindow under: &rsquo;Windows&rsquo;.</span></div>
<div class="line left">
<span class="small">NotifyWindow classInit</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"ProjectWindow"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;ProjectWindow&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: Window<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;userview parent changes&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;actionMenu &rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>A ProjectWindow represents its userview as a window to provide access to many UserViews, each for a different "project".  Besides the state in the userview, they also carry their own hashset for changes, so that such changes can be maintained on a per-project basis.  parent specifies another ProjectWindow to which control is given when the user leaves the current userview</span></div>
<div class="line left">
<span class="bold large"><br>Changing views</span></div>
<div class="line left">
<span class="bold small">install</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">Establish this project and its userview as the current screen view</span><span class="small">"</span><span class="bold small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[Changes&larr; changes.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(user&larr; userview) install.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self putTitle.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user restart]</span></div>
<div class="line left">
<span class="bold small">putTitle<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ [titlepara≡nil⇒[titlepara&larr; &rsquo;Top View&rsquo; asParagraph allBold]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">titleframe put: titlepara<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">centered: user screenrect extent x/3⌾8.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">titleframe outline]</span></div>
<div class="line left">
<span class="bold small">runParent</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">leave this view by installing the one above</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[parent install]</span></div>
<div class="line left">
<span class="bold large"><br>Window behavior</span></div>
<div class="line left">
<span class="bold small">close</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"break circular links"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[userview&larr; parent&larr; nil]</span></div>
<div class="line left">
<span class="bold small">yellowbug<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[actionMenu bug=1⇒[self install]]</span></div>
<div class="line left">
<span class="bold large"><br>Initialization</span></div>
<div class="line left">
<span class="bold small">classInit<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[actionMenu &larr; Menu new string: &rsquo;enter&rsquo;]</span></div>
<div class="line left">
<span class="bold small">init</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"a new window"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self userview: (user copyIn: self)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">changes: HashSet init<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">parent: user projectWindow.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self newframe; show]</span></div>
<div class="line left">
<span class="bold small">userview: userview changes: changes parent: parent</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"load state"</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪ProjectWindow under: &rsquo;Windows&rsquo;.</span></div>
<div class="line left">
<span class="small">ProjectWindow classInit</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"SyntaxWindow"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;SyntaxWindow&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: PanedWindow<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;stdFrame stdTemplates &rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>I am a paned window with a stack pane and a code pane to report errors during non-interactive compilations, e.g., filin, ⓢ, understands.</span></div>
<div class="line left">
<span class="bold large"><br>Initialization</span></div>
<div class="line left">
<span class="bold small">classInit<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[stdTemplates &larr; (0⌾0 rect: 12⌾36), (12⌾0 rect: 36⌾36).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">stdFrame &larr; 60⌾320 rect: 570⌾500]</span></div>
<div class="line left">
<span class="bold small">of: errorString at: position in: stream for: class from: context </span><span class="small">| stackPane codePane<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[stackPane &larr; StackPane new.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">codePane &larr; CodePane new class: class selector: nil para: nil.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self title: class title with: (stackPane, codePane) at: stdTemplates.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">stdFrame moveto: (user screenrect center-(stdFrame extent/2)).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self frame: (self fixframe: stdFrame); show.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">stackPane context: false instance: false code: codePane.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">stackPane of: context inVector.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">codePane showing: stream asArray.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">codePane from: stackPane; notify: errorString at: position in: stream]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪SyntaxWindow under: &rsquo;Windows&rsquo;.</span></div>
<div class="line left">
<span class="small">SyntaxWindow classInit</span></div>
    <div class="line left">
<span class="small">&rsquo;From Smalltalk 5.5k XM November 24 on 22 November 1980 at 2:57:08 am.&rsquo;<br></span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large">"CodePane"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;CodePane&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: Window<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;pared class selector selectorPane scrollBar&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;editmenu &rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>I am a Window for editing a paragraph which may include Smalltalk source code.  My selectorPane (not necessarily of class SelectorPane, and possibly even myself) compiles and doits for me.</span></div>
<div class="line left">
<span class="bold large"><br>Initialization</span></div>
<div class="line left">
<span class="bold small">class: class selector: selector para: para</span></div>
<div class="line left">
<span class="bold small">classInit<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[editmenu &larr; Menu new string:<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">&rsquo;again<br>copy<br>cut<br>paste<br>doit<br>compile<br>undo<br>cancel<br>align&rsquo;]</span></div>
<div class="line left">
<span class="bold small">from: selectorPane</span></div>
<div class="line left">
<span class="bold small">init</span></div>
<div class="line left">
<span class="bold small">showing: paragraph<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[pared &larr; ParagraphEditor new para: paragraph asParagraph frame: nil.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pared formerly: false; fixframe: frame.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self windowenter.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">scrollBar &larr; ([scrollBar≡nil⇒ [ScrollBar new] scrollBar]) on: frame from: pared]</span></div>
<div class="line left">
<span class="bold large"><br>Window protocol</span></div>
<div class="line left">
<span class="bold small">close<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[pared unselect. selectorPane &larr; pared &larr; nil. scrollBar close]</span></div>
<div class="line left">
<span class="bold small">doit </span><span class="small">| s val d [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">d &larr; [user leftShiftKey⇒ [mem◦067] false].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[d⇒ [mem◦067 &larr; 58]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">scrollBar hide.<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">do automatic selection (ESC) on empty selections</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[(s &larr; pared selectRange) empty⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pared unselect; fintype; complement.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s &larr; pared selectRange]].<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">val &larr; selectorPane execute: pared selectionAsStream for: self. <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[val≡nil or⦂ s ≠ pared selectRange⇒ ["</span><span class="italic small">result is nil or error occurred</span><span class="small">"]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">automatically paste result</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s&larr; s stop+1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pared Scrap &larr; [(String new: 100) asStream<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">space; print: val; contents asParagraph];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">selectRange: (s to: s); paste].<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">scrollBar show.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">d⇒ [mem◦067 &larr; d]<br>]</span></div>
<div class="line left">
<span class="bold small">eachtime </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user kbck⇒ [⇑self kbd]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">frame has: user mp⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user anybug⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user redbug⇒ [⇑self redbug]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user yellowbug⇒ [⇑self yellowbug]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user bluebug⇒ [⇑false]]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user anykeys⇒ [⇑self keyset]]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑self outside]</span></div>
<div class="line left">
<span class="bold small">enter<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[scrollBar show]</span></div>
<div class="line left">
<span class="bold small">frame &larr; frame<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"Change my frame and that of my pared (if any)."</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pared≡nil⇒ [] pared frame &larr; frame.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">scrollBar on: frame from: pared]</span></div>
<div class="line left">
<span class="bold small">hardcopy: pf </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"if this is just part of a CodeWindow, then print entire Paragraph with no frame.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">unfortunately, the test for this is a kludge. otherwise, print clipped"<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">selectorPane ≡ self⇒ [(PressPrinter init) press: pf; print: pared contents]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">frame hardcopy: pf thickness: 1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pared hardcopy: pf]</span></div>
<div class="line left">
<span class="bold small">kbd<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[pared typing]</span></div>
<div class="line left">
<span class="bold small">keyset<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑pared keyset]</span></div>
<div class="line left">
<span class="bold small">leave<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[scrollBar hide]</span></div>
<div class="line left">
<span class="bold small">outline<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[frame outline: 1]</span></div>
<div class="line left">
<span class="bold small">outside<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑scrollBar startup]</span></div>
<div class="line left">
<span class="bold small">picked<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑frame has: user mp]</span></div>
<div class="line left">
<span class="bold small">redbug<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑pared selecting]</span></div>
<div class="line left">
<span class="bold small">show<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[frame outline. pared show]</span></div>
<div class="line left">
<span class="bold small">windowenter<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self outline. pared enter]</span></div>
<div class="line left">
<span class="bold small">windowleave<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[pared≡nil⇒[] pared leave]</span></div>
<div class="line left">
<span class="bold small">yellowbug<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[editmenu bug<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=5⇒[self doit];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=1⇒[scrollBar hidewhile⦂ [pared again]];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=2⇒[pared copy];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=3⇒[pared cut];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=4⇒[pared paste];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=6⇒[pared formerly⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[scrollBar hidewhile⦂ [selectorPane compile: pared contents⇒ [pared formerly: false]]]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">  frame flash];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=7⇒[pared undo];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=8⇒[pared formerly⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pared Deletion &larr; pared contents.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">scrollBar hidewhile⦂ [self showing: pared formerly]] frame flash];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=9⇒[pared realign]]</span></div>
<div class="line left">
<span class="bold large"><br>Browse/Notify protocol</span></div>
<div class="line left">
<span class="bold small">compile: parag</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"as my own selectorPane"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑self compile: parag in: class under: &rsquo;As yet unclassified&rsquo;]</span></div>
<div class="line left">
<span class="bold small">compile: parag in: defaultClass under: category<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑Generator new<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">compile: parag<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">in: [class≡nil⇒ [defaultClass] class]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">under: category<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">notifying: self]</span></div>
<div class="line left">
<span class="bold small">contents<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑pared contents]</span></div>
<div class="line left">
<span class="bold small">dirty<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[pared formerly⇒ [⇑frame] ⇑false]</span></div>
<div class="line left">
<span class="bold small">execute: parseStream for: codePane</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"as my own selectorPane"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑self execute: parseStream in: false to: nil]</span></div>
<div class="line left">
<span class="bold small">execute: parseStream in: context to: receiver<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑Generator new evaluate: parseStream in: context to: receiver notifying: self]</span></div>
<div class="line left">
<span class="bold small">formerly: oldpara </span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"should not be called before &rsquo;showing:&rsquo;"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[pared formerly: oldpara]</span></div>
<div class="line left">
<span class="bold small">interactive<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑true]</span></div>
<div class="line left">
<span class="bold small">notify: errorString at: position in: stream<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[pared<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">fintype;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">selectRange: (position to: position);<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">replace: (&rsquo;➲&rsquo; + errorString + &rsquo;➲.&rsquo;) asParagraph;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">selectAndScroll.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑false]</span></div>
<div class="line left">
<span class="bold small">oldContents<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑pared formerly]</span></div>
<div class="line left">
<span class="bold small">reflects: selection  </span><span class="italic small">"am I trying to show the code of selectorPaneⓢ selection?"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑class≡nil and⦂ selection&gt;0]</span></div>
<div class="line left">
<span class="bold small">selectRange: r </span><span class="small">[pared selectRange: r; selectAndScroll]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪CodePane under: &rsquo;Panes and Menus&rsquo;.</span></div>
<div class="line left">
<span class="small">CodePane classInit</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"FilePane"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;FilePane&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: CodePane<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;file&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;editmenu &rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>This class has not yet been commented</span></div>
<div class="line left">
<span class="bold large"><br>As yet unclassified</span></div>
<div class="line left">
<span class="bold small">classInit </span><span class="small">"FilePane classInit."</span><span class="bold small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[editmenu &larr; Menu new string:<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">&rsquo;again<br>copy<br>cut<br>paste<br>doit<br>put<br>undo<br>get<br>align&rsquo;]</span></div>
<div class="line left">
<span class="bold small">file: file</span></div>
<div class="line left">
<span class="bold small">yellowbug<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[editmenu bug<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=1⇒[pared again];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=2⇒[pared copy];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=3⇒[pared cut];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=4⇒[pared paste];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=5⇒[self doit];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=6⇒[pared formerly⇒ [user displayoffwhile⦂ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">file readwriteshorten; reset; append: pared contents; close.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pared formerly: false]]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">frame flash];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=7⇒[pared undo];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=8⇒[user displayoffwhile⦂ [scrollBar hidewhile⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self showing: file contents asParagraph]]];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=9⇒[pared realign]]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪FilePane under: &rsquo;Panes and Menus&rsquo;.</span></div>
<div class="line left">
<span class="small">FilePane classInit</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"ListPane"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;ListPane&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: Textframe<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;list firstShown lastShown selection scrollBar&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;&rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>A list pane displays a vertical list of one-line items.  The list can be scrolled slow or fast, and any item can be selected.  When an item is selected (or deselected), a dependent pane can be told to display appropriate material.</span></div>
<div class="line left">
<span class="bold large"><br>Initialization</span></div>
<div class="line left">
<span class="bold small">of: list </span><span class="small">"Acquire the specified list and show me scrolled to the top"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[firstShown&larr; selection&larr; 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self frame&larr; window.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self fill; deselected]</span></div>
<div class="line left">
<span class="bold small">revise: newlist with: sel  </span><span class="small">| changing<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"Acquire newlist. Do not change firstShown. Select sel if in list."</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[changing &larr; list≠newlist⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[list &larr; newlist.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">firstShown &larr; firstShown min: (<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">list length+2  - (window height-4/self lineheight) max: 0).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[nil ≠ para⇒ [para &larr; para asStream]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self fill]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> selection&gt;0⇒ [changing &larr; list◦selection≠sel⇒ [self compselection]]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> changing &larr; true].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">changing⇒ [selection &larr; ¬1. self select: (list find: sel)]]</span></div>
<div class="line left">
<span class="bold small">select: lineNum </span><span class="small">| oldSel<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"Select my non-dummy displayed entry whose subscript is lineNum; highlight it; if it is different from selection, tell me to select.  If there is no such entry, set selection to 0 and if it wasnt 0 before, tell me to deselect."</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">oldSel &larr; selection.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(1 max: firstShown) ≤ lineNum and⦂ lineNum ≤ (list length min: lastShown)⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[selection &larr; lineNum. self compselection. oldSel≠selection⇒ [self selected]]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">selection &larr; 0. oldSel≠selection⇒ [self deselected]]</span></div>
<div class="line left">
<span class="bold large"><br>Pane protocol</span></div>
<div class="line left">
<span class="bold small">close</span><span class="small bold italic"> </span><span class="italic small">"Zero my selection so it wont be grayed when I close.  Break cycles."</span><span class="bold small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[selection&larr;0. scrollBar close]</span></div>
<div class="line left">
<span class="bold small">eachtime<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[window has: user mp⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[user kbck⇒[⇑self kbd]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user anybug⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[user redbug⇒[⇑self redbug]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user yellowbug⇒[⇑self yellowbug]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user bluebug⇒[⇑false]]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user anykeys⇒[⇑self keyset]]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑self outside]</span></div>
<div class="line left">
<span class="bold small">enter<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[scrollBar show]</span></div>
<div class="line left">
<span class="bold small">firsttime<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[window has: user mp⇒[self enter]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑false]</span></div>
<div class="line left">
<span class="bold small">frame &larr; window </span><span class="italic small">"(Re)initialize my window"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[para &larr; nil.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">scrollBar &larr; ([scrollBar≡nil⇒ [ScrollBar new] scrollBar]) on: window from: self]</span></div>
<div class="line left">
<span class="bold small">hardcopy: pf </span><span class="small">| t cr first last lasty lineNum parag left right lineheight [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">window hardcopy: pf thickness: 1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[para≡nil⇒ [self makeParagraph]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">parag &larr; para asParagraph.<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">t &larr; para asStream.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">last &larr; 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">cr &larr; 015.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">left &larr; frame minX.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">right &larr; window maxX.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">lasty &larr; frame minY.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">lineheight &larr; self lineheight.<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ lineNum from: firstShown to: lastShown do⦂ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">first &larr; last.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[(t skipTo: cr) or⦂ lineNum = lastShown⇒ [last &larr; t position]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user notify: &rsquo;not enough lines&rsquo;].<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[lineNum = selection and⦂ selection &gt; 0⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"outline selection; complementing doesn&rsquo;t look good"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(self selectionRect-(0⌾1) inset: 0⌾1) hardcopy: pf thickness: 1]].<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(parag copy: first+1 to: last-1) presson: pf in:<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(pf transrect: (left ⌾ lasty rect: right ⌾ (lasty+lineheight+4))) style: style.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">lasty &larr; lasty + lineheight.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]]</span></div>
<div class="line left">
<span class="bold small">kbd<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[window flash. user kbd.]</span></div>
<div class="line left">
<span class="bold small">keyset </span><span class="small">| c<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"As long as any keyset keys are down, react to keys 2 and 8 down by scrolling up or down a line at a time.  If key 4 is down as well, scroll faster."</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">c &larr; user currentCursor.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self scrollControl⦂ [user keyset=6⇒[2]; =12⇒[¬2]; =2⇒[1]; =8⇒[¬1] 0].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">c show]</span></div>
<div class="line left">
<span class="bold small">lasttime<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self leave]</span></div>
<div class="line left">
<span class="bold small">leave<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[scrollBar hide]</span></div>
<div class="line left">
<span class="bold small">outline<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[window outline: 1]</span></div>
<div class="line left">
<span class="bold small">outside </span><span class="small">[⇑scrollBar startup]</span></div>
<div class="line left">
<span class="bold small">picked<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑window has: user mp]</span></div>
<div class="line left">
<span class="bold small">redbug </span><span class="small">| newSel f</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"Deselect selection and select cursor item, if any"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[[f &larr; self locked⇒ []<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self compselection.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">newSel &larr; (user mp y - window origin y)/self lineheight + firstShown.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">XeqCursor showwhile⦂ [self select: [newSel = selection⇒ [0] newSel]]].<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ (user redbug and⦂ (window has: user mp)) do⦂ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">f⇒ [f flash. self compselection; compselection]]]</span></div>
<div class="line left">
<span class="bold small">scrollPos<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[firstShown≡nil or⦂ list length=0⇒[⇑0.0]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑firstShown asFloat/list length]</span></div>
<div class="line left">
<span class="bold small">scrollTo: f | t</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self scrollControl⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[t&larr; (f*list length) asInteger - firstShown.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">t&lt;0⇒[firstShown&lt;0⇒[0] t]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">lastShown&gt;list length⇒[0] t]]</span></div>
<div class="line left">
<span class="bold small">windowenter </span><span class="italic small">"Refresh my image.  Reaffirm selection."</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self outline; fill; select: selection.]</span></div>
<div class="line left">
<span class="bold small">windowleave<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self compselection; grayselection]</span></div>
<div class="line left">
<span class="bold small">yellowbug<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[window flash]</span></div>
<div class="line left">
<span class="bold large"><br>Subclass defaults</span></div>
<div class="line left">
<span class="bold small">deselected </span><span class="italic small">"I just lost my selection.  I dont care, but my subclasses might."</span></div>
<div class="line left">
<span class="bold small">dirty </span><span class="italic small">"My subclasses may want to prohibit a change of selection"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑false]</span></div>
<div class="line left">
<span class="bold small">locked </span><span class="italic small">"My subclasses may want to prohibit a change of selection"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑[selection=0⇒ [false] self dirty]]</span></div>
<div class="line left">
<span class="bold small">selected </span><span class="italic small">"A new selection is highlighted.  I dont care, but my subclasses might"</span></div>
<div class="line left">
<span class="bold large"><br>Private</span></div>
<div class="line left">
<span class="bold small">compselection </span><span class="italic small">"If I have a selection, complement its image."</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[selection≠0⇒ [self selectionRect comp]]</span></div>
<div class="line left">
<span class="bold small">dummy<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑&rsquo;▱▱▱▱▱▱▱&rsquo;]</span></div>
<div class="line left">
<span class="bold small">fill </span><span class="small">[self makeParagraph; show]</span></div>
<div class="line left">
<span class="bold small">grayselection<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[selection≠0⇒ [self selectionRect color: ltgray mode: oring]]</span></div>
<div class="line left">
<span class="bold small">init<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self para: nil frame: nil.]</span></div>
<div class="line left">
<span class="bold small">makeParagraph </span><span class="small">| i len s lines </span><span class="italic small">"Given firstShown, compute lastShown."</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">len &larr; list length.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">lastShown &larr; firstShown-1 + (lines &larr; window height-4/self lineheight)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">min: 1+len.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self locked⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[i &larr; (selection-lastShown max: 0) + (selection-firstShown min: 0).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">i≠0⇒ [para&larr;nil. firstShown &larr; firstShown + i. lastShown &larr; lastShown + i]]].<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(frame &larr; window inset: 2) width &larr; 999.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">para is: String⇒ ["</span><span class="italic small">if para is a String, refresh from it directly</span><span class="small">"]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"otherwise compute para."</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s &larr; [para≡nil⇒ [(String new: 200) asStream] para].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i from: firstShown to: lastShown do⦂ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[0&lt;i and⦂ i≤len⇒ [lines &larr; lines-1. (list◦i) printon: s]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s append: self dummy].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s cr].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: (lines+1 min: s limit - s position) do⦂ [s cr].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">para &larr; s asArray]</span></div>
<div class="line left">
<span class="bold small">scrollBy⦂ expr copying: src into: dest showing: item in: frame direction: n<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">| strm final stop pt delay chars locked t<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[strm &larr; Stream new. chars &larr; 2*frame width/self lineheight. para &larr; String new: chars.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pt &larr; dest origin. final &larr; [n&lt;0⇒ [0] list length+1].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">stop &larr; [locked&larr;self locked⇒ [0 max: (list length+1 min: (lastShown - firstShown * n sign + selection))] final].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ item≠stop do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[firstShown &larr; firstShown + n. lastShown &larr; lastShown + n. item &larr; item + n.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">strm of: para from: 1 to: chars.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[item≠final⇒ [(list◦item) printon: strm] self dummy copyto: strm].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">strm cr. src blt: pt mode: storing. self show.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(t&larr; expr eval) abs ≤1⇒ [for⦂ delay to: chars/4 do⦂ [strm myend]. para &larr; nil. ⇑self]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">t*n&lt;0⇒[⇑self]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">para &larr; nil. locked and: stop≠final⇒ [locked flash. ⇑false]]</span><span class="bold small"><br></span></div>
<div class="line left">
<span class="bold small">scrollControl⦂ expr<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">| dY onlyFirst butFirst onlyLast butLast x1 x2 y1 y2 y3 y4 k<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"Selection is highlighted.  Unhighlight it.  Invalidate my saved para if I scroll.  Then reselect selection, or deselect if it is no longer displayed."</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self compselection. dY &larr; self lineheight.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">x1 &larr; window origin x. x2 &larr; window corner x.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">y1 &larr; window origin y+2. y4 &larr; window height-4 |dY + y1. y2&larr;y1+dY. y3&larr;y4-dY.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">onlyFirst &larr; x1+2⌾y1 rect: 2000⌾y2. butFirst &larr; x1⌾y2 rect: x2⌾y4.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">onlyLast &larr; x1+2⌾y3 rect: 2000⌾y4. butLast &larr; x1⌾y1 rect: x2⌾y3.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ (k&larr;expr eval)≠0 do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[k&gt;0⇒[UpCursor topage1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self scrollBy⦂ expr eval copying: butFirst into: butLast showing: lastShown<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">in: onlyLast direction: 1⇒[] ⇑self select: selection]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">DownCursor topage1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self scrollBy⦂ expr eval copying: butLast into: butFirst showing: firstShown<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">in: onlyFirst direction: ¬1⇒[] ⇑self select: selection].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self select: selection]</span></div>
<div class="line left">
<span class="bold small">scrollUp: n </span><span class="small">| c<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[c &larr; window origin x-20.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self scrollControl⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[user buttons=4⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[user mp x &gt; c⇒[2] ¬2]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">0]]</span></div>
<div class="line left">
<span class="bold small">selectionRect </span><span class="small">| h w<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"I have a selection.  Return its highlighting rectangle."</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(w &larr; window inset: 2) height &larr; h &larr; self lineheight. <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑w + (0⌾(selection-firstShown *h))]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪ListPane under: &rsquo;Panes and Menus&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"ClassPane"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;ClassPane&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: ListPane<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;systemPane organizationPane&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;editmenu &rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>I am a list pane that displays the names of all the classes of a category</span></div>
<div class="line left">
<span class="bold large"><br>Initialization</span></div>
<div class="line left">
<span class="bold small">classInit<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[editmenu &larr; Menu new string: &rsquo;filout<br>print<br>forget&rsquo;]</span></div>
<div class="line left">
<span class="bold small">from: systemPane to: organizationPane</span></div>
<div class="line left">
<span class="bold large"><br>Window protocol</span></div>
<div class="line left">
<span class="bold small">close<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[systemPane &larr; nil. super close]</span></div>
<div class="line left">
<span class="bold small">yellowbug<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["</span><span class="italic small">If there is a selection, let the user choose a command from the menu.</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">selection=0⇒ [window flash]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">editmenu bug<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=1⇒ ["</span><span class="italic small">filout</span><span class="small">" (Smalltalk◦(list◦selection)) filout];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=2⇒ ["</span><span class="italic small">print</span><span class="small">" (Smalltalk◦(list◦selection)) printout];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=3⇒ ["</span><span class="italic small">forget</span><span class="small">" systemPane forget: list◦selection]]</span></div>
<div class="line left">
<span class="bold large"><br>ListPane protocol</span></div>
<div class="line left">
<span class="bold small">deselected<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"I just lost my selection.  Tell organizationPane to display nothing."</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">organizationPane class: nil.]</span></div>
<div class="line left">
<span class="bold small">selected<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"My selection just changed.  Tell organizationPane to display the categories of my newly selected Class."</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">organizationPane class: Smalltalk◦(list◦selection).]</span></div>
<div class="line left">
<span class="bold large"><br>Browser protocol</span></div>
<div class="line left">
<span class="bold small">compile: parag<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[systemPane compile: parag]</span></div>
<div class="line left">
<span class="bold small">dirty<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑organizationPane dirty]</span></div>
<div class="line left">
<span class="bold small">noCode<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[selection=0⇒ [⇑systemPane noCode] ⇑&rsquo;&rsquo;]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪ClassPane under: &rsquo;Panes and Menus&rsquo;.</span></div>
<div class="line left">
<span class="small">ClassPane classInit</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"Menu"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;Menu&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: Object<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;str text thisline frame&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;&rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>I am a list of text lines one of which can be selected with the pointing device</span></div>
<div class="line left">
<span class="bold large"><br>Initialization</span></div>
<div class="line left">
<span class="bold small">rescan </span><span class="italic small">" | each. Menu allInstances notNil transform⦂ each to⦂ each rescan."</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self string: str]</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"rescan (for new fonts, lineheight)"</span></div>
<div class="line left">
<span class="bold small">string: str </span><span class="small">|  i pt tpara<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[[str last≠13⇒[str&larr;str+&rsquo;<br>&rsquo;]].</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"make sure str ends with CR"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">text &larr; Textframe new para: (tpara &larr; str asParagraph)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">frame:  (Rectangle new origin: (pt &larr;  0 ⌾ 0)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">corner: 1000 ⌾ 1000).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pt &larr; text maxx: str length+1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">text frame growto: pt + (4 ⌾ 0).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">tpara center.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">frame &larr; text frame inset: ¬2  ⌾ ¬2.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">thisline &larr; Rectangle new origin: text frame origin<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">corner: text frame corner x ⌾ text lineheight]</span></div>
<div class="line left">
<span class="bold small">stringFromVector: v </span><span class="small">| s<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["DW classInit"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s &larr; Stream default.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ v from: v do⦂ [s append: v; cr].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self string: s contents]</span></div>
<div class="line left">
<span class="bold large"><br>User interactions</span></div>
<div class="line left">
<span class="bold small">bug </span><span class="small">| index bits<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[bits &larr; self movingsetup.</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"set up and save background"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">index &larr; self bugit.</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"get the index"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">frame bitsFromString: bits.</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"restore background"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ index</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"return index"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span></div>
<div class="line left">
<span class="bold small">clear<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[frame clear]</span></div>
<div class="line left">
<span class="bold small">fbug </span><span class="small">| index<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"for fixed menus"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">index &larr; self bugit.</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"get the index"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ index</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"return index"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span></div>
<div class="line left">
<span class="bold small">frame<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑ frame]</span></div>
<div class="line left">
<span class="bold small">has: pt<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑ text frame has: pt]</span></div>
<div class="line left">
<span class="bold small">moveto: pt<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self clear.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">frame moveto: pt.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">text frame moveto: pt+2.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">thisline moveto: pt+2.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">rebug<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[user waitbug. </span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"wait for button down again"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑</span><span class="italic small">"bugcursor showwhile⦂"</span><span class="small"> self bug]</span></div>
<div class="line left">
<span class="bold small">show<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[frame clear: black. text show.]</span></div>
<div class="line left">
<span class="bold small">wbug </span><span class="small">| index bits [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"save background, display menu"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bits &larr; self movingsetup.<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"wait until a mouse button is down"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">until⦂ user anybug do⦂ [].<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"get selection (possibly 0)"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">index &larr; self bugit.<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"restore background"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">frame bitsFromString: bits.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ index<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span></div>
<div class="line left">
<span class="bold small">zbug </span><span class="small">| index bits<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[bits &larr; self movingsetup.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ (index &larr; self bugit) = 0 do⦂ [].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">frame bitsFromString: bits.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ index<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span></div>
<div class="line left">
<span class="bold large"><br>Internal</span></div>
<div class="line left">
<span class="bold small">bugit </span><span class="small">| pt bits<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[user nobug ⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑0]</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"accidental bug returns 0"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">thisline comp.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ true do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[text frame has: (pt &larr; user mp) ⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[user anybug⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[thisline has: pt⇒[]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pt &larr; text ptofpt: pt.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">thisline comp.</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"selection follows mouse"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">thisline moveto: text frame origin x  ⌾ pt y.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">thisline comp]<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑1+ (thisline origin y-text frame origin y<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">/ text lineheight)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"return index"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">thisline comp. </span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"he left the menu"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">until⦂ [text frame has: user mp] do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[user nobug⇒[⇑0]] </span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"return 0 for abort"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">thisline comp]</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"he came back"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">movingsetup </span><span class="small">| pt bits<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[pt &larr; user mp - thisline center.</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"center prev item on mouse"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">text frame moveby: pt. thisline moveby: pt.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">frame moveby: pt.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bits &larr; frame bitsIntoString.</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"save background"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">frame clear: black. text show.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ bits<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪Menu under: &rsquo;Panes and Menus&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"OrganizationPane"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;OrganizationPane&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: ListPane<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;classPane selectorPane class&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;editmenu &rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>I am a list pane that displays the selector categories of a class.</span></div>
<div class="line left">
<span class="bold large"><br>Initialization</span></div>
<div class="line left">
<span class="bold small">class: class<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self of: (self listFor: class)]</span></div>
<div class="line left">
<span class="bold small">classInit<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[editmenu &larr; Menu new string: &rsquo;filout<br>print&rsquo;]</span></div>
<div class="line left">
<span class="bold small">from: classPane to: selectorPane</span></div>
<div class="line left">
<span class="bold small">listFor: class<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑[class≡nil⇒ [Vector new: 0]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">↪(ClassDefinition ClassOrganization) concat: class organization categories]]</span></div>
<div class="line left">
<span class="bold large"><br>Window protocol</span></div>
<div class="line left">
<span class="bold small">close<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[classPane &larr; nil. super close]</span></div>
<div class="line left">
<span class="bold small">yellowbug<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["If there is a selection, let the user choose a command from the menu."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">selection≤1⇒ [window flash]</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"Can&rsquo;t filout or print definition by itself"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">editmenu bug<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=1⇒ ["filout the selected category"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">selection=2⇒ [class filoutOrganization]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">class filoutCategory: list◦selection];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=2⇒ ["print the selected category"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">selection=2⇒ [window flash]</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"Can&rsquo;t print organization"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">class printoutCategory: list◦selection]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold large"><br>ListPane protocol</span></div>
<div class="line left">
<span class="bold small">deselected<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"I just lost my selection.  Tell selectorPane to display nothing."</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">selectorPane of: (Vector new: 0)]</span></div>
<div class="line left">
<span class="bold small">selected<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[selectorPane of: [selection≤2⇒ [Vector new: 0] class organization category: list◦selection]]</span></div>
<div class="line left">
<span class="bold large"><br>Browser protocol</span></div>
<div class="line left">
<span class="bold small">code: selector<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑class code: selector]</span></div>
<div class="line left">
<span class="bold small">compile: parag<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">| sel cat<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[class≡nil or⦂ selection=1⇒ [classPane compile: parag] </span><span class="italic small">"new definition"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">selection=2⇒ [class organization fromParagraph: parag. self class: class] </span><span class="italic small">"new organization"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">cat &larr; [selection=0⇒ [&rsquo;As yet unclassified&rsquo;] list◦selection].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">sel &larr; selectorPane compile: parag in: class under: cat⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self revise: (self listFor: class) with: cat.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">selection≠0⇒ [selectorPane revise: (class organization category: cat) with: sel]]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑false]</span></div>
<div class="line left">
<span class="bold small">dirty<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑selectorPane dirty]</span></div>
<div class="line left">
<span class="bold small">execute: parag<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑classⓢ parag]</span></div>
<div class="line left">
<span class="bold small">forget: selector </span><span class="small">| cat<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[class derstands: selector.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">cat &larr; list◦selection.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self revise: (self listFor: class) with: cat.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">selection&gt;0⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[selectorPane revise: (class organization category: cat) with: selector]]</span></div>
<div class="line left">
<span class="bold small">noCode<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[class≡nil⇒ [⇑classPane noCode]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">selection=0⇒ [⇑&rsquo;&rsquo;]; =1⇒ [⇑class definition]; =2⇒ [⇑class organization]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑&rsquo;Message name and Arguments | Temporary variables "short comment"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["long comment if necessary"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">Smalltalk<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">Statements]&rsquo;]</span></div>
<div class="line left">
<span class="bold small">spawn: selector with: parag formerly: oldparag<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[selectorPane compselection; select: 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">class edit: selector para: parag formerly: oldparag]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪OrganizationPane under: &rsquo;Panes and Menus&rsquo;.</span></div>
<div class="line left">
<span class="small">OrganizationPane classInit</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"ScrollBar"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;ScrollBar&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: Object<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;rect bitstr owner position&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;DownCursor UpCursor JumpCursor &rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>I am a bar to the left of an awake window.  With the cursor in me I can make that window scroll.</span></div>
<div class="line left">
<span class="bold large"><br>Initialization</span></div>
<div class="line left">
<span class="bold small">classInit<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[UpCursor &larr; Cursor new fromtext: &rsquo;<br>1000000000000000<br>1100000000000000<br>1110000000000000<br>1111000000000000<br>1111100000000000<br>1111110000000000<br>1100000000000000<br>1100000000000000<br>1100000000000000<br>1100000000000000<br>1100000000000000<br>1100000000000000<br>1100000000000000<br>1100000000000000<br>1100000000000000<br>1100000000000000&rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">DownCursor &larr; Cursor new fromtext: &rsquo;<br>1100000000000000<br>1100000000000000<br>1100000000000000<br>1100000000000000<br>1100000000000000<br>1100000000000000<br>1100000000000000<br>1100000000000000<br>1100000000000000<br>1100000000000000<br>1111110000000000<br>1111100000000000<br>1111000000000000<br>1110000000000000<br>1100000000000000<br>1000000000000000&rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">JumpCursor &larr; Cursor new fromtext: &rsquo;<br>0111000000000000<br>1111100000000000<br>1111100000000000<br>0111000000000000<br>0000000000000000<br>0000000000000000<br>0000000000000000<br>0000000000000000<br>0000000000000000<br>0000000000000000<br>0000000000000000<br>0000000000000000<br>0000000000000000<br>0000000000000000<br>0000000000000000<br>0000000000000000&rsquo; offset: 2⌾1]</span></div>
<div class="line left">
<span class="bold small">on: f from: o<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self on: f from: o at: o scrollPos]</span></div>
<div class="line left">
<span class="bold small">on: frame from: owner at: f<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[rect &larr; Rectangle new<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">origin: frame origin-(32⌾2)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">extent: 32⌾(frame height+4).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">position &larr; Rectangle new<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">origin: rect origin+(9⌾4)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">extent: 16⌾8.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self boxPosition&larr; f]</span></div>
<div class="line left">
<span class="bold large"><br>Scheduling</span></div>
<div class="line left">
<span class="bold small">close<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[owner&larr;nil]</span></div>
<div class="line left">
<span class="bold small">eachtime </span><span class="small">| p cx r</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">This needs to be restructured</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[rect has: (p&larr; user mp)⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[cx &larr; rect center x - 2.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">p x &lt; cx⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[r &larr; Rectangle new origin: rect origin corner: cx⌾rect maxY.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">DownCursor showwhile⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[while⦂ (r has: (p&larr;user mp)) do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self slide: p⇒[owner scrollTo: (position minY-rect minY-4) asFloat/(rect height-12)]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user redbug⇒[self reposition⦂[owner scrollUp: rect origin y - p y]]]]]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">r &larr; Rectangle new origin: cx⌾rect minY corner: rect corner.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">UpCursor showwhile⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[while⦂ (r has: (p&larr;user mp)) do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self slide: p⇒[owner scrollTo: (position minY-rect minY-4) asFloat/(rect height-12)]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user redbug⇒[self reposition⦂[owner scrollUp: p y - rect origin y]]]]]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑false]</span></div>
<div class="line left">
<span class="bold small">firsttime</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑rect has: user mp]</span></div>
<div class="line left">
<span class="bold small">lasttime</span></div>
<div class="line left">
<span class="bold small">slide: p </span><span class="small">| bug<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[position has: p⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[JumpCursor showwhile⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[bug &larr; false.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ ((position has: user mp) and⦂ bug≡false) do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[user redbug⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[bug &larr; true.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ user redbug do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self reshow⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[position moveto: position origin x⌾<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">((user mp y max: rect origin y+4) min: rect corner y-12)]]]]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑bug]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑false]</span></div>
<div class="line left">
<span class="bold large"><br>Image</span></div>
<div class="line left">
<span class="bold small">boxPosition&larr; f<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[position moveto: rect origin+<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(9⌾(4+(([f&lt;0.0⇒[0.0]; &gt;1.0⇒[1.0] f])*(rect height-16))))]</span></div>
<div class="line left">
<span class="bold small">hide </span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">restore background</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[bitstr≡nil⇒ [user notify: &rsquo;Attempt to hide unshown scrollbar&rsquo;]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">rect bitsFromString: bitstr.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitstr &larr; nil]</span></div>
<div class="line left">
<span class="bold small">hidewhile⦂ expr  </span><span class="small">| v<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self hide. v &larr; expr eval. self show. ⇑v]</span></div>
<div class="line left">
<span class="bold small">reposition⦂ expr<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self reshow⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[expr eval.  self boxPosition&larr; owner scrollPos]]</span></div>
<div class="line left">
<span class="bold small">reshow⦂ expr </span><span class="small">| r<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[r &larr; position inset: ¬2.  expr eval.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">r clear: white.  position outline]</span></div>
<div class="line left">
<span class="bold small">show</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">Save background and turn gray</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[bitstr &larr; rect bitsIntoString.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">rect clear: black.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(rect inset: 2⌾2 and: 1⌾2) clear: white.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">position outline]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪ScrollBar under: &rsquo;Panes and Menus&rsquo;.</span></div>
<div class="line left">
<span class="small">ScrollBar classInit</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"SelectorPane"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;SelectorPane&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: ListPane<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;organizationPane codePane&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;editmenu &rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>I am a ListPane whose entries are the message selectors of a category within a class.  Only organizationPane knows what the class and category are.  I make codePane display the code of my selected selector, if any.</span></div>
<div class="line left">
<span class="bold large"><br>Initialization</span></div>
<div class="line left">
<span class="bold small">classInit<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[editmenu &larr; Menu new string:<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">&rsquo;spawn<br>forget&rsquo;]</span></div>
<div class="line left">
<span class="bold small">from: organizationPane to: codePane</span></div>
<div class="line left">
<span class="bold large"><br>Window protocol</span></div>
<div class="line left">
<span class="bold small">close<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[organizationPane &larr; nil. super close]</span></div>
<div class="line left">
<span class="bold small">yellowbug<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[selection=0⇒ [window flash]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">scrollBar hidewhile⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[editmenu bug<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=1⇒ [organizationPane spawn: list◦selection with: codePane contents<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">formerly: codePane oldContents];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=2⇒ [organizationPane forget: list◦selection]]]</span></div>
<div class="line left">
<span class="bold large"><br>ListPane protocol</span></div>
<div class="line left">
<span class="bold small">deselected<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[codePane showing: organizationPane noCode]</span></div>
<div class="line left">
<span class="bold small">selected<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[codePane showing: (organizationPane code: list◦selection)]</span></div>
<div class="line left">
<span class="bold large"><br>Browser protocol</span></div>
<div class="line left">
<span class="bold small">compile: parag<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑organizationPane compile: parag]</span></div>
<div class="line left">
<span class="bold small">compile: parag in: class under: heading<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑codePane compile: parag in: class under: heading]</span></div>
<div class="line left">
<span class="bold small">dirty<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑codePane dirty]</span></div>
<div class="line left">
<span class="bold small">execute: parseStream for: codePane<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑codePane execute: parseStream in: false to: nil]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪SelectorPane under: &rsquo;Panes and Menus&rsquo;.</span></div>
<div class="line left">
<span class="small">SelectorPane classInit</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"StackPane"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;StackPane&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: ListPane<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;contextVarPane instanceVarPane codePane variables proceed&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;stackmenu &rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>I am a list pane that displays one or all of the stack below a context in a notify window.</span></div>
<div class="line left">
<span class="bold large"><br>Initialization</span></div>
<div class="line left">
<span class="bold small">classInit<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[stackmenu &larr; Menu new string:<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">&rsquo;stack<br>spawn<br>proceed<br>restart&rsquo;]</span></div>
<div class="line left">
<span class="bold small">context: contextVarPane at: level instance: instanceVarPane code: codePane<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[variables &larr; (Vector new: 16) asStream.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> proceed≡nil⇒[proceed &larr; (false, nil, level)]]</span></div>
<div class="line left">
<span class="bold small">context: contextVarPane instance: instanceVarPane code: codePane<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[variables &larr; (Vector new: 16) asStream.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> proceed≡nil⇒[proceed &larr; (false, nil, Top currentPriority)]]</span></div>
<div class="line left">
<span class="bold small">interrupt: flag<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[proceed◦1 &larr; flag]</span></div>
<div class="line left">
<span class="bold large"><br>Window protocol</span></div>
<div class="line left">
<span class="bold small">close<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[Top enable: proceed◦3. super close. list⇒ [(list◦1) releaseFully]]</span></div>
<div class="line left">
<span class="bold small">yellowbug<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[scrollBar hidewhile⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[stackmenu bug<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=1⇒ [</span><span class="italic small">"show a full backtrace"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> self revise: (list◦1) stack with: [selection=0⇒ [nil] list◦selection]];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=2⇒ [</span><span class="italic small">"spawn a code editor"</span><span class="small"> self spawn];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=3⇒ [</span><span class="italic small">"return to selected context"</span><span class="small"> self continue: false];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=4⇒ [</span><span class="italic small">"restart selected context"</span><span class="small"> self continue: true]]]</span></div>
<div class="line left">
<span class="bold large"><br>ListPane protocol</span></div>
<div class="line left">
<span class="bold small">deselected<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[contextVarPane ≡ false⇒ []<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">codePane showing: &rsquo;&rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">contextVarPane names: (Vector new: 0) values: ↪(nil) wrt: false.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">instanceVarPane names: (Vector new: 0) values: ↪(nil) wrt: false]</span></div>
<div class="line left">
<span class="bold small">locked<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑contextVarPane and⦂ (selection&gt;0 and⦂ self dirty)]</span></div>
<div class="line left">
<span class="bold small">selected </span><span class="small">| context instance code safeVec<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[contextVarPane ≡ false⇒ []<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">context &larr; list◦selection. instance &larr; context receiver.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">Decompiler new findPC: context pc.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">code &larr; self code.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">codePane showing: [code⇒ [code] &rsquo;&rsquo;].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">codePane selectRange: Decompiler new highlight.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">variables reset. context variableNamesInto: self with: nil.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[code⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[contextVarPane names: (↪(thisContext) concat: variables contents)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">values: (context, context tempframe) wrt: context.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> context tempframe≡nil⇒ [user notify: &rsquo;NIL TEMPFRAME&rsquo;]]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> contextVarPane names: ↪(thisContext) values: context inVector wrt: context].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">variables reset. instance class fieldNamesInto: self.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">safeVec &larr; Vector new: 2. safeVec all &larr; instance.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">instanceVarPane names: (↪(self) concat: variables contents) values: safeVec wrt: context.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">contextVarPane select: 1]</span></div>
<div class="line left">
<span class="bold large"><br>NotifyWindow protocol</span></div>
<div class="line left">
<span class="bold small">compile: parseStream </span><span class="small">| ctxt selector method mcl<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ctxt &larr; list◦(selection max: 1). mcl &larr; ctxt mclass.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> proceed◦2 &larr; selector &larr;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">codePane compile: parseStream in: mcl under: &rsquo;As yet unclassified&rsquo;⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> </span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[codePane reflects: selection⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[method &larr; mcl md methodorfalse: selector⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self releaseAboveSelection.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> </span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">ctxt restartWith: method. proceed◦1 &larr; true.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> </span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self of: list◦(selection to: list length) copy; select: 1]]]]</span></div>
<div class="line left">
<span class="bold small">dirty<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑codePane and⦂ codePane dirty]</span></div>
<div class="line left">
<span class="bold small">execute: parseStream for: codePane<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑proceed◦2 &larr;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">codePane execute: parseStream in: [selection=0⇒ [false] list◦selection] to: nil]</span></div>
<div class="line left">
<span class="bold large"><br>Private</span></div>
<div class="line left">
<span class="bold small">code </span><span class="small">| mclass selector </span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"code of my selected context"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[mclass &larr; (list ◦ selection) mclass.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">selector &larr; self selector.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑(mclass canunderstand: selector) and⦂ (mclass code: selector)]</span></div>
<div class="line left">
<span class="bold small">comment: s</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"called by selected via Class fieldNamesInto"</span></div>
<div class="line left">
<span class="bold small">contents</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"called by selected via Class fieldNamesInto"</span></div>
<div class="line left">
<span class="bold small">continue: restarting </span><span class="small">| ctxt<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"Close my window and resume my selected context, if any, else my first context.  If interrupted (proceed◦1) or restarting or a recompiled method, don&rsquo;t return a value; otherwise, return proceed◦2."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[user leftShiftKey ⇒[mem◦067 &larr; 58 "turn display off"]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[selection=0⇒ [selection&larr;1]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">ctxt &larr; list◦selection.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self releaseAboveSelection.</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"release abandoned contexts"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[restarting⇒ [ctxt restart]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> proceed◦1 and: selection=1⇒ [</span><span class="italic small">"resume after interrupt"</span><span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> ctxt push: proceed◦2].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">list &larr; false. </span><span class="italic small">"Inhibit me closing."</span><span class="small"> user topWindow vanish.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">list &larr; nil.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[proceed◦3=1⇒[thisContext sender release]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">Top run: ctxt at: proceed◦3.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">Top enable: proceed◦3.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">Top wakeup: proceed◦3.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">Top resetCurrent]</span></div>
<div class="line left">
<span class="bold small">declaration: dummy1 name: string asArg: dummy2<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[variables next &larr; string]</span></div>
<div class="line left">
<span class="bold small">identifier: s</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"called by selected via Class fieldNamesInto"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[variables next &larr; s]</span></div>
<div class="line left">
<span class="bold small">notify: msg </span><span class="italic small">"selected context doesnt know its variables"</span></div>
<div class="line left">
<span class="bold small">releaseAboveSelection<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[[selection&gt;1⇒ [(list◦(selection-1)) sender &larr; nil. (list◦1) release</span><span class="italic small">"Fully"</span><span class="small">]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(list◦(selection max: 1)) verifyFrames]</span></div>
<div class="line left">
<span class="bold small">selector </span><span class="small">| context<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[context &larr; list◦(selection max: 1).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑[context sender≡nil⇒ [false] context selector]]</span></div>
<div class="line left">
<span class="bold small">separator: c</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"called by selected via Class fieldNamesInto"</span></div>
<div class="line left">
<span class="bold small">spawn </span><span class="small">| mclass selector parag oldparag<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[mclass &larr; (list◦(selection max: 1)) mclass.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">selector &larr; self selector.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">parag &larr; [codePane⇒ [codePane contents] mclass canunderstand: selector⇒ [mclass code: selector] &rsquo;&rsquo;].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">oldparag &larr; [codePane⇒ [codePane oldContents] false].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self compselection; select: 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">mclass edit: selector para: parag formerly: oldparag]</span></div>
<div class="line left">
<span class="bold small">terminate </span><span class="italic small">"called by parser close during initialization"</span></div>
<div class="line left">
<span class="bold small">trailer: s</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"called by selected via Class fieldNamesInto"</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪StackPane under: &rsquo;Panes and Menus&rsquo;.</span></div>
<div class="line left">
<span class="small">StackPane classInit</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"SystemPane"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;SystemPane&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: ListPane<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;mySysOrgVersion classPane&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;sysmenu &rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>I am a list pane in which all the system categories are displayed.</span></div>
<div class="line left">
<span class="bold large"><br>Initialization</span></div>
<div class="line left">
<span class="bold small">classInit<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[sysmenu &larr; Menu new string: &rsquo;filout<br>print&rsquo;]</span></div>
<div class="line left">
<span class="bold small">to: classPane</span></div>
<div class="line left">
<span class="bold small">update<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self of: (↪(AllClasses SystemOrganization) concat: SystemOrganization categories). mySysOrgVersion&larr;user classNames]</span></div>
<div class="line left">
<span class="bold large"><br>Window protocol</span></div>
<div class="line left">
<span class="bold small">enter</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold small"> </span><span class="italic small">"be sure I am up to date"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[mySysOrgVersion≡user classNames⇒ [super enter]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">window outline. self update. super enter]</span></div>
<div class="line left">
<span class="bold small">leave</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold small"> </span><span class="italic small">"I am up to date"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[mySysOrgVersion &larr; user classNames. super leave]</span></div>
<div class="line left">
<span class="bold small">yellowbug<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[selection&lt;3⇒[window flash]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">scrollBar hidewhile⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[sysmenu bug<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=1⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[SystemOrganization filoutCategory: list◦selection];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=2⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[SystemOrganization printCategory: list◦selection]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold large"><br>ListPane protocol</span></div>
<div class="line left">
<span class="bold small">deselected<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[classPane of: (Vector new: 0)]</span></div>
<div class="line left">
<span class="bold small">selected<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[classPane of: self classes]</span></div>
<div class="line left">
<span class="bold large"><br>Browser protocol</span></div>
<div class="line left">
<span class="bold small">classes </span><span class="italic small">"return a Vector of the classes in my selected category"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[selection</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=1⇒ [⇑user classNames];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">≤2⇒ [⇑Vector new: 0]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑SystemOrganization category: list◦selection]</span></div>
<div class="line left">
<span class="bold small">compile: parag<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">| class cat className<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[selection=2⇒ [SystemOrganization fromParagraph: parag. self update] </span><span class="italic small">"new organization"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">cat &larr; [selection≤1⇒ [false] list◦selection].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">class &larr; nilⓢparag.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">class Is: Class⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[className &larr; class title unique.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[cat⇒ [SystemOrganization classify: className under: cat]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">mySysOrgVersion≡user classNames⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[selection&gt;0⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[classPane of: [cat⇒ [SystemOrganization category: cat] user classNames]]]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self update]]</span></div>
<div class="line left">
<span class="bold small">dirty<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑classPane dirty]</span></div>
<div class="line left">
<span class="bold small">forget: className<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[user notify: &rsquo;Class &rsquo;+className+&rsquo; will disappear if you proceed...&rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(Smalltalk◦className) noChanges; obsolete. Smalltalk delete: className.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">SystemOrganization delete: className.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">AllClassNames &larr; AllClassNames delete: className.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">classPane revise: self classes with: className]</span></div>
<div class="line left">
<span class="bold small">noCode<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[selection=0⇒ [⇑&rsquo;&rsquo;]; =2⇒ [⇑SystemOrganization]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑&rsquo;Class new title: &rsquo;&rsquo;NameOfClass&rsquo;&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">subclassof: Object<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">fields: &rsquo;&rsquo;names of fields&rsquo;&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">declare: &rsquo;&rsquo;names of class variables&rsquo;&rsquo;&rsquo; copy]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪SystemPane under: &rsquo;Panes and Menus&rsquo;.</span></div>
<div class="line left">
<span class="small">SystemPane classInit</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"VariablePane"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;VariablePane&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: ListPane<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;valuePane values context&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;varmenu &rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>I am a list pane that displays the names of variables in a context or instance.</span></div>
<div class="line left">
<span class="bold large"><br>Initialization</span></div>
<div class="line left">
<span class="bold small">classInit<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[varmenu &larr; Menu new string: &rsquo;inspect&rsquo;]</span></div>
<div class="line left">
<span class="bold small">names: vars values: values wrt: context<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self of: vars]</span></div>
<div class="line left">
<span class="bold small">to: valuePane<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[]</span></div>
<div class="line left">
<span class="bold large"><br>Window protocol</span></div>
<div class="line left">
<span class="bold small">yellowbug<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[selection=0⇒ [window flash]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">scrollBar hidewhile⦂ [varmenu bug =1⇒ [self value inspect]]]</span></div>
<div class="line left">
<span class="bold large"><br>ListPane protocol</span></div>
<div class="line left">
<span class="bold small">deselected<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[valuePane showing: &rsquo;&rsquo;]</span></div>
<div class="line left">
<span class="bold small">selected<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[valuePane showing: self value asString]</span></div>
<div class="line left">
<span class="bold large"><br>Notify/Inspect protocol</span></div>
<div class="line left">
<span class="bold small">compile: parag<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[window flash. ⇑false]</span></div>
<div class="line left">
<span class="bold small">execute: parseStream for: valuePane<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑valuePane execute: parseStream in: context to: values◦1]</span></div>
<div class="line left">
<span class="bold large"><br>Private</span></div>
<div class="line left">
<span class="bold small">value<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[selection=1⇒ [⇑values◦1] ⇑(values◦2) inspectfield: selection-1]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪VariablePane under: &rsquo;Panes and Menus&rsquo;.</span></div>
<div class="line left">
<span class="small">VariablePane classInit</span></div>
    <div class="line left">
<span class="small">&rsquo;From Smalltalk 5.5k XM November 24 on 22 November 1980 at 2:57:08 am.&rsquo;<br></span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large">"File"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;File&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: Dict<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;directory type name serialNumber pageReaders pageBuffer lastpn error&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;&rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">sharing: FilePool;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>A collection of FilePages usually on some device external to the virtual memory, which can be viewed and modified. File is a generalization: some examples are AltoFile and WoodstockFile. FilePage and FileDirectory are related classes. FileStream provides Stream access to Files.<br><br>Subclasses should override any superclass message implemented as [self subError]</span></div>
<div class="line left">
<span class="bold large"><br>Documentation</span></div>
<div class="line left">
<span class="bold small">help </span><span class="small">"<br><br>A common way to access a </span><span class="bold small">File</span><span class="small"> is through a </span><span class="bold small">FileStream</span><span class="small">.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">to create a FileStream on either an old or new file:<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">&lt;FileStream&gt; &larr; &lt;FileDirectory&gt; </span><span class="bold small">file:</span><span class="small"> &lt;String&gt;. (see also </span><span class="bold small">oldFile:</span><span class="small"> and </span><span class="bold small">newFile:</span><span class="small">)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">e.g. f &larr; dp0 file: &rsquo;test&rsquo;.<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">The default access mode (</span><span class="bold small">readwriteshorten</span><span class="small">) allows you to read or write, and<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">automatically shorten a File (to its current position) upon closing).  If you want to<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">only read a file, </span><span class="bold small">readonly</span><span class="small"> mode is faster and safer.<br><br>Some common ways to access a FileStream (see </span><span class="bold small">Stream</span><span class="small"> and </span><span class="bold small">FileStream</span><span class="small">):<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">reading a character (an Integer between 0 and 255)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold small">next, ◦</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">reading a String of characters<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold small">upto:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold small">, next:, nextString, contents</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">reading other kinds of objects<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold small">nextword, word:, nextNumber:, nextParagraph</span><span class="small"><br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">writing characters<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold small">next&larr;, ◦&larr;</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">writing a String of characters<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold small">append:, nextString&larr;</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">writing other kinds of objects<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold small">nextword, word:&larr;, print:</span><span class="small"><br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">finding position<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold small">position, wordposition, length, end, positionSize:</span><span class="small"><br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">changing position (besides reading/writing)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold small">position&larr;, skip:, skipTo:, reset, settoend, wordposition&larr;, position:size:<br></span><span class="small"><br>When finished with a FileStream, &lt;FileStream&gt; </span><span class="bold small">close</span><span class="small">.<br><br>For information about using or creating other views of file organizations (</span><span class="bold small">Btree</span><span class="small">, file-based object dictionaries, Findit), about WFS and Juniper files, and general file problems, see Steve Weyer.<br>"</span></div>
<div class="line left">
<span class="bold large"><br>Dictionary</span></div>
<div class="line left">
<span class="bold small">close</span></div>
<div class="line left">
<span class="bold small">entryClass </span><span class="small">["</span><span class="italic small">a subclass of FilePage</span><span class="small">" self subError]</span></div>
<div class="line left">
<span class="bold small">Find: page </span><span class="small">[⇑page pageNumber ≤ lastpn]</span></div>
<div class="line left">
<span class="bold small">found: page </span><span class="small">["</span><span class="italic small">read an existing page</span><span class="small">" self subError]</span></div>
<div class="line left">
<span class="bold small">makeEntry: page </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">page is: self entryClass⇒ [page init; serialNumber: serialNumber. ⇑page]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑[(self entryClass new) dictionary: self;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">init; pageNumber: page; serialNumber: serialNumber]]</span></div>
<div class="line left">
<span class="bold small">open </span><span class="small">["</span><span class="italic small">compute lastpn</span><span class="small">" self findLastPage]</span></div>
<div class="line left">
<span class="bold small">release</span></div>
<div class="line left">
<span class="bold small">reopen </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self sameFile⇒ []<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">init and directory access</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">directory get: self init].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self open]</span></div>
<div class="line left">
<span class="bold large"><br>DictionaryEntry</span></div>
<div class="line left">
<span class="bold small">dictionary </span><span class="small">[⇑directory]</span></div>
<div class="line left">
<span class="bold small">dictionary: directory</span></div>
<div class="line left">
<span class="bold small">init </span><span class="small">[lastpn &larr; false. error &larr; nullString. serialNumber &larr; String new: 4]</span></div>
<div class="line left">
<span class="bold small">match: entry </span><span class="small">[⇑self name match: entry name]</span></div>
<div class="line left">
<span class="bold small">name </span><span class="small">[⇑name]</span></div>
<div class="line left">
<span class="bold small">name: name</span></div>
<div class="line left">
<span class="bold small">printon: strm </span><span class="small">[strm append: name]</span></div>
<div class="line left">
<span class="bold large"><br>Initialize</span></div>
<div class="line left">
<span class="bold small">classInit </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">subclasses of File may want to share variables in pools.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">execute before filin:</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">Smalltalk declare: ↪XFilePool as: (SymbolTable new init: 16).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">in classInit:</span><span class="small"> XFilePool declare: ↪() as: ↪()"<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">FilePool declare: ↪(read write shorten) as: ↪(1 2 4)]</span></div>
<div class="line left">
<span class="bold small">sameFile </span><span class="small">"</span><span class="italic small">is File&rsquo;s current internal representation the same as what is stored externally? if so, usually can avoid some initialization, directory lookup</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑false]</span></div>
<div class="line left">
<span class="bold large"><br>Name</span></div>
<div class="line left">
<span class="bold small">serialNumber </span><span class="small">[⇑serialNumber]</span></div>
<div class="line left">
<span class="bold small">serialNumber: s </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">stored as a String of 4 characters rather than as various Numbers</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s is: String⇒ [serialNumber &larr; s]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s is: Substring⇒ [serialNumber &larr; s copy]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s is: Integer⇒ [serialNumber word: 1 &larr; 0; word: 2 &larr; s]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">Vector of Integers</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">serialNumber word: 1 &larr; s◦1; word: 2 &larr; s◦2]</span></div>
<div class="line left">
<span class="bold large"><br>FileDirectory</span></div>
<div class="line left">
<span class="bold small">delete </span><span class="small">[⇑directory delete: self]</span></div>
<div class="line left">
<span class="bold small">directory </span><span class="small">[⇑directory]</span></div>
<div class="line left">
<span class="bold small">directory: directory</span></div>
<div class="line left">
<span class="bold small">rename: newName </span><span class="small">[⇑directory rename: self newName: newName]</span></div>
<div class="line left">
<span class="bold small">type </span><span class="small">[⇑type]</span></div>
<div class="line left">
<span class="bold small">type: type </span><span class="small">"used by different Files in different ways, e.g. read/write mode"</span></div>
<div class="line left">
<span class="bold large"><br>File Length</span></div>
<div class="line left">
<span class="bold small">endFile: page </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">make File end with this FilePage. false means delete all of File</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self subError]</span></div>
<div class="line left">
<span class="bold small">findLastPage </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">the default definitions for </span><span class="bold small">findLastPage</span><span class="italic small"> and </span><span class="bold small">length</span><span class="italic small"> are circular.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">at least one of them must be defined by a subclass"<br></span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑lastpn &larr; self pageFrom: self length]</span></div>
<div class="line left">
<span class="bold small">lastFullPage </span><span class="small">[(self read: self lastPage) full⇒ [⇑lastpn] ⇑lastpn-1]</span></div>
<div class="line left">
<span class="bold small">lastPage </span><span class="small">["</span><span class="italic small">length in pages</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">lastpn⇒ [⇑lastpn] ⇑self findLastPage]</span></div>
<div class="line left">
<span class="bold small">lastPage: lastpn </span><span class="small">"</span><span class="italic small">for those who know what they&rsquo;re doing</span><span class="small">"</span></div>
<div class="line left">
<span class="bold small">length </span><span class="small">| page [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">length in characters</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">page &larr; self read: self lastPage.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑lastpn-1 * page dataLength + page length]</span></div>
<div class="line left">
<span class="bold small">pageFrom: len </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">compute page number for a character index</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑(len-1 / self entryClass new dataLength) asSmall+ 1]</span></div>
<div class="line left">
<span class="bold large"><br>FilePage</span></div>
<div class="line left">
<span class="bold small">doCommand: com page: page error: s </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">execute a File command on page. if an error occurs, include<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">error &larr; &rsquo;some error message&rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑self error: s<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">if s is false, returns false.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">otherwise s is passed to an error routine</span><span class="small">" self subError]</span></div>
<div class="line left">
<span class="bold small">error </span><span class="small">[⇑error]</span></div>
<div class="line left">
<span class="bold small">error: e </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">e⇒ [e &larr; [(Stream default) append: name; append: &rsquo; in &rsquo;; append: e;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">append: &rsquo;, &rsquo;; append: error; contents].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">error &larr; nullString.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑super error: e]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑false]</span></div>
<div class="line left">
<span class="bold small">Get: page </span><span class="small">| p pn [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pn &larr; page pageNumber.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">p &larr; self Read: page⇒ [⇑p]<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">current last page of the file is assumed full</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ p from: lastpn+1 to: pn-1 do⦂ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">page pageNumber: p.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">page &larr; self Write: page].<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">return an empty last page which is not written yet</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">page pageNumber: pn; length: 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑page]</span></div>
<div class="line left">
<span class="bold small">get: pn </span><span class="small">[⇑self Get: (self makeEntry: pn)]</span></div>
<div class="line left">
<span class="bold small">newPage </span><span class="small">[⇑self makeEntry: 0]</span></div>
<div class="line left">
<span class="bold small">newPage: pn </span><span class="small">[⇑self makeEntry: pn]</span></div>
<div class="line left">
<span class="bold small">Read: page </span><span class="small">["</span><span class="italic small">return page or false</span><span class="small">" self subError]</span></div>
<div class="line left">
<span class="bold small">read: pn </span><span class="small">[⇑self Read: (self makeEntry: pn)]</span></div>
<div class="line left">
<span class="bold small">Write: page </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">update </span><span class="bold small">lastpn</span><span class="italic small">, write page and return result (maybe next page)</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self subError]</span></div>
<div class="line left">
<span class="bold large"><br>FileStream</span></div>
<div class="line left">
<span class="bold small">asStream </span><span class="small">[⇑(FileStream new) on: [self open; get: 1]]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪File under: &rsquo;Files&rsquo;.</span></div>
<div class="line left">
<span class="small">File classInit</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"FileDirectory"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;FileDirectory&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: Dict<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;directory fileReaders&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;&rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">sharing: FilePool;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>A collection of Files. FileDirectory is a generalization: some examples are AltoFileDirectory and WoodstockFileDirectory</span></div>
<div class="line left">
<span class="bold large"><br>Dictionary</span></div>
<div class="line left">
<span class="bold small">checkName: s </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">default behavior is to get rid of ending period.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">subclasses can do any kind of checking they want and<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">return false if name is no good</span><span class="small">"<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s empty or⦂ s last ≠ (&rsquo;.&rsquo;◦1)⇒ [⇑s]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑s copy: 1 to: s length-1]</span></div>
<div class="line left">
<span class="bold small">close </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self obsolete⇒ []<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">externalViews delete: self.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self release]</span></div>
<div class="line left">
<span class="bold small">entryClass </span><span class="small">["</span><span class="italic small">a subclass of File</span><span class="small">" self subError]</span></div>
<div class="line left">
<span class="bold small">error: e entry: file </span><span class="small">[⇑file error: e]</span></div>
<div class="line left">
<span class="bold small">Find: file </span><span class="small">| name [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">name &larr; self checkName: file name⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">file name: name.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑self Position &larr; file]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">file error: &rsquo;illegal name&rsquo;]</span></div>
<div class="line left">
<span class="bold small">insert: file </span><span class="small">| old [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"note: this changes the default behavior found in Dict.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">this creates a new version rather than generating an error if the name exists"<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">file &larr; self makeEntry: file.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self versionNumbers⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"ignore explicit version and directory will create a next version"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">file &larr; self makeEntry: (file name asStream upto: &rsquo;!&rsquo;◦1)]<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self Find: file⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">old &larr; self makeEntry: (file name + &rsquo;$&rsquo;).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"otherwise, if the file already exists,<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">rename it to name$, deleting that file first if it exists"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self Find: old⇒ [self Delete: old]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self rename: file name newName: old name.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"reposition to original name"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self Find: file⇒ [self error: &rsquo;insert/rename ??&rsquo; entry: file]]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"file didn&rsquo;t exist"].<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self Insert: file.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑file]</span></div>
<div class="line left">
<span class="bold small">open </span><span class="small">[externalViews insert: self]</span></div>
<div class="line left">
<span class="bold small">printon: strm </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">strm append: [self obsolete⇒ [&rsquo;a closed &rsquo;] &rsquo;an open &rsquo;];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">append: self class title;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">append: &rsquo; on &rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self server printon: strm]</span></div>
<div class="line left">
<span class="bold large"><br>DictionaryEntry</span></div>
<div class="line left">
<span class="bold small">dictionary </span><span class="small">[⇑directory]</span></div>
<div class="line left">
<span class="bold small">dictionary: directory</span></div>
<div class="line left">
<span class="bold large"><br>Initialize</span></div>
<div class="line left">
<span class="bold small">directory: directory</span></div>
<div class="line left">
<span class="bold large"><br>File</span></div>
<div class="line left">
<span class="bold small">allocateSN: file </span><span class="small">["</span><span class="italic small">allocate a new serial number for a File</span><span class="small">" self subError]</span></div>
<div class="line left">
<span class="bold small">directory </span><span class="small">[⇑directory]</span></div>
<div class="line left">
<span class="bold small">newPage </span><span class="small">["</span><span class="italic small">return a dummy FilePage from a dummy File</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑(self makeEntry: nullString) newPage]</span></div>
<div class="line left">
<span class="bold small">versionNumbers </span><span class="small">["generally, version numbers are not supported" ⇑false]</span></div>
<div class="line left">
<span class="bold large"><br>FileStream</span></div>
<div class="line left">
<span class="bold small">file: name </span><span class="small">[⇑(self get: name) asStream]</span></div>
<div class="line left">
<span class="bold small">filin: s </span><span class="small">[self filin: s format: 1]</span></div>
<div class="line left">
<span class="bold small">filin: s format: ft </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">read Class definitions or Changes from FileStreams or PressFiles<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">ft: 1 (FileStream=Bravo), 2 (Press)</span><span class="small">"<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user displayoffwhile⦂ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s is: Vector⇒ [for⦂ s from: s do⦂ [self filin: s format: ft]]<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">special case for Alto and patterns</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(s is: String) and⦂ ((s has: &rsquo;*&rsquo;◦1) or⦂ (s has: &rsquo;#&rsquo;◦1))⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self filin: (self filesMatching: s) format: ft]<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[s is: UniqueString⇒ ["</span><span class="italic small">Class name</span><span class="small">" s &larr; s + [ft=1⇒ [&rsquo;.st&rsquo;] &rsquo;.press&rsquo;]]].<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">([ft=1⇒ [self oldFile: s] self pressfile: s]) filin]]</span></div>
<div class="line left">
<span class="bold small">newFile: name </span><span class="small">[⇑(self insert: name) asStream]</span></div>
<div class="line left">
<span class="bold small">oldFile: name </span><span class="small">[⇑(self find: name) asStream]</span></div>
<div class="line left">
<span class="bold small">pressfile: name </span><span class="small">[⇑PressFile new of: (self file: name)]</span></div>
<div class="line left">
<span class="bold small">pressfilin: s </span><span class="small">[self filin: s format: 2]</span></div>
<div class="line left">
<span class="bold large"><br>FTP</span></div>
<div class="line left">
<span class="bold small">asFtpDirectory </span><span class="small">| ftp [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"to allow convenient (kludgey) access to file servers (e.g. phylum, dpj) via Ftp"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(ftp &larr; FtpDirectory new) server: self server; open.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ftp userName empty⇒ [ftp login: self userName password: self userPassword]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ftp]</span></div>
<div class="line left">
<span class="bold small">login: name </span><span class="small">[⇑self login: name password: &rsquo;&rsquo; "</span><span class="italic small">or prompt?</span><span class="small">"]</span></div>
<div class="line left">
<span class="bold small">login: name password: pw </span><span class="small">[self subError]</span></div>
<div class="line left">
<span class="bold small">retrieve: s </span><span class="small">| t [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s is: Vector⇒ [for⦂ t from: s do⦂ [self retrieve: t as: t]]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑self retrieve: s as: s]</span></div>
<div class="line left">
<span class="bold small">retrieve: s1 as: s2 </span><span class="small">| f [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self exists: s1⇒ [f &larr; self oldFile: s1] ⇑false].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">f readonly.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">([s2 is: FileStream⇒ [s2] dp0 file: s2]) append: f; close.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">f close]</span></div>
<div class="line left">
<span class="bold small">server </span><span class="small">[⇑directory]</span></div>
<div class="line left">
<span class="bold small">server: directory</span></div>
<div class="line left">
<span class="bold small">store: s </span><span class="small">| t [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s is: Vector⇒ [for⦂ t from: s do⦂ [self store: t as: t]]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑self store: s as: s]</span></div>
<div class="line left">
<span class="bold small">store: s1 as: s2 </span><span class="small">| f [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[s1 is: FileStream⇒ [f &larr; s1] dp0 exists: s1⇒ [f &larr; dp0 oldFile: s1] ⇑false].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">f readonly.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(self file: s2) append: f; close.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">f close]</span></div>
<div class="line left">
<span class="bold small">userName </span><span class="small">[⇑[currentProfile≡nil⇒ [&rsquo;&rsquo;] currentProfile userName: self server]]</span></div>
<div class="line left">
<span class="bold small">userPassword </span><span class="small">[⇑[currentProfile≡nil⇒ [&rsquo;&rsquo;] currentProfile userPassword: self server]]</span></div>
<div class="line left">
<span class="bold large"><br>Juniper</span></div>
<div class="line left">
<span class="bold small">closeTransaction </span><span class="small">"</span><span class="italic small">default is to do nothing</span><span class="small">"</span></div>
<div class="line left">
<span class="bold small">exceptionHandler: eh </span><span class="small">"</span><span class="italic small">default is to do nothing</span><span class="small">"</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪FileDirectory under: &rsquo;Files&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"FilePage"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;FilePage&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: Dict<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;file page&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;&rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">sharing: FilePool;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>A block, chunk, or page of information from some collection of pages (a File).  FilePage is a generalization: some examples are AltoFilePage and WoodstockFilePage</span></div>
<div class="line left">
<span class="bold large"><br>Dictionary</span></div>
<div class="line left">
<span class="bold small">◦i </span><span class="small">[⇑page◦(self checkIndex: i)]</span></div>
<div class="line left">
<span class="bold small">◦i &larr; v </span><span class="small">[⇑page◦(self checkIndex: i) &larr; v]</span></div>
<div class="line left">
<span class="bold small">asStream </span><span class="small">[⇑self asStream: Stream new]</span></div>
<div class="line left">
<span class="bold small">reopen </span><span class="small">[file reopen; makeEntry: self "</span><span class="italic small">self may have been released</span><span class="small">"]</span></div>
<div class="line left">
<span class="bold large"><br>DictionaryEntry</span></div>
<div class="line left">
<span class="bold small">dictionary </span><span class="small">[⇑file]</span></div>
<div class="line left">
<span class="bold small">dictionary: file</span></div>
<div class="line left">
<span class="bold small">init </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[page≡nil⇒ ["self page:" page &larr; String new: self pageLength]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self length: 0"not sure who depends on this besides FileStream read:"]</span></div>
<div class="line left">
<span class="bold small">name: sp </span><span class="small">[self init; serialNumber: sp◦1; pageNumber: sp◦2]</span></div>
<div class="line left">
<span class="bold large"><br>Initialize</span></div>
<div class="line left">
<span class="bold small">file: file</span></div>
<div class="line left">
<span class="bold small">page: page</span></div>
<div class="line left">
<span class="bold large"><br>File</span></div>
<div class="line left">
<span class="bold small">doCommand: com error: s </span><span class="small">[⇑file doCommand: com page: self error: s]</span></div>
<div class="line left">
<span class="bold small">endFile </span><span class="small">[⇑file endFile: self]</span></div>
<div class="line left">
<span class="bold small">file </span><span class="small">[⇑file]</span></div>
<div class="line left">
<span class="bold small">get: pn </span><span class="small">["</span><span class="italic small">recycle self</span><span class="small">" self pageNumber: pn; length: 0. ⇑file Get: self]</span></div>
<div class="line left">
<span class="bold small">read: pn </span><span class="small">["</span><span class="italic small">recycle self</span><span class="small">" self pageNumber: pn; length: 0. ⇑file Read: self]</span></div>
<div class="line left">
<span class="bold small">write </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">some files, e.g. AltoFile, will return a last empty page instead of a full one</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑file Write: self]</span></div>
<div class="line left">
<span class="bold large"><br>Page</span></div>
<div class="line left">
<span class="bold small">address </span><span class="small">["</span><span class="italic small">page address, e.g. on a disk</span><span class="small">" self subError]</span></div>
<div class="line left">
<span class="bold small">address: a </span><span class="small">[self subError]</span></div>
<div class="line left">
<span class="bold small">asStream: s </span><span class="small">| offset [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">offset &larr; self headerLength.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑s of: self dataString from: offset+1 to: offset+self length "self dataEnd"]</span></div>
<div class="line left">
<span class="bold small">checkIndex: i </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">i &gt; 0 and⦂ i ≤ self length⇒ [⇑i + self headerLength]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self error: &rsquo;illegal index&rsquo;]</span></div>
<div class="line left">
<span class="bold small">dataBeginning </span><span class="small">[⇑self headerLength]</span></div>
<div class="line left">
<span class="bold small">dataEnd </span><span class="small">["</span><span class="italic small">logical end of data in page</span><span class="small">" ⇑self headerLength + self length]</span></div>
<div class="line left">
<span class="bold small">dataEnd: pos </span><span class="small">[self length: pos - self headerLength]</span></div>
<div class="line left">
<span class="bold small">dataLength </span><span class="small">["</span><span class="italic small">physical length of data in page. default</span><span class="small">" ⇑512]</span></div>
<div class="line left">
<span class="bold small">dataMaxEnd </span><span class="small">["</span><span class="italic small">physical end of data in page</span><span class="small">" ⇑self headerLength + self dataLength]</span></div>
<div class="line left">
<span class="bold small">dataString </span><span class="small">[⇑page]</span></div>
<div class="line left">
<span class="bold small">full </span><span class="small">[⇑self length = self dataLength]</span></div>
<div class="line left">
<span class="bold small">header: n </span><span class="small">["</span><span class="italic small">return n-th header word</span><span class="small">" ⇑page word: n]</span></div>
<div class="line left">
<span class="bold small">header: n &larr; v </span><span class="small">["</span><span class="italic small">set and return n-th header word</span><span class="small">" ⇑page word: n &larr; v]</span></div>
<div class="line left">
<span class="bold small">headerLength </span><span class="small">["</span><span class="italic small">length of stuff before data begins in page</span><span class="small">" ⇑0]</span></div>
<div class="line left">
<span class="bold small">lastPage </span><span class="small">["</span><span class="italic small">is this last page in file?</span><span class="small">" ⇑self pageNumber ≥ file lastPage]</span></div>
<div class="line left">
<span class="bold small">length </span><span class="small">["</span><span class="italic small">logical length of data in page</span><span class="small">" self subError]</span></div>
<div class="line left">
<span class="bold small">length: len </span><span class="small">[self subError]</span></div>
<div class="line left">
<span class="bold small">page </span><span class="small">[⇑page]</span></div>
<div class="line left">
<span class="bold small">pageLength </span><span class="small">["</span><span class="italic small">physical size of page</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑self headerLength + self dataLength + self trailerLength]</span></div>
<div class="line left">
<span class="bold small">pageNumber </span><span class="small">[self subError]</span></div>
<div class="line left">
<span class="bold small">pageNumber: pn </span><span class="small">[self subError]</span></div>
<div class="line left">
<span class="bold small">serialNumber </span><span class="small">[⇑file serialNumber]</span></div>
<div class="line left">
<span class="bold small">serialNumber: sn </span><span class="small">[self subError]</span></div>
<div class="line left">
<span class="bold small">trailerLength </span><span class="small">["</span><span class="italic small">length of stuff after data ends in page</span><span class="small">" ⇑0]</span></div>
<div class="line left">
<span class="bold small">word: i </span><span class="small">["</span><span class="italic small">no bounds checking</span><span class="small">" ⇑page word: self headerLength/2 + i]</span></div>
<div class="line left">
<span class="bold small">word: i &larr; v </span><span class="small">["</span><span class="italic small">no bounds checking</span><span class="small">" ⇑page word: self headerLength/2 + i &larr; v]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪FilePage under: &rsquo;Files&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"EtherFilePage"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;EtherFilePage&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: FilePage<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;&rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>A FilePage which consists of an ethernet packet (Pacbuf) containing network information, header info and data</span></div>
<div class="line left">
<span class="bold large"><br>FilePage</span></div>
<div class="line left">
<span class="bold small">dataString </span><span class="small">[⇑page pupString]</span></div>
<div class="line left">
<span class="bold small">header: n </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">for accessing information after pup header, e.g. file commands and parameters.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">n = 1 to (self headerLength-24)/2</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑page word: 12+n]</span></div>
<div class="line left">
<span class="bold small">header: n &larr; v </span><span class="small">[⇑page word: 12+n &larr; v]</span></div>
<div class="line left">
<span class="bold small">headerLength </span><span class="small">[⇑44 "</span><span class="italic small">ethernet encap.(4), pup header(20), file label (20=default)</span><span class="small">"]</span></div>
<div class="line left">
<span class="bold small">init </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[page≡nil⇒ ["self page:" page &larr; file allocatePage]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self length: 0]</span></div>
<div class="line left">
<span class="bold small">length </span><span class="small">[⇑page pupLength - (self headerLength - 2)]</span></div>
<div class="line left">
<span class="bold small">length: len </span><span class="small">[page pupLength &larr; len + self headerLength - 2]</span></div>
<div class="line left">
<span class="bold small">trailerLength </span><span class="small">[⇑2 "</span><span class="italic small">checksum</span><span class="small">"]</span></div>
<div class="line left">
<span class="bold large"><br>Ether</span></div>
<div class="line left">
<span class="bold small">packet </span><span class="small">[⇑page]</span></div>
<div class="line left">
<span class="bold small">pupType </span><span class="small">[⇑page pupType]</span></div>
<div class="line left">
<span class="bold small">pupType&larr; p </span><span class="small">[⇑page pupType&larr; p]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪EtherFilePage under: &rsquo;Files&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"FileStream"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;FileStream&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: Stream<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;page dirty rwmode&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;&rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">sharing: FilePool;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>A Stream which windows a File. see File example</span></div>
<div class="line left">
<span class="bold large"><br>Dictionary</span></div>
<div class="line left">
<span class="bold small">close </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self obsolete⇒ []<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self writing⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">rwmode anymask: shorten⇒ [self shorten]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self flush]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"self release (sort of)"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">dirty &larr; limit &larr; 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self file close.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">externalViews delete: self]</span></div>
<div class="line left">
<span class="bold small">file </span><span class="small">[⇑page file]</span></div>
<div class="line left">
<span class="bold small">obsolete </span><span class="small">[⇑dirty]</span></div>
<div class="line left">
<span class="bold small">release </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self obsolete⇒ []<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">dirty &larr; limit &larr; 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self file release]</span></div>
<div class="line left">
<span class="bold small">reopen </span><span class="small">| pos [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">dirty "self obsolete"⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">reopen to current position</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pos &larr; position.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self read: page pageNumber⇒ [position &larr; pos min: limit]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">if that page doesn&rsquo;t exist, go to last one that does.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">note that settoend would be recursive</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self read: (self file lastPage)⇒ [position &larr; limit]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self error: &rsquo;cannot reopen or settoend&rsquo;]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑false]</span></div>
<div class="line left">
<span class="bold large"><br>Initialize</span></div>
<div class="line left">
<span class="bold small">on: page </span><span class="italic small">"some page from a File, usually page 1, or another FileStream</span><span class="small">" [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[page is: FileStream⇒ [page &larr; page page]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">page asStream: self.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">externalViews insert: self.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"obsolete flag"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">dirty &larr; false]</span></div>
<div class="line left">
<span class="bold large"><br>Access Modes</span></div>
<div class="line left">
<span class="bold small">readonly </span><span class="small">[self setMode: read]</span></div>
<div class="line left">
<span class="bold small">readwrite </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">allow read and write but don&rsquo;t automatically shorten</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self setMode: read + write]</span></div>
<div class="line left">
<span class="bold small">readwriteshorten </span><span class="small">["</span><span class="italic small">allow read and write and shorten File upon closing</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self setMode: read+write+shorten]</span></div>
<div class="line left">
<span class="bold small">setMode: m </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">rwmode = m⇒ []<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">don&rsquo;t flush if first time or not write mode or continuing write mode</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[rwmode≡nil or⦂ ((rwmode nomask: write) or⦂ (m anymask: write))⇒ []<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self flush].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">rwmode &larr; m]<br></span></div>
<div class="line left">
<span class="bold small">writeshorten </span><span class="small">["</span><span class="italic small">allow write and shorten File upon closing. in general, this would be faster for overwriting Files since pages might not have to be read first. at present, treated same as </span><span class="bold small">readwriteshorten</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self setMode: write+shorten]</span></div>
<div class="line left">
<span class="bold small">writing </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">rwmode≡nil⇒ ["</span><span class="italic small">default mode. true</span><span class="small">" ⇑self readwriteshorten]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑(rwmode land: write) = write]</span></div>
<div class="line left">
<span class="bold large"><br>Stream</span></div>
<div class="line left">
<span class="bold small">◦i </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self position &larr; i-1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑self next]</span></div>
<div class="line left">
<span class="bold small">◦i &larr; v </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self position &larr; i-1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑self next &larr; v]</span></div>
<div class="line left">
<span class="bold small">append: s </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"try to make some special cases go much faster"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[s is: String⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s length &gt; 80⇒ [self writeString: s from: 1 to: s length. ⇑s]]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s is: Stream⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(s limit - s position &gt; 80) and⦂ (s asArray is: String)⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self writeString: s asArray from: s position+1 to: s limit. ⇑s]]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s is: FileStream⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self writeFile: s for: nil. ⇑s]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">].<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑super append: s]</span></div>
<div class="line left">
<span class="bold small">contents </span><span class="small">| s ["</span><span class="italic small">read all of a File</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self readonly; reset.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s &larr; self next: self length.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self close.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑s]</span></div>
<div class="line left">
<span class="bold small">end </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self reopen.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">position &lt; limit⇒ [⇑false]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self read: page pageNumber+1⇒ [⇑"page empty" position = limit]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑true]</span></div>
<div class="line left">
<span class="bold small">into: s endError: err </span><span class="small">| charsRead len t [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">len &larr; s  length.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[len &gt; 80⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">charsRead &larr; len - (self readString: s from: 1 to: len)]<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"in line: super into: s endError: err"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">charsRead &larr; 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"read until count or stream is exhausted"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ (charsRead &lt; len and⦂ (t &larr; self next)) do⦂ [s◦(charsRead &larr; charsRead+1) &larr;t]].<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">err⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">charsRead = len⇒ [⇑s]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user notify: &rsquo;only read first &rsquo; + charsRead asString]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑charsRead]</span></div>
<div class="line left">
<span class="bold small">length </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">page lastPage⇒ [⇑page pageNumber-1 * page dataLength + page length]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑self file length]</span></div>
<div class="line left">
<span class="bold small">next: n from: strm </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">n &gt; 80 and⦂ (strm is: FileStream)⇒ [self writeFile: strm for: n]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑super next: n from: strm]</span></div>
<div class="line left">
<span class="bold small">pastend </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self reopen or⦂ (page lastPage≡false and⦂ self nextPage)⇒ [⇑self next]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑false]</span></div>
<div class="line left">
<span class="bold small">pastend&larr; v </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self writing⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self reopen⇒ [⇑self next &larr; v]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[limit &lt; page dataMaxEnd or⦂ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self nextPage⇒ [position=limit]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self error: &rsquo;could not get page&rsquo;]⇒ [limit &larr; page dataMaxEnd]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑self next&larr; v]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self error: &rsquo;no writing allowed&rsquo;]</span></div>
<div class="line left">
<span class="bold small">position </span><span class="small">[⇑self positionSize: 1]</span></div>
<div class="line left">
<span class="bold small">position&larr; p </span><span class="small">[⇑self position: p size: 1]</span></div>
<div class="line left">
<span class="bold small">printon: strm </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">super printon: strm.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">strm append: &rsquo; on &rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self file printon: strm]</span></div>
<div class="line left">
<span class="bold small">reset </span><span class="small">["self position &larr; 0"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self read: 1⇒ []<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self error: &rsquo;reset&rsquo;]</span></div>
<div class="line left">
<span class="bold small">settoend </span><span class="small">["self position &larr; self length"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">make sure file is open so lastPage is correct</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self reopen.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">when writing on the last page, lastPage may be too small</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self read: (self file lastPage max: page pageNumber)⇒ [position &larr; limit]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self error: &rsquo;settoend???&rsquo;]</span></div>
<div class="line left">
<span class="bold small">skip: n </span><span class="small">| p plen [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">n=0⇒ []<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self reopen.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">p &larr; position + n.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[n &gt; 0⇒ [p ≥ limit]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self fixEnd "</span><span class="italic small">important on last page</span><span class="small">".<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">p &lt; page dataBeginning]⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">simply: self position &larr; self position + n.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">however, since we are incurable optimizers...</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">plen &larr; page dataLength.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">assume p is not Large, otherwise use intdiv:</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">p &larr; p - page dataBeginning.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self positionPage: (page pageNumber + [n &lt; 0⇒ [(p+1)/plen - 1] p/plen])<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">character: p \ plen⇒ []<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self error: &rsquo;cannot skip &rsquo; + n asString]<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">same page</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">position &larr; p]</span></div>
<div class="line left">
<span class="bold small">word: i </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self wordposition &larr; i-1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑self nextword]</span></div>
<div class="line left">
<span class="bold small">word: i &larr; v </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self wordposition &larr; i-1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑self nextword &larr; v]</span></div>
<div class="line left">
<span class="bold small">wordposition </span><span class="small">[⇑self positionSize: 2]</span></div>
<div class="line left">
<span class="bold small">wordposition&larr; w </span><span class="small">[⇑self position: w size: 2]</span></div>
<div class="line left">
<span class="bold large"><br>File</span></div>
<div class="line left">
<span class="bold small">directory </span><span class="small">[⇑self file directory]</span></div>
<div class="line left">
<span class="bold small">fixEnd </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self writing and⦂ position &gt; page dataEnd⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">fix the end of page</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">page dataEnd: (limit &larr; position)]]</span></div>
<div class="line left">
<span class="bold small">flush </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self obsolete⇒ [⇑page]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self fixEnd.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑page write]</span></div>
<div class="line left">
<span class="bold small">name </span><span class="small">[⇑self file name]</span></div>
<div class="line left">
<span class="bold small">nextPage </span><span class="small">[⇑self read: page pageNumber+1]</span></div>
<div class="line left">
<span class="bold small">pad: size </span><span class="small">| rem [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"skip to next boundary of size and return how many characters skipped"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">rem &larr; (([page dataLength \ size = 0⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">position - page dataBeginning] self position]) \ size) asSmall.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">rem = 0⇒ [⇑0]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self skip: size - rem.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑size - rem]</span></div>
<div class="line left">
<span class="bold small">pad: size with: val </span><span class="small">| rem [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"pad to next boundary of size and return how many characters padded"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">rem &larr; (([page dataLength \ size = 0⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">position - page dataBeginning] self position]) \ size) asSmall.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">rem = 0⇒ [⇑0]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self next: size - rem &larr; val.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑size - rem]</span></div>
<div class="line left">
<span class="bold small">page </span><span class="small">[⇑page]</span></div>
<div class="line left">
<span class="bold small">position: objpos size: size </span><span class="small">| len pn c pos [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">set the current character position and the current page<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">from the position of an object of a given size (see </span><span class="bold small">positionSize:</span><span class="italic small">)</span><span class="small">"<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">len &larr; page dataLength.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[size = len⇒ ["</span><span class="italic small">page size</span><span class="small">" pn &larr; objpos+1. c &larr; 0]<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pos &larr; objpos.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[size = 1⇒ []<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">len \ size = 0⇒ ["</span><span class="italic small">page length is a multiple of size</span><span class="small">" len &larr; len / size]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pos &larr; objpos * size.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">size &larr; 1].<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">obtain quotient (page) and remainder (position)</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pos &larr; pos intdiv: len.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pn &larr; 1 + (pos◦1) asSmall.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">c &larr; size * (pos◦2) asSmall].<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self positionPage: pn character: c⇒ [⇑objpos]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self error: &rsquo;cannot read page &rsquo; + pn asString]</span></div>
<div class="line left">
<span class="bold small">positionPage: pn character: c </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">normally accessed by </span><span class="bold small">position:size:, skip:</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self read: pn⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">c assumed between 0 and page dataLength. position, limit were set in </span><span class="bold small">on:</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">position &larr; position + c.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">position ≤ limit or⦂ self writing⇒ [⇑true]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">position &larr; limit.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑false]<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">c=0⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">try end of previous page</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑self positionPage: pn-1 character: page dataLength]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑false]</span></div>
<div class="line left">
<span class="bold small">positionSize: size </span><span class="small">| len pos [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">compute the position for an object of a given size,<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">e.g. characters (1), words (2), fixed length (n),<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">from the current character position and the current page</span><span class="small">"<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">len &larr; page dataLength.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">size = 1 or⦂ len \ size ≠ 0⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pos &larr; page pageNumber-1 * len + (position - page dataBeginning).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">size=1⇒ [⇑pos]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑pos / size]<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">page length is a multiple of size</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑page pageNumber-1 * (len/size) + <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(position - page dataBeginning / size)]</span></div>
<div class="line left">
<span class="bold small">read: pn </span><span class="small">| p [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">normally accessed by </span><span class="bold small">nextPage, position:size:, reopen, reset, settoend</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pn &lt; 1⇒ [⇑false]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self obsolete⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">reopen the file, (re)read the page</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">page reopen.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">p &larr; page read: pn⇒ [self on: p]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑false]<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pn = page pageNumber and⦂ (page length &gt; 0 or⦂ position &gt; page dataBeginning)⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self fixEnd.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">page asStream: self]<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">current page has wrong page number or is empty (possibly from error)</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self writing⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[[pn &gt; page pageNumber and⦂ page full≡false⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">fill up last page when positioning past it</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">position &larr; page dataMaxEnd]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">otherwise, fixEnd</span><span class="small">" position &gt; page dataEnd]⇒ [page dataEnd: (limit &larr; position)]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">write current page</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">p &larr; page write.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">p pageNumber = pn⇒ ["</span><span class="italic small">already have next page, e.g. at end of AltoFile</span><span class="small">"]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">read it or create it</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">p &larr; page get: pn]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">p &larr; page read: pn].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">p⇒ [(page &larr; p) asStream: self]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑false]</span></div>
<div class="line left">
<span class="bold small">settopage: p char: c </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">mainly for compatibility, since page sizes may vary.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">in general, use </span><span class="bold small">position&larr;, wordposition&larr;</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self read: p asSmall⇒ [self skip: c asSmall]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self error: &rsquo;no page&rsquo;]</span></div>
<div class="line left">
<span class="bold small">shorten </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">normally called by </span><span class="bold small">close</span><span class="italic small"> and not directly by user</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self on: [page dataEnd: (limit &larr; position); endFile].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">position &larr; limit]</span></div>
<div class="line left">
<span class="bold large"><br>Filin/Filout</span></div>
<div class="line left">
<span class="bold small">asParagraphPrinter </span><span class="small">["</span><span class="italic small">default format for filout etc.</span><span class="small">" ⇑BravoPrinter init of: self]</span></div>
<div class="line left">
<span class="bold small">backup </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">assume ivy open</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self directory≡dp0⇒ [ivy replace: self name]]</span></div>
<div class="line left">
<span class="bold small">filin </span><span class="small">| p [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user cr.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self readonly.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self end⇒ [self file error: &rsquo;empty file&rsquo;]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ (p &larr; self nextParagraph) do⦂ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">FilinSource &larr; self.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user print: nilⓢ p text; space].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self close.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">FilinSource &larr; nil]</span></div>
<div class="line left">
<span class="bold small">filout </span><span class="small">[self filout: Changes contents sort]</span></div>
<div class="line left">
<span class="bold small">filout: source </span><span class="small">[(self asParagraphPrinter) stamp; printchanges: source; close]</span></div>
<div class="line left">
<span class="bold small">filoutclass: class </span><span class="small">[(self asParagraphPrinter) stamp; printclass: class; close]</span></div>
<div class="line left">
<span class="bold small">nextParagraph </span><span class="small">| text [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">Bravo format paragraph (or self contents if no trailer)</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self end⇒ [⇑false]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">text &larr; self upto: 032 "</span><span class="italic small">ctrl-z</span><span class="small">".<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑text asParagraph applyBravo: self at: 1 to: text length]</span></div>
<div class="line left">
<span class="bold large"><br>Print</span></div>
<div class="line left">
<span class="bold small">asPressPrinter </span><span class="small">["</span><span class="italic small">default format for printt etc.</span><span class="small">" ⇑PressPrinter init of: self]</span></div>
<div class="line left">
<span class="bold small">printout: source </span><span class="small">[(self asPressPrinter) stamp; printchanges: source; close; toPrinter]</span></div>
<div class="line left">
<span class="bold small">printoutclass: class </span><span class="small">[(self asPressPrinter) stamp; printclass: class; close; toPrinter]</span></div>
<div class="line left">
<span class="bold small">toPrinter </span><span class="small">| pp p [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">print an unformatted or Bravo file as a press file</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user displayoffwhile⦂ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pp &larr; (self directory file: self name + &rsquo;Press&rsquo;) asPressPrinter.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self readonly.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ (p &larr; self nextParagraph) do⦂ [pp print: p].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self close].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pp close; toPrinter]</span></div>
<div class="line left">
<span class="bold large"><br>CodePane Editor</span></div>
<div class="line left">
<span class="bold small">edit </span><span class="small">[user restartup: (CodeWindow new file: self)]</span></div>
<div class="line left">
<span class="bold large"><br>Fast Access</span></div>
<div class="line left">
<span class="bold small">readPages: n </span><span class="small">| charsLeft len s [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">read n pages of characters</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">len &larr; n * page dataLength.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s &larr; String new: len.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"charsRead &larr; self into: s endError: false."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">charsLeft &larr; self readString: s from: 1 to: len.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">charsLeft = 0⇒ ["</span><span class="italic small">read len chars</span><span class="small">" ⇑s]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">return characters read only before end of file</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑s copy: 1 to: len - charsLeft]</span></div>
<div class="line left">
<span class="bold small">readString: s from: start to: stop </span><span class="small">| len charsLeft [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">for reading a subrange of a large String from a file (quickly, if BitBlt is used);<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">called by </span><span class="bold small">FileStream into:endError:</span><span class="small">"<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self readonly; reopen.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">start &larr; start - 1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">charsLeft &larr; stop - start.<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">keep going until all of the requested characters are copied or<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">until end of file. if end of current page only, next page is read.</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ (charsLeft &gt; 0 and⦂ self end ≡ false) do⦂ [<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">len = # characters of current page that will fit in String</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">len &larr; limit - position min: charsLeft.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">charsLeft &larr; charsLeft - len.<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">copy subrange of page into String</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s copy: start+1 to: start+len<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">with: array from: position+1 to: position+len.<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">update source and destination pointers</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">position &larr; position+ len.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">start &larr; start + len.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">].<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">return the number of characters not read</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑charsLeft]</span></div>
<div class="line left">
<span class="bold small">streamPosition </span><span class="small">[⇑position]</span></div>
<div class="line left">
<span class="bold small">streamPosition&larr;position </span><span class="small">[⇑position]</span></div>
<div class="line left">
<span class="bold small">writeFile: fs for: charsLeft </span><span class="small">| start len maxLimit [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">for copying part or all of one file to another (quickly, if BitBlt is used);<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">charsLeft ≡ nil means copy until end, otherwise a number of characters.</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">called by </span><span class="bold small">FileStream append:, next:from:</span><span class="small">"<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self writing⇒ [] self error: &rsquo;read only!&rsquo;].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self reopen.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">fs readonly; reopen.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">maxLimit &larr; page dataMaxEnd.<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">keep going until all of the requested characters are copied or<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">until end of file. if end of current page only, next page is read.</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ ((charsLeft≡nil or⦂ charsLeft &gt; 0) and⦂ fs end ≡ false) do⦂ [<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">end of current destination page?</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[position = maxLimit⇒ [self nextPage]].<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">len = # characters of source page that will fit in destination page</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">start &larr; fs streamPosition.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">len &larr; maxLimit - position min: fs limit - start.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[charsLeft≡nil⇒ []<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">len &larr; len min: charsLeft.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">charsLeft &larr; charsLeft - len].<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">copy subrange of source page into destination page</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">array copy: position+1 to: position+len<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">with: fs asArray from: start+1 to: start+len.<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">update source and destination pointers</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">fs streamPosition &larr; start + len.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">position &larr; position + len.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">position &gt; limit⇒ [limit &larr; position]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">].<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">return the number of characters not read</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑[charsLeft ≡ nil⇒ [0] charsLeft]]</span></div>
<div class="line left">
<span class="bold small">writeString: s from: start to: stop </span><span class="small">| len charsLeft maxLimit [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">for writing a subrange of a large String onto a file (quickly, if BitBlt is used);<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">called by </span><span class="bold small">FileStream</span><span class="italic small"> </span><span class="bold small">append:</span><span class="small">"<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self writing⇒ [] self error: &rsquo;read only!&rsquo;].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self reopen.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">start &larr; start - 1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">charsLeft &larr; stop - start.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">maxLimit &larr; page dataMaxEnd.<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">keep going until all of the requested characters are copied</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ charsLeft &gt; 0 do⦂ [<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">end of current page?</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[position = maxLimit⇒ [self nextPage]].<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">len = # characters of String that will fit in current page</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">len &larr; maxLimit - position min: charsLeft.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">charsLeft &larr; charsLeft - len.<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">copy subrange of String into page</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">array copy: position+1 to: position+len<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">with: s from: start+1 to: start+len.<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">update source and destination pointers</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">start &larr; start + len.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">position &larr; position + len.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">position &gt; limit⇒ [limit &larr; position]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑s]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪FileStream under: &rsquo;Files&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"FtpDirectory"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;FtpDirectory&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: FileDirectory<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;command&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;&rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>an interim(?) substitute for our own ftp server</span></div>
<div class="line left">
<span class="bold large"><br>FileDirectory</span></div>
<div class="line left">
<span class="bold small">close </span><span class="small">[self closeThen: &rsquo;Resume. Small.Boot&rsquo;]</span></div>
<div class="line left">
<span class="bold small">closeThen: s </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">command append: &rsquo;; &rsquo;; append: s.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user quitThen: command contents.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self open]</span></div>
<div class="line left">
<span class="bold small">commands </span><span class="small">[⇑command contents]</span></div>
<div class="line left">
<span class="bold small">connect: name password: pw </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">command append: &rsquo; Connect/C &rsquo;; append: name; space; append: pw]</span></div>
<div class="line left">
<span class="bold small">delete: name </span><span class="small">[command append: &rsquo; Delete/C &rsquo;; append: (self checkName: name)]</span></div>
<div class="line left">
<span class="bold small">directoryName: name </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"this message should be directory:, but until rewriting..."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">command append: &rsquo; Directory/C &rsquo;; append: name]</span></div>
<div class="line left">
<span class="bold small">login: name password: pw </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">name empty⇒ []<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">command append: &rsquo; Login/C &rsquo;; append: name; space; append: pw]</span></div>
<div class="line left">
<span class="bold small">open </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">command &larr; Stream new of: (String new: 100).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">command append: &rsquo;Ftp &rsquo;; append: directory.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self login: self userName password: self userPassword]</span></div>
<div class="line left">
<span class="bold small">rename: oldName newName: newName </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">command append: &rsquo; Rename/C &rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">append: (self checkName: oldName); space; append: (self checkName: newName)]</span></div>
<div class="line left">
<span class="bold small">replace: name </span><span class="small">| s [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s &larr; self checkName: name.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(directory compare: &rsquo;maxc&rsquo;) = 2⇒ [self delete: s; store: s]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">store as highest version (ifs only)</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">command append: &rsquo; Store/S &rsquo;; append: s; space; append: s; append: &rsquo;!H&rsquo;]</span></div>
<div class="line left">
<span class="bold small">retrieve: s </span><span class="small">| t [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s is: Vector⇒ [for⦂ t from: s do⦂ [self retrieve: t]]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">command append: &rsquo; Retrieve/C &rsquo;; append: (self checkName: s)]</span></div>
<div class="line left">
<span class="bold small">retrieve: remote as: local </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">command append: &rsquo; Retrieve/S &rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">append: (self checkName: remote); space; append: (self checkName: local)]</span></div>
<div class="line left">
<span class="bold small">store: s </span><span class="small">| t [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s is: Vector⇒ [for⦂ t from: s do⦂ [self store: t]]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">command append: &rsquo; Store/C &rsquo;; append: (self checkName: s)]</span></div>
<div class="line left">
<span class="bold small">store: local as: remote </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">command append: &rsquo; Store/S &rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">append: (self checkName: local); space; append: (self checkName: remote)]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪FtpDirectory under: &rsquo;Files&rsquo;.</span></div>
    <div class="line left">
<span class="small">&rsquo;From Smalltalk 5.5k XM November 24 on 22 November 1980 at 2:57:08 am.&rsquo;<br></span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large">"AltoFile"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;AltoFile&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: File<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;leader pageAddresses&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;&rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">sharing: AltoFilePool;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>A File found on an Alto Model 31(44) disk</span></div>
<div class="line left">
<span class="bold large"><br>Dictionary</span></div>
<div class="line left">
<span class="bold small">close </span><span class="small">["to look at at reopen" type &larr; self updateLeader: (self read: 0)]</span></div>
<div class="line left">
<span class="bold small">entryClass </span><span class="small">[⇑AltoFilePage]</span></div>
<div class="line left">
<span class="bold small">open </span><span class="small">["</span><span class="italic small">don&rsquo;t find last page immediately.  for later close</span><span class="small">" type &larr; read]</span></div>
<div class="line left">
<span class="bold large"><br>DictionaryEntry</span></div>
<div class="line left">
<span class="bold small">fileSize </span><span class="small">["sn, version, fn, leader, name" ⇑11 + (name length lor: 1)]</span></div>
<div class="line left">
<span class="bold small">init </span><span class="small">[super init.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pageAddresses &larr; AltoFileAddressTable new]</span></div>
<div class="line left">
<span class="bold small">readFrom: s </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"read file description from SysDir"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">serialNumber &larr; s next: 4.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s skip: 4 "self version: s nextword. s skip: 2".<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">leader &larr; directory virtualToReal: s nextword.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">name &larr; s nextString.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s padNext]</span></div>
<div class="line left">
<span class="bold small">storeOn: s </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s append: serialNumber;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nextword &larr; 1; nextword &larr; 0;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nextword &larr; (directory realToVirtual: leader);<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nextString &larr; name; padNext &larr; 0]</span></div>
<div class="line left">
<span class="bold large"><br>File</span></div>
<div class="line left">
<span class="bold small">classInit </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">before filing in:</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">Smalltalk declare: ↪AltoFilePool as: (SymbolTable new init: 32)"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">AltoFilePool<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">declare: ↪(CRR CCR CCW CWW "</span><span class="italic small">disk commands</span><span class="small">")<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">as: ↪(044100 044120 044130 044150);<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">declare: ↪(<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">dfmask "</span><span class="italic small">bit means active directory entry</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">boffset "</span><span class="italic small">byte offset of bit table in DiskDescriptor</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">dirname) as: ↪(02000 040 &rsquo;SysDir.&rsquo; );<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">declare: ↪(nextp backp numch pagen vn) as: ↪(1 2 4 5 6)]</span></div>
<div class="line left">
<span class="bold small">doCommand: com page: page error: e </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">error &larr; nullString.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self dskprim: directory diskNumber address: page address command: com<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">page: page page⇒ [⇑page]<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">error &larr; self errorString: error "</span><span class="italic small">set by </span><span class="bold small">dskprim:...</span><span class="small">".<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑self error: e]</span></div>
<div class="line left">
<span class="bold small">endFile: page </span><span class="small">| nextPage pn [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[page≡false⇒ ["</span><span class="italic small">free all of file</span><span class="small">" pn &larr; ¬1]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[page full⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nextPage &larr; self Write: page.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">if page was a full last page, next is an empty (and now last) page</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nextPage lastPage⇒ [⇑nextPage]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">page &larr; self read: page pageNumber+1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">page empty⇒ [⇑page]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">page length: 0]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">write last page</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">page header: nextp &larr; 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self Write: page.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">free rest of file</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pn &larr; page pageNumber].<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">lastpn &larr; false "</span><span class="italic small">reset by readPage:</span><span class="small">".<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ (lastpn≡false and⦂ (nextPage &larr; self read: (pn &larr; pn+1))) do⦂ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nextPage init; freePage;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">doCommand: CWW error: &rsquo;endFile:&rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">directory deallocate: nextPage].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[page⇒ [pageAddresses position &larr; (lastpn &larr; page pageNumber)]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑page]</span></div>
<div class="line left">
<span class="bold small">findLastPage </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self read: 20000.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑lastpn]</span></div>
<div class="line left">
<span class="bold small">Get: page </span><span class="small">| p pn [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pn &larr; page pageNumber.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self Read: page⇒ [⇑page]<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">page now contains last page</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ p from: lastpn to: pn-1 do⦂ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">page pageNumber: p; length: page dataLength.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">this writes current and allocates next (empty) page</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">page &larr; self Write: page].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑page]</span></div>
<div class="line left">
<span class="bold small">Read: page </span><span class="small">| pn p palen [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pn &larr; page pageNumber.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[pageAddresses⇒ [palen &larr; pageAddresses length]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pn = 0⇒ [palen &larr; 0]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑false].<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ p from: (palen min: pn) to: pn do⦂ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">set up page for checking</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">page<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">zeroed by machine code</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">header: nextp &larr; [p &lt; palen⇒ [pageAddresses◦(p+1)] 0];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">header: backp &larr; [p=0⇒ [0]; =1⇒[leader] pageAddresses◦(p-1)];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">length: [p &lt; palen⇒ [page dataLength] 0];"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pageNumber: p;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">address: [p=0⇒ [leader] pageAddresses◦p];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">doCommand: CCR error: &rsquo;readPage:&rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">page lastPage⇒ [(lastpn &larr; p) &lt; pn⇒ [⇑false]]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">p ≥ palen and⦂ pageAddresses⇒[pageAddresses◦(p+1) &larr; page header: nextp]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">no need to store if already known or no page table</span><span class="small">"].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑page]</span></div>
<div class="line left">
<span class="bold small">sameFile </span><span class="small">| page s [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(page &larr; self newPage: 0) address: leader.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">if any of following  tests fail, File will be reinitialized</span><span class="small">"<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑("</span><span class="italic small">serial number match</span><span class="small">" (page doCommand: CCR error: false) and⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">correct page number</span><span class="small">" page pageNumber = 0) and⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[s &larr; page asStream.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">last write was by us</span><span class="small">" type = (s next: 4) and⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[s skip: 8.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">same name</span><span class="small">" (name compare: s nextString) = 2]]]</span></div>
<div class="line left">
<span class="bold small">Write: page </span><span class="small">| nextPage labelDirty returnPage [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[(labelDirty &larr; page lastPage) and⦂ page full⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">last page can&rsquo;t be full, so glue on another page</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">returnPage &larr; nextPage &larr; self newPage.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">directory allocate: nextPage after: (directory realToVirtual: page address).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nextPage init;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">header: backp &larr; page address;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pageNumber: (lastpn &larr; page pageNumber+1);<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">serialNumber: serialNumber;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">doCommand: CWW error: &rsquo;writePage: (allocate)&rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">link to current page</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">page header: nextp &larr; nextPage address.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pageAddresses⇒ [pageAddresses◦lastpn &larr; nextPage address]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="bold small">growSmalltalkBy:</span><span class="small">"]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">returnPage &larr; page].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">whenever a last (or second last) page is written, write label also</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self doCommand: [labelDirty⇒ [CWW] CCW] page: page error: &rsquo;writePage:&rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">type &larr; read+write.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑returnPage]</span></div>
<div class="line left">
<span class="bold large"><br>Alto</span></div>
<div class="line left">
<span class="bold small">dskprim: diskNumber </span><span class="small">"</span><span class="italic small">0/1</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold small">address: a</span><span class="small"> "</span><span class="italic small">starting Alto disk address</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold small">command: com</span><span class="small"> "</span><span class="italic small">disk command (usually CCR, CCW, CWW)</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold small">page: string</span><span class="small"> "</span><span class="italic small">string containing label and data</span><span class="small">"<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["</span><span class="italic small">if disk routine encounters an error,</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">error &larr; (DCB status, to be interpreted by </span><span class="bold small">errorString:</span><span class="small">).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑false"<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">if other error occurs, e.g. nil instead of Integer...</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">error &larr; ¬1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑false] primitive: 80</span></div>
<div class="line left">
<span class="bold small">errorString: status </span><span class="small">| t s [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">see Alto hardware manual for details on error word format</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">status=¬1⇒ [⇑&rsquo;primitive failure, bad args?&rsquo;]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s &larr; Stream default.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s append: ↪(&rsquo;&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">&rsquo;hardware error or sector overflow&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">&rsquo;check error&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">&rsquo;disk command specified illegal sector&rsquo;)◦(1 + (status land: 3)).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ t to: 6 do⦂ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">status allmask: (0200 lshift: 1-t)⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s space; append: ↪(<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">&rsquo;seek failed, possible illegal track&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">&rsquo;seek in progress&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">&rsquo;disk unit not ready&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">&rsquo;hardware late&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">&rsquo;hardware not transferring&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">&rsquo;checksum&rsquo;)◦t]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s space; append: status base8.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑s contents]</span></div>
<div class="line left">
<span class="bold small">leader </span><span class="small">[⇑leader]</span></div>
<div class="line left">
<span class="bold small">leader: leader</span></div>
<div class="line left">
<span class="bold small">pageAddresses: pageAddresses</span></div>
<div class="line left">
<span class="bold small">updateLeader: page </span><span class="small">| s time lastwrite [ <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">see &lt;Alto&gt;AltoFileSys.D, (p.3 leader page) for further info</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">time &larr; user timewords.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s &larr; page asStream.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[type anymask: write ⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">set creation/write read date and name</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">directory flush.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">lastwrite &larr; time.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s append: time; append: time; append: time.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">name empty⇒ []<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s nextString&larr; name]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">lastwrite &larr; s next: 4.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s skip: 4; append: time].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self Write: page.<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑lastwrite]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪AltoFile under: &rsquo;Alto File System&rsquo;.</span></div>
<div class="line left">
<span class="small">AltoFile classInit</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"AltoFileAddressTable"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;AltoFileAddressTable&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: RunVector<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;&rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>This class converts to virtual disk addrs which tend to come in consecutive<br>runs, and can thus use the compact representation of its superclass.</span></div>
<div class="line left">
<span class="bold large"><br>Reading and writing</span></div>
<div class="line left">
<span class="bold small">◦i </span><span class="small">| base [base&larr; super◦i. ⇑dp0 virtualToReal: base+offset]</span></div>
<div class="line left">
<span class="bold small">◦i&larr; val </span><span class="small">| virt [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">virt&larr; dp0 realToVirtual: val.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">starts ≡ nil⇒[super◦i&larr; virt. ⇑val]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">super◦i&larr; virt-i+(starts last).</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"superclass tries for constant runs"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">offset&gt;0⇒[⇑val]</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"OK if same run"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">values last&larr; virt. ⇑val]</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"else fix new run value base"</span></div>
<div class="line left">
<span class="bold small">position&larr; p </span><span class="small">| l</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"shortens (for file shorten)"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[p&gt;max⇒[user notify: &rsquo;invalid extension&rsquo;] max&larr; p.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(l&larr; starts findSorted: max)&lt;starts length⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[starts&larr; starts copy: 1 to: l.  values&larr; values copy: 1 to: l]]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪AltoFileAddressTable under: &rsquo;Alto File System&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"AltoFileDirectory"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;AltoFileDirectory&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: FileDirectory<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;dirFile bitsFile closed diskPages totalPages nSectors&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;&rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">sharing: AltoFilePool;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br></span></div>
<div class="line left">
<span class="bold large"><br>Dictionary</span></div>
<div class="line left">
<span class="bold small">close </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self obsolete⇒ []<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">dirFile close.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[bitsFile ≡ nil⇒ ["an interrupted open?"] bitsFile close].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">super close]</span></div>
<div class="line left">
<span class="bold small">Delete: file </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(self deleteEntry: file) open; endFile: false.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitsFile flush]</span></div>
<div class="line left">
<span class="bold small">entryClass </span><span class="small">[⇑AltoFile]</span></div>
<div class="line left">
<span class="bold small">entrySize: file </span><span class="small">["entry size in words" ⇑1 + (file fileSize / 2)]</span></div>
<div class="line left">
<span class="bold small">Insert: file </span><span class="small">| sn page [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">file serialNumber: (sn &larr; self allocateSN: file).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">allocate a new page (more success after O.S. stuff, bittable etc.)</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self allocate: (page &larr; file newPage) after: 800.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">write 0th -- leader, in the process filling it in and then creating first page</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">page init; serialNumber: sn; length: page dataLength.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">file leader: page address; type: write; updateLeader: page.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self addEntry: file]</span></div>
<div class="line left">
<span class="bold small">nextEntry: file </span><span class="small">| s elen [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">dirFile≡nil⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(file name compare: dirname) = 2⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">return system directory file. known serialNumber and leader</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">file serialNumber: 0100000, 0144; leader: 010000.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑file]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self error: &rsquo;directory not open&rsquo;]<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">return the next file entry, ignore deleted entries,<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">and leave dirFile positioned before next entry</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ (s &larr; dirFile nextword) do⦂ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">elen &larr; s land: dfmask-1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s allmask: dfmask⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">file readFrom: dirFile.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">dirFile skip: elen*2 - (file fileSize + 2).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑file]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">deleted entry, again</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">dirFile skipwords: elen-1].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑false]</span></div>
<div class="line left">
<span class="bold small">obsolete </span><span class="small">[⇑dirFile≡nil]</span></div>
<div class="line left">
<span class="bold small">open </span><span class="small">| f s a page len elen type [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nil ≠ dirFile⇒ []<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">assume some defaults in case DSHAPE is not in SysDir leader page.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">these should only be needed if the disk is old (and not scavenged).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">they will not work if a 14 sector system is missing DSHAPE (unlikely) since addresses of first page of directory and of DiskDescriptor might be computed incorrectly.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">in a Smalltalk-76 system, nSectors, diskPages had better eventually match:<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">| a. a &larr; Vmem specialLocs◦13. mem◦(a+5), (mem◦(a+6))<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nSectors &larr; 12.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">diskPages &larr; 812*nSectors.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">totalPages &larr; 2*diskPages.<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">read SysDir leader page to find out file system configuration.  see AltoFileSys.D</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">f &larr; self find: dirname.<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">to prevent address of page 1 from being stored</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">f pageAddresses: false.<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">length of property list, in words</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">page &larr; f read: 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">len &larr; page◦494.<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[len ≠ 210⇒ []<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">scan file properties for DSHAPE</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s &larr; page asStream.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s skipwords: page◦493.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ len &gt; 0 do⦂ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">type &larr; s next.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">type = 0⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">0 terminates list.  property not found. try to read if from DiskDescriptor"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">len &larr; 0]<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">elen &larr; s next.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">type = 1 and⦂ elen = 5⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">DSHAPE. read property</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self configure: s.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">set flags so configure and loop are not done again</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s &larr; false. len &larr; 0]<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">skip over other property</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">len &larr; len - elen.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s skipwords: elen-1]].<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">now, with the correct (or default) file system configuration,<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">store the virtual address of next page (1), and create a FileStream on SysDir</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">a &larr; AltoFileAddressTable new.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">a◦1 &larr; page header: nextp.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">f pageAddresses: a.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(dirFile &larr; f asStream) readonly.<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(bitsFile &larr; self oldFile: &rsquo;DiskDescriptor&rsquo;) readwrite.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[s⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">configuration not read from SysDir. this will work for 12 sector systems.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">14 sector systems should have had the DSHAPE property</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self configure: bitsFile]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">super open.<br>]</span></div>
<div class="line left">
<span class="bold small">Position &larr; entry </span><span class="small">| name elen s holepos holesize entrysize nlen sk [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">entry format<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">1</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">n (length in words, including this one) + undeleted bit (dfmask)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">2-3</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">serialNumber<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">4</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">version<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">5</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">0?<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">6</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">virtual address of page 0<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">7-n name as Bcpl string (extra 0 if length even)</span><span class="small">"<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">name &larr; entry name.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">dirFile≡nil and⦂ (name compare: dirname) = 2⇒ [⇑true]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self reset.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">holepos &larr; false.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">holesize &larr; dfmask.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nlen &larr; name length.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">entrysize &larr; self entrySize: entry "</span><span class="italic small">desired entry size</span><span class="small">".<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ (s &larr; dirFile nextword) do⦂ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">entry length in words</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">elen &larr; s land: dfmask-1.<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[entrysize &gt; elen⇒ ["</span><span class="italic small">entry too small</span><span class="small">" sk &larr; ¬2]<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s = elen⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">deleted entry. check hole size for later inserting or renaming</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">sk &larr; ¬2.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">elen &lt; holesize⇒[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">hole is the smallest so far</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">holesize &larr; elen. holepos &larr; dirFile position]]<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">normal entry, big enough</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">dirFile skip: 10.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nlen ≠ dirFile next⇒ ["</span><span class="italic small">name wrong size</span><span class="small">" sk &larr; ¬13]<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">sk &larr; ¬13 - nlen.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(name compare: (dirFile next: nlen)) = 2⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">name match, position back to beginning of entry</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">dirFile skip: sk.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑entry]].<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">sk is the character offset from the entry header word to the next entry</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">dirFile skip: elen*2 + sk].<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[holepos⇒ [dirFile position &larr; holepos-2] "</span><span class="italic small">at end of dirFile</span><span class="small">"].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑false]</span></div>
<div class="line left">
<span class="bold small">release </span><span class="small">[dirFile &larr; bitsFile &larr; nil]</span></div>
<div class="line left">
<span class="bold small">reset </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self obsolete⇒ [self open] self flush].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">dirFile readonly; reset]</span></div>
<div class="line left">
<span class="bold large"><br>FileDirectory</span></div>
<div class="line left">
<span class="bold small">allocateSN: file </span><span class="small">| sn [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitsFile position &larr; 010.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">sn &larr; bitsFile next: 4.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[(sn word: 2 &larr; (sn word: 2) + 1) = 0⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">overflow</span><span class="small">" sn word: 1 &larr; (sn word: 1) + 1]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitsFile skip: ¬4; append: sn.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑sn]</span></div>
<div class="line left">
<span class="bold small">checkName: s </span><span class="small">[⇑self checkName: s fixing: false]</span></div>
<div class="line left">
<span class="bold small">realToVirtual: adr </span><span class="small">["see </span><span class="bold small">virtualToReal:</span><span class="small">.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">Alto address format is<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">bits<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">0-3</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">sector number (0 - 015, i.e. 12 or 14 sectors)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">4-12</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">cylinder number (0 - 0312, Model 31; 0-0625, Model 44)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">13</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">head number (0-1)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">14</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">disk number</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">(0-1)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">15</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">restore bit.<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">in a system with two separable disks, addresses on disk 1 have a 0 disk bit, which is complemented by the disk primitive</span><span class="small">"<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑"vadr &larr;" ("</span><span class="italic small">sector: field</span><span class="small">" adr lshift: ¬12) +<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">("</span><span class="italic small">cylinder and head: field*</span><span class="small">" nSectors * ((adr land: 07774) lshift: ¬2)) +<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">("</span><span class="italic small">disk: field*pages per disk</span><span class="small">" [(adr land: 2) = 2⇒ [diskPages] 0]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"diskPages*(adr land: 2)/2")<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"vadr &lt; 0 or⦂ vadr ≥ totalPages⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self error: &rsquo;illegal disk address&rsquo;]"]</span></div>
<div class="line left">
<span class="bold small">rename: file newName: newName </span><span class="small">| holesize pos [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[newName &larr; self checkName: newName⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self position &larr; newName⇒ [self error: &rsquo;new name already exists: &rsquo; + newName]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">a possible insertion place</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pos &larr; dirFile position]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self error: &rsquo;illegal new name: &rsquo; + newName].<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self Find: (file &larr; self makeEntry: file)⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">holesize &larr; dirFile nextword land: dfmask-1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">dirFile skip: ¬2.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">file name: newName.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[(self entrySize: file "</span><span class="italic small">new size of entry</span><span class="small">") ≤ holesize⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">new entry will fit in current entry</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pos &larr; dirFile position.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">read and save entry</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self nextEntry: file]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">delete and save entry</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self deleteEntry: file].<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">position to same entry or hole discovered earlier</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">dirFile position &larr; pos.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self addEntry: (file name: newName).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">file type is: Integer⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"file is open. defer leader page change until someone closes it"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">file type: write]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"close file: updating name in leader page" file type: write; close]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">file error: &rsquo;rename: old name does not exist&rsquo;]</span></div>
<div class="line left">
<span class="bold small">virtualToReal: vadr </span><span class="small">| t2 d ["</span><span class="italic small">inverse of </span><span class="bold small">realToVirtual:</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"vadr &lt; 0 or⦂ vadr ≥ totalPages⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self error: &rsquo;illegal virtual address&rsquo;]"<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"faster to do /\ for normal Integers"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"t &larr; vadr intdiv: diskPages.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">sec &larr; t◦2 intdiv: nSectors"<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[vadr &lt; diskPages⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">d &larr; 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">t2 &larr; vadr]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">d &larr; 2.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">t2 &larr; vadr \ diskPages].<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑("</span><span class="italic small">sector</span><span class="small">" (t2 \ nSectors) lshift: 12) +<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">("</span><span class="italic small">cylinder & head</span><span class="small">" (t2 / nSectors) lshift: 2) +<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">("</span><span class="italic small">disk</span><span class="small">" d "(vadr / diskPages) lshift: 1")]</span></div>
<div class="line left">
<span class="bold large"><br>Alto</span></div>
<div class="line left">
<span class="bold small">addEntry: file </span><span class="small">| entrysize holesize [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">called only by </span><span class="bold small">Insert:</span><span class="italic small"> and </span><span class="bold small">rename:newName:</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[holesize &larr; dirFile nextword⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">either a deleted entry or rename entry</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">holesize &larr; holesize land: dfmask-1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">dirFile skip: ¬2]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">at end</span><span class="small">"].<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">entrysize &larr; self entrySize: file.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">dirFile readwrite;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nextword &larr; entrysize + dfmask.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">file storeOn: dirFile.<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[holesize and⦂ entrysize &lt; holesize⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">mark remaining hole</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">dirFile nextword &larr; holesize-entrysize]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">dirFile readonly.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitsFile flush]</span></div>
<div class="line left">
<span class="bold small">allocate: nextPage after: address </span><span class="small">| index stop ch m vadr [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">index &larr; false.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ true do⦂ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">go around bittable from address to end, and beginning to address.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">we start over again if the table appears full or bitsFile is out of sync</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[index and⦂ stop ≥ totalPages⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"wrap around to where we started"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">stop &larr; address.</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">index &larr; 0]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[index ≡ false⇒ ["</span><span class="italic small">first time or bitsFile out of sync</span><span class="small">"]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">disk probabbly full</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user quitThen:<br>&rsquo;//   YOUR DISK IS FULL - Please make some space available.<br>//   Then resume Smalltalk and interrupt or continue as desired...&rsquo;].<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self open.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">index by bits rather than bytes? close enough for now</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">index &larr; address land: 0177770.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">stop &larr; totalPages].<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitsFile position &larr; index/8 + boffset.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ (index and⦂ (index &larr; index+8) ≤ stop) do⦂ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(ch &larr; bitsFile next) = 0377⇒ ["</span><span class="italic small">8 full</span><span class="small">"]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">check that bitsFile position is correct --<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">possibly out of sync with index if  growSmalltalkBy: occurred?</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitsFile position ≠ (index/8 + boffset)⇒ [index &larr; false]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">m &larr; 0200.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ vadr from: index-8 to: index-1 do⦂ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[(ch land: "nomask:" m) = 0⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">page appears free. first update DiskDescriptor</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitsFile skip: ¬1; next &larr; ch &larr; ch lor: m.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"then check if page is really free"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">vadr=0⇒ ["</span><span class="italic small">O.S. boot</span><span class="small">"]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">([nextPage init; freePage;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">address: (self virtualToReal: vadr);<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">doCommand: CCR error: false])⇒ [⇑vadr]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">page not really free</span><span class="small">"]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">page not free according to bit</span><span class="small">"].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">m &larr; m lshift: ¬1].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]]</span></div>
<div class="line left">
<span class="bold small">checkName: fname fixing: fixing </span><span class="small">| x copy special [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">fname empty⇒[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">fixing⇒ [⇑&rsquo;$&rsquo;]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"empty name" ⇑false]<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[fname length &gt; 38⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[fixing⇒ [fname &larr; fname◦(1 to: 38)]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"name too long" ⇑false]].<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">copy &larr; (String new: fname length+1) asStream.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">special &larr; &rsquo;.-+$!?&rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ x from: fname do⦂ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"check characters: alphanumeric or 6 special"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">x isletter or⦂ ((special has: x) or⦂ x isdigit) ⇒ [copy next &larr; x]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">fixing⇒ [copy next &larr; special◦2]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"illegal character" ⇑false].<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[fixing⇒ [fname last = (special◦1)⇒ [copy skip: ¬1]]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">fname last ≠ (special◦1)⇒ [copy next &larr;  special◦1]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑copy contents]</span></div>
<div class="line left">
<span class="bold small">configure: s </span><span class="small">| nDisks nHeads nTracks [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"read disk configuration from a Stream:<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">either leader page of SysDir or beginning of DiskDescriptor"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nDisks &larr; s nextword.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nTracks &larr; s nextword.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nHeads &larr; s nextword.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nSectors &larr; s nextword.<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">diskPages &larr; nTracks * nHeads * nSectors.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">totalPages &larr; nDisks * diskPages]</span></div>
<div class="line left">
<span class="bold small">deallocate: page </span><span class="small">| index ch m [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[dirFile≡nil⇒ [self open]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">index &larr; self realToVirtual: page address.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">character position</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitsFile position &larr; index/8 + boffset.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">ch &larr; bitsFile next.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">bit position</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">m &larr; 0200 lshift: 0-(index land: 7).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"make page free by turning off bit in DiskDescriptor"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(ch land: m) = m⇒ [bitsFile skip: ¬1; next&larr; ch - m]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user cr; show: &rsquo;page already free (dealloc:)&rsquo;]</span></div>
<div class="line left">
<span class="bold small">deleteEntry: file </span><span class="small">| p [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">called only by </span><span class="bold small">Delete:</span><span class="italic small"> and </span><span class="bold small">rename:newName:</span><span class="italic small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">read and save</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">p &larr; dirFile position.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self nextEntry: file.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">dirFile position &larr; p.<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">delete it from directory (turn off bit in entry length word)</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">p &larr; dirFile nextword land: dfmask-1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">dirFile skip: ¬2; readwrite; nextword &larr; p; readonly; skip: ¬2.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑file]</span></div>
<div class="line left">
<span class="bold small">diskID </span><span class="small">| f u [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">return user name and disk name installed in O.S.</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(f &larr; self oldFile: &rsquo;sys.boot&rsquo;) readonly; position &larr; 512.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">u &larr; f nextString.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">f padNext.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">u &larr; u, f nextString.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">f close.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑u]</span></div>
<div class="line left">
<span class="bold small">diskNumber </span><span class="small">["directory is: Integer⇒ [" ⇑directory "] ⇑directory diskNumber"]</span></div>
<div class="line left">
<span class="bold small">filesMatching: pattern </span><span class="small">| files v i [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">files &larr; self match: [pattern last = (&rsquo;.&rsquo;◦1)⇒ [pattern] pattern + &rsquo;.&rsquo;].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">v &larr; Vector new: files length.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: v length do⦂ [v◦i &larr; (files◦i) name].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑v]</span></div>
<div class="line left">
<span class="bold small">flush </span><span class="small">[bitsFile≡nil⇒ [] bitsFile flush]</span></div>
<div class="line left">
<span class="bold small">freePages </span><span class="small">| npages ch i [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self open.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitsFile position &larr; boffset.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">npages &larr; 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i from: 1 to: totalPages by: 8 do⦂ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(ch &larr; bitsFile next) =0377⇒ ["</span><span class="italic small">all used</span><span class="small">"]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">possibly up to 8 unused</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">npages &larr; npages+8.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">until⦂ ch = 0 do⦂ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">npages &larr; npages - (ch land: 1).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">ch &larr; ch lshift: ¬1]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑npages]</span></div>
<div class="line left">
<span class="bold small">growSmalltalkBy: n </span><span class="small">| zfpt i file page a zlen ["dp0 growSmalltalkBy: 100."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">find and read last page of small.boot, then extend file</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">i &larr; 1. zlen&larr; 96.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">zfpt &larr; CoreLocs new base: (Vmem specialLocs◦7) length: zlen*2.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">until⦂ zfpt◦(i+zlen) = 0 do⦂ [i &larr; i+1].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">a &larr; (zfpt◦(i+zlen-1)) + (zfpt◦i) - (zfpt◦(i-1)) - 1.<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self open.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">file &larr; self makeEntry: &rsquo;small.boot.&rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">page &larr; file newPage.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">page address: (self virtualToReal: a);<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">doCommand: CRR error: &rsquo;cannot read last page. growSmalltalkBy:&rsquo;.<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">bypass reading file and creating random access table, just extend it</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">page lastPage⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">file serialNumber: page serialNumber;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">lastPage: page pageNumber;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pageAddresses: false "</span><span class="bold small">Read:, Write:</span><span class="italic small"> check this</span><span class="small">";<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">Get: (page pageNumber: page pageNumber+n).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user space; print: self freePages; show: &rsquo; pages left.&rsquo;]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self error: &rsquo;growSmalltalkBy:. last page not last or 2 successive user grows&rsquo;]</span></div>
<div class="line left">
<span class="bold small">stampBoot </span><span class="small">| a file page ["dp0 stampBoot."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"update the time stamps in leader page of current boot file"<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"find SafeId for current boot file"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">a &larr; Vmem specialLocs◦13.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">file &larr; self makeEntry: &rsquo;&rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">file serialNumber: mem◦a, (mem◦(a+1)).<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"read page one of the boot file to find out the leader address"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">page &larr; file makeEntry: 1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">page address: mem◦(a+4).<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"then set leader address and dirty flag, and close file<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">thereby updating create/write/read dates, but not name"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">file doCommand: CCR page: page error: &rsquo;cannot read page 1 of boot file&rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">leader: (page header: backp);<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">type: write;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">close]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪AltoFileDirectory under: &rsquo;Alto File System&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"AltoFilePage"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;AltoFilePage&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: FilePage<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;address&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;&rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">sharing: AltoFilePool;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>A FilePage from an AltoFile consists of a header (2 words), a label (8 words) and data (512 characters)</span></div>
<div class="line left">
<span class="bold large"><br>FilePage</span></div>
<div class="line left">
<span class="bold small">address </span><span class="small">[⇑address]</span></div>
<div class="line left">
<span class="bold small">address: address</span></div>
<div class="line left">
<span class="bold small">headerLength </span><span class="small">[⇑16]</span></div>
<div class="line left">
<span class="bold small">init </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">page ≡ nil⇒ [super init]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">nextp, backp, lnused, numch, pn</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">page fill: 1 to: 10 with: 0]</span></div>
<div class="line left">
<span class="bold small">lastPage </span><span class="small">[⇑("self header:" page word: nextp) = 0]</span></div>
<div class="line left">
<span class="bold small">length </span><span class="small">[⇑"self header:" page word: numch]</span></div>
<div class="line left">
<span class="bold small">length: len </span><span class="small">["self header:" page word: numch &larr; len]</span></div>
<div class="line left">
<span class="bold small">pageNumber </span><span class="small">[⇑"self header:" page word: pagen]</span></div>
<div class="line left">
<span class="bold small">pageNumber: pn </span><span class="small">["self header:" page word: pagen &larr; pn]</span></div>
<div class="line left">
<span class="bold small">serialNumber </span><span class="small">[⇑page◦(13 to: 16)]</span></div>
<div class="line left">
<span class="bold small">serialNumber: sn </span><span class="small">["page◦(13 to: 16) &larr; sn"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">page copy: 13 to: 16 with: sn from: 1 to: 4.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"self header:" page word: vn &larr; 1 "fixed version"]</span></div>
<div class="line left">
<span class="bold large"><br>Alto</span></div>
<div class="line left">
<span class="bold small">freePage </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">label for a free page: version, sn1, sn2 = ¬1</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">page fill: 11 to: 16 with: 0377]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪AltoFilePage under: &rsquo;Alto File System&rsquo;.</span></div>
    <div class="line left">
<span class="small">&rsquo;From Smalltalk 5.5k XM November 24 on 22 November 1980 at 2:57:08 am.&rsquo;<br></span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large">"ILFile"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;ILFile&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: File<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;&rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">sharing: ILFilePool;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>An IFS file accessed through the Leaf protocol, 12/79</span></div>
<div class="line left">
<span class="bold large"><br>Dictionary</span></div>
<div class="line left">
<span class="bold small">entryClass </span><span class="small">[⇑ILFilePage]</span></div>
<div class="line left">
<span class="bold large"><br>File</span></div>
<div class="line left">
<span class="bold small">classInit </span><span class="small">| i sym names ["ILFile classInit."<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">ILFilePool declare: ↪NotFound as: &rsquo;207&rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">names &larr; ↪(<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">1011 (BadLeafHandle)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">02000 (AnswerBit)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">0176000 (RequestBits)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">0260 (LeafType)<br>"5-bit operations for left field command block word"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">0 (Error Open Close Delete)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">6 (Read Write Reset)<br><br>"read/write modes"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">0140 (SetEof "no holes, set eof")<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">0200 (NoExtend "don&rsquo;t extend file on read or write")<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">0100 (NoHoles "for writing past end")<br><br>"open file modes"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">0163400 (WriteOld "read, write, extend, any explicit, highest")<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">0103400 (ReadOld "read, any explicit, highest")<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">0167600 (CreateNew "read, write, extend, create, any explicit, next")<br><br>"control codes for left half of pupID1 field"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">0 (Data Ack Noop)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">5 (OpenConnection "if Reset")<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">9 (DestroyConnection Dally Quit BrokenConnection)) asStream.<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i from: names do⦂ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ sym from: names next do⦂ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">ILFilePool declare: sym as: i.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">i &larr; i+1]]]<br></span></div>
<div class="line left">
<span class="bold small">close </span><span class="small">["ignore errors if file was readonly" self close: [type = read⇒ [false] &rsquo;close&rsquo;]]</span></div>
<div class="line left">
<span class="bold small">close: e </span><span class="small">| p ["close file, possibly ignoring errors"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"for next open"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">type &larr; read.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"shorten header block to first 2 words: command&length,  file handle"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">p &larr; self newPage.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">p length: ¬6.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self doCommand: Close page: p error: e]</span></div>
<div class="line left">
<span class="bold small">doCommand: com page: page error: e </span><span class="small">| in ecode [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">page command: com.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ true do⦂ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"make sure connection is open"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">directory open.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">error &larr; nullString.<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[in &larr; directory socket sendPacket: page packet⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">in◦11 = BrokenConnection⇒ [ecode &larr; ¬1]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"turn packet into a ILFilePage"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">in &larr; [(self entryClass new) dictionary: self; page: in].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"check if answer is of same type as request"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">((page header: 1) land: RequestBits) + AnswerBit =<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">((in header: 1) land: RequestBits)⇒ [⇑in]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">ecode &larr; in header: 2]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"no response?"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">ecode &larr; false].<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"some kind of problem"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">com = Quit⇒ ["ignore" ⇑false]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ecode ≡ false or⦂ ecode = ¬1⇒ ["make new connection" directory release]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">ecode = ¬1 or⦂ ecode = 1011⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"try again after some reinitializing"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"reopen file"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self reopen.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"init page with new handle only -- don&rsquo;t lose mode, length, etc."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">page serialNumber: serialNumber]<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">error &larr; [ecode⇒ [e⇒ [self errorString: ecode] ecode asString]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">directory directory + &rsquo; not responding&rsquo;].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">e⇒ [self error: e "proceeding tries again"]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑false]]</span></div>
<div class="line left">
<span class="bold small">endFile: page </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"make sure we can write"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self writeMode: page.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"update length. this will end file with this page"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">lastpn &larr; page pageNumber.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑self Write: page]</span></div>
<div class="line left">
<span class="bold small">errorString: errorCode </span><span class="small">| ef ename errorString notfound dollar cr [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[errorCode is: String⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">errorString &larr; errorCode.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">errorCode &larr; [(errorString◦1) isdigit⇒ [errorString asInteger] 0]]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">errorString &larr; errorCode asString].<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">ename &larr; &rsquo;&lt;System&gt;Ifs.Errors&rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(self name compare: ename) = 2⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"recursion" ⇑errorString + &rsquo; (cannot access Ifs.Errors !!!)&rsquo;]<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">notfound &larr; errorString + &rsquo;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(error code not found)&rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">errorCode ≤ 0⇒ [⇑notfound]<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">dollar &larr; &rsquo;$&rsquo;◦1. cr &larr; 015.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">ef &larr; directory oldFile: ename.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">ef readonly.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">errorString &larr; false.<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"scan through the errors file looking for lines of the form:<br>$$nn</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">some message<br>"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">until⦂ errorString do⦂ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">ef skipTo: dollar⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">ef next = dollar⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"valid line"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">ef integerScan<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">&gt; errorCode⇒ ["since errors are ordered" errorString &larr; notfound];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">= errorCode⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">errorString &larr; (String new: 200) asStream.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">errorString print: errorCode.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">until⦂ (ef peek = dollar or⦂ ef peek = cr) do⦂ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">errorString append: (ef upto: cr); space].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">errorString &larr; errorString contents]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"end of file"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">errorString &larr; notfound].<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">ef close.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑errorString]</span></div>
<div class="line left">
<span class="bold small">findLastPage </span><span class="small">["already known from open" ⇑lastpn]</span></div>
<div class="line left">
<span class="bold small">open </span><span class="small">"do nothing. lastpn set by </span><span class="bold small">ILFileDirectory Find:</span><span class="small">"</span></div>
<div class="line left">
<span class="bold small">Read: page </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">page pageNumber &gt; lastpn⇒ ["no page" ⇑false]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"don&rsquo;t extend beyond eof. length of page is 0, but request is for 512 bytes"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">page mode: NoExtend; header: 5 &larr; 512 "self dataLength".<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑self doCommand: Read page: page error: &rsquo;Read:&rsquo;]</span></div>
<div class="line left">
<span class="bold small">release </span><span class="small">[self close: false]</span></div>
<div class="line left">
<span class="bold small">Write: page </span><span class="small">| pn [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(pn &larr; page pageNumber) &gt; (lastpn+1)⇒ [self error: &rsquo;illegal page number&rsquo;]<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"make sure we can write"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self writeMode: page.<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">page mode: [pn ≥ lastpn⇒ [SetEof] NoHoles].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self doCommand: Write page: page error: &rsquo;Write:&rsquo;.<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"file possibly extended"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[pn = (lastpn+1)⇒ [lastpn &larr; pn]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑page]</span></div>
<div class="line left">
<span class="bold small">writeMode: page </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"make sure we can write on file"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">type = write⇒ []<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"turn on writing by closing and reopening file. eventually there might be<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">a simpler way to change file mode"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self close.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">type &larr; write.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">directory Find: self⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"file handle changed"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">page serialNumber: serialNumber]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self error: &rsquo;file failed to reopen&rsquo;]</span></div>
<div class="line left">
<span class="bold large"><br>IFS</span></div>
<div class="line left">
<span class="bold small">allocatePage </span><span class="small">[⇑directory allocatePage]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪ILFile under: &rsquo;IFS File System&rsquo;.</span></div>
<div class="line left">
<span class="small">ILFile classInit</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"ILFileDirectory"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;ILFileDirectory&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: FileDirectory<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;userName userPassword isocket&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;&rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">sharing: ILFilePool;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>IFS directory, 12/79</span></div>
<div class="line left">
<span class="bold large"><br>Dictionary</span></div>
<div class="line left">
<span class="bold small">Delete: file </span><span class="small">["delete a file (highest version)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">shorten header block to 2 words: command&length,  file handle"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(file newPage) length: ¬6; doCommand: Delete error: &rsquo;Delete:&rsquo;]</span></div>
<div class="line left">
<span class="bold small">entryClass </span><span class="small">[⇑ILFile]</span></div>
<div class="line left">
<span class="bold small">Find: file </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"since there can be many readers but only one writer, default mode is for<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">read only. writing will cause file to be closed and reopened for writing"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑self openFile: file mode: [file type = write⇒ [WriteOld] ReadOld]]</span></div>
<div class="line left">
<span class="bold small">Insert: file </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">file type: write.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self openFile: file mode: CreateNew⇒ [⇑file]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">file error: &rsquo;Insert: cannot create&rsquo;]</span></div>
<div class="line left">
<span class="bold small">obsolete </span><span class="small">[⇑isocket ≡ nil]</span></div>
<div class="line left">
<span class="bold small">open </span><span class="small">| page [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">isocket ≡ nil "self obsolete"⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[isocket &larr; ILSocket new hostName: directory "name of IFS/Leaf server"⇒ []<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">isocket &larr; nil.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user notify: directory + &rsquo; (name not found)&rsquo;].<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">super open.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">page &larr; self newPage.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"treat packet in page as a parameter block"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(ILParameterBlock new)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">packet &larr; page packet;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nextword &larr; 0; "host number (0 = this, ¬1 = all)"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nextString &larr; self userName;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nextString  &larr; self userPassword.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">page doCommand: Reset error: false⇒ []<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">isocket &larr; nil.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user notify: &rsquo;open (reset)&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]]</span></div>
<div class="line left">
<span class="bold small">release </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self obsolete⇒ []<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"shorten header block to 0 words.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">DestroyConnection. after this the connection is gone"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(self newPage) length: ¬10; doCommand: Quit error: false.<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">isocket close.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">isocket &larr; nil]</span></div>
<div class="line left">
<span class="bold small">versionNumbers </span><span class="small">[⇑true]</span></div>
<div class="line left">
<span class="bold large"><br>IFS</span></div>
<div class="line left">
<span class="bold small">allocatePage </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[isocket≡nil⇒ [self open]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"return a packet to be used by ILFilePage"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑isocket freePacket]</span></div>
<div class="line left">
<span class="bold small">name: userName password: userPassword</span></div>
<div class="line left">
<span class="bold small">noAck </span><span class="small">["an optimization for intense ether activity" isocket noAck]</span></div>
<div class="line left">
<span class="bold small">openFile: file mode: m </span><span class="small">| page [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"open bit modes<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">read<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">write<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">extend<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">multiple (0)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">create name<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">explicit version in name (2b)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">no, old, next or old, any<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">default (if no version specified) (2b)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">no, lowest, highest, next<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">unused (7b)"<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self open.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">page &larr; file newPage.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"treat packet in page as a parameter block"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(ILParameterBlock new)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">packet &larr; page packet;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nextword &larr; 0; "file handle"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nextword &larr; m; "modes"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nextString &larr; self userName;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nextString  &larr; self userPassword;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nextString &larr; &rsquo;&rsquo;; "connect name"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nextString &larr; &rsquo;&rsquo;; "connect password"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nextString &larr; self checkName: file name.<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"answer bits (in page header: 5)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">same (5b)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">version (4b)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bad, default lowest, default highest, default next, !*, !L, !H, !N, explicit old, explicit lowest, explicit highest, explicit next, explicit new, explicit-less, explicit between, explicit greater"<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">page &larr; file doCommand: Open page: page error: false⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">file serialNumber: page serialNumber.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"open returns file length"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">file lastPage: (page pageNumber - [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">((page header: 4) land: 0777) =0⇒ ["full last page" 1] 0] max: 1)]<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">file error = NotFound⇒ [⇑false]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑file error: &rsquo;open &rsquo; + (file errorString: file error)<br>]</span></div>
<div class="line left">
<span class="bold small">socket </span><span class="small">[⇑isocket]</span></div>
<div class="line left">
<span class="bold small">userName </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">userName ≡ nil or⦂ userName empty⇒ [⇑super userName]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑userName]</span></div>
<div class="line left">
<span class="bold small">userPassword </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">userPassword ≡ nil or⦂ userPassword empty⇒ [⇑super userPassword]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑userPassword]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪ILFileDirectory under: &rsquo;IFS File System&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"ILFilePage"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;ILFilePage&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: EtherFilePage<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;&rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">sharing: ILFilePool;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>12/79, SAW.<br>Format of header is generally (for read/write)<br>1 operation (5 bits opcode, 1 bits request/answer, 10 bits inclusive byte length of block<br>2 file handle<br>3&4 byte address (mode in high 5 bits)<br>5 byte length</span></div>
<div class="line left">
<span class="bold large"><br>FilePage</span></div>
<div class="line left">
<span class="bold small">headerLength </span><span class="small">[⇑34 "4+20+10"]</span></div>
<div class="line left">
<span class="bold small">length </span><span class="small">["valid for read or write" ⇑self header: 5]</span></div>
<div class="line left">
<span class="bold small">length: len </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"10 bytes in a normal header block. ILParameterBlock can change things.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">also negative lengths can shorten it and change pupLength"<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"length of command block, including data"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self header: 1 &larr; 10 + len.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"number of data bytes to read/write"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self header: 5 &larr; len.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"set pupLength"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">super length: len]</span></div>
<div class="line left">
<span class="bold small">pageNumber </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"extract page number from 27-bit byte address. ignore high 5 mode bits.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">dividing byte adress (which may be a LargeInteger) by self dataLength (512)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">is the correct but slow way to do this. byte address 0 = page 1"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑(((self header: 3) land: 03777) * 0200 "lshift: 7, maybe large") +<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">((self header: 4) lshift: ¬9) + 1]</span></div>
<div class="line left">
<span class="bold small">pageNumber: pn </span><span class="small">["inverse of </span><span class="bold small">pageNumber</span><span class="small">. set 5 mode bits to 0"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pn &larr; pn-1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self header: 3 &larr; pn / 0200 "lshift: ¬7, except for large pn".<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self header: 4 &larr; pn lshift: 9]</span></div>
<div class="line left">
<span class="bold small">serialNumber </span><span class="small">| sn [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">sn &larr; String new: 4.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">sn◦1 &larr; sn◦2 &larr; 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">sn word: 2 &larr; self header: 2.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑sn]</span></div>
<div class="line left">
<span class="bold small">serialNumber: sn </span><span class="small">[self header: 2 &larr; sn word: 2]</span></div>
<div class="line left">
<span class="bold large"><br>IFS</span></div>
<div class="line left">
<span class="bold small">command: com </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"operation word (header 1)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">0-4<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">opcode<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">5<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">0 request<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">1 answer<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">6-15<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">inclusive byte length of operation block"<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">page pupType &larr; LeafType.<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"make operation a request, preserve length set earlier"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">page◦25 &larr; (page◦25 land: 3) + (com lshift: 3).<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"left half pupID1"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">page◦11 &larr; [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">com = Reset⇒ [OpenConnection]; = Quit⇒ [DestroyConnection] Data]]</span></div>
<div class="line left">
<span class="bold small">mode: m </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">current meaning of 5 read/write bits (from high to low):<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">0-1<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">0 read or write anywhere<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">1 no holes (read or write) zeros past end<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">2 don&rsquo;t extend on read or write<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">3 check extend (Error)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">2<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">1 set eof<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">3-4<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">0 undefined</span><span class="small">"<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"m is a byte which is already shifted"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">page◦29 &larr; (page◦29 land: 7) + m]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪ILFilePage under: &rsquo;IFS File System&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"ILParameterBlock"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;ILParameterBlock&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: Object<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;packet position&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;&rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">sharing: ILFilePool;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>for passing parameters to IFS. primarily used by ILFileDirectory open & openFile:</span></div>
<div class="line left">
<span class="bold large"><br>Initialization</span></div>
<div class="line left">
<span class="bold small">packet &larr; packet </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"default is an empty (data) packet, except first header word"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self position: 26]</span></div>
<div class="line left">
<span class="bold large"><br>Changing values</span></div>
<div class="line left">
<span class="bold small">nextString &larr; s </span><span class="small">| strm [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">strm &larr; packet pupString asStream.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">strm skip: position; nextword &larr; s length; append: s; padNext &larr; 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self position: strm position]</span></div>
<div class="line left">
<span class="bold small">nextword &larr; w </span><span class="small">| strm [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">strm &larr; packet pupString asStream.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">strm skip: position; nextword &larr; w.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self position: strm position]</span></div>
<div class="line left">
<span class="bold small">position: position </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"changing length of data in packet"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">packet pupLength &larr; position - 2.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"set inclusive byte length in first command word; rest set later"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">packet word: 13 &larr; position - 24]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪ILParameterBlock under: &rsquo;IFS File System&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"ILSocket"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;ILSocket&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: RetransmitSocket<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;seqNum outPac result abortTransfer outAck&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;&rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">sharing: ILFilePool;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>for communicating with a Leaf socket on an IFS server, 12/79</span></div>
<div class="line left">
<span class="bold large"><br>Socket</span></div>
<div class="line left">
<span class="bold small">net: n host: h </span><span class="small">["usually called by </span><span class="bold small">hostName:</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">seqNum &larr; 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">super net: n host: h soc: 043 asInt32.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self retransmit: 8 every: [n = NETNUM⇒ ["same net" 400] 1800].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self setAck]</span></div>
<div class="line left">
<span class="bold small">noAck </span><span class="small">["if acknowledgements are not needed" outAck &larr; false]</span></div>
<div class="line left">
<span class="bold small">sendPacket: outPac </span><span class="small">| nseq [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"send a packet, wait for result, and acknowledge.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold small">RetransmitSocket setAddressesAndComplete:</span><span class="small"> sets timer<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold small">ILSocket socProcess:</span><span class="small"> receives answers<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold small">ILSocket timerFired</span><span class="small"> handles retransmissions"<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">result &larr; abortTransfer &larr; false.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"alloc, receiver seq"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">outPac pupID0 &larr; <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"command, send seq"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">outPac◦12 &larr; "pupID1 &larr; (outPac pupID1 land: 0177400) +" seqNum.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self setAddressesAndComplete: outPac.<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"while waiting for packet to arrive, set up ack"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nseq &larr; (seqNum +1) \ 256.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[outPac◦11 = DestroyConnection⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"assume reply will be Dally. send Quit to shut down connection a little faster"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[outAck⇒ []<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"create ack"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self setAck.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">outAck pupID0 &larr; outAck◦12 &larr; seqNum].<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">outAck◦11 &larr; Quit.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">retransMax &larr; 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"same sequence numbers as previous"]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">outAck⇒ ["acknowledgement for Open & Data"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">outAck pupID0 &larr; outAck◦12 &larr; nseq]<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"in rapid interchanges, the next request is an implicit ack, so it&rsquo;s faster not to send one. however, packets unacknowledged for ~5 secs. at the server end can cause degraded performance"].<br> <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"now wait for </span><span class="bold small">socProcess:</span><span class="small"> to set result, or </span><span class="bold small">timerFired</span><span class="small"> to set abortTransfer"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">until⦂ (result or⦂ abortTransfer) do⦂ [].<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[result⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">seqNum &larr; nseq.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">outAck⇒ ["send ack" self completePup: outAck]]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑result]</span></div>
<div class="line left">
<span class="bold small">setAck </span><span class="small">["create acknowledgement packet"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">outAck &larr; self freePacket.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">outAck pupType &larr; LeafType.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">outAck dataString &larr; &rsquo;&rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"control code"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">outAck◦11 &larr; Ack.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self setAddresses: outAck]</span></div>
<div class="line left">
<span class="bold small">socProcess: Ipac </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"check if this is a packet we want. normally left half of pupID1 = Data (0).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">in case of DestroyConnection, control code might be Dallying (10)"<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">Ipac◦12 "pupID1" = seqNum and⦂ Ipac pupType = LeafType⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"turn off timer, save result"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self timerOff.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">result &larr; Ipac]<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"recycle packet"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self freePacket: Ipac]</span></div>
<div class="line left">
<span class="bold small">timerFired </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"timer has fired -- retransmit or abort"<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">result or⦂ abortTransfer⇒ ["bug?--timer may not have been disabled yet"]<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self timerOn⇒ ["retransmit" self completePup: outPac]<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"abort"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">abortTransfer &larr; true]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪ILSocket under: &rsquo;IFS File System&rsquo;.</span></div>
    <div class="line left">
<span class="small">&rsquo;From Smalltalk 5.5k XM November 24 on 22 November 1980 at 2:57:08 am.&rsquo;<br></span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large">"EventQueue"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;EventQueue&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: Queue<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;primitivequeue readwriteelapsed time&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;read elapsed write &rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>The EventQueue (Events) is a subclass of class Queue.  It contains a regular queue which is filled from a block of memory (currently 128 words long), updated during the 60HZ interrupt.  This block of memory is called the primitivequeue, and is unpacked into the regular queue when events are available upon receiving the message peek or next.  The fundamental difference between peek and next is that next dequeues the current event and peek does not.  Furthermore peek will return false when the queue is empty, and next, when the queue is empty, will create a time elapsed event and return that.  An event will be of class UserEvent as created by the primitiveDequeue and next  messages. The machine code thinks of events as a 4-word structure as follows:<br><br>Word 1:<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">Left Byte:<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">1 = Key down.  0 = Key up.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">Right Byte:<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">8-bit Ascii value.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">Mouse Buttons:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">Left/Top</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">=</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">0<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">Middle</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">=</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">1<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">Right/Bottom</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">=</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">2<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">Keyset:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">Leftmost</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">=</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">3<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">=</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">4<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">=</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">5<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">=</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">6<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">Rightmost</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">=</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">7<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">Values 8 - 255, keyboard decodings as expected by rawkbd.<br><br>Word 2:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">Time (sixtieths of a second since last event).<br><br>Word 3:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">Cursor x coordinate (UserView htab accounted for).<br><br>Word 4:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">Cursor y coordinate (UserView vtab accounted for)..<br></span></div>
<div class="line left">
<span class="bold large"><br>Initialization</span></div>
<div class="line left">
<span class="bold small">init</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold small"> </span><span class="italic small">"sets up system wide event queue -- only one from the present"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"***BEWARE, USED ONLY AT TIME OF SYSTEM GENERATION***"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">primitivequeue &larr; CoreLocs new base: (mem◦0114) length: (mem◦0115).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">readwriteelapsed &larr; CoreLocs new base: 0111 length: 3.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">read &larr; 0. write &larr; 1. elapsed &larr; 2.</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"offsets of read, write and elapsed pointers"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">time &larr; 0.</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"start time at 0"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">super of: (Vector new: 4). </span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"initialize Smalltalk queue"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold large"><br>Public Access</span></div>
<div class="line left">
<span class="bold small">elapsedtime </span><span class="small">[⇑readwriteelapsed◦elapsed] </span><span class="italic small">"return elapsed time"</span><span class="small"><br></span></div>
<div class="line left">
<span class="bold small">next </span><span class="small">| event elapsedtime </span><span class="italic small">"return event from queue unless both queues empty,  when return null event"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[event &larr; self dequeue ⇒ [⇑event]</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"Queue not empty?"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">event &larr; self primitiveDequeue ⇒ [⇑event]</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"primitivequeue not empty?"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">elapsedtime &larr; readwriteelapsed◦elapsed.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑UserEvent new</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"when empty return null event"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">x:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user x</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"event x"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">y:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user y</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"event y"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">type:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">0</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"2=up, 1=down, 0=null, only time passed"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">stroke:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">0</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"0 stroke for null event"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">elapsed:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">elapsedtime</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"1-32767 sixtieths of a sec -- since last event"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">time:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(time + elapsedtime) asSmall</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"time since timer reset"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span></div>
<div class="line left">
<span class="bold small">peek </span><span class="small">| event </span><span class="italic small">"unless both queues empty, return event from queue, but dont dequeue"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[event &larr; super peek ⇒[ ⇑event]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">event &larr; self primitiveDequeue ⇒ [⇑self next &larr; event]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑false</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span></div>
<div class="line left">
<span class="bold small">reset </span><span class="italic small">"for the present, just reset time to 0"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[time &larr; 0]</span></div>
<div class="line left">
<span class="bold small">time </span><span class="small">[⇑time]</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> </span><span class="italic small">"return time"</span><span class="small"><br></span></div>
<div class="line left">
<span class="bold small">time &larr; time</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold small"> </span><span class="italic small">"reset time"</span><span class="small"><br></span></div>
<div class="line left">
<span class="bold large"><br>Private</span></div>
<div class="line left">
<span class="bold small">primitiveDequeue </span><span class="small">| rp tands nrp event elapsedtime<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"unless empty, return event from primitivequeue"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[(readwriteelapsed◦read) = (readwriteelapsed◦write) ⇒ </span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑false].</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"primitivequeue empty?"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"Build event from primitive queue and return it."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"first word has type and stroke packed"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">tands &larr; primitivequeue◦(rp &larr; readwriteelapsed◦read).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">elapsedtime &larr; primitivequeue◦(rp + 1).</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">event &larr; UserEvent new<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">x:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">primitivequeue◦(rp + 2)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"event x"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">y:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">primitivequeue◦(rp + 3)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"event y"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">type:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[tands &lt; 0 ⇒ [2] 1]</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"2=up, 1=down"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">stroke:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[tands &gt; 0 ⇒ [tands] 0 - tands]</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"1-336"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">elapsed:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">elapsedtime</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"1-32767 sixtieths of a second"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">time:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(time &larr; (time + elapsedtime) asSmall).<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nrp &larr; rp + 4.</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"set bumped read pointer"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[nrp ≥ (primitivequeue length) ⇒ [nrp &larr; 1]].</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"Wrap-around?"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">readwriteelapsed◦read &larr; nrp.</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"bump read pointer"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑event</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"Return event"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪EventQueue under: &rsquo;Events&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"MessageTally"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;MessageTally&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: Object<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;class method tally rcvrs&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;timer &rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>The following statement analyzes the evaluation of &rsquo;user restore&rsquo;.  It checks every 10 sixtieths of a second to see what method is being executed.  It prints the analysis on file &rsquo;restore.spy&rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">spy every: 10; on⦂ [user restore]; report: &rsquo;restore.spy&rsquo;; close.<br>Read further to learn of more flexible ways to use message tallies.<br><br>A message tally is a tally of how many times, according to some authority, a certain method or any of that method&rsquo;s callees has been invoked.  Message tallies for the callees are listed in the vector, rcvrs; thus, each message tally is a node in a tree.  The root of that tree is called the &rsquo;root tally&rsquo;; its method the &rsquo;root method&rsquo;; and the context that was running that method the &rsquo;root context&rsquo;.  Contexts that do not have the root context on their stack are tallied as if the root context were at the bottom of their stack.<br><br>The authority informs the root tally of invocations in either of two ways: &rsquo;explicitly&rsquo; or by &rsquo;spying&rsquo;.<br><br>To explicitly create the tallies from a root context, rc, a root tally is created with:<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">mt &larr; MessageTally new from: rc<br>and is informed of the invocation of each context c with:<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">mt tally: c<br><br>To spy on (periodically sample) the execution of a statement sequence, ss, every t sixtieths of a second (t&gt;1), a root tally is created with:<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">mt &larr; MessageTally new every: t<br>and is informed of invocations with:<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">valOfSS &larr; mt on⦂ [ss].<br>The context that executes the latter statement is the root context.  Its method should not be called recursively by ss.  Only one spying operation can be in progress at a time, and all spies share the most recently specified time interval.  Thus, there may as well be only one spying message tally in existence, and the global variable &rsquo;spy&rsquo; is predefined as such.<br><br>Spying typically adds 1/4 second per probe to execution.  Ctrl-shift-esc can be used to abort a spying operation.<br><br>Tallies can be printed by:<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">mt report: &rsquo;filename.spy&rsquo;<br>which prints two tables of invocations sorted by tally, with tallies expressed as percentages and with methods described in terms of their defining class and selector.  In the first table, &rsquo;Leaves&rsquo;, tallies do not include time spent in submethods (this is like the spy in Swat).  In the second table, &rsquo;Tree&rsquo;, the percentages do include time spent in submethods, and those submethods are displayed indented.  In both tables, entries below a &rsquo;cutoff&rsquo; of 2 per cent are suppressed.<br><br>Different cutoffs can be specified for each table.  To cut off Leaves at 7.5 per cent and Tree at 3 per cent, use:<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">mt report: &rsquo;filename.spy&rsquo; cutoff: 7.5,3<br>A cutoff of 100 or greater suppresses printing of that table completely.  To output to a specified stream, use the message &rsquo;fullprinton:cutoff:&rsquo;.<br><br>To release the storage occupied by the tally tree, use the message &rsquo;close&rsquo;.</span></div>
<div class="line left">
<span class="bold large"><br>Public Tallying</span></div>
<div class="line left">
<span class="bold small">abort<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[timer is: Timer⇒ [timer disable]]</span></div>
<div class="line left">
<span class="bold small">classInit<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[Smalltalk define: ↪spy as: (MessageTally new every: 10)]</span></div>
<div class="line left">
<span class="bold small">close </span><span class="italic small">"release storage"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[class &larr; method &larr; tally &larr; rcvrs &larr; nil]</span></div>
<div class="line left">
<span class="bold small">every: sixtieths</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold small">  </span><span class="italic small">"Create a spy that samples with the specified period"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self abort. timer &larr; Timer new for: sixtieths action⦂ [self tally: Top◦1. timer reset]]</span></div>
<div class="line left">
<span class="bold small">from: context  </span><span class="italic small">"Create a tallier from the specified root"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self class: context receiver class method: context method]</span></div>
<div class="line left">
<span class="bold small">moreon⦂ remote </span><span class="small">| val  </span><span class="italic small">"Spy on the specified evaluation without resetting"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["use as follows:<br></span><span class="bold small">eachtime  <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[spy every: 10.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑spy moreon⦂ [super eachtime].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">class &larr; remote receiver class.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">method &larr; remote method. <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">timer reset. val &larr; remote eval. timer disable. ⇑val]</span></div>
<div class="line left">
<span class="bold small">on⦂ remote </span><span class="small">| val  </span><span class="italic small">"Spy on the specified evaluation"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self from: remote. timer reset. val &larr; remote eval. timer disable. ⇑val]</span></div>
<div class="line left">
<span class="bold small">reset<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["reset stats"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">tally &larr; 0. rcvrs &larr; Vector new: 0]</span></div>
<div class="line left">
<span class="bold small">tally: context </span><span class="small">| root  </span><span class="italic small">"Explicitly tally the specified context and its stack"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[context method≡method⇒ [⇑self bump]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(root &larr; context sender)≡nil⇒[⇑self bump tallyPath: context]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑(self tally: root) tallyPath: context]</span></div>
<div class="line left">
<span class="bold large"><br>Public Reporting</span></div>
<div class="line left">
<span class="bold small">fullprinton: s cutoff: pct </span><span class="small">| set mt i t<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[user displayoffwhile⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[s print: tally; append: &rsquo; tallies&rsquo;; cr. tally=0⇒ []<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s cr; cr. [pct is: Vector⇒ [] pct &larr; pct, pct].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[pct◦1&lt;100⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[s append: &rsquo;**Leaves**&rsquo;; cr. t &larr; ((pct◦1)*(tally-1)/100) asInteger.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">set &larr; HashSet new init: 128. self leaves: set.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self cumprinton: s from: set total: tally over: t. s next&larr;12; cr.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">set &larr; nil]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[pct◦2&lt;100⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[s append: &rsquo;**Tree**&rsquo;; cr. t &larr; ((pct◦2)*(tally-1)/100) asInteger.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self treeprinton: s tab: 0 total: tally over: t. s next&larr;12; cr]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s skip: ¬2]]</span></div>
<div class="line left">
<span class="bold small">printon: s<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[class≡nil⇒ [super printon: s] self printon: s total: 100]</span></div>
<div class="line left">
<span class="bold small">report: filename<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self report: filename cutoff: 2]</span></div>
<div class="line left">
<span class="bold small">report: filename cutoff: pct </span><span class="small">| f  </span><span class="italic small">"pct=(leaves,roots,tree) or one number for all"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[f &larr; dp0 file: filename. f append: filename; space.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self fullprinton: f cutoff: pct. f close]</span></div>
<div class="line left">
<span class="bold large"><br>Private Tallying</span></div>
<div class="line left">
<span class="bold small">bump<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[tally &larr; tally+1]</span></div>
<div class="line left">
<span class="bold small">tallyPath: context </span><span class="small">| m path mt c<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[m &larr; context method. path&larr;false.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ mt from: rcvrs do⦂ [mt method≡m⇒ [path&larr;mt]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[path≡false⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[path &larr; MessageTally new class: context receiver class method: m. rcvrs &larr; rcvrs, path]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑path bump]</span></div>
<div class="line left">
<span class="bold large"><br>Private Reporting</span></div>
<div class="line left">
<span class="bold small">&lt; mt<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑tally &gt; mt tally]</span></div>
<div class="line left">
<span class="bold small">= mt<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑mt method≡method]</span></div>
<div class="line left">
<span class="bold small">&gt; mt<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑tally &lt; mt tally]</span></div>
<div class="line left">
<span class="bold small">breakdown </span><span class="small">| n b mt<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[b &larr; rcvrs. b≡nil or⦂ b length=0⇒ [⇑↪()]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">n &larr; tally. for⦂ mt from: b do⦂ [n &larr; n - mt tally].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[n&gt;0⇒ [b &larr; b, [MessageTally new class: class method: method; primitives: n]]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑b]</span></div>
<div class="line left">
<span class="bold small">bump: n<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[tally &larr; tally+n]</span></div>
<div class="line left">
<span class="bold small">cumprinton: s from: set total: total over: threshold </span><span class="small">| mt<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[for⦂ mt from: set contents sort do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[mt tally&gt;threshold⇒ [mt printon: s total: total. s cr] ⇑self]]</span></div>
<div class="line left">
<span class="bold small">hash<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑method asOop]</span></div>
<div class="line left">
<span class="bold small">into: set </span><span class="small">| mt i<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[[i &larr; set find: self⇒ [mt &larr; set objects◦i]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">set insert: (mt &larr; MessageTally new class: class method: method)].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">mt bump: tally]</span></div>
<div class="line left">
<span class="bold small">leaves: ldict </span><span class="small">| b mt<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[b &larr; self breakdown. b length=0⇒ [self into: ldict] for⦂ mt from: b do⦂ [mt leaves: ldict]]</span></div>
<div class="line left">
<span class="bold small">primitives: tally<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[rcvrs &larr; nil]</span></div>
<div class="line left">
<span class="bold small">printon: s total: total </span><span class="small">| i v<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[v &larr; (0.0+tally/total*1000.0+0.5) asInteger asString. i &larr; v length.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s append: &rsquo;  &rsquo;◦(i to: 2); append: v◦(1 to: i-1); append: &rsquo;.&rsquo;; next&larr;v◦i; space.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">rcvrs≡nil⇒ [s append: &rsquo;primitives&rsquo;]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">class describe: method on: s]</span></div>
<div class="line left">
<span class="bold small">tally<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑tally]</span></div>
<div class="line left">
<span class="bold small">treeprinton: s tab: tab total: total over: threshold </span><span class="small">| i mt<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[tally≤threshold⇒ []<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[tab&gt;0⇒ [for⦂ i to: tab-1 do⦂ [s append: &rsquo;  |&rsquo;]. self printon: s total: total. s cr]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ mt from: self breakdown sort do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[mt treeprinton: s tab: tab+1 total: total over: threshold]]</span></div>
<div class="line left">
<span class="bold large"><br>Private Common</span></div>
<div class="line left">
<span class="bold small">class: class method: method<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[tally &larr; 0. rcvrs &larr; Vector new: 0]</span></div>
<div class="line left">
<span class="bold small">method<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑method]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪MessageTally under: &rsquo;Events&rsquo;.</span></div>
<div class="line left">
<span class="small">MessageTally classInit</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"PriorityInterrupt"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;PriorityInterrupt&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: Object<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;scheduler priority&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;&rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>PriorityInterrupts fill the need for (sched, level) pairs.  Most messages are simply passed on to the scheduler with the priority as an argument</span></div>
<div class="line left">
<span class="bold large"><br>Initialization</span></div>
<div class="line left">
<span class="bold small">from: scheduler at: priority</span></div>
<div class="line left">
<span class="bold large"><br>Level numbers</span></div>
<div class="line left">
<span class="bold small">+ arg<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑priority + arg]</span></div>
<div class="line left">
<span class="bold large"><br>Scheduling</span></div>
<div class="line left">
<span class="bold small">deepsleep<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[scheduler deepsleep: priority]</span></div>
<div class="line left">
<span class="bold small">disable<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[scheduler disable: priority]</span></div>
<div class="line left">
<span class="bold small">enable<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[scheduler enable: priority]</span></div>
<div class="line left">
<span class="bold small">reset<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[scheduler reset: priority]</span></div>
<div class="line left">
<span class="bold small">restart<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[scheduler restart: priority]</span></div>
<div class="line left">
<span class="bold small">run: newContext<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[scheduler run: newContext at: priority] primitive: 87</span></div>
<div class="line left">
<span class="bold small">sleep<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[scheduler sleep: priority]</span></div>
<div class="line left">
<span class="bold small">swap: newContext<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold small"> with: fieldReference<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[scheduler<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">swap: newContext<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">at: priority<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">with: fieldReference] primitive: 88</span></div>
<div class="line left">
<span class="bold small">terminate<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[scheduler terminate: priority]</span></div>
<div class="line left">
<span class="bold small">wakeup<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[scheduler wakeup: priority]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪PriorityInterrupt under: &rsquo;Events&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"PriorityScheduler"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;PriorityScheduler&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: Object<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">sourceIndirect<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">"an indirect reference to the source of power,<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">ie the source from which this scheduler was spawned,<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">and who therefore holds the suspension if it is suspended."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">suspendedContexts<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">"&lt;Vector of Contexts&gt; the suspended processes"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">initialContexts<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">"&lt;Vector of Contexts&gt; root processes for restarting"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">enabledPriorities<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">"&lt;Integer&gt; priorities which can receive control"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">awakePriorities<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">"&lt;Integer&gt; priorities which are requesting control"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">interruptedPriorities<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">"&lt;Integer&gt; new priorities which are requesting control"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">currentPriority<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">"&lt;Integer&gt; priority which currently has control"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">usedPriorities<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">"&lt;Integer&gt; priorities which have processes installed"&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;TimeInt CtlCDisp UserInt GRODSK CtlShftEscInt CtlCInt &rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">sharing: BitMasks;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>The underlying machine has a pointer to the top-level scheduler (Top), so that physical interrupts can also cause interrupts in Smalltalk.  This they do by calling their own copy of wakeup and reselect.  This copy is also invoked (primitive 65) when reselect is sent to the top-level scheduler, since its source is the virtual machine itself.</span></div>
<div class="line left">
<span class="bold large"><br>Initialization</span></div>
<div class="line left">
<span class="bold small">◦ priority<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑suspendedContexts◦priority]</span></div>
<div class="line left">
<span class="bold small">currentPriority </span><span class="small">[⇑currentPriority]</span></div>
<div class="line left">
<span class="bold small">fromSource: sourceIndirect<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"Initialize a scheduler having 16 spaces for processes"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> suspendedContexts &larr; Vector new: 16.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> initialContexts &larr; Vector new: 16.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> enabledPriorities &larr; 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> awakePriorities &larr; 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> interruptedPriorities &larr; 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> usedPriorities &larr; 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> currentPriority &larr; 0.]</span></div>
<div class="line left">
<span class="bold small">replaceUser: stack<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[UserInt run: stack]</span></div>
<div class="line left">
<span class="bold large"><br>Install and Terminate</span></div>
<div class="line left">
<span class="bold small">install⦂ newContext above: priority </span><span class="small">| i<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"Install a process in the next empty level above &lt;priority&gt; which is initialized from &lt;newContext&gt; (a remote Context). If there is no empty level above that priority, tell the user and return false"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> newContext sender &larr; nil.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> for⦂ i from: (priority+1 to: 16) do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[(usedPriorities land: biton◦i) = 0⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑self<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">INSTALL⦂ [while⦂ true do⦂ [newContext cleancopy eval]]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">AT: i]]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> user show:<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">&rsquo;PriorityScheduler unable to install above level &rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">+priority asString<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">+&rsquo;. false returned&rsquo;. ⇑false]</span></div>
<div class="line left">
<span class="bold small">install⦂ newContext at: priority<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"Install a process at level &lt;priority&gt; which is initialized from &lt;newContext&gt; (a remote Context). If there is already a process at that priority, tell the user and return false"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> newContext sender &larr; nil.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> (usedPriorities land: biton◦priority) = 0⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑self<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">INSTALL⦂ [while⦂ true do⦂ [newContext cleancopy eval]]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">AT: priority]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> user show:<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">&rsquo;PriorityScheduler unable to install at level &rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">+priority asString<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">+&rsquo;. false returned&rsquo;. ⇑false]</span></div>
<div class="line left">
<span class="bold small">run: newContext<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold small"> at: priority<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"replace the process at &lt;priority&gt; with &lt;newContext&gt;. If that is the currently running priority, abandon what is running and start from &lt;newContext&gt;"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> priority = currentPriority⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[sourceIndirect run: newContext]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> suspendedContexts◦priority &larr; newContext]</span></div>
<div class="line left">
<span class="bold small">swap: newContext<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold small"> at: priority<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold small"> with: fieldReference<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"replace the process at &lt;priority&gt; with &lt;newContext&gt; and place the old contents in the field referred to by &lt;fieldReference&gt;"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> priority = currentPriority⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[sourceIndirect<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">swap: newContext<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">with: fieldReference]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> fieldReference value&larr; suspendedContexts◦priority.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> suspendedContexts◦priority &larr; newContext]</span></div>
<div class="line left">
<span class="bold small">terminate: priority<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"Remove a process from the scheduler, allowing that level to be reused"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> enabledPriorities &larr; enabledPriorities land: bitoff◦priority.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> [suspendedContexts◦priority≠nil⇒[(suspendedContexts◦priority) releaseFully]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> [initialContexts◦priority≠nil⇒[(initialContexts◦priority) releaseFully]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> suspendedContexts◦priority &larr; initialContexts◦priority &larr; nil.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> awakePriorities &larr; awakePriorities land: bitoff◦priority.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> interruptedPriorities &larr; interruptedPriorities land: bitoff◦priority.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> usedPriorities &larr; usedPriorities land: bitoff◦priority.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> self reselect]</span></div>
<div class="line left">
<span class="bold large"><br>Enable and Disable</span></div>
<div class="line left">
<span class="bold small">disable: priority<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"Prevent the process at &lt;priority&gt; from being activated by a wakeup. Turn off the corresponding bit in enabledPriorities and check if that changes who should run"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> enabledPriorities &larr; enabledPriorities land: bitoff◦priority.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self reselect]</span></div>
<div class="line left">
<span class="bold small">enable: priority<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"Allow the process at &lt;priority&gt; to be activated by a wakeup. Turn on the corresponding bit in enabledPriorities and check if that changes who should run"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> enabledPriorities &larr; enabledPriorities lor: biton◦priority.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> self reselect]</span></div>
<div class="line left">
<span class="bold large"><br>Wakeup and Sleep</span></div>
<div class="line left">
<span class="bold small">deepsleep: priority<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"Request the process at &lt;priority&gt; to cease running and ignore any new wakeups. Turn off the corresponding bit in awakePriorities and interruptedPriorities and check if that changes who should run"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> awakePriorities &larr; awakePriorities land: bitoff◦priority.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> interruptedPriorities &larr; interruptedPriorities land: bitoff◦priority.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> self reselect]</span></div>
<div class="line left">
<span class="bold small">errorReset<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"There has been an error. Initialize the state of the process that was running.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">  If it was not the user process (priority 1), request it to cease running and<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">  prevent its further running (i.e. disable it)"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> currentPriority=1⇒[self init: currentPriority]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> awakePriorities &larr; awakePriorities land: bitoff◦currentPriority.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> enabledPriorities &larr; enabledPriorities land: bitoff◦currentPriority.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> self init: currentPriority]</span></div>
<div class="line left">
<span class="bold small">reselect<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold small"> </span><span class="small">| newPriority oldPriority newContext tempenabled tempinterrupts<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"Switch to the highest priority enabled process"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> tempenabled &larr; self disable.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> tempinterrupts &larr; interruptedPriorities land: awakePriorities.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> awakePriorities &larr; interruptedPriorities lor: awakePriorities.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> interruptedPriorities &larr; tempinterrupts.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> newPriority &larr; (awakePriorities land: tempenabled) hibit.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> newPriority = 0⇒[enabledPriorities &larr; tempenabled. ⇑false]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> newPriority = currentPriority⇒[enabledPriorities &larr; tempenabled]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> newContext &larr; suspendedContexts◦newPriority.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> suspendedContexts◦newPriority &larr; nil.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> oldPriority &larr; currentPriority.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> currentPriority &larr; newPriority.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> enabledPriorities &larr; tempenabled.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> sourceIndirect<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">swap: newContext<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">with: (suspendedContexts ref: oldPriority)]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">primitive: 65</span></div>
<div class="line left">
<span class="bold small">reset: priority<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"Initialize the state of the process at &lt;priority&gt; and request it to cease running"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> awakePriorities &larr; awakePriorities land: bitoff◦priority.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> self init: priority]</span></div>
<div class="line left">
<span class="bold small">resetCurrent<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"Initialize the state of the process that is running. If it is not the<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">  user process (priority 1), request it to cease running"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> currentPriority=1⇒[self init: currentPriority]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> awakePriorities &larr; awakePriorities land: bitoff◦currentPriority.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> self init: currentPriority]</span></div>
<div class="line left">
<span class="bold small">restart: priority<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"Initialize the state of a suspended process and request it to run"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> interruptedPriorities &larr; interruptedPriorities lor: biton◦priority.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> self init: priority]</span></div>
<div class="line left">
<span class="bold small">sleep: priority<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"Request the process at &lt;priority&gt; to cease running, if a new wakeup has arrived the process will be reawakened. Turn off the corresponding bit in awakePriorities and check if that changes who should run"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> awakePriorities &larr; awakePriorities land: bitoff◦priority.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> self reselect]</span></div>
<div class="line left">
<span class="bold small">wakeup: priority<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"Request the process at &lt;priority&gt; to run. Turn on the corresponding bit in interruptedPriorities and check if that changes who should run"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> interruptedPriorities &larr; interruptedPriorities lor: biton◦priority.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> self reselect]</span></div>
<div class="line left">
<span class="bold large"><br>Top level</span></div>
<div class="line left">
<span class="bold small">init1<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[UserInt &larr; Top<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">install⦂ [user restart]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">at: 1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> UserInt enable wakeup]</span></div>
<div class="line left">
<span class="bold small">init11</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">" Top terminate: 11; init11. "</span><span class="bold small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[GRODSK &larr; Top<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">install⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[user displayoffwhile⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[user show: &rsquo;<br>Smalltalk needs more space.<br>Just a moment...&rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">dp0 growSmalltalkBy: 100.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user show: &rsquo;  Done.&rsquo;; cr].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">GRODSK deepsleep]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">at: 11.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">GRODSK enable]</span></div>
<div class="line left">
<span class="bold small">init8 </span><span class="small">| nw<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[CtlCInt &larr; Top<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">install⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[nw &larr; user notifier: &rsquo;Control c Interrupt&rsquo; level: 1 interrupt: true.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[nw⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[user schedule: nw.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> </span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nw takeCursor.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nw &larr; nil.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> </span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">UserInt restart]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">CtlCInt sleep]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">at: 8.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> CtlCInt enable]</span></div>
<div class="line left">
<span class="bold small">init9  </span><span class="small">"Top terminate: 9; init9."</span><span class="bold small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[CtlShftEscInt &larr; Top<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">install⦂ [spy abort. user restoredisplay. <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[user buttons=7⇒["dont release possible garbage"] (Top◦1) releaseFully].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">UserInt restart. CtlShftEscInt sleep]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">at: 9.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> CtlShftEscInt enable]</span></div>
<div class="line left">
<span class="bold small">initsched<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[Top &larr; self fromSource: (PriorityInterrupt new).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> self init1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> self init11.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> self init8.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> self init9.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> Top top]</span></div>
<div class="line left">
<span class="bold small">top<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"Make this scheduler the top level one. It will receive all physical (non-Smalltalk) interrupts"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> enabledPriorities &larr; enabledPriorities lor: biton◦1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> awakePriorities &larr; awakePriorities lor: biton◦1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> currentPriority &larr; 1] primitive: 61</span></div>
<div class="line left">
<span class="bold large"><br>Critical sections</span></div>
<div class="line left">
<span class="bold small">critical⦂ expr</span><span class="small">| t v<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"Execute &lt;expr&gt; without allowing it to be interrupted"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> t &larr; self disable.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> v &larr; expr eval.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> enabledPriorities &larr; t.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> self reselect. ⇑v]</span></div>
<div class="line left">
<span class="bold large"><br>Private</span></div>
<div class="line left">
<span class="bold small">disable </span><span class="small">| t<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"This message should deffinitely be protected. Zero all the enabled flags and return the previous value of them"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> t &larr; enabledPriorities. enabledPriorities &larr; 0. ⇑t] primitive: 66</span></div>
<div class="line left">
<span class="bold small">init: priority<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold small"> </span><span class="small">| newPriority oldPriority newContext tempenabled tempinterrupts<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"This message should be protected. It is used by reset: and restart: to actually switch suspended processes"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> tempenabled &larr; self disable.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> tempinterrupts &larr; interruptedPriorities land: awakePriorities.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> awakePriorities &larr; interruptedPriorities lor: awakePriorities.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> interruptedPriorities &larr; tempinterrupts.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> newPriority &larr; (awakePriorities land: tempenabled) hibit max: 1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> (newPriority = currentPriority)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">and: (currentPriority = priority)⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[enabledPriorities &larr; tempenabled.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> sourceIndirect run: (initialContexts◦priority) cleancopy]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> suspendedContexts◦priority &larr; (initialContexts◦priority) cleancopy.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> newPriority = currentPriority⇒[enabledPriorities &larr; tempenabled.]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> newContext &larr; suspendedContexts◦newPriority.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> suspendedContexts◦newPriority &larr; nil.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> oldPriority &larr; currentPriority.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> currentPriority &larr; newPriority.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> enabledPriorities &larr; tempenabled.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> oldPriority = priority⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[sourceIndirect run: newContext]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> sourceIndirect<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">swap: newContext<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">with: (suspendedContexts ref: oldPriority)]</span></div>
<div class="line left">
<span class="bold small">INSTALL⦂ newContext AT: priority<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"This message should be protected, it is used by install:at: and install:above: to do the actual initialization of the process"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> newContext sender &larr; nil.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> usedPriorities &larr; usedPriorities lor: biton◦priority.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> initialContexts◦priority &larr; newContext.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> suspendedContexts◦priority &larr; newContext cleancopy.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> ⇑PriorityInterrupt new from: self at: priority]</span></div>
<div class="line left">
<span class="bold small">printon: s </span><span class="small">| i b2 j<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[super printon: s.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: 5 do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[s cr.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">b2&larr; (usedPriorities, enabledPriorities, awakePriorities,<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">interruptedPriorities, (1 lshift: currentPriority-1))◦i base: 2.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ j to: 16-b2 length do⦂ [s next&larr; &rsquo;0&rsquo;◦1].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s append: b2; space;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">append: ↪(&rsquo;used&rsquo; &rsquo;enabled&rsquo; &rsquo;awake&rsquo; &rsquo;interrupted&rsquo; &rsquo;current&rsquo;)◦i]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold large"><br>Reclamation</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪PriorityScheduler under: &rsquo;Events&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"Timer"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;Timer&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: Object<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">activeTime</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">"how long this Timer will be the active one"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">nextTimer</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">"the Timer which will fire after this one"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">lastTimer</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">"the Timer which will fire before this one"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">delay</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">"how long between setting and firing"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">action</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">"what happens when this timer fires"&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;currentTimer timerActions &rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>A Timer is an object which causes an action after an interval of time. The time interval is measured in units of a sixtieth of a second from when the instance was initialized with the message &lt;for: {time interval} action⦂ [{code for action}]&gt;. When the interval is over the Timer fires by placing the action on a queue to be evaluated before processing at the user level continues. There is no need to mantain a name for a Timer while it is active, but a named timer may be disabled or reused. The Timers waiting to fire form a doubly linked list whose first link is referred to by the class variable currentTimer. Each Timer knows how long it should run after the preceding Timer has fired</span></div>
<div class="line left">
<span class="bold large"><br>Initialization</span></div>
<div class="line left">
<span class="bold small">classInit</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"Initialize the processes used by the Timers"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[timerActions &larr; Queue new of: (Vector new: 4).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> self init16.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> self init12]</span></div>
<div class="line left">
<span class="bold small">for: delay action⦂ action<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"Initialize a new Timer"</span><span class="small">]</span></div>
<div class="line left">
<span class="bold small">init12 </span><span class="small">| nextAction</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"Initialize the process which evals Timer actions"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[Top install⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[while⦂ true do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[while⦂ (nextAction &larr; timerActions next) do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[nextAction eval].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> Top sleep: 12]] at: 12.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> Top enable: 12]</span></div>
<div class="line left">
<span class="bold small">init16</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"Initialize the process wakened by a Timer timing out"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[Top install⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[while⦂ true do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[currentTimer fire.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> Top sleep: 16]] at: 16.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> Top enable: 16]</span></div>
<div class="line left">
<span class="bold small">reset </span><span class="small">| nextTimeout foundit<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"Set up this Timer to add &lt;action&gt; to the Queue of remote Contexts to be evaled after an interval of &lt;delay&gt; sixtieths of a second. Find the proper place in the doubly linked list and calculate the amount of time to run after the preceeding timer fires"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> Top critical⦂ <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[[activeTime≡nil⇒[]self disable].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> activeTime &larr; delay. nextTimer &larr; currentTimer. lastTimer &larr; nil.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> foundit &larr; false.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> until⦂ foundit do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[nextTimer≡nil⇒[foundit &larr; true].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> (nextTimeout &larr; nextTimer activetime) &gt; activeTime⇒[foundit &larr; true].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> activeTime &larr; activeTime - nextTimeout.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> lastTimer &larr; nextTimer.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> nextTimer &larr; lastTimer nexttimer].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> [nextTimer≡nil⇒[] nextTimer insertlast: self].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> lastTimer≡nil⇒[self startup] lastTimer insertnext: self]]</span></div>
<div class="line left">
<span class="bold large"><br>List Behavior</span></div>
<div class="line left">
<span class="bold small">deletelast<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"Delete the Timer before this one. When deleting a Timer, the activeTime of the Timer after it must be increased by its activeTime"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> activeTime &larr; activeTime + lastTimer activetime.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> (lastTimer &larr; lastTimer lasttimer)≡nil⇒[self startup]]</span></div>
<div class="line left">
<span class="bold small">deletenext<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"Delete the Timer after this one"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> nextTimer &larr; nextTimer nexttimer]</span></div>
<div class="line left">
<span class="bold small">insertlast: lastTimer<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"Insert a new Timer before this one. When inserting a Timer in front of another, the activeTime of the later one must be reduced so it is the amount of time after the new Timers firing"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> activeTime &larr; self activetime - lastTimer activetime]</span></div>
<div class="line left">
<span class="bold small">insertnext: nextTimer</span></div>
<div class="line left">
<span class="bold small">lasttimer<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑lastTimer]</span></div>
<div class="line left">
<span class="bold small">nexttimer<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑nextTimer]</span></div>
<div class="line left">
<span class="bold small">release </span><span class="small">[lastTimer &larr; nil. nextTimer &larr; nil. action &larr; nil]</span></div>
<div class="line left">
<span class="bold large"><br>Timing Behavior</span></div>
<div class="line left">
<span class="bold small">activetime<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"If this is the current Timer return the time until it fires, otherwise return activeTime"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> ⇑activeTime] primitive: 96</span></div>
<div class="line left">
<span class="bold small">disable</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"Remove this timer from the list"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[Top critical⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[[self≡currentTimer and⦂ nextTimer≡nil⇒[self shutoff. Top deepsleep: 16]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> [lastTimer≡nil⇒[] lastTimer deletenext].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> [nextTimer≡nil⇒[] nextTimer deletelast].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> activeTime &larr; nil. lastTimer &larr; nil. nextTimer &larr; nil]]</span></div>
<div class="line left">
<span class="bold small">fire</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"Time is up, add the action to the Queue to be evaled"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[timerActions next&larr; action.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> Top wakeup: 12.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> activeTime &larr; nil.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> lastTimer &larr; nil.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> nextTimer≡nil⇒[self shutoff]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> nextTimer startup.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> nextTimer &larr; nil]</span></div>
<div class="line left">
<span class="bold small">primstartup<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"this message informs the virtual machine that this is the next Timer to fire"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[] primitive: 95</span></div>
<div class="line left">
<span class="bold small">shutoff<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"this message informs the virtual machine and class Timer that there are no more Timers to fire"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> currentTimer &larr; nil] primitive: 97</span></div>
<div class="line left">
<span class="bold small">startup<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"make this the next Timer to fire"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> lastTimer &larr; nil.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> currentTimer &larr; self.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> self primstartup]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪Timer under: &rsquo;Events&rsquo;.</span></div>
<div class="line left">
<span class="small">Timer classInit</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"UserEvent"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;UserEvent&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: Point<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;type stroke elapsed time&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;&rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>This class is used by the Events queue (updated in the 60HZ interrupt routine) to package up and return an event every time the queue is popped.  The class provides easy access to various parts of the event.  Users may create their own events by pushing onto the Events queue, which is why the Initialization here is classified as private.</span></div>
<div class="line left">
<span class="bold large"><br>Initialization</span></div>
<div class="line left">
<span class="bold small">x: x y: y type: type stroke: stroke elapsed: elapsed time: time <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"make an event, usually called from EventQueue"</span><span class="small"><br></span></div>
<div class="line left">
<span class="bold large"><br>Public Access</span></div>
<div class="line left">
<span class="bold small">elapsed </span><span class="italic small">"return an event stroke"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"1 - 32767 sixtieths of second since previous non-time-elapsed event recorded"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑elapsed]</span></div>
<div class="line left">
<span class="bold small">isKbdDown<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["if stroke a down stroke and not keyset or mouse button, return it,<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">otherwise return false"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">type ≠ 1 ⇒ [⇑false] ⇑stroke &gt; 16]</span></div>
<div class="line left">
<span class="bold small">stroke </span><span class="italic small">"return an event stroke"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"0-2 = top,middle,bottom mouse buttons, 3-7 = keyset left to right, 8-255 = keyboard"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑stroke]</span></div>
<div class="line left">
<span class="bold small">time </span><span class="italic small">"return an event stroke"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"1 - 32767 sixtieths of second since Events time reset"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑time]</span></div>
<div class="line left">
<span class="bold small">type </span><span class="italic small">"return event type"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"2 = upstroke event, 1 = downstroke event, 0 = time-elapsed event"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑type]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪UserEvent under: &rsquo;Events&rsquo;.</span></div>
    <div class="line left">
<span class="small">&rsquo;From Smalltalk 5.5k XM November 24 on 22 November 1980 at 2:57:08 am.&rsquo;<br></span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large">"BitBlt"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;BitBlt&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: Object<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;function color destbase destraster destx desty<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">width height sourcebase sourceraster sourcex sourcey<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">sstrike dstrike &rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;pageOneCursor &rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>BitBlt copies bits from one rectangle to another in core.  x, y, width and height are in bits, raster is in words, and base is a core address.  Mode is storing, oring, xoring or erasing.  If source or destination is a Smalltalk object, then you have to lock it, as in copyToString, below.  The primitive does no bounds checking, so watch out.</span></div>
<div class="line left">
<span class="bold large"><br>Access to Parts</span></div>
<div class="line left">
<span class="bold small">color  </span><span class="small">[⇑color]</span></div>
<div class="line left">
<span class="bold small">color &larr; color</span></div>
<div class="line left">
<span class="bold small">destbase  </span><span class="small">[⇑destbase]</span></div>
<div class="line left">
<span class="bold small">destbase &larr; destbase</span></div>
<div class="line left">
<span class="bold small">destraster  </span><span class="small">[⇑destraster]</span></div>
<div class="line left">
<span class="bold small">destraster &larr; destraster</span></div>
<div class="line left">
<span class="bold small">destx  </span><span class="small">[⇑destx]</span></div>
<div class="line left">
<span class="bold small">destx &larr; destx</span></div>
<div class="line left">
<span class="bold small">desty  </span><span class="small">[⇑desty]</span></div>
<div class="line left">
<span class="bold small">desty &larr; desty</span></div>
<div class="line left">
<span class="bold small">dest &larr; pt </span><span class="small">[destx&larr; pt x.  desty &larr; pt y]</span></div>
<div class="line left">
<span class="bold small">dstrike </span><span class="small">[⇑dstrike]<br></span></div>
<div class="line left">
<span class="bold small">dstrike &larr; dstrike<br></span></div>
<div class="line left">
<span class="bold small">extent &larr; pt </span><span class="small">[width &larr; pt x.  height &larr; pt y]</span></div>
<div class="line left">
<span class="bold small">function  </span><span class="small">[⇑function]</span></div>
<div class="line left">
<span class="bold small">function &larr; function</span></div>
<div class="line left">
<span class="bold small">height  </span><span class="small">[⇑height]</span></div>
<div class="line left">
<span class="bold small">height &larr; height</span></div>
<div class="line left">
<span class="bold small">sourcebase  </span><span class="small">[⇑sourcebase]</span></div>
<div class="line left">
<span class="bold small">sourcebase &larr; sourcebase</span></div>
<div class="line left">
<span class="bold small">sourceraster  </span><span class="small">[⇑sourceraster]</span></div>
<div class="line left">
<span class="bold small">sourceraster &larr; sourceraster</span></div>
<div class="line left">
<span class="bold small">sourcex  </span><span class="small">[⇑sourcex]</span></div>
<div class="line left">
<span class="bold small">sourcex &larr; sourcex</span></div>
<div class="line left">
<span class="bold small">sourcey  </span><span class="small">[⇑sourcey]</span></div>
<div class="line left">
<span class="bold small">sourcey &larr; sourcey</span></div>
<div class="line left">
<span class="bold small">source &larr; pt </span><span class="small">[sourcex&larr; pt x.  sourcey &larr; pt y]</span></div>
<div class="line left">
<span class="bold small">sstrike </span><span class="small">[⇑sstrike]<br></span></div>
<div class="line left">
<span class="bold small">sstrike &larr; sstrike<br></span></div>
<div class="line left">
<span class="bold small">width  </span><span class="small">[⇑width]</span></div>
<div class="line left">
<span class="bold small">width &larr; width</span></div>
<div class="line left">
<span class="bold large"><br>Setup</span></div>
<div class="line left">
<span class="bold small">classInit <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[pageOneCursor &larr; 0431. "location of hardware cursor"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">forCursor<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[function&larr; color&larr; 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">destbase&larr; sourcebase&larr; 0431.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">width&larr; height&larr; 16. destraster&larr; sourceraster&larr; 1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">destx&larr; desty&larr; sourcex&larr; sourcey&larr; 0. sstrike &larr; dstrike &larr; false<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">init <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[function &larr; color &larr; destbase &larr; destraster &larr; destx &larr; desty &larr; width &larr;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">height &larr; sourcebase &larr; sourceraster &larr; sourcex &larr; sourcey &larr; 0. sstrike &larr; dstrike &larr; false<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold large"><br>Operations</span></div>
<div class="line left">
<span class="bold small">callBLT<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[user croak]  primitive: 33</span></div>
<div class="line left">
<span class="bold small">checksandcall </span><span class="small">| destlocked sourcelocked</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"checks if either base a string and/or strike and locks accordingly"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">function &larr; function land: 017.</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"set up function to add XM stuff"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[destbase class ≡ String ⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[destbase◦1 &larr; destbase◦1.  "set the dirty bit"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">destlocked &larr; destbase.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">destbase &larr; ([dstrike ⇒ [((destlocked lock) + 9)]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">destlocked lock</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> </span><span class="italic small">"strike header"</span><span class="small">])<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[destbase ≠ pageOneCursor ⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[function &larr; function + 020. </span><span class="italic small">"dest not string, then must be in display"</span><span class="small">]</span><span class="italic small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"unless doing cursor work in page one location"</span><span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[sourcebase class ≡ String ⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[sourcelocked &larr; sourcebase.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">sourcebase &larr; ([sstrike ⇒ [((sourcelocked lock) + 9)]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">sourcelocked lock</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> </span><span class="italic small">"strike header"</span><span class="small">])<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[sourcebase ≠ pageOneCursor ⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[function &larr; function + 040. </span><span class="italic small">"source not string, then must be in display"</span><span class="small">]</span><span class="italic small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"unless doing cursor work in page one location"</span><span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self callBLT.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[destlocked ≡ nil ⇒ [] destbase &larr; destlocked unlock].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[sourcelocked ≡ nil ⇒ [] sourcebase &larr; sourcelocked unlock].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">copy: mode <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[function &larr; mode land: 3. self checksandcall]</span></div>
<div class="line left">
<span class="bold small">copycomp: mode <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[function &larr; 4 + (mode land: 3). self checksandcall]</span></div>
<div class="line left">
<span class="bold small">fill: mode color: color <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[function &larr; 12 + (mode land: 3). self checksandcall]</span></div>
<div class="line left">
<span class="bold small">paint: mode <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[function &larr; 8 + (mode land: 3). self checksandcall]</span></div>
<div class="line left">
<span class="bold small">stringCopy: deststring from: start to: stop with: replacement from: rstart to: rstop<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["copies equal subranges from one string to another.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">works for BitBlt parameters up to 4096. maybe too much set up for short strings.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">currently, called by </span><span class="bold small">String copy:to:with:from:to:</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">width &larr; 1+stop-start.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">width = 0⇒ [⇑deststring]<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(start &gt; 4096 or⦂ rstart &gt; 4096) or⦂ width ≥ 4096⇒ [⇑false]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(width &lt; 0 or⦂ width ≠ (1+rstop-rstart)) or⦂ (<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(start &lt; 1 or⦂ stop &gt; deststring length) or⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(rstart &lt; 1 or⦂ rstop &gt; replacement length))⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user notify: &rsquo;illegal range or subscript&rsquo;]<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"self init."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">function &larr; color &larr; destraster &larr; desty &larr; sourceraster &larr; sourcey &larr; 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">sstrike &larr; dstrike &larr; false.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">height &larr; 1.<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">width &larr; width*8.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">destbase &larr; deststring lock. <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">destx &larr; (start - 1) * 8.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">sourcebase &larr; replacement lock.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">sourcex &larr; (rstart - 1) * 8.<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self callBLT.<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">replacement unlock.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"mark dirty"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">deststring◦1 &larr; deststring◦1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">deststring unlock.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑deststring<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">stringReplace: deststring with: sourcestring from: start to: stop and: replacement from: rstart to: rstop </span><span class="small">| slock [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"works for BitBlt parameters less than 4096. replaces a subrange of a string.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">called only by </span><span class="bold small">String replace:to:by:from:to:</span><span class="small">.  concatenates into deststring:<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">sourcestring◦(1 to: start-1)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">replacement◦(rstart to: rstop)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">sourcestring◦(stop+1 to: sourcestring length).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">assumes String arguments"<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">deststring length = 0⇒ [⇑deststring]<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(replacement is: String)≡false⇒[⇑false]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(stop ≥ 4096 or⦂ sourcestring length - stop ≥ 4096) or⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(start+rstop-rstart ≥ 4096 or⦂ rstart &gt; 4096)⇒ [⇑false]<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(start &lt; 1 or⦂ stop &gt; sourcestring length) or⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(rstart &lt; 1 or⦂ rstop &gt; replacement length)⇒ [user notify: &rsquo;illegal subscript&rsquo;]<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"self init."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">function &larr; color &larr; destraster &larr; desty &larr; sourceraster &larr; sourcey &larr; 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">sstrike &larr; dstrike &larr; false.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">height &larr; 1.<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">destbase &larr; deststring lock. <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">sourcebase &larr; slock &larr; sourcestring lock.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">width &larr; (start - 1) * 8.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[width = 0⇒ []<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">sourcex &larr; destx &larr; 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self callBLT].<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">destx &larr; width.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">width &larr; (1+rstop-rstart)*8.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[width = 0⇒ []<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">sourcex &larr; (rstart - 1) * 8.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">sourcebase &larr; replacement lock.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self callBLT.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">replacement unlock].<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">destx &larr; destx+ width.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">width &larr; (sourcestring length - stop) * 8.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[width = 0⇒ []<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">sourcebase &larr; slock.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">sourcex &larr; stop * 8.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self callBLT].<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">deststring◦1 &larr; deststring◦1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">sourcestring unlock. deststring unlock.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑deststring<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪BitBlt under: &rsquo;Primitive Access&rsquo;.</span></div>
<div class="line left">
<span class="small">BitBlt classInit</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"CoreLocs"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;CoreLocs&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: Array<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;base length&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;&rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>I am an array mapping a section of Alto memory</span></div>
<div class="line left">
<span class="bold large"><br>Initialization</span></div>
<div class="line left">
<span class="bold small">base: base length: length</span></div>
<div class="line left">
<span class="bold large"><br>Reading and Writing</span></div>
<div class="line left">
<span class="bold small">◦ x </span><span class="small">[x isLarge⇒[⇑self◦(x asSmall)] user croak] primitive: 42</span></div>
<div class="line left">
<span class="bold small">◦ x &larr; val </span><span class="small">[x isLarge⇒[⇑self◦(x asSmall) &larr; val] user croak] primitive: 43</span></div>
<div class="line left">
<span class="bold small">base </span><span class="small">[⇑base]</span></div>
<div class="line left">
<span class="bold small">length </span><span class="small">[⇑length]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪CoreLocs under: &rsquo;Primitive Access&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"VirtualMemory"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;VirtualMemory&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: Object<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;map "Pclass Map"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">premap "block before map"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">FirstContextOop "oop of FirstContext"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">SpecialOopsOop "oop of SpecialOops"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">zip  "Zone Index of Pages"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">prezip  "block before zip"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">zadd   "file info"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">vmemfile "file for vmem" &rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;ZHB RCI PIN zfused zfree zjmpt pmint num00 pmend ZN zflen pmatm zlong PCL ZVPN CPT BSC ISC ZJMP zend &rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>A model of the OOZE virtual memory</span></div>
<div class="line left">
<span class="bold large"><br>Pclass Map</span></div>
<div class="line left">
<span class="bold small">CPT: oop </span><span class="small">| poma<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[poma &larr; 2*(oop field: PCL) +1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑map◦poma field: CPT]</span></div>
<div class="line left">
<span class="bold small">freelist: object  </span><span class="small">| a<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"one-order index into freelists."</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">object class is: Class ⇒[⇑1]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">a &larr; self ISC: object asOop.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">a &lt; 024 ⇒[⇑1+a] ⇑1+ a-013]</span></div>
<div class="line left">
<span class="bold small">freelistOffset: len </span><span class="italic small">"offset of freelist for this length in a variable length class"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑Class instsize + [len &lt; 9 ⇒[len] (len-1) log2 + 6]]<br></span></div>
<div class="line left">
<span class="bold small">highpm0: oop gets: val </span><span class="small">| poma<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[premap◦pmatm &larr; premap◦pmatm min: (oop field: PIN &larr; 0).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">poma &larr; 2*(oop field: PCL) +1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">map◦poma &larr; val]</span></div>
<div class="line left">
<span class="bold small">highPM: oop </span><span class="small">| pcl a<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[pcl &larr; oop field: PCL.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">a &larr; premap◦pmatm field: PCL.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pcl &lt; a ⇒[⇑false]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑map◦(2*pcl +1)]</span></div>
<div class="line left">
<span class="bold small">ISC: oop </span><span class="small">| poma<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[poma &larr; 2*(oop field: PCL) +1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑map◦poma field: ISC]</span></div>
<div class="line left">
<span class="bold small">lowPM: oop </span><span class="small">| pcl a<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[pcl &larr; oop field: PCL.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">a &larr; premap◦pmend field: PCL.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pcl ≥ a ⇒[⇑false]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑map◦(2*pcl +1)]</span></div>
<div class="line left">
<span class="bold small">newHighPM&larr; pm0 </span><span class="small">| pcl a<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[a &larr; premap◦pmatm.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">premap◦pmatm &larr; (a &larr; a-0200).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pcl &larr; a field: PCL.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">map◦(2*pcl +1) &larr; pm0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑a]</span></div>
<div class="line left">
<span class="bold small">newLowPM&larr; pm0 </span><span class="small">| poma a<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[map◦1 = pm0 ⇒[</span><span class="italic small">"reserved pclasses for Class"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">map◦3 = 0 ⇒[map◦3 &larr; pm0. ⇑0200]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">map◦5 = 0 ⇒[map◦5 &larr; pm0. ⇑0400] ]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"normal case"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">a &larr; premap◦pmend.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">premap◦pmend &larr; a+0200.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">poma &larr; (a field: PCL) *2 +1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">map◦poma ≠ 0 ⇒[</span><span class="italic small">"skip over already filled"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑self newLowPM&larr; pm0]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">map◦poma &larr; pm0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑a]</span></div>
<div class="line left">
<span class="bold small">newZN: oop <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self ZN: oop gets: self newZone]</span></div>
<div class="line left">
<span class="bold small">pclassesOf: cls </span><span class="small">| i clsoop n z p </span><span class="italic small">"find pclasses of this class (in order of ZHB)"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"ignore small integers and nil"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">p &larr; (Vector new: 1) asStream.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">z &larr; (Vector new: 1) asStream.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">clsoop &larr; cls asOop.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i from: (1 to: 2*(0174000 field: PCL) by: 2) do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[map◦i = 0 ⇒[]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(map◦i field: RCI) = clsoop ⇒[p next&larr; i/2. z next&larr; (map◦(i+1) field: ZHB)]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">p &larr; p contents. z &larr; z contents.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">n &larr; p copy.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: z length do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[n◦(z◦i +1) &larr; p◦i].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑n]</span></div>
<div class="line left">
<span class="bold small">pclassesOf: cls length: len </span><span class="small">| i clsoop n z p isc pm0 </span><span class="italic small">"find pclasses of this class and length (in order of ZHB)"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"ignore small integers and nil"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">p &larr; (Vector new: 1) asStream.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">z &larr; (Vector new: 1) asStream.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">isc &larr; [len &lt; 9 ⇒[len] (len-1) log2 + 17].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">clsoop &larr; cls asOop.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i from: (1 to: 2*(0174000 field: PCL) by: 2) do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[(pm0 &larr; map◦i) = 0 ⇒[]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(pm0 field: RCI) ≠ clsoop ⇒[]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(pm0 field: ISC) = isc ⇒[p next&larr; i/2. z next&larr; (map◦(i+1) field: ZHB)]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">p &larr; p contents. z &larr; z contents.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">n &larr; p copy.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: z length do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[n◦(z◦i +1) &larr; p◦i].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑n]</span></div>
<div class="line left">
<span class="bold small">pmatm </span><span class="small">[⇑premap◦pmatm]</span></div>
<div class="line left">
<span class="bold small">ZHB: oop </span><span class="small">| poma<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[poma &larr; 2*(oop field: PCL) +1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑map◦(1+poma) field: ZHB]</span></div>
<div class="line left">
<span class="bold small">ZHB: oop gets: val </span><span class="small">| poma i<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[poma &larr; 2*(oop field: PCL) +1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">i &larr; map◦(1+poma).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">map◦(1+poma) &larr; (i field: ZHB &larr; val)]</span></div>
<div class="line left">
<span class="bold small">ZN: oop </span><span class="small">| poma<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[poma &larr; 2*(oop field: PCL) +1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑map◦(1+poma) field: ZN]</span></div>
<div class="line left">
<span class="bold small">ZN: oop gets: val </span><span class="small">| poma i<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[poma &larr; 2*(oop field: PCL) +1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">i &larr; map◦(1+poma).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">map◦(1+poma) &larr; (i field: ZN &larr; val)]</span></div>
<div class="line left">
<span class="bold large"><br>Writing and Reading</span></div>
<div class="line left">
<span class="bold small">obwiz: oop </span><span class="small">| poma pm0 pm1 isc bsc i len zz pin zhb<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"find (zn, zp, zw, dlen)"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">zz &larr; Vector new: 4.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">poma &larr; (oop field: PCL)*2 +1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(pm0 &larr; map◦poma) = 0 ⇒ [user notify: &rsquo;bad oop&rsquo;]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pm1 &larr; map◦(1+poma).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">isc &larr; pm0 field: ISC.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bsc &larr; pm0 field: BSC.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">zhb &larr; pm1 field: ZHB.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[isc &lt; 024 ⇒[len &larr; ((isc max: 1)+ 1-bsc) / (2-bsc)]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">len &larr; 8. i &larr; isc+bsc.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">until⦂ 024 = i do⦂ [i &larr; i-1. len &larr; len*2]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">len &larr; len+1 </span><span class="italic small">"length word"</span><span class="small"> ].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">zz◦4 &larr; len &larr; len+1. </span><span class="italic small">"dlen with refct"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"w &larr; (dlen*128*zhb) +dlen*pin"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pin &larr; oop field: PIN.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">zz◦2 </span><span class="italic small">"zp"</span><span class="small"> &larr; (zhb/2 *len) +(len/256 *pin).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">zz◦3 </span><span class="italic small">"zw"</span><span class="small"> &larr; (zhb\2 *128 *len) +(len\256 *pin).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">zhb\2 * len ≥ 512 ⇒[user notify: &rsquo;address overflow&rsquo;]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">zz◦2 </span><span class="italic small">"zp"</span><span class="small"> &larr; zz◦2 + (zz◦3 field: 136 </span><span class="italic small">"highbyte"</span><span class="small">).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">zz◦3 </span><span class="italic small">"zw"</span><span class="small"> &larr; zz◦3 field: 128 </span><span class="italic small">"lowbyte"</span><span class="small">.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">zz◦1 &larr; pm1 field: ZN.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑zz]</span></div>
<div class="line left">
<span class="bold small">readin: oop </span><span class="small">| zinfo<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[zinfo &larr; self obwiz: oop.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑self read: zinfo◦4 at: zinfo]</span></div>
<div class="line left">
<span class="bold small">systemNoHistory </span><span class="small">[] primitive: 82</span></div>
<div class="line left">
<span class="bold small">writeout: oop with: image </span><span class="small">| zinfo<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[zinfo &larr; self obwiz: oop.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[zinfo◦4 ≥ (image length /2) ⇒[]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user notify: &rsquo;bad image length&rsquo;].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self write: image at: zinfo<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold large"><br>Init</span></div>
<div class="line left">
<span class="bold small">AComment<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"VirtualMemory models the Pclass Map of Ooze.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">Vmem is one with CoreLocs on real system.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">(VirtualMemory new) thisvmem.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">Pmap is new one we are building.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">(VirtualMemory new) fakevmem.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">map is 1-order addressing.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">In init, set pmatm by searching PM for<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">highest 0. (No LMAT)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">map RCI field is old class oop. only convert to <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">new with mapPM at end.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">Atoms may not cover more than half of the<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">address space. (highpm0:gets:)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">(VirtualMemory new) giveBirth.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">Zone Index of Pages. works for both vector zip<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">and corelocs of real zip.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">zip, zadd are one-order.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">zfree is 1-order in fake, core addr in this.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">zlong = 512.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">zend is not used (0 fake, core addr in this) <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"</span><span class="small">]</span></div>
<div class="line left">
<span class="bold small">fakevmem: vmemfile<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"this instance is a model of a new vmem, which is built on another file"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self init.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">map &larr; Vector new: 1024.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">map all &larr; 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">premap &larr; (0176000, 0174000, 0, 0).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"num00, pmint, pmatm, pmend"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">prezip &larr; (3, 01244, 0). </span><span class="italic small">"zfree, zlong, zend"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">zip &larr; Vector new: prezip◦zlong.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">zip all &larr; 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">zadd &larr; (1, 1).  </span><span class="italic small">"zfused, zflen"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">vmemfile readwrite.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">Smalltalk define: ↪Pmap as: self]</span></div>
<div class="line left">
<span class="bold small">init  </span><span class="italic small">"common to both real and fake vmem"</span><span class="bold small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"field descriptors and indicies in tables"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">num00 &larr; 1. pmint &larr; 2. pmatm &larr; 3. pmend &larr; 4.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">RCI &larr; 151. CPT &larr; 22. BSC &larr; 21. ISC &larr; 80.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">ZHB &larr; 136. ZN &larr; 128. <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">PCL &larr; 151. PIN &larr; 112.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">ZJMP &larr; 76. ZVPN &larr; 16*12.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">zfree &larr; 1. zlong &larr; 2. zend &larr; 3.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">zfused &larr; 1. zflen &larr; 2.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">zjmpt &larr; (603, 570, 471, 410, 353, 300, 253, <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">210, 169, 132, 101, 72, 49, 30, 13)]</span></div>
<div class="line left">
<span class="bold small">premap </span><span class="small">[⇑premap] </span><span class="italic small">"array of limits in Pclass Map"</span></div>
<div class="line left">
<span class="bold small">thisvmem </span><span class="small">| c m "create Vmem, a VirtualMemory viewing this very system"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[c &larr; self specialLocs.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">map &larr; CoreLocs new base: c◦2 -1 length: 1025.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">premap &larr; CoreLocs new base: c◦2 -5 length: 5.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">Smalltalk define: ↪Vmem  as: self.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self init.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">m &larr; 1023.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">until⦂ (map◦m = 0) do⦂ [m &larr; m-2].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">premap◦pmatm &larr; (0 field: PCL &larr; m/2 +1).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">prezip &larr; CoreLocs new base: c◦3 -4 length: 4.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">zip &larr; CoreLocs new base: c◦3 -1 length: prezip◦zlong+1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">zadd &larr; CoreLocs new base: c◦12 -3 length: 3.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(vmemfile &larr; dp0 oldFile: &rsquo;small.boot&rsquo;) readonly.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">FirstContext &larr; Context new sender: nil <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">receiver: user<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">method: (m &larr; UserView md method: ↪restart) <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">tempframe: (Vector new: (m◦3 max: m◦4)) pc: m◦6<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">stackptr: m◦5 -1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">SpecialOops◦1 &larr; Object md method: ↪error.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">FirstContextOop &larr; FirstContext asOop.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">SpecialOopsOop &larr; SpecialOops asOop]</span></div>
<div class="line left">
<span class="bold large"><br>Vmem Writing</span></div>
<div class="line left">
<span class="bold small">afterBirth </span><span class="small">[MethodKeeperKeeper &larr; nil]</span></div>
<div class="line left">
<span class="bold small">giveBirth </span><span class="small">| pm0 vm </span><span class="italic small">"initialize map for early pclasses"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self preBirth.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"small Integer, 16 pclasses, oops 0174000-0177777"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pm0 &larr; Vmem highPM: 0176000. </span><span class="italic small">"size, class info for Integer"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">until⦂ (Pmap newHighPM&larr; pm0) = 0174000 do⦂ []. <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"first UniqueString"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(vm &larr; Vmapper new) object: (0173600 asObject); touchoop.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"Class oops 0-0177"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">vm object: Class; touchoop.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"more Class oops 0200-0577"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">Pmap newLowPM&larr; 0; newLowPM&larr; 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"VariableLengthClass oops 0600-0777"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">vm object: Vector; touchoop.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"skip over some oops"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">until⦂ (Pmap newLowPM&larr; 0) = 01600 do⦂ [].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"Object oops 02000-02177, false=02000"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(vm object: false) map ≠ 02000 ⇒[user notify: &rsquo;bad false oop&rsquo;]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"set pointer back to oops skipped over"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">Pmap premap ◦ pmend &larr; 01000<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">giveBirth2 </span><span class="small">| vm<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[vm &larr; Vmapper new.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">vm object: (Smalltalk ref: ↪FirstContext).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">FirstContextOop &larr; (vm readin word: 2). </span><span class="italic small">"new oop of FirstContext"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">vm reset; object: (Smalltalk ref: ↪SpecialOops).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">SpecialOopsOop &larr; (vm readin word: 2). </span><span class="italic small">"new oop of SpecialOops"</span><span class="small">]</span></div>
<div class="line left">
<span class="bold small">giveBirth3 </span><span class="small">| vm p [</span><span class="italic small">"create a new Small.boot<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">Write out all objects rooted at Smalltalk.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">Do not write the stack (rooted in R76, the current context).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">Pmap file close. Pmap &larr; nil.<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">*** Below is the commmand to start a Vmem write on a Dorado<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">(or Alto -- double disk O.S.).  edit and recompile the method if you don&rsquo;t<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">want to use old UniqueStrings, or if newsmall.boot, smalltalk.run,<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">smalltalk.syms, byterp.mb are not located on dp0i,<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">i.e. dp1 oldFile: &rsquo;small.boot&rsquo; instead of dp0 oldFile: &rsquo;newsmall.boot&rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">also delete rename: commands at the end.<br></span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user displayoffwhile⦂ [(VirtualMemory new) giveBirth3]. user quit.<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">***"<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user releaseExternalViews.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[E≡nil⇒ [] E kill].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">Flushed&larr; false.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(Vmapper new) init; UseOldUniqueStrings: true.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user show: &rsquo;init &rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(VirtualMemory new) thisvmem.  </span><span class="italic small">"define Vmem, Pmap"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(VirtualMemory new) fakevmem: (dp0 oldFile: &rsquo;newsmall.boot&rsquo;).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self giveBirth.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">vm &larr; Vmapper new.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user show: &rsquo;run &rsquo;. vm object: Smalltalk; map.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user show: &rsquo;USTable &rsquo;. vm arefsRectify.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user show: &rsquo;freelist &rsquo;. vm writefreelists.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user show: &rsquo;mrefs &rsquo;. vm mrefsRectify.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user show: &rsquo;PM &rsquo;. Pmap mapPM; giveBirth2.<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">These work as many times as needed on dp0 or dp1</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user show: &rsquo;surgery &rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">Pmap surgery: (dp0 oldFile: &rsquo;Smalltalk.Run&rsquo;).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user show: &rsquo;ram &rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">Pmap ramwrite: (dp0 oldFile: &rsquo;Byterp.Mb&rsquo;).<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">adjust size of new file</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">p &larr; Pmap pagesUsed + 264 "</span><span class="italic small">boot & ram</span><span class="small">" + 250 "</span><span class="italic small">extra</span><span class="small">".<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user show: &rsquo;pages reclaimed &rsquo;; print: (Pmap file) file lastPage - p.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(Pmap file) readwriteshorten; settopage: p char: 0; close; readwrite.<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"rename files so that new file is small.boot"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(Vmem file) file rename: &rsquo;oldsmall.boot&rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(Pmap file) file rename: &rsquo;small.boot&rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">mapPM </span><span class="small">| c i v rci ctrans  </span><span class="italic small">"convert to new RCI"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ctrans &larr; (Vmapper new) classtrans.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ c from: (1 to: 1023 by: 2) do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[(i &larr; map◦c) = 0 ⇒[]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">rci &larr; i field: RCI.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(v &larr; ctrans lookup: rci) ⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[map◦c &larr; (i field: RCI &larr; v◦1)]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user notify: &rsquo;class not mapped&rsquo;]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">preBirth </span><span class="small">| v<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[MethodKeeperKeeper &larr; MessageDict new.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">MethodKeeperKeeper init: (v &larr; MethodKeeper contents) length *2; holdMethods: v]</span></div>
<div class="line left">
<span class="bold small">ramwrite: source </span><span class="small">| s </span><span class="italic small">"write 8 pages of ram image into small.boot</span><span class="small">" [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s &larr; source name.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">source readonly.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[source directory ≡ dp0 ⇒[]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(dp0 file: s) append: source; close "</span><span class="italic small">copy onto dp0</span><span class="small">"].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">source close.<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">cleanup vmem file before quit</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">vmemfile close.<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">go out to OS, packram, and come back</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s &larr; s◦(1 to: s length-4) concat: &rsquo;.br.&rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user quitThen: [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(Stream default) append: &rsquo;Packmu &rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">append: source name; space; append: s;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">append: &rsquo;; Resume &rsquo;; append: Vmem file name;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">contents].  <br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">skip .br stuff and constants</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(s &larr; dp0 oldFile: s) readonly; skipwords: 0421.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">now write in ram image (8 pages of 512)</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">vmemfile settopage: 0400 char: 0; readwrite; next: 4096 from: s.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s close.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self ≡ Vmem ⇒[vmemfile readonly "</span><span class="italic small">does flush</span><span class="small">"]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">vmemfile flush]</span></div>
<div class="line left">
<span class="bold large"><br>Surgery</span></div>
<div class="line left">
<span class="bold small">dynaLocs: guide </span><span class="small">| l locs keys v i "Surgery - add core location and value pairs to guide dictionary to test after flush"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[l &larr; self specialLocs.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">locs &larr; (premap base +pmend, (l◦11 -1), (l◦12 -2), (l◦4 +1)).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">keys &larr; (↪premaptest, ↪purgetest, ↪zaddtest, ↪loxtest).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i from: 1 to: keys length do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[v &larr; locs◦i, (mem◦(locs◦i)).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">guide insert: keys◦i with: v].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(guide lookup: ↪loxtest)◦2 &larr; ¬1]</span></div>
<div class="line left">
<span class="bold small">runLocs: f </span><span class="small">| guide i v locs keys offsets "Surgery - create dictionary of locations of key system tables in Smalltalk.run"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[i &larr; f name.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(v &larr; f directory oldFile: (i◦(1 to: i length-5) concat: &rsquo;.syms.&rsquo;)) readonly.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">locs &larr; self symsFind: (&rsquo;PMBASE&rsquo;, &rsquo;ZIP&rsquo;, &rsquo;ZADD&rsquo;, &rsquo;INITIALIZE&rsquo;, &rsquo;OOZIN&rsquo;, &rsquo;SAFID&rsquo;) on: v.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">v close.<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">keys &larr; ↪(maprun ziprun zaddrun initrun zfps safid).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">offsets &larr; ↪(¬1 ¬1 ¬3 ¬3 ¬2 ¬1). "words offset"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">guide &larr; Dictionary new init: 16.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i from: 1 to: locs length do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[v &larr; (locs◦i lshift: ¬8), ((locs◦i land: 0377) -19 *2). "page, byte"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"magic fudge factor of 19 words for .run file"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">v◦2 &larr; v◦2 +(offsets◦i *2). "bytes offset"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">guide insert: keys◦i with: v].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">v &larr; (guide lookup: ↪maprun) copy.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">v◦2 &larr; v◦2 +(¬4 *2).  "offset ¬5 total"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">guide insert: ↪premaprun with: v.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">v &larr; (guide lookup: ↪ziprun) copy.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">v◦2 &larr; v◦2 +(¬3 *2).  "offset ¬4 total"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">guide insert: ↪preziprun with: v.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑guide]</span></div>
<div class="line left">
<span class="bold small">specialLocs </span><span class="small">[] primitive: 84<br>"returns a vector containing the core addresses of:<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">1 ROTBASE (the Resident Object Table)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">2 PMBASE (the Pclass Map)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">3 ZIP (the Zone Index of Pages)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">4 LOX (the table of LOcked objeX)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">5 FULL (loc of lowest addr used for resident data)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">6 ULIM (loc of highest addr used for resident data)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">7 ZFPT (the zone file Page Table)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">8 OVTAB (the Table of OVerflow ref counts)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">9 PURGE (a code label)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">10 DISPGLBS (Table of Display Globals)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">11 BACPUR (a code label)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">12 ZADD (.-2 has #pages req&rsquo;d, .-1 has #pages in boot file; add 264 for real file length)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">13 SAFID (loc of file id (5-word block) for the .boot file)<br>"</span></div>
<div class="line left">
<span class="bold small">staticTest: guide on: f </span><span class="small">| l locs offsets values names i v "Surgery - test known static constants in thisvmem and in smalltalk.run"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[offsets &larr; (pmint, 2, 0, 0).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">values &larr; (0174000, 01244, 96, 031415).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">names &larr; (↪premaprun, ↪preziprun, ↪zaddrun, ↪initrun).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: names length do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[v &larr; guide lookup: names◦i.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">f settopage: v◦1 char: v◦2 +(offsets◦i *2).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">f nextword ≠ (values◦i)⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[user notify: &rsquo;bad .run loc&rsquo;]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self ≡ Vmem ⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[l &larr; self specialLocs.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">offsets◦4 &larr; 0.  values◦4 &larr; 014764.</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">locs &larr; (premap base, prezip base, zadd base, (l◦11) "bacpur").<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i from: 1 to: locs length do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[values◦i ≠ (mem◦(locs◦i +(offsets◦i)))⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[user notify: &rsquo;bad system loc&rsquo;]]]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">surgery: f </span><span class="small">| guide Etemp i v keys [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">write virtual memory tables into Smalltalk.run using Smalltalk.syms.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user displayoffwhile⦂ [Vmem ramwrite: (dp0 oldFile: &rsquo;byterp.mb&rsquo;)].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user displayoffwhile⦂ [Vmem surgery: (dp0 oldFile: &rsquo;Smalltalk.run&rsquo;)]. "<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">vmemfile close.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user releaseExternalViews.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[E ≡ nil ⇒[] E kill].<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self ≡ Vmem ⇒[self thisvmem.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">Flushed &larr; true. Etemp &larr; Events]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">f readwrite.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">guide &larr; self runLocs: f.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self staticTest: guide on: f.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self ≡ Vmem ⇒[user clearshow: &rsquo;Wait for the safe light to flash, then hit any key&rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">until⦂ user kbck do⦂ []. user kbd.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self dynaLocs: guide.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user clearshow: &rsquo;Dont forget user systemStartup. in the new system to enable interrupts and get the display set up. &rsquo;.<br>]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self tablewrt: guide on: f. "</span><span class="italic small">write in Smalltalk.run</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">f close.<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self ≡ Vmem ⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[keys &larr; (↪premaptest, ↪purgetest, ↪zaddtest, ↪loxtest).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: keys length do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[v &larr; guide lookup: keys◦i.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">v◦2 ≠ (mem◦(v◦1))⇒[user notify: &rsquo;please surgery again&rsquo;]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">Events &larr; nil. self systemVmemOut.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">Events &larr; Etemp.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">vmemfile close.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user quit]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">symsFind: strs on: f1 </span><span class="small">| f2 S N L offset val str j i "find initial values of SRELs in smalltalk.syms"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["S is start of string space (words)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">N is start of symbol table "<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(f2 &larr; f1 directory oldFile: f1 name) readonly.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">f1 wordposition &larr; 2.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">S &larr; f1 nextword.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">N &larr; f1 nextword.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">f1 wordposition &larr; N.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">L &larr; f1 nextword.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: L do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[offset &larr; f1 nextword. "next offset"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">f1 skip: 4.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">val &larr; f1 nextword.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">f2 wordposition &larr; S+offset.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">str &larr; f2 next: f2 next.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ j to: strs length do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[(strs◦j) class ≡ String ⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[strs◦j = str ⇒[strs◦j &larr; val]]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">f2 close.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ j to: strs length do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[(strs◦j) class ≡ String ⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[user notify: &rsquo;symbol not found&rsquo;]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑strs]</span></div>
<div class="line left">
<span class="bold small">systemVmemOut </span><span class="small">[] primitive: 83</span></div>
<div class="line left">
<span class="bold small">tablewrt: guide on: f </span><span class="small">| i v vfile "copy tables from self to .run file"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[v &larr; guide lookup: ↪premaprun.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">f settopage: v◦1 char: v◦2 +(2*pmatm).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">f nextword&larr; premap◦pmatm.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">f nextword&larr; premap◦pmend.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: 1024 do⦂ [f nextword&larr; map◦i].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">v &larr; guide lookup: ↪preziprun.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">f settopage: v◦1 char: v◦2 +(2*1 "zfree").<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">i &larr; [self ≡ Vmem ⇒ [¬1-zip base "relative indexing"]¬1 "</span><span class="italic small">make 0-order"</span><span class="small">] .</span><span class="italic small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">f nextword&larr; prezip ◦1 +i. "zfree"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">v &larr; guide lookup: ↪zaddrun.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">f settopage: v◦1 char: v◦2 +(2*1 "zfused").<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">f nextword&larr; zadd ◦1. </span><span class="italic small">" zfused "</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">v &larr; guide lookup: ↪ziprun.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">f settopage: v◦1 char: v◦2 +(2*1).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: prezip◦zlong do⦂ [f nextword&larr; zip◦i]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">v &larr; guide lookup: ↪initrun.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">f settopage: v◦1 char: v◦2 +(2*1 "SpecialOops").<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">f nextword&larr; SpecialOopsOop.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">f nextword&larr; FirstContextOop.<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"disk address of start of virtual memory"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">vfile &larr; vmemfile file.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">v &larr; guide lookup: ↪zfps.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">f settopage: v◦1 char: v◦2 +(2*1).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">f nextword&larr; (vfile read: 0410) address.<br></span><span class="bold small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"swat file id of vmem file"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">v &larr; guide lookup: ↪safid.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">f settopage: v◦1 char: v◦2 + (2*1).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">f append: vfile serialNumber; skip: 4; nextword &larr; (vfile read: 1) address.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold large"><br>Zone Pages</span></div>
<div class="line left">
<span class="bold small">cover: zz </span><span class="small">| pp zrp lpir zjmp vpn olpir<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[pp &larr; zz◦2 + 1. "zp 1-order"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">lpir &larr; 1. olpir &larr; 0. zrp &larr; zz◦1 *2 +1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">until⦂ lpir ≥ pp do⦂ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">0 = (zjmp &larr; zip◦zrp field: ZJMP) ⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self run: [lpir ≥ 32 ⇒[32] lpir +1] after: zrp.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self cover: zz]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">zrp &larr; (zjmpt◦zjmp + zrp -1)\ (prezip◦zlong) +1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">olpir &larr; lpir.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">lpir &larr; lpir + [lpir ≥ 32 ⇒[32] lpir +1] ].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">vpn &larr; (zip◦zrp field: ZVPN) +pp -(olpir +1).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">0 = vpn ⇒[user notify: &rsquo;pclass has no zone&rsquo;]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">vpn &larr; vpn + 0407.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">vmemfile settopage: vpn char: zz◦3 *2]</span></div>
<div class="line left">
<span class="bold small">file </span><span class="small">[⇑vmemfile]</span></div>
<div class="line left">
<span class="bold small">getpages: i </span><span class="small">| vpn<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[[zadd◦zflen &lt; (zadd◦zfused + i) ⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[zadd◦zflen &larr; zadd◦zflen + (i max: 20).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">vmemfile settopage: zadd◦zflen + 0407 char: 0]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">vpn &larr; zadd◦zfused.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">zadd◦zfused &larr; vpn+i.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑vpn]</span></div>
<div class="line left">
<span class="bold small">newZone </span><span class="small">| zrp<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[zip is: Vector ⇒[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">zrp &larr; prezip◦zfree.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">until⦂ zip◦zrp = 0 do⦂ [zrp &gt; (prezip◦zlong) ⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[user notify: &rsquo;zip overflow&rsquo;]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">zrp &larr; zrp+2].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">prezip◦zfree &larr; 2+zrp.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">zip◦zrp &larr; self getpages: 1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑zrp/2]]</span></div>
<div class="line left">
<span class="bold small">pagesUsed </span><span class="small">[⇑zadd◦zfused]</span></div>
<div class="line left">
<span class="bold small">read: len at: zz </span><span class="small">| i str<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[i &larr; 256 - (zz◦3) "zw" min: len.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self cover: zz.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">str &larr; vmemfile next: 2*i.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">i=len ⇒[⇑str]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">zz◦2 &larr; zz◦2 +1. "zp"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">zz◦3 &larr; 0. "zw"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑str concat: (self read: len-i at: zz)]</span></div>
<div class="line left">
<span class="bold small">run: n after: zrp </span><span class="small">| i j<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[for⦂ i to: 15 do⦂ <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[j &larr; zjmpt◦i +zrp -1 \ (prezip◦zlong) +1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">zip◦j = 0 ⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[zip◦zrp &larr; zip◦zrp field: ZJMP &larr; i.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">zip◦j &larr; self getpages: n. ⇑zrp]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user notify: &rsquo;new zip is full&rsquo;]</span></div>
<div class="line left">
<span class="bold small">write: str at: zz </span><span class="small">| i len<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[len &larr; str length /2.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">i &larr; 256 - (zz◦3) "zw" min: len.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">i = len ⇒[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self cover: zz.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">vmemfile append: str]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self write: str from: 1 at: zz]</span></div>
<div class="line left">
<span class="bold small">write: str from: pos at: zz </span><span class="small">| i len<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[len &larr; str length +1 -pos.  "bytes yet to write"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">i &larr; len min: (256 - (zz◦3) "zw")*2.  "bytes in page"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self cover: zz.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">vmemfile append: str◦(pos to: i+pos-1).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">i=len ⇒[]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">zz◦2 &larr; zz◦2 +1. "zp"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">zz◦3 &larr; 0. "zw"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self write: str from: i+pos at: zz]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪VirtualMemory under: &rsquo;Primitive Access&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"Vmapper"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;Vmapper&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: Object<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;object oop noop image&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;classtrans PCL mapqueue clamp stopcount USTableOop mrefs arefs count UseOldUniqueStrings &rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>This class has not yet been commented</span></div>
<div class="line left">
<span class="bold large"><br>Mapping</span></div>
<div class="line left">
<span class="bold small">map </span><span class="small">| i<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[(i &larr; mrefs lookup: oop) ⇒[i◦1 &larr; i◦1 -1. ⇑i◦2]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[user kbck ⇒ [user kbd; ev] self bump].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">object class = Integer ⇒[⇑self mapInteger];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">= UniqueString ⇒[⇑self mapUniqueString];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">= Vector ⇒[⇑self mapVector];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">= Float ⇒[⇑self mapFloat];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">= MessageDict ⇒[⇑self mapMdict]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">object Is: HashSet ⇒[⇑self mapHashSet]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">object Is: String ⇒[⇑self mapString]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">object class = Class ⇒[⇑self mapClass];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">= VariableLengthClass ⇒[⇑self mapClass];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">= Vmapper ⇒[⇑¬1]; </span><span class="italic small">"avoid recursion in writing"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">= VirtualMemory ⇒[⇑self mapVmem]; </span><span class="italic small">"avoid recursion in writing"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"put any fixed octave class here"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">= Object ⇒[⇑self mapObject]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑self mapNormal]</span></div>
<div class="line left">
<span class="bold small">mapClass </span><span class="small">| nlen oadd i refs vm j<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[clamp find: object ⇒[⇑¬1 "don&rsquo;t write this class"]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nlen &larr; 1 + object class instsize. </span><span class="italic small">"refct + normal fields"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">i &larr; [object is: Class ⇒[oadd &larr; 0. 1] oadd &larr; 1. 20].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">noop &larr; self newoop.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[(vm &larr; classtrans lookup: oop) ⇒[vm◦1 &larr; noop]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">vm &larr; Vector new: i+1. vm◦1 &larr; noop.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">classtrans insert: oop with: vm].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nlen &larr; nlen + i + oadd.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">image &larr; String new: 2*nlen.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[(refs &larr; object refct) = 2 ⇒[</span><span class="italic small">"exactly one reference"</span><span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">mrefs insert: oop with: (refs-2, noop)].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">image word: 1 &larr; refs -2.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[oadd=1 ⇒[image word: 2 &larr; nlen-2]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ j from: (2+oadd to: nlen-i) do⦂ <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[vm &larr; Vmapper new object: (object instfield: j-1-oadd).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">image word: j &larr; vm map].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self writeout.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑noop]</span></div>
<div class="line left">
<span class="bold small">mapFloat </span><span class="small">| refs i<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[image &larr; String new: 8.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">noop &larr; self newoop.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[(refs &larr; object refct) = 2 ⇒[</span><span class="italic small">"exactly one reference"</span><span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">mrefs insert: oop with: (refs-2, noop)].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">image word: 1 &larr; refs-2.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: 3 do⦂ [image word: (i+1) &larr; object instfield: i].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self writeout.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑noop]</span></div>
<div class="line left">
<span class="bold small">mapHashObs  </span><span class="small">| nlen oadd i refs vm trans ob<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[nlen &larr; object length. </span><span class="italic small">"in words"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">oadd &larr; [nlen≤8⇒[0]1].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nlen &larr; oadd +1 +nlen.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">image &larr; String new: 2*nlen.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[(refs &larr; object refct) = 2 </span><span class="italic small">"exactly one ref"</span><span class="small"> ⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[noop &larr; self newoop]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(i &larr; mrefs lookup: oop) ⇒[i◦1 &larr; i◦1 -1. noop &larr; i◦2]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">noop &larr; self newoop.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">mrefs insert: oop with: (refs-2, noop)].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">image word: 1 &larr; refs -2.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[oadd=1⇒[image word: 2 &larr; object length]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">ob &larr; (trans &larr; self permHashSet) objects.  </span><span class="italic small">"translation dictionary"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i from: (2+oadd to: nlen) do⦂ <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[vm &larr; ob◦(i-1-oadd).  </span><span class="italic small">"integer noops"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">vm ≡ nil ⇒[] image word: i &larr; vm].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self writeout.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑noop, trans values]</span></div>
<div class="line left">
<span class="bold small">mapHashSet </span><span class="small">| nlen i refs vm perm  </span><span class="italic small">"all subclass on HashSet except Mdict"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[mrefs asOop = oop ⇒[⇑¬1] </span><span class="italic small">"do not map"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">arefs asOop = oop ⇒[⇑¬1] </span><span class="italic small">"do not map"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nlen &larr; 1 + (object class instsize). </span><span class="italic small">"refct + fields"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">image &larr; String new: 2*nlen.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">noop &larr; self newoop.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[(refs &larr; object refct) = 2 ⇒[</span><span class="italic small">"exactly one reference"</span><span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">mrefs insert: oop with: (refs-2, noop)].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">image word: 1 &larr; refs -2.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">vm &larr; Vmapper new object: (object instfield: 1).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">i &larr; vm mapHashObs.  </span><span class="italic small">"(oop, perm)"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">image word: 2 &larr; i◦1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">perm &larr; i◦2.  </span><span class="italic small">"permutation of other parts"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i from: (3 to: nlen) do⦂ <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[vm &larr; Vmapper new object: (object instfield: i-1).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">image word: i &larr; (vm mapHashVals: perm)].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self writeout.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑noop]</span></div>
<div class="line left">
<span class="bold small">mapHashVals: perm </span><span class="small">| nlen oadd i refs vm  </span><span class="italic small">"values vec of dictionary"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[oop = ¬1 ⇒[⇑¬1]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nlen &larr; object length. </span><span class="italic small">"in words"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">oadd &larr; [nlen≤8⇒[0]1].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nlen &larr; oadd +1 +nlen.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">image &larr; String new: 2*nlen.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[(refs &larr; object refct) = 2 </span><span class="italic small">"exactly one ref"</span><span class="small"> ⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[noop &larr; self newoop]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(i &larr; mrefs lookup: oop) ⇒[i◦1 &larr; i◦1 -1. noop &larr; i◦2]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">noop &larr; self newoop.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">mrefs insert: oop with: (refs-2, noop)].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">image word: 1 &larr; refs -2.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[oadd=1⇒[image word: 2 &larr; object length]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">object &larr; object◦perm.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i from: (2+oadd to: nlen) do⦂ <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[(vm &larr; Vmapper new) object: object◦ (i-1-oadd).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">image word: i &larr; vm map].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self writeout.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑noop]</span></div>
<div class="line left">
<span class="bold small">mapInteger </span><span class="small">| refs<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[¬02000 ≤ object and: object &lt; 01777 ⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑oop </span><span class="italic small">"small integer"</span><span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">image &larr; String new: 4.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">noop &larr; self newoop.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[(refs &larr; object refct) = 2 ⇒[</span><span class="italic small">"exactly one reference"</span><span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">mrefs insert: oop with: (refs-2, noop)].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">image word: 1 &larr; refs-2.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">image word: 2 &larr; object.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self writeout.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑noop]</span></div>
<div class="line left">
<span class="bold small">mapMdict </span><span class="small">| i refs vm perm  </span><span class="italic small">" maps MessageDict instance "</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[image &larr; String new: 12.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">noop &larr; self newoop.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[(refs &larr; object refct) = 2 ⇒[</span><span class="italic small">"exactly one reference"</span><span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">mrefs insert: oop with: (refs-2, noop)].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">image word: 1 &larr; refs -2.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(vm &larr; Vmapper new) object: (object instfield: 1).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">i &larr; vm mapHashObs.  </span><span class="italic small">"(oop, perm)"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">image word: 2 &larr; i◦1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">perm &larr; i◦2.  </span><span class="italic small">"permutation of other parts"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i from: (3 to: 6) do⦂ <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[(vm &larr; Vmapper new) object: (object instfield: i-1).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">i = 3 ⇒[image word: 3 &larr; (vm mapMethodVec: perm)]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">image word: i &larr; (vm mapHashVals: perm)].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self writeout.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑noop]</span></div>
<div class="line left">
<span class="bold small">mapMethod </span><span class="small">| nlen oadd refs i a vm b<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[oop = ¬1 ⇒[⇑¬1]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nlen &larr; object length. </span><span class="italic small">"in bytes!!"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">oadd &larr; [nlen≤8⇒[0]1].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nlen &larr; 2*oadd +2 +nlen.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">image &larr; String new: nlen+1 |2.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[(refs &larr; object refct) = 2 </span><span class="italic small">"exactly one ref"</span><span class="small"> ⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[noop &larr; self newoop]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(i &larr; mrefs lookup: oop) ⇒[i◦1 &larr; i◦1 -1. noop &larr; i◦2]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">noop &larr; self newoop.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">mrefs insert: oop with: (refs-2, noop)].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">image word: 1 &larr; refs -2.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[oadd=1⇒[image word: 2 &larr; object length]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[nlen ≤ 8 or⦂ object◦6 = 6 ⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[image◦(2*oadd +3 to: nlen) &larr; object]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">a &larr; 2*oadd +3. b &larr; object◦6.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">image◦(a to: a+5) &larr; object◦(1 to: 6).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i from: (4 to: b /2) do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[(vm &larr; Vmapper new) object: (object word: i) asObject.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">image word: (i+1+oadd) &larr; vm map].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">image◦(a+b to: nlen) &larr; object◦(b+1 to: object length)].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self writeout.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑noop]</span></div>
<div class="line left">
<span class="bold small">mapMethodVec: perm </span><span class="small">| nlen oadd i refs vm<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[oop = ¬1 ⇒[⇑¬1]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nlen &larr; object length. </span><span class="italic small">"in words"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">oadd &larr; [nlen≤8⇒[0]1].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nlen &larr; oadd +1 +nlen.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">image &larr; String new: 2*nlen.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[(refs &larr; object refct) = 2 </span><span class="italic small">"exactly one ref"</span><span class="small"> ⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[noop &larr; self newoop]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(i &larr; mrefs lookup: oop) ⇒[i◦1 &larr; i◦1 -1. noop &larr; i◦2]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">noop &larr; self newoop.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">mrefs insert: oop with: (refs-2, noop)].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">image word: 1 &larr; refs -2.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[oadd=1⇒[image word: 2 &larr; object length]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">object &larr; object◦perm.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i from: (2+oadd to: nlen) do⦂ <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[(vm &larr; Vmapper new) object: object◦ (i-1-oadd).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">image word: i &larr; vm mapMethod].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self writeout.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑noop]</span></div>
<div class="line left">
<span class="bold small">mapNormal </span><span class="small">| nlen i refs vm oadd </span><span class="italic small">"all fixed, pointer type classes"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[clamp find: object class ⇒[⇑¬1 "don&rsquo;t write the instance"]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nlen &larr; object class instsize.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">oadd &larr; [nlen≤19⇒[0]1].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nlen &larr; oadd+1 +nlen.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">image &larr; String new: 2*nlen.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">noop &larr; self newoop.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[(refs &larr; object refct) = 2 ⇒[</span><span class="italic small">"exactly one reference"</span><span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">mrefs insert: oop with: (refs-2, noop)].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">image word: 1 &larr; refs-2.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[oadd=1⇒[image word: 2 &larr; nlen-oadd-1]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i from: (2+oadd to: nlen) do⦂ <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[vm &larr; Vmapper new object: (object instfield: i-oadd-1).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">image word: i &larr; vm map].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self writeout.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑noop]</span></div>
<div class="line left">
<span class="bold small">mapObject </span><span class="small">| refs  </span><span class="italic small">"nil, false, true"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[object≡nil ⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[mrefs insert: ¬1 with: (500, ¬1). </span><span class="italic small">"for speed of<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">catching nil. watch out on cleanup"</span><span class="small"> ⇑¬1]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">image &larr; String new: 4.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">noop &larr; self newoop.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">noop\128&gt;1 ⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[user notify: &rsquo;Unidentified flying Object&rsquo;]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[(refs &larr; object refct) = 2 ⇒[</span><span class="italic small">"exactly one reference"</span><span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">mrefs insert: oop with: (refs-2, noop)].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">image word: 1 &larr; refs -2.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self writeout.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑noop]</span></div>
<div class="line left">
<span class="bold small">mapString </span><span class="small">| nlen oadd refs<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[nlen &larr; object length. </span><span class="italic small">"in bytes!!"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">oadd &larr; [nlen≤8⇒[0]1].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nlen &larr; 2*oadd +2 +nlen.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">image &larr; String new: nlen+1 |2.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">noop &larr; self newoop.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[(refs &larr; object refct) = 2 ⇒[</span><span class="italic small">"exactly one reference"</span><span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">mrefs insert: oop with: (refs-2, noop)].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">image word: 1 &larr; refs -2.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[oadd=1⇒[image word: 2 &larr; object length]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">image◦((2*oadd +3) to: nlen) &larr; object.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self writeout.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑noop]</span></div>
<div class="line left">
<span class="bold small">mapUniqueString </span><span class="small">| nlen oadd refs<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[[UseOldUniqueStrings ⇒[self UniStroop. noop &larr; oop]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(refs &larr; arefs lookup: oop) ⇒[⇑refs]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">noop &larr; self newoop.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">arefs insert: oop with: noop].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nlen &larr; object length. </span><span class="italic small">"in bytes!!"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">oadd &larr; [nlen≤8⇒[0]1].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nlen &larr; 2*oadd +2 +nlen.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">image &larr; String new: nlen+1 |2.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">image word: 1 &larr; 1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[oadd=1⇒[image word: 2 &larr; object length]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">image◦((2*oadd +3) to: nlen) &larr; object.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self writeout.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑noop]</span></div>
<div class="line left">
<span class="bold small">mapVector </span><span class="small">| nlen oadd i refs vm<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[[UseOldUniqueStrings ⇒[] USTableOop = oop ⇒[⇑¬1]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"do not map since new atom Oops"</span><span class="small">]. <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nlen &larr; object length. </span><span class="italic small">"in words"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">oadd &larr; [nlen≤8⇒[0]1].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nlen &larr; oadd +1 +nlen.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">image &larr; String new: 2*nlen.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">noop &larr; self newoop.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[(refs &larr; object refct) = 2 ⇒[</span><span class="italic small">"exactly one reference"</span><span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">mrefs insert: oop with: (refs-2, noop)].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">image word: 1 &larr; refs-2.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[oadd=1⇒[image word: 2 &larr; object length]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i from: (2+oadd to: nlen) do⦂ <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[vm &larr; Vmapper new object: (object◦ (i-1-oadd)).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">image word: i &larr; vm map].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self writeout.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑noop]</span></div>
<div class="line left">
<span class="bold small">mapVmem </span><span class="small">| nlen i refs vm  "VirtualMemory, Vmem and Pmap"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[nlen &larr; 1 + (object class instsize). "refct + fields"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">image &larr; String new: 2*nlen.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">noop &larr; self newoop.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[(refs &larr; object refct) = 2 ⇒["exactly one reference"]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">mrefs insert: oop with: (refs-2, noop)].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">image word: 1 &larr; refs -2.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i from: (2 to: nlen) do⦂ <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[image word: i &larr; ¬1]. "Vmem needed for purgealittle"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self writeout.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑noop]</span></div>
<div class="line left">
<span class="bold small">permHashSet </span><span class="small">| ob i bb nili vm   </span><span class="italic small">"gets new atoms, returns dict of objects and permutation"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[bb &larr; Dictionary new init: object length.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">i &larr; 1. while⦂ (object◦i ≡ nil and: i ≠ object length) do⦂ [i &larr; i+1].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[((object◦i) class) ≡ Integer ⇒[false]; ≡ String ⇒[false] true] ⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[for⦂ i to: object length do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[object◦i ≡ nil ⇒[nili &larr; i]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">vm &larr; Vmapper new object: object◦i.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bb insert: vm map with: i].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">ob &larr; bb values.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: ob length do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ob◦i ≡ nil ⇒[ob◦i &larr; nili] ].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑bb]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">ob &larr; bb objects.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: ob length do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[vm &larr; Vmapper new object: object◦i.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">ob◦i &larr; vm map].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">ob &larr; bb values.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: ob length do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ob◦i &larr; i].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑bb]</span></div>
<div class="line left">
<span class="bold large"><br>Writing Out</span></div>
<div class="line left">
<span class="bold small">method: sel </span><span class="small">| v str a j i   </span><span class="italic small">"object is a class. find this method and construct vmapper"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[(v &larr; classtrans lookup: oop) ≡ false ⇒[user notify: &rsquo;object not a class&rsquo;]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">str &larr; Pmap readin: v◦1. </span><span class="italic small">"class image"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">i &larr; Pmap readin: (str word: 1+4+(oop/0200)). </span><span class="italic small">"mdict image"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">str &larr; Pmap readin: (i word: 1+1). </span><span class="italic small">"objects vector image"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">a &larr; String new: 2. a word: 1 &larr; sel asOop. </span><span class="italic small">"selector"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">j &larr; str find: a◦2. <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">a◦1 ≠ (str◦(j-1)) ⇒[user notify: &rsquo;can not find&rsquo;]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">i &larr; Pmap readin: (i word: 1+2). </span><span class="italic small">"methods vector image"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">v &larr; Vmapper new object: (object md method: sel).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">v noop: (i word: (j/2)). v readin.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑v]</span></div>
<div class="line left">
<span class="bold small">newoop </span><span class="small">| v a i indx o </span><span class="italic small">"see if classtrans can help find new oop"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[(v &larr; classtrans lookup: (i &larr; object class) asOop) ⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[indx &larr; 1 + (Vmem freelist: object).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> [i ≡ Class ⇒[oop ≤ 027 ⇒[⇑oop] </span><span class="italic small">"touchoop set it up"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">v◦indx ≤ 027 ⇒[v◦indx &larr; 027+1] ];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">≡ VariableLengthClass ⇒[o &larr; v◦indx. </span><span class="italic small">"in case pclass changes"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">v◦indx &larr; o max: o|128 +(oop\128) +1. <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ o|128 +(oop\128)] ].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">a &larr; self nextfree: v◦indx.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">v◦indx &larr; a◦2. ⇑a◦1]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> a &larr; [i is: Class ⇒[1] 20].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> v &larr; Vector new: a+1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> classtrans insert: (object class) asOop with: v.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> ⇑self newoop]</span></div>
<div class="line left">
<span class="bold small">newpcl: n </span><span class="small">| a pm0<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"object class = Foo ⇒[an exception]"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pm0 &larr; Vmem lowPM: oop.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">a &larr; [pm0 ⇒[Pmap newLowPM&larr; pm0]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">Pmap newHighPM&larr; (Vmem highPM: oop)].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">n=¬1 ⇒[Pmap newZN: a. Pmap ZHB: a gets: 0. ⇑a]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">Pmap ZN: a gets: (Pmap ZN: n).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">Pmap ZHB: a gets: 1 + (Pmap ZHB: n).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑a]</span></div>
<div class="line left">
<span class="bold small">nextfree: n </span><span class="small">| a<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[n≡nil ⇒[n &larr; self newpcl: ¬1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑(n, (n+1))]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">n\0200 = 0177 ⇒[a &larr; self newpcl: n.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑(n, a)]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑(n, (n+1))]</span></div>
<div class="line left">
<span class="bold small">object: object<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[oop &larr; object asOop]</span></div>
<div class="line left">
<span class="bold small">readin </span><span class="small">| v  </span><span class="italic small">"read object off vmemfile and return image"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[[noop ≡ nil ⇒[(v &larr; mrefs lookup: oop) ⇒[noop &larr; v◦2] <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user notify: &rsquo;can not find new oop&rsquo;]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑image &larr; Pmap readin: noop]</span></div>
<div class="line left">
<span class="bold small">writeout<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"write image of object on file"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">Pmap writeout: noop with: image]</span></div>
<div class="line left">
<span class="bold large"><br>Init and Exceptions</span></div>
<div class="line left">
<span class="bold small">Acomment<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"Vmapper writes objects out.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">watch out for abnormally high refcts.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">we trust map to catch all special cases (especially<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">fixed octave classes (VariableLengthClass)).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">Vmapper edit: ↪mapObject.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">Vmem is VirtualMemory of this system.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">Pmap is VirtualMemory of new system.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">refct in mrefs is 1-order (0 = all done)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">mrefs - a Dictionary<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">old oop  -&gt;  (remaining refct, new oop)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">classtrans - a Dictionary<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">old class oop  -&gt;  (new oop, freelist oop)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">-&gt;  (new oop, 20 freelist oops)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">sequence of foreign object:<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">map (put in mrefs) <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">newoop (classtrans lookup old class)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">not there⇒ create pclass, get zone, zip entry<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">enter freelist, no new class in classtrans<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">put nop in mrefs, write object out<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">later: map class, fill in classtrans new class<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">later: pass over PM, convert RCI<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">To remap atoms:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">To only copy atoms:<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">giveBirth3 - arefsRectify</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">- don&rsquo;t call<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">mapUniqueString -uniStrOop</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">-newoop, arefs<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">mapVector - filter USTable</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">-don&rsquo;t<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">writefreelists - don&rsquo;t freelistRectify</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">-call it<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">(Speed only below)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">permHashSet - test objects</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">-force fail on test<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">Now above done by setting UseOldUniqueStrings in giveBirth3.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"</span><span class="small">]</span></div>
<div class="line left">
<span class="bold small">arefsRectify </span><span class="small">| i ustable vm </span><span class="italic small">"create USTable and write out"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[UseOldUniqueStrings ⇒[⇑nil </span><span class="italic small">"dont create if using old atoms"</span><span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">ustable &larr; Vector new: USTable length.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: ustable length do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ustable◦i &larr; Vector new: 2].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">i &larr; ustable.  ustable &larr; USTable. USTable &larr; i.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i from: arefs objects do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[i ≡ nil ⇒[]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">↪a intern: i asObject].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">i &larr; ustable.  ustable &larr; USTable. USTable &larr; i.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">vm &larr; Vmapper new.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">vm object: ustable.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self reset; object: (Smalltalk ref: ↪USTable); readin.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">image word: 2 &larr; vm map. </span><span class="italic small">"ref new table"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self writeout; reset]</span></div>
<div class="line left">
<span class="bold small">bump  </span><span class="italic small">"count objects mapped, print"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[count &larr; count + 1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">count\ 100 = 0 ⇒[user clearshow: count asString; space;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">show: oop base8; cr.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">count = stopcount ⇒[user ev; show: stopcount asOop base8]]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">freelistRectify </span><span class="small">| i v  </span><span class="italic small">"fix bad atom freelist"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[[UseOldUniqueStrings ⇒[] ⇑nil].  </span><span class="italic small">"dont rectify if new atom names created"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i from: (Vmem pmatm to: 0174000 - 0200 by: 0200) do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[(Vmapper new object: i asObject) UniStroop].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">v &larr; classtrans lookup: 0602.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i from: (2 to: 21) do⦂ [v◦i ≡ nil ⇒[]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">v◦i &larr; v◦i + 1]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">init   </span><span class="italic small">"set up class variables"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[PCL &larr; 151.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">classtrans &larr; Dictionary new init: 32.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">mrefs &larr; Dictionary new init: 64.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">arefs &larr; Dictionary new init: 64.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">count &larr; 1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">stopcount &larr; 5 </span><span class="italic small">"no stopping"</span><span class="small">.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">clamp &larr; HashSet new init: 8. <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"clamp insertall: (ClassA, ClassB, ClassC...).""ones to get rid of"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">USTableOop &larr; USTable asOop.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"override this in VirtualMemory giveBirth3"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">UseOldUniqueStrings &larr; true]</span></div>
<div class="line left">
<span class="bold small">mrefsRectify </span><span class="small">| v zz<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[for⦂ v from: mrefs values do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[v ≡ nil ⇒[]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">v◦1 = 0 ⇒[</span><span class="italic small">"refct ok"</span><span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">v◦2 = ¬1 ⇒[</span><span class="italic small">"nil not on disk"</span><span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">zz &larr; Pmap obwiz: v◦2.  </span><span class="italic small">"noop"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">image &larr; Pmap read: 2 at: zz.  </span><span class="italic small">"2 words"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">image word: 1 &larr; (image word: 1) - (v◦1).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">Pmap writeout: v◦2 with: image.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self reset]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">noop: noop </span><span class="italic small">"give it noop for readin"</span></div>
<div class="line left">
<span class="bold small">reset </span><span class="small">[noop &larr; image &larr; nil]</span></div>
<div class="line left">
<span class="bold small">touchoop </span><span class="small">| v a i indx </span><span class="italic small">"claim pclass, zone, classtrans"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[(v &larr; classtrans lookup: (object class) asOop) ⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[indx &larr; 1 +(Vmem freelist: object).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">a &larr; self nextfree: v◦indx.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">v◦indx &larr; a◦1. </span><span class="italic small">"not take it"</span><span class="small"> ⇑a◦1]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> i &larr; [object class is: Class ⇒[1] 20].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> v &larr; Vector new: i+1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> classtrans insert: (object class) asOop with: v.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> ⇑self touchoop]</span></div>
<div class="line left">
<span class="bold small">UniStroop </span><span class="small">| pm0 v indx<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"Unique Strings must get same oop and pclass"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">v &larr; classtrans lookup: 0602.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">indx &larr; 1+ (Vmem freelist: object).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pm0 &larr; Pmap highPM: oop.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pm0 and⦂ 0 ≠ pm0 ⇒[</span><span class="italic small">"test for new max freelist"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(oop field: PCL) = (v◦indx field: PCL) ⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[v◦indx &larr; v◦indx max: oop]] <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">Pmap highpm0: oop gets: (Vmem highPM: oop).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">Pmap ZHB: oop gets: (Vmem ZHB: oop).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">v◦indx ≡ nil ⇒[Pmap newZN: oop.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">v◦indx &larr; oop]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">Pmap ZN: oop gets: (Pmap ZN: v◦indx).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">v◦indx &larr; oop min: v◦indx<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">UseOldUniqueStrings: a </span><span class="small">[UseOldUniqueStrings &larr; a] </span><span class="italic small">"true if do not want atoms remapped"</span></div>
<div class="line left">
<span class="bold small">writefreelists </span><span class="small">| v oadd i nlen str<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self freelistRectify.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nlen &larr; 1 + Class instsize. oadd &larr; 1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">str &larr; String new: 4. <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">str word: 1 &larr; 1. str word: 2 &larr; ¬1. </span><span class="italic small">"refct=1, link = nil"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ v from: classtrans values do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[v ≡ nil ⇒[]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">image &larr; Pmap readin: v◦1.  </span><span class="italic small">"noop"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[v length = 2 ⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"a Class"</span><span class="small"> v◦2 ≡ nil ⇒[]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">image word: (1+nlen) &larr; v◦2.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">Pmap writeout: v◦2 with: str]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"a Variable Length Class"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: 20 do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[v◦(1+i) ≡ nil ⇒ []<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">image word: (i+nlen+oadd) &larr; v◦(1+i).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">Pmap writeout: v◦(1+i) with: str] ].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">Pmap writeout: v◦1 with: image].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self reset]</span></div>
<div class="line left">
<span class="bold large"><br>As yet unclassified</span></div>
<div class="line left">
<span class="bold small">Addons<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[(dp0 file: &rsquo;VmapperAdd.st&rsquo;) filout: ↪(<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">)]</span></div>
<div class="line left">
<span class="bold small">arefs  </span><span class="italic small">"dictionary of UniqueString oops and noops"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑arefs]</span></div>
<div class="line left">
<span class="bold small">classtrans </span><span class="small">[⇑classtrans]</span></div>
<div class="line left">
<span class="bold small">image </span><span class="small">[⇑image]</span></div>
<div class="line left">
<span class="bold small">mrefs </span><span class="italic small">"dictionary of multiple refct oops"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑mrefs]</span></div>
<div class="line left">
<span class="bold small">noop </span><span class="small">[⇑noop]</span></div>
<div class="line left">
<span class="bold small">object </span><span class="small">[⇑object]</span></div>
<div class="line left">
<span class="bold small">oop </span><span class="small">[⇑oop]</span></div>
<div class="line left">
<span class="bold small">printon: strm<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[oop ≡ nil ⇒[super printon: strm]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">strm append: &rsquo;Vmapper &rsquo;; append: oop base8]</span></div>
<div class="line left">
<span class="bold small">show </span><span class="small">| i  </span><span class="italic small">"show image of object in base8"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[for⦂ i to: image length/2 do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[user show: (image base8: i); space.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">i\3 = 0 ⇒[user cr]]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪Vmapper under: &rsquo;Primitive Access&rsquo;.</span></div>
    <div class="line left">
<span class="small">&rsquo;From Smalltalk 5.5k XM November 24 on 22 November 1980 at 2:57:08 am.&rsquo;<br></span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large">"ParagraphScanner"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;ParagraphScanner&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: Object<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;para "&lt;Paragraph&gt;"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">style "&lt;TextStyle&gt;"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">press "&lt;PressFile&gt; for output"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">runstrm "&lt;Stream&gt; of paragraph runs"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">textstrm "&lt;Stream&gt; of paragraph text"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">font "&lt;WidthTable&gt; current font"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">ascent "&lt;Integer&gt; max ascent"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">descent "&lt;Integer&gt; negative max descent"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">width "&lt;Integer&gt; total width"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">spaces "&lt;Integer&gt; number of spaces"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">rect "&lt;Rectangle&gt; for printing"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">tabpos "&lt;Stream&gt; (text position, new X position) of tabs"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;&rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>Scans through a paragraph computing the dimensions of a partial line of text.</span></div>
<div class="line left">
<span class="bold large"><br>Initialization</span></div>
<div class="line left">
<span class="bold small">in: rect</span></div>
<div class="line left">
<span class="bold small">init<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ascent &larr; descent &larr; width &larr; spaces &larr; 0. tabpos reset]</span></div>
<div class="line left">
<span class="bold small">of: para to: press style: style<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[textstrm &larr; &rsquo;&rsquo; asStream.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">runstrm &larr; para runs asStream.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">tabpos &larr; (Vector new: 10) asStream]</span></div>
<div class="line left">
<span class="bold large"><br>Access</span></div>
<div class="line left">
<span class="bold small">position </span><span class="small">[⇑textstrm position]</span></div>
<div class="line left">
<span class="bold small">width </span><span class="small">[⇑width]</span></div>
<div class="line left">
<span class="bold large"><br>Scanning</span></div>
<div class="line left">
<span class="bold small">backup<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[textstrm skip: ¬1]</span></div>
<div class="line left">
<span class="bold small">scan </span><span class="italic small">"Scan up to a zero-width character, back up to last blank if width exceeded"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">| maxw sp char t<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"Save state" spos slim srunpos sasc sdesc swidth ssp sfont stpos<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[textstrm end and⦂ self newrun≡false⇒ [⇑false]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">maxw &larr; rect width.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ascent &larr; ascent max: font ascent.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">descent &larr; descent max: font descent.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">sp &larr; font space.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">t &larr; font scan: textstrm until: width exceeds: maxw.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[(char &larr; t◦1) ≡ true⇒ [] width &larr; t◦2].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">char = 040] do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["Save state"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">spos &larr; textstrm position. slim &larr; textstrm limit.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">srunpos &larr; runstrm position. stpos &larr; tabpos position.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">sasc &larr; ascent. sdesc &larr; descent.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">swidth &larr; width. ssp &larr; spaces. sfont &larr; font.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">spaces &larr; spaces+1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">width &larr; width+sp].<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">char⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[(char≡true and⦂ nil≠spos) and⦂ (2*ascent ≤ rect height)⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"Back up to just past last blank (if another line fits)"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">textstrm of: para text from: spos+1 to: slim.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">runstrm position &larr; srunpos. tabpos position &larr; stpos.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">ascent &larr; sasc. descent &larr; sdesc.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">width &larr; swidth. spaces &larr; ssp. font &larr; sfont.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑040]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑char]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self newrun]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> do⦂ [].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑false]</span></div>
<div class="line left">
<span class="bold small">tab<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[spaces &larr; 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">tabpos next &larr; textstrm position;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">next &larr; (width &larr; width + font tab | font tab)]</span></div>
<div class="line left">
<span class="bold large"><br>Printing</span></div>
<div class="line left">
<span class="bold small">printfrom: charpos aligned: align skip: n </span><span class="italic small">"Returns false if goes below bottom"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">| ybot a b ix iy px xs sp rs len tpos ts ntab rval ifont w ps [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">this code basically writes the EL (entity list) for a line</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"bottom of character -- ascent not really ascent but height"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(ybot &larr; rect corner y - ascent) &lt; rect origin y ⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">won&rsquo;t fit</span><span class="small">" ⇑false]<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">a &larr; charpos + 1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">b &larr; textstrm position - n.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[a &gt; b ⇒ [</span><span class="italic small">"No text"</span><span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">ts &larr; tabpos viewer.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">tpos &larr; ts next.<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">px &larr; false.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">xs &larr; rect width - width.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">ix &larr; rect minX + ["</span><span class="italic small">left margin offset</span><span class="small">" align=2⇒ [xs/2]; =4⇒[xs] 0].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">set baseline of character.  do setx before showchars</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">press sety: (iy &larr; ybot + descent).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">sp &larr; font space "kludge?".<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[align=1⇒ ["</span><span class="italic small">do setspacex before showchars</span><span class="small">"] press setspacex: sp].<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">rs &larr; (para run: a to: b) asStream.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ (len &larr; rs next) do⦂ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">press selectfont: (press fontindex: (rval &larr; rs next) style: style) - 1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">b &larr; a+len.<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[(rval land: 4) = 0⇒ ["no underlining"]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"unfortunately, we must rescan this part of line to find out how wide it is"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">ifont &larr; press codefont: rval style: style "a WidthTable".<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">ps &larr; (para◦(a to: b-1)) asStream.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">w &larr; true, 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ w◦1 do⦂ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">w &larr; ifont scan: ps until: w◦2 exceeds: rect width.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">w◦1 = 040⇒ [w◦2 &larr; w◦2 + ifont space];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=011⇒ [w◦2 &larr; w◦2 + ifont tab | ifont tab]].<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[px⇒ ["use current x position"] press setx: ix].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"change y position to show rectangle, then change y back again"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">press sety: iy-40; showrectwidth: w◦2 height: 30; sety: iy].<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">ntab &larr; 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ (tpos and⦂ tpos&lt;b) do⦂ [</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"Put out tabs"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[tpos = a⇒ ["</span><span class="italic small">no text between this tab and last</span><span class="small">"]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">put out accumulated tabs or initial x</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ntab&gt; 0⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">press skipchars: ntab; setx: px.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">ntab &larr; 0]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">px⇒ []<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">press setx: (px &larr; ix)].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">press showchars: tpos-a].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">ntab &larr; ntab+1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">px &larr; ix + ts next.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">a &larr; tpos+1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">tpos &larr; ts next].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ntab&gt; 0⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">press skipchars: ntab;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">setx: px]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">px⇒ []<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">press setx: (px &larr; ix)].<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[align=1 and⦂ tpos≡false ⇒</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"Reset space width"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[spaces=0⇒ [] press setspacex: xs/spaces+sp].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">align &larr; 0]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">rs end⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">for more compactness, maybe</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">press showchars: b-a skip: n.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ybot]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">press showchars: b-a.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">a &larr; b]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[n &gt; 0⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">skip over ending blank or carriage return</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">press skipchars: n]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ybot]</span></div>
<div class="line left">
<span class="bold large"><br>Private scanning</span></div>
<div class="line left">
<span class="bold small">newrun </span><span class="small">| len pos [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">len &larr; runstrm next⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[pos &larr; textstrm position.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">textstrm of: para text from: pos+1 to: pos+len.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">font &larr; press codefont: (runstrm next) style: style]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑false]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪ParagraphScanner under: &rsquo;Press File Support&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"PressFile"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;PressFile&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: Object<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;DL "&lt;File&gt; stores data list"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">EL "&lt;Set&gt; accumulates entity list"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">parts "&lt;Set&gt; accumulates part directory"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">DLstart "&lt;Integer&gt; position of current entity in DL"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">ELstart "&lt;Integer&gt; word position of current entity in EL"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">Pstart "&lt;Integer&gt; record position of current page in DL"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">eorigin "&lt;Point&gt;"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">scale "&lt;Integer&gt; micas per Alto screen dot"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">boundbox "&lt;Rectangle&gt; bounding box for current page"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fontcodes "&lt;Vector&gt; of run codes corresponding to current fonts"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fontdefs "&lt;Vector of WidthTables&gt; corresponding to fontcodes"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">estate "&lt;Vector&gt; of some entity state"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">FL "&lt;Set&gt; accumulates strings for Ext. File part" &rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;prevstyle SMentity recordsize printers printerMenu &rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>There are two levels of code in this class: the low-level Press commands and the high level user commands.  At the moment, only text, lines and bitmaps are supported (see Paragraph presson:in: and class ParagraphScanner for the former).  ignores bounding box stuff. limited reading.<br><br>see &lt;GR-DOCS&gt;PressFormat.Press and PressFormat-figure.Press for more details</span></div>
<div class="line left">
<span class="bold large"><br>Initialization</span></div>
<div class="line left">
<span class="bold small">of: DL </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">EL &larr; Set new string: 200.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">FL &larr; Set new string: 40.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">parts &larr; Set new string: 40.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">fontcodes &larr; Vector new: 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">fontdefs &larr; Vector new: 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">estate &larr; Vector new: 3 "font, spacex, spacey, ...".<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">prevstyle&larr; nil.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self scale: PressScale;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">startPage]</span></div>
<div class="line left">
<span class="bold small">reset </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">DL readwriteshorten; reset.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self of: DL]</span></div>
<div class="line left">
<span class="bold small">scale: scale</span></div>
<div class="line left">
<span class="bold large"><br>Aspects</span></div>
<div class="line left">
<span class="bold small">defaultPrinterName </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑[currentProfile ≡ nil⇒ [PrinterName] currentProfile printerName]]</span></div>
<div class="line left">
<span class="bold small">name </span><span class="small">[⇑DL name]</span></div>
<div class="line left">
<span class="bold small">scale </span><span class="small">[⇑scale]</span></div>
<div class="line left">
<span class="bold large"><br>Entity/Page/File Commands</span></div>
<div class="line left">
<span class="bold small">box: rect hue: hue sat: sat bright: bright containing⦂ expr | w r</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self entity: (self transrect: (w&larr; rect inset: ¬2)) containing⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[for⦂ r from: (w minus: rect) do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self showrect: r color: 0].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ColorPrint⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self hue: hue; saturation: sat;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">showrect: rect color: bright; brightness: 0]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">expr eval]]</span></div>
<div class="line left">
<span class="bold small">clip: boundingbox</span></div>
<div class="line left">
<span class="bold small">close </span><span class="small">| p i font [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">DL writing≡false⇒ [DL close]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self closePage.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">parts≡false or⦂ parts empty⇒ []<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"if present, include the external file part  --- added Sept 80"<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[FL empty⇒[]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self part⦂ [DL append: FL] code: 2.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">FL reset.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self padpage].<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"put font names and descriptions into font directory (part)"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self part⦂ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: fontdefs length do⦂ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">font &larr; fontdefs ◦ i.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">DL nextword&larr; 16; nextword&larr; i-1;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">next &larr; font min; next &larr; font max.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self Bcpl: font name pad: 20.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">DL next &larr; font face; next &larr; font min;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nextword &larr; font pointsize; nextword&larr; 0]]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">code: 1.<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">write part directory. Pstart is current page position</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">DL append: parts asReadStream.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self padpage.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">p &larr; self recordnum.<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">document directory</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">DL nextword&larr; 27183; </span><span class="italic small">"press password"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nextword&larr; p + 1 </span><span class="italic small">"number of records"</span><span class="small">;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nextword&larr; parts position / 8 </span><span class="italic small">"number of parts"</span><span class="small">;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nextword&larr; Pstart; </span><span class="italic small">"part dir and length"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nextword&larr; p - Pstart;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nextword&larr; ¬1; "</span><span class="italic small">backpointer to obsolete doc dir</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">append: user timewords; "2 time words"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nextword&larr; 1; </span><span class="italic small">"first and last copies"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nextword&larr; 1;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nextword&larr; ¬1; </span><span class="italic small">"first and last pages"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nextword &larr; ¬1;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nextword &larr; &rsquo;S&rsquo;◦1 "</span><span class="italic small">solid color (looked at by color printers)</span><span class="small">";<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">next: 2*(0177-12) &larr; 0377.<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">p &larr; user now.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self Bcpl: self name pad: 52;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">Bcpl: [currentProfile≡nil⇒ [dp0 diskID◦1] currentProfile printedBy] pad: 32;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">Bcpl: [((String new: 40) asStream) print: p◦1; space; print: p◦2; contents] pad: 40;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">padpage.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">DL close.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">parts reset]</span></div>
<div class="line left">
<span class="bold small">entity: box containing⦂ expr </span><span class="small">| v [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self startEntity.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">boundbox &larr; box.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">v &larr; expr eval.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self closeEntity.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑v]</span></div>
<div class="line left">
<span class="bold small">entityorigin: eorigin</span></div>
<div class="line left">
<span class="bold small">page </span><span class="small">[self closePage]</span></div>
<div class="line left">
<span class="bold small">pictureinit </span><span class="small">[self pictureinit: user screenrect scale: PressScale]</span></div>
<div class="line left">
<span class="bold small">pictureinit: rect scale: scale<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[boundbox &larr; boundbox include: (self transrect: rect).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self somefont]</span></div>
<div class="line left">
<span class="bold small">screenout: rect scale: scale<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"puts a bit map image onto the PressFile.  The standard<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">scaling is 32 micas per Alto dot.  22 looks better, Dover only<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">works with 32"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user displayoffwhile⦂ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self somefont; setp: (self transrect: rect) origin; bitmap: rect bits: false; close]]</span></div>
<div class="line left">
<span class="bold small">selectPrinter </span><span class="small">[⇑self selectPrinter: self defaultPrinterName]</span></div>
<div class="line left">
<span class="bold small">selectPrinter: oldName </span><span class="small">| t [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user cr; show: &rsquo;select a printer (currently &rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">show: [oldName≡false or⦂ oldName empty⇒ [&rsquo;none&rsquo;] oldName]; show: &rsquo;)&rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user cursorloc &larr; user screenrect center; restoredisplay.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">t &larr; 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ t = 0 do⦂ [t &larr; printerMenu wbug].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑[t ≤ printers length⇒ [printers◦t]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">t = (printers length+1)⇒ ["same" oldName] "none" false]]</span></div>
<div class="line left">
<span class="bold small">toPrinter </span><span class="small">[self toPrinter: self defaultPrinterName]</span></div>
<div class="line left">
<span class="bold small">toPrinter: ndest </span><span class="small">"a printer name" | psocket dest np t perr [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">ndest ≡ false⇒ ["don&rsquo;t try to print" ⇑false]<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">E ≡ nil⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"use O.S. if Smalltalk ethercode not alive"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">t &larr; (String new: 100) asStream.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">t append: &rsquo;Empress. &rsquo;; append: self name.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ndest length &gt; 0⇒ [t space; append: ndest; append: &rsquo;/H&rsquo;]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">t append: &rsquo;; Resume.~ Small.Boot&rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user quitThen: t asReadStream]<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">dest &larr; &rsquo;&rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">perr &larr; psocket &larr; false.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">np &larr; printers length+1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">DL readonly.<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ ndest do⦂ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">perr or⦂ ndest empty⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">perr &larr; false.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">ndest &larr; self selectPrinter: dest]<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[dest = ndest⇒ ["to same printer"]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">dest &larr; ndest.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"close previous socket"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">psocket⇒ [psocket close. psocket &larr; false]].<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[psocket⇒ []<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"create new socket"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">psocket &larr; EFTPSender new hostName: dest⇒ [psocket wakeup]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user cr; show: &rsquo;name lookup failure&rsquo;].<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"send file"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">psocket and⦂ (user displayoffwhile⦂ [psocket send: DL reset])⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"success--stop" ndest &larr; false]<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"failure--switch servers?"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">perr &larr; true].<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"cleanup after success or abort"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">DL close.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">psocket⇒ [psocket close]]</span></div>
<div class="line left">
<span class="bold large"><br>Fonts</span></div>
<div class="line left">
<span class="bold small">codefont: code style: style<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑fontdefs◦(self fontindex: code style: style)]</span></div>
<div class="line left">
<span class="bold small">fontindex: code style: style </span><span class="small">| ix font n<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"return index if in font dictionary"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">code &larr; code land: 0363.</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"Remove underline and strikeout"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[style=prevstyle⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[(ix &larr; fontcodes find: code) &gt; 0 ⇒ [⇑ix]]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">fontcodes all&larr; nil. "invalid across style change"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">prevstyle&larr; style].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">n &larr; code / 16 + 1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">font &larr; (WidthTable new<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">named: (style fontfamily: n)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pointsize: (style fontsize: n)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">face: (code / 2 land: 1) + (code * 2 land: 2))<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> lookup.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(ix&larr; fontdefs find: font)&gt;0⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[fontcodes◦ix&larr; code. ⇑ix]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"add entry to font dictionary"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">fontdefs length=16⇒[user notify: &rsquo;too many fonts&rsquo;. ⇑1]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">fontcodes &larr; fontcodes, code.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">fontdefs &larr; fontdefs, font.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑fontcodes length]</span></div>
<div class="line left">
<span class="bold small">selectfont: f </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">estate◦1 = f⇒ []<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">EL next &larr; 0160 + (estate◦1 &larr; f)]</span></div>
<div class="line left">
<span class="bold small">somefont</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"fool self into writing non-empty fontdir"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self fontindex: 5*16 style: DefaultTextStyle]</span></div>
<div class="line left">
<span class="bold large"><br>Transformations</span></div>
<div class="line left">
<span class="bold small">transpt: p<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑ Point new x: (p x * scale) asInteger y: (25400 - (p y * scale)) asInteger]</span></div>
<div class="line left">
<span class="bold small">transrect: rect<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑ Rectangle new<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">origin: (self transpt: rect minX ⌾ rect maxY)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">corner: (self transpt: rect maxX ⌾ rect minY)]</span></div>
<div class="line left">
<span class="bold large"><br>EL commands</span></div>
<div class="line left">
<span class="bold small">brightness: b </span><span class="small">[EL next&larr; 0370; next&larr; b]</span></div>
<div class="line left">
<span class="bold small">hue: b </span><span class="small">[EL next&larr; 0371; next&larr; b]</span></div>
<div class="line left">
<span class="bold small">onlyoncopy: n </span><span class="small">[EL next &larr; 0355; next &larr; n]</span></div>
<div class="line left">
<span class="bold small">resetspace </span><span class="small">[EL next &larr; 0366]</span></div>
<div class="line left">
<span class="bold small">saturation: s </span><span class="small">[EL next&larr; 0372; next&larr; s]</span></div>
<div class="line left">
<span class="bold small">setp: p </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"self setx: p x; sety: p y"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">EL next &larr; 0356; nextword &larr; p x;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">next &larr; 0357; nextword &larr; p y]</span></div>
<div class="line left">
<span class="bold small">setspacex: x </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">estate◦2 = x⇒ []<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">estate◦2 &larr; x.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">x ≥ 0 and⦂ x ≤ 2047⇒ ["</span><span class="italic small">short form</span><span class="small">" EL nextword &larr; 060000 + x]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">EL next &larr; 0364; nextword &larr; x]</span></div>
<div class="line left">
<span class="bold small">setspacey: y </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">estate◦3 = y⇒ []<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">estate◦3 &larr; y.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">y ≥ 0 and⦂ y ≤ 2047⇒ ["</span><span class="italic small">short form</span><span class="small">" EL nextword &larr; 064000 + y]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">EL next &larr; 0365; nextword &larr; y]</span></div>
<div class="line left">
<span class="bold small">setx: x </span><span class="small">[EL next &larr; 0356; nextword &larr; x]</span></div>
<div class="line left">
<span class="bold small">sety: y </span><span class="small">[EL next &larr; 0357; nextword &larr; y]</span></div>
<div class="line left">
<span class="bold small">showchar: char </span><span class="small">["immediate" EL next &larr; 0363; next &larr; char]</span></div>
<div class="line left">
<span class="bold small">showchars: n </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">n=0⇒ []<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">n ≥ 1 and⦂ n ≤ 32⇒ ["</span><span class="italic small">short form</span><span class="small">" EL next &larr; n-1]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">EL next &larr; 0360; next &larr; n]</span></div>
<div class="line left">
<span class="bold small">showchars: n skip: t </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">t=1 and⦂ (n ≥ 1 and⦂ n ≤ 32)⇒ [EL next &larr; 0100 + n-1]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self showchars: n; skipchars: t]</span></div>
<div class="line left">
<span class="bold small">showdots: nwords </span><span class="small">[EL next &larr; 0374; nextNumber: 4 &larr; nwords]</span></div>
<div class="line left">
<span class="bold small">showdotsopaque: nwords </span><span class="small">[EL next &larr; 0375; nextNumber: 4 &larr; nwords]</span></div>
<div class="line left">
<span class="bold small">showrect: rect </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self setp: rect origin.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">EL next &larr; 0376;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nextword &larr; rect width;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nextword &larr; rect height]</span></div>
<div class="line left">
<span class="bold small">showrect: rect color: c </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ColorPrint⇒ [self brightness: c]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self showrect: (self transrect: rect)]</span></div>
<div class="line left">
<span class="bold small">showrectwidth: w height: h </span><span class="small">[EL next &larr; 0376; nextword &larr; w; nextword &larr; h]</span></div>
<div class="line left">
<span class="bold small">skipchars: n </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">n=0⇒ []<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">n ≥ 1 and⦂ n ≤ 32⇒ ["</span><span class="italic small">short form</span><span class="small">" EL next  &larr; 040 + n-1]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">EL next &larr; 0361; next &larr; n]</span></div>
<div class="line left">
<span class="bold small">skipcontrol: n </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"immediate"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">EL next &larr; 0353; next &larr; n.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"now put n bytes in EL"]</span></div>
<div class="line left">
<span class="bold small">skipcontrol: n type: t </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"n bytes have been put in DL"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">EL next &larr; 0362; nextword &larr; n; next &larr; t]</span></div>
<div class="line left">
<span class="bold small">space </span><span class="small">[EL next &larr; 0367]</span></div>
<div class="line left">
<span class="bold large"><br>Bitmaps/Dots</span></div>
<div class="line left">
<span class="bold small">AIS: file width: w height: h croprect: r at: pt scale: s<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self setp: (self transpt: pt); dots⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self setcoding: 8 "byte samples" dots: w lines: h;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">setmode: 3 "to right and to bottom of page";<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">setsizewidth: (s*r width*scale) asInteger height: (s*r height*scale) asInteger;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">setwindowwidth: r width height: r height skipdots: r minX skiplines: r minY;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">dotsfromAIS: file]]<br>"<br>(dp0 pressfile: &rsquo;pix.press&rsquo;) somefont; AIS: &rsquo;girl.ais&rsquo; width: 512 height: 512 croprect: (50⌾50 rect: 500⌾500) at: 36⌾80 scale: 0.65; close.<br>"</span></div>
<div class="line left">
<span class="bold small">bitmap: rect bits: bits </span><span class="small">| w w16 h</span><span class="italic small"> </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">some pecularities of spruce:<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">scale must be 32, and multiples of 16 for width (maybe extra stuff prints)</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">w &larr; rect width.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">w16 &larr; w + 15 | 16 "</span><span class="italic small">width to next word boundary</span><span class="small">".<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">h &larr; rect height.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">origin should be set earlier</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self dots⦂ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self setcoding: 0 "</span><span class="italic small">bitmap</span><span class="small">" dots: w16 lines: h;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">setmode: 3 "</span><span class="italic small">to right and to bottom of page</span><span class="small">";<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">setsizewidth: scale * w16 height: scale * h;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">setwindowwidth: [ColorPrint⇒ [w] w16] height: h;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">dotsfollow.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bits⇒["</span><span class="italic small">bits supplied</span><span class="small">" DL append: bits]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">else from screen</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">rect bitsOntoStream: DL]]</span></div>
<div class="line left">
<span class="bold small">dots⦂ exp </span><span class="small">| dlpos [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">dlpos &larr; self padword.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">exp eval.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self showdots: DL wordposition - dlpos]</span></div>
<div class="line left">
<span class="bold small">dotsfollow </span><span class="small">[DL nextword &larr; 3]</span></div>
<div class="line left">
<span class="bold small">dotsfromAIS: file </span><span class="small">| f<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[f&larr;file length inString+file+[file length even⇒[&rsquo; &rsquo;]&rsquo;&rsquo;]. "BCPLize"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">DL nextword &larr; 4; nextword &larr; 4; append: f. FL append: f]</span></div>
<div class="line left">
<span class="bold small">setcoding: c dots: d lines: l </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">DL next &larr; 1; next &larr; c;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nextword &larr; d; nextword &larr; l]</span></div>
<div class="line left">
<span class="bold small">setmode: m </span><span class="small">[DL next &larr; 2; next &larr; m]</span></div>
<div class="line left">
<span class="bold small">setsizewidth: w height: h </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">DL nextword &larr; 2; nextword &larr; w; nextword &larr; h]</span></div>
<div class="line left">
<span class="bold small">setwindowwidth: w height: h </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self setwindowwidth: w height: h skipdots: 0 skiplines: 0]</span></div>
<div class="line left">
<span class="bold small">setwindowwidth: w height: h skipdots: sd skiplines: sl<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[DL nextword &larr; 1;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nextword &larr; sd; nextword &larr; w;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nextword &larr; sl; nextword &larr; h]</span></div>
<div class="line left">
<span class="bold large"><br>Lines/Objects</span></div>
<div class="line left">
<span class="bold small">drawcurve: v </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">v length ≠ 12⇒ [user notify: &rsquo;illegal drawcurve&rsquo;]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">DL nextword &larr; 2.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ v from: v do⦂ [DL nextword &larr; v]]</span></div>
<div class="line left">
<span class="bold small">drawdiscat: pt radius: radius | dx dy i<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[radius ≤ 16 ⇒ []<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> dx &larr; ↪(5 4 3 1 ¬1 ¬3 ¬4 ¬5 ¬5 ¬4 ¬3 ¬1 1 3 4 5).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> dy &larr; ↪(1 3 4 5 5 4 3 1 ¬1 ¬3 ¬4 ¬5 ¬5 ¬4 ¬3 ¬1).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> self showobject⦂ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self moveto: pt + ((dx◦16*radius/5) ⌾ (dy◦16*radius/5)).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> </span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: 16 do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self drawto: pt + ((dx◦i*radius/5) ⌾ (dy◦i*radius/5))]]]</span></div>
<div class="line left">
<span class="bold small">drawlinefrom: p1 to: p2 width: width | d length t1 t2<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[[(d &larr; p2-p1) = (0⌾0) ⇒ []<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">d x&larr; d x asFloat. d y&larr; d y asFloat. width &larr; width asFloat.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">length &larr; ((d x*d x)+(d y*d y)) sqrt.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">d x&larr; (d x*width/length) asInteger.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">d y&larr; (d y*width/length) asInteger.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">t1 &larr; d y ⌾ (0 - d x).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">t2 &larr; 0 - d y ⌾ d x.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self showobject⦂ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self moveto: p1 + t1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self drawto: p2 + t1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self drawto:  p2 + t2.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self drawto:  p1 + t2.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self drawto:  p1 + t1]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> self drawdiscat: p2 radius: width]</span></div>
<div class="line left">
<span class="bold small">drawlinefromscreen: p1 to: p2 width: width<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑self drawlinefrom: (self transpt: p1) to: (self transpt: p2) width: (width*scale)] </span></div>
<div class="line left">
<span class="bold small">drawto: p </span><span class="small">[DL nextword &larr; 1; nextPoint &larr; p]</span></div>
<div class="line left">
<span class="bold small">moveto: p </span><span class="small">[DL nextword &larr; 0; nextPoint &larr; p]</span></div>
<div class="line left">
<span class="bold small">object⦂ expr atScreen: p <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self showobject⦂ [self objectGotoScreen: p pen: 0. expr eval]]</span></div>
<div class="line left">
<span class="bold small">objectGotoScreen: p pen: pen </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">DL nextword&larr; pen; nextPoint &larr; (self transpt: p)]</span></div>
<div class="line left">
<span class="bold small">showobject⦂ exp </span><span class="small">| p [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">p &larr; self padword.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"expression containing moveto, drawto, drawcurve"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">exp eval.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">EL next &larr; 0373; nextword &larr; DL wordposition - p]</span></div>
<div class="line left">
<span class="bold large"><br>Private</span></div>
<div class="line left">
<span class="bold small">append: x<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑DL append: x]</span></div>
<div class="line left">
<span class="bold small">Bcpl: s pad: n </span><span class="small">| slen [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">write a Bcpl string and padding to fill n bytes (used by close)</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">slen &larr; s length min: n-1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">DL next &larr; slen; append: s◦(1 to: slen); next: n-(slen+1) &larr; 0]</span></div>
<div class="line left">
<span class="bold small">classInit </span><span class="small">| a p ["PressFile classInit."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">Smalltalk declare: ↪PressScale as: 32.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">recordsize &larr; 512.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">SMentity &larr; 5.<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">a &larr; (String new: 250) asStream.<br>"from [Maxc1]&lt;Altodocs&gt;NetTopology.Press, October 1980. in order of net number"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">printers &larr; ↪(<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"net #"</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"printer names"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">" 1"</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">&rsquo;Navajo&rsquo;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"HENRIETTA"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">" 3"</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">&rsquo;Menlo&rsquo; &rsquo;Clover&rsquo; &rsquo;Lilac&rsquo; "PARC: BLDG 35, FLOOR 2"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">" 5"</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">&rsquo;Kanji&rsquo;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"PARC:  BLDG 34"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">" 6"</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">&rsquo;Wonder&rsquo; &rsquo;Quake&rsquo;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"PARC: BLDG 35, FLOOR 1&3"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"10"</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">&rsquo;Puff&rsquo;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"A&E"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"12"</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">&rsquo;White&rsquo; &rsquo;Colorado&rsquo;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"PASADENA"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"14"</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">&rsquo;Niagara&rsquo; &rsquo;Tioga&rsquo;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"WEBSTER"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"20"</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">&rsquo;Yoda&rsquo;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"PARC: BLDG 32"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"21"</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">&rsquo;Lily&rsquo; </span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"SPG"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"23"</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">&rsquo;Ranger&rsquo;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"DALLAS"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"26"</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">&rsquo;Windfall&rsquo;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"DC"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"27"</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">&rsquo;Genesee&rsquo;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"WEBSTER"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"33"</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">&rsquo;Amarok&rsquo;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"TORONTO"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"34"</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">&rsquo;Yankee&rsquo;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"STAMFORD"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"36"</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">&rsquo;Cyclops&rsquo;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"LEESBURG"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"54"</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">&rsquo;Rover&rsquo;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"A&E"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"55"</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">&rsquo;SPGEng&rsquo; &rsquo;Emperor&rsquo;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"A&E"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"56"</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">&rsquo;Thud&rsquo;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"A&E"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"60"</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">&rsquo;Adelie&rsquo; &rsquo;Daisy&rsquo; &rsquo;RockHopper&rsquo; </span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"BAYHILL"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"62"</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">&rsquo;Bud&rsquo;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"?"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ p from: printers do⦂ [a append: p; cr].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">a append: &rsquo;same printer&rsquo;; cr; append: &rsquo;no printer&rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">printerMenu &larr; Menu new string: a contents]</span></div>
<div class="line left">
<span class="bold small">closeEntity </span><span class="small">[self closeEntity: SMentity]</span></div>
<div class="line left">
<span class="bold small">closeEntity: etype </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">EL wordposition = ELstart⇒ []<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"Put a trailer into the EL"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">EL</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">padNext &larr; 0377;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"word-pad EL with &lt;Nop&gt;"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">next &larr; etype;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">next&larr; 0; </span><span class="italic small">"fontset"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"dlstart relative to DL location in file"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nextNumber: 4 &larr; DLstart - (Pstart*recordsize);<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nextNumber: 4 &larr; DL position - DLstart;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nextPoint&larr; eorigin; </span><span class="italic small">"entity origin"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nextPoint&larr; boundbox origin;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nextPoint&larr; boundbox extent.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">EL nextword &larr; EL wordposition - ELstart + 1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self startEntity]</span></div>
<div class="line left">
<span class="bold small">closePage </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self closeEntity.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">EL empty⇒ []<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">DL</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">padNext &larr; 0;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nextword &larr; 0;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">append: EL asReadStream.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self part: 0 start: Pstart]</span></div>
<div class="line left">
<span class="bold small">data </span><span class="small">["slightly dangerous" ⇑DL]</span></div>
<div class="line left">
<span class="bold small">padpage </span><span class="small">["</span><span class="italic small">words of padding to end of page</span><span class="small">" ⇑(DL pad: recordsize with: 0) / 2]</span></div>
<div class="line left">
<span class="bold small">padword </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"make object (lines or dots) start on word boundary"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[DL padNext &larr; 0⇒ [self skipchars: 1]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑DL wordposition]</span></div>
<div class="line left">
<span class="bold small">part⦂ exp code: c </span><span class="small">| fp [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self closePage.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">fp &larr; self recordnum.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">exp eval.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self part: c start: fp]</span></div>
<div class="line left">
<span class="bold small">part: type start: start </span><span class="small">| padding</span><span class="bold small"> </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">padding &larr; self padpage.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">parts nextword &larr; type;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nextword &larr; start;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nextword &larr; self recordnum - start;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nextword &larr; padding.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self startPage]</span></div>
<div class="line left">
<span class="bold small">recordnum </span><span class="small">[⇑DL positionSize: recordsize]</span></div>
<div class="line left">
<span class="bold small">skipcode: code data: s </span><span class="small">| t [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">called by </span><span class="bold small">hidePress:complete:</span><span class="italic small">. s is a String</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(t &larr; s length+1) &lt; 256⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">immediate, in EL</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self skipcontrol: t.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">EL next &larr; code; append: s]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">in DL</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">DL next &larr; code; append: s.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self skipcontrol: t type: SMentity]</span></div>
<div class="line left">
<span class="bold small">startEntity </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">DLstart &larr; DL position.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">ELstart &larr; EL wordposition.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">boundbox &larr; 0 asRectangle.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">eorigin &larr; 0⌾0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">estate all &larr; ¬1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">estate◦1 &larr; 0]</span></div>
<div class="line left">
<span class="bold small">startPage </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">EL reset.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">Pstart &larr; self recordnum.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self startEntity]</span></div>
<div class="line left">
<span class="bold large"><br>Reading</span></div>
<div class="line left">
<span class="bold small">filin </span><span class="small">| p [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self open.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ (p &larr; self nextParagraph) do⦂ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">FilinSource &larr; self.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user print: nilⓢ p text; space].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">FilinSource &larr; nil.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self close]</span></div>
<div class="line left">
<span class="bold small">nextControl </span><span class="small">| command t entity [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">return the next skip-control information</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">command &larr; nil.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ true do⦂ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(estate and⦂ command)≡false⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">either or both false. get next entity</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">t &larr; EL next⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">estate &larr; EL next viewer. command &larr; nil.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">t◦1 ≠ SMentity⇒ ["ignore this entity" estate &larr; false]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">DLstart &larr; (t◦(3 to: 6)) asStream nextNumber: 4.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">DL position &larr; Pstart*recordsize + DLstart]<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">no more entities on current part (page)</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self readPart⇒ []<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">no more pages</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑false]<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">entity &larr; estate.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ (command &larr; entity next) do⦂ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">some stuff arranged by probable frequency</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">command<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">&lt; 0100⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="bold small">show-characters-short</span><span class="small"> (0-037)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold small">skip-characters-short</span><span class="small"> (040-077)"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">DL skip: (command land: 037) +1];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">= 0356⇒ ["</span><span class="bold small">set-x"</span><span class="small"> entity nextword];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">= 0357⇒ ["</span><span class="bold small">set-y</span><span class="small">" entity nextword];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">&lt; 0140⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="bold small">show-characters-and-skip</span><span class="small"> (0100-0137)"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">DL skip: (command land: 037) +2];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">&lt; 0160⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="bold small">set-space-x-short</span><span class="small"> (0140-0147)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold small">set-space-y-short</span><span class="small">  (0150-0157)"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"(command land: 7)*256 +" entity next];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">&lt; 0200⇒ ["</span><span class="bold small">font</span><span class="small">" "command land: 017"];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">= 0362⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="bold small">skip-control-bytes</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">t &larr; entity nextword.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">entity next≠SMentity⇒ ["ignore" DL skip: t]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑DL next: t];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">= 0360⇒ ["</span><span class="bold small">show-characters</span><span class="small">" DL skip: entity next];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">= 0377⇒ ["</span><span class="bold small">nop</span><span class="small">"];<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">&lt; 0353⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="bold small">available</span><span class="small"> (0200-0237)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold small">spare</span><span class="small"> (0240-0352)"];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">= 0353⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="bold small">skip-control-bytes-immediate</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑entity next: entity next];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">= 0354⇒ ["</span><span class="bold small">alternative</span><span class="small">" entity skipwords: 5];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">= 0355⇒ ["</span><span class="bold small">only-on-copy</span><span class="small">" entity next];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">= 0361⇒ ["</span><span class="bold small">skip characters</span><span class="small">" DL skip: entity next];<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">= 0363⇒ ["</span><span class="bold small">show-character-immediate</span><span class="small">" entity next];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">&lt; 0366⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="bold small">set-space-x</span><span class="small"> (0364)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold small">set-space-y</span><span class="small"> (0365)" entity nextword];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">&lt; 0370⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="bold small">reset-space</span><span class="small"> (0366)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold small">space</span><span class="small"> (0367)" ];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">&lt; 0373⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="bold small">set-brightness</span><span class="small"> (0370)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold small">set-hue</span><span class="small"> (0371)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold small">set-saturation</span><span class="small"> (0372)" entity next];<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">= 0373⇒ ["</span><span class="bold small">show-object</span><span class="small">" DL skipwords: entity nextword];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">&lt; 0376⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="bold small">show-dots</span><span class="small"> (0374)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold small">show-dots-opaque</span><span class="small"> (0375)"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">DL skipwords: (entity nextNumber: 4)];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">= 0376⇒ ["</span><span class="bold small">show-rectangle</span><span class="small">" entity skipwords: 2]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]]]</span></div>
<div class="line left">
<span class="bold small">nextParagraph </span><span class="small">| s p [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s &larr; self nextControl⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s &larr; s asStream.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">p &larr; Paragraph new.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s next = p pressCode⇒ [⇑p fromPress: self value: s]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑false]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑false]</span></div>
<div class="line left">
<span class="bold small">open </span><span class="small">| t [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">read the parts (and font directory?)</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">DL readonly; "reopen?" settoend; skip: 0 - recordsize.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">DL nextword = 27183 and⦂ DL nextword = (self recordnum + 1)⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">t &larr; DL nextword.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">DL position: DL nextword size: recordsize.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">parts &larr; (DL next: t*8) viewer.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self readPart]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self error: &rsquo;not a press file&rsquo;]</span></div>
<div class="line left">
<span class="bold small">readPart </span><span class="small">| t [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">read parts until we find a printed page or end</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">estate &larr; false.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ (t &larr; parts nextword) do⦂ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">Pstart &larr; parts nextword.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">t ≠ 0⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">not a printed page</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">parts skip: 4.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">t&gt; 0⇒ ["font or other part"]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">a non-standard part. let document (estate?) interpret</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"DL position &larr; Pstart*recordsize.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">estate fromPress: self name: t value: DL"]<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">go to end of last record of entity list, ignoring padding</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">t &larr; parts nextword "</span><span class="italic small">length</span><span class="small">".<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">DL position &larr; Pstart+t * recordsize - ((1 + parts nextword) * 2).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">EL &larr; Set new vector: 50.<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">scan backwards for beginning of entity list, reading entities</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ (t &larr; DL nextword) &gt; 0 do⦂ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">t &lt; 12⇒ [user notify: &rsquo;illegal entity&rsquo;]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">DL skipwords: 0-t.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">read entity and trailer (last 12 words of entity)</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">EL next &larr; DL next: t-12 *2.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">EL next &larr; DL next: 24.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">DL skipwords: ¬1 - t].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">now reverse:  trailer, entity (1st), ... (last)</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑EL &larr; (EL asArray◦(EL length to: 1 by: ¬1)) asStream]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑false]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪PressFile under: &rsquo;Press File Support&rsquo;.</span></div>
<div class="line left">
<span class="small">PressFile classInit</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"WidthTable"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;WidthTable&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: Object<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;name "&lt;String&gt; name of font family"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">pointsize "&lt;Integer&gt; size in points"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">face "&lt;Integer&gt; Press face code"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">min "&lt;Integer&gt; min character code in font"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">max "&lt;integer&gt; max character code in font"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">"Ascent, descent, and width are in micas"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">ascent "&lt;Integer&gt; max ascent of characters in font"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">descent "&lt;Integer&gt; NEGATIVE max descent of characters in font"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">widths "&lt;Vector of Integers&gt; widths of characters"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;tab WidthDict &rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>Holds font parameters and width table for a Press font.  It knows how to load itself from FONTS.WIDTHS.</span></div>
<div class="line left">
<span class="bold large"><br>Initialization</span></div>
<div class="line left">
<span class="bold small">classInit<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[WidthDict &larr; Dictionary init.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">tab &larr; 500]</span></div>
<div class="line left">
<span class="bold small">lookup </span><span class="small">| key font i [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">key &larr; name + pointsize asString + (↪(&rsquo;&rsquo; &rsquo;I&rsquo; &rsquo;B&rsquo; &rsquo;BI&rsquo;)◦(face+1)).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">font &larr; WidthDict lookup: key⇒ [⇑font]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self fontfrom: (dp0 oldFile: &rsquo;Fonts.Widths&rsquo;) readonly.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i from: ↪(011 015 040) do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[i ≥ min and⦂ i ≤ max ⇒ [widths◦(i-min+1) &larr; 0]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">WidthDict insert: key with: self.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑self]</span></div>
<div class="line left">
<span class="bold small">named: name pointsize: pointsize face: face</span></div>
<div class="line left">
<span class="bold large"><br>Access</span></div>
<div class="line left">
<span class="bold small">ascent </span><span class="small">[⇑ascent]</span></div>
<div class="line left">
<span class="bold small">descent </span><span class="small">[⇑descent]</span></div>
<div class="line left">
<span class="bold small">face </span><span class="small">[⇑face]</span></div>
<div class="line left">
<span class="bold small">max </span><span class="small">[⇑max]</span></div>
<div class="line left">
<span class="bold small">min </span><span class="small">[⇑min]</span></div>
<div class="line left">
<span class="bold small">name </span><span class="small">[⇑name]</span></div>
<div class="line left">
<span class="bold small">pointsize </span><span class="small">[⇑pointsize]</span></div>
<div class="line left">
<span class="bold small">scan: strm until: width exceeds: maxw </span><span class="small">| char w [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ (char &larr; strm next) do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[char &lt; min ⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[char=040 or⦂ (char=015 or⦂ char=011) ⇒ [⇑char, width]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user notify: &rsquo;char too low&rsquo;]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">char &gt; max ⇒ [user notify: &rsquo;char too high&rsquo;]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(w &larr; widths◦(char+1-min)) = 0 ⇒ [⇑char, width]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(width &larr; width + w) &gt; maxw ⇒ [⇑true, width]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑false, width]</span></div>
<div class="line left">
<span class="bold small">space </span><span class="small">[⇑150]</span></div>
<div class="line left">
<span class="bold small">tab </span><span class="small">[⇑tab]</span></div>
<div class="line left">
<span class="bold small">tab &larr; t </span><span class="small">[tab &larr; t]</span></div>
<div class="line left">
<span class="bold large"><br>Reading FONTS.WIDTHS</span></div>
<div class="line left">
<span class="bold small">findfield: n on: file </span><span class="small">| IXH [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">IXH &larr; file nextword.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(IXH bits: (0 to: 3)) "type"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">= 0 ⇒ [user notify: &rsquo;field not found&rsquo;];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">≠ n]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[file skipwords: (IXH land: 07777 "length") - 1]]</span></div>
<div class="line left">
<span class="bold small">fontfrom: file </span><span class="small">| i code fam fmin fmax start len found w scale<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"find code for font family"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">file reset. fam &larr; &rsquo;&rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">until⦂ (fam = name) do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self findfield: 1 on: file.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">code &larr; file nextword.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">fam &larr; file next: (len &larr; file next).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">file skip: 19 - len].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"now search for proper face"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">found &larr; false.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"Convert from points to micas"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">scale &larr; (pointsize asFloat * 2540 / 72) asInteger.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">until⦂ found do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self findfield: 4 on: file.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">found &larr; [file next = code].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[file next ≠ face ⇒ [found &larr; false]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">fmin &larr; file next.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">fmax &larr; file next.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">i &larr; file nextword. [i ≠ scale and: i ≠ 0 ⇒ [found &larr; false]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">file skip: 4. start &larr; file nextword. file skip: 4].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">scale &larr; [i ≠ 0 ⇒ [1 </span><span class="italic small">"don&rsquo;t need to scale"</span><span class="small">] pointsize asFloat * 254 / 7200].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">min &larr; fmin. max &larr; fmax.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"get bb and x-tables"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">file wordposition&larr; start+1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">descent &larr; 0 - (scale * file nextword) asInteger.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">file nextword.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">ascent &larr; (scale * file nextword) asInteger.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">file nextword.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">widths &larr; Vector new: (max - min + 1).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: widths length do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[w &larr; file nextword.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">widths◦i &larr; [w &gt; 0 ⇒ [(scale * w) asInteger] 0]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">file close]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪WidthTable under: &rsquo;Press File Support&rsquo;.</span></div>
<div class="line left">
<span class="small">WidthTable classInit</span></div>
    <div class="line left">
<span class="small">&rsquo;From Smalltalk 5.5k XM November 24 on 22 November 1980 at 2:57:08 am.&rsquo;<br></span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large">"Decompiler"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;Decompiler&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: Object<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;method temps instvars literals stack isReference literalNames&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;breakPC highlight &rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">sharing: ByteCodes;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>This class has not yet been commented</span></div>
<div class="line left">
<span class="bold large"><br>Initialization</span></div>
<div class="line left">
<span class="bold small">decompile: sel class: class </span><span class="small">| strm block ignore p<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[method &larr; class method: sel.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">method length&lt;8⇒[⇑self quickCode: sel class: class]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self initSymbols: class.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">stack &larr; (Vector new: (method◦3)-(method◦5)) asStream.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">block &larr; self block: method◦6+1 to: method length<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pc⦂ ignore hasValue⦂ ignore.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">stack empty≡false⇒[user notify: &rsquo;stack not empty&rsquo;]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self convertMacros: block sel: sel.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">strm &larr; Stream default.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self printPattern: sel on: strm.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">strm crtab: 1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">block printon: strm indent: 1 precedence: 0 forValue: false decompiler: self.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[(p&larr;method word: 1)≠0⇒[strm append: &rsquo; primitive: &rsquo;; print: p]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑strm contents asParagraph makeBoldPattern]</span></div>
<div class="line left">
<span class="bold small">findPC: x </span><span class="small">[breakPC&larr; x. highlight&larr; 1 to: 1]</span></div>
<div class="line left">
<span class="bold small">highlight </span><span class="small">[⇑highlight]</span></div>
<div class="line left">
<span class="bold small">highlight: x </span><span class="small">[⇑highlight&larr; x]</span></div>
<div class="line left">
<span class="bold large"><br>Symbols</span></div>
<div class="line left">
<span class="bold small">initSymbols: class </span><span class="small">| i lit env<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["</span><span class="italic small">Init temps with made-up names</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">temps &larr; Vector new: method◦5.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: temps length do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[temps◦i &larr; &rsquo;t&rsquo; + i asString].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">instvars &larr; class instvars.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">literals &larr; MessageDict new literalsIn: method.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">literalNames &larr; Vector new: literals length.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">env &larr; class wholeEnvironment, Smalltalk, Undeclared.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: literals length do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[lit &larr; literals◦i.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">literalNames◦i &larr;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[lit is: UniqueString⇒[lit]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">lit is: ObjectReference⇒[self invertRef: lit environment: env]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">lit≡FieldReference⇒[&rsquo;&rsquo;]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">lit asString]]]</span></div>
<div class="line left">
<span class="bold small">instvar: i<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑instvars◦(i-codeLoadField+1)]</span></div>
<div class="line left">
<span class="bold small">invertRef: ref environment: env </span><span class="small">| table n<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[for⦂ table from: env do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[n&larr;table invertRef: ref⇒[⇑n]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑&rsquo;unknown&rsquo;]</span></div>
<div class="line left">
<span class="bold small">literal: i </span><span class="small">| index lit str<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[index &larr; i-codeLoadLit+1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">lit &larr; literals◦index.  str &larr; literalNames◦index.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">lit is: ObjectReference⇒[⇑str]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(lit is: UniqueString) or⦂ (lit is: Vector)⇒[⇑&rsquo;↪&rsquo; + str]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑str]</span></div>
<div class="line left">
<span class="bold small">literalIndirect: i<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑literalNames◦(i-codeLoadLitInd+1)]</span></div>
<div class="line left">
<span class="bold small">selector: i <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[i&gt;166 and⦂ i&lt;208⇒[⇑SpecialOops◦(i-166)]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑literalNames◦(i-codeSendLit+1)]</span></div>
<div class="line left">
<span class="bold small">temp: i<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑temps◦(i-codeLoadTemp+1)]</span></div>
<div class="line left">
<span class="bold large"><br>Byte Interpretation</span></div>
<div class="line left">
<span class="bold small">block: start to: end pc⦂ pc hasValue⦂ v<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">| block code byte j stackPos t<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["Decompile the method from start to end into a ParsedBlock and return the<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">instance of ParsedBlock.  Assign to pc the value of the pc after leaving<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">the block.  If at run time this block will leave a value on the stack,<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">set hasValue to true."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">block &larr; ParsedBlock default. pc value&larr; end+1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">stackPos &larr; stack position.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">code &larr; Stream new of: method from: start to: end.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ byte from: code do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[byte&lt;0200⇒[self loadByte: byte code: code]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">byte&lt;0210⇒[self controlByte: byte code: code block: block]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">byte&lt;0214⇒[self loadByte: byte code: code  "extended loads"]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">byte=0214⇒[self selectorByte: byte code: code at: code position  "extended selector"]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">byte&lt;0260⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[j&larr;self jumpByte: byte code: code block: block.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">code end⇒[pc value&larr;j]]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self selectorByte: byte code: code at: code position]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"If there is an additional item on the stack, it will be the value<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">of this block"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">stack position&gt;stackPos⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[t&larr;stack pop.  v value&larr;true.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">block empty and⦂ (t is: ParsedBlock)⇒[⇑t]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">block next&larr; t.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑block]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">v value&larr;false.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[block empty⇒[block next&larr; nil]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"pretend that returns jump to end of method"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[block returns or⦂ (block◦block position) returns⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[pc value&larr; method length+1]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑block]</span></div>
<div class="line left">
<span class="bold small">checkForRemoteCode: jump code: code block: block </span><span class="small">| m ignore t j b<br>"</span><span class="italic small">Check if this is a jump around remote code.</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[jump&gt;code limit⇒[⇑false]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">remote code should terminate with a </span><span class="small italic underline">toEnd</span><span class="italic small">, and then a jump back</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">method◦(jump-3)≠toEnd⇒[⇑false]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">t &larr; method◦(jump-2).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">t&lt;0240 or⦂ t&gt;0243⇒[⇑false]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">j &larr; t-0244*256+(method◦(jump-1)).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">jump+j ≠ (code position+1) ⇒[⇑false]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">m &larr; stack pop.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">((m isnt: ParsedMessage) or⦂ m rcvr≡toLoadThisCtxt≡false) or⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(self selector: m op)≠↪remoteCopy⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[stack next&larr; m.  ⇑false]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">it&rsquo;s a piece of remote code</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">b &larr; self block: code position+1 to: jump-4<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pc⦂ ignore hasValue⦂ ignore.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">stack next&larr; ParsedRemote new expr: b.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">code position&larr; jump-1]</span></div>
<div class="line left">
<span class="bold small">conditionalJump: elseStart code: code block: block<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">| cond ifExpr thenExpr elseExpr thenJump elseJump ignore newBlock<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">hasValue last<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ifExpr &larr; stack pop.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">thenExpr &larr; self block: code position+1 to: elseStart-1<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pc⦂ thenJump hasValue⦂ hasValue.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">ensure jump is within block (in case thenExpr returns)</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">thenJump &larr; thenJump min: code limit+1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">if jump goes back, then it&rsquo;s a loop</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">thenJump&lt;elseStart⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self loop: thenJump whileExpr: ifExpr doExpr: thenExpr<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">code: code block: block doSize: elseStart-code position-1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">code position&larr; elseStart-1]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">elseExpr &larr; self block: elseStart to: thenJump-1<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pc⦂ elseJump hasValue⦂ ignore.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">if </span><span class="small italic underline">elseJump</span><span class="italic small"> is backwards, it is not part of the elseExpr</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[elseJump&lt;code position⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[code position&larr; thenJump-3.  last&larr;true] <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">code position&larr; thenJump-1].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[thenJump+1=code limit  "</span><span class="italic small">still might be last</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">and⦂ (method◦thenJump≥0240 and⦂ method◦thenJump≤0247)⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[last&larr;true]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[thenJump=code limit<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">and⦂ (method◦thenJump≥0220 and⦂ method◦thenJump≤0227)⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[last&larr;true]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">check for and⦂ or or⦂</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">hasValue and⦂ (thenExpr position=1 and⦂ thenExpr◦1≡toLoadTrue)⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[stack next&larr; ParsedDisjunct new left: ifExpr right:<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[elseExpr position=1⇒[elseExpr◦1] elseExpr] ]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">hasValue and⦂ (elseExpr position=1 and⦂ elseExpr◦1≡toLoadFalse)⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[stack next&larr; ParsedConjunct new left: ifExpr right:<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[thenExpr position=1⇒[thenExpr◦1] thenExpr] ]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">it&rsquo;s an if statement</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">cond &larr; ParsedConditional new<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">ifExpr: ifExpr thenExpr: thenExpr elseExpr: elseExpr.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">If the then part has a value, put the conditional in a block, and put the<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">block on the stack.  (If the compiler is working right the else part will<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">leave a value, too ... this is not checked).</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">hasValue⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[newBlock&larr;ParsedBlock default.  newBlock next&larr; cond.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">stack next&larr; newBlock]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">If the thenExpr jumps to the end of the current block,<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">or to a jump backwards at the end of the current block,<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">or to a ⇑self at the end of the method,<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">append the cond<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">to the current block.  Otherwise, embed it in a new block.</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(code end or⦂ last≡true) or⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(thenJump+1=method length and⦂ method◦thenJump=toLoadSelf)⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[block next&larr; cond]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">newBlock&larr;ParsedBlock default.  newBlock next&larr; cond.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">block next&larr; newBlock]</span></div>
<div class="line left">
<span class="bold small">controlByte: byte code: code block: block </span><span class="small">| var t strm<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[byte=toSmashPop⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[var &larr; self makeLoad: code next code: code.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">block next&larr; ParsedAssignment new var: var expr: stack pop]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">byte=toSmash⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["</span><span class="italic small">smash no pop at the end of a block will require the next byte<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">to be fetched from after the limit of the block</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">code end⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[strm &larr; Stream new of: method from: code limit+1 to: method length.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">var &larr; self makeLoad: strm next code: strm.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">block next&larr; ParsedAssignment new var: var expr: stack pop]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">var &larr; self makeLoad: code next code: code.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">block next&larr; ParsedAssignment new var: var expr: stack pop.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">uncascade assignment statements</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">stack next&larr; var]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">byte=toPop⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[block next&larr; stack pop]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">byte=toReturn⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[t &larr; stack pop.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">stack empty≡false⇒[user notify: &rsquo;stack not empty&rsquo;]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">elide final ⇑self</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">t≡toLoadSelf and⦂ code position=method length⇒[]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">block doesReturn.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">block next&larr; t]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">byte=toEnd⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[user notify: &rsquo;unexpected&rsquo;]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">byte=toLoadThisCtxt⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[stack next&larr; byte]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">byte=toSuper⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[stack pop.  "</span><span class="italic small">delete ref to self</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">stack next&larr; byte]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user notify: &rsquo;unknown control byte&rsquo;]</span></div>
<div class="line left">
<span class="bold small">jumpByte: byte code: code block: block </span><span class="small">| offset j<br>"</span><span class="italic small">If this is an unconditional jump, return the position in the method to which it jumps.  If this is a conditional jump forward, parse a conditional statement.  Conditional jumps backward are not produced by the current compiler.</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[byte&lt;0230⇒["</span><span class="italic small">short unconditional jump forward</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑byte-0220+code position+2]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">byte&lt;0240⇒["</span><span class="italic small">short conditional jump forward</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self conditionalJump: byte-0230+code position+2 code: code block: block.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑code position+1]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">byte&lt;0250⇒["</span><span class="italic small">long unconditional jump</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">offset &larr;  code next.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">j &larr; byte-0244*256+offset+code position+1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self checkForRemoteCode: j code: code block: block.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑j]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">byte&lt;0254⇒[code skip: 1.  "long conditional jump backward"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user notify: &rsquo;conditional jump backward not expected&rsquo;]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">byte&lt;0260⇒["</span><span class="italic small">long conditional jump forward</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">offset &larr; code next.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self conditionalJump: byte-0254*256+offset+code position+1<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">code: code block: block.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑code position+1]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user notify: &rsquo;not a jump byte&rsquo;]</span></div>
<div class="line left">
<span class="bold small">loadByte: byte code: code </span><span class="small">| t lit<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[t &larr; self makeLoad: byte code: code.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">t≥codeLoadLit and⦂ t&lt;codeLoadLitInd⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[lit &larr; literals◦(t-codeLoadLit+1).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">lit≡FieldReference⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self remoteReference: code]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">lit is: ObjectReference⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[stack next&larr; ParsedObjectReference new var: t]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">stack next&larr; t]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">stack next&larr; t]</span></div>
<div class="line left">
<span class="bold small">loop: jumpBack whileExpr: whileExpr doExpr: doExpr code: code block: block<br>doSize: doSize<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">| n b ignore<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["</span><span class="italic small">jumpBack will jump to the beginning of whileExpr.  In the case of for statements or while&rsquo;s with a block in the condition, the whileExpr should include more than just the last expression.  Kludge: find all the statements needed by re-decompiling.</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">n &larr; code position-doSize jmpSize.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">b &larr; self block: jumpBack to: n pc⦂ ignore hasValue⦂ ignore.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">discard unwanted statements from block</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">block skip: 1-b position.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">block next&larr; ParsedLoop new <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">whileExpr: [b position=1⇒[whileExpr] b] doExpr: doExpr]</span></div>
<div class="line left">
<span class="bold small">makeLoad: byte code: code </span><span class="small">| offset<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["</span><span class="italic small">check for extended loads</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">byte≥0210 and⦂ byte≤0213⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["</span><span class="italic small">extended reference codes:<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">0210 - extended inst<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">0211 - extended temp<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">0212 - extended literal<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">0213 - extended literal indirect"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">offset&larr;256*(byte-0207).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑code next+offset]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> ⇑byte asCompilerCode]</span></div>
<div class="line left">
<span class="bold small">remoteReference: code </span><span class="small">| i obj offset var<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[i &larr; stack pop.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">offset &larr; [i≤124⇒[↪(0 1 2 10)◦(i-120)] literals◦(i-codeLoadLit+1)].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">obj &larr; stack pop.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">code skip: 2.  "</span><span class="italic small">skip </span><span class="small italic underline">new</span><span class="italic small"> </span><span class="small italic underline">object:offset:</span><span class="italic small"> </span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">var &larr; [obj=toLoadTempframe⇒[codeLoadTemp+offset-1]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">obj=toLoadSelf⇒[codeLoadField+offset-1]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user notify: &rsquo;bad remote reference&rsquo;].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">stack next&larr; ParsedFieldReference new var: var]</span></div>
<div class="line left">
<span class="bold small">selectorByte: byte code: code at: p </span><span class="small">| op sel i nArgs args rcvr<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["check for extended selector codes"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">op &larr; [byte=toSendLitLong⇒[code next+codeSendLit] byte asCompilerCode].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"find the corresponding selector and the number of args it expects"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">sel &larr; self selector: op.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nArgs &larr; sel numArgs.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">rcvr &larr; stack pop.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[nArgs=0⇒[args&larr;false]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> nArgs=1⇒[args&larr;stack pop]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> args &larr; Vector new: nArgs.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> for⦂ i from: nArgs to: 1 by: ¬1 do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[args◦i &larr; stack pop]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">stack next&larr; ParsedMessage new rcvr: rcvr op: op args: args.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">p=breakPC⇒[stack last hasPC]]</span></div>
<div class="line left">
<span class="bold large"><br>Macros</span></div>
<div class="line left">
<span class="bold small">convertMacros: block sel: sel </span><span class="small">| macros compilerTemps vec loc i<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["</span><span class="italic small">replace statement patterns with corresponding macros when possible</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">macros &larr; (Vector new: 10) asStream.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">for each temp, compilerTemps is false if it is a user temp, true if it is a<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">compiler temp, and nil if not yet known</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">compilerTemps &larr; Vector new: temps length.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: sel numArgs do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[compilerTemps◦i &larr; false].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">block findMacros: macros compilerTemps: compilerTemps.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">insert macros in reverse order to keep indices from being messed up</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">vec &larr; macros contents.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i from: vec length-1 to: 1 by: ¬2 do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[vec◦i≡nil⇒[]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">vec◦i insertMacro: vec◦(i+1) decompiler: self].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">set names of compiler temps to empty string</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: temps length do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[compilerTemps◦i≡true⇒[temps◦i &larr; &rsquo;&rsquo;]]]</span></div>
<div class="line left">
<span class="bold large"><br>Printing</span></div>
<div class="line left">
<span class="bold small">printPattern: sel on: strm </span><span class="small">| i n keywords<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[n&larr;sel numArgs.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[n=0⇒[strm append: sel; space  "</span><span class="italic small">unary</span><span class="small">"]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> keywords&larr;sel keywords.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> for⦂ i to: keywords length do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[strm append: keywords◦i; space; append: temps◦i; space]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">n=(method◦5)⇒[]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">strm append: &rsquo;| &rsquo;.   "</span><span class="italic small">temps beyond args</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i from: n+1 to: method◦5 do⦂ [strm append: temps◦i; space]]</span></div>
<div class="line left">
<span class="bold small">quickCode: sel class: class </span><span class="small">| t strm<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[method length=2⇒[⇑sel asParagraph makeBoldPattern]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">method length=5⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[t &larr; method◦5.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">strm &larr; Stream default.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">strm append: sel; append: &rsquo; [⇑&rsquo;; append: class instvars◦(t+1); append: &rsquo;]&rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑strm contents asParagraph makeBoldPattern]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑&rsquo;undeciperable method&rsquo; asParagraph]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪Decompiler under: &rsquo;Compiler&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"Generator"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;Generator&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: Object<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;literals nTemps maxTemp local environment parser supered root requestor sourceStream sourceParagraph&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;&rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">sharing: ByteCodes;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>I generate code parsed by parser.  The symbol tables I use are local and environment.  The run-time needs of the code are recorded in literals, nTemps, and maxTemp.  If a message was passed to super, then supered is true.  I remember my root context to abort in case of error.</span></div>
<div class="line left">
<span class="bold large"><br>Services</span></div>
<div class="line left">
<span class="bold small">compile: sourceParagraph in: class under: category notifying: requestor </span><span class="small">| selector<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[user displayoffwhile⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[sourceStream &larr; sourceParagraph asStream.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">selector &larr; self compileIn: class⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[class organization classify: selector under: category]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑selector]</span></div>
<div class="line left">
<span class="bold small">evaluate: sourceStream in: context to: receiver notifying: requestor<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">| method nvars value tframe<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[method &larr; user displayoffwhile⦂ [self evaluateIn: context to: receiver].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">root≡true≡false⇒ [⇑method] </span><span class="italic small">"compilation failed, return false or corrected value"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nvars &larr; nTemps.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">context⇒ </span><span class="italic small">"frame copy here because interpret loses control"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[tframe &larr; context tempframe◦(1 to: nvars) copyto: (Vector new: method◦3).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">value &larr; context interpret: method with: tframe.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">tframe◦(1 to: nvars) copyto: context tempframe.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑value]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑Context new have: receiver interpret: method]</span></div>
<div class="line left">
<span class="bold large"><br>Errors</span></div>
<div class="line left">
<span class="bold small">abortWith: errorString </span><span class="small">| mySender<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[[WhatFlag⇒ [user notify: errorString]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">mySender &larr; thisContext swapSender: root sender.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">root sender &larr; nil. root &larr; nil. parser terminate.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">mySender release. mySender &larr; nil.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user restoredisplay.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑requestor notify: errorString at: sourceStream position in: sourceStream]<br></span><span class="italic small">"Parser notify"</span></div>
<div class="line left">
<span class="bold small">notify: errorString<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[parser notify: errorString]<br></span><span class="italic small">"ParsedObjectReference remote"</span></div>
<div class="line left">
<span class="bold small">terminate<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[root &larr; nil]<br></span><span class="italic small">"Parser terminate"</span></div>
<div class="line left">
<span class="bold large"><br>Code generation</span></div>
<div class="line left">
<span class="bold small">compileIn: class<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">| block method nargs selector primitive<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[parser &larr; Parser new. root &larr; thisContext. parser from: sourceStream to: self.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self initSymbols: class.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">block &larr; ParsedBlock default.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">selector &larr; parser pattern: block. nargs &larr; nTemps.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">parser temporaries: block. primitive &larr; parser body: block.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">parser mustBeDone. parser &larr; nil.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">block mustReturn: true </span><span class="italic small">"defaults to ⇑self"</span><span class="small">.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[method &larr; [primitive=0 and⦂ nargs=0⇒ [block quickCode] false]⇒ []<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">method &larr; self generate: block in: class.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">method◦2 &larr; primitive; ◦4 &larr; nargs].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">class install: selector method: method literals: literals<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">code: [sourceParagraph is: Paragraph⇒ [sourceParagraph]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">sourceStream asArray] backpointers: nil.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[HuhFlag⇒ [Huh&larr;nil. Huh &larr; (self decompile: method onto: Stream default) contents. HuhFlag&larr;false]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑selector]<br></span><span class="italic small">"compile"</span></div>
<div class="line left">
<span class="bold small">decompile: method onto: s<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[method length&lt;6⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[s append: &rsquo;Quick code: &rsquo;; append: method asBytes. ⇑s]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s print: method◦4; append: &rsquo; args; &rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">print: method◦5; append: &rsquo; temps; &rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">print: (method◦3) - (method◦5); append: &rsquo; stack; &rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">print: (method◦6) -6 /2; append: &rsquo; literals; &rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[(method◦2) &gt; 0⇒ [s append: &rsquo; primitive: &rsquo;; print: method◦2; append: &rsquo;;&rsquo;]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s print: method length; append: &rsquo; bytes total.&rsquo;; cr.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">method◦2 = 40⇒ [⇑s]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑self decompileBytes: method onto: s]</span></div>
<div class="line left">
<span class="bold small">decompileBytes: method onto: s<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">| dict x i c m t<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[dict &larr; Dictionary new init: 64.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">dict insertall: ((128 to: 131) copy, 125 concat: (144 to: 175) copy)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">with: ↪(<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">&rsquo;&larr;&uarr;&rsquo; &rsquo;&larr;&rsquo; &rsquo;&uarr;&rsquo; &rsquo;⇑&rsquo; &rsquo;end&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">&rsquo;jmp1&rsquo; &rsquo;jmp2&rsquo; &rsquo;jmp3 &rsquo; &rsquo;jmp4&rsquo; &rsquo;jmp5&rsquo; &rsquo;jmp6&rsquo; &rsquo;jmp7&rsquo; &rsquo;jmp8&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">&rsquo;bfp1&rsquo; &rsquo;bfp2&rsquo; &rsquo;bfp3 &rsquo; &rsquo;bfp4&rsquo; &rsquo;bfp5&rsquo; &rsquo;bfp6&rsquo; &rsquo;bfp7&rsquo; &rsquo;bfp8&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">&rsquo;jmp&rsquo; &rsquo;jmp&rsquo; &rsquo;jmp&rsquo; &rsquo;jmp&rsquo; &rsquo;jmp&rsquo; &rsquo;jmp&rsquo; &rsquo;jmp&rsquo; &rsquo;jmp&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">&rsquo;bfp&rsquo; &rsquo;bfp&rsquo; &rsquo;bfp&rsquo; &rsquo;bfp&rsquo; &rsquo;bfp&rsquo; &rsquo;bfp&rsquo; &rsquo;bfp&rsquo; &rsquo;bfp&rsquo;).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ x from: local contents do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[i&larr;local◦x. t &larr; i land: 255.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[i&gt;255 and⦂ t&lt;16⇒ [i&larr;((i lshift: ¬8)-1 lshift: 4) + t]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">dict insert: i with: x].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ x from: stdSelectors contents do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[dict insert: stdSelectors◦x with: [x is: Integer⇒ [x inString] x]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: 5 do⦂ [dict insert: toLoadConst+i-1 with: ↪(&rsquo;¬1&rsquo; &rsquo;0&rsquo; &rsquo;1&rsquo; &rsquo;2&rsquo; &rsquo;10&rsquo;)◦i].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ t from: (m &larr; (method◦(method◦6 +1 to: method length)) asStream) do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[[t≥toLoadFieldLong and⦂ t≤toSendLitLong⇒ [t&larr;((t-0207) lshift: 8)+ m next]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> [c &larr; dict lookup: t⇒ [s append: c] s append: &rsquo;#&rsquo;. s append: t base8].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> s space.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> t &lt; toLongJmp⇒ [] t ≥ 0260⇒ []<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> s print: t\8 -4 *256 + m next; space].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s cr.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑s]</span></div>
<div class="line left">
<span class="bold small">evaluateIn: context to: receiver<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">| block method class nvars<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ </span><span class="italic small">"If context is false, receiver will evaluate in top level"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">block &larr; ParsedBlock default.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">parser &larr; Parser new. root &larr; thisContext.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">parser from: sourceStream to: self.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[context⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self initSymbols: (class &larr; context mclass).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">context variableNamesInto: self with: ParsedBlock default.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nvars &larr; nTemps.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">root &larr; thisContext. </span><span class="italic small">"because variableNamesInto nil&rsquo;ed it"</span><span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> self initSymbols: (class &larr; receiver class)].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">parser temporaries: block; statements: block; mustBeDone. parser &larr; nil.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">block mustReturn: false </span><span class="italic small">"returns last value"</span><span class="small">.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">method &larr; self generate: block in: class.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[HuhFlag⇒ [Huh&larr;nil. Huh &larr; (self decompile: method onto: Stream default) contents. HuhFlag&larr;false]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">root &larr; true. </span><span class="italic small">"to signify success"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nTemps &larr; nvars.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑method]<br></span><span class="italic small">"evaluate"</span></div>
<div class="line left">
<span class="bold small">generate: block in: class<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">| header method code lit stack<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[[(lit &larr; literals find: nil)&gt;0⇒ [literals &larr; (literals◦(1 to: lit-1)) copy]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[supered⇒ [literals &larr; literals, (Smalltalk ref: class title unique)]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">header &larr; 6 + (2* literals length).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">code &larr; (method &larr; String new: header + block sizeForValue) asStream.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">code<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">next &larr; 0; next &larr; 0; next &larr; 0;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">next &larr; 0; next &larr; maxTemp; next &larr; header.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ lit from: literals do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[code next &larr; lit PTR lshift: ¬8; next &larr; lit PTR land: 0377].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">stack &larr; ParseStack init.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">block emitForValue: code on: stack.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[stack position≠1⇒ [user notify: &rsquo;Compiler stack discrepancy&rsquo;]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[code position≠method length⇒ [user notify: &rsquo;Compiler code size discrepancy&rsquo;]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">method◦3 &larr; maxTemp + stack length.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑method] </span><span class="italic small">"compile|evaluate"</span></div>
<div class="line left">
<span class="bold large"><br>Parse tree</span></div>
<div class="line left">
<span class="bold small">assignment: var expr: expr<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑ParsedAssignment new var: var expr: expr]<br></span><span class="italic small">"Parser expression"</span></div>
<div class="line left">
<span class="bold small">block<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑ParsedBlock default]<br></span><span class="italic small">"Parser primary|Parser alternatives"</span></div>
<div class="line left">
<span class="bold small">evalKeyword: arg<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑arg]<br></span><span class="italic small">"Parser keywordMessage"</span></div>
<div class="line left">
<span class="bold small">ifExpr: ifExpr thenExpr: thenExpr elseExpr: elseExpr<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑ParsedConditional new ifExpr: ifExpr thenExpr: thenExpr elseExpr: elseExpr]<br></span><span class="italic small">"ifthen...|Parser alternatives"</span></div>
<div class="line left">
<span class="bold small">keywordMessage: rcvr selector: sel args: args<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[sel=&rsquo;and⦂&rsquo;⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑ParsedConjunct new left: rcvr right: args local];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">  = &rsquo;or⦂&rsquo;⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑ParsedDisjunct new left: rcvr right: args local]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑self rcvr: rcvr selector: sel args: (args remote: self)]<br></span><span class="italic small">"Parser keywordMessage"</span></div>
<div class="line left">
<span class="bold small">noEvalKeyword: arg<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑arg asRemoteCode: self]<br></span><span class="italic small">"Parser keywordMessage"</span></div>
<div class="line left">
<span class="bold small">nullStatement: block<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[block next &larr; toLoadNil. ⇑block]<br></span><span class="italic small">"ifthen|Parser statements"</span></div>
<div class="line left">
<span class="bold small">rcvr: rcvr selector: sel args: args<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[[rcvr≡toSuper⇒ [supered&larr;true]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ParsedMessage new rcvr: rcvr op: (self encodeSel: sel) args: args]<br></span><span class="italic small">"loop|keywordMessage|Parser binaryMessage|Parser unaryMessage"</span></div>
<div class="line left">
<span class="bold small">receivingVar: expr </span><span class="small">| rcvr var </span><span class="italic small">"who in expr is cascade recipient"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[rcvr &larr; expr emittedReceiver⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[var &larr; rcvr emittedVariable⇒ [⇑var]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">var &larr; self newTemp. </span><span class="italic small">"if a non-variable, compute it just once"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">expr emittedReceiver &larr; ParsedAssignment new var: var expr: rcvr.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑var]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">parser notify: &rsquo;MAY ONLY FOLLOW A MESSAGE&rsquo;]<br></span><span class="italic small">"Parser cascade"</span></div>
<div class="line left">
<span class="bold small">variable: name<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">| var global ref unq<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[var &larr; local lookup: name⇒ [⇑var]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[unq &larr; name hasBeenUniqued⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[for⦂ global from: environment do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ref &larr; global lookupRef: unq⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑codeLoadLitInd + (self litIndex: ref)]]]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">requestor interactive⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[parser notify: &rsquo;➲Smalltalk declare: ↪&rsquo; + name + &rsquo; as: nil➲TO DECLARE GLOBAL&rsquo;]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user show: &rsquo; (&rsquo; + name + &rsquo; is Undeclared) &rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">unq &larr; name unique.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">Undeclared declare: unq.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑codeLoadLitInd + (self litIndex: (Undeclared ref: unq))]<br></span><span class="italic small">"Parser expression|Parser primary"</span></div>
<div class="line left">
<span class="bold large"><br>Macros</span></div>
<div class="line left">
<span class="bold small">for: var from: startMinus1 to: stop do: ritual on: block </span><span class="small">| temp<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[temp &larr; self newTempForMacro.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"temp&larr;stop. var&larr;startMinus1. while⦂ temp≥(var &larr; 1+var) do⦂ ritual"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">block next &larr; ParsedAssignment new var: temp expr: stop;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">next &larr; ParsedAssignment new var: var expr: startMinus1;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">next &larr; ParsedLoop new<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">whileExpr:<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(ParsedMessage new rcvr: temp op: toGeq args:<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(ParsedAssignment new var: var<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">expr: (ParsedMessage new rcvr: toLoad1 op: toPlus args: var)))<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">doExpr: ritual]<br></span><span class="italic small">"for...todoargs"</span></div>
<div class="line left">
<span class="bold small">forfromdo: block args: args </span><span class="small">| var sequence ritual strm<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[var &larr; (args◦1) local. sequence &larr; args◦2. ritual &larr; (args◦3) local.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">strm &larr; self newTempForMacro.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"strm &larr; sequence asStream. while⦂ (var &larr; strm next) do⦂ ritual"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">block next &larr; ParsedAssignment new var: strm<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">expr: (ParsedMessage new rcvr: sequence op: toAsStream args: false);<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">next &larr; ParsedLoop new<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">whileExpr:<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(ParsedAssignment new var: var<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">expr: (ParsedMessage new rcvr: strm op: toNext args: false))<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">doExpr: ritual]<br></span><span class="italic small">"macro (perform)"</span></div>
<div class="line left">
<span class="bold small">forfromtobydo: block args: args<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"for⦂ var from: (start to: stop by: step) do⦂ ritual"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">args◦2 &larr; self rcvr: args◦2 selector: &rsquo;to:by:&rsquo; args: (args◦(3 to: 4)) copy.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self forfromdo: block args: (args◦↪(1 2 5)) copy]<br></span><span class="italic small">"macro (perform)"</span></div>
<div class="line left">
<span class="bold small">forfromtodo: block args: args<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self for: (args◦1) local<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">from: (ParsedMessage new rcvr: args◦2 op: toMinus args: toLoad1)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">to: args◦3<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">do: (args◦4) local<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">on: block]<br></span><span class="italic small">"macro (perform)"</span></div>
<div class="line left">
<span class="bold small">fortodo: block args: args<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self for: (args◦1) local<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">from: toLoad0<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">to: args◦2<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">do: (args◦3) local<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">on: block]<br></span><span class="italic small">"macro (perform)"</span></div>
<div class="line left">
<span class="bold small">ifthen: block args: args<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[block next &larr; self ifExpr: (args◦1) local thenExpr: (args◦2) local elseExpr: (self nullStatement: ParsedBlock default)]<br></span><span class="italic small">"macro (perform)"</span></div>
<div class="line left">
<span class="bold small">ifthenelse: block args: args<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[block next &larr; self ifExpr: (args◦1) local thenExpr: (args◦2) local elseExpr: (args◦3) local]<br></span><span class="italic small">"macro (perform)"</span></div>
<div class="line left">
<span class="bold small">macro: block selector: sel args: args<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">| special<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[special &larr; inLineMsgs lookup: sel⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self perform: special with: block with: args]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">Context canunderstand: sel unique⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[block next &larr; self rcvr: toLoadThisCtxt selector: sel args: (args remote: self)]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑false]<br></span><span class="italic small">"Parser keywordMessage"</span></div>
<div class="line left">
<span class="bold small">untildo: block args: args<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[block next &larr; ParsedLoop new whileExpr: (ParsedNegation new rcvr: (args◦1) local op: toEq args: toLoadFalse) doExpr: (args◦2) local]<br></span><span class="italic small">"macro (perform)"</span></div>
<div class="line left">
<span class="bold small">whiledo: block args: args<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[block next &larr; ParsedLoop new whileExpr: (args◦1) local doExpr: (args◦2) local]<br></span><span class="italic small">"macro (perform)"</span></div>
<div class="line left">
<span class="bold large"><br>Table maintenance</span></div>
<div class="line left">
<span class="bold small">balance<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑nTemps]<br></span><span class="italic small">"Parser cascade"</span></div>
<div class="line left">
<span class="bold small">comment: s<br></span><span class="italic small">"Class fieldNamesInto"</span></div>
<div class="line left">
<span class="bold small">contents<br></span><span class="italic small">"Class fieldNamesInto"</span></div>
<div class="line left">
<span class="bold small">declaration: block name: name asArg: asArg<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">| permVar tempVar<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[tempVar &larr; self newTemp.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">permVar &larr; local lookup: name ⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[asArg and⦂ permVar isField⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[block next &larr; ParsedAssignment new var: permVar expr: tempVar]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">parser notify: &rsquo;NAME ALREADY IN USE&rsquo;]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">local insert: name with: tempVar]<br></span><span class="italic small">"Parser declaration|temporaries"</span></div>
<div class="line left">
<span class="bold small">encodeSel: sel<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">| code<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[code &larr; stdSelectors lookup: sel⇒ [⇑code]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑codeSendLit+ (self litIndex: [sel class≡Integer⇒ [UST1◦(sel+1)] sel unique])]<br></span><span class="italic small">"rcvr|ParsedFieldReference remote|ParsedRemote remote"</span></div>
<div class="line left">
<span class="bold small">identifier: s<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[local insert: s with: (nTemps &larr; nTemps + 1)]<br></span><span class="italic small">"Class fieldNamesInto"</span></div>
<div class="line left">
<span class="bold small">initSymbols: class | s<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[environment &larr; class wholeEnvironment, Smalltalk.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">local &larr; Dictionary new copyfrom: stdPrimaries.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nTemps &larr; codeLoadField-1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ s from: class instvars do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[local insert: s with: (nTemps &larr; nTemps + 1)].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nTemps &larr; maxTemp &larr; 0. literals &larr; Vector new: 123. supered &larr; false]<br></span><span class="italic small">"compile|evaluate"</span></div>
<div class="line left">
<span class="bold small">juggle </span><span class="small">| oldTemps<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[oldTemps &larr; maxTemp. maxTemp &larr; nTemps. ⇑oldTemps]<br></span><span class="italic small">"Parser macro"</span></div>
<div class="line left">
<span class="bold small">literal: x  </span><span class="small">| i<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[[x class≡Integer⇒ [0≠(i&larr;↪(¬1 0 1 2 10) find: x)⇒ [⇑toLoadConst+i-1]]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑codeLoadLit + (self litIndex: x)]<br></span><span class="italic small">"Parser primary|ParsedFieldReference remote"</span></div>
<div class="line left">
<span class="bold small">litIndex: oop  </span><span class="small">| i t<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[for⦂ i to: 123 do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[(t &larr; literals◦i)≡nil⇒ [literals◦i&larr;oop. ⇑i-1]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">t class≡oop class⇒ [t sameAs: oop⇒ [⇑i-1]]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">parser notify: &rsquo;MORE THAN 123 LITERALS REFERENCED&rsquo;]<br></span><span class="italic small">"encodeSel|literal"</span></div>
<div class="line left">
<span class="bold small">newTemp<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[(nTemps &larr; nTemps+1) &gt; maxTemp and⦂ (maxTemp &larr; nTemps) &gt; 256⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[parser notify: &rsquo;MORE THAN 256 TEMPS REQUIRED&rsquo;]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑codeLoadTemp + nTemps-1]<br></span><span class="italic small">"receivingVar|declaration"</span></div>
<div class="line left">
<span class="bold small">newTempForMacro </span><span class="italic small">"juggle arranged that maxTemp are needed by args of macro"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[nTemps &larr; maxTemp. ⇑self newTemp]<br></span><span class="italic small">"forfromdo|forfromtodo"</span></div>
<div class="line left">
<span class="bold small">separator: c<br></span><span class="italic small">"Class fieldNamesInto"</span></div>
<div class="line left">
<span class="bold small">trailer: s<br></span><span class="italic small">"Class fieldNamesInto"</span></div>
<div class="line left">
<span class="bold small">unbalance: nTemps<br></span><span class="italic small">"Parser cascade"</span></div>
<div class="line left">
<span class="bold small">unjuggle: oldTemps<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[maxTemp &larr; oldTemps max: maxTemp]<br></span><span class="italic small">"Parser macro"</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪Generator under: &rsquo;Compiler&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"ParsedAssignment"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;ParsedAssignment&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: Object<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;var expr elide&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;&rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">sharing: ByteCodes;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>I am a node in a compiler parse tree.  I represent an assignment of an expression to a variable.</span></div>
<div class="line left">
<span class="bold large"><br>Initialization</span></div>
<div class="line left">
<span class="bold small">var: var expr: expr</span></div>
<div class="line left">
<span class="bold large"><br>Code generation</span></div>
<div class="line left">
<span class="bold small">emitForEffect: code on: stack<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[expr emitForValue: code on: stack. stack pop: 1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">elide⇒ [</span><span class="italic small">"var begins the next statement"</span><span class="small"> code next &larr; toSmash]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">code next &larr; toSmashPop.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">var emitBytes: code]</span></div>
<div class="line left">
<span class="bold small">emitForValue: code on: stack<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[expr emitForValue: code on: stack.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">code next &larr; toSmash.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">var emitBytes: code]</span></div>
<div class="line left">
<span class="bold small">emittedVariable<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑var]</span></div>
<div class="line left">
<span class="bold small">firstPush<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑expr firstPush]</span></div>
<div class="line left">
<span class="bold small">sizeForEffect: nextPush<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑expr sizeForValue + 1 + [elide &larr; nextPush≡var⇒ [0] var sizeForValue]]</span></div>
<div class="line left">
<span class="bold small">sizeForValue<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑expr sizeForValue + 1 + var sizeForValue]</span></div>
<div class="line left">
<span class="bold large"><br>Miscellaneous</span></div>
<div class="line left">
<span class="bold small">printon: s<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[s append: &rsquo;(&rsquo;; print: var; append: &rsquo;&larr;&rsquo;; print: expr; append: &rsquo;)&rsquo;]</span></div>
<div class="line left">
<span class="bold large"><br>Decompiling</span></div>
<div class="line left">
<span class="bold small">expr </span><span class="small">[⇑expr]</span></div>
<div class="line left">
<span class="bold small">findMacros: macros compilerTemps: compilerTemps<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[var findMacros: macros compilerTemps: compilerTemps.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">expr findMacros: macros compilerTemps: compilerTemps]</span></div>
<div class="line left">
<span class="bold small">isForFromInit: loop </span><span class="small">| cond b nextMess<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["</span><span class="italic small">return true if I could be the first initialization statement for a <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small italic underline">for⦂ from:</span><span class="italic small"> loop.</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(expr isnt: ParsedMessage) or⦂ expr op≠toAsStream⇒[⇑false]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">loop isnt: ParsedLoop⇒[⇑false]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">b &larr; loop whileExpr.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(b isnt: ParsedBlock) or⦂ b position≠2⇒[⇑false]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">b◦1 isnt: ParsedAssignment⇒[⇑false]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nextMess &larr; (b◦1) expr.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nextMess isnt: ParsedMessage⇒[⇑false]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nextMess rcvr≠var or⦂ nextMess op≠toNext⇒[⇑false]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑true]</span>&nbsp;&nbsp;&nbsp;&nbsp;</div>
<div class="line left">
<span class="bold small">isForFromToInit: start loop: loop </span><span class="small">| b incr test<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["</span><span class="italic small">return true if I could be the first initialization statement for a <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small italic underline">for⦂ to: do⦂</span><span class="italic small"> or a </span><span class="small italic underline">for⦂ from: to: do⦂</span><span class="italic small"> loop</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">I should set the upper bound, start should set the var to start-1</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(start isnt: ParsedAssignment) or⦂ (loop isnt: ParsedLoop)⇒[⇑false]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> [start expr≡toLoad0⇒[]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">start expr isnt: ParsedMessage⇒[⇑false]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">start expr op≠toMinus or⦂ start expr args≠toLoad1⇒[⇑false]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">the loop condition should increment the var and compare it with the <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">upper bound</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">b &larr; loop whileExpr.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(b isnt: ParsedBlock) or⦂ b position≠2⇒[⇑false]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">incr &larr; b◦1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">incr isnt: ParsedAssignment⇒[⇑false]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">incr var≠start var⇒[⇑false]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(incr expr isnt: ParsedMessage) or⦂ incr expr op≠toPlus⇒[⇑false]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">incr expr rcvr≠toLoad1 or⦂ incr expr args≠start var⇒[⇑false]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">test &larr; b◦2.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">test isnt: ParsedMessage⇒[⇑false]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(test rcvr≠var or⦂ test op≠toGeq) or⦂ test args≠incr var⇒[⇑false]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑true]</span></div>
<div class="line left">
<span class="bold small">printon: strm indent: level precedence: p forValue: v decompiler: decompiler<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ [p&gt;1⇒[strm append: &rsquo;(&rsquo;]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">var printon: strm indent: level precedence: 1<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">forValue: true decompiler: decompiler.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">strm append: &rsquo; &larr; &rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">expr printon: strm indent: level+2 precedence: 1<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">forValue: true decompiler: decompiler.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">p&gt;1⇒[strm append: &rsquo;)&rsquo;]]</span></div>
<div class="line left">
<span class="bold small">var </span><span class="small">[⇑var]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪ParsedAssignment under: &rsquo;Compiler&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"ParsedBlock"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;ParsedBlock&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: Stream<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;returns&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;&rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">sharing: ByteCodes;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>I am a stream to collect the statements of a block and then to become a node in a compiler parse tree.</span></div>
<div class="line left">
<span class="bold large"><br>Initialization</span></div>
<div class="line left">
<span class="bold small">default<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[limit &larr; 1. array &larr; Vector new: 1. position &larr; 0. returns &larr; false]</span></div>
<div class="line left">
<span class="bold small">doesReturn<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[returns &larr; true]</span></div>
<div class="line left">
<span class="bold small">mustReturn: fromMethod<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[returns⇒ []<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[fromMethod⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[position&gt;0 and⦂ (array◦position) emitsLoad⇒ [array◦position &larr; toLoadSelf] self next &larr; toLoadSelf]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self doesReturn]</span></div>
<div class="line left">
<span class="bold large"><br>Code generation</span></div>
<div class="line left">
<span class="bold small">emitForEffect: code on: stack<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[returns⇒ [self emitForValue: code on: stack. stack pop: 1]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self emitExceptLast: code on: stack.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(array◦position) emitForEffect: code on: stack]</span></div>
<div class="line left">
<span class="bold small">emitForValue: code on: stack<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self emitExceptLast: code on: stack.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(array◦position) emitForValue: code on: stack.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">returns⇒ [code next &larr; toReturn]]</span></div>
<div class="line left">
<span class="bold small">firstPush<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑(array◦1) firstPush]</span></div>
<div class="line left">
<span class="bold small">sizeForEffect: nextPush<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[returns⇒ [⇑self sizeForValue]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑self sizeExceptLast + ((array◦position) sizeForEffect: nextPush)]</span></div>
<div class="line left">
<span class="bold small">sizeForTruth: trueSkip falsity: falseSkip<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[returns⇒ [⇑self sizeForValue]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑self sizeExceptLast + (array◦position sizeForTruth: trueSkip falsity: falseSkip)]</span></div>
<div class="line left">
<span class="bold small">sizeForValue<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑self sizeExceptLast + (array◦position) sizeForValue + [returns⇒ [1] 0]]</span></div>
<div class="line left">
<span class="bold large"><br>Miscellaneous</span></div>
<div class="line left">
<span class="bold small">printon: s </span><span class="small">| i<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[s append: &rsquo;[&rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: position-1 do⦂ [s print: (array◦i); append: &rsquo;. &rsquo;].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[returns⇒ [s append: &rsquo;⇑&rsquo;]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[position&gt;0⇒ [s print: (array◦position)]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s append: &rsquo;]&rsquo;]</span></div>
<div class="line left">
<span class="bold small">quickCode </span><span class="small">| t v<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[position=1 and⦂ (returns and⦂ (v&larr;array◦1) emitsLoad)⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[v=toLoadSelf⇒ [t &larr; String new: 2. t◦1&larr;0; ◦2&larr;1. ⇑t]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">v isField⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[t &larr; String new: 5. t◦1&larr;0; ◦2&larr;40; ◦3&larr;0; ◦4&larr;0; ◦5&larr;v. ⇑t]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑false]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑false]</span></div>
<div class="line left">
<span class="bold small">returns<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑returns]</span></div>
<div class="line left">
<span class="bold large"><br>Private</span></div>
<div class="line left">
<span class="bold small">emitExceptLast: code on: stack<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">| i<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[for⦂ i to: position-1 do⦂ [(array◦i) emitForEffect: code on: stack]]</span></div>
<div class="line left">
<span class="bold small">sizeExceptLast<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">| i next nextPush size<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[size &larr; 0. next &larr; array◦position.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: position-1 do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[nextPush &larr; next firstPush. next &larr; array◦(position-i).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">size &larr; size + (next sizeForEffect: nextPush)].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑size]</span></div>
<div class="line left">
<span class="bold large"><br>Decompiling</span></div>
<div class="line left">
<span class="bold small">findMacros: macros compilerTemps: compilerTemps </span><span class="small">| i s t<br>"</span><span class="italic small">Look for </span><span class="small italic underline">for</span><span class="italic small"> statements.  If one of my statements is the init statement for a </span><span class="small italic underline">for</span><span class="italic small">, append myself and the index of that statement to the stream </span><span class="small italic underline">macros</span><span class="italic small">.  Mark its compiler-generated temp.  If the temp is subsequently used before being re-assigned, the pattern can&rsquo;t be a </span><span class="small italic underline">for</span><span class="italic small"> after all, and will be deleted from </span><span class="small italic underline">macros</span><span class="italic small">.</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[for⦂ i to: position do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[s &larr; array◦i.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(s isnt: ParsedAssignment) or⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(s var&lt;codeLoadTemp or⦂ s var&gt;(codeLoadTemp+255))⇒  "</span><span class="italic small">not a </span><span class="small italic underline">for</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[s findMacros: macros compilerTemps: compilerTemps]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">t &larr; s var-codeLoadTemp+1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">i≤(position-2) and⦂ (s isForFromToInit: array◦(i+1) loop: array◦(i+2))⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[macros next&larr; self; next&larr; i.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">compilerTemps◦t &larr; true.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">check other parts of the for</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s expr findMacros: macros compilerTemps: compilerTemps.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">array◦(i+1) findMacros: macros compilerTemps: compilerTemps.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(array◦(i+2)) doExpr findMacros: macros compilerTemps: compilerTemps.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">i &larr; i+2]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">i≤(position-1) and⦂ (array◦i isForFromInit: array◦(i+1))⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[macros next&larr; self; next&larr; i.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">compilerTemps◦t &larr; true.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s expr findMacros: macros compilerTemps: compilerTemps.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(array◦(i+1)) doExpr findMacros: macros compilerTemps: compilerTemps.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">i &larr; i+1]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s findMacros: macros compilerTemps: compilerTemps]]</span></div>
<div class="line left">
<span class="bold small">insertMacro: loc decompiler: decompiler </span><span class="small">| macro n i<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["</span><span class="italic small">create a parsed for loop, and replace the old statements by it</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">macro &larr; ParsedForLoop new block: self loc: loc decompiler: decompiler.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">array◦loc &larr; macro.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">n &larr; macro nStatements.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i from: loc+n to: position do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[array◦(i-n+1) &larr; array◦i].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">position &larr; position-n+1]</span></div>
<div class="line left">
<span class="bold small">printon: strm indent: level precedence: p forValue: v decompiler: decompiler </span><span class="small">| i<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["</span><span class="italic small">ignore precedence, since the block is enclosed in brackets</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">position=0⇒[strm append: &rsquo;[]&rsquo; ]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">strm append: &rsquo;[&rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: position-1 do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[array◦i printon: strm indent: level precedence: 0<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">forValue: false decompiler: decompiler.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">strm append: &rsquo;.&rsquo;; crtab: level].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> [returns⇒[strm append: &rsquo;⇑&rsquo;]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">array◦position printon: strm indent: level precedence: 0<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">forValue: (returns or⦂ v) decompiler: decompiler.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">strm append: &rsquo;]&rsquo; ]</span></div>
<div class="line left">
<span class="bold large"><br>As yet unclassified</span></div>
<div class="line left">
<span class="bold small">emitForTruth: trueSkip falsity: falseSkip into: code on: stack<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[returns⇒ [self emitForValue: code on: stack]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self emitExceptLast: code on: stack.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(array◦position) emitForTruth: trueSkip falsity: falseSkip into: code on: stack]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪ParsedBlock under: &rsquo;Compiler&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"ParsedConditional"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;ParsedConditional&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: Object<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;ifExpr thenExpr elseExpr thenSize elseSize jmpSize&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;&rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>I am a node in a compiler parse tree.  I represent a condition and two alternatives.</span></div>
<div class="line left">
<span class="bold large"><br>Initialization</span></div>
<div class="line left">
<span class="bold small">ifExpr: ifExpr thenExpr: thenExpr elseExpr: elseExpr</span></div>
<div class="line left">
<span class="bold large"><br>Code generation</span></div>
<div class="line left">
<span class="bold small">emitForEffect: code on: stack<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ifExpr emitForValue: code on: stack.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">thenSize emitBfp: code on: stack.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">thenExpr emitForEffect: code on: stack.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[jmpSize&gt;0⇒ [elseSize emitJmp: code on: stack]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">elseExpr emitForEffect: code on: stack]</span></div>
<div class="line left">
<span class="bold small">emitForValue: code on: stack<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ifExpr emitForValue: code on: stack.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">thenSize emitBfp: code on: stack.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">thenExpr emitForValue: code on: stack.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">stack pop: 1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[jmpSize&gt;0⇒ [elseSize emitJmp: code on: stack]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">elseExpr emitForValue: code on: stack]</span></div>
<div class="line left">
<span class="bold small">firstPush<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑ifExpr firstPush]</span></div>
<div class="line left">
<span class="bold small">sizeForEffect: nextPush<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[elseSize &larr; elseExpr sizeForEffect: nextPush.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">jmpSize &larr; [thenExpr returns⇒ [0] elseSize jmpSize].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">thenSize &larr; (thenExpr sizeForEffect: ¬1) + jmpSize.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ifExpr sizeForValue + thenSize bfpSize + thenSize + elseSize]</span></div>
<div class="line left">
<span class="bold small">sizeForValue<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[elseSize &larr; elseExpr sizeForValue.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">jmpSize &larr; [thenExpr returns⇒ [0] elseSize jmpSize].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">thenSize &larr; thenExpr sizeForValue + jmpSize.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ifExpr sizeForValue + thenSize bfpSize + thenSize + elseSize]</span></div>
<div class="line left">
<span class="bold large"><br>Miscellaneous</span></div>
<div class="line left">
<span class="bold small">printon: s<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[s append: &rsquo;if⦂ &rsquo;; print: ifExpr; append: &rsquo;then⦂ &rsquo;; print: thenExpr; append: &rsquo;else⦂ &rsquo;; print: elseExpr]</span></div>
<div class="line left">
<span class="bold small">returns<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑thenExpr returns and⦂ elseExpr returns]</span></div>
<div class="line left">
<span class="bold large"><br>Decompiling</span></div>
<div class="line left">
<span class="bold small">findMacros: macros compilerTemps: compilerTemps<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ifExpr findMacros: macros compilerTemps: compilerTemps.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">thenExpr findMacros: macros compilerTemps: compilerTemps.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">elseExpr findMacros: macros compilerTemps: compilerTemps]</span></div>
<div class="line left">
<span class="bold small">printon: strm indent: level precedence: p forValue: v decompiler: decompiler<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">| pos char<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ifExpr printon: strm indent: level precedence: 0 <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">forValue: true decompiler: decompiler.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">strm append: &rsquo; ⇒&rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[thenExpr position&gt;1 or⦂ (thenExpr◦1 is: ParsedConditional)⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[strm crtab: level+1] strm space].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">thenExpr printon: strm indent: level+1 precedence: 0 <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">forValue: v decompiler: decompiler.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">elseExpr position=1 and⦂ elseExpr last≡nil⇒[]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">strm crtab: level.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">Kludge!! Delete brackets around else block</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pos&larr;strm position.  char&larr;strm pop.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">elseExpr printon: strm indent: level precedence: 0 <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">forValue: v decompiler: decompiler.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">strm skip: ¬1.  strm◦pos&larr;char]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪ParsedConditional under: &rsquo;Compiler&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"ParsedConjunct"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;ParsedConjunct&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: Object<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;left right rightSize&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;&rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">sharing: ByteCodes;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>I am a node in a compiler parse tree.  I represent (left and⦂ right) and try to optimize the code generation thereof.</span></div>
<div class="line left">
<span class="bold large"><br>Initialization</span></div>
<div class="line left">
<span class="bold small">left: left right: right</span></div>
<div class="line left">
<span class="bold large"><br>Code generation</span></div>
<div class="line left">
<span class="bold small">emitForEffect: code on: stack<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[left emitForValue: code on: stack.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">rightSize emitBfp: code on: stack.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">right emitForEffect: code on: stack]</span></div>
<div class="line left">
<span class="bold small">emitForTruth: trueSkip falsity: falseSkip into: code on: stack<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[left emitForTruth: 0 falsity: rightSize+falseSkip into: code on: stack.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">right emitForTruth: trueSkip falsity: falseSkip into: code on: stack]<br></span></div>
<div class="line left">
<span class="bold small">emitForValue: code on: stack<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[left emitForValue: code on: stack.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">rightSize emitBfp: code on: stack.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">right emitForValue: code on: stack.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">1 emitJmp: code on: stack.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">code next &larr; toLoadFalse]</span></div>
<div class="line left">
<span class="bold small">firstPush<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑left firstPush]</span></div>
<div class="line left">
<span class="bold small">sizeForEffect: nextPush<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[rightSize &larr; right sizeForEffect: ¬1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑left sizeForValue + rightSize bfpSize + rightSize]</span></div>
<div class="line left">
<span class="bold small">sizeForTruth: trueSkip falsity: falseSkip<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[rightSize &larr; right sizeForTruth: trueSkip falsity: falseSkip.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑(left sizeForTruth: 0 falsity: rightSize+falseSkip) + rightSize]</span></div>
<div class="line left">
<span class="bold small">sizeForValue<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[rightSize &larr; right sizeForValue + 1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑left sizeForValue + rightSize bfpSize + rightSize + 1]</span></div>
<div class="line left">
<span class="bold large"><br>Miscellaneous</span></div>
<div class="line left">
<span class="bold small">emittedReceiver<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑left]</span></div>
<div class="line left">
<span class="bold small">emittedReceiver &larr; left</span></div>
<div class="line left">
<span class="bold small">printon: s<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[s append: &rsquo;(&rsquo;; print: left; append:  &rsquo; and⦂ &rsquo;; print: right; append: &rsquo;)&rsquo;]</span></div>
<div class="line left">
<span class="bold large"><br>Decompiling</span></div>
<div class="line left">
<span class="bold small">findMacros: macros compilerTemps: compilerTemps<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[left findMacros: macros compilerTemps: compilerTemps.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">right findMacros: macros compilerTemps: compilerTemps]</span></div>
<div class="line left">
<span class="bold small">printon: strm indent: level precedence: p forValue: v decompiler: decompiler<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ [p≥2⇒[strm append: &rsquo;(&rsquo;]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">left printon: strm indent: level precedence: 2<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">forValue: true decompiler: decompiler.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">strm append: &rsquo; and⦂ &rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">right printon: strm indent: level precedence: 2<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">forValue: v decompiler: decompiler.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">p≥2⇒[strm append: &rsquo;)&rsquo;]]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪ParsedConjunct under: &rsquo;Compiler&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"ParsedDisjunct"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;ParsedDisjunct&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: Object<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;left right rightSize&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;&rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">sharing: ByteCodes;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>I am a node in a compiler parse tree.  I represent (left or⦂ right) and try to optimize the code generation thereof.</span></div>
<div class="line left">
<span class="bold large"><br>Initialization</span></div>
<div class="line left">
<span class="bold small">left: left right: right</span></div>
<div class="line left">
<span class="bold large"><br>Code generation</span></div>
<div class="line left">
<span class="bold small">emitForEffect: code on: stack<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[left emitForValue: code on: stack.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">rightSize jmpSize emitBfp: code on: stack.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">rightSize emitJmp: code on: stack.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">right emitForEffect: code on: stack]</span></div>
<div class="line left">
<span class="bold small">emitForTruth: trueSkip falsity: falseSkip into: code on: stack<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[left emitForTruth: rightSize+trueSkip falsity: 0 into: code on: stack.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">right emitForTruth: trueSkip falsity: falseSkip into: code on: stack]</span></div>
<div class="line left">
<span class="bold small">emitForValue: code on: stack<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[left emitForValue: code on: stack.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(1 + rightSize jmpSize) emitBfp: code on: stack.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">code next &larr; toLoadTrue.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">rightSize emitJmp: code on: stack.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">right emitForValue: code on: stack]</span></div>
<div class="line left">
<span class="bold small">firstPush<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑left firstPush]</span></div>
<div class="line left">
<span class="bold small">sizeForEffect: nextPush<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[rightSize &larr; right sizeForEffect: ¬1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑left sizeForValue + 1 + rightSize jmpSize + rightSize]</span></div>
<div class="line left">
<span class="bold small">sizeForTruth: trueSkip falsity: falseSkip<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[rightSize &larr; right sizeForTruth: trueSkip falsity: falseSkip.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑(left sizeForTruth: rightSize+trueSkip falsity: 0) + rightSize]</span></div>
<div class="line left">
<span class="bold small">sizeForValue<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[rightSize &larr; right sizeForValue.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑left sizeForValue + 2 + rightSize jmpSize + rightSize]</span></div>
<div class="line left">
<span class="bold large"><br>Miscellaneous</span></div>
<div class="line left">
<span class="bold small">emittedReceiver<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑left]</span></div>
<div class="line left">
<span class="bold small">emittedReceiver &larr; left</span></div>
<div class="line left">
<span class="bold small">printon: s<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[s append: &rsquo;(&rsquo;; print: left; append: &rsquo; or⦂ &rsquo;; print: right; append: &rsquo;)&rsquo;]</span></div>
<div class="line left">
<span class="bold large"><br>Decompiling</span></div>
<div class="line left">
<span class="bold small">findMacros: macros compilerTemps: compilerTemps<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[left findMacros: macros compilerTemps: compilerTemps.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">right findMacros: macros compilerTemps: compilerTemps]</span></div>
<div class="line left">
<span class="bold small">printon: strm indent: level precedence: p forValue: v decompiler: decompiler<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ [p≥2⇒[strm append: &rsquo;(&rsquo;]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">left printon: strm indent: level precedence: 2<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">forValue: true decompiler: decompiler.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">strm append: &rsquo; or⦂ &rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">right printon: strm indent: level precedence: 2<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">forValue: v decompiler: decompiler.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">p≥2⇒[strm append: &rsquo;)&rsquo;]]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪ParsedDisjunct under: &rsquo;Compiler&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"ParsedFieldReference"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;ParsedFieldReference&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: Object<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;var toLoadVar toLoadFieldReference toObjectOffset&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;&rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">sharing: ByteCodes;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>I am a node in a compiler parse tree.  I represent a remote argument which is a reference to a method or instance variable.</span></div>
<div class="line left">
<span class="bold large"><br>Initialization</span></div>
<div class="line left">
<span class="bold small">var: var</span></div>
<div class="line left">
<span class="bold large"><br>Code generation</span></div>
<div class="line left">
<span class="bold small">emitForValue: code on: stack<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[([var isField⇒ [toLoadSelf] toLoadTempframe]) emitForValue: code on: stack.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">toLoadVar emitForValue: code on: stack.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">toLoadFieldReference emitForValue: code on: stack.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">code next &larr; toNew. toObjectOffset emitBytes: code..<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">stack pop: 2]</span></div>
<div class="line left">
<span class="bold small">local<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑var]</span></div>
<div class="line left">
<span class="bold small">remote: generator<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[toLoadVar &larr; generator literal: (var land: 0177)+1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">toLoadFieldReference &larr; generator literal: FieldReference.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">toObjectOffset &larr; generator encodeSel: ↪object:offset:]</span></div>
<div class="line left">
<span class="bold small">sizeForValue<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑ 2 + toLoadVar sizeForValue +<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">toLoadFieldReference sizeForValue + toObjectOffset sizeForValue]</span></div>
<div class="line left">
<span class="bold large"><br>Miscellaneous</span></div>
<div class="line left">
<span class="bold small">printon: s<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[s append: &rsquo;FLD=&gt; &rsquo;; print: var]</span></div>
<div class="line left">
<span class="bold large"><br>Decompiling</span></div>
<div class="line left">
<span class="bold small">findMacros: macros compilerTemps: compilerTemps<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[var findMacros: macros compilerTemps: compilerTemps]</span></div>
<div class="line left">
<span class="bold small">printon: strm indent: level precedence: p forValue: v decompiler: decompiler<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[var printon: strm indent: level precedence: p<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">forValue: true decompiler: decompiler]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪ParsedFieldReference under: &rsquo;Compiler&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"ParsedForLoop"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;ParsedForLoop&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: Object<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;var source start stop step doExpr nStatements&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;&rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">sharing: ByteCodes;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>I represent a for loop.  I am used only by the decompiler, not the compiler.</span></div>
<div class="line left">
<span class="bold large"><br>Decompiling</span></div>
<div class="line left">
<span class="bold small">block: block loc: loc decompiler: decompiler </span><span class="small">| init1 init2 loop s<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["</span><span class="italic small">loc should point to the initialization statement for a </span><span class="small italic underline">for</span><span class="italic small"> loop in block</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">init1 &larr; block◦loc.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">block◦(loc+1) is: ParsedLoop⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[nStatements &larr; 2.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">loop &larr; block◦(loc+1).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">var &larr; loop whileExpr◦2.  doExpr &larr; loop doExpr.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">init statement creates a stream ... see if its an interval</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s &larr; init1 expr rcvr.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(s is: ParsedMessage) and⦂ (decompiler selector: s op)≡↪to:by: ⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[start &larr; s rcvr.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">stop &larr; s args◦1.  step &larr; s args◦2]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">source &larr; s]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">must be a for⦂from:to:do⦂.  </span><span class="small italic underline">init1</span><span class="italic small"> will set up the limit, and </span><span class="small italic underline">init2</span><span class="italic small"> will<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">initialize </span><span class="small italic underline">var</span><span class="italic small"> to start-1</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nStatements &larr; 3.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">init2 &larr; block◦(loc+1).  loop &larr; block◦(loc+2).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">var &larr; init2 var.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">start &larr; [init2 expr≡toLoad0</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇒[toLoad1] init2 expr rcvr].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">stop &larr; init1 expr.  step &larr; toLoad1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">doExpr &larr; loop doExpr]</span></div>
<div class="line left">
<span class="bold small">nStatements<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["</span><span class="italic small">return the number of statements in my expanded form</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑nStatements]</span></div>
<div class="line left">
<span class="bold small">printon: strm indent: level precedence: p forValue: v decompiler: decompiler<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[source≡nil⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[strm append: &rsquo;for⦂ &rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">var printon: strm indent: level precedence: 2<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">forValue: true decompiler: decompiler.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> [start≡toLoad1⇒[] strm append: &rsquo; from: &rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">start printon: strm indent: level precedence: 2<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">forValue: true decompiler: decompiler].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">strm append: &rsquo; to: &rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">stop printon: strm indent: level precedence: 2<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">forValue: true decompiler: decompiler.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> [step≡toLoad1⇒[] strm append: &rsquo; by: &rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">step printon: strm indent: level precedence: 2<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">forValue: true decompiler: decompiler].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">strm append: &rsquo; do⦂&rsquo;; crtab: level+1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">doExpr printon: strm indent: level+1 precedence: 0 <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">forValue: false decompiler: decompiler]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">source is a stream</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">strm append: &rsquo;for⦂ &rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">var printon: strm indent: level precedence: 2<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">forValue: true decompiler: decompiler.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">strm append: &rsquo; from: &rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">source printon: strm indent: level precedence: 2<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">forValue: true decompiler: decompiler.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">strm append: &rsquo; do⦂&rsquo;; crtab: level+1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">doExpr printon: strm indent: level+1 precedence: 0 <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">forValue: false decompiler: decompiler]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪ParsedForLoop under: &rsquo;Compiler&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"ParsedLoop"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;ParsedLoop&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: Object<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;whileExpr doExpr whileSize doSize&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;&rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">sharing: ByteCodes;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>I am a node in a compiler parse tree.  I represent that part of an in-line loop statement that can be expressed in the while-do form.</span></div>
<div class="line left">
<span class="bold large"><br>Initialization</span></div>
<div class="line left">
<span class="bold small">whileExpr: whileExpr doExpr: doExpr</span></div>
<div class="line left">
<span class="bold large"><br>Code generation</span></div>
<div class="line left">
<span class="bold small">emitForEffect: code on: stack<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["</span><span class="italic small">optimization removed to make things easier for decompiler --<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">whileExpr emitForTruth: 0 falsity: doSize into: code on: stack.</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">whileExpr emitForValue: code on: stack.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">doSize emitBfp: code on: stack.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">doExpr emitForEffect: code on: stack.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">0 - doSize - whileSize - doSize jmpSize emitJmp: code on: stack]</span></div>
<div class="line left">
<span class="bold small">emitForValue: code on: stack<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self emitForEffect: code on: stack.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">toLoadNil emitForValue: code on: stack]</span></div>
<div class="line left">
<span class="bold small">firstPush<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑whileExpr firstPush]</span></div>
<div class="line left">
<span class="bold small">sizeForEffect: nextPush<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[doSize &larr; (doExpr sizeForEffect: ¬1) + 2.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">whileSize &larr; whileExpr sizeForTruth: 0 falsity: doSize.</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">whileSize &larr; whileExpr  sizeForValue.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑whileSize + doSize + doSize jmpSize]</span></div>
<div class="line left">
<span class="bold small">sizeForValue<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑(self sizeForEffect: ¬1) + 1]</span></div>
<div class="line left">
<span class="bold large"><br>Miscellaneous</span></div>
<div class="line left">
<span class="bold small">printon: s<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[s append: &rsquo;while⦂ &rsquo;; print: whileExpr; append: &rsquo;do⦂ &rsquo;; print: doExpr]</span></div>
<div class="line left">
<span class="bold large"><br>Decompiling</span></div>
<div class="line left">
<span class="bold small">doExpr </span><span class="small">[⇑doExpr]</span></div>
<div class="line left">
<span class="bold small">findMacros: macros compilerTemps: compilerTemps<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[whileExpr findMacros: macros compilerTemps: compilerTemps.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">doExpr findMacros: macros compilerTemps: compilerTemps]</span></div>
<div class="line left">
<span class="bold small">printon: strm indent: level precedence: p forValue: v decompiler: decompiler<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[[whileExpr is: ParsedNegation⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[strm append: &rsquo;until⦂ &rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">whileExpr negated printon: strm indent: level precedence: 2<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">forValue: true decompiler: decompiler]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> strm append: &rsquo;while⦂ &rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> whileExpr printon: strm indent: level precedence: 2<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">forValue: true decompiler: decompiler].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">strm append: &rsquo; do⦂&rsquo;; crtab: level+1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">doExpr printon: strm indent: level+1 precedence: 0 <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">forValue: false decompiler: decompiler]</span></div>
<div class="line left">
<span class="bold small">whileExpr </span><span class="small">[⇑whileExpr]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪ParsedLoop under: &rsquo;Compiler&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"ParsedMessage"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;ParsedMessage&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: Object<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;rcvr op args "false if no args, Vector if many args" hasPC&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;&rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">sharing: ByteCodes;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>I am a node in a compiler parse tree.  I represent an expression consisting of a receiver (rcvr), a selector byte code (op), and an argument list (args) which is false for no arguments, a vector of parse trees for 2 or more arguments, or the argument parse tree for one argument.</span></div>
<div class="line left">
<span class="bold large"><br>Initialization</span></div>
<div class="line left">
<span class="bold small">hasPC </span><span class="small">[hasPC&larr; true]</span></div>
<div class="line left">
<span class="bold small">rcvr: rcvr op: op args: args<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[hasPC&larr; false.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">op=toEq and⦂ ((toLoadFalse≡rcvr) or⦂ (toLoadFalse≡args))⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑ParsedNegation new rcvr: rcvr op: op args: args]]</span></div>
<div class="line left">
<span class="bold large"><br>Code generation</span></div>
<div class="line left">
<span class="bold small">emitForEffect: code on: stack<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self emitForValue: code on: stack. code next &larr; toPop. stack pop: 1]</span></div>
<div class="line left">
<span class="bold small">emitForValue: code on: stack<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[args emitForValue: code on: stack.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">rcvr emitForValue: code on: stack.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[rcvr≡toSuper⇒ [code next&larr;rcvr]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">op emitBytes: code. args argsOff: stack]</span></div>
<div class="line left">
<span class="bold small">firstPush<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑([args⇒ [args] rcvr]) firstPush]</span></div>
<div class="line left">
<span class="bold small">sizeForEffect: nextPush<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑self sizeForValue+1]</span></div>
<div class="line left">
<span class="bold small">sizeForValue<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑args sizeForValue + rcvr sizeForValue + op sizeForValue + [rcvr≡toSuper⇒ [1] 0]]</span></div>
<div class="line left">
<span class="bold large"><br>Miscellaneous</span></div>
<div class="line left">
<span class="bold small">args </span><span class="small">[⇑args]</span></div>
<div class="line left">
<span class="bold small">args&larr;args</span></div>
<div class="line left">
<span class="bold small">emittedReceiver<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑rcvr]</span></div>
<div class="line left">
<span class="bold small">emittedReceiver &larr; rcvr</span></div>
<div class="line left">
<span class="bold small">op </span><span class="small">[⇑op]</span></div>
<div class="line left">
<span class="bold small">printon: s<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[s append: &rsquo;(&rsquo;; print: rcvr; space; print: op.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[args⇒ [s space; print: args]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s append: &rsquo;)&rsquo;]</span></div>
<div class="line left">
<span class="bold small">rcvr </span><span class="small">[⇑rcvr]</span></div>
<div class="line left">
<span class="bold large"><br>Decompiling</span></div>
<div class="line left">
<span class="bold small">findMacros: macros compilerTemps: compilerTemps </span><span class="small">| vec a<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[vec &larr; [args≡nil⇒[↪()] args is: Vector⇒[args] args inVector].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ a from: vec do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[a findMacros: macros compilerTemps: compilerTemps].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">rcvr findMacros: macros compilerTemps: compilerTemps]</span></div>
<div class="line left">
<span class="bold small">printon: strm indent: level precedence: p forValue: v decompiler: decompiler<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">| sel keywords i parens myP vec char1<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[sel &larr; decompiler selector: op.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">myP &larr; [sel isinfix⇒[3]; iskeyword⇒[2]; isarrow⇒[1] 4].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"check if parens are needed"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">parens &larr; [myP&lt;p or⦂ (p=2 and⦂ myP=2)].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> [parens⇒[strm append: &rsquo;(&rsquo;]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">char1&larr; strm position.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">rcvr printon: strm indent: level precedence: myP<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">forValue: true decompiler: decompiler.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> [myP=4⇒[strm space; append: sel  "unary selector"]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> keywords &larr; sel keywords.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">vec &larr; [args≡nil⇒[↪()] args is: Vector⇒[args] args inVector].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> for⦂ i to: keywords length do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[strm space; append: keywords◦i; space.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">vec◦i printon: strm indent: level <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">precedence: [myP=3⇒[4] myP]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">forValue: true decompiler: decompiler]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[hasPC⇒[decompiler highlight: (char1+1 to: strm position+1)]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">parens⇒[strm append: &rsquo;)&rsquo;]]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪ParsedMessage under: &rsquo;Compiler&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"ParsedNegation"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;ParsedNegation&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: ParsedMessage<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;&rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">sharing: ByteCodes;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>I am a node in a compiler parse tree.  I am a parsed messsage in which the selector is ≡ and one of the participants is false.</span></div>
<div class="line left">
<span class="bold large"><br>Initialization</span></div>
<div class="line left">
<span class="bold small">rcvr: rcvr op: op args: args</span></div>
<div class="line left">
<span class="bold large"><br>Code generation</span></div>
<div class="line left">
<span class="bold small">emitForTruth: trueSkip falsity: falseSkip into: code on: stack<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[([toLoadFalse≡rcvr⇒ [args] rcvr]) emitForTruth: falseSkip falsity: trueSkip into: code on: stack]</span></div>
<div class="line left">
<span class="bold small">sizeForTruth: trueSkip falsity: falseSkip<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑([toLoadFalse≡rcvr⇒ [args] rcvr]) sizeForTruth: falseSkip falsity: trueSkip]</span></div>
<div class="line left">
<span class="bold large"><br>Miscellaneous</span></div>
<div class="line left">
<span class="bold small">negated </span><span class="small">[toLoadFalse≡rcvr⇒[⇑args] ⇑rcvr]</span></div>
<div class="line left">
<span class="bold small">printon: s<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[s append: &rsquo;(negation)&rsquo;. super printon: s]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪ParsedNegation under: &rsquo;Compiler&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"ParsedObjectReference"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;ParsedObjectReference&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: Object<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;var&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;&rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">sharing: ByteCodes;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>I am a node in a compiler parse tree.  I represent a remote argument which is a reference to a class or pool variable.</span></div>
<div class="line left">
<span class="bold large"><br>Initialization</span></div>
<div class="line left">
<span class="bold small">var: var</span></div>
<div class="line left">
<span class="bold large"><br>Code generation</span></div>
<div class="line left">
<span class="bold small">emitForValue: code on: stack  </span><span class="italic small">"Turn literal indirect into literal direct"</span><span class="bold small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[(var-256) emitForValue: code on: stack]</span></div>
<div class="line left">
<span class="bold small">local<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑var]</span></div>
<div class="line left">
<span class="bold small">remote: generator</span></div>
<div class="line left">
<span class="bold small">sizeForValue<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑(var-256) sizeForValue]</span></div>
<div class="line left">
<span class="bold large"><br>Miscellaneous</span></div>
<div class="line left">
<span class="bold small">printon: s<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[s append: &rsquo;OBJ=&gt; &rsquo;; print: var]</span></div>
<div class="line left">
<span class="bold large"><br>Decompiling</span></div>
<div class="line left">
<span class="bold small">findMacros: macros compilerTemps: compilerTemps<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[var findMacros: macros compilerTemps: compilerTemps]</span></div>
<div class="line left">
<span class="bold small">printon: strm indent: level precedence: p forValue: v decompiler: decompiler<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[strm append: (decompiler literal: var)]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪ParsedObjectReference under: &rsquo;Compiler&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"ParsedRemote"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;ParsedRemote&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: Object<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;expr esize toRemoteCopy&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;&rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">sharing: ByteCodes;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>I am a node in a compiler parse tree.  I represent an argument that is to be passed unevaluated.</span></div>
<div class="line left">
<span class="bold large"><br>Initialization</span></div>
<div class="line left">
<span class="bold small">expr: expr</span></div>
<div class="line left">
<span class="bold large"><br>Code generation</span></div>
<div class="line left">
<span class="bold small">emitForValue: code on: stack<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[toLoadThisCtxt emitForValue: code on: stack.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">toRemoteCopy emitBytes: code.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">code emitLong: toLongJmp by: esize.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">expr emitForValue: code on: stack.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">code next &larr; toEnd. stack pop: 1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(0-esize) emitJmp: code on: stack]</span></div>
<div class="line left">
<span class="bold small">local<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑expr]</span></div>
<div class="line left">
<span class="bold small">remote: generator<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[toRemoteCopy &larr; generator encodeSel: ↪remoteCopy]</span></div>
<div class="line left">
<span class="bold small">sizeForValue<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[esize &larr; expr sizeForValue + 3.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑esize + toRemoteCopy sizeForValue + 3]</span></div>
<div class="line left">
<span class="bold large"><br>Miscellaneous</span></div>
<div class="line left">
<span class="bold small">printon: s<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[s append: &rsquo;⦂&rsquo;; print: expr]</span></div>
<div class="line left">
<span class="bold large"><br>Decompiling</span></div>
<div class="line left">
<span class="bold small">findMacros: macros compilerTemps: compilerTemps<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[expr findMacros: macros compilerTemps: compilerTemps]</span></div>
<div class="line left">
<span class="bold small">printon: strm indent: level precedence: p forValue: v decompiler: decompiler<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[[(expr is: ParsedBlock) and⦂ <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(expr position&gt;1 or⦂ (expr◦1 is: ParsedConditional))⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[strm crtab: level+1]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">expr printon: strm indent: level+1 precedence: p<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">forValue: true decompiler: decompiler]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪ParsedRemote under: &rsquo;Compiler&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"Parser"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;Parser&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: Object<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;source dest oppositeCourt type token mark keep&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;&rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">sharing: TokenCodes;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>I parse tokens from source (a stream).  I report each parse node to dest (e.g., a code generator).  When an error occurs, I back up source to mark and notify dest.  I have two kinds of methods, token suppliers and token consumers, which coroutine with each other.  The coroutine that is not in control is suspended in the context, oppositeCourt.  Token suppliers are driven by an instance of class Reader that scans source and classifies each token by type.  Token consumers analyze the syntax and report it to dest.  The variable "keep" is no longer used.</span></div>
<div class="line left">
<span class="bold large"><br>Initialization</span></div>
<div class="line left">
<span class="bold small">from: source to: dest<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[oppositeCourt &larr; thisContext.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">mark &larr; source position. type &larr; 1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(Reader new of: source) readInto: self]<br></span><span class="italic small">"Generator compile|Generator evaluate"</span></div>
<div class="line left">
<span class="bold large"><br>Token suppliers</span></div>
<div class="line left">
<span class="bold small">comment: s<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[mark &larr; source position]</span></div>
<div class="line left">
<span class="bold small">contents<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[type &larr; 0. mark &larr; source position + 1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">thisContext sender &larr; nil.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ true do⦂ [self resume. self notify: &rsquo;MORE EXPECTED&rsquo;]]</span></div>
<div class="line left">
<span class="bold small">float: i fraction: f exp: e<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[token &larr; (i+&rsquo;.&rsquo;+f+&rsquo;e&rsquo;+e) asFloat.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">type &larr; aNumber. self resume]</span></div>
<div class="line left">
<span class="bold small">identifier: token<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[type &larr; aWord. self resume]</span></div>
<div class="line left">
<span class="bold small">integer: s<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[token &larr; s asInteger.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">type &larr; aNumber. self resume]</span></div>
<div class="line left">
<span class="bold small">keyword: token<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[type &larr; aKeyword. self resume]</span></div>
<div class="line left">
<span class="bold small">leftparen<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[type &larr; aLeftPar. self resume]</span></div>
<div class="line left">
<span class="bold small">onechar: token<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[type &larr;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[token=056⇒ [aPeriod];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=0133⇒ [aLeftBrack];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=0135⇒ [aRightBrack];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=033⇒ [aCondArrow];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=0137⇒ [aLeftArrow];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=021⇒ [aReturnArrow];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=073⇒ [aSemicolon];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=017⇒ [aHand]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">aBinary].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self resume]</span></div>
<div class="line left">
<span class="bold small">otheratom: token<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[type &larr; aGibberish. self resume]</span></div>
<div class="line left">
<span class="bold small">rightparen<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[type &larr; aRightPar. self resume]</span></div>
<div class="line left">
<span class="bold small">separator: c</span></div>
<div class="line left">
<span class="bold small">string: token<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[type &larr; aString. self resume]</span></div>
<div class="line left">
<span class="bold small">trailer: s<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[mark &larr; source position]</span></div>
<div class="line left">
<span class="bold large"><br>Method syntax</span></div>
<div class="line left">
<span class="bold small">body: block  </span><span class="small">| p  </span><span class="italic small">"return the primitive number, or 0"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[type=aLeftBrack⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self block: block.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">type=aKeyword and⦂ token=&rsquo;primitive:&rsquo;⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self advance. type=aNumber⇒ [p &larr; token. self advance. ⇑p]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self notify: &rsquo;EXPECTED A NUMBER&rsquo;]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑0]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑0]<br></span><span class="italic small">"Generator compile"</span></div>
<div class="line left">
<span class="bold small">declaration: block<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[type≠aWord⇒ [self notify: &rsquo;EXPECTED AN ARGUMENT NAME&rsquo;]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">dest declaration: block name: token asArg: true.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self advance]<br></span><span class="italic small">"pattern"</span></div>
<div class="line left">
<span class="bold small">pattern: block<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">| selector<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[selector &larr; Stream default.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[type=aWord⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[selector append: token. self advance];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=aBinary⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[selector append: (UST1◦(token+1)). self advance; declaration: block]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ type = aKeyword do⦂ [selector append: token. self advance; declaration: block].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">selector empty⇒ [self notify: &rsquo;EXPECTED A SELECTOR&rsquo;]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[type=aLeftArrow⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[selector append: &rsquo;&larr;&rsquo;. self advance; declaration: block]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑selector contents unique]<br></span><span class="italic small">"Generator compile|Context variableNamesInto"</span></div>
<div class="line left">
<span class="bold small">temporaries: block<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[type=aBinary and⦂ token=0174⇒ </span><span class="italic small">"|"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self advance.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ type=aWord do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[dest declaration: block name: token asArg: false. self advance]]]<br></span><span class="italic small">"Generator compile|Context variableNamesInto"</span></div>
<div class="line left">
<span class="bold large"><br>Statement syntax</span></div>
<div class="line left">
<span class="bold small">alternatives: ifExpr </span><span class="italic small">"⇒ [..] ..."</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">| thenExpr elseExpr<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self advance.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">type≠aLeftBrack⇒ [self notify: &rsquo;EXPECTED A [BLOCK]&rsquo;]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">thenExpr &larr; self block: dest block. elseExpr &larr; dest block.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[type=aSemicolon⇒ [self cascade: elseExpr after: ifExpr] self statements: elseExpr].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑dest ifExpr: ifExpr thenExpr: thenExpr elseExpr: elseExpr]<br></span><span class="italic small">"cascade"</span></div>
<div class="line left">
<span class="bold small">block: block<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self advance; statements: block.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">type=aRightBrack⇒ [self advance. ⇑block]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self notify: &rsquo;PERIOD OR RIGHT BRACKET WAS EXPECTED&rsquo;]<br></span><span class="italic small">"body|alternatives|expression|keywordMessage|binaryMessage"</span></div>
<div class="line left">
<span class="bold small">cascade: block after: expr  </span><span class="small">| val var oldTemps<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[var &larr; dest receivingVar: expr.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">oldTemps &larr; dest balance.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ type=aSemicolon do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self advance.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(val &larr; self messageChain: var)≡var⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self notify: &rsquo;MESSAGE EXPECTED&rsquo;].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">type=aCondArrow⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[block next &larr; self alternatives: val. dest unbalance: oldTemps. ⇑self]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">block next &larr; val].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">dest unbalance: oldTemps]<br></span><span class="italic small">"statement|alternatives"</span></div>
<div class="line left">
<span class="bold small">loopStmt: block  </span><span class="small">| oldMark<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[oldMark &larr; mark. self keywordMessage: false loop: block⇒ [⇑self]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">mark &larr; oldMark. self notify: &rsquo;UNKNOWN CONTROL MESSAGE&rsquo;]<br></span><span class="italic small">"statement"</span></div>
<div class="line left">
<span class="bold small">macro: block  </span><span class="small">| oldMark oldTemps val<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[oldMark &larr; mark. oldTemps &larr; dest juggle.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">val &larr; self keywordMessage: false macro: block.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">dest unjuggle: oldTemps.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">val⇒ [⇑block]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">mark &larr; oldMark. self notify: &rsquo;UNKNOWN CONTROL MESSAGE&rsquo;]<br></span><span class="italic small">"statement"</span></div>
<div class="line left">
<span class="bold small">statement: block </span><span class="small">| expr<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[type=aReturnArrow⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self advance. block next &larr; self expression. block doesReturn.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[type=aPeriod⇒ [self advance]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">type≠aRightBrack⇒ [self notify:&rsquo;SHOULDN&rsquo;&rsquo;T FOLLOW RETURN&rsquo;]];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">= aKeyword⇒ [self macro: block. type&gt;aPeriod⇒ [self statement: block]];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">≤aPeriod⇒ [dest nullStatement: block] </span><span class="italic small">"doit eof aRightBrack aPeriod"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">expr &larr; self expression.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">type=aCondArrow⇒ [block next &larr; self alternatives: expr]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">block next &larr; expr.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">type=aSemicolon⇒ [self cascade: block after: expr]]<br></span><span class="italic small">"statements"</span></div>
<div class="line left">
<span class="bold small">statements: block<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self statement: block.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ type=aPeriod do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self advance. self statement: block]]<br></span><span class="italic small">"alternatives|block|Generator evaluate"</span></div>
<div class="line left">
<span class="bold large"><br>Expression syntax</span></div>
<div class="line left">
<span class="bold small">binaryMessage: rcvr assign: assign </span><span class="italic small">"binarySelector ..."</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">| sel args<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[sel &larr; token. self advance.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">args &larr; [type=aLeftBrack⇒ [self block: dest block] self factor].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[assign and⦂ type=aLeftArrow⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self advance.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">args &larr; [(Vector new: 2)◦1&larr;args; ◦2&larr;self expression; itself].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">sel &larr; [(String new: 2)◦1&larr;sel; ◦2&larr;0137</span><span class="italic small">"&larr;"</span><span class="small">; itself]]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑dest rcvr: rcvr selector: sel args: args]<br></span><span class="italic small">"term|messageChain"</span></div>
<div class="line left">
<span class="bold small">expression<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">| var<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[type=aLeftBrack⇒ [⇑self block: dest block];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=aKeyword⇒ [⇑self macro: dest block];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">≠aWord⇒ [⇑self messageChain: self primary]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"It begins with a variable name"</span><span class="small"> var &larr; dest variable: token. self advance.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">type≠aLeftArrow⇒ [⇑self messageChain: var]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"It is a variable assignment"</span><span class="small"> self advance.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑dest assignment: var expr: self expression]<br></span><span class="italic small">"unaryMessage|binaryMessage|keywordMessage|statement|subExpression"</span></div>
<div class="line left">
<span class="bold small">factor<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">| expr<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[expr &larr; self primary.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ type=aWord do⦂ [expr &larr; self unaryMessage: expr assign: false].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑expr]<br></span><span class="italic small">"term|binaryMessage"</span></div>
<div class="line left">
<span class="bold small">keywordMessage: rcvr macro: block </span><span class="italic small">"keyword ..."</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">| sel args arg<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[sel &larr; Stream default. args &larr; (Vector new: 4) asStream.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ type = aKeyword do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[sel append: token. self advance.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">arg &larr; [type=aLeftBrack⇒ [self block: dest block] self term].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">args next &larr; [sel last=03⇒ [dest noEvalKeyword: arg] dest evalKeyword: arg]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[type=aLeftArrow⇒ [sel append: &rsquo;&larr;&rsquo;. args next &larr; [self advance; expression]]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">sel &larr; sel contents. args &larr; [args position=1⇒ [args last] args contents].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">block⇒ [⇑dest macro: block selector: sel args: args]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑dest keywordMessage: rcvr selector: sel args: args]<br></span><span class="italic small">"macro|messageChain"</span></div>
<div class="line left">
<span class="bold small">messageChain: rcvr<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[while⦂ type=aWord do⦂ [rcvr &larr; self unaryMessage: rcvr assign: true].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ type=aBinary do⦂ [rcvr &larr; self binaryMessage: rcvr assign: true].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[type = aKeyword⇒ [rcvr &larr; self keywordMessage: rcvr macro: false]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑rcvr]<br></span><span class="italic small">"cascade|expression"</span></div>
<div class="line left">
<span class="bold small">term  </span><span class="small">| rcvr<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[rcvr &larr; self factor.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ type=aBinary do⦂ [rcvr &larr; self binaryMessage: rcvr assign: false].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑rcvr]<br></span><span class="italic small">"keywordMessage"</span></div>
<div class="line left">
<span class="bold small">unaryMessage: rcvr assign: assign </span><span class="italic small">"word ..."</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">| sel args<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[sel &larr; token. self advance.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">args &larr;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[assign and⦂ type=aLeftArrow⇒ [sel &larr; sel + &rsquo;&larr;&rsquo;. self advance; expression] false].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑dest rcvr: rcvr selector: sel args: args]<br></span><span class="italic small">"factor|messageChain"</span></div>
<div class="line left">
<span class="bold large"><br>Primary syntax</span></div>
<div class="line left">
<span class="bold small">literal </span><span class="italic small">"A Vector, UniqueString, String, or Number"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">| t oldMark<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[type<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=aLeftPar⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[oldMark &larr; mark. self advance.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">t &larr; self read. type=aRightPar⇒ [self advance. ⇑t]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">mark &larr; oldMark. self notify: &rsquo;UNMATCHED&rsquo;]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">t &larr; [type≥aKeyword⇒ [token unique]; ≤aBinary⇒ [UST1◦(token+1)] token].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self advance. ⇑t]<br></span><span class="italic small">"primary|read"</span></div>
<div class="line left">
<span class="bold small">primary<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">| t<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[type<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=aWord⇒ [t &larr; dest variable: token. self advance. ⇑t];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=aLeftPar⇒ [⇑self subExpression];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=aNumber⇒ [t &larr; dest literal: token. self advance. ⇑t];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=aString⇒ [t &larr; dest literal: token. self advance. ⇑t];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=aHand⇒ [self advance.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">type=aRightPar or⦂ type=0⇒ [self notify: &rsquo;EXPECTED LITERAL&rsquo;]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑dest literal: self literal]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self notify: &rsquo;OBJECT EXPECTED&rsquo;]<br></span><span class="italic small">"factor|expression"</span></div>
<div class="line left">
<span class="bold small">read </span><span class="italic small">"A sequence of literals"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">| s<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[s &larr; (Vector new: 10) asStream.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">until⦂ (type=aRightPar or⦂ type=0) do⦂ [s next &larr; self literal].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑s contents]<br></span><span class="italic small">"literal"</span></div>
<div class="line left">
<span class="bold small">subExpression </span><span class="italic small">"(...)"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">| expr<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self advance. expr &larr; self expression.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">type=aRightPar⇒ [self advance. ⇑expr]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self notify: &rsquo;NOT EXPECTED IN A (SUBEXPRESSION)&rsquo;]<br></span><span class="italic small">"primary"</span></div>
<div class="line left">
<span class="bold large"><br>Suspension</span></div>
<div class="line left">
<span class="bold small">advance </span><span class="italic small">"Switch from the parser to the reader to obtain another token."</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[mark &larr; source position- [type&gt;aBinary⇒ [1] 0].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">oppositeCourt &larr; thisContext swapSender: oppositeCourt]</span></div>
<div class="line left">
<span class="bold small">mustBeDone<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[type=0⇒ [self terminate] self notify: &rsquo;UNEXPECTED CONSTRUCT&rsquo;]<br></span><span class="italic small">"Generator compile|Generator evaluate"</span></div>
<div class="line left">
<span class="bold small">notify: errorString </span><span class="small">| delims<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[source skip: mark - source position.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">delims &larr; ↪(011 012  014 015 040).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ (delims has: source peek) do⦂ [source next].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[source myend≡false⇒ [source skip: 1]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">dest abortWith: errorString]</span></div>
<div class="line left">
<span class="bold small">resume </span><span class="italic small">"The reader has supplied another token; resume the parser."</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[oppositeCourt &larr; thisContext swapSender: oppositeCourt]</span></div>
<div class="line left">
<span class="bold small">terminate<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[[dest≡nil⇒ [] dest terminate. dest &larr; nil].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[oppositeCourt≡nil⇒ [] oppositeCourt release. oppositeCourt &larr; nil]]<br></span><span class="italic small">"mustBeDone|Generator abortWith|Context variableNamesInto"</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪Parser under: &rsquo;Compiler&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"ParseStack"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;ParseStack&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: Object<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;position length&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;&rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>I keep track of the current and high position of the stack that will be needed by code being compiled.</span></div>
<div class="line left">
<span class="bold large"><br>Initialization</span></div>
<div class="line left">
<span class="bold small">init<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[length &larr; position &larr; 0]</span></div>
<div class="line left">
<span class="bold large"><br>Changes</span></div>
<div class="line left">
<span class="bold small">pop: n<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[(position &larr; position - n) &lt; 0⇒ [user notify: &rsquo;Parse stack underflow&rsquo;]]</span></div>
<div class="line left">
<span class="bold small">push: n<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[(position &larr; position + n) &gt; length⇒ [length &larr; position]]</span></div>
<div class="line left">
<span class="bold large"><br>Results</span></div>
<div class="line left">
<span class="bold small">length<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑length]</span></div>
<div class="line left">
<span class="bold small">position<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑position]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪ParseStack under: &rsquo;Compiler&rsquo;.</span></div>
    <div class="line left">
<span class="small">&rsquo;From Smalltalk 5.5k XM November 24 on 22 November 1980 at 2:57:08 am.&rsquo;<br></span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large">"ParagraphPrinter"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;ParagraphPrinter&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: Object<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;frame "&lt;Rectangle&gt; usable area on page"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">leading "&lt;Integer&gt; paragraph leading"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">style "&lt;TextStyle&gt; for paragraphs"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">strm "&lt;Stream&gt; for output"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;defaultframe defaultleading &rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>Provides a stream-like interface for printing a succession of paragraphs on a Bravo or Press file.  The margins, leading, and style are settable instance variables.  BravoPrinter and PressPrinter each override some messages</span></div>
<div class="line left">
<span class="bold large"><br>Initialization</span></div>
<div class="line left">
<span class="bold small">classInit </span><span class="small">| inch<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[inch &larr; 2540.</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"1 inch in micas"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">defaultframe &larr;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(0.75*inch) asInteger⌾(1*inch) rect: (7.75*inch) asInteger⌾(10*inch).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">defaultleading &larr; 0]</span></div>
<div class="line left">
<span class="bold small">init<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self frame &larr; self defaultframe.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self leading &larr; defaultleading.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self style &larr; DefaultTextStyle]</span></div>
<div class="line left">
<span class="bold small">of: strm</span></div>
<div class="line left">
<span class="bold large"><br>Access to state</span></div>
<div class="line left">
<span class="bold small">defaultframe </span><span class="small">[⇑defaultframe]</span></div>
<div class="line left">
<span class="bold small">defaultleading </span><span class="small">[⇑defaultleading]</span></div>
<div class="line left">
<span class="bold small">frame </span><span class="small">[⇑frame]</span></div>
<div class="line left">
<span class="bold small">frame &larr; frame</span></div>
<div class="line left">
<span class="bold small">leading &larr; leading</span></div>
<div class="line left">
<span class="bold small">style &larr; style</span></div>
<div class="line left">
<span class="bold large"><br>Writing</span></div>
<div class="line left">
<span class="bold small">print: para</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"A dummy, subclasses will override"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[strm append: para text]</span></div>
<div class="line left">
<span class="bold large"><br>Class stuff</span></div>
<div class="line left">
<span class="bold small">printchanges: lis </span><span class="small">| selector class heading old mes s delFlg<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">prints Changes format:</span><span class="small"> (&rsquo;class message&rsquo; &rsquo;class message&rsquo; ...)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">or alternate format:</span><span class="small"> (class (message ...) class () ...) </span><span class="italic small">or both<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">If an element appears in the list of the form &rsquo;~class message&rsquo;, this puts out a <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">line causing the system to forget that method.  These come after any additons,<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">owing to the sort on Changes"</span><span class="small"><br>  [lis empty⇒ [⇑lis]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user displayoffwhile⦂ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">lis &larr; lis asStream.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">old &larr; mes &larr; false.<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ class do⦂ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">get next class, selector pair</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[delFlg&larr; false.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">mes and⦂ (selector &larr; mes next)⇒ ["</span><span class="italic small">more of alternate form</span><span class="small">"]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s &larr; lis next⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s is: UniqueString⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">class &larr; Smalltalk lookup: s.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">mes &larr; lis next asStream.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">selector &larr; mes next]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">Changes format</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s &larr; s asStream.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[s peek=126 "~"⇒[s next. "take it off stream" delFlg&larr; true]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">class &larr; Smalltalk◦(s upto: 040) unique.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">selector &larr; s upto: 040.]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">class &larr; false].<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">delFlg⇒[self printForget: selector class: class]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"same, different or no class"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[old ≡ class⇒ []<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[old⇒ [old endCategoryOn: self; endChangesOn: self]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">class ≡ false⇒ ["</span><span class="italic small">finished</span><span class="small">"]<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user cr; show: class title.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">old &larr; class.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">class startChangesOn: self.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">heading &larr; &rsquo;As yet unclassified&rsquo;].<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">class≡false⇒ []<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user space; show: selector.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s &larr; class organization invert: (selector &larr; selector unique).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s⇒[[s ≠ heading⇒[class startCategory: (heading &larr; s) on: self]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">class printMethod: selector on: self]]]]</span></div>
<div class="line left">
<span class="bold small">printclass: class </span><span class="small">| c first [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">class is: Vector⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">first &larr; true.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ c from: class do⦂ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[first⇒ [first &larr; false] self nextpage].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self printclass: c]]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user displayoffwhile⦂ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[class is: UniqueString⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[class &larr; Smalltalk◦class]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user cr; show: class title.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">class paraprinton: self]]</span></div>
<div class="line left">
<span class="bold small">printForget: selector class: class<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"Print a line that causes a message to be forgotten"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[user cr; show: &rsquo;~&rsquo;+class title+&rsquo; &rsquo;+selector.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self print:<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(class title + &rsquo; derstands: ↪&rsquo; + selector + &rsquo;.<br>&rsquo;) asParagraph]</span></div>
<div class="line left">
<span class="bold small">stamp </span><span class="small">| s t [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">t &larr; user now "date and time".<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s &larr; Stream default.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s append: &rsquo;&rsquo;&rsquo;From &rsquo;; append: user version;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">append: &rsquo; on &rsquo;; print: t◦1;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">append: &rsquo; at &rsquo;; print: t◦2;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">append: &rsquo;.&rsquo;&rsquo;&rsquo;; cr.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self print: s contents asParagraph]</span></div>
<div class="line left">
<span class="bold large"><br>Closing</span></div>
<div class="line left">
<span class="bold small">close </span><span class="small">[strm close]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪ParagraphPrinter under: &rsquo;Paragraph printing&rsquo;.</span></div>
<div class="line left">
<span class="small">ParagraphPrinter classInit</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"BravoPrinter"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;BravoPrinter&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: ParagraphPrinter<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;eject "Eject page before next paragraph if true"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;&rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>Prints Paragraphs in Bravo format</span></div>
<div class="line left">
<span class="bold large"><br>Initialization</span></div>
<div class="line left">
<span class="bold small">init<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[super init.  eject &larr; false]</span></div>
<div class="line left">
<span class="bold large"><br>Writing</span></div>
<div class="line left">
<span class="bold small">eject<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[strm next &larr; 014; cr]</span></div>
<div class="line left">
<span class="bold small">nextpage<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[eject⇒ [self eject] eject &larr; true]</span></div>
<div class="line left">
<span class="bold small">print: para </span><span class="small">| l r<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[[eject⇒ [self eject. eject &larr; false]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">strm append: para text; next&larr; 032.</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"&uarr;Z"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">l &larr; frame origin x.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">r &larr; frame corner x.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[l≠self defaultframe origin x⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[strm append: &rsquo;l&rsquo;; print: l]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[r≠self defaultframe corner x⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[strm append: &rsquo;z&rsquo;; print: r]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[leading≠self defaultleading⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[strm append: &rsquo;e&rsquo;; print: leading]].<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"any other run info and cr"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">para bravoRuns: strm.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪BravoPrinter under: &rsquo;Paragraph printing&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"PressPrinter"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;PressPrinter&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: ParagraphPrinter<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;page "&lt;Integer&gt; current page number"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">ypos "&lt;Integer&gt; current y position on page"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">press "&lt;PressFile&gt; for output"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;defaultframe &rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>Prints Paragraphs in Press format</span></div>
<div class="line left">
<span class="bold large"><br>Initialization</span></div>
<div class="line left">
<span class="bold small">classInit </span><span class="small">| inch<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[inch &larr; 2540.</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"1 inch in micas"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">defaultframe &larr;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(1.1*inch) asInteger⌾(1*inch) rect: (7.75*inch) asInteger⌾(10*inch)]</span></div>
<div class="line left">
<span class="bold small">defaultframe </span><span class="small">[⇑defaultframe]</span></div>
<div class="line left">
<span class="bold small">init </span><span class="small">[super init. page &larr; 1. ypos &larr; frame maxY]</span></div>
<div class="line left">
<span class="bold small">of: strm </span><span class="small">[press &larr; PressFile new of: strm]</span></div>
<div class="line left">
<span class="bold small">press: press</span></div>
<div class="line left">
<span class="bold large"><br>Writing</span></div>
<div class="line left">
<span class="bold small">nextpage </span><span class="small">[self nextpage: true]</span></div>
<div class="line left">
<span class="bold small">nextpage: h </span><span class="small">| n [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">press page.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">page &larr; page+1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">ypos &larr; frame maxY.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">h⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">n &larr; page asString.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">press setp: frame maxX+800 ⌾ (ypos + 960);<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">selectfont: (press fontindex: 0 style: DefaultTextStyle) - 1;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">append: n;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">showchars: n length]]</span></div>
<div class="line left">
<span class="bold small">print: para </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self print: para in: (<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">Rectangle new origin: frame origin corner: frame maxX ⌾ ypos)]</span></div>
<div class="line left">
<span class="bold small">print: para in: rect </span><span class="small">| result oldpara [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[rect width = 0 or⦂ rect height = 0⇒ [user notify: &rsquo;zero dimension&rsquo;]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">para is a Paragraph-like object (TextImage, Form, etc.)</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">oldpara &larr; para.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">until⦂ ((result &larr; para presson: press in: rect) is: Integer) do⦂ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">rest of para goes on next page</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self nextpage.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">para &larr; result.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">rect &larr; rect minX ⌾ frame minY rect: rect maxX ⌾ ypos].<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">original para can hide information. if it split across page boundaries,<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">the format may vary. other completion flags can be added later</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">oldpara hidePress: press complete: [oldpara≡para⇒ [0] 1].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ypos &larr; result]</span></div>
<div class="line left">
<span class="bold large"><br>Closing</span></div>
<div class="line left">
<span class="bold small">close<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[press close]</span></div>
<div class="line left">
<span class="bold small">toPrinter </span><span class="small">[press toPrinter]</span></div>
<div class="line left">
<span class="bold large"><br>Projector behavior</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪PressPrinter under: &rsquo;Paragraph printing&rsquo;.</span></div>
<div class="line left">
<span class="small">PressPrinter classInit</span></div>
    <div class="line left">
<span class="small">&rsquo;From Smalltalk 5.5k XM November 24 on 22 November 1980 at 2:57:08 am.&rsquo;<br></span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large">"BitRect"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;BitRect&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: Rectangle<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;title  "&lt;String&gt; title of picture"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">stripheight  "&lt;Integer&gt; scan lines in a buffer (private)"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">data  "&lt;Vector&gt; of Strings.  Saves the bits in the Rectangle"&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;defaultpic &rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>BitRect is a Rectangle that remembers the bits within it.<br>To create and edit one, say:<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">BitRect new fromuser edit.<br>This installs a BitRectEditor in the scheduler and starts it up.<br>The editor is explained in BitRectEditor.</span></div>
<div class="line left">
<span class="bold large"><br>Initialization</span></div>
<div class="line left">
<span class="bold small">classInit<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["</span><span class="italic small">the default picture is a gray rectangle</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">defaultpic &larr; BitRect new filin: &rsquo;defaultpic&rsquo;]</span></div>
<div class="line left">
<span class="bold small">default </span><span class="small">[⇑defaultpic recopy]</span></div>
<div class="line left">
<span class="bold small">fromuser<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self title: &rsquo;BitRect&rsquo; in: Rectangle new fromuser.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self saveScreenBits]</span></div>
<div class="line left">
<span class="bold small">origin: origin corner: corner title: title stripheight: stripheight data: data</span></div>
<div class="line left">
<span class="bold small">title: title in: rect </span><span class="small">| nStrips i strips<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[origin&larr;rect origin.  corner&larr;rect corner.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">the strip height is chosen so that each bitstring is about 2048 bytes</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">stripheight&larr;1023/((self extent x + 15)/16).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nStrips&larr;(self extent y+stripheight-1)/stripheight.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">data&larr;Vector new: nStrips.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">strips&larr;self strips.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: nStrips do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[data◦i&larr;String new: (strips◦i) bitStringLength]]</span></div>
<div class="line left">
<span class="bold large"><br>Access to parts</span></div>
<div class="line left">
<span class="bold small">data </span><span class="small">[⇑data]</span></div>
<div class="line left">
<span class="bold small">title </span><span class="small">[⇑title]</span></div>
<div class="line left">
<span class="bold large"><br>Rectangle Protocol</span></div>
<div class="line left">
<span class="bold small">= x </span><span class="small">[⇑self≡x]</span></div>
<div class="line left">
<span class="bold small">bitsOntoStream: strm </span><span class="small">| bits<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[for⦂ bits from: data do⦂ [strm append: bits]]</span></div>
<div class="line left">
<span class="bold small">corner&larr;x </span><span class="small">[self growby: x-corner]</span></div>
<div class="line left">
<span class="bold small">extent&larr;x </span><span class="small">[self growby: x-self extent]</span></div>
<div class="line left">
<span class="bold small">growby: change </span><span class="small">| old<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[old&larr;BitRect new origin: origin corner: corner title: title<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">stripheight: stripheight data: data.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self title: title in: (origin rect: corner+change).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self copyBitsFrom: old]</span></div>
<div class="line left">
<span class="bold small">growto: x </span><span class="small">[self growby: x-corner]</span></div>
<div class="line left">
<span class="bold small">hash </span><span class="small">[user croak] primitive: 46</span></div>
<div class="line left">
<span class="bold small">height&larr;h </span><span class="small">[self growby: 0⌾(h-self extent y)]</span></div>
<div class="line left">
<span class="bold small">printon: strm<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[strm append: &rsquo;a BitRect&rsquo;]</span></div>
<div class="line left">
<span class="bold small">width&larr;w </span><span class="small">[self growby: (w-self extent x)⌾0]</span></div>
<div class="line left">
<span class="bold large"><br>Editing</span></div>
<div class="line left">
<span class="bold small">copyBitsFrom: other<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">| clippedStrip i j myStrips otherStrips myStrip otherStrip<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["</span><span class="italic small">copy all bits from </span><span class="small italic underline">other</span><span class="italic small"> that are within my area</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">myStrips&larr;self strips.  otherStrips&larr;other strips.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: myStrips length do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[for⦂ j to: otherStrips length do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[myStrip&larr;myStrips◦i.  otherStrip&larr;otherStrips◦j.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">clippedStrip&larr;myStrip intersect: otherStrip.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">clippedStrip empty⇒[]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">BitBlt init function&larr;0;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">destbase&larr;data◦i;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">destraster&larr;myStrip width+15/16;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">dest&larr;clippedStrip origin-myStrip origin;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">extent&larr;clippedStrip extent;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">sourcebase&larr;other data◦j;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">sourceraster&larr;otherStrip width+15/16;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">source&larr;clippedStrip origin-otherStrip origin;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">checksandcall]]]</span></div>
<div class="line left">
<span class="bold small">edit </span><span class="small">| a<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[user leaveTop.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">a&larr;BitRectEditor new picture: self.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">a takeCursor; enter.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user restartup: a]</span></div>
<div class="line left">
<span class="bold large"><br>Showing</span></div>
<div class="line left">
<span class="bold small">saveScreenBits </span><span class="small">| strips i<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[strips&larr;self strips.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: strips length do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[strips◦i bitsIntoString: data◦i mode: storing clippedBy: nil]]</span></div>
<div class="line left">
<span class="bold small">show </span><span class="small">| strips i<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[strips&larr;self strips.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: strips length do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[strips◦i bitsFromString: data◦i]]</span></div>
<div class="line left">
<span class="bold small">strips   </span><span class="small">"</span><span class="italic small">return a vector of strips (Rectangles)</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">| nStrips strips stripOrigin stripExtent i<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[(nStrips&larr;data length)=1⇒[⇑self inVector]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">strips&larr;Vector new: nStrips.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">stripOrigin&larr;origin.  stripExtent&larr;self width⌾stripheight.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: nStrips-1 do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[strips◦i&larr;Rectangle new origin: stripOrigin extent: stripExtent.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">stripOrigin&larr;stripOrigin+(0⌾stripheight)].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">strips◦nStrips&larr;Rectangle new origin: stripOrigin corner: corner.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑strips]</span></div>
<div class="line left">
<span class="bold large"><br>Filin and filout</span></div>
<div class="line left">
<span class="bold small">filin: title </span><span class="small">| f i x y rect strips  </span><span class="italic small">"read bits from a file"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[f&larr;dp0 oldFile: (title concat: &rsquo;.pic.&rsquo;).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">f readonly.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">f end⇒[f close. user notify: &rsquo;no data&rsquo;]<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">x&larr;f nextword.  y&larr;f nextword.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">rect&larr;Rectangle new origin: [origin is: Point⇒[origin] 0⌾0] extent: x⌾y.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self title: title in: rect.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">stripheight≠f nextword⇒[user notify: &rsquo;strip heights dont match&rsquo;]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">strips &larr; self strips.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: strips length do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[f into: data◦i].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">f close]</span></div>
<div class="line left">
<span class="bold small">filout </span><span class="small">| f i  "</span><span class="italic small">write bits on a file</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[f &larr; dp0 file: (title concat: &rsquo;.pic.&rsquo;).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">f nextword &larr; self extent x.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">f nextword &larr; self extent y.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">f nextword &larr; stripheight.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i from: data do⦂ [f append: i].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">f close]</span></div>
<div class="line left">
<span class="bold large"><br>Press</span></div>
<div class="line left">
<span class="bold small">length </span><span class="small">[⇑self bitStringLength]</span></div>
<div class="line left">
<span class="bold small">presson: press in: r </span><span class="small">| w h hs scale w16 y [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">scale &larr; press scale.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">h &larr; self height.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(hs  &larr; scale*h) &gt; r height⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"not enough room left on current page.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">assume for now that it will at least fit on an entire page"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑self]<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">w &larr; self width.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">w16 &larr; w + 15 | 16 "width to next word boundary".<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"with w, prints on viola but not on spruce.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">with w16, prints on spruce with garbage on end"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">press setp: 0⌾(y &larr; r corner y - hs);<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">dots⦂ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">press setcoding: 1 "bitmap" dots: w16 lines: h;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">setmode: 3 "to right and to bottom";<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">setsizewidth: scale*w16 height: hs;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">setwindowwidth: w16 height: h;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">dotsfollow.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self bitsOntoStream: press data].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑y]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪BitRect under: &rsquo;Picture Editor&rsquo;.</span></div>
<div class="line left">
<span class="small">BitRect classInit</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"BitRectEditor"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;BitRectEditor&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: Window<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;tool  "&lt;BitRectTool&gt; the current tool"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">picture  "&lt;BitRect&gt; the picture we are working on"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">dirty  "false if picture has not been modified"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">saveActionPic saveToolPic  "buffers for saving background" &rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;tools toolpic actionbuttons actionpic windowmenu &rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>BitRectEditor edits BitRects.<br>To create, say:<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">BitRect new fromuser edit.<br>This installs a BitRectEditor in the scheduler and starts it up.<br>The editing tools are to the left of the picture.  (The first one looks like a doodle).  They are: draw-thin, erase, straightedge, gray-block, paintbrush, magnifier.  The actions for the tools are displayed above the picture.<br>See BitRectTool for explanations of the actions.<br><br>CAUTION: this ordering is arbitrary.  It is currently possible to set a new action for any of the tools, so that if you are not careful, the straightedge will start being a magnifier or whatever.  This should get fixed eventually.<br><br>tools = a RadioButtons. Each button owns a BitRectTool (the active one is held in tool).<br>actionbuttons = a Vector of RadioButtons.  The groups of buttons are: action, mode, pen width, gray, and grid.<br>toolpic = BitRect of icons for the tools (at side of picture).<br>actionpic = BitRect of icons for the parts of a tool (above picture)<br>windowmenu = menu for bluebug.<br><br>To edit a copy of the tool picture, say<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">newpic&larr;(BitRectEditor◦↪toolpic) recopy.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">newpic edit.<br>To install this copy as the menu picture, say<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">BitRectEditor new toolpic: newpic recopy.<br>Do the analogous thing to edit the action picture.<br>Caution: the editor blows up if you edit the tool picture itself and not a copy.<br></span></div>
<div class="line left">
<span class="bold large"><br>Initialization</span></div>
<div class="line left">
<span class="bold small">actionpic: a </span><span class="small">[actionpic &larr; a]</span></div>
<div class="line left">
<span class="bold small">classInit </span><span class="small">| t i<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[t &larr; Vector new: 6.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: t length do⦂ [t◦i &larr; BitRectTool new init].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">tools &larr; (RadioButtons new) vec: t at: 0⌾0 width: 20.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">windowmenu &larr; Menu new string: &rsquo;under<br>move<br>grow<br>close<br>filout<br>printbits&rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">actionpic&larr;BitRect new filin: &rsquo;actionpic&rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">toolpic&larr;BitRect new filin: &rsquo;toolpic&rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self initmenu1]</span></div>
<div class="line left">
<span class="bold small">initmenu1 </span><span class="small">| s z<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[s &larr; Vector new: 5. z &larr; 20.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s◦1 &larr; (RadioButtons new) vec: ↪(setbrush paint block draw line blowup) at: 0⌾0 height: z. "</span><span class="italic small">action</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s◦2 &larr; (RadioButtons new) vec: (black, dkgray, gray, ltgray, white) at: 0⌾0 height: z. "</span><span class="italic small">tone</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s◦3 &larr; (RadioButtons new) vec: (0, 1, 2, 3) at: 0⌾0 height: z. "</span><span class="italic small">mode</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s◦4 &larr; (RadioButtons new) vec: (1, 2, 4, 8) at: 0⌾0 height: z. "</span><span class="italic small">width</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s◦5 &larr; (RadioButtons new) vec: (1, 2, 4, 8, 16, 32) at: 0⌾0 height: z. "</span><span class="italic small">grid</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">actionbuttons &larr; s.]</span></div>
<div class="line left">
<span class="bold small">picture: picture<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[tool &larr; tools push: 1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self frame: (picture origin rect: picture corner)]</span></div>
<div class="line left">
<span class="bold small">toolpic: a </span><span class="small">[toolpic &larr; a]</span></div>
<div class="line left">
<span class="bold large"><br>Window protocol</span></div>
<div class="line left">
<span class="bold small">bluebug </span><span class="small">| <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">picture is: BitImage⇒ [ ⇑ picture fromrectangle: (picture rectangle)]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">windowmenu bug<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> =1 ⇒[self leave. ⇑exitflag &larr; false];  "</span><span class="italic small">under</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=2 ⇒[self leave; newframe; enter];  "</span><span class="italic small">move</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=3 ⇒[self grow  "</span><span class="italic small">grow</span><span class="small">"];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=4 ⇒[self leave; erase.   "</span><span class="italic small">close</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> user unschedule: self. ⇑false];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=5 ⇒[self leave. picture filout. self enter];  "</span><span class="italic small">filout</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=6 ⇒[self print]</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">press file</span><span class="small">"]</span></div>
<div class="line left">
<span class="bold small">enter </span><span class="small">| start pt b<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["</span><span class="italic small">Periodically check if the mouse is still in the frame.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">If not, stop showing the picture</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">super show.  self lostMouse⇒[⇑false]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">picture show.  dirty&larr;false.  self lostMouse⇒[⇑false]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ b from: actionbuttons do⦂ [b reset].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">show action menu above the picture</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">start&larr;frame origin-1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pt &larr; start-(0⌾actionpic extent y).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">actionpic moveto: pt.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">saveActionPic&larr;actionpic bitsIntoString.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self lostMouse⇒[⇑false]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">last point I can return before having to restore bits under menus</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">actionpic show.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pt &larr; actionbuttons◦1 moveto: pt. "</span><span class="italic small">action</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pt &larr; actionbuttons◦3 moveto: pt. "</span><span class="italic small">mode</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pt &larr; actionbuttons◦4 moveto: pt. "</span><span class="italic small">width</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">show the next bank of action buttons</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pt &larr; start-(0⌾(actionpic extent y+1/2)).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pt &larr; actionbuttons◦2 moveto: pt.  "</span><span class="italic small">tone</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pt &larr; actionbuttons◦5 moveto: pt.  "</span><span class="italic small">grid</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">tool brushpt: (pt &larr; pt+(7⌾7)).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(tool brush) moveto: pt; show.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"show the tool pic"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pt &larr; start-(toolpic extent x⌾0).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">toolpic moveto: pt.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">saveToolPic &larr; toolpic bitsIntoString.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">toolpic show.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">tools moveto: pt;  setvalue: tool.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">tool frame: frame; showon: actionbuttons.]</span></div>
<div class="line left">
<span class="bold small">fixframe: r<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[picture moveto: r origin.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">r corner&larr;picture corner.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑r]</span></div>
<div class="line left">
<span class="bold small">grow </span><span class="small">| oldframe newframe pt r<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self leave.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">newframe&larr;picture origin rect: picture corner.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">CornerCursor showwhile⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[pt&larr;user mp+16.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ user nobug do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[newframe corner&larr;pt.  newframe comp.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pt&larr;user mp+16.  newframe comp].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ user anybug do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[newframe corner&larr;pt.  newframe comp.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pt&larr;user mp+16.  newframe comp]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">clear unused areas from old picture to background,<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">and clear new picture areas to white</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">oldframe&larr;picture inset: ¬2⌾¬2.  "</span><span class="italic small">¬2 is for erasing old border</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ r from: (oldframe minus: newframe) do⦂ [r clear: background].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ r from: (newframe minus: picture) do⦂ [r clear: white].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">picture title: picture title in: newframe; saveScreenBits.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self frame: newframe; show; takeCursor; enter]</span></div>
<div class="line left">
<span class="bold small">leave<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[[nil≡saveActionPic⇒[]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> actionpic bitsFromString: saveActionPic.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> saveActionPic &larr; nil.].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> [nil≡ saveToolPic⇒[]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> toolpic bitsFromString: saveToolPic.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> saveToolPic&larr;nil].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[dirty⇒[picture saveScreenBits. dirty &larr; false]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">frame border: 3 color: white]</span></div>
<div class="line left">
<span class="bold small">lostMouse </span><span class="small">[⇑(frame has: user mp)≡false]</span></div>
<div class="line left">
<span class="bold small">outside </span><span class="small">| pt<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[toolpic has: (pt&larr;user mp)⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[user redbug⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[tool&larr;tools bug: pt. tool frame: frame; showon: actionbuttons]]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">actionpic has: pt⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[user redbug⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[tool setfrom: actionbuttons]]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑false]</span></div>
<div class="line left">
<span class="bold small">redbug </span><span class="small">[dirty&larr;true.  tool redbug]</span></div>
<div class="line left">
<span class="bold small">showtitle   </span><span class="italic small">"The BitRectEditor have a menu where the title used to be"</span></div>
<div class="line left">
<span class="bold small">title </span><span class="small">[⇑picture title]</span></div>
<div class="line left">
<span class="bold small">tool </span><span class="small">[⇑ tool]</span></div>
<div class="line left">
<span class="bold small">yellowbug<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[picture is: BitImage⇒ [ picture yellowbug] <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪BitRectEditor under: &rsquo;Picture Editor&rsquo;.</span></div>
<div class="line left">
<span class="small">BitRectEditor classInit</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"BitRectTool"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;BitRectTool&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: Object<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;action "&lt;UniqueString&gt; the current action"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">pencil  "&lt;Turtle&gt; used for draw or straight-edge"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">brush  "&lt;BitRect&gt; source for painting"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">mode  "&lt;Integer&gt; how brush combines with the destination"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">tone  "&lt;Integer&gt; a spatial half-tone color (4 bits by 4 bits)"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">grid  "&lt;Integer&gt; all mouse points are rounded to this"&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;blowupScale graypens brushpt &rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>A BitRectTool paints on the screen.<br>A tool is a combination of action, mode, pen-width, gray, and grid.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">action is one of: make-brush, paint, block-of-gray, draw, straight-edge, magnify.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">mode is one of: store, or, xor, and.  (how tool is combined with picture)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">pen-width is 1, 2, 4, or 8.  (width of the pen)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">gray is one of: black, darkgray, gray, lightgray, white.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">grid is one of: 1, 2, 4, 8, 16, 32.   (minimum spacing of mouse points)<br>Menus for each part of a tool appear above the picture (in the same order).<br>Some actions do not use certain of the other parts of a tool.<br>(example: Block-of-gray does not use pen-width.)<br><br>brushpt = Point in the menu where brush is shown.<br>graypens = Vector of Strings of bits in pens.</span></div>
<div class="line left">
<span class="bold large"><br>Tool action</span></div>
<div class="line left">
<span class="bold small">block </span><span class="small">[self getRectangle color: tone mode: mode]</span></div>
<div class="line left">
<span class="bold small">blowup </span><span class="small">| smallRect bigRectFrame<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[smallRect&larr;self getRectangle.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bigRectFrame &larr; Rectangle new origin: smallRect corner<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">extent: 4⌾4 + (smallRect  extent*blowupScale).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">smallRect empty or⦂ bigRectFrame bitStringLength&gt;4000⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[pencil frame flash.  ⇑nil].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[user screenrect has: bigRectFrame corner⇒[] <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bigRectFrame moveto: smallRect origin-bigRectFrame extent.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user screenrect has: bigRectFrame origin⇒[]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">can&rsquo;t find a space for blown up image</span><span class="small">"</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pencil frame flash.  ⇑nil].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self blowup: smallRect to: bigRectFrame]</span></div>
<div class="line left">
<span class="bold small">blowup: smallRect to: bigRectFrame<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">| bigRect box pt i turt flag bits<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[bits &larr; bigRectFrame bitsIntoString.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bigRect &larr; bigRectFrame inset: 2⌾2.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">smallRect blowup: bigRect origin by: blowupScale.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">turt&larr;Turtle init.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">box &larr; 0⌾0 rect: (blowupScale-1)⌾(blowupScale-1).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">keep editing in blowup mode until the user presses a button<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">outside the big rect</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ flag do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[bigRect has: (pt &larr; user mp)⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[box moveto: bigRect origin + (i &larr; pt-bigRect origin|blowupScale).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">turt place: smallRect origin + (i/blowupScale).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user redbug⇒[box color: black mode: storing. <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">turt black; go: 0]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user yellowbug⇒[box color: white mode: storing. <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">turt white; go: 0]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user bluebug⇒[bigRect flash]]</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user anybug ⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[(bigRect inset: ¬5⌾¬5) has: pt⇒[bigRect flash]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">quit</span><span class="small">" flag&larr;false]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bigRectFrame bitsFromString: bits]</span></div>
<div class="line left">
<span class="bold small">brush </span><span class="small">[⇑brush]</span></div>
<div class="line left">
<span class="bold small">brush: sourceRect   </span><span class="small">"</span><span class="italic small">use the bits in the BitRect </span><span class="small italic underline">sourceRect</span><span class="italic small"> as a brush</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">| minpt maxpt pt offset<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["</span><span class="italic small">The inner painting loop should be fast - all the extra foliage below<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">is to move tests outside of the inner loop</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">sourceRect moveto: brushpt; show.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">minpt&larr;self frame origin.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">maxpt&larr;self frame corner-sourceRect extent.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">offset&larr;sourceRect extent/2.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">If mode is storing or oring, use brush command, otherwise blt.</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">Use the unclipped form of brushing  and grid=1 when possible</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[mode&lt;xoring and⦂ grid=1⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[while⦂ user redbug do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[minpt≤(pt&larr;user mp-offset) and⦂ pt≤maxpt⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[sourceRect brush: pt mode: mode color: tone]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">sourceRect brush: pt mode: mode color: tone clippedBy: self frame]]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> mode≥xoring and⦂ grid=1⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[while⦂ user redbug do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[minpt≤(pt&larr;user mp-offset) and⦂ pt≤maxpt⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[sourceRect blt: pt mode: mode]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">sourceRect blt: pt mode: mode clippedBy: self frame]]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> mode&lt;xoring⇒   "</span><span class="italic small">grid is &gt; 1</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[while⦂ user redbug do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[minpt≤(pt&larr;self mpOnGrid-offset) and⦂ pt≤maxpt⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[sourceRect brush: pt mode: mode color: tone]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">sourceRect brush: pt mode: mode color: tone clippedBy: self frame]]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> "</span><span class="italic small">grid is &gt; 1 and mode≥xoring</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ user redbug do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[minpt≤(pt&larr;self mpOnGrid-offset) and⦂ pt≤maxpt⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[sourceRect blt: pt mode: mode]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">sourceRect blt: pt mode: mode clippedBy: self frame]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">draw<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[tone=white or⦂ tone=black⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[pencil place: self mpOnGrid-pencil frame origin.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">grid=1⇒</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">make drawing with grid 1 fast</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[while⦂ user redbug do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[pencil goto: user mp-pencil frame origin]]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ user redbug do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[pencil goto: self mpOnGrid-pencil frame origin]]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self brush: graypens◦pencil width]</span></div>
<div class="line left">
<span class="bold small">getRectangle </span><span class="small">| rect newrect start t   </span><span class="italic small">"rect must be in my frame"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["</span><span class="italic small">the rect-newrect stuff is so that the complementing stays<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">on for a while</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">start&larr;self mpOnGrid.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">rect&larr;newrect&larr;(Rectangle new origin: start corner: start)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">intersect: self frame.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">move the cursor slightly so that the user will notice the rectangle<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">being complemented</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user cursorloc&larr;start+4.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ user anybug do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[rect&larr;newrect.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">rect comp.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">t&larr;self mpOnGrid.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">newrect&larr;(Rectangle new origin: (start min: t) corner: (start max: t))<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">intersect: self frame.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">rect comp].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑rect]</span></div>
<div class="line left">
<span class="bold small">line </span><span class="small">| start end width</span><span class="bold small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[start&larr;end&larr;self mpOnGrid-pencil frame origin.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">width&larr;pencil width.  pencil xor; width: 1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ user redbug do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[end&larr;self mpOnGrid-pencil frame origin.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pencil xor; place: start; goto: end; place: start; goto: end].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[tone=white⇒[pencil white] pencil black].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pencil width: width; place: start; goto: end]</span></div>
<div class="line left">
<span class="bold small">mode<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑ mode]</span></div>
<div class="line left">
<span class="bold small">mpOnGrid   </span><span class="italic small">"return mouse point rounded to </span><span class="small italic underline">grid</span><span class="italic small">"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑user mp+(grid/2) | grid]</span></div>
<div class="line left">
<span class="bold small">paint<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self brush: brush]</span></div>
<div class="line left">
<span class="bold small">redbug </span><span class="small">[self perform: action]</span></div>
<div class="line left">
<span class="bold small">setbrush </span><span class="small">| rect<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[rect&larr;self getRectangle.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">rect empty or⦂ 50⌾50&lt;rect extent⇒[pencil frame flash].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">brush color: white mode: storing.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">brush title: &rsquo;brush&rsquo; in: rect; saveScreenBits.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">brush moveto: brushpt; show.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">action &larr; ↪paint]</span></div>
<div class="line left">
<span class="bold small">shade </span><span class="small">| p1 p2 a b t p r vs "down on redbug is black place.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">up on redbug is white place.  Subsequent redbugs<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">paint a shade of gray depending on position between<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">black and white (and beyond white to black again).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">Yellow or blue bug terminates."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[until⦂ user redbug do⦂ [p1 &larr; user mp]. "black"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">until⦂ user nobug do⦂ [p2 &larr; user mp]. "white"<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">vs &larr; ↪( ¬1  ¬1025  ¬1089  ¬585  ¬4681  ¬6731  ¬22058  ¬27031   ¬26986  ¬31191  ¬32108   5160  5128  8321  1025 01 0).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">r &larr; 0⌾0 rect: 10⌾10.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">b&larr;(p1-p2). b &larr; b x asFloat ⌾ b y asFloat.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">a &larr; b x * b x + (b y * b y) /16.0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">until⦂ (user yellowbug or⦂ user bluebug) do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[user redbug ⇒[p&larr;user mp.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">t &larr; b* (p-p2).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">t &larr; (t x + t y /a) asInteger abs min: 16.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">brush brush: p mode: mode color: vs◦(17-t)]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span></div>
<div class="line left">
<span class="bold small">tone<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑ tone]</span></div>
<div class="line left">
<span class="bold large"><br>Tool selection</span></div>
<div class="line left">
<span class="bold small">brushpt: pt  </span><span class="small">"</span><span class="italic small">set the point at which the current brush will be shown</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[brushpt&larr;pt]</span></div>
<div class="line left">
<span class="bold small">frame </span><span class="small">[⇑pencil frame]</span></div>
<div class="line left">
<span class="bold small">frame: f </span><span class="small">[pencil frame: f]</span></div>
<div class="line left">
<span class="bold small">setfrom: butvec </span><span class="small">| pt<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[butvec◦1 has: (pt &larr; user mp) ⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[action &larr; butvec◦1 bug: pt]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">butvec◦2 has: pt ⇒[tone &larr; butvec◦2 bug: pt.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">tone=white ⇒[pencil white] pencil black]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">butvec◦3 has: pt ⇒[mode &larr; butvec◦3 bug: pt]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">butvec◦4 has: pt ⇒[pencil width: (butvec◦4 bug: pt)]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">butvec◦5 has: pt ⇒[grid &larr; butvec◦5 bug: pt]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">showon: butvec<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[butvec◦1 setvalue: action.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">butvec◦2 setvalue: tone.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">butvec◦3 setvalue: mode.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">butvec◦4 setvalue: pencil width.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">butvec◦5 setvalue: grid]</span></div>
<div class="line left">
<span class="bold large"><br>Class initialization</span></div>
<div class="line left">
<span class="bold small">classInit </span><span class="small">| rect saveBits t i<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[blowupScale&larr;4.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"make a vector of gray pens"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">rect &larr; 0⌾0 rect: 9⌾9.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">saveBits&larr;rect bitsIntoString.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">t &larr; Turtle init.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">graypens &larr; Vector new: 8.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: 8 do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[t width: i.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">rect clear: white. <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">t place: 4⌾4; go: 0. <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">graypens◦i &larr; BitRect new title: &rsquo;graypen&rsquo; in: rect.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(graypens◦i) saveScreenBits].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">rect bitsFromString: saveBits]</span></div>
<div class="line left">
<span class="bold small">init<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[(pencil &larr; Turtle new) init; black; width: 2.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(brush &larr; BitRect new) title: &rsquo;brush&rsquo; in: (0⌾0 rect: 16⌾16).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">tone &larr; black. mode &larr; 0. grid &larr; 1. action &larr; ↪draw]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪BitRectTool under: &rsquo;Picture Editor&rsquo;.</span></div>
<div class="line left">
<span class="small">BitRectTool classInit</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"RadioButtons"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;RadioButtons&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: Object<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;vec  "&lt;Vector&gt; values corresponding to the buttons"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">cur  "&lt;Integer&gt; button currently selected"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">rect  "&lt;Rectangle&gt; contains all the buttons"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">size  "&lt;Integer&gt; width or height of a button"&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;&rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>A RadioButtons is a row or column of square regions ("buttons") on the display screen.  There is always exactly one button pushed.  (RadioButtons is a model of the station selection buttons on a car radio.)  The pushed button has a black box around it.  Each button has a value associated with it, which is returned when the button is pressed.  RadioButtons will not destroy a menu picture (BitRect) displayed in its area, but the RadioButtons has no knowledge of the picture.<br></span></div>
<div class="line left">
<span class="bold large"><br>Pushing a Button</span></div>
<div class="line left">
<span class="bold small">bug: pt </span><span class="small">| r a<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[r &larr; (pt - rect origin - (1⌾1)) / size.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">a &larr; r x + r y + 1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑self push: a]</span></div>
<div class="line left">
<span class="bold small">push: a<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self release: cur thenPush: a.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑vec◦(cur &larr; a)]</span></div>
<div class="line left">
<span class="bold small">setvalue: v </span><span class="small">| i<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"if value has been lost, set self to 1"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">i&larr;(vec find: v) max: 1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self push: i.  ⇑i]</span></div>
<div class="line left">
<span class="bold large"><br>Init and State</span></div>
<div class="line left">
<span class="bold small">has: pt </span><span class="small">[⇑rect has: pt]</span></div>
<div class="line left">
<span class="bold small">moveto: pt<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[rect moveto: pt.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">cur &larr; 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑rect corner x ⌾ rect origin y]</span></div>
<div class="line left">
<span class="bold small">reset </span><span class="small">[cur&larr;0]</span></div>
<div class="line left">
<span class="bold small">value </span><span class="small">[⇑vec◦cur]</span></div>
<div class="line left">
<span class="bold small">vec </span><span class="small">[⇑vec]</span></div>
<div class="line left">
<span class="bold small">vec: vec at: r height: size<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[rect &larr; r rect: r+ ((vec length ⌾ 1)*size).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">cur &larr; 0]</span></div>
<div class="line left">
<span class="bold small">vec: vec at: r width: size<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[rect &larr; r rect: r+ ((1 ⌾ vec length)*size).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">cur &larr; 0]</span></div>
<div class="line left">
<span class="bold large"><br>Private</span></div>
<div class="line left">
<span class="bold small">release: a thenPush: b </span><span class="small">| boxer offset<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[a=b⇒[]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">offset &larr; [size=rect extent y⇒[size⌾0] 0⌾size].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[a≠0⇒[boxer &larr; Rectangle new origin: (offset*(a-1)+rect origin+1)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">extent: size⌾size-1.  boxer comp.  (boxer inset: 1⌾1) comp]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">b≠0⇒[boxer &larr; Rectangle new origin: (offset*(b-1)+rect origin+1)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">extent: size⌾size-1.  boxer comp.  (boxer inset: 1⌾1) comp]]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪RadioButtons under: &rsquo;Picture Editor&rsquo;.</span></div>
    <div class="line left">
<span class="small">&rsquo;From Smalltalk 5.5k XM November 24 on 22 November 1980 at 2:57:08 am.&rsquo;<br></span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large">"Etherworld"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;Etherworld&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: Object<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;&rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">sharing: EtherPool;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>This is, of course, the class that controls all of the basic ethernet operations.  There should not be more than one EtherWorld, and one, E, has to be defined for the system to work.    <br><br>In this implementation, and due to timing considerations, it is expected that the transmitter will post quite quickly;  thus, we disable interrupts and busy wait for its completion.<br><br>In general, the interrupt is only armed when we have started the receiver.  The Etherworld currently uses these input processes in the PrioityScheduler: <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">IntProc, at IntProcLevel (14)  -- awakened when the device interrupts<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">InputProc, at InputProcLevel (13) -- distributes packets to sockets, <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">allowing each  socket to then run.<br><br>Note that some of the timers may be on other levels.<br><br>The ethernet can be in one of several states:<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">if E ≡ nil, there is nothing<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">if E ~≡ nil, etherState can be ethAwake, ethAsleep, ethDead.<br><br>ethDead means E created, and classInit done, but nothing else.<br>ethAsleep means all data structures created, but no attempt to start.<br>ethAwake means it is up and running.<br><br>The messages wakeup,  sleep and kill move to one of those states.<br>Other messages are used for single transitions from adjacent states.<br><br>If you just want to temporarily prevent the device from running use etherStop and etherStart.<br>Should go to ethAsleep (use E sleep) if you quit, since may come up on a different machine.<br><br>The lights on the right side of the screen are Etherworld signals.  They mean  Etherworld awakened; packet addressed to the Alto received; packet being processed; output being sent; and input rejected.<br></span></div>
<div class="line left">
<span class="bold large"><br>Initialization/Termination</span></div>
<div class="line left">
<span class="bold small">classInit <br></span><span class="small">[<br>"if this needs to be filed in again, execute this first<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">Smalltalk declare: ↪EtherPool as: (SymbolTable new init: 32).<br><br>access variables from outside with (for example) with EtherPool◦↪ethAwake"<br><br>Smalltalk declare: ↪(E).<br><br>EtherPool declare: ↪( ethInPacNext checkIncomingCS  <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">IntProcLevel InputProcLevel ethIntBits<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">etherState ethAwake ethAsleep ethDead)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">as: (false,false,14,13,020,0,3,1,0).<br><br>EtherPool declare: ↪(  <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">NETNUM ALTONUM <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">freeQ justArrivedQ   <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">sockeTable routingTable routingHopCount routingUpdateUser<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">IntProc InputProc broadcastFilter <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">IntLight InputLight OutputLight )]</span></div>
<div class="line left">
<span class="bold small">etherStart </span><span class="small">"allows ether to start running again"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"makes sure the interrupt is on, and kicks the device"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">etherState=ethAwake ⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[mem◦0601=0⇒ [mem◦0601&larr;ethIntBits]]. <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self SIO: 3.   "forces it to wake up again"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self notify: &rsquo;Attempt to etherStart when not awake!!.&rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">etherStop </span><span class="small">"temporarily shuts off the ether stuff"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">Top critical⦂ <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">mem◦0601&larr;0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self SIO: 3.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">mem◦0600 &larr; 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">Init </span><span class="small">| i "</span><span class="italic small">move from state ethDead to ethAsleep</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">if we were already running, bring it all down, just in case!!</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[etherState=ethDead ⇒ [] self kill]. "</span><span class="italic small">now sure we are ethDead</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">NETNUM &larr; ALTONUM&larr;0.  "may get reset later"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self setLights.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(justArrivedQ&larr;(SafeQ new) of: (Vector new: 20)) enable.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[freeQ⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(freeQ&larr; (SafeQ new) of: (Vector new: 20)) enable.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: 10 do⦂ [freeQ next&larr; Pacbuf init]]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">justArrivedQ disable].<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">ethInPacNext&larr; self freePacket.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">sockeTable&larr; Dictionary new init: 10. <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">routingTable&larr; String new: 255.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">routingTable all &larr; 0. "1-255, 0 is special"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">routingHopCount &larr; String new: 255.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">routingHopCount all &larr; 8.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">routingUpdateUser &larr; RoutingUpdater init.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self installIntProc.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self installInputProc.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">IntProc enable.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">InputProc enable.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">etherState &larr; ethAsleep.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"we are still asleep, must do a wakeup to get numbers, start, etc."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">kill | socket </span><span class="small">"shuts down ethernet and PUP world completely"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"Should free up all of the storage, etc.....<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">Would need to wakeup or Init, to get started again.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">Device may have been running"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">etherState=ethDead⇒[] "do nothing"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[etherState=ethAwake ⇒ [self sleep]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"everything now shut down"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ socket from: (sockeTable values) do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[socket≡nil⇒[] socket kill]. <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">Top terminate: IntProcLevel; terminate: InputProcLevel.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">ethInPacNext⇒ <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">ethInPacNext≡nil⇒ []<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">ethInPacNext locked⇒[ethInPacNext unlock]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">ethInPacNext &larr; false.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"Release the PQueues to avoid circular data structures"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[freeQ and⦂ freeQ≠nil⇒[freeQ release. freeQ &larr; nil]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[justArrivedQ≠nil⇒[justArrivedQ release. justArrivedQ &larr; nil]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[routingUpdateUser≡ nil⇒ [] routingUpdateUser release].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">routingUpdateUser &larr; routingTable &larr; routingHopCount &larr; nil.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">etherState &larr; ethDead.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">setLights<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[IntLight&larr; Rectangle new origin: 576⌾0 extent: 16⌾16.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">InputLight&larr; Rectangle new origin: 592⌾0 extent: 16⌾16.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">OutputLight&larr;Rectangle new origin: 576⌾16 extent: 16⌾16]</span></div>
<div class="line left">
<span class="bold small">sleep </span><span class="small">| socket "be sure to do this before a user quit" <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">etherState=ethDead ⇒ [self Init] "that is, go from dead to asleep"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">etherState=ethAsleep ⇒ [] "already asleep"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">etherState=ethAwake ⇒ <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["try to shut down gracefully"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ socket from: (sockeTable values) do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[socket≡nil⇒[] socket sleep]. "warn the sockets, leaves them in table"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self etherStop.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">etherState&larr;ethAsleep.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"when next we wake up, may be on a new machine/net"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"when next we wake up, may be on a new machine/net"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">wakeup </span><span class="small">| socket "Try to get everything up and running" <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">etherState=ethAwake ⇒ [self etherStart] "do nothing, kick the receiver".<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[etherState=ethDead ⇒ [self sleep]]. "that is, go from dead to asleep"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">etherState=ethAsleep ⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["this is the tricky one, need to get our machine # and routing table.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">may have come up on a different network and host, assume the worst"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">ALTONUM &larr; self getMachineID.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self setMachineID: ALTONUM.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">NETNUM &larr; 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ socket from: sockeTable values do⦂ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">socket≡nil⇒ [] socket setOutAddBlock].<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">etherState &larr; ethAwake.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self etherStart.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">routingUpdateUser update.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">NETNUM = 0⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">etherState &larr; ethAsleep.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user notify: &rsquo;no routing tables&rsquo;]<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"tell leftover sockets current net&host, and that we are awake again"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ socket from: (sockeTable values) do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[socket≡nil⇒[] socket setOutAddBlock; wakeup]. <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self notify: &rsquo;In wakeup, found Ethernet in some unknown state.&rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold large"><br>Input Interrupt Routines</span></div>
<div class="line left">
<span class="bold small">copyinput: string </span><span class="small">[user croak] primitive: 108</span></div>
<div class="line left">
<span class="bold small">installInputProc </span><span class="small">| inBuf destSoc [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">InputProc &larr; Top install⦂ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ [true] do⦂ [  "</span><span class="italic small">infinite loop for process in scheduler</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">InputLight comp. <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ [inBuf&larr;justArrivedQ next] do⦂ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">process each incoming buffer, know it&rsquo;s a PUP</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">verify the incoming checksum</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">checkIncomingCS and⦂ (inBuf checksumOK)≡false⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["</span><span class="italic small">reject it, done</span><span class="small">" self freePacket: inBuf]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">To be honest, we should check the destNet and destHost,<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">but they generally have to be OK.....<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">OK to pass the packet on</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(destSoc &larr; sockeTable lookup: inBuf destSocNum) ⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ destSoc acceptPacbuf: inBuf].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">couldn&rsquo;t find a socket for it, done</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> self freePacket: inBuf]. <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">InputLight comp. <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">InputProc sleep   "</span><span class="italic small">last action in the loop</span><span class="small">"]] <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">at: InputProcLevel]</span></div>
<div class="line left">
<span class="bold small">installIntProc  </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">IntProc &larr; Top install⦂ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ [true] do⦂ [  "</span><span class="italic small">infinite loop for process in scheduler.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">Interrupt just happened, running at a high level, interface off.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">Something just happened, do the common cases first.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">Input is wired down below; only comes here if OK.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">Note: we can only come here if last action was to start the rec!!</span><span class="small">"<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">IntLight comp. <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">copy out the packet first</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ethInPacNext ⇒[self copyinput: ethInPacNext pupString]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"user cr; show: &rsquo;warning, no packet pre-fetched. tell John&rsquo;."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">ethInPacNext &larr; self freePacket⇒ [self copyinput: ethInPacNext pupString]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"user cr; show: &rsquo;input lost&rsquo;"].<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">start the receiver</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self SIO: 2.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ethInPacNext⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">now process this input</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">justArrivedQ next&larr; ethInPacNext. <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">ethInPacNext &larr; self freePacket.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">Top wakeup: InputProcLevel.  "</span><span class="italic small">all done</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]].<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">IntLight comp. <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">IntProc sleep    "</span><span class="italic small">last action in the loop</span><span class="small">"]]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">at: IntProcLevel]<br></span></div>
<div class="line left">
<span class="bold large"><br>Output Routines</span></div>
<div class="line left">
<span class="bold small">doOutput: string </span><span class="small">[] primitive: 100</span></div>
<div class="line left">
<span class="bold small">sendOutput: ethOutPac </span><span class="small">| post<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">This is the one and only place from which we  send output.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">Only one packet gets passed in to us at a time.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">For performance, we wait here for the transmitter to post!!!!<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">Nominally, we are running at level 0;  thus, this must be run<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">at a Top critical, to protect from multiple calls.</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[etherState≠ethAwake ⇒ <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self wakeup. user show: &rsquo;starting Ethernet...&rsquo;]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">Top critical⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">OutputLight comp. <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">mem◦0606&larr; (ethOutPac totLengthWords)."EthOutCntLoc"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[(post &larr; self doOutput: ethOutPac pupString) ≠ 0777 ⇒ <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[user cr; show: &rsquo;Warning, bad output post: &rsquo;+ post base8]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">OutputLight comp. <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]. "end of the critical part"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold large"><br>User messages</span></div>
<div class="line left">
<span class="bold small">awake </span><span class="small">[⇑etherState = ethAwake]</span></div>
<div class="line left">
<span class="bold small">broadcastFilter: val<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[val ⇒ [broadcastFilter&larr;true. self broadcastFilterSet: 1] <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">broadcastFilter &larr; false.  self broadcastFilterSet: 0.]</span></div>
<div class="line left">
<span class="bold small">broadcastFilterSet: val<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[user croak ] primitive: 107</span></div>
<div class="line left">
<span class="bold small">freePacket </span><span class="small">| p [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">get a packet</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">freeQ⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(p &larr; freeQ next) ⇒ [⇑p]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user show: &rsquo;Warning, empty freeQ, in Etherworld&rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑false]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑Pacbuf new init]</span></div>
<div class="line left">
<span class="bold small">freePacket: p </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">put a used packet into free queue</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[freeQ and⦂ p⇒ [freeQ next &larr; p]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑false]</span></div>
<div class="line left">
<span class="bold large"><br>Utility messages</span></div>
<div class="line left">
<span class="bold small">error: str </span><span class="small">[user cr. user show: str]</span></div>
<div class="line left">
<span class="bold small">fill </span><span class="small">| "I want to replenish the freeQ" outstanding [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">freeQ≡false or⦂ freeQ≡nil⇒ []<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">outstanding &larr; (Pacbuf howMany) - (freeQ length).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user cr; show: (outstanding asString)+&rsquo; packets outstanding&rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">until⦂ [freeQ length=10] do⦂ [freeQ next &larr; Pacbuf init].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">getMachineID  </span><span class="small">[⇑ (self SIO: 0) \ 256]</span></div>
<div class="line left">
<span class="bold small">notify: strng </span><span class="small">| "turn off the Ethernet before doing a user notify" <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self etherStop.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user show: &rsquo; Etherworld stopped&rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> [Top currentPriority ≠ 1⇒[user cr; show: &rsquo;priority is &rsquo; + (Top currentPriority) asString.  ]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> user notify: strng]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;</div>
<div class="line left">
<span class="bold small">printon: s </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">etherState = ethDead ⇒ [s append: &rsquo;Etherworld,  etherState = ethDead.&rsquo;].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s append: &rsquo;Etherworld running on &rsquo;; print: NETNUM;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">append: &rsquo;#&rsquo;+(ALTONUM base8)+&rsquo;#&rsquo; ; cr.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[freeQ⇒ [s print: freeQ length; append: &rsquo; Pacbufs in freeQ&rsquo;]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s append: &rsquo;no freeQ&rsquo;].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s cr; append: &rsquo;etherState = &rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">etherState = ethAsleep ⇒ [s append: &rsquo;etherAsleep&rsquo;].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">etherState = ethAwake ⇒ [s append: &rsquo;etherAwake&rsquo;].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s print: etherState.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">printRoutingTable </span><span class="small">| </span><span class="bold small">i </span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i from: 1 to: 255 do⦂ <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">routingTable◦i ≠ 0 ⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user cr.  user show: &rsquo;To net &rsquo; + i asString + <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">&rsquo; via host &rsquo; + (routingTable◦i) asString + &rsquo;, hop count = &rsquo; +<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(routingHopCount◦i) asString.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user cr.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">] </span></div>
<div class="line left">
<span class="bold small">printSocketTable </span><span class="small">| i [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">sockeTable≡nil⇒[user cr; show: &rsquo;no socketTable&rsquo;]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i from: sockeTable objects do⦂ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">i≡nil⇒[]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user cr; print: i; show: &rsquo;, &rsquo;; print: sockeTable◦i<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;</div>
<div class="line left">
<span class="bold small">setMachineID: ID </span><span class="small">[mem◦0610 &larr; ID]</span></div>
<div class="line left">
<span class="bold small">SIO: sioArg </span><span class="small">[] primitive: 91</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪Etherworld under: &rsquo;Ethernet Control&rsquo;.</span></div>
<div class="line left">
<span class="small">Etherworld classInit</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"Int32"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;Int32&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: Number<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;high low&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;&rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>This class should probably be part of Number rather than Etherworld.<br>NOTE THAT + AND - SHOULD BE FIXED TO RETURN TO SMALLTALK IF TYPE OF ARG IS NOT INT32</span></div>
<div class="line left">
<span class="bold large"><br>Initialization</span></div>
<div class="line left">
<span class="bold small">asInteger </span><span class="small">[high = 0 ⇒ [⇑ low] ⇑high*65536 + low]</span></div>
<div class="line left">
<span class="bold small">high: high low: low</span></div>
<div class="line left">
<span class="bold large"><br>Info about self</span></div>
<div class="line left">
<span class="bold small">hash </span><span class="small">[⇑ low]</span></div>
<div class="line left">
<span class="bold small">high </span><span class="small">[⇑ high]</span></div>
<div class="line left">
<span class="bold small">low </span><span class="small">[⇑ low]</span></div>
<div class="line left">
<span class="bold small">printon: strm <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[high printon: strm base: 8. strm append: &rsquo;|&rsquo;. low printon: strm base: 8 ]</span></div>
<div class="line left">
<span class="bold large"><br>Arithmetic</span></div>
<div class="line left">
<span class="bold small">≠ arg </span><span class="small">[⇑ low ≠ arg low or⦂ high ≠ arg high]</span></div>
<div class="line left">
<span class="bold small">+ arg </span><span class="small">[⇑self + arg asInt32] primitive: 93</span></div>
<div class="line left">
<span class="bold small">- arg </span><span class="small">[⇑self - arg asInt32] primitive: 92</span></div>
<div class="line left">
<span class="bold small">&lt; arg </span><span class="italic small">"revised M. Dolbec 6/25/80"</span><span class="bold small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[high = arg high⇒ <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[low &lt; 0 ⇒ <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[arg low &lt; 0 ⇒ <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑low &gt; arg low]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑false]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">arg low &gt; 0 ⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑low &lt; arg low] <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑true]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑high &lt; arg high]</span></div>
<div class="line left">
<span class="bold small">= arg </span><span class="small">[⇑low = arg low and⦂ high = arg high]</span></div>
<div class="line left">
<span class="bold small">&gt; arg </span><span class="italic small">"revised M. Dolbec 6/25/80"</span><span class="bold small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑arg &lt; self]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪Int32 under: &rsquo;Ethernet Control&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"Pacbuf"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;Pacbuf&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: Object<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;pupString locked&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;&rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>This is the basic unit for building and interpreting packets for the ethernet.<br>It contains the messages that allow fields of a packet to be filled and read.<br>Most users will prefer to use the socket mechanisms</span></div>
<div class="line left">
<span class="bold large"><br>Initialization</span></div>
<div class="line left">
<span class="bold small">init <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[pupString &larr; String new: 558.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">locked &larr; false]</span></div>
<div class="line left">
<span class="bold large"><br>Ethernet header</span></div>
<div class="line left">
<span class="bold small">ethType </span><span class="small">[⇑pupString word: 2]</span></div>
<div class="line left">
<span class="bold small">ethType&larr; eT </span><span class="small">[pupString word: 2 &larr; eT]</span></div>
<div class="line left">
<span class="bold small">imEthDestHost </span><span class="small">[⇑pupString◦1]</span></div>
<div class="line left">
<span class="bold small">imEthDestHost&larr; iEDH </span><span class="small">[pupString◦1 &larr; iEDH]</span></div>
<div class="line left">
<span class="bold small">imEthSrcHost </span><span class="small">[⇑pupString◦2]</span></div>
<div class="line left">
<span class="bold small">imEthSrcHost&larr; iESH </span><span class="small">[pupString◦2 &larr; iESH]</span></div>
<div class="line left">
<span class="bold large"><br>PUP Header</span></div>
<div class="line left">
<span class="bold small">addressBlock </span><span class="small">[⇑pupString◦(13 to: 24) ]</span></div>
<div class="line left">
<span class="bold small">addressBlock&larr; addBlock </span><span class="small">"for quickly setting the 6 fields" [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"pupString◦(13 to: 24) &larr; addBlock"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pupString copy: 13 to: 24 with: addBlock from: 1 to: 12]</span></div>
<div class="line left">
<span class="bold small">destHost </span><span class="small">[⇑pupString◦14]</span></div>
<div class="line left">
<span class="bold small">destHost&larr; dH </span><span class="small">[pupString◦14 &larr; dH]</span></div>
<div class="line left">
<span class="bold small">destNet </span><span class="small">[⇑pupString◦13]</span></div>
<div class="line left">
<span class="bold small">destNet&larr; dN </span><span class="small">[pupString◦13 &larr;  dN]</span></div>
<div class="line left">
<span class="bold small">destSoc0 </span><span class="small">[⇑pupString word: 8]</span></div>
<div class="line left">
<span class="bold small">destSoc0&larr; i </span><span class="small">[⇑pupString word: 8&larr;i]</span></div>
<div class="line left">
<span class="bold small">destSoc1 </span><span class="small">[⇑pupString word: 9]</span></div>
<div class="line left">
<span class="bold small">destSoc1&larr; i </span><span class="small">[⇑pupString word: 9&larr;i]</span></div>
<div class="line left">
<span class="bold small">destSocNum </span><span class="small">[⇑Int32 new high: (pupString word: 8) low: (pupString word: 9) ]</span></div>
<div class="line left">
<span class="bold small">destSocNum&larr; dSN </span><span class="small">[pupString word: 8 &larr; dSN high.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> pupString word: 9 &larr; dSN low]</span></div>
<div class="line left">
<span class="bold small">pupID </span><span class="small">[⇑Int32 new high: (pupString word: 5) low: (pupString word: 6) ]</span></div>
<div class="line left">
<span class="bold small">pupID0 </span><span class="small">[⇑pupString word: 5 ]</span></div>
<div class="line left">
<span class="bold small">pupID0&larr; pID </span><span class="small">[⇑pupString word: 5 &larr; pID ]</span></div>
<div class="line left">
<span class="bold small">pupID1 </span><span class="small">[⇑pupString word: 6 ]</span></div>
<div class="line left">
<span class="bold small">pupID1&larr; pID </span><span class="small">[⇑pupString word: 6 &larr; pID ]</span></div>
<div class="line left">
<span class="bold small">pupID&larr; pID </span><span class="small">[pupString word: 5 &larr; pID high.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> pupString word: 6 &larr; pID low]</span></div>
<div class="line left">
<span class="bold small">pupLength </span><span class="small">[⇑pupString word: 3]</span></div>
<div class="line left">
<span class="bold small">pupLength&larr; pL </span><span class="small">[⇑pupString word: 3 &larr; pL]</span></div>
<div class="line left">
<span class="bold small">pupType </span><span class="small">[⇑pupString◦8]</span></div>
<div class="line left">
<span class="bold small">pupType&larr; pT </span><span class="small">[pupString◦8 &larr; pT]</span></div>
<div class="line left">
<span class="bold small">sourceHost </span><span class="small">[⇑pupString◦20]</span></div>
<div class="line left">
<span class="bold small">sourceHost&larr; sH </span><span class="small">[pupString◦20 &larr; sH]</span></div>
<div class="line left">
<span class="bold small">sourceNet </span><span class="small">[⇑pupString◦19]</span></div>
<div class="line left">
<span class="bold small">sourceNet&larr; sN </span><span class="small">[pupString◦19 &larr; sN]</span></div>
<div class="line left">
<span class="bold small">sourceSoc0 </span><span class="small">[⇑pupString word: 11]</span></div>
<div class="line left">
<span class="bold small">sourceSoc0&larr; i </span><span class="small">[⇑pupString word: 11&larr;i]</span></div>
<div class="line left">
<span class="bold small">sourceSoc1 </span><span class="small">[⇑pupString word: 12]</span></div>
<div class="line left">
<span class="bold small">sourceSoc1&larr; i </span><span class="small">[⇑pupString word: 12&larr;i]</span></div>
<div class="line left">
<span class="bold small">sourceSocNum </span><span class="small">[⇑Int32 new high: (pupString word: 11) low: (pupString word: 12)]</span></div>
<div class="line left">
<span class="bold small">sourceSocNum&larr; sSN </span><span class="small">[pupString word: 11 &larr; sSN high.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> pupString word: 12 &larr; sSN low]</span></div>
<div class="line left">
<span class="bold small">swapPorts </span><span class="small">| i [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i from: 13 to: 18 do⦂ [pupString swap: i with: i+6]]</span></div>
<div class="line left">
<span class="bold small">totLengthWords </span><span class="small">[⇑((self pupLength)+5)/2]</span></div>
<div class="line left">
<span class="bold small">transportControl </span><span class="small">[⇑pupString◦7]</span></div>
<div class="line left">
<span class="bold small">transportControl&larr; tC </span><span class="small">[pupString◦7 &larr; tC]</span></div>
<div class="line left">
<span class="bold large"><br>PUP Checksum</span></div>
<div class="line left">
<span class="bold small">checksum  </span><span class="small">[⇑pupString word: ((self pupLength+1)/2)+2]</span></div>
<div class="line left">
<span class="bold small">checksumOK </span><span class="small">"Boolean, returns true or false"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["just look at the current packet"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑self checksum = self doChecksum]</span></div>
<div class="line left">
<span class="bold small">checksum&larr;  cs <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold small"> </span><span class="small">[pupString word: (((self pupLength+1)/2)+2) &larr; </span><span class="bold small">cs</span><span class="small">]</span></div>
<div class="line left">
<span class="bold small">doChecksum </span><span class="small">| i cs <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">cs &larr; 0. <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i from: (3 to: (((self length + 1)/2)+2)) do⦂ "does not work"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[cs&larr;cs+(pupString word: i). </span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">   "for packets with carries"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[cs &lt;0⇒[cs &larr; (cs lshift: 1)+1] cs &larr; cs lshift: 1]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[cs=¬1⇒[cs &larr; 0]]. <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑cs<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">] primitive: 94 </span></div>
<div class="line left">
<span class="bold large"><br>Data </span></div>
<div class="line left">
<span class="bold small">dataLength </span><span class="small">[⇑(pupString word: 3) "self pupLength" - 22]</span></div>
<div class="line left">
<span class="bold small">dataLength&larr; len </span><span class="small">[⇑pupString word: 3 "self pupLength" &larr; len + 22]</span></div>
<div class="line left">
<span class="bold small">dataString </span><span class="small">[⇑pupString copy: 25 to: 24+self dataLength]</span></div>
<div class="line left">
<span class="bold small">dataString&larr; str </span><span class="small">| i [</span><span class="bold small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">i &larr; str length.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">i &gt; 532 ⇒ [user notify: &rsquo;Data string too big for single PUP&rsquo;]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pupString copy: 25 to: 24 + i with: str from: 1 to: i.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self dataLength &larr; i.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑str]</span></div>
<div class="line left">
<span class="bold small">dataWord: i </span><span class="small">[⇑pupString word: i + 12]</span></div>
<div class="line left">
<span class="bold small">dataWord: i &larr; v </span><span class="small">[⇑pupString word: i + 12 &larr; v]</span></div>
<div class="line left">
<span class="bold large"><br>Etc</span></div>
<div class="line left">
<span class="bold small">◦ i </span><span class="small">[⇑pupString◦i]</span></div>
<div class="line left">
<span class="bold small">◦ i &larr; v </span><span class="small">[⇑pupString◦i &larr; v]</span></div>
<div class="line left">
<span class="bold small">header </span><span class="small">[⇑pupString◦(1 to: 24) ]</span></div>
<div class="line left">
<span class="bold small">lock </span><span class="small">[locked⇒[E notify: &rsquo;trying to lock a buffer already locked&rsquo;]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">locked&larr;true. ⇑pupString lock]</span></div>
<div class="line left">
<span class="bold small">locked </span><span class="small">[⇑locked]</span></div>
<div class="line left">
<span class="bold small">lockwith: string </span><span class="small">[locked⇒[E notify: &rsquo;trying to lock a buffer already locked&rsquo;]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">locked&larr;string. ⇑pupString lock]</span></div>
<div class="line left">
<span class="bold small">pupString  </span><span class="small">[⇑pupString]</span></div>
<div class="line left">
<span class="bold small">pupString &larr; pupString </span><span class="small">[⇑pupString]</span></div>
<div class="line left">
<span class="bold small">unlock </span><span class="small">[locked⇒[locked&larr;false.  pupString unlock]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user notify: &rsquo;trying to unlock a buffer not locked&rsquo;]</span></div>
<div class="line left">
<span class="bold small">word: i </span><span class="small">[⇑pupString word: i]</span></div>
<div class="line left">
<span class="bold small">word: i &larr; v </span><span class="small">[⇑pupString word: i &larr; v]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪Pacbuf under: &rsquo;Ethernet Control&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"SafeQ"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;SafeQ&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: PQueue<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;enabled&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;&rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>checks all objects enqueued, to be sure not there already</span></div>
<div class="line left">
<span class="bold large"><br>As yet unclassified</span></div>
<div class="line left">
<span class="bold small">disable </span><span class="small">[enabled &larr; false]</span></div>
<div class="line left">
<span class="bold small">enable </span><span class="small">[enabled &larr; true]</span></div>
<div class="line left">
<span class="bold small">length </span><span class="small">[⇑position - readposition]<br></span></div>
<div class="line left">
<span class="bold small">next &larr; arg </span><span class="small">| i "short comment" [[enabled⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i from: (readposition+1) to: position do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(array◦i)≡arg⇒[E notify: &rsquo;putting same guy on Q twice&rsquo;]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">arg locked⇒[E notify: &rsquo;putting locked Pacbuf on Q&rsquo;]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">super next &larr; arg<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">status </span><span class="small">[⇑enabled]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪SafeQ under: &rsquo;Ethernet Control&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"Socket"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;Socket&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: Object<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;socNumber computeOutgoingCS filterInput outAddBlock<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">lclSocNum frnNet frnHost frnSocNum&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;&rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">sharing: EtherPool;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>Sockets are used to do all communication through the net.  <br>It is expected that a specialized server or process can have<br>its own subclass of Socket with its own definitions of the<br>&rsquo;Overwrite by Subclass&rsquo; operations.  Note that subclasses will<br>have to access some global variables. <br><br>Each socket is identified by a 32-bit lclSocNum, which really<br>defines who we are.<br>In addition, aspects of the lcl and frn addresses are used  to make<br>decisions about accepting<br>incoming packets, addressing outgoing packets, defaulting fields, etc.<br><br>The input distributor assures that an input was destined for our net<br>(not trying to<br>find a gateway) and our host (either explicitly or as broadcast, <br>if not filtered), and found us by socket number.  Input need NOT be<br>filtered by the socket according to source, since the client may want<br>to see error messages from an intermediate address.<br><br>As a convenience, however, the socket can be asked to filterInput,<br>so it only accepts things which match the frnPort.<br>Thus, local and foreign attributes are primarily used to default<br>fields of an outgoing  packet.</span></div>
<div class="line left">
<span class="bold large"><br>Initialization</span></div>
<div class="line left">
<span class="bold small">default <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["default local socket number and leave frn port open"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self net: 0 host: 0 soc: (Int32 new high: 0 low: 0)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">from: lclSocNum  <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["set lcl soc number, leave frnPort open -- useful for creating<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">a well-known socket as a listener"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self from: lclSocNum net: 0 host: 0 soc: (Int32 new high: 0 low: 0)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">from: lclSocNum net: frnNet host: frnHost soc: frnSocNum <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold small"> </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"this is the most general initialization, both lcl soc# and frnPort given"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">outAddBlock &larr; String new: 12.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self setOutAddBlock.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">computeOutgoingCS &larr; filterInput &larr; false. <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">sockeTable insert: lclSocNum with: self.  "put me in socket table"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self doMoreInit<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">hostName: name </span><span class="small">| a nh [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">lookup name, then set net and host numbers (maybe socket?)</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">a &larr; NameUser init.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nh &larr; a getAddressBlock: name.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">since this socket may get many responses,<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">make sure socket is not half deleted from sockeTable after first response</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">Top critical⦂ [a close].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nh⇒ [self net: nh◦1 host: nh◦2]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"invalid name?"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑false]</span></div>
<div class="line left">
<span class="bold small">net: frnNet host: frnHost soc: frnSocNum </span><span class="small">[</span><span class="bold small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"default the local socket number:<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">use some memory dependent info (space) for the high word so that no two<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">sockets (instances) can be the same, also non-zero.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">use time for low word, so that same instance will not usually have the<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">same socket number (odds = 1/65536)"<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">lclSocNum &larr; Int32 new high: self nail low: user ticks.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self unNail; from: lclSocNum net: frnNet host: frnHost soc: frnSocNum<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">setOutAddBlock<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">outAddBlock◦1 &larr; frnNet. outAddBlock◦2 &larr; frnHost.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">outAddBlock word: 2 &larr; frnSocNum high.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">outAddBlock word: 3 &larr; frnSocNum low.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">outAddBlock◦7 &larr; NETNUM. outAddBlock◦8 &larr; ALTONUM.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">outAddBlock word: 5 &larr; lclSocNum high.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">outAddBlock word: 6 &larr; lclSocNum low.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">to: h </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">convenient default if on my net</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self net: NETNUM host: h]</span></div>
<div class="line left">
<span class="bold small">wakeup </span><span class="small">| "when E goes from ethAsleep to ethAwak" <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[  ]</span></div>
<div class="line left">
<span class="bold large"><br>Process incoming packet</span></div>
<div class="line left">
<span class="bold small">acceptPacbuf: Ipac </span><span class="small">| temp<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["if we get here, we know that the input distributer has verified the<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">PUP dest as being us (or a broadcast, if broadcast filter is off).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">We do not have responsibility for verifying incoming checksum.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">First, check if we&rsquo;ve been asked to filter by source:"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">filterInput and⦂ <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(frnNet ≠ Ipac sourceNet) or⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">  ((frnHost ≠ Ipac sourceHost) or⦂ (frnSocNum ≠ Ipac sourceSocNum))<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> ⇒ [⇑self socDispose: Ipac]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"It&rsquo;s good, take it..."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑self socProcess: Ipac<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold large"><br>Process outgoing packet</span></div>
<div class="line left">
<span class="bold small">broadcast: packet to: socNumber</span><span class="small">| "I want to broadcast this packet" [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self setAddresses: packet.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">packet<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">destHost&larr;0;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">destNet&larr;0;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">destSoc0&larr;socNumber high;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">destSoc1&larr;socNumber low.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"I assume that the length and type have been done"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self completePup: packet.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">completePup: pac </span><span class="small">| </span><span class="bold small">t<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"the user must have set all 6 address fields,ID, length, and type"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"Now route the packet appropriately, assuming we have Ethernet..."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">NETNUM =  pac destNet ⇒  [pac imEthDestHost &larr;pac destHost] <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"most common case"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">0 = pac destNet ⇒ [pac imEthDestHost &larr; 0] "broadcast"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">0 = (t &larr; routingTable◦(pac destNet)) ⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user show: &rsquo;<br>Inaccessible destination net: &rsquo; + pac destNet asString+ &rsquo;, packet not sent.&rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑pac.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pac imEthDestHost &larr; t.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pac imEthSrcHost &larr; ALTONUM.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pac ethType &larr; 01000.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pac transportControl&larr; 0. <br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"as a socket we have an option about computing outgoing checksums"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pac checksum &larr; [computeOutgoingCS⇒[pac doChecksum] ¬1].<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"Fix this up later......"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">E sendOutput: pac.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑pac<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">defaultAddresses: pac   </span><span class="small">"overwrites any fields which are 0"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[pac destNet = 0 ⇒ [pac destNet &larr; frnNet]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[pac destHost = 0 ⇒ [pac destHost &larr; frnHost]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[(pac destSoc0 = 0) and: (pac destSoc1=0) ⇒ <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[pac destSocNum &larr; frnSocNum]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[pac sourceNet = 0 ⇒ [pac sourceNet &larr; NETNUM]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[pac sourceHost = 0 ⇒ [pac sourceHost &larr; ALTONUM]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[(pac sourceSoc0 = 0) and: (pac sourceSoc1 = 0) ⇒ <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[pac sourceSocNum &larr; lclSocNum]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">defaultAndComplete: pac<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self defaultAddresses: pac.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self completePup: pac.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">setAddresses: pac </span><span class="small">[pac addressBlock &larr; outAddBlock]</span></div>
<div class="line left">
<span class="bold small">setAddressesAndComplete: pac <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[pac addressBlock &larr; outAddBlock.  self completePup: pac]</span></div>
<div class="line left">
<span class="bold large"><br>Access to Parts</span></div>
<div class="line left">
<span class="bold small">close </span><span class="small">[self release.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">sockeTable lookup: lclSocNum⇒[sockeTable delete: lclSocNum]]</span></div>
<div class="line left">
<span class="bold small">computeOutgoingCS </span><span class="small">[⇑</span><span class="bold small">computeOutgoingCS</span><span class="small">]</span></div>
<div class="line left">
<span class="bold small">computeOutgoingCS&larr; computeOutgoingCS </span><span class="small">[⇑</span><span class="bold small">computeOutgoingCS</span><span class="small">]</span></div>
<div class="line left">
<span class="bold small">disable  </span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["left for compatibility" user show: &rsquo;unnecessary disable&rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self close.]</span></div>
<div class="line left">
<span class="bold small">enable </span><span class="small">["now a no-op" user show: &rsquo;someone did unnecessary enable&rsquo;. self print]</span></div>
<div class="line left">
<span class="bold small">filterInput  </span><span class="small">[⇑filterInput]</span></div>
<div class="line left">
<span class="bold small">filterInput&larr; filterInput </span><span class="small">[⇑filterInput ]</span></div>
<div class="line left">
<span class="bold small">freePacket </span><span class="small">| p [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">get a packet</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">freeQ⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(p &larr; freeQ next)⇒ [⇑p]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user show: &rsquo;Warning, empty freeQ, in Socket&rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑false]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑Pacbuf new init]</span></div>
<div class="line left">
<span class="bold small">freePacket: p </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">put a used packet into free queue</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[freeQ and⦂ p⇒ [freeQ next &larr; p]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑false]</span></div>
<div class="line left">
<span class="bold small">frnHost </span><span class="small">[⇑frnHost]</span></div>
<div class="line left">
<span class="bold small">frnHost&larr; frnHost </span><span class="small">[⇑frnHost]</span></div>
<div class="line left">
<span class="bold small">frnNet </span><span class="small">[⇑frnNet]</span></div>
<div class="line left">
<span class="bold small">frnNet&larr; frnNet </span><span class="small">[⇑frnNet]</span></div>
<div class="line left">
<span class="bold small">frnSocNum </span><span class="small">[⇑frnSocNum]</span></div>
<div class="line left">
<span class="bold small">frnSocNum&larr; frnSocNum </span><span class="small">[⇑frnSocNum]</span></div>
<div class="line left">
<span class="bold small">lclSocNum </span><span class="small">[⇑lclSocNum]</span></div>
<div class="line left">
<span class="bold small">lclSocNum&larr; lclSocNum </span><span class="small">[⇑lclSocNum]</span></div>
<div class="line left">
<span class="bold large"><br>Overwrite by Subclasses</span></div>
<div class="line left">
<span class="bold small">doMoreInit</span></div>
<div class="line left">
<span class="bold small">kill </span><span class="small">["whole world about to go.  I don&rsquo;t care, but my subclasses might"]</span></div>
<div class="line left">
<span class="bold small">release </span><span class="small">"</span><span class="italic small">disable Timers, undo circular structures etc.</span><span class="small">"</span></div>
<div class="line left">
<span class="bold small">sleep </span><span class="small">["the user is quitting.  I don&rsquo;t care, but my subclasses might"]</span></div>
<div class="line left">
<span class="bold small">socDispose: Ipac </span><span class="small">[self freePacket: Ipac]</span></div>
<div class="line left">
<span class="bold small">socProcess: Ipac </span><span class="small">[self freePacket: Ipac]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪Socket under: &rsquo;Ethernet Control&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"RetransmitSocket"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;RetransmitSocket&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: Socket<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;retransTimer retransMax retransCount&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;&rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>An abstract socket for handling retransmission behavior</span></div>
<div class="line left">
<span class="bold large"><br>Socket</span></div>
<div class="line left">
<span class="bold small">release </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">retransTimer≡nil⇒ []<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">release circular structure</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">retransTimer disable. retransTimer &larr; nil]</span></div>
<div class="line left">
<span class="bold small">setAddressesAndComplete: pac </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">this may need to be bracketed as critical?</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pac addressBlock &larr; outAddBlock.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">start timer</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">retransCount &larr; 0. retransTimer reset.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self completePup: pac<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"self startTimer.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">super setAddressesAndComplete: pac"]</span></div>
<div class="line left">
<span class="bold large"><br>Timer</span></div>
<div class="line left">
<span class="bold small">retransmit: retransMax every: delay </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">retransTimer &larr; Timer new.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">retransTimer for: delay action⦂ [self timerFired]]</span></div>
<div class="line left">
<span class="bold small">startTimer </span><span class="small">[retransCount &larr; 0. retransTimer reset]</span></div>
<div class="line left">
<span class="bold small">timerOff </span><span class="small">[retransTimer≡nil⇒ [] retransTimer disable]</span></div>
<div class="line left">
<span class="bold small">timerOn </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">turn on timer if retry count has not been reached</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(retransCount &larr; retransCount + 1) ≤ retransMax ⇒ [retransTimer reset]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑false]</span></div>
<div class="line left">
<span class="bold large"><br>Subclass</span></div>
<div class="line left">
<span class="bold small">timerFired </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">subclass should redefine this</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self timerOn⇒ ["</span><span class="italic small">again, e.g. self completePup: pac"</span><span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">done</span><span class="small">"]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪RetransmitSocket under: &rsquo;Ethernet Control&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"NameUser"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;NameUser&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: RetransmitSocket<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;resultType resultSet result outPac&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;&rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>Typical use: <br>   foo &larr; NameUser init.<br>   foo getAddressBlock: string.  --- returns 6-byte string<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">foo getAddressString.  --- returns string like 2#2#0<br>   foo close.</span></div>
<div class="line left">
<span class="bold large"><br>Initialization</span></div>
<div class="line left">
<span class="bold small">init <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["create a NameUser, to socket 4, from a default local socket number"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">E wakeup.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self net: 0 host: 0 soc: 4 asInt32.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self retransmit: 2 every: 300]</span></div>
<div class="line left">
<span class="bold large"><br>Output requests</span></div>
<div class="line left">
<span class="bold small">getAddressBlock: str </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">returns a string, 6 bytes: net/host/socket</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">result &larr; resultSet &larr; false.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">outPac &larr; self freePacket.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">outPac pupType&larr; 0220; dataString&larr; str.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self setAddressesAndComplete: outPac.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">until⦂ resultSet do⦂ [].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑result]</span></div>
<div class="line left">
<span class="bold small">getAddressString: str </span><span class="small">| temp  "return string representation"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">temp &larr; self getAddressBlock: str ⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑(temp◦1) base8 + &rsquo;#&rsquo; + (temp◦2) base8 + &rsquo;#&rsquo; +<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(temp word: 2) base8 + &rsquo;|&rsquo; +  (temp word: 3) base8.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑false<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">getName: str </span><span class="small">| "convert string address back to host name"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["not implemented yet"]</span></div>
<div class="line left">
<span class="bold large"><br>Handle input</span></div>
<div class="line left">
<span class="bold small">socProcess: Ipac </span><span class="small">| i j best bestHops "overwrite from Socket"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"called from Ether stuff, running at a very high level"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["dummy block"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">resultSet ⇒ ["we are not waiting!!"]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"must be the answer, or an error"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self timerOff.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">resultSet &larr; true.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">0222 = Ipac pupType ⇒ "error"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["user show: (Ipac dataString). "].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">0221 ≠ Ipac pupType ⇒ "error"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["user show: &rsquo;unknown pup received by name user.&rsquo;"].<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"an answer arrived"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">result &larr; Ipac dataString. "1 or more 6 byte blocks"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">result length = 6 ⇒ ["all done"].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"more than one, find the nearest address"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">best &larr; 1.  bestHops &larr; 16.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i from: 1 to: (result length) by: 6 do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">NETNUM = (result◦i) ⇒ [best &larr; i.  bestHops &larr; 0].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">j&larr; routingHopCount◦(result◦i).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">j &lt; bestHops ⇒ [best&larr;i. bestHops&larr;j].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">result &larr; result copy: best to: (best+5).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]"dummy block".<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"all done"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self freePacket: Ipac.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">timerFired  </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self timerOn⇒ [self completePup: outPac]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">resultSet &larr; true]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪NameUser under: &rsquo;Ethernet Control&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"RoutingUpdater"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;RoutingUpdater&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: RetransmitSocket<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;outPac resultSet&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;&rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>A specialized sub-class of Socket, designed to send out requests<br>for the current routing info, and update the routing table.</span></div>
<div class="line left">
<span class="bold large"><br>Initialization</span></div>
<div class="line left">
<span class="bold small">init </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"create a new local soc number, broadcast to socket 2"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">super net: 0 host: 0 soc: 2 asInt32.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">outPac &larr; self freePacket.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">outPac pupType &larr; 0200.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">outPac dataString &larr; &rsquo;&rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self retransmit: 3 every: 300.<br>]</span></div>
<div class="line left">
<span class="bold large"><br>Sending</span></div>
<div class="line left">
<span class="bold small">update </span><span class="small">| i <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: 255 do⦂ [routingTable◦i &larr; 0. routingHopCount◦i&larr;8].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">resultSet &larr; false.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self setAddressesAndComplete: outPac.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">until⦂ resultSet do⦂ []]</span></div>
<div class="line left">
<span class="bold large"><br>Overwrite from Socket</span></div>
<div class="line left">
<span class="bold small">socProcess: pac </span><span class="small">| block gateway net count i <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="bold small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">an input has arrived, we are running at a higher level.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">Check the packet type</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">if⦂ pac pupType = 0201 then⦂ <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self timerOff.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">resultSet &larr; NETNUM &larr; pac sourceNet.<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">block &larr; pac pupString.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">gateway &larr; pac sourceHost.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i from: 25 to: 24+pac dataLength by: 4 do⦂ <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">net &larr; block◦i. <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">count &larr; block◦(i+3) + 1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">count &lt; (routingHopCount◦net) ⇒ <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[routingTable◦net &larr; gateway. routingHopCount◦net &larr; count]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self freePacket: pac<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">timerFired </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self timerOn⇒ [self completePup: outPac]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">resultSet &larr; true]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪RoutingUpdater under: &rsquo;Ethernet Control&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"RPPSocket"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;RPPSocket&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: RetransmitSocket<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;seqNum outPac ackOK abortTransfer inQ ackType transaction myStream eof&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;&rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>I establish a reliable packet protocol for communication.<br>This is a sub-class of Socket, and uses many of its messages.</span></div>
<div class="line left">
<span class="bold large"><br>Intialization</span></div>
<div class="line left">
<span class="bold small">init </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self retransmit: 10 every: 180.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">seqNum &larr; transaction &larr; 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">outPac &larr; ackOK  &larr; false.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">abortTransfer &larr; true. "stop an old timer from perhaps firing"]</span></div>
<div class="line left">
<span class="bold large"><br>Termination</span></div>
<div class="line left">
<span class="bold small">release </span><span class="small">[self reset. inQ &larr; false. super release]</span></div>
<div class="line left">
<span class="bold small">reset </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">outPac &larr; self freePacket: outPac.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self timerOff]</span></div>
<div class="line left">
<span class="bold large"><br>Sending Data</span></div>
<div class="line left">
<span class="bold small">send: myStream <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"Sends a whole stream, and an end sequence.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">let the caller hand in a stream, or a file already opened</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[outPac ⇒ [] outPac &larr; self freePacket].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">seqNum &larr; 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">abortTransfer &larr; eof &larr; false.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">until⦂ [eof or⦂ abortTransfer] do⦂ [self sendData].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">abortTransfer ⇒ [self reset. ⇑false]<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"We hit the end of file, do the end sequence and close the connection"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self sendEndSequence ⇒ [⇑myStream] ⇑false.  "all done!"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">sendBlock: str <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"Take the data from a string (1-532 bytes), send it out; uses outPac"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">outPac dataString &larr; str.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self sendPacket.  "tries to do it reliably"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">abortTransfer⇒[⇑false]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">sendData </span><span class="small">| i t buf len [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"send one packet of data from myStream"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">buf &larr; outPac pupString.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">i &larr; 24.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"data bytes are 1-512, 25-536"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[myStream is: FileStream⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"read characters faster (should work especially well for the usual case:<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">FileStreams starting on a page boundary, with page sizes of 512)"<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">len &larr; 512 - (myStream readString: buf from: i+1 to: i+512)]<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"fill the buffer the slow, careful way"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ (i &lt; 536 and⦂ (t &larr; myStream next)) do⦂ [buf◦(i &larr;i+1) &larr; t]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">len &larr; i-24].<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">eof &larr; len &lt; 512.<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">len = 0⇒ ["empty packet. don&rsquo;t send"]<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">outPac pupType &larr; 030. "Data"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"set the packet length"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">outPac dataLength &larr; len.<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"send packet reliably or abort, then return"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self sendPacket. <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">sendEndSequence<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"This will do the 3-way handshake, and close the connection.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">send end, wait for ack"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">outPac pupType &larr; 032. "end"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"set the packet length"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">outPac pupLength &larr; 22.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self sendPacket. "gets sent reliably, we hope"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">abortTransfer⇒[self reset. ⇑false].<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"send the last gratuitous end, do not try to retransmit"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self sendPacketOnce.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self reset.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑true.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">sendPacket </span><span class="small">| <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"general routine to send the outPac packet, maybe retransmit, get ack" <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">ackOK &larr; abortTransfer &larr; false.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">outPac pupID1 &larr; seqNum. <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">outPac pupID0 &larr; transaction. "pupID0 can be used by one of my subclasses"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self setAddressesAndComplete: outPac.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">until⦂ [abortTransfer or⦂ ackOK] do⦂ [].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">seqNum &larr; seqNum + 1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">sendPacketOnce </span><span class="small">| <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"special routine to send the outPac packet, no retransmission" <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">outPac pupID1 &larr; seqNum. <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">outPac pupID0 &larr; transaction. "pupID0 can be used by one of my subclasses"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self setAddressesAndComplete: outPac; timerOff.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold large"><br>Receiving Data</span></div>
<div class="line left">
<span class="bold large"><br>Handle Input</span></div>
<div class="line left">
<span class="bold small">process: packet </span><span class="small">["</span><span class="italic small">my subclasses use this</span><span class="small">" self freePacket: packet]</span></div>
<div class="line left">
<span class="bold small">socProcess: Ipac </span><span class="small">"</span><span class="italic small">I have received a packet</span><span class="small">" [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">Ipac pupType = ackType ⇒[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[Ipac pupID1 = seqNum and⦂ Ipac pupID0 = transaction⇒[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">a legal acknowledgement</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self timerOff.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">ackOK &larr; true]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">an old acknowledgement</span><span class="small">"].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self freePacket: Ipac]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">must be a trasmission started elsewhere</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self process: Ipac.]</span></div>
<div class="line left">
<span class="bold large"><br>Timer Interupts</span></div>
<div class="line left">
<span class="bold small">timerFired </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"This piece of code only runs when a Timer fires;  <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">Don&rsquo;t do an active return"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">ackOK or⦂ abortTransfer⇒ ["This transaction has been terminated"]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self timerOn⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"retransmit"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self completePup: outPac]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user show: &rsquo;Excessive retransmits in RPP retransmit&rsquo; .<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">abortTransfer &larr; true]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪RPPSocket under: &rsquo;Ethernet Control&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"EFTPSender"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;EFTPSender&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: RPPSocket<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo; &rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;&rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>A specialized sub-class of RPPSocket, designed to send files to an<br>EFTP receiver.  By convention, the receiver will be on socket 020<br>There can only be one outstanding packet at a time, called outPac.</span></div>
<div class="line left">
<span class="bold large"><br>Initialization</span></div>
<div class="line left">
<span class="bold small">net: n host: h<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"Each instance of an EFTPSender has a unique lclSocket, but<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">always goes to socket 020 of the receiver"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">super net: n host: h soc: (Int32 new high: 0 low: 020).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"unlike plain sockets, we only want acks from this dest."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">filterInput &larr; true.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self retransmit: 5 every: 180.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">outPac &larr; false.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">transaction &larr; 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">ackType &larr; 031.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold large"><br>Receiving</span></div>
<div class="line left">
<span class="bold small">process: packet </span><span class="small">| error "The printer is trying to tell me something" [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">packet pupType = 033⇒[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"error 33!!!" error &larr; packet dataString.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self freePacket: packet.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user show: &rsquo;remote server aborted: &rsquo;; show: error◦(3 to: error length).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">abortTransfer&larr;true]]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪EFTPSender under: &rsquo;Ethernet Control&rsquo;.</span></div>
    <div class="line left">
<span class="small">&rsquo;From Smalltalk 5.5k XM November 24 on 22 November 1980 at 2:57:08 am.&rsquo;<br></span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large">"Form"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;Form&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: Object<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;extent bits offset figure ground&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;brush aurora black white aurorarunning SPARE color formmenu under reverse blankcursor over dotsetter &rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>This class is a virtual bit map represented as a smalltalk String</span></div>
<div class="line left">
<span class="bold large"><br>INIT</span></div>
<div class="line left">
<span class="bold small">classInit <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["sets up colors and effects for BITBLT."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">black &larr; 0-1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">white &larr; 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">over &larr; 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">under &larr; 1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">reverse &larr; 2.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">brush &larr; Form new extent: 5⌾5. brush black.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">color &larr; 1.<br>formmenu &larr; Menu new string:<br>&rsquo;brush<br>black<br>white<br>line<br>arc<br>erase<br>size<br>figure<br>ground<br>&rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">dotsetter &larr; BitBlt new init." a BitBlt for pattern access."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">dotsetter width &larr; 1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">dotsetter height &larr; 1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">aurorarunning &larr; false.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">aurora &larr; "Aurora new" nil.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">close<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[]</span></div>
<div class="line left">
<span class="bold small">extent: extent<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["creates a virtual bit map with width = (extent x) and height = (extent y) with the bits all 1."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self extent: extent figure: 0 ground: 1 offset: (0⌾0).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;</div>
<div class="line left">
<span class="bold small">extent: extent figure: figure ground: ground offset: offset<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["creates a virtual bit map with width = (extent x) and height = (extent y) with the bits all 1."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bits&larr; String new: 2*(extent y)*( ((extent x) +15) /16).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;</div>
<div class="line left">
<span class="bold small">fromImage: image <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["creates a virtual bit map with width = (image width) and height = (image height) with the bits in image."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self extent: image extent.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bits&larr; (image rectangle) bitsIntoString<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;</div>
<div class="line left">
<span class="bold small">fromrectangle: r <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["creates a virtual bit map with width = (r width) and height = (r height) with the bits in r."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self extent: r extent.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bits&larr; r bitsIntoString<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;</div>
<div class="line left">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold small">fromuser  | r<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["create a new Form whose rectangle is specified by the user. "<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">r &larr; Rectangle new fromuser.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self extent: r extent.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bits&larr; r bitsIntoString<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">fromuserevenword  | r<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["create a new Form whose rectangle is specified by the user,<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">truncated to nearest multiple of 16 (for Spruce printing). "<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">r &larr; Rectangle new fromuserevenword.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self extent: r extent.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bits&larr; r bitsIntoString<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold large"><br>PATTERN ACCESS</span></div>
<div class="line left">
<span class="bold small">bits <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["return the string containing the bits)"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ bits<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">bits: bits <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["reset the string containing the bits)"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">black </span><span class="small">| i<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["sets all bits in the form to black ( to ones)"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: bits length do⦂ [ bits◦i &larr; 0-1]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">black: pt <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["sets the bit at pt in the  form to black ( to one)"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(((0⌾0) ≤ pt) and⦂ (pt ≤ extent)) ⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">dotsetter destbase &larr; bits.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">dotsetter destraster &larr; (extent x +15)/16.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">dotsetter destx &larr; pt x.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">dotsetter desty &larr; pt y.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">dotsetter fill: storing color: black<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">gray </span><span class="small">| i<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["sets all bits in the form to gray ( to gray)"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: bits length do⦂ [ bits◦i &larr; 025252]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">white </span><span class="small">| i<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["sets all bits in the form to white ( to zeros)"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: bits length do⦂ [ bits◦i &larr; 0]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold large"><br>MODULE ACCESS</span></div>
<div class="line left">
<span class="bold small">extent<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["return the extent (width⌾height) of the Form"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ extent<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">figure<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["return the figure( color assiciated with black) for the form "<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ figure<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">figure: figure <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["set the figure ( color assiciated with black) for the form "<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">ground <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["return the ground ( color assiciated with white) for the form "<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ ground<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">ground: ground <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["set the ground ( color assiciated with white) for the form "<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">height <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["return the height of the Form"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ extent y<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">length </span><span class="small">[ ⇑ bits length]</span></div>
<div class="line left">
<span class="bold small">offset <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["return the offset of the Form"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ offset<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">offset: offset <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["set the offset of the form "<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ self<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">width <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["return the width of the Form"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ extent x<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold large"><br>FILING</span></div>
<div class="line left">
<span class="bold small">read: filename </span><span class="small">| f strip w h form stripheight leftoverlines i<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["Reads the Form from the disk in the format width,height,bits."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">f&larr; (dp0 oldFile: filename).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">f readonly.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">w &larr; (f nextword).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">h &larr;(f nextword).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">extent &larr; w⌾h.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">w*h &lt; 64000⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[bits &larr; (Form new extent: extent) bits.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">f into: bits.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">f close.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">f close.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user notify: &rsquo;too many bits to be a Form&rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">write: filename<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["</span><span class="italic small">Saves the Form in the format width,height,bits.</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(dp0 file: filename)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nextword&larr; (self width);<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nextword&larr; (self height);<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">append: bits;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">close.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold large"><br>DISPLAY</span></div>
<div class="line left">
<span class="bold small">displayat:  path effect: effect clippedBy: cliprect</span><span class="small">| r i clippedrect<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["basic form display primitive"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">path is: Point ⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ r &larr; Rectangle new origin:  path extent: (self extent).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">r bitsFromString: bits mode: effect clippedBy: cliprect.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">aurorarunning⇒ <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[user displayoffwhile⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">clippedrect &larr; r intersect: (user screenrect).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">aurora destination: clippedrect ; source: clippedrect ;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">figure: figure ; ground: ground ;  function: 002117 "AoverB" ;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> doit; function: 0 ; doit.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">] </span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"><br> </span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">path is: Path ⇒ [for⦂ i to: path length do⦂ [ self displayat: path◦i<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">effect: effect clippedBy: cliprect] ]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold large"><br>SYSTEM</span></div>
<div class="line left">
<span class="bold small">asInstance </span><span class="small">| s<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[s &larr; Stream new default.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s nextPoint&larr; extent.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s nextPoint&larr; offset.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s nextword &larr; figure.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s nextword &larr; ground.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s nextString &larr; bits.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ s contents <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">copy </span><span class="small">| t<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["return a copy of myself"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">t &larr; Form new extent: extent.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">t bits: bits copy.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ t<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">fromInstance: file <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">extent &larr;  file nextPoint.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">offset &larr;  file nextPoint.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">figure &larr; file nextword.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">ground &larr; file nextword.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bits &larr; file nextString.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ self <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">fromPress: press value: s </span><span class="small">| nbytes [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">extent&larr; s nextPoint.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">offset&larr; s nextPoint.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">figure &larr; s nextword.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">ground &larr; s nextword.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nbytes &larr; 2*(extent y)*((extent x + 15)/16).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(press data) skip: 0-nbytes.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bits &larr; (press data) next: nbytes]</span></div>
<div class="line left">
<span class="bold small">hideData: complete </span><span class="small">| s<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["</span><span class="italic small">a Form does not split across page boundaries</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">Stream new of: (s &larr; String new: 12);<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nextPoint&larr; extent;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nextPoint&larr; offset;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nextword &larr; figure;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nextword &larr; ground.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ s]</span></div>
<div class="line left">
<span class="bold small">hidePress: press complete: c </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">press skipcode: self pressCode data: (self hideData: c)]</span></div>
<div class="line left">
<span class="bold small">pressCode </span><span class="small">[⇑5]</span></div>
<div class="line left">
<span class="bold small">presson: press in: r </span><span class="small">| hs y [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(hs  &larr; press scale*self height) &gt; r height⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"not enough room left on current page.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">assume for now that it will at least fit on an entire page"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑self]<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">press setp: (r origin x)⌾(y &larr; r corner y - hs);<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitmap: self bits: bits.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑y]</span></div>
<div class="line left">
<span class="bold large"><br>EDITING</span></div>
<div class="line left">
<span class="bold small">arc: parentimage </span><span class="small">| pt1 pt2 pt3 path pt<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["arc tool for forms."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">BlankCursor topage1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">until⦂ user redbug do⦂</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ pt1 &larr; self blinkbrush: parentimage].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">brush displayat: pt1 effect: color clippedBy: user screenrect.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">until⦂ user nobug do⦂</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ pt2 &larr; self blinkbrush: parentimage].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">brush displayat: pt2 effect: color clippedBy: user screenrect.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">until⦂ user redbug do⦂</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ pt3 &larr; self blinkbrush: parentimage].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">brush displayat: pt3 effect: color clippedBy: user screenrect.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">path &larr; Path new init.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">path addarcfrom: pt1 via: pt2 to: pt3.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ pt from: path do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ brush displayat: pt effect: color clippedBy: user screenrect].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">NormalCursor topage1<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span></div>
<div class="line left">
<span class="bold small">blinkbrush: parentimage </span><span class="small">| pt <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["to show current position of brush in the form."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pt &larr; parentimage mp.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">brush displayat: (parentimage rectangle origin)+ pt<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">effect: 2 clippedBy: user screenrect.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">brush displayat: (parentimage rectangle origin)+ pt<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">effect: 2 clippedBy: user screenrect.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ (parentimage rectangle origin)+ pt<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span></div>
<div class="line left">
<span class="bold small">edit: parentimage </span><span class="small">| pt f c file<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["Simple Form editor for now."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">until⦂ false do⦂ "forever for now"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[pt &larr; parentimage mp." blink the current brush"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">BlankCursor topage1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self blinkbrush: parentimage.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user redbug ⇒ </span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ parentimage contains:<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(pt &larr; self blinkbrush: parentimage)⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[brush displayat: pt effect: color<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">clippedBy: parentimage rectangle.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ user redbug do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[brush displayat:<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(self blinkbrush: parentimage) effect: color<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">clippedBy: parentimage rectangle.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">] <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">NormalCursor topage1. <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bits&larr; (parentimage rectangle) bitsIntoString.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ self.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">] <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user kbck⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">c &larr; user kbd. <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">c = 120⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ user clearshow: &rsquo;x gridding is &rsquo;. parentimage xgrid print.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user cr.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">parentimage xgrid:<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(user request: &rsquo;x gridding . . . &rsquo;) asInteger.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">] <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">c = 121⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ user clearshow: &rsquo;y gridding is &rsquo;. parentimage ygrid print.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user cr.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">parentimage ygrid:<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(user request: &rsquo;y gridding . . . &rsquo;) asInteger.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">] <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">c = 114⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">file &larr;(user request: &rsquo;filename of Form . . .&rsquo;) .<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">brush &larr;Form new read: file. brush figure: 1  ; ground: 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">] <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> ]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user yellowbug ⇒</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">NormalCursor topage1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">formmenu bug<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=1⇒</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self newbrush: parentimage ]; "get a new brush"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=2⇒</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[color &larr; 1.]; "set the color of the brush to black"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=3⇒</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[color &larr; 3.]; "set the color of the brush to white"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=4⇒</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self line: parentimage];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=5⇒</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self arc: parentimage];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=6⇒</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self white. parentimage display];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"erase the whole form"<br> </span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=7⇒</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self resize: parentimage<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]; "change size"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=8⇒</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self setfigure: parentimage];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=9⇒</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self setground: parentimage]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user bluebug ⇒ </span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[bits&larr; (parentimage rectangle) bitsIntoString.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">NormalCursor topage1. ⇑ self.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">] "exit back to the parentimage"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span></div>
<div class="line left">
<span class="bold small">line: parentimage </span><span class="small">| pt1 pt2 path pt<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["line tool for forms."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">BlankCursor topage1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">until⦂ user redbug do⦂</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ pt1 &larr; self blinkbrush: parentimage].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">brush displayat: pt1 effect: color clippedBy: user screenrect.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">until⦂ user nobug do⦂</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ pt2 &larr; self blinkbrush: parentimage].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">brush displayat: pt2 effect: color clippedBy: user screenrect.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">path &larr; Path new init.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">path addlinefrom: pt1 to: pt2.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ pt from: path do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ brush displayat: pt effect: color clippedBy: user screenrect].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">NormalCursor topage1<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span></div>
<div class="line left">
<span class="bold small">newbrush: superimage </span><span class="small">|  pt rect<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">OriginCursor topage1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user waitbug.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pt &larr; ( superimage mp)+ superimage rectangle origin.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">rect &larr; pt rect: pt.</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">CornerCursor topage1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">until⦂ user nobug do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[rect reverse.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">rect reverse.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pt &larr; <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">( superimage mp)+ superimage rectangle origin.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">rect corner &larr; (rect origin) max: pt.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br> </span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">brush &larr; Form new fromrectangle: rect.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">NormalCursor topage1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span></div>
<div class="line left">
<span class="bold small">resize: superimage </span><span class="small">|  pt f<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[superimage boxcomp.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">CornerCursor topage1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user waitbug. <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">until⦂ user nobug do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[superimage reverse.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">superimage reverse.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">( pt &larr; <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">((superimage superimage) mp)+<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">((superimage superimage) rectangle origin)).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">superimage corner&larr; pt max: ((superimage origin) + (16⌾16)).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br> </span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">f&larr;Form new fromrectangle: superimage rectangle.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bits &larr; f bits.<br> </span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">extent&larr; f extent .<br> </span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">offset &larr; 0⌾0.<br> </span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">superimage white ;<br> </span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">resize ; display ; boxcomp.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">NormalCursor topage1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span></div>
<div class="line left">
<span class="bold small">setfigure: parentimage </span><span class="small">| <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"for now just increment the figure color by 1 \ 14"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">figure &larr; (figure +1 ) \ 14.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self displayat: (parentimage origin) effect: 0 clippedBy: user screenrect.<br>]<br></span></div>
<div class="line left">
<span class="bold small">setground: parentimage </span><span class="small">| <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"for now just increment the ground color by 1 \ 14"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">ground &larr; (ground +1 ) \ 14.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self displayat: (parentimage origin) effect: 0 clippedBy: user screenrect.<br>]<br></span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪Form under: &rsquo;Form Path Image&rsquo;.</span></div>
<div class="line left">
<span class="small">Form classInit</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"FormSet"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;FormSet&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: Object<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;space spaceorigin image strike style styleindex formindex offsettable&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;imageindex bitmover &rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>An object for holding sets of forms.  The most conventional use will be as a repository of a set of forms typically identified as characters when seen on the display or on paper.  The forms will be ascessible by passing a one-character<br>string or a number.</span></div>
<div class="line left">
<span class="bold large"><br>ACCESS</span></div>
<div class="line left">
<span class="bold small">asForm: formindex</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold small">  </span><span class="small">| f<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"returns the form indexed by formindex ."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self checkindex.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">f &larr; Form new extent: (self width) ⌾ (self height) . <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitmover destraster &larr; (f width + 15 / 16).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitmover destx &larr; 0. bitmover desty &larr; 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitmover sourcex &larr; (self originx). bitmover sourcey &larr;  0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitmover width &larr; (self width).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitmover height &larr; (self ascent) + (self descent).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitmover sourceraster &larr; (self wordwidth).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitmover destbase &larr; (f bits).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitmover sourcebase &larr; strike.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitmover dstrike &larr; false.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitmover sstrike &larr; true.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitmover copy: storing.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ f<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">changeascentto: newascent</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"new ascent for FormSet"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self deltaascent: (newascent - (self ascent))<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">changedescentto: newdescent</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"new ascent for FormSet"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self deltadescent: (newdescent - (self descent))<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">changewidthof: formindex to: width</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"new width for form at index"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self checkindex. self deltawidthof: formindex by: (width - (self width))<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">classInit<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"Just initialize the bitmover for now."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitmover &larr; BitBlt init</span><span class="italic small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">copy: formindex</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold small"> to: pt </span><span class="small">| f<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"copies the form indexed by formindex to pt."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self checkindex.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"f &larr; Image new size: (self width) ⌾ (self height) at: pt."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitmover destraster &larr; ((user screenrect) width + 15 / 16).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitmover destx &larr; pt x. bitmover desty &larr; pt y.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitmover sourcex &larr; (self originx). bitmover sourcey &larr;  0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitmover width &larr; (self width).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitmover height &larr; (self ascent) + (self descent).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitmover sourceraster &larr; (self wordwidth).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitmover destbase &larr; (mem◦ 066).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitmover sourcebase &larr; strike.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitmover strike &larr; true.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitmover copy: oring.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ self widthof: formindex<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">copy: formindex</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold small"> to: pt effect: effect </span><span class="small">| f<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"copies the form indexed by formindex to pt."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self checkindex.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"f &larr; Image new size: (self width) ⌾ (self height) at: pt."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitmover destraster &larr; ((user screenrect) width + 15 / 16).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitmover destx &larr; pt x. bitmover desty &larr; pt y.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitmover sourcex &larr; (self originx). bitmover sourcey &larr;  0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitmover width &larr; (self width).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitmover height &larr; (self ascent) + (self descent).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitmover sourceraster &larr; (self wordwidth).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitmover destbase &larr; (mem◦ 066).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitmover sourcebase &larr; strike.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitmover strike &larr; true.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitmover copy: effect.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">copyrange: start to: stop from: sourceset startingat: deststart<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">| savebackground savebits i f<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"copy a range of forms from one set to another"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user displayoffwhile⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[sourceset is: FormSet ⇒ []<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">sourceset is: String ⇒ [sourceset &larr; FormSet new from: sourceset]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user notify: &rsquo;Illegal sourceset -- not String or Formset.&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">savebackground &larr;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">Form new size: (sourceset maxwidth) by: (sourceset height).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">savebackground translate: 0⌾0; scale: 1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">savebits &larr; savebackground bitsIntoString.<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i from: start to: stop do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[f &larr; sourceset copy: i to: 0⌾0. self include: deststart with: f.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">deststart &larr; deststart + 1].<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">savebackground bitsFromString: savebits.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">currentformindex<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"return index of form last touched"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ formindex<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">currentformorigin |</span><span class="small"> imageindex</span><span class="bold small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"return index in image of form last touched"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> imageindex &larr; image find: formindex.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ space ptofchar: imageindex.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">from: strike<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"Make a formset out of string in strike format"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self classInit. self install: strike<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">from: first to: last ascent: ascent descent: descent<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold small">style: style styleindex: styleindex name: name<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"Make an empty formset."</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self classInit.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">offsettable &larr; String new: (last - first + 3) * 2.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">offsettable all &larr; 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">offsettable word: (last - first + 3) &larr; 4.</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"width of illegal form"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">strike &larr;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">String new: (9 </span><span class="italic small">"header"</span><span class="small"> + ascent + descent </span><span class="italic small">"space for illegal form"</span><span class="small">) * 2.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">strike all &larr; 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self type: 0100000.</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"for the outside world"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self first: first.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self last: last.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self wordwidth: 1.</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"only illegal form"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self ascent: ascent.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self descent: descent.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self maxwidth: 4.</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"width of illegal form"</span><span class="small"><br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">strike &larr; strike concat: offsettable ◦ (1 to: offsettable length).<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"mash in bits of illegal form"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"leftside"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitmover destraster &larr; (self wordwidth).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitmover destx &larr; 0. bitmover desty &larr; 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitmover width &larr; 1. bitmover height &larr; (self ascent) + (self descent).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitmover destbase &larr; strike.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitmover dstrike &larr; true.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitmover fill: storing color: black.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"rightside"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitmover destx &larr; 3.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitmover dstrike &larr; true.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitmover fill: storing color: black.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"top"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitmover width &larr; 4. bitmover height &larr; 1. bitmover destx &larr; 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitmover dstrike &larr; true.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitmover fill: storing color: black.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"bottom"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitmover desty &larr; (self ascent) + (self descent) - 1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitmover dstrike &larr; true.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitmover fill: storing color: black.<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self install: strike.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self updateseglength.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[style ≡ nil ⇒ []<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">style setfont: styleindex name: name fromstring: strike]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">fromspace: pt to: dest<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"get form selected from space"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">formindex &larr; image ◦ ((space charofpt: pt) min: 256).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ (self copy: formindex to: dest).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">fromstyle: style styleindex: styleindex<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"Make a formset out of string in strike format"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self classInit. self install: style fonts◦(styleindex+1)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">height<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"return height of fromset"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑self ascent + self descent<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">include: formindex with: form </span><span class="small">| newoffsettable newstrike i j<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"Put a form into the formset"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(formindex &gt; (self first)) and:<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(formindex &lt; (self last)) ⇒ [ self replace: formindex with: form]<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">formindex &lt; 0 ⇒ [user notify: &rsquo;Formindex &lt; 0 illegal for formset.&rsquo;]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">formindex &gt; 255 ⇒ [user notify: &rsquo;Formindex &gt; 255 illegal for formset.&rsquo;]<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[formindex &lt; (self first) ⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[newoffsettable &larr;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">String new: ((self first) - formindex + (self abslength)) * 2.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">newoffsettable all &larr; 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">j &larr; (self first) - formindex + 1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i  from: j to: ((newoffsettable length) / 2) do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[newoffsettable word: i &larr; strike word: offsettable + (i-j)].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">newoffsettable &larr;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">String new: ((self abslength) + formindex - (self last)) * 2.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">newoffsettable all &larr; 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i from: 0 to: ((self length) - 1) do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[newoffsettable word: (i+1) &larr; strike word: offsettable + i].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i from: (self length) to: ((newoffsettable length) / 2) do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[newoffsettable word: i &larr; strike word: offsettable + self length].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">newoffsettable word: ((newoffsettable length) / 2) &larr;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">strike word: (offsettable + self length + 1).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">newstrike &larr; String new: (9 </span><span class="italic small">"header"</span><span class="small"> + ((self wordwidth) *<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">((self ascent + self descent)) </span><span class="italic small">"bits"</span><span class="small">)) * 2.</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"new space for bits"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: 9 do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[newstrike word: i &larr; strike word: i].</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"fill in header of new font"</span><span class="small"><br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitmover destraster &larr; (self wordwidth).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitmover destx &larr; 0. bitmover desty &larr; 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitmover sourcex &larr; 0. bitmover sourcey &larr; 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitmover width &larr; (self strikerightx).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitmover height &larr; (self ascent) + (self descent).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitmover sourceraster &larr; (self wordwidth).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitmover destbase &larr; newstrike.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitmover sourcebase &larr; strike.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitmover strike &larr; true.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitmover copy: storing.<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"copy the xtable"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">newstrike &larr;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">newstrike concat:  newoffsettable ◦(1 to: newoffsettable length).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self install: newstrike.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[formindex &lt; (self first)  ⇒ [self first: formindex] self last: formindex].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self replace: formindex with: form.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">initspaceat: spaceorigin </span><span class="small">| i run para<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"make a space for formset viewing"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">image &larr; String new: 256.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">image all &larr; 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i from: ((self first) to: (self last)+1)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">do⦂ [image◦(i+1) &larr; i].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">run &larr; String new: 2.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">run word: 1 &larr;  16 * (styleindex) + 0177400.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">para &larr;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">Paragraph new text: image runs: run alignment: 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[space ≡ nil ⇒ [] space erase].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">space&larr; Textframe new para: para<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">frame: (Rectangle new origin: spaceorigin extent:<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">((self last) - (self first) * (self maxwidth) / 8)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⌾<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">((self ascent) + (self descent) * 6))<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">style: style.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span></div>
<div class="line left">
<span class="bold small">makecu: name scale: scale<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">| f i iform bits drast srast<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"Put out strike in Carnegie-Mellon format.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">A typical call might look like:<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">yourset &larr;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">FormSet new style: DefaultTextStyle styleindex: 0.<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">yourset makecu: &rsquo;cream12&rsquo; scale: 1.</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user  displayoffwhile⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">f &larr; (dp0 file: name + &rsquo;.cu.&rsquo;).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">f nextword &larr; self height * scale.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">f nextword &larr; self maxwidth * scale + 15 / 16.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bits &larr; String new:<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">((self height * scale) * ((self maxwidth * scale + 15)/16))<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">* 2.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">drast &larr; self maxwidth * scale + 15 / 16.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">srast &larr; (user screenrect width) + 15/16.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i from: ((self first) to: (self last) by: 1) do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[iform &larr; "self copy: i to: 0⌾0" self asForm: i. <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">iform displayat: (0⌾0) effect: 0 clippedBy: user screenrect.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[scale &gt; 1 ⇒ [iform blowup: 0⌾0 by: scale]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">f nextword &larr; i. f nextword &larr; self width*scale.<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitmover destbase &larr; bits.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitmover destraster &larr; drast.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitmover destx &larr; 0. bitmover desty &larr; 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitmover sourcebase &larr; mem◦066.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitmover sourceraster &larr; srast.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitmover sourcex &larr; 0. bitmover sourcey &larr; 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitmover dstrike &larr; false.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitmover sstrike &larr; true.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitmover width &larr; (iform width) * scale.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitmover height &larr; (iform height) * scale.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bits all &larr; 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitmover copy: storing.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">f append: bits].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">f close.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">newspace<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"let user reshape/position space"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">space frame &larr; Rectangle new fromuser. self show.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">replace: formindex with: form<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"Replace form in set.  Check incoming form for compatibility with formset,<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">and insert form into formset."</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self checkindex.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[form width ≠ self width ⇒ [self changewidthof: formindex to: form width]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">form displayat: (0⌾0) effect: 0 clippedBy: user screenrect.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"copy bits of form into formset"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitmover destraster &larr; (self wordwidth).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitmover destx &larr; (self originx). bitmover desty &larr; 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitmover sourcex &larr; 0. bitmover sourcey &larr; 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitmover width &larr; (self width).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitmover height &larr; (self ascent) + (self descent).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitmover sourceraster &larr; ((user screenrect) width + 15 / 16).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitmover destbase &larr; strike.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitmover sourcebase &larr; (mem ◦ 066).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitmover dstrike &larr; true.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitmover copy: storing.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">show<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"show all the forms in the set"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">space outline. space show<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">space<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"return textframe that is space of formset"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ space <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">spaceframe<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"return frame of space"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑(space frame)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">spaceorigin: spaceorigin<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"reposition the space"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">space erase. (space frame) origin &larr; spaceorigin. self show.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">widthof: formindex<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"return width of from at formindex"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑self width<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold large"><br>INTERNAL</span></div>
<div class="line left">
<span class="bold small">abslength<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"Return absolute length of formset, i.e. number of forms in set<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">plus space for illegal character and its rightx"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ ((self last) - (self first) + 3)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">checkindex<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"check formindex for legality and make into number if necessary"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[formindex is: String ⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[formindex length &gt; 1 ⇒ [user notify: &rsquo;formindex out of range for FormSet.&rsquo;]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">formindex &larr; formindex◦1]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(formindex &lt; (self first)) or: (formindex &gt; (self last+1)) ⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[user notify: &rsquo;formindex out of range for this FormSet.&rsquo;]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">deltaascent: delta </span><span class="small">| newstrike<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"ascent delta"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[(self ascent) + delta &lt; 0 ⇒[delta &larr; 0 - (self ascent)]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[delta &gt; 0 ⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"grow"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">newstrike &larr; String new: (2 * (self wordwidth) * delta).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">newstrike all &larr;  0.</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"fill with white"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">newstrike &larr;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"add oldfont header and new space together"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(strike◦(1 to: 18) concat: newstrike◦(1 to: newstrike length)).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">newstrike &larr;</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"now add on rest of old font"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(newstrike concat: strike◦(19 to: strike length)).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"shrink"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">newstrike &larr; (strike◦(1 to: 18) concat:<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">strike◦((19 + (0 - (2 * (self wordwidth) * delta)))<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">to: strike length)).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">newstrike word: 6 &larr; ((self ascent) + delta).</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"reset ascent word in font"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self install: newstrike.</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"newstrike now font of interest"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self updateseglength.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[style ≡ nil ⇒ [ ]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(style maxascent) &lt; (self ascent) ⇒ [style maxascent: (self ascent)]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">deltadescent: delta </span><span class="small">| newstrike somespace<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"descent delta"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[(self descent) + delta &lt; 0 ⇒ [ delta &larr; 0 - (self descent)]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[delta &gt; 0 ⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[somespace &larr; String new: 2 * (self wordwidth) * delta.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">somespace all &larr; 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">newstrike &larr;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(strike ◦ (1 to: offsettable - 1 * 2) concat: somespace).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">newstrike &larr;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(strike ◦ (1 to: ((offsettable - 1 * 2)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">+ ((self wordwidth) * delta * 2)))).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"copy the xtable"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">newstrike &larr;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">newstrike concat: strike ◦ ((offsettable * 2 - 1) to: strike length).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">newstrike word: 7 &larr;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">((self descent) + delta).</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"reset descent word in font"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self install: newstrike.</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"updatedfont now font of interest"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self updatemaxwidth.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self updateseglength.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[style ≡ nil ⇒ [ ]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(style maxdescent) &lt; (self descent) ⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[style maxdescent: (self descent)]]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">deltawidthof: index by: delta<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">| newwordwidth newoffsettable newstrike normalizedindex normalizedlast i<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"change width of form at index"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[delta &lt; 0 ⇒ [(delta abs) &gt; (self width) ⇒ [delta &larr; 0-(self width)]]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">newwordwidth &larr;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[((self strikerightx) + 15 / 16) ≠<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(i &larr; ((self strikerightx) + delta + 15 / 16)) ⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ i ]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(self wordwidth)].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">newoffsettable &larr; newwordwidth *<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">((self ascent + self descent)) </span><span class="italic small">"height"</span><span class="small"> + 9 </span><span class="italic small">"header"</span><span class="small"> + 1 </span><span class="italic small">"for 0 addressing"</span><span class="small">.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">XeqCursor showwhile⦂ <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">newstrike &larr; String new: (9 </span><span class="italic small">"header"</span><span class="small"> + (newwordwidth *<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">((self ascent + self descent)) </span><span class="italic small">"bits"</span><span class="small">)) * 2.</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"grow/shrink the bits"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">newstrike all &larr; 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: 8 do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[newstrike word: i &larr; strike word: i].</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"fill in header of new font"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">newstrike word: 9 &larr; newwordwidth.</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"set raster in new font"</span><span class="small"><br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"copy the xtable"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">newstrike &larr; newstrike concat: strike◦((offsettable * 2 - 1) to: strike length).<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"set up to copy up to old bits of form in formset"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitmover destraster &larr; newwordwidth.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitmover destx &larr; 0. bitmover desty &larr; 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitmover sourcex &larr; 0. bitmover sourcey &larr; 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitmover width &larr; (self originx) + (self width).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitmover height &larr; (self ascent) + (self descent).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitmover sourceraster &larr; (self wordwidth).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitmover destbase &larr; newstrike.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitmover sourcebase &larr; strike.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitmover sstrike &larr; true.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitmover dstrike &larr; true.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitmover copy: storing.<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"now copy remainder of font"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitmover destx &larr; (self originx) + (self width) + delta.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitmover width &larr; (self strikerightx) - (self originx) - (self width).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitmover sourcex &larr; (self originx) + (self width).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitmover copy: storing.<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"shift x-vals"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">normalizedindex &larr; formindex - (self first).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">normalizedlast &larr; (self last) - (self first).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i from: ((normalizedindex + 1) to: (normalizedlast + 2 </span><span class="italic small">"max"</span><span class="small">)) do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[newstrike word: (newoffsettable+i) &larr;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">delta + (newstrike word: (newoffsettable+i))].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self install: newstrike.</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"set up the updated copy of the formset"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self updatemaxwidth.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self updateseglength. <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">install: strike<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"set up a new or refreshed strike"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[style ≡ nil ⇒ [] style fonts ◦ (styleindex + 1) &larr; strike].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">offsettable &larr; (self wordwidth) *<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">((self ascent) + (self descent)) + 9 </span><span class="italic small">"header"</span><span class="small"> + 1 </span><span class="italic small">"for 0 addressing"</span><span class="small">.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ strike]</span></div>
<div class="line left">
<span class="bold small">length<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"Return length of formset, i.e. number of forms in set"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ ((self last) - (self first) + 1)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">originx<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"Return origin x  of form at formindex"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ (strike word: (offsettable + formindex - (self first)))]</span></div>
<div class="line left">
<span class="bold small">updatemaxwidth </span><span class="small">| newmaxwidth i<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"update max width"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">newmaxwidth &larr; 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i from:<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(offsettable to: offsettable + ((self last) - (self first) + 1))<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[newmaxwidth &larr;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(newmaxwidth<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">max: ((strike word: i+1) - (strike word: i)))].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self maxwidth: newmaxwidth.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">updateseglength<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"compute new segment length for formset"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">strike word: 5 &larr;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(5</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"length, ascent, descent, kern, and raster"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">+ ((self wordwidth) * ((self ascent) + (self descent)))</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"bits"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">+ ((self last "max") - (self first</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"min") + 2)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"xtabl"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">width<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"Return width of form at formindex"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ (strike word: (offsettable + (formindex - (self first)) + 1)) -<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(strike word: (offsettable + (formindex - (self first)))) ]</span></div>
<div class="line left">
<span class="bold large"><br>PARTS</span></div>
<div class="line left">
<span class="bold small">ascent<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"When form set treated as characters, describes distance from top of form<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">to baseline."</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑(strike word: 6)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">ascent: ascent<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"When form set treated as characters, describes distance from top of form<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">to baseline."</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">strike word: 6 &larr; ascent.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">descent<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"When form set treated as characters, describes distance from bottom of<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">form to baseline."</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑(strike word: 7)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">descent: descent<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"When form set treated as characters, describes distance from bottom of<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">form to baseline."</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">strike word: 7 &larr; descent.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">first<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"Heritage from the world of fonts"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑(strike word: 2)</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"minimum formindex (ascii) in the strike"</span><span class="small">]</span></div>
<div class="line left">
<span class="bold small">first: first<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"Heritage from the world of fonts"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">strike word: 2 &larr; first.</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"minimum formindex (ascii) in the strike"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">kern<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"When form set treated as characters, describes distance this form is<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">to intrude into space of preceding character."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑(strike word: 8)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">last<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"Heritage from the world of fonts"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑(strike word: 3)</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"maximum formindex (ascii) in the strike"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">last: last<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"Heritage from the world of fonts"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">strike word: 3 &larr; last.</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"maximum formindex (ascii) in the strike"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">maxwidth<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"All forms in this set ≤ to this value"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑(strike word: 4)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">maxwidth: maxwidth<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"All forms in this set ≤ to this value"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">strike word: 4 &larr; maxwidth.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">segmentlength<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"Amount of space allocated for form set - 4"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑(strike word: 5)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">strikerightx<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["Corner x of last form in form set"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑(strike word: (offsettable + ((self last) - (self first)) + 2)).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">type<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"**BEWARE -- outside world has ideas about this value."</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑(strike word: 1)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">type: type<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"**BEWARE -- outside world has ideas about this value."</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">strike word: 1 &larr; type.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">wordwidth<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"Also know as the raster of the formset.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">The width in alto words of the bits of the formset.  When the display of a <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">form is desired, the word and bit address of the bits of the form must<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">be discovered.  Adding the wordwidth to the word portion of that value,<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">produces the word address of the second line of the bits of the form, and<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">so on until the height of the form is spanned."</span><span class="small"><br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑(strike word: 9)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">wordwidth: wordwidth<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"Also know as the raster of the formset.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">The width in alto words of the bits of the formset.  When the display of a <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">form is desired, the word and bit address of the bits of the form must<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">be discovered.  Adding the wordwidth to the word portion of that value,<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">produces the word address of the second line of the bits of the form, and<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">so on until the height of the form is spanned."</span><span class="small"><br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">strike word: 9 &larr; wordwidth.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪FormSet under: &rsquo;Form Path Image&rsquo;.</span></div>
<div class="line left">
<span class="small">FormSet classInit</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"Image"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;Image&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: Set<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo; origin rectangle path form superimage xgrid ygrid figure ground&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;aurora under black screen reverse white over aurorarunning &rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>This class has not yet been commented</span></div>
<div class="line left">
<span class="bold large"><br>INIT</span></div>
<div class="line left">
<span class="bold small">blink: form </span><span class="small">| pt <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["to show current gridded position of the form... returns abs position."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pt &larr; self mp.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">form displayat: ( rectangle origin)+ pt<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">effect: 2 clippedBy: user screenrect.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">form displayat: ( rectangle origin)+ pt<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">effect: 2 clippedBy: user screenrect.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ (self rectangle origin)+ pt<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span></div>
<div class="line left">
<span class="bold small">classInit<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["sets up black and white as colors and over ,under and reverse as modes<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">also initializes the name screen as an image the size of the display"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">black &larr; 0-1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">white &larr; 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">over &larr; 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">under &larr; 1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">reverse &larr; 2.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">screen &larr; Image new origin: user screenrect origin extent: user screenrect extent.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">aurora &larr; "Aurora new" nil.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">aurorarunning &larr; false.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">fromuser<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["create a new Image whose rectangle is specified by the user. "<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">rectangle &larr; Rectangle new fromuser.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self origin: (rectangle origin) rectangle: rectangle<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">path: (rectangle origin) form: (Form new fromrectangle: rectangle)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">figure: 1 ground: 0 xgrid: 1 ygrid: 1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">origin: origin extent: extent <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["create a new Image at origin with extent (width⌾height). "<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self origin: (origin copy)  rectangle: (Rectangle new origin: origin extent: extent)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> path: nil form: nil figure: 1 ground: 0 xgrid: 1 ygrid: 1<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">origin: origin rectangle: rectangle path: path form: form<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["basic message to create a new instance."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self origin: origin rectangle: rectangle path: path form: form<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">figure: 1 ground: 0 xgrid: 1 ygrid: 1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span></div>
<div class="line left">
<span class="bold small">origin: origin rectangle: rectangle path: path form: form figure: figure ground: ground xgrid: xgrid ygrid: ygrid<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["basic message to create a new instance."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self default]<br></span></div>
<div class="line left">
<span class="bold small">rectanglefromuser | f pt r<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["create a  Rectangle  specified by the user and origin and corner are gridded. "<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">r &larr; Rectangle new.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">f &larr; Form new extent: xgrid⌾ygrid. f black.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user waitnobug.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">until⦂ user anybug do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">r origin &larr; self blink: f.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">until⦂ user nobug do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">r corner &larr; (self mp + rectangle origin) max: (r origin + f extent).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">r reverse ; reverse.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ r.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold large"><br>BUILDING IMAGES</span></div>
<div class="line left">
<span class="bold small">add: p and: i | s<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["add p (set or point) and i ( Image or Form ) and expand the<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> bounding rectangle of this image."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">rectangle &larr;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">rectangle include:<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">((Rectangle new origin: (p origin)+ origin extent: i size)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">include: (Rectangle new origin: (p corner)+ origin extent: i size)).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s &larr; Set default. s add: p ; add: i .<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self add: s<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">addform: f andpath: p | r<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["add p (set or point) and f ( Form ) and expand the<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> bounding rectangle of this image."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self addpath: p andform: f<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">addimage: i  | r<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["add the Image i (as a subimage) and expand the<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> bounding rectangle of this image."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">rectangle &larr;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">rectangle<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">include:<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(Rectangle new origin: (i origin)+ origin extent: i extent).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self add: i.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">addpath: p andform: f | r<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["add p (set or point) and f ( Form ) and expand the<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> bounding rectangle of this image."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">rectangle &larr;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">rectangle<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">include:<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(r &larr; ((Rectangle new origin: (p origin)"+ origin" extent: f extent)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">include:<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(Rectangle new origin: ((p corner) - (1⌾1))"+ origin" extent: f extent))).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self add: (Image new origin: 0⌾0 rectangle: r path: p form: f<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">figure: 1 ground: 0 xgrid: 1 ygrid: 1).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold large"><br>CHANGING IMAGES</span></div>
<div class="line left">
<span class="bold small">appendimage: newimage after: image </span><span class="small">| i<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["append newimage into the image after image."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">i &larr; self findbyrect: image.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self insertI: (i+1) value: newimage.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">comment<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["see class Set for operations (deletion,replacement,insertion etc.) on subimages ( elements)."]<br></span></div>
<div class="line left">
<span class="bold small">deleteimage: i | subimage<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["delete the i th subimage and recompute the bounding rectangle of the Image"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">subimage &larr; self◦i.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self deleteI: i.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">( subimage rectangle) isWithin: rectangle⇒ [] self resize "recompute bounding rectangle"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">deletesubimage: i <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["delete the ith subimage."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self deleteindex: i.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">edit: superimage | </span><span class="small">blackdot pt indexofsubimage subimage</span><span class="bold small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["eventually a general Image manipulator for now<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">just passes control to its subimages."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nil≡ form ⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[user waitnobug.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">until⦂ (1 = 2) do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> "until bug occurs outside rectangle"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">((false = (rectangle has: (user mp))) and: (user anybug))⇒[⇑ self ]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user kbck ⇒ [ self kbd ]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user redbug⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[indexofsubimage &larr; self smallestsubimageat:<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">( (user mp) - self rectangle origin).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">indexofsubimage⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ subimage &larr; self◦indexofsubimage.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">subimage translate: self origin .<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">subimage edit: self.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">subimage translate: ((0⌾0)-self origin).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user yellowbug⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self yellowbug<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">form &larr; form edit: self.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[form is: Form⇒ [] "origin &larr;  (form origin) copy." rectangle &larr; (form frame) copy].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ self <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span></div>
<div class="line left">
<span class="bold small">findbyrect: image </span><span class="small">| i<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: position do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[(array◦i) rectangle = image rectangle ⇒ [⇑i]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑0]</span></div>
<div class="line left">
<span class="bold small">highlite  | r i<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["reverse the ith subimage ."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: position do⦂ <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">r &larr; Rectangle new origin: (self origin+ (self◦i) origin)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">extent: (self◦i) extent.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">r comp<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">indexofsubimageat: pt | i subimage <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["return the index of the subimage which contains pt(relative to self origin)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">otherwise return false."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: self length do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[subimage &larr; (self◦i).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(subimage rectangle) has: pt⇒ [ ⇑ i]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ false<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">indexofsubimagebelow: yvalue | i subimage <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["return the index of the first subimage below yvalue otherwise return false."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: self length do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ ((self◦i) top ≥ yvalue) ⇒ [ ⇑ i]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ false<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">outlinesubimage: i  | r<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["draw an outline(reversed boarder 2 units thick) about the ith subimage ."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">r &larr; Rectangle new origin: (self origin+ (self◦i) origin)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">extent: (self◦i) extent.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">r comp<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">replaceimage: image with: newimage </span><span class="small">| i<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["replace image with newimage in self."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">i &larr; self findbyrect: image.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self replaceI: i value: newimage.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">smallestsubimageat: pt | i smallest slf sml<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["return the index of the smallest subimage which contains pt(relative to self origin)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">otherwise return false."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">smallest &larr; false.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: self length do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">((self◦i) rectangle) has: pt⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">smallest⇒[ slf&larr;((self◦i) rectangle).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">sml&larr;((self◦smallest) rectangle).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(slf area &lt; sml area) ⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[smallest &larr; i]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">  ]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">smallest &larr; i<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">smallest⇒[⇑ self◦smallest]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ smallest</span><span class="small bold italic"> </span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">subimage: i | sub s<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["return the ith subimage."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">sub &larr; (self◦i)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s &larr; Image new at: (self origin) + (sub◦1) origin. s add: (0⌾0) and: sub◦2. <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ s<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">subimageat: pt | i <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["return the  subimage which contains pt (relative to self origin)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">otherwise return false."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">i &larr; self indexofsubimageat: pt.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">i ⇒ [ ⇑ self◦ i]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ false<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">subimageswithin: rect | image topleft fittedimage t<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["return an image containing my subimages that are within rect, </span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">otherwise return false."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">image &larr; Image new origin: rect origin extent: rect extent.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ t from: self do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(t rectangle) isWithin: rect⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">image addimage: (t translate: (0⌾0)-(rect origin))<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">image length = 0⇒[⇑ false]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">topleft &larr; (image◦1) rectangle origin.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ t from: image do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[(t rectangle origin) &lt; topleft⇒ [topleft &larr; (t rectangle origin)]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">fittedimage &larr; Image new origin: (topleft+rect origin) extent: (1⌾1).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ t from: image do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ fittedimage addimage: (t translate: (0⌾0)-topleft)].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ fittedimage</span><span class="small bold italic"> </span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">substitute: form1 for: form2 </span><span class="small">| i <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["everywhere in the imagesubstitute form1 for form2"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: self length do⦂ [ (self◦i)◦2 ≡ form2 ⇒  [ (self◦i)◦2 &larr; form1]]  <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold large"><br>DISPLAY</span></div>
<div class="line left">
<span class="bold small">blink <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["blink the image" <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self display: 2.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self display: 2.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">display <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["display all of the forms in the image on the screen "<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self displayat: 0⌾0 effect: 0 clippedBy: user screenrect.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">display: effect  <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["display all of the forms in the image on the screen <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">effect = 0 ⇒ store<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">effect = 1 ⇒ or<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">effect = 2 ⇒ xor<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">effect = 3 ⇒ and complement<br>"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self displayat: 0⌾0 effect: effect clippedBy: user screenrect.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">displayat: pt effect: effect clippedBy: cliprect </span><span class="small">| i <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["display all of the subimages in this image "<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[nil≡ form</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇒ []<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">form displayat: (path + pt+ origin) effect: effect clippedBy: cliprect].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: self length  do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ (self◦i) displayat: (pt +  origin) effect: effect clippedBy: cliprect<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">quickDisplayAt: pt scale: scal offset: delta </span><span class="small">| i rect x1 y1 x2 y2<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["outline me and all of the subimages in this image in given scale"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">x1&larr; (scal*(rectangle minX + pt x) + delta x) asInteger.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">y1&larr; (scal*(rectangle minY + pt y) + delta y) asInteger.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">x2&larr; (scal*(rectangle maxX + pt x) + delta x) asInteger.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">y2&larr; (scal*(rectangle maxY + pt y) + delta y) asInteger.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">rect &larr; x1⌾y1 rect: x2⌾y2.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">rect outline.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pt &larr; pt+origin.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: self length do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[rect &larr; (self◦i) rectangle.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">x1&larr; (scal*(rect minX + pt x) + delta x) asInteger.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">y1&larr; (scal*(rect minY + pt y) + delta y) asInteger.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">x2&larr; (scal*(rect maxX + pt x) + delta x) asInteger.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">y2&larr; (scal*(rect maxY + pt y) + delta y) asInteger.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">rect &larr; x1⌾y1 rect: x2⌾y2.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">rect color: gray mode: oring.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold large"><br>MODULE ACCESS</span></div>
<div class="line left">
<span class="bold small">= image<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑(rectangle = (image rectangle))<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">bottom<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["return the bottom y of the bounding rectangle of theImage."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ rectangle corner y.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">center<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["return the center of the Image."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ rectangle center.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">contains: pt <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["return true if the  bounding rectangle for the Image contains pt.."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ rectangle has: pt<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">corner<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["return the corner of the Image."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ rectangle corner.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">corner&larr; pt<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["modify the corner of the Image."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> rectangle corner&larr; pt.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">extent <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["return the extent (width,height) of the Image."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ rectangle extent<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">height<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["return the height of the Image."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ rectangle extent y.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">leftside<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["return the leftmost x of the bounding rectangle of theImage."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ rectangle origin x.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">origin<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["return the origin of the image."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ origin<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">origin: origin<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["change the origin of the image."]</span></div>
<div class="line left">
<span class="bold small">rectangle <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["return the rectangle that bounds the Image."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ rectangle<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">rectangle: r <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["redefine rectangle that bounds the Image."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">rectangle&larr; r<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">resize | i <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[" Recompute the bounding rectangle of the Image"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[nil≡ form</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇒ [rectangle &larr; Rectangle new origin: origin extent: 1⌾1]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">rectangle &larr; Rectangle new origin: origin extent: form extent].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: self length do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ rectangle  &larr; rectangle include: ((self◦i) rectangle) ]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">rightside<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["return the rightmost x of the bounding rectangle of theImage."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ rectangle corner x.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">superimage<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["return the superimage (Image containing) of this Image."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ superimage<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">top<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["return the top y of the bounding rectangle of theImage."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ rectangle origin y.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">width<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["return the width of the Image."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ rectangle extent x.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold large"><br>PATTERN ACCESS</span></div>
<div class="line left">
<span class="bold small">black<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["black out the image"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self color: black effect: 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">boxcomp <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["border without disturbing the interior."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">rectangle comp<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">color: color effect: effect <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["basic rectangle call to blt."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">rectangle color: color mode: effect .<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">aurorarunning⇒</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[user displayoffwhile⦂ [aurora destination: rectangle ; source: rectangle ;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">figure: figure ; ground: ground ;  function: 002117 "AoverB" ; doit<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]]<br> ]</span></div>
<div class="line left">
<span class="bold small">gray<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["gray out the image"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self color: gray effect: storing<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">reverse<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["reverse  the image (black to white and white to black)"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self color: black effect: 2<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">white <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["white out the image"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">form is: BorderedText⇒ [ (rectangle inset: (¬1⌾¬1) and: (¬1⌾¬1)) clear: 0]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self color: white effect: over.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold large"><br>TRANSFORMATIONS</span></div>
<div class="line left">
<span class="bold small">griddedpoint: pt <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑ ((pt x)| xgrid) ⌾ ((pt y)| ygrid) ]</span></div>
<div class="line left">
<span class="bold small">normalize | delta i <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["recompute origin, rectangle and path so that: path origin = 0⌾0."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[nil ≡ path ⇒ [] delta &larr; (path origin) copy. path normalize. origin translate: delta]. </span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: self length do⦂ [ (self◦i) normalize ].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">translate: delta <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["translate the origin and bounding rectangle of the Image."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">rectangle &larr; rectangle translate: delta.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">origin translate: delta.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">translateto: pt <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["move the Image to pt."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self translate: pt - origin.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold large"><br>SYSTEM</span></div>
<div class="line left">
<span class="bold small">copy </span><span class="small">| im i<br>[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">im &larr; Image new origin: origin copy rectangle: rectangle copy path: path copy form: form copy figure: figure copy ground: ground copy xgrid: xgrid copy  ygrid: ygrid copy.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: self length do⦂ <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[im add: (self◦i) copy].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ im<br>]</span></div>
<div class="line left">
<span class="bold small">fromPress: press value: s </span><span class="small">| numberofsubimages i code t<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["</span><span class="italic small">retrieves and builds an instance of class Image from a press file</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self default. <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">numberofsubimages&larr; s nextword.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">origin &larr; s nextPoint.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">i &larr; s nextPoint.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">rectangle &larr; i rect: s nextPoint.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">xgrid &larr; s nextword.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">ygrid &larr; s nextword.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">figure &larr; s nextword.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">ground &larr; s nextword.<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">form &larr; s next.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">path &larr; s next.<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: numberofsubimages do⦂ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s &larr; press nextControl asStream.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">code &larr; s next.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">t &larr; Image new.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">code = t pressCode⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self addimage: (t fromPress: press value: s)]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user notify: &rsquo;subimage not Image&rsquo;].<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[form=0⇒ [form &larr; nil]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s &larr; press nextControl asStream.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">code &larr; s next.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">form &larr; [code = 4⇒ [TextImage new]; =5⇒ [Form new]; = 6 ⇒[BorderedText new] false].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">form and⦂ code = form pressCode⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[code=4⇒ [form frame &larr; rectangle copy]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[code=6⇒ [form frame &larr; rectangle copy]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">form fromPress: press value: s]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user notify: &rsquo;illegal form&rsquo;].<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[path=0⇒ [path &larr; nil]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s &larr; press nextControl asStream.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">code &larr; s next.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">path &larr; [code = 6⇒ [Path new]; =7⇒ [Point new] false].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">path and⦂ code = path pressCode⇒ [path fromPress: press value: s]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user notify: &rsquo;illegal path&rsquo;]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">hideData: complete </span><span class="small">| s<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["</span><span class="italic small">stores an instance of class Image on a press file. ignore complete</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">Stream new of: (s &larr; String new: 24);<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nextword&larr; self length; "</span><span class="italic small">number of subimages</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nextPoint&larr; origin;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nextPoint&larr; rectangle origin;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nextPoint&larr; rectangle corner;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nextword&larr; xgrid;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nextword &larr; ygrid;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nextword &larr; figure;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nextword &larr; ground;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">next &larr; [form≡nil ⇒ [0] 1];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">next &larr; [path≡nil⇒ [0] 1].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ s]</span></div>
<div class="line left">
<span class="bold small">hidePress: press complete: c </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">c ≥ 0⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">called from </span><span class="bold small">PressPrinter print:in:</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[form≡nil⇒ ["</span><span class="italic small">already done</span><span class="small">"]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">form hidePress: press complete: c].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">path≡nil⇒ []<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">path hidePress: press complete: c]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">¬1. called from </span><span class="bold small">Image presson:in:</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">press skipcode: self pressCode data: (self hideData: c)]</span></div>
<div class="line left">
<span class="bold small">kbd | <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[" default response for Images."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user kbd.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self reverse ; reverse.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">mp | p<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[" returns a gridded point relative to my rectangle."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">p &larr; user mp.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">p x&larr; ((p x) - rectangle origin x) | xgrid. <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">p y&larr; ((p y) - rectangle origin y) | ygrid.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ p<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">pressCode </span><span class="small">[⇑1]</span></div>
<div class="line left">
<span class="bold small">presson: press in: r </span><span class="small">| yvalue t h rect [</span><span class="bold small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self length &gt; 0 and⦂ r height &lt; (h &larr; press scale * self height)⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">try on next page</span><span class="small">" ⇑self]<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self hidePress: press complete: ¬1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ t from: self do⦂ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">yvalue &larr;  t presson: press in: r.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">if subimage didn&rsquo;t fit, print version will be clipped,<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">but entire subimage will be stored</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">t hidePress: press complete: [yvalue is: Integer⇒ [0] 1]].<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">form≡nil⇒ [⇑r corner y - h]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">rect &larr; r copy.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">rect corner y &larr; rect corner y - (( path y)*(press scale)).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">form will be hidden by Image presson:in: or PressPrinter print:in:</span><span class="small">".<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑form presson: press in: rect]</span></div>
<div class="line left">
<span class="bold small">printon: strm </span><span class="small">| t [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">strm append: &rsquo;an Image: &rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">array is: String⇒ [strm space append: self]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ t from: self do⦂ [strm space print: t]]</span></div>
<div class="line left">
<span class="bold large"><br>ACCESS TO PARTS</span></div>
<div class="line left">
<span class="bold small">figure<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["return the figure color (color associated with black) for this Image"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ figure<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">figure: figure <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["change the figure color (color associated with black) for this Image"]</span></div>
<div class="line left">
<span class="bold small">form <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["return the form for this Image"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ form<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">form: form <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["change the form for this Image"]</span></div>
<div class="line left">
<span class="bold small">ground<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["return the ground color (color associated with white) for this Image"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ ground<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">ground: ground <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["change the ground color (color associated with white) for this Image"]</span></div>
<div class="line left">
<span class="bold small">hash </span><span class="small">[⇑rectangle hash]</span></div>
<div class="line left">
<span class="bold small">path <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["return the path for this Image"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ path<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">path: path<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["change the path for this Image"]</span></div>
<div class="line left">
<span class="bold small">superimage: superimage </span></div>
<div class="line left">
<span class="bold small">xgrid <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["return the x gridding module for this Image"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ xgrid<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">xgrid: xgrid <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["set the x gridding module for this Image"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">ygrid <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["return the y gridding module for this Image"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ ygrid<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">ygrid: ygrid <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["set the y gridding module for this Image"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold large"><br>Fist and last</span></div>
<div class="line left">
<span class="bold small">close<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">| im<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[[array≡nil<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇒[]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ im  from: self asArray notNil do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[im close]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">superimage&larr;nil.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">form&larr;nil.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self vector: 0]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪Image under: &rsquo;Form Path Image&rsquo;.</span></div>
<div class="line left">
<span class="small">Image classInit</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"Path"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;Path&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: Set<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;&rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>This class has not yet been commented</span></div>
<div class="line left">
<span class="bold large"><br>INIT</span></div>
<div class="line left">
<span class="bold small">init <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["must be executed for each new instance."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self default.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold large"><br>BUILDING PATHS</span></div>
<div class="line left">
<span class="bold small">comment <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["see Set for these ... add:, append:, and ◦&larr; are the main ones"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold large"><br>ACCESSING PATHS</span></div>
<div class="line left">
<span class="bold small">pointnearestto: p </span><span class="small">| distance i nearest d<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["return the index of the point  in the path nearest (manhatten norm) to p."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">distance &larr; p dist: self◦1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nearest &larr; 1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: position do⦂ <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">d &larr;  p dist: self◦i .<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">d&lt; distance⇒ <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ nearest&larr; i. distance &larr; d.]  <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ nearest<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold large"><br>MODIFYING PATHS</span></div>
<div class="line left">
<span class="bold small">deleteindex: i </span><span class="small">| r [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">r &larr; array◦( i+1 to: position).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">position &larr; i-1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self append: r.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">array◦(position+1) &larr; nil.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">insert: pt atindex: index </span><span class="small">| r <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"insert pt at index in the path"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">index &gt; position⇒ [self next &larr; pt]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">r &larr; [position = limit⇒ [self grow] self growby: 0].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">position &larr; 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self append: (r ◦ 1 to: index-1);<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">next &larr; pt;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">append: r◦(index to: r length).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold large"><br>SPECIAL PATHS</span></div>
<div class="line left">
<span class="bold small">addarcfrom: p1 via: p2 to: p3 </span><span class="small">| pa pb i k s<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"Kaehler method for Flegal curve"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s&larr; Path new init. <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s add: p1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pa&larr; p2-p1. pb&larr; p3-p2.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">k&larr; 5 max: (pa x abs + pa y abs + pb x abs + pb y abs)/20.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: k do⦂</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"k is a guess how many segments are appropriate"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[s add: (pa*i/k+p1*(k-i)) + (pb*(i-1)/k+p2*(i-1)) / (k-1)]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s add: p3 .<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: (s length-1) do⦂ [  self addlinefrom: s◦i to: s◦(i+1) ] <br>]</span></div>
<div class="line left">
<span class="bold small">addlinefrom: p1 to: p2 |</span><span class="small"> x1 y1 dx dy yinc x0 y0 cdl i<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"for now just add points to the space at alto resolution between p1 and p2<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">inclusive"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">dx&larr; ( p2 x) - (p1 x).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">dy&larr; ( p2 y) - (p1 y).<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[dx &lt; 0 ⇒ [dx &larr; 0-dx. dy &larr; 0-dy. x0&larr; p2 x. y0 &larr; p2 y]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">x0 &larr; p1 x. y0 &larr; p1 y].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[dy ≥ 0 ⇒ [yinc&larr;1] yinc &larr; 0-1 . dy &larr; 0-dy].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> dx≥dy⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[cdl &larr; ( dx/2).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i from: 0 to: dx do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self add: (x0⌾y0). cdl &larr; cdl + dy.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">x0 &larr; x0+1. <br> </span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">cdl &gt; dx⇒ [cdl &larr; cdl - dx. y0 &larr; y0 + yinc]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"y is fastest mover"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">cdl &larr; (dy/2).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i from: 0 to: dy do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self add: (x0⌾y0) . cdl &larr; cdl+ dx.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">y0 &larr; y0 + yinc.  <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> cdl &gt; dy ⇒ [cdl &larr; cdl - dy. x0&larr; x0+1]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]. <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold large"><br>TRANSFORMATIONS</span></div>
<div class="line left">
<span class="bold small">+ delta </span><span class="small">| i<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ "add delta to every point in the path"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ (self copy) translate: delta<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">normalize </span><span class="small">| delta i<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ "subtract the origin of the path from every point in the path"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">delta &larr; self origin.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: self length  do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ self◦i &larr; self◦i - delta<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">scale: factor </span><span class="small">| i<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ "scale every point in the path by factor"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: self length  do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ self◦i &larr; self◦i * factor<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">translate: delta </span><span class="small">| i<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ "add delta to every point in the path"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: self length  do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ self◦i &larr; self◦i + delta<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold large"><br>MEASURING</span></div>
<div class="line left">
<span class="bold small">corner <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["return the corner of the bounding rectangle that includes all the points in the path."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ (self rectangle) corner<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">extent <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["return the extent of the bounding rectangle that includes all the points in the path."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ (self rectangle) extent]</span></div>
<div class="line left">
<span class="bold small">height <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["return the height of the bounding rectangle that includes all the points in the path."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ self size y]</span></div>
<div class="line left">
<span class="bold small">origin <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["return the origin of the bounding rectangle that includes all the points in the path."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ (self rectangle) origin<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">rectangle | r  i<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["return the bounding rectangle that includes all the points in the path."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">r &larr; Rectangle new origin: self◦1 extent: 1⌾1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: self length do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ r &larr; r include: self◦i</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ r<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">size <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["return the extent of the bounding rectangle that includes all the points in the path."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ (self rectangle) extent]</span></div>
<div class="line left">
<span class="bold small">width <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["return the width of the bounding rectangle that includes all the points in the path."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ self size x]</span></div>
<div class="line left">
<span class="bold large"><br>SYSTEM</span></div>
<div class="line left">
<span class="bold small">copy  | t<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["returns a new instance of Path that is a copy "<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">t &larr; Path new init.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">t append: (array◦(1 to: position)) copy.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ t]</span></div>
<div class="line left">
<span class="bold small">pressCode </span><span class="small">[⇑6]</span></div>
<div class="line left">
<span class="bold small">printon: strm </span><span class="small">| t [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">strm append: &rsquo;a Path: &rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">array is: String⇒ [strm space append: self]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ t from: self do⦂ [strm space print: t]]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪Path under: &rsquo;Form Path Image&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"Point"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;Point&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: Object<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;x y&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;&rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>I am an x-y pair of numbers usually designating a location on the screen</span></div>
<div class="line left">
<span class="bold large"><br>Initialization</span></div>
<div class="line left">
<span class="bold small">copy <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑ (x⌾y)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">x: x y: y</span></div>
<div class="line left">
<span class="bold large"><br>Arithmetic</span></div>
<div class="line left">
<span class="bold small">≤ pt </span><span class="small">[⇑ x≤pt x and⦂ y≤pt y]</span></div>
<div class="line left">
<span class="bold small">≥ pt </span><span class="small">[⇑ x≥pt x and⦂ y≥pt y]</span></div>
<div class="line left">
<span class="bold small">* scale<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"Return a Point that is the product of me and scale (which is a Point or Number)"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑Point new x: (x * scale asPtX) y: (y * scale asPtY)]</span></div>
<div class="line left">
<span class="bold small">+ delta<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"Return a Point that is the sum of me and delta (which is a Point or Number)"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑Point new x: (x + delta asPtX) y: (y + delta asPtY)]</span></div>
<div class="line left">
<span class="bold small">- delta<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"Return a Point that is the difference of me and delta (which is a Point or Number)"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑Point new x: (x - delta asPtX) y: (y - delta asPtY)]</span></div>
<div class="line left">
<span class="bold small">/ scale<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"Return a Point that is the quotient of me and scale (which is a Point or Number)"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑Point new x: (x / scale asPtX) y: (y / scale asPtY)]</span></div>
<div class="line left">
<span class="bold small">&lt; pt </span><span class="small">[⇑ x&lt;pt x and⦂ y&lt;pt y]</span></div>
<div class="line left">
<span class="bold small">= pt </span><span class="small">[⇑x=pt x and⦂ y=pt y]</span></div>
<div class="line left">
<span class="bold small">&gt; pt </span><span class="small">[⇑x&gt;pt x and⦂ y&gt;pt y]</span></div>
<div class="line left">
<span class="bold small">abs</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"absolute value of a point"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑Point new x: (x abs) y: (y abs)</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">dist: pt </span><span class="small">| t</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"distance (Manhattan norm) between pt and self"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[t &larr; (pt - self) abs.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑(t x) + (t y)]</span></div>
<div class="line left">
<span class="bold small">length<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑((x asFloat*x asFloat)+(y asFloat*y asFloat)) sqrt]</span></div>
<div class="line left">
<span class="bold small">max: t<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑Point new x: (x max: t x) y: (y max: t y)]</span></div>
<div class="line left">
<span class="bold small">min: t<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑Point new x: (x min: t x) y: (y min: t y)]</span></div>
<div class="line left">
<span class="bold small">normal </span><span class="small">| n</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"unit vector rotated 90 deg clockwise"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[n&larr; y asFloat neg ⌾ x asFloat.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑n/n length]</span></div>
<div class="line left">
<span class="bold small">normalize <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"set selt to zero"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self x &larr; 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self y &larr; 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">translate:  delta<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"increment self by delta"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">x &larr; x + delta x.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">y &larr; y + delta y.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="small">| grid<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑Point new x: x|grid y: y|grid]</span></div>
<div class="line left">
<span class="bold large"><br>Conversion</span></div>
<div class="line left">
<span class="bold small">asPoint<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"Return self."</span><span class="small">]</span></div>
<div class="line left">
<span class="bold small">asPtX<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑x]</span></div>
<div class="line left">
<span class="bold small">asPtY<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑y ]</span></div>
<div class="line left">
<span class="bold small">asRectangle<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"Return a Rectangle with me as both origin and corner."</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑self rect: self]</span></div>
<div class="line left">
<span class="bold small">asRectCorner </span><span class="italic small">"pretend to be a Rectangle for Rectangle +-*/"</span></div>
<div class="line left">
<span class="bold small">asRectOrigin </span><span class="italic small">"pretend to be a Rectangle for Rectangle +-*/"</span></div>
<div class="line left">
<span class="bold small">corner<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑ self+ (1⌾1)]</span></div>
<div class="line left">
<span class="bold small">extent<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑ (1⌾1)]</span></div>
<div class="line left">
<span class="bold small">extent: p</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"infix creation of rectangles"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑Rectangle new origin: self extent: p]</span></div>
<div class="line left">
<span class="bold small">height<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑ 1]</span></div>
<div class="line left">
<span class="bold small">origin<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑ self]</span></div>
<div class="line left">
<span class="bold small">printon: strm <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[strm print: x; append: &rsquo;⌾&rsquo;; print: y]</span></div>
<div class="line left">
<span class="bold small">rect: p</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"infix creation of rectangles"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑Rectangle new origin: self corner: p]</span></div>
<div class="line left">
<span class="bold small">width<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑ 1]</span></div>
<div class="line left">
<span class="bold large"><br>Access to parts</span></div>
<div class="line left">
<span class="bold small">hash </span><span class="small">[⇑(x lshift: 2) lxor: y]</span></div>
<div class="line left">
<span class="bold small">theta </span><span class="small">| tan theta "return the angle the point makes with origin.  right is 0; down is 90."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[x=0 ⇒ [y≥0 ⇒ [⇑ 90.0] ⇑ 270.0].<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> tan &larr; y asFloat/x asFloat.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> theta &larr; tan arctan.<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> x≥0 ⇒ [y≥0 ⇒[⇑ theta] ⇑360.0 + theta].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> ⇑ 180.0 + theta]</span></div>
<div class="line left">
<span class="bold small">x</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold small"> </span><span class="small">[⇑x]</span></div>
<div class="line left">
<span class="bold small">x &larr; x</span></div>
<div class="line left">
<span class="bold small">y </span><span class="small">[⇑y]</span></div>
<div class="line left">
<span class="bold small">y &larr; y</span></div>
<div class="line left">
<span class="bold large"><br>SYSTEM</span></div>
<div class="line left">
<span class="bold small">fromPress: press value: s<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ x &larr; s nextword. y &larr; s nextword]</span></div>
<div class="line left">
<span class="bold small">hideData: complete </span><span class="small">| s<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[Stream new of: (s &larr; String new: 4); nextPoint&larr; self.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ s]</span></div>
<div class="line left">
<span class="bold small">hidePress: press complete: c<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[press skipcode: self pressCode data: (self hideData: c)]</span></div>
<div class="line left">
<span class="bold small">pressCode </span><span class="small">[⇑7]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪Point under: &rsquo;Form Path Image&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"Rectangle"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;Rectangle&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: Object<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;origin corner&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;&rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>I am a pair of points, usually representing a rectangular area on the screen</span></div>
<div class="line left">
<span class="bold large"><br>Initialization</span></div>
<div class="line left">
<span class="bold small">copy  <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["new rectangle"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ (origin copy) rect: (corner copy)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">fromuser </span><span class="small">| t<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"Show the origin cursor until the user presses a mouse button,<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">then get my origin"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">origin&larr;OriginCursor showwhile⦂ [user waitbug].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"Show the corner cursor and complement me until the user presses<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">a button again.  The loop is arranged so <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">that complementing stays on for a little while."</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">t&larr;origin.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">CornerCursor showwhile⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[while⦂ [corner&larr;t.  t &larr; user mpnext] do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self comp.  t &larr; t max: origin.  self comp]]]</span></div>
<div class="line left">
<span class="bold small">fromuserevenword </span><span class="small">| t<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"Show the origin cursor until the user presses a mouse button,<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">then get my origin"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">origin&larr;OriginCursor showwhile⦂ [user waitbug].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"Show the corner cursor and complement me until the user presses<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">a button again.  The loop is arranged so <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">that complementing stays on for a little while."</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">t&larr;origin.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">CornerCursor showwhile⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[while⦂ [corner &larr; t.  t &larr; user mpnext] do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self comp.  t &larr; (((t x) + 15 | 16) ⌾ t y) max: origin.  self comp]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">origin: origin corner: corner</span></div>
<div class="line left">
<span class="bold small">origin: origin extent: extent<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[corner &larr; origin+extent]</span></div>
<div class="line left">
<span class="bold large"><br>Aspects</span></div>
<div class="line left">
<span class="bold small">area </span><span class="small">[⇑(self width)*(self height)]</span></div>
<div class="line left">
<span class="bold small">bottom </span><span class="small">[⇑corner y]</span></div>
<div class="line left">
<span class="bold small">corner </span><span class="small">[⇑corner]</span></div>
<div class="line left">
<span class="bold small">corners </span><span class="small">| v<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[v&larr; Vector new: 4.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">v◦1&larr; origin. v◦2&larr; corner x⌾ origin y.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">v◦3&larr; corner. v◦4&larr; origin x⌾corner y.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑v]</span></div>
<div class="line left">
<span class="bold small">corner &larr; corner</span></div>
<div class="line left">
<span class="bold small">edge: side </span><span class="small">"</span><span class="italic small">Returns one side as a number.</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">Sides are numbered 0-3.  +1 goes counterclockwise.  lxor: 2 gets opposite side.</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[side<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=0⇒["top" ⇑origin y];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=1⇒["left" ⇑origin x];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=2⇒["bottom" ⇑corner y];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=3⇒["right" ⇑corner x].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user notify: &rsquo;Invalid side&rsquo;]</span></div>
<div class="line left">
<span class="bold small">extent<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑corner-origin]</span></div>
<div class="line left">
<span class="bold small">extent &larr; extent<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[corner &larr; origin+extent. ⇑extent]</span></div>
<div class="line left">
<span class="bold small">hash </span><span class="small">[⇑(origin lshift: 1) lxor: corner]</span></div>
<div class="line left">
<span class="bold small">height<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑corner y - origin y]</span></div>
<div class="line left">
<span class="bold small">height &larr; h </span><span class="italic small">"change my bottom y to make my height h"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[corner y &larr; origin y + h]</span></div>
<div class="line left">
<span class="bold small">leftside </span><span class="small">[⇑origin x]</span></div>
<div class="line left">
<span class="bold small">maxX </span><span class="small">[⇑corner x]</span></div>
<div class="line left">
<span class="bold small">maxY </span><span class="small">[⇑corner y]</span></div>
<div class="line left">
<span class="bold small">minX </span><span class="small">[⇑origin x]</span></div>
<div class="line left">
<span class="bold small">minY </span><span class="small">[⇑origin y]</span></div>
<div class="line left">
<span class="bold small">origin </span><span class="small">[⇑origin]</span></div>
<div class="line left">
<span class="bold small">origin &larr; origin</span></div>
<div class="line left">
<span class="bold small">rightside </span><span class="small">[⇑corner x]</span></div>
<div class="line left">
<span class="bold small">side: side </span><span class="italic small">"Returns one side as a rectangle."</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"Sides are numbered 0-3.  +1 goes counterclockwise.  Xor: 2 gets opposite side."</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[side<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=0⇒[</span><span class="italic small">"top"</span><span class="small"> ⇑origin rect: corner x⌾origin y];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=1⇒[</span><span class="italic small">"left"</span><span class="small"> ⇑origin rect: origin x⌾corner y];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=2⇒[</span><span class="italic small">"bottom"</span><span class="small"> ⇑origin x⌾corner y rect: corner];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=3⇒[</span><span class="italic small">"right"</span><span class="small"> ⇑corner x⌾origin y rect: corner].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user notify: &rsquo;Invalid side&rsquo;]</span></div>
<div class="line left">
<span class="bold small">size<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑corner-origin]</span></div>
<div class="line left">
<span class="bold small">top </span><span class="small">[⇑origin y]</span></div>
<div class="line left">
<span class="bold small">width<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑corner x - origin x]</span></div>
<div class="line left">
<span class="bold small">width &larr; w </span><span class="italic small">"change my right x to make my width w"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[corner x &larr; origin x + w]</span></div>
<div class="line left">
<span class="bold small">withEdge: side at: coord </span><span class="small">"Returns a rectangle with one side moved."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[side<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=0⇒ [⇑origin x⌾coord rect: corner];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=1⇒ [⇑coord⌾origin y rect: corner];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=2⇒ [⇑origin rect: corner x⌾coord];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=3⇒ [⇑origin rect: coord⌾corner y].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user notify: &rsquo;Invalid side&rsquo;]</span></div>
<div class="line left">
<span class="bold small">withSide: side at: pt </span><span class="italic small">"Returns a rectangle with one side moved."</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[side<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=0⇒ [⇑origin x⌾pt y rect: corner];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=1⇒ [⇑pt x⌾origin y rect: corner];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=2⇒ [⇑origin rect: corner x⌾pt y];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=3⇒ [⇑origin rect: pt x⌾corner y].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user notify: &rsquo;Invalid side&rsquo;]</span></div>
<div class="line left">
<span class="bold large"><br>Arithmetic</span></div>
<div class="line left">
<span class="bold small">* scale </span><span class="small">[<br></span><span class="italic small">"Return a Rectangle which is the product of me and scale (which is a Rectangle, Point, or Number)"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑Rectangle new origin: origin * scale asRectOrigin corner: corner * scale asRectCorner]</span></div>
<div class="line left">
<span class="bold small">+ delta </span><span class="small">[<br>"</span><span class="italic small">Return a Rectangle which is the sum of me and delta (which is a Rectangle, Point, or Number)"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑Rectangle new origin: origin + delta asRectOrigin corner: corner + delta asRectCorner]</span></div>
<div class="line left">
<span class="bold small">- delta </span><span class="small">[<br></span><span class="italic small">"Return a Rectangle which is the difference of me and delta (which is a Rectangle, Point, or Number)"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑Rectangle new origin: origin - delta asRectOrigin corner: corner - delta asRectCorner]</span></div>
<div class="line left">
<span class="bold small">/ scale </span><span class="small">[<br></span><span class="italic small">"Return a Rectangle which is the quotient of me and scale (which is a Rectangle, Point, or Number)"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑Rectangle new origin: origin / scale asRectOrigin corner: corner / scale asRectCorner]</span></div>
<div class="line left">
<span class="bold small">= r<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑origin = r origin and: corner = r corner]</span></div>
<div class="line left">
<span class="bold small">center<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑origin+corner/2]</span></div>
<div class="line left">
<span class="bold small">empty<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑(origin &lt; corner)≡false]</span></div>
<div class="line left">
<span class="bold small">has: pt </span><span class="small">[⇑origin ≤ pt and⦂ pt &lt; corner]</span></div>
<div class="line left">
<span class="bold small">include: r </span><span class="italic small">"Returns the merge with an adjacent rectangle."</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑(origin min: r origin) rect: (corner max: r corner)]</span></div>
<div class="line left">
<span class="bold small">inset: p1<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑origin+p1 rect: corner-p1]</span></div>
<div class="line left">
<span class="bold small">inset: p1 and: p2<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑origin+p1 rect: corner-p2]</span></div>
<div class="line left">
<span class="bold small">intersect: r </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑Rectangle new origin: (origin max: r origin)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">corner: (corner min: r corner)]</span></div>
<div class="line left">
<span class="bold small">intersects: r<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑(origin max: r origin) &lt; (corner min: r corner)]</span></div>
<div class="line left">
<span class="bold small">isWithin: rect</span><span class="small bold italic">  </span><span class="italic small">"am I equal to or contained within rect"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑origin ≥ rect origin and⦂ corner ≤ rect corner]</span></div>
<div class="line left">
<span class="bold small">max: rect<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑Rectangle new<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">origin: (origin min: rect origin)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">corner: (corner max: rect corner)]</span></div>
<div class="line left">
<span class="bold small">minus: r </span><span class="small">| s yorg ycor</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"return Vector of Rectangles comprising<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">the part of me not intersecting r "</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"Make sure the intersection is non-empty"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[origin≤r corner and⦂ r origin≤corner⇒ [] ⇑self inVector].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s &larr; (Vector new: 4) asStream.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[r origin y&gt;origin y⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[s next &larr; origin rect: corner x⌾(yorg &larr; r origin y)]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> yorg &larr; origin y].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[r corner y&lt;corner y⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[s next &larr; origin x⌾(ycor &larr; r corner y) rect: corner]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> ycor &larr; corner y].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[r origin x&gt;origin x⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[s next &larr; origin x⌾yorg rect: r origin x⌾ycor]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[r corner x&lt;corner x⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[s next &larr; r corner x⌾yorg rect: corner x⌾ycor]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑s contents]</span></div>
<div class="line left">
<span class="bold small">nearest: pt<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑((origin x max: pt x) min: corner x) ⌾<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">((origin y max: pt y) min: corner y)]</span></div>
<div class="line left">
<span class="bold small">side: side distanceTo: pt<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[side<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=0⇒ [⇑pt y-origin y];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=1⇒ [⇑pt x-origin x];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=2⇒ [⇑corner y-pt y];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=3⇒ [⇑corner x-pt x].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user notify: &rsquo;Invalid side&rsquo;]</span></div>
<div class="line left">
<span class="bold small">sideNearest: pt </span><span class="small">| d dmin i imin<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[dmin &larr; 077777.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i from: (0 to: 3) do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[dmin&gt;(d &larr; self side: i distanceTo: pt) abs⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[dmin &larr; d.  imin &larr; i]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑imin]</span></div>
<div class="line left">
<span class="bold large"><br>Altering</span></div>
<div class="line left">
<span class="bold small">dragto: dest </span><span class="small">| v i<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self blt: dest mode: storing.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">v &larr; dest rect: dest+self extent.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i from: (self minus: v) do⦂ [i clear].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">origin &larr; dest. corner &larr; v corner]</span></div>
<div class="line left">
<span class="bold small">growby: pt<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[corner &larr; corner + pt]</span></div>
<div class="line left">
<span class="bold small">growto: corner </span></div>
<div class="line left">
<span class="bold small">maxstretch: bound </span><span class="small">| bx by boundr selfr<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[bx&larr;(bound corner-origin) x. by&larr;(bound corner-origin) y.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">boundr&larr;bx asFloat/by. selfr&larr;self width asFloat/self height.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">selfr&gt;boundr⇒[self extent&larr;(bx⌾(bx asFloat/selfr) asInteger)]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self extent&larr;((by asFloat*selfr) asInteger⌾by)]</span></div>
<div class="line left">
<span class="bold small">moveby: pt<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[origin &larr; origin+pt. corner &larr; corner+pt]</span></div>
<div class="line left">
<span class="bold small">moveto: pt<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[corner &larr; corner+pt-origin. origin&larr;pt]</span></div>
<div class="line left">
<span class="bold small">translate: pt<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[origin &larr; origin+pt. corner &larr; corner+pt]</span></div>
<div class="line left">
<span class="bold small">translateto: pt <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self translate:  pt - origin. ]</span></div>
<div class="line left">
<span class="bold small">usermove <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self usermove: user screenrect]</span></div>
<div class="line left">
<span class="bold small">usermove: bound </span><span class="small">| m lim<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[lim&larr;bound corner-self extent. self bordercomp. m&larr;user mp.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ true do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[[user redbug⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self bordercomp; moveto: (bound origin max: ((m&larr;user mp) min: lim)); bordercomp]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ (user anybug and⦂ m=user mp) do⦂ [].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[user bluebug⇒[user waitnobug. ⇑self bordercomp]]]]</span></div>
<div class="line left">
<span class="bold small">usersize <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self usersize: user screenrect]</span></div>
<div class="line left">
<span class="bold small">usersize: bound </span><span class="small">| m lim<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[[self origin≡nil⇒[origin&larr;user mp. self extent&larr;16]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self bordercomp. m&larr;user mp.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ true do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[lim&larr;bound corner-self extent.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[user redbug⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self bordercomp; moveto: (bound origin max: ((m&larr;user mp) min: lim)); bordercomp]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[user yellowbug⇒[self bordercomp.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">corner&larr;m&larr;(user mp min: bound corner) max: origin. self bordercomp]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ (user anybug and⦂ m=user mp) do⦂ [].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[user bluebug⇒[user waitnobug. ⇑self bordercomp]]]]</span></div>
<div class="line left">
<span class="bold large"><br>Conversion</span></div>
<div class="line left">
<span class="bold small">asRectangle<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"Return self."</span><span class="small">]</span></div>
<div class="line left">
<span class="bold small">asRectCorner<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑corner ]</span></div>
<div class="line left">
<span class="bold small">asRectOrigin<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑origin ]</span></div>
<div class="line left">
<span class="bold small">bitsFromStream: strm </span><span class="small">| rec s [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">rec &larr; origin rect: origin + (self width ⌾ (16 min: self height)).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s&larr; String new: rec bitStringLength.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ rec maxY ≤ corner y do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[strm into: s.  rec bitsFromString: s; moveby: 0⌾16].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">rec minY &lt; corner y⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[rec corner y&larr; corner y.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s&larr; nil. s&larr; String new: rec bitStringLength.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">strm into: s.  rec bitsFromString: s]]</span></div>
<div class="line left">
<span class="bold small">bitsFromString: str<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"default stores bits onto display"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self bitsFromString: str mode: storing]</span></div>
<div class="line left">
<span class="bold small">bitsFromString: str mode: mode </span><span class="small">[user croak] primitive: 52</span></div>
<div class="line left">
<span class="bold small">bitsFromString: str mode: mode clippedBy: clipRect<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">| destRect <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["</span><span class="italic small">Load the screen bits within my area from those stored in </span><span class="small italic underline">str</span><span class="italic small">.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">If </span><span class="small italic underline">clipRect</span><span class="italic small"> is not nil, then load only those bits within both<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">myself and </span><span class="small italic underline">clipRect</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self bitStringLength≠str length⇒[user notify: &rsquo;wrong bit string length&rsquo;]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">destRect&larr;self intersect: user screenrect.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[nil≡clipRect⇒[] destRect&larr;destRect intersect: clipRect].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">BitBlt init destbase&larr;mem◦066;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">destraster&larr;user screenrect width/16|2;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">dest&larr;destRect origin;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">extent&larr;destRect extent;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">sourceraster&larr;corner x-origin x+15/16;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">source&larr;destRect origin-origin;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">sourcebase &larr; str ; copy: mode]</span></div>
<div class="line left">
<span class="bold small">bitsIntoString </span><span class="small">| str [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">str &larr; String new: self bitStringLength.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self  bitsIntoString: str mode: storing.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑str]</span></div>
<div class="line left">
<span class="bold small">bitsIntoString: str<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"default stores bits into the string"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self bitsIntoString: str mode: storing]</span></div>
<div class="line left">
<span class="bold small">bitsIntoString: str mode: mode </span><span class="small">[user croak] primitive: 51</span></div>
<div class="line left">
<span class="bold small">bitsIntoString: str mode: mode clippedBy: clipRect<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">| sourceRect <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["</span><span class="italic small">Store the screen bits within my area into </span><span class="small italic underline">str</span><span class="italic small">.  If </span><span class="small italic underline">clipRect</span><span class="italic small"> is not nil,<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">then store only those bits within both myself and </span><span class="small italic underline">clipRect</span><span class="italic small">,<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">leaving alone the other bits in </span><span class="small italic underline">str</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self bitStringLength≠str length⇒[user notify: &rsquo;wrong bit string length&rsquo;]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">sourceRect&larr;self intersect: user screenrect.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[clipRect≡nil⇒[] sourceRect&larr;sourceRect intersect: clipRect].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">BitBlt init destraster&larr;corner x-origin x+15/16;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">dest&larr;sourceRect origin-origin;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">extent&larr;sourceRect extent;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">sourcebase&larr;mem◦066;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">sourceraster&larr;user screenrect width/16|2;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">source&larr;sourceRect origin;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">destbase &larr; str ; copy: mode]</span></div>
<div class="line left">
<span class="bold small">bitsOntoStream: strm </span><span class="small">| rec s [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">rec &larr; origin rect: origin + (self width ⌾ (16 min: self height)).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s&larr; (String new: rec bitStringLength) all&larr;0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ rec maxY ≤ corner y do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[rec bitsIntoString: s; moveby: 0⌾16.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">strm append: s].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">rec minY &lt; corner y⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[rec bitsIntoString: s.  strm append:<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s◦(1 to: s length/rec height*(corner y-rec minY))]]</span></div>
<div class="line left">
<span class="bold small">bitStringLength </span><span class="small">| extent [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">extent &larr; corner - origin.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ 2 * extent y* (extent x +15/16)]</span></div>
<div class="line left">
<span class="bold small">hardcopy: pf </span><span class="small">[self hardcopy: pf thickness: 2]</span></div>
<div class="line left">
<span class="bold small">hardcopy: pf thickness: th </span><span class="small">| r [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ r from: ((self inset: 0-th) minus: self) do⦂ [pf showrect: r color: 0]]</span></div>
<div class="line left">
<span class="bold small">printon: strm <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[strm print: origin; append: &rsquo; rect: &rsquo;; print: corner]</span></div>
<div class="line left">
<span class="bold large"><br>Image</span></div>
<div class="line left">
<span class="bold small">blowup: at by: scale </span><span class="small">| z dest<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[dest &larr; Rectangle new origin: at extent: self extent*scale.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[(dest has: origin) or: (dest has: corner) ⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[z &larr; self bitsIntoString. dest outline.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self moveto: dest origin. self bitsFromString: z]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">dest outline].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self blowup: at by: scale spacing: 1]</span></div>
<div class="line left">
<span class="bold small">blowup: at by: scale spacing: spacing<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">| extent z inc sinc slice width height dest i j spread<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[extent &larr; self extent.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">scale &larr; scale asPoint.  spacing &larr; spacing asPoint.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">dest &larr; Rectangle new origin: at extent: extent*scale.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">z &larr; 1⌾0. width &larr; extent x. height &larr;  0⌾extent y.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">spread &larr; (scale-spacing) x.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: 2 do⦂</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"first do horiz, then vert"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[inc &larr; z * ¬1. sinc &larr; z * scale.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">slice &larr; Rectangle new<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">origin: (z * width) + [i = 1 ⇒[self origin] at]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">extent: z + height.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">dest &larr; at + (z * (scale * width)).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ j to: width do⦂</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"slice it up"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[dest &larr; dest - sinc.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">slice moveby: inc.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">slice blt: dest mode: storing]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">slice &larr; Rectangle new origin: at + z<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">extent: height+(z*(scale-1)).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ j to: width do⦂</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"clear slice source"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[slice clear: white. slice moveby: sinc]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">slice &larr; Rectangle new origin: at<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">extent: height + (z * ((scale*width)-1)).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ j to: spread - 1 do⦂</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"spread it out"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[slice blt: at + z mode: oring]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">z &larr; 0⌾1.</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"flip to do vertical"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">width &larr; extent y. height &larr; (scale*extent) x⌾0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">spread &larr; (scale-spacing) y]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">blt: dest mode: mode </span><span class="small">[user croak] primitive: 47</span></div>
<div class="line left">
<span class="bold small">blt: dest mode: mode clippedBy: clipRect<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">| destRect clippedSource<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["</span><span class="italic small">Copy the screen bits within my area to the rectangle whose<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">origin is </span><span class="small italic underline">dest</span><span class="italic small"> and whose extent is the same as mine.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">If </span><span class="small italic underline">clipRect</span><span class="italic small"> is not nil, then copy only those bits within both<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">the destination rectangle and </span><span class="small italic underline">clipRect</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">destRect&larr;(Rectangle new origin: dest extent: self extent)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">intersect: user screenrect.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[nil≡clipRect⇒[] destRect&larr;destRect intersect: clipRect].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">find the source for the bits after clipping</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">clippedSource&larr;origin+destRect origin-dest.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">BitBlt init<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">destbase&larr;mem◦066;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">destraster&larr;user screenrect width/16|2;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">dest&larr;destRect origin;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">extent&larr;destRect extent;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">sourcebase&larr;mem◦066;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">sourceraster&larr;user screenrect width/16|2;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">source&larr;clippedSource;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">copy: mode]</span></div>
<div class="line left">
<span class="bold small">bltcomp: dest mode: mode </span><span class="small">[user croak] primitive: 48</span></div>
<div class="line left">
<span class="bold small">brush: dest mode: mode color: color </span><span class="small">[user croak] primitive: 49</span></div>
<div class="line left">
<span class="bold small">brush: dest mode: mode color: color clippedBy: clipRect<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">| destRect clippedSource<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["</span><span class="italic small">Brush the screen bits within my area to the rectangle whose<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">origin is </span><span class="small italic underline">dest</span><span class="italic small"> and whose extent is the same as mine.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">If </span><span class="small italic underline">clipRect</span><span class="italic small"> is not nil, then brush only those bits within both<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">the destination rectangle and </span><span class="small italic underline">clipRect</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">destRect&larr;(Rectangle new origin: dest extent: self extent)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">intersect: user screenrect.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[nil≡clipRect⇒[] destRect&larr;destRect intersect: clipRect].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">find the source for the bits after clipping</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">clippedSource&larr;origin+destRect origin-dest.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">BitBlt init<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">color&larr;color;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">destbase&larr;mem◦066;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">destraster&larr;user screenrect width/16|2;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">dest&larr;destRect origin;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">extent&larr;destRect extent;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">sourcebase&larr;mem◦066;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">sourceraster&larr;user screenrect width/16|2;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">source&larr;clippedSource;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">paint: mode]</span></div>
<div class="line left">
<span class="bold small">clear</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"default is backround"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self color: background mode: storing]</span></div>
<div class="line left">
<span class="bold small">clear: color<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self color: color mode: storing]</span></div>
<div class="line left">
<span class="bold small">color: color mode: mode </span><span class="small">[user croak] primitive: 50</span></div>
<div class="line left">
<span class="bold small">comp<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self color: black mode: xoring]</span></div>
<div class="line left">
<span class="bold small">comp: color<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self color: color mode: xoring]</span></div>
<div class="line left">
<span class="bold small">fillin: color mode: mode </span><span class="small">| T bits p s dirs i which</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"Rectangle new fromuser fillin: gray"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[T &larr; Turtle init.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">p&larr; origin + (self width⌾0).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s&larr; Rectangle new origin: p extent: self extent.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">dirs&larr;((1⌾0), (¬1⌾0), (0⌾1), (0⌾¬1)).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bits&larr; s bitsIntoString.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self blt: p mode: storing.</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"s &larr; self"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user waitbug. T place: user mp; pendn.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ user anybug do⦂</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"draw seed in self"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[T goto: user mp].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self blt: p mode: xoring.</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"s &larr; seed only"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s blt: origin mode: xoring.</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"take seed out of self"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user waitbug.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ user anybug do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[for⦂ which from: 0 to: 2 by: 2 do⦂ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: 2 do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[s blt: dirs◦(which+i)+p mode: oring]</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"smear seed around"<br> </span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self blt: p mode: erasing]]</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"then clip to outline"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s brush: origin mode: mode color: color.</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"paint it in"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s bitsFromString: bits]</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"restore background to s"</span></div>
<div class="line left">
<span class="bold small">flash </span><span class="small">[self comp; comp]</span></div>
<div class="line left">
<span class="bold small">reverse<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self color: black mode: xoring]</span></div>
<div class="line left">
<span class="bold small">rotate</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"(0⌾0 rect: 128⌾128) rotate."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">| size maskr spt mpt tpt data temp atab btab i unit<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[size &larr; self extent x. spt &larr; size⌾size.</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"size must be a power of 2"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">data &larr; Rectangle new origin: origin extent: spt.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">maskr &larr; Rectangle new origin: (mpt&larr; origin + (0⌾size)) extent: spt.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">temp &larr; Rectangle new origin: (tpt&larr; mpt + (size⌾0)) extent: spt.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">atab &larr; (0⌾0),(1⌾0),(0⌾0),(0⌾1),(1⌾1),(0⌾1),(1⌾0),(¬1⌾0),(1⌾0).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">btab &larr; (0⌾0),(1⌾1),(0⌾0),(1⌾1),(¬1⌾¬1),(1⌾1).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">unit &larr; size/2.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">maskr clear: white.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(Rectangle new origin: mpt extent: unit⌾unit) clear: black.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">until⦂ unit&lt;1 do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[for⦂ i to: 3 do⦂</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"flip left and right halves"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[temp clear: white.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">maskr blt: atab◦i*unit + tpt mode: storing.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">maskr blt: atab◦(3+i)*unit + tpt mode: oring.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">data bltcomp: tpt mode: erasing.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">temp blt: atab◦(6+i)*unit + origin mode: xoring].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: 3 do⦂</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"flip diagonals"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[temp clear: white.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">maskr blt: btab◦i*unit + tpt mode: storing.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">data bltcomp: tpt mode: erasing.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">temp blt: btab◦(3+i)*unit + origin mode: xoring].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(unit&larr; unit/2)&lt;1⇒[]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">maskr blt: (0⌾unit)+mpt mode: erasing.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">maskr blt: (unit⌾0)+mpt mode: erasing.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">maskr blt: (unit*2⌾0)+mpt mode: oring.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">maskr blt: (0⌾(2*unit))+mpt mode: oring]]</span></div>
<div class="line left">
<span class="bold large"><br>Border</span></div>
<div class="line left">
<span class="bold small">border: thick color: color</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"paints a border withoud disturbing interior"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[(Rectangle new<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">origin: origin-(thick⌾thick) corner: (corner x+thick)⌾origin y)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">clear: color;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">moveto: (origin x-thick)⌾corner y; clear: color;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">origin &larr; corner x⌾(origin y-thick); clear: color;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">moveto: origin-(thick⌾thick); clear: color]</span></div>
<div class="line left">
<span class="bold small">boxcomp</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"paints a border withoud disturbing interior"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[(Rectangle new<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">origin: origin-(2⌾2) corner: (corner x+2)⌾origin y)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">color: black mode: xoring;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">moveto: (origin x-2)⌾corner y; color: black mode: xoring;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">origin &larr; corner x⌾(origin y-2); color: black mode: xoring;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">moveto: origin-(2⌾2); color: black mode: xoring]</span></div>
<div class="line left">
<span class="bold small">outline </span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"default border is two thick"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self outline: 2]</span></div>
<div class="line left">
<span class="bold small">outline: thick </span><span class="small">| t<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[t &larr; (¬1⌾¬1)*thick.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(self inset: t) clear: black.  self clear: white]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪Rectangle under: &rsquo;Form Path Image&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"TextImage"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;TextImage&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: Textframe<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;c1 c2 begintypein superimage figure ground&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;cut esc paste aurora Scrap scrap bs Deletion aurorarunning paragraphmenu ctlw &rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>This class has not yet been commented</span></div>
<div class="line left">
<span class="bold large"><br>INIT</span></div>
<div class="line left">
<span class="bold small">classInit <br></span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bs &larr; 8. ctlw &larr; 145. esc &larr; 160. cut &larr; 173. paste &larr; 158.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">Scrap &larr; Deletion &larr; nullString.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">paragraphmenu &larr; Menu new string:<br>&rsquo;resize<br>fit<br>cut<br>paste<br>copy<br>align<br>figure<br>ground<br>&rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">aurora &larr; "Aurora new" nil.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">aurorarunning &larr; false.<br>]<br></span></div>
<div class="line left">
<span class="bold small">close<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[superimage&larr;nil]</span></div>
<div class="line left">
<span class="bold small">paragraph: para frame: frame style: style<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self paragraph: para frame: frame style: style figure: 1 ground: 0<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">paragraph: para frame: frame style: style figure: figure ground: ground<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[nil≡ para ⇒ [ para &larr; nullString ]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">c1 &larr; c2 &larr; begintypein&larr; 1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self para: para frame: frame style: style<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">text: t width: w | run r<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">c1 &larr; c2 &larr; begintypein&larr; 1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">run &larr; String new: 2. run word: 1 &larr;  16 * 7 + 0177400.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">r &larr; Rectangle new origin: 0⌾0 extent: w⌾(DefaultTextStyle lineheight+2).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self paragraph: (Paragraph new text: t runs: run  alignment: 2) frame: r style: DefaultTextStyle.<br><br> ]</span></div>
<div class="line left">
<span class="bold large"><br>EDITING</span></div>
<div class="line left">
<span class="bold small">align<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[para alignment &larr; ↪(1 2 4 0 0)◦(1+para alignment).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self show.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self reversefrom: c1 to: c2.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">checklooks </span><span class="small">| t val mask [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"see ParagraphEditor checklooks.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">substitute c1 for loc1, c2 for loc2, oldEntity for oldpara, entity for para"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">t &larr; ↪(166 150 137 151   230 214 201 215<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">135 159 144 143 128 127 129 131 180 149<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">199 223 208 207 192 191 240 226) find: user kbck.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">t=0⇒[⇑false]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user kbd.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">t=25⇒[self toBravo]; "ctl-T" <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> =26⇒[self fromBravo]. "ctl-F" <br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"[oldEntity⇒[] oldEntity &larr; entity recopy]."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">val &larr; ↪(1 2 4 256   ¬1 ¬2 ¬4 256  "ctl-b i - x   B I ¬ X"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">0 16 32 48 64 80 96 112 128 144  "ctl-0 1 ... 9"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">160 176 192 208 224 240)◦t.  "ctl-shift-0 1 ... 5"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[val=256⇒[mask&larr; 0377.  val&larr; 0]</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"reset all"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">val&lt;0⇒[mask&larr; 0-val.  val&larr; 0]</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"reset emphasis"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">val&gt;0 and⦂ val&lt;16⇒[mask&larr; val]</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"set emphasis"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">mask&larr; 0360].</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"set font"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">para maskrun: c1 to: c2-1 under: mask to: val]</span></div>
<div class="line left">
<span class="bold small">copyselection <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["copy the current selection and store it in the Scrap."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">Scrap &larr; para copy: c1 to: c2-1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span></div>
<div class="line left">
<span class="bold small">cut <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["cut out the current selection and redisplay the paragraph."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">Scrap &larr; para copy: c1 to: c2-1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self reversefrom: c1 to: c2.</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"deselect old selection"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">para replace: c1 to: c2-1 by: nullString.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">c2 &larr; c1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">begintypein &larr; false.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self show.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self reversefrom: c1 to: c2.</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"show new selection"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span></div>
<div class="line left">
<span class="bold small">edit: superimage </span><span class="small">| pt charindex<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"eventually a general paragraph manipulator for now just a hack."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self show ; reversefrom: c1 to: c2." show current selection"user waitnobug.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">until⦂ 1=2 do⦂ "forever for now"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user kbck⇒ [self kbd]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user yellowbug⇒ [paragraphmenu bug<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=1⇒</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self resize ]; "resize"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=2⇒</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self fit]; "include all of the text in the current selection"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=3⇒</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self cut]; "delete the current selection"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=4⇒</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self paste]; "paste the Scrap over the selection"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=5⇒</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self copyselection]; "copy current selection"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=6⇒</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self align]; "change the alignment of the paragraph"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=7⇒</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self setfigure]; "set color corrisponding to 1"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=8⇒</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self setground] "set color corrisponding to 1"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user redbug⇒ [self reversefrom: c1 to: c2. frame has: (pt &larr; user mp)⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self select: pt]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑self.]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user tabletbug⇒ [frame has: (pt &larr; user mp)⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self tabletBug]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self reversefrom: c1 to: c2. ⇑self.]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user bluebug⇒ [self reversefrom: c1 to: c2. "erase current selection"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑self.] "and exit back to the document"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">fintype<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[begintypein⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[begintypein&lt;c1⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[Scrap &larr; para copy: begintypein to: c1-1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">c1 &larr; begintypein]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">begintypein &larr; false]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑false]</span></div>
<div class="line left">
<span class="bold small">fit</span><span class="small">| t <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"make the bounding rectangle of the TextImage contain all the textwhile not changing the width of the TextImage."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self white.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">frame extent&larr; ((frame width)⌾ 1000).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">t &larr; self rectofchar: (para length+1).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">frame extent&larr; (frame width)⌾((t corner y) - (frame origin y)).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self show. frame border: 1 color: ¬1. self reversefrom: c1 to: c2.<br>]</span></div>
<div class="line left">
<span class="bold small">kbd </span><span class="small">| more char  "key struck on the keyboard"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[c1&lt;c2 and⦂ self checklooks⇒[⇑ self show reversefrom: c1 to: c2]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">more &larr; Set new string: 16.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[begintypein⇒[] Deletion &larr; para copy: c1 to: c2-1. begintypein &larr; c1].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ (char &larr; user kbdnext) do⦂ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">char<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=bs⇒ ["backspace"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">more empty⇒ [begintypein &larr; begintypein min: (c1 &larr; 1 max: c1-1)]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">more skip: ¬1];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=cut⇒ [⇑self cut];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=paste⇒ [⇑self paste];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=ctlw⇒ ["ctl-w for backspace word"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">more reset.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">c1 &larr; 1 max: c1-1.</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ [c1&gt;1 and⦂ (para◦(c1-1)) tokenish] do⦂ [c1 &larr; c1-1].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">begintypein &larr; begintypein min: c1];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=esc⇒ ["</span><span class="italic small">select previous type-in</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[more empty⇒[self reversefrom: c1 to: c2]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">para replace: c1 to: c2-1 by:  more. c1 &larr; c2].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self fintype.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">c1 &larr; c2-Scrap length.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑self reversefrom: c1 to: c2]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"just a normal character"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">more next&larr; char].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">para replace: c1 to: c2-1 by:  more. c2 &larr; c1 + more length. c1 &larr; c2.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self show. self reversefrom: c1 to: c2]</span></div>
<div class="line left">
<span class="bold small">paste <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["paste the Scrap over the current selection and redisplay the paragraph."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self fintype.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self reversefrom: c1 to: c2.</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"deselect current selection"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">para replace: c1 to: c2-1 by: Scrap.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">c2 &larr; c1 + Scrap length.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self show.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self reversefrom: c1 to: c2.</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"highlight new selection"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span></div>
<div class="line left">
<span class="bold small">resize </span><span class="small">| t pt xgrid ygrid<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"Show the origin cursor until the user presses a mouse button,<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">then get my origin"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"Show the corner cursor and show me until  user nobug<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">t&larr;frame origin.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">CornerCursor topage1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user waitbug. self white.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">frame corner&larr; frame origin.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">until⦂ user nobug do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self white.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">( pt &larr; <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">((superimage superimage) mp)+<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">((superimage superimage) rectangle origin)).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">frame corner&larr; pt max: frame origin+ (16⌾(style lineheight)).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self displayat: frame origin effect: 0 clippedBy: frame.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">NormalCursor topage1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self show. frame boxcomp. self reversefrom: c1 to: c2.<br>]</span></div>
<div class="line left">
<span class="bold small">setfigure </span><span class="small">| <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"for now just increment the figure color by 1 \ 14"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">figure &larr; (figure +1 ) \ 14.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self displayat: (self frame origin) effect: 0 clippedBy: user screenrect.<br>]</span></div>
<div class="line left">
<span class="bold small">setground </span><span class="small">| <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"for now just increment the figure color by 1 \ 14"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">ground &larr; (ground +1 ) \ 14.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self displayat: (self frame origin) effect: 0 clippedBy: user screenrect.<br>]</span></div>
<div class="line left">
<span class="bold small">white <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["white out the image"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(frame inset: (¬2⌾¬2)) clear: 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold large"><br>SELECTION</span></div>
<div class="line left">
<span class="bold small">complementfrom: hair1 to: hair2 </span><span class="small">| temprect<br>["Complement the screen dots corresponding to the lines and part-lines of the paragraph between hair1 inclusive and hair2 exclusive.  If hair1 = hair2, this is a no-op.  If hair1 &gt; hair2, they are reversed. This complementing happens in three parts, A, B, and C, between points 1 and 2, according to the following illustration:<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">1AAA<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">BBBB<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">BBBB<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">BBBB<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">CCC2<br>unless there is just one line involved, as in:<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">1DD2<br>"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"one line case"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">hair1 minY = hair2 minY⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[((([hair1 minX ≤ hair2 minX⇒ [hair1 origin rect: hair2 corner]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">hair2 origin rect: hair1 corner]) intersect: frame) intersect: window) comp]<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[hair1 minY &gt; hair2 minY⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">temprect &larr; hair1. hair1 &larr; hair2. hair2 &larr; temprect]].<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">temprect &larr; (frame minX ⌾ hair1 maxY) rect: (frame maxX ⌾ hair2 minY).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(((hair1 origin rect: (temprect maxX ⌾ temprect minY)) intersect: frame) intersect: window)  comp.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">((temprect intersect: frame) intersect: window)  comp.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">((((temprect minX ⌾ temprect maxY) rect: hair2 corner) intersect: frame) intersect: window)  comp.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">reversefrom: char1 to: char2</span><span class="small">| h1 h2<br>["Complement the dots corresponding to the the lines and part-lines of the paragraph between the left edge of char1 and the left edge of char2.  If char1 = char2, this is sort of a no-op.  If char1 &gt; char2, this is undefined."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self ptofchar: char1. h1 &larr; reply1 rect: reply2.<br> </span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[char2=char1⇒[h2 &larr; h1+ (1⌾0)] self ptofchar: char2. h2 &larr; reply1 rect: reply2.].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self complementfrom: h1 to: h2]</span></div>
<div class="line left">
<span class="bold small">select: pt </span><span class="small">| h1 h2 c h drag2 selection<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"draw out and record ( c1 and c2) a selection"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">c1 &larr; c2 &larr; self charofpt: pt.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">h1 &larr; reply1 rect: reply2.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">h2 &larr; h1 + (1⌾0).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self complementfrom: h1 to: h2.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">selection &larr; true.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ (pt &larr; user mpnext) do⦂ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">c &larr; self charofpt: pt.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">h &larr; "proj screenHairBeforeThatChar" reply1 rect: reply2.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[c1 = c2⇒ [drag2 &larr; c ≥ c2]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[drag2⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[c &lt; c1⇒ [h &larr; self ptofchar: (c &larr; c1). h &larr; reply1 rect: reply2.]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self complementfrom: h to: h2.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">c2 &larr; c. h2 &larr; h]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[c &gt; c2⇒ [h &larr; self ptofchar: (c &larr; c2). h &larr; reply1 rect: reply2.]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self complementfrom: h1 to: h.</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">c1 &larr; c. h1 &larr; h].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">h1 = h2⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self complementfrom: h1 to: (h2 &larr; h1 + (1⌾0))]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">drag2⇒ []<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"get rid of extra line in backwards select"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self complementfrom: h2 - (1⌾0) to: h2]</span></div>
<div class="line left">
<span class="bold large"><br>SYSTEM</span></div>
<div class="line left">
<span class="bold small">copy | t<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">t &larr;  TextImage new paragraph: para copy frame: (frame copy) style: style copy.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">t c1&larr; c1 ; c2&larr; c2 ; begintypein &larr; begintypein.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ t<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">fromPress: press value: s </span><span class="small">[</span><span class="bold small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">frame set by Image</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">para &larr; Paragraph new fromPress: press value: s.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">figure &larr; s nextword.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self paragraph: para frame: frame style: DefaultTextStyle<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">figure: figure ground: s nextword]</span></div>
<div class="line left">
<span class="bold small">hideData: complete </span><span class="small">| s p [ <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">p &larr; para hideData: complete.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">Stream new of: (s &larr; String new: p length+4);<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">append: p;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nextword &larr; figure;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nextword &larr; ground.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑s]</span></div>
<div class="line left">
<span class="bold small">hidePress: press complete: c </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">press skipcode: self pressCode data: (self hideData: c)]</span></div>
<div class="line left">
<span class="bold small">pressCode </span><span class="small">[⇑4]</span></div>
<div class="line left">
<span class="bold small">presson: press in: r <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ para presson: press in: r.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">show | </span><span class="small">lastvisible</span><span class="bold small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["display text and expand the frame in y to include all of<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">the text if the textimage is too small"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">super show.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">lastvisible &larr; self rectofchar: para length.</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"see if lastvisible out of frame"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">lastvisible bottom &gt; frame bottom ⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[frame corner y&larr; lastvisible corner y.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">super show.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold large"><br>ACCESS TO PARTS</span></div>
<div class="line left">
<span class="bold small">begintypein&larr; begintypein </span></div>
<div class="line left">
<span class="bold small">c1&larr; c1 </span></div>
<div class="line left">
<span class="bold small">c2&larr; c2 </span></div>
<div class="line left">
<span class="bold small">figure <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["return the figure color (color associated with black) for this TextImage"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ figure<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">figure: figure <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["change the figure color (color associated with black) for this TextImage"]</span></div>
<div class="line left">
<span class="bold small">ground <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["return the ground color (color associated with white) for this TextImage"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ ground<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">ground: ground <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["change the ground color (color associated with white) for this TextImage"]</span></div>
<div class="line left">
<span class="bold small">leftflush<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ (self para) flushleft]</span></div>
<div class="line left">
<span class="bold small">rectangle<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["Return rectangle (frame of Textframe) for compatibility with Image calls -- <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">needed in findbyrect: in Document"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑frame]</span></div>
<div class="line left">
<span class="bold small">text<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑ self para text]</span></div>
<div class="line left">
<span class="bold large"><br>DISPLAY</span></div>
<div class="line left">
<span class="bold small">displayat: pt effect: effect clippedBy: cliprect | clippedrect<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["display text "<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">super displayat: pt effect: effect clippedBy: cliprect.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">aurorarunning⇒ <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[user displayoffwhile⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[clippedrect &larr; (super frame) intersect: (user screenrect).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">aurora destination: clippedrect ; source: clippedrect ;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">figure: figure ; ground: ground ;  function: 002117 "AoverB" ;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> doit; function: 0 ; doit.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪TextImage under: &rsquo;Form Path Image&rsquo;.</span></div>
<div class="line left">
<span class="small">TextImage classInit</span></div>
    <div class="line left">
<span class="small">&rsquo;From Smalltalk 5.5k XM November 24 on 22 November 1980 at 2:57:08 am.&rsquo;<br></span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large">"BitImage"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;BitImage&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: Image<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;strips nstrips&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;brush aurora stripheightSPARE stripheight black white bitimagemenu erase SPARE color formmenu under reverse blankcursor over dotsetter &rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>This class is a virtual bit map represented as a smalltalk String</span></div>
<div class="line left">
<span class="bold large"><br>INIT</span></div>
<div class="line left">
<span class="bold small">classInit <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["sets up colors and effects for BITBLT."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">black &larr; 0-1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">white &larr; 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">over &larr; 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">under &larr; 1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">reverse &larr; 2.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">erase &larr; 3.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">brush &larr; Form new extent: 5⌾5. brush black.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">color &larr; 1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">stripheight &larr; 20.<br>bitimagemenu &larr; Menu new string:<br>&rsquo;size<br>figure<br>ground<br>newform<br>pasteform<br>arc<br>areafill<br>shade<br>vertical<br>horizontal<br>rotate<br>&rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">aurora &larr; "Aurora new" nil.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">fromImage: image <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["creates a virtual bit map with width = (image width) and height = (image height) with the bits in image."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self fromrectangle: image rectangle.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;</div>
<div class="line left">
<span class="bold small">fromrectangle: rect </span><span class="small">| </span><span class="bold small">r i leftover image yposition<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["creates a virtual bit map with width = (r width) , height = (r height)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> and the bits in rect. The Image is  made up of forms that are stripheight high."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">super origin: rect origin extent: rect extent.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nstrips &larr; (rect height + (stripheight -1))/stripheight.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">yposition &larr; 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">leftover &larr; rect height \ stripheight.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ (leftover = 0) ⇒ [leftover &larr; stripheight]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">r &larr; Rectangle new origin: rect origin extent: (rect width)⌾stripheight.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: nstrips do⦂ <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ i = nstrips ⇒ [ r extent &larr; ((rect width)⌾leftover)]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">image &larr; Image new origin: (0⌾0) extent: rect extent.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">image form: (Form new fromrectangle: r) ; path: (0⌾yposition).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self addimage: image.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">yposition &larr; yposition + stripheight.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">r translate: (0⌾stripheight).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"><br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;</div>
<div class="line left">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold small">fromuser  | r<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["create a new Form whose rectangle is specified by the user. "<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">r &larr; Rectangle new fromuser.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self fromrectangle: r<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">fromuserevenword  | r<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["create a new BitImage whose rectangle is specified by the user,<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">truncated to nearest multiple of 16 (for Spruce printing). "<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">r &larr; Rectangle new fromuserevenword.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self fromrectangle: r.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold large"><br>PATTERN ACCESS</span></div>
<div class="line left">
<span class="bold small">erase </span><span class="small">| i<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["sets all bits in the BitImage to white ( to zeros)"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: nstrips do⦂ [ (strips◦i) white]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">nstrips<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ nstrips <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span></div>
<div class="line left">
<span class="bold small">nstrips: nstrips <br></span></div>
<div class="line left">
<span class="bold small">saveScreenBits<br></span><span class="small">[<br>]</span></div>
<div class="line left">
<span class="bold small">strips <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["return the set of Forms making up this BitImage)"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ strips<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">strips: strips <br></span></div>
<div class="line left">
<span class="bold large"><br>MODULE ACCESS</span></div>
<div class="line left">
<span class="bold small">comment <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["see class Image"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">frame </span><span class="small">[ ⇑ rectangle]</span></div>
<div class="line left">
<span class="bold small">moveto: pt  <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self translateto: pt<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold large"><br>FILING</span></div>
<div class="line left">
<span class="bold small">read: filename </span><span class="small">| file subimage strip yposition i<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["Reads the Image in the format nstrips , Form(1) , Form(2) , Form(3) . . .<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">Form(nstips). Where each Form is saved as width,height then bits.  "<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self origin: 0⌾0 extent: 1⌾1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">yposition &larr; 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">file&larr; (dp0 oldFile: filename) readonly.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nstrips &larr; file nextword.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: nstrips do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">strip &larr; Form new fromInstance: file.  <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self addform: strip andpath: (0⌾yposition).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">yposition&larr; yposition+ strip height.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">file close.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">write: filename </span><span class="small">| file subimage<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["Saves the Form in the format nstrips , Form(1) , Form(2) , Form(3) . . .<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">Form(nstips). Where each Form is saved as width,height then bits.  "<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">file &larr; (dp0 file: filename).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">file nextword&larr; nstrips.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ subimage from: self do⦂ [ file append: (subimage form) asInstance. ]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">file close.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold large"><br>DISPLAY</span></div>
<div class="line left">
<span class="bold small">displayat:  path effect: effect clippedBy: cliprect<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">super displayat: path effect: effect clippedBy: cliprect<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">show<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">super displayat: (0⌾0) effect: 0 clippedBy: user screenrect<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold large"><br>SYSTEM</span></div>
<div class="line left">
<span class="bold small">copy </span><span class="small">| t i<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["return a copy of myself"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">t &larr; BitImage new origin: (origin copy) extent: (self extent) copy.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: self length do⦂ [ t add: (self◦i) copy].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ t<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">pressCode </span><span class="small">[⇑3]</span></div>
<div class="line left">
<span class="bold small">printon: strm </span><span class="small">| t<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">strm append: &rsquo;a Bitmage: &rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span></div>
<div class="line left">
<span class="bold small">title <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ &rsquo;&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold large"><br>EDITING</span></div>
<div class="line left">
<span class="bold small">arc </span><span class="small">| pt1 pt2 pt3 p pt<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["arc tool for forms."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">BlankCursor topage1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user clear; print: &rsquo;Redbug 3 points&rsquo;; cr; print: &rsquo;Paints using current brush.&rsquo; .<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user waitnobug.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">until⦂ user redbug do⦂</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ pt1 &larr; self blinkbrush].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">brush displayat: pt1 effect: color clippedBy: user screenrect.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user waitnobug.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">until⦂ user redbug do⦂</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ pt2 &larr; self blinkbrush].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">brush displayat: pt2 effect: color clippedBy: user screenrect.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user waitnobug.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">until⦂ user redbug do⦂</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ pt3 &larr; self blinkbrush].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">brush displayat: pt3 effect: color clippedBy: user screenrect.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">XeqCursor show.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">p &larr; Path new init.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">p addarcfrom: pt1 via: pt2 to: pt3.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ pt from: p do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ brush displayat: pt effect: color clippedBy: user screenrect].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">NormalCursor show<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span></div>
<div class="line left">
<span class="bold small">blinkbrush </span><span class="small">| pt <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["to show current position of brush in the BitImage."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pt &larr; self mp + rectangle origin.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">brush displayat: pt<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">effect: 2 clippedBy: user screenrect.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">brush displayat: pt<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">effect: 2 clippedBy: user screenrect.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ pt<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span></div>
<div class="line left">
<span class="bold small">edit: superimage | bits <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["uses the BitRect toolbox editor"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">XeqCursor show.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">dotsetter &larr; BitRectEditor new picture: self.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">dotsetter firsttime.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">NormalCursor show.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ true do⦂ "forever"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(dotsetter lostMouse and: (user anybug)) ⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">dotsetter outside⇒ []<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">XeqCursor show.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">dotsetter lasttime.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bits &larr; self fromrectangle: rectangle.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">NormalCursor show.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ bits<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">dotsetter eachtime<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span></div>
<div class="line left">
<span class="bold small">grayEdit </span><span class="small">| a b c i d p r v bits "edit up a gray pattern and return it"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["first a rectangle for it.  Then redbug is black, yellow is white,<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">blue terminates"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">r &larr; Rectangle new fromuser. bits&larr;0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">a &larr; r extent. a&larr; (a x max:  a y) | 4. a &larr; a⌾a.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">b &larr; r origin. r extent&larr; a; color: white mode: storing; moveby: 0⌾(0-a y).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">c &larr; a/4.  d &larr; b rect: b+c.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">until⦂ user bluebug do⦂ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user redbug ⇒[p &larr; user mp -b /c.  i &larr; p y *4 +p x +1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">i&lt;1 or⦂ i&gt;16 ⇒[r flash]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">d moveto: b+(c*p); color: black mode: storing.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bits &larr; bits lor: (1 lshift: 16-i).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">r color: bits mode: storing. user waitnobug]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user yellowbug ⇒[p &larr; user mp -b /c.  i &larr; p y *4 +p x +1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">i&lt;1 or⦂ i&gt;16 ⇒[r flash]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">d moveto: b+(c*p); color: white mode: storing.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bits &larr; (¬1 lxor:(1 lshift: 16-i)) land: bits.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">r color: bits mode: storing. user waitnobug]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">] ⇑bits]<br>"aa grayEdit base8 ."</span></div>
<div class="line left">
<span class="bold small">horizontalsymmetry </span><span class="small">| r f i <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["horizontal symmetry tool"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user clear; show: &rsquo;Define rectangle. Reflection will be around lower edge&rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">r &larr; Rectangle new fromuser.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">XeqCursor show.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: ( r height) do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">f &larr; Form new fromrectangle: (Rectangle new origin: ((r origin x)⌾((r bottom)-i)) extent: ((r width)⌾1)).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">f displayat: (r origin x)⌾((r bottom) +i) effect: 0 clippedBy: user screenrect.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">NormalCursor show.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">line </span><span class="small">| pt1 pt2 p pt<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["line tool for forms."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">BlankCursor topage1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">until⦂ user redbug do⦂</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ pt1 &larr; self blinkbrush].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">brush displayat: pt1 effect: color clippedBy: user screenrect.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">until⦂ user nobug do⦂</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ pt2 &larr; self blinkbrush].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">brush displayat: pt2 effect: color clippedBy: user screenrect.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">p &larr; Path new init.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">p addlinefrom: pt1 to: pt2.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ pt from: p do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ brush displayat: pt effect: color clippedBy: user screenrect].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">NormalCursor topage1<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span></div>
<div class="line left">
<span class="bold small">newbrush </span><span class="small">|  pt rect<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">OriginCursor topage1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user waitbug.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pt &larr; ( self mp)+ rectangle origin.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">rect &larr; pt rect: pt.</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">CornerCursor topage1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">until⦂ user nobug do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[rect reverse.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">rect reverse.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pt &larr; <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">( self mp)+ rectangle origin.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">rect corner &larr; (rect origin) max: pt.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br> </span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">brush &larr; Form new fromrectangle: rect.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">NormalCursor topage1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span></div>
<div class="line left">
<span class="bold small">pastebrush </span><span class="small">| pt1 <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["one-copy tool for forms."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user waitnobug.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">OriginCursor show.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user waitbug.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ user redbug do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ pt1 &larr; self blinkbrush].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">XeqCursor show.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">brush displayat: pt1 effect: (dotsetter tool mode) clippedBy: user screenrect.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">NormalCursor show]</span></div>
<div class="line left">
<span class="bold small">resize: superimage </span><span class="small">|  pt f<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[dotsetter leave.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">CornerCursor topage1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user waitbug. <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">until⦂ user nobug do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self reverse.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self reverse.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">( pt &larr; <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(superimage  mp)+<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> superimage rectangle origin).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self corner&larr; pt max: ((self origin) + (16⌾16)).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br> </span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self fromrectangle: rectangle.<br> </span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self white ; display.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">NormalCursor topage1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self edit: superimage<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span></div>
<div class="line left">
<span class="bold small">rotate </span><span class="small">| r f i j<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["90 degree rotation tool"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">r &larr; Rectangle new fromuser.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: ( r width) do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ j to: ( r height) do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">f &larr; Form new fromrectangle: (Rectangle new origin: (((r origin x)+i)⌾(r top+j)) extent: (1⌾1)).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">f displayat: (((r corner x)+j))⌾((r top)+i) effect: 0 clippedBy: user screenrect.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">setfigure </span><span class="small">| t<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"for now just increment the figure color by 1 \ 12"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">figure &larr; (figure +1 ) \ 12.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ t from: self do⦂ [ (t form) figure: figure].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self display<br>]<br></span></div>
<div class="line left">
<span class="bold small">setground </span><span class="small">| t<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="italic small">"for now just increment the ground color by 1 \ 12"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">ground &larr; (ground +1 ) \ 12.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ t from: self do⦂ [ (t form) ground: ground].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self display<br>]<br></span></div>
<div class="line left">
<span class="bold small">verticalsymmetry </span><span class="small">| r f i <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["vertical symmetry tool"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user clear; show: &rsquo;Define rectangle. Reflection will be around right-hand edge&rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">r &larr; Rectangle new fromuser.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">XeqCursor show.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: ( r width) do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">f &larr; Form new fromrectangle: (Rectangle new origin: (((r origin x)+(r width)-i)⌾(r top)) extent: (1⌾(r height))).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">f displayat: ((r corner x) + i)⌾(r top) effect: 0 clippedBy: user screenrect.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">NormalCursor show.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">yellowbug </span><span class="small">| <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bitimagemenu bug<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=1⇒</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self resize: superimage<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]; "change size"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=2⇒</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self setfigure];</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=3⇒</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self setground];</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=4⇒</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self newbrush];</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=5⇒</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self pastebrush];</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=6⇒</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self arc ];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=7⇒</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[Rectangle new fromuser fillin: ((dotsetter tool) tone)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">mode: ((dotsetter tool) mode) ];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=8⇒  [(dotsetter tool) shade];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=9⇒  [self verticalsymmetry];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=10⇒  [self horizontalsymmetry];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=11⇒  [self rotate]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪BitImage under: &rsquo;FPI Packages&rsquo;.</span></div>
<div class="line left">
<span class="small">BitImage classInit</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"BorderedText"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;BorderedText&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: TextImage<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;&rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>This class has not yet been commented</span></div>
<div class="line left">
<span class="bold large"><br>DISPLAY</span></div>
<div class="line left">
<span class="bold small">displayat: pt effect: effect clippedBy: cliprect | origin corner<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["display text and border around it "<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">super displayat: pt effect: effect clippedBy: cliprect.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">origin &larr; frame origin.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">corner &larr; frame corner.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(Rectangle new<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">origin: origin-(1⌾1) corner: (corner x+1)⌾origin y)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">color: ¬1 mode: effect;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">moveto: (origin x-1)⌾corner y; color: ¬1 mode: effect;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">origin &larr; corner x⌾(origin y-1); color: ¬1 mode: effect;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">moveto: origin-(1⌾1); color: ¬1 mode: effect<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold large"><br>SYSTEM</span></div>
<div class="line left">
<span class="bold small">copy </span><span class="small">| t<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">t &larr;  BorderedText new paragraph: para copy frame: (frame copy) style: style copy.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">t c1&larr; c1 ; c2&larr; c2 ; begintypein &larr; begintypein.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ t<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">pressCode </span><span class="small">[⇑6]</span></div>
<div class="line left">
<span class="bold small">presson: press in: r | scale<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">scale &larr; press scale.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">press setp: (r origin x- scale)⌾(r corner y-(3*scale)) ;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">showrectwidth: (scale*(2+self width)) height: scale.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">press setp: (r origin x- scale)⌾(r corner y-((self height+5)*scale)) ;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">showrectwidth: (scale*(2+self width)) height: scale.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">press setp: (r origin x- scale)⌾(r corner y-(scale*(self height+4))) ;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">showrectwidth: scale height: (scale*(self height+2)).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">press setp: (r origin x+(scale*(self width)))⌾(r corner y-(scale*(self height+4))) ;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">showrectwidth: scale height: (scale*(self height+2)).<br><br>⇑ para presson: press in: r.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪BorderedText under: &rsquo;FPI Packages&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"Document"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;Document&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: Image<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;displayorder style&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;leading micasperinch &rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>basic document class</span></div>
<div class="line left">
<span class="bold large"><br>EDITING</span></div>
<div class="line left">
<span class="bold small">bubbledelete: image </span><span class="small">| delta i k<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["delete image from the document  and subtracting images extent y from all subimages below it."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">i &larr; self find: image.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">i⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self deleteI: i .<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">delta &larr; image extent y.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ k from: i to: self length do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(self◦k) translate: (0⌾(0-delta))<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">bubbleinsert: image </span><span class="small">| delta i k<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["insert image into the document keeping the document y-sorted and adding images extent y to all subimages below it."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">i &larr; self findindex: image.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self insertI: i value: image.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">delta &larr; image extent y.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ k from: i+1 to: self length do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(self◦k) translate: (0⌾delta)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">delete: image </span><span class="small">|  i <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["delete image from the document and leave its space. "<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">i &larr; self find: image.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">i⇒ [ self deleteI: i.]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">edit <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["Documents are edited with a DocumentEditor"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">DocumentEditor new init: self.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">findindex: image </span><span class="small">| y guess top bottom<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["binary search on the origins of the rectangles surrounding my subimages<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">returns the index of the subimage just below image."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">position = 0 ⇒ [ ⇑ 1]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">top &larr; 1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">bottom &larr; position.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">y&larr; image rectangle origin y.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">y ≤ ((self◦1) rectangle origin y) ⇒ [ ⇑ 1].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">y ≥ ((self◦position) rectangle origin y) ⇒ [ ⇑ position+1]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">guess &larr; position/2.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">until⦂  bottom = (top+1) do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[((self◦guess) rectangle origin y) ≥ y ⇒ [ bottom &larr; guess ] top &larr; guess].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">guess &larr; (bottom + top) /2<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ bottom<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">insert: image </span><span class="small">| i<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["insert image into the document keeping the document y-sorted."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">i &larr; self findindex: image.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self insertI: i value: image.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">resize </span><span class="small">| delta t<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["make sure the document does not have subimages that have negative y values and resize the document"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[position ≥ 1 ⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(delta &larr; (self◦1) top) ≤ 0 ⇒ <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ t from: self do⦂ [ t translate: (0⌾(0-delta)) ] <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">super resize<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold large"><br>INIT</span></div>
<div class="line left">
<span class="bold small">classInit <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">micasperinch &larr; 2540.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">name<br>[ ⇑  displayorder </span><span class="small">"returns the name of the document ( displayorder is currently used for name... note that name is a string."<br></span><span class="bold small"> ] <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"><br></span></div>
<div class="line left">
<span class="bold small">name: displayorder <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["sets the name of the document ( displayorder is currently used for name... note that name is a string."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold large"><br>SYSTEM</span></div>
<div class="line left">
<span class="bold small">copy </span><span class="small">| im i<br>[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">im &larr; Document new origin: origin copy rectangle: rectangle copy path: path copy form: form copy figure: figure copy ground: ground copy xgrid: xgrid copy  ygrid: ygrid copy.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: self length do⦂ <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[im add: (self◦i) copy].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">im name: (self name) copy.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ im<br>]</span></div>
<div class="line left">
<span class="bold small">fromPress: displayorder </span><span class="small">| press s<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["</span><span class="italic small">retrieves an instance of class Document from a press file</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user displayoffwhile⦂ <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self default.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> press &larr; (dp0 pressfile: </span><span class="bold small">displayorder</span><span class="small">). press open.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s &larr; (press nextControl) asStream.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s next = self pressCode ⇒ [self fromPress: press value: s]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user notify: &rsquo;error in pressfile&rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">fromPress: press value:  s </span><span class="small">| numberofsubimages t t1 i code <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["builds an instance of class Document from a press file"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">numberofsubimages&larr; s nextword.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">origin &larr; s nextPoint.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">t &larr; s nextPoint.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">t1 &larr; s nextPoint.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">rectangle &larr; t rect: t1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">xgrid &larr; s nextword.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">ygrid &larr; s nextword.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">displayorder&larr; s nextString.</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: numberofsubimages do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[s &larr; (press nextControl) asStream.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">code &larr; s next. <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">t &larr; [code = 1⇒ [Image new]; = 2⇒ [Heading new];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">= 3⇒ [BitImage new] false].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">t and⦂ code = t pressCode⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self addimage: (t fromPress: press value: s)]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user notify: &rsquo;illegal code or code mismatch&rsquo;]</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ self<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">hardcopy </span><span class="small">|</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">p i press bottoms rect pressscale pageheight pagewidth  lastrect </span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">currentrect oldytop oldybottom <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">oldytop &larr; 11*micasperinch.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pageheight &larr; 11*micasperinch.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pagewidth&larr; 8*micasperinch.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user displayoffwhile⦂ <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">press &larr; dp0 pressfile: (displayorder + &rsquo;.doc&rsquo;).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pressscale &larr; press scale.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self hidePress: press complete: ¬1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">p &larr; PressPrinter init.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">p press: press;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">frame &larr;  ("in micas"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">((1*micasperinch)⌾(1*micasperinch)) rect:<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">((pagewidth-micasperinch)⌾(pageheight-micasperinch))).<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">lastrect &larr; ((self◦1) rectangle)*pressscale.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">rect &larr; ((lastrect leftside)⌾(1*micasperinch))<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">rect: ((lastrect rightside) ⌾(pageheight - (lastrect top))).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">oldybottom &larr; p print: self◦1 in: rect.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i from: (2 to: self length) do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[oldybottom &gt; oldytop⇒ <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["page break" oldytop &larr; pageheight-micasperinch.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">currentrect&larr; ((self◦i) rectangle) * pressscale.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[(currentrect top &gt; lastrect bottom)⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[oldytop &larr; oldybottom+(lastrect bottom-currentrect top)"no overlap"]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">oldytop &larr; (oldytop+(lastrect top-currentrect top))"overlap"].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">rect &larr; ((currentrect leftside)⌾(1*micasperinch))<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">rect: ((currentrect rightside) ⌾(oldytop)).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">oldybottom &larr; p print: (self◦i) in: rect.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">lastrect &larr; ((self◦i) rectangle)*pressscale.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">].<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">press close; toPrinter "send over ethernet to printer"]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">hideData: complete </span><span class="small">| s<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["stores an instance of class Document from a press file"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s &larr; Stream new of: (String new: 100).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s nextword&larr; self length; "number of subimages"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nextPoint&larr; origin;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nextPoint&larr; rectangle origin;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nextPoint&larr; rectangle corner;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nextword&larr; xgrid;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nextword&larr; ygrid;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nextString&larr; displayorder.</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ s contents]</span></div>
<div class="line left">
<span class="bold small">pressCode </span><span class="small">[⇑0]</span></div>
<div class="line left">
<span class="bold small">printon: strm </span><span class="small">| t<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">strm append: &rsquo;a Document &rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪Document under: &rsquo;FPI Packages&rsquo;.</span></div>
<div class="line left">
<span class="small">Document classInit</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"DocumentEditor"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;DocumentEditor&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: Window<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;document documentwindow screenimage firstindex lastindex<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">indexofselection selection &rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;jumpcursor documentmenu scrap blankcursor &rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>This class has not yet been commented</span></div>
<div class="line left">
<span class="bold large"><br>INIT</span></div>
<div class="line left">
<span class="bold small">buildscreenimage |</span><span class="small"> i r delta  <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["This function copies the subimages intersecting the document window<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">into the screen image."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">screenimage &larr; Image new origin: self frame origin extent: self frame extent.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">screenimage  xgrid: (document xgrid) ; ygrid: (document ygrid).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">delta &larr; documentwindow origin y.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">firstindex &larr; 1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">" find the index of the first subimage that intersects the document window."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">until⦂ ((firstindex≥(document length)) or⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">((((document◦firstindex) rectangle) bottom) &gt; (documentwindow top))) do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[firstindex &larr; firstindex+1].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">lastindex &larr; firstindex.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i from: (firstindex to: document length) do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">((((document◦i) rectangle) top) &lt; (documentwindow bottom))⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[lastindex &larr; i. screenimage add: (((document◦i) "copy")<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">translate: 0⌾0 - (0⌾delta))<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">] ⇑ lastindex<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"><br>]</span></div>
<div class="line left">
<span class="bold small">classInit <br></span><span class="italic small">"  DocumentEditor classInit.    "<br></span><span class="small">[</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">documentmenu &larr; Menu new string:<br>&rsquo;move<br>erase<br>place<br>cut<br>paste<br>copy<br>top<br>bottom<br>jump<br>addspace<br>deletespace<br>show<br>&rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">jumpcursor &larr; Cursor new fromtext: &rsquo;<br>1111111111111111<br>1111111111111111<br>0000000000000000<br>0000000000000000<br>0000000000000000<br>0000000000000000<br>0000001110000000<br>0000011111000000<br>0000011111000000<br>0000001110000000<br>0000000000000000<br>0000000000000000<br>0000000000000000<br>0000000000000000<br>1111111111111111<br>1111111111111111&rsquo; offset: 2⌾1.<br>]<br><br></span></div>
<div class="line left">
<span class="bold small">defaultdocument <br></span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self defaultdocument: &rsquo;document&rsquo;<br>]</span></div>
<div class="line left">
<span class="bold small">defaultdocument: name </span><span class="small">| defaultdocument run r textimage f im dot heading head text char b image row<br>[" name is a string"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">defaultdocument &larr; Document new origin: 0⌾0<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">extent: (user screenrect) extent.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">defaultdocument name: name.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">defaultdocument xgrid: DefaultTextStyle tab.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">defaultdocument ygrid: DefaultTextStyle lineheight.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">textimage &larr; BorderedText new.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">textimage text: &rsquo;Text that is bordered&rsquo; width: 200.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">defaultdocument addform: textimage andpath: 0⌾0.<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">textimage &larr; TextImage new.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">textimage text: &rsquo;This is a paragraph&rsquo; width: 600.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">defaultdocument addform: textimage andpath: 0⌾0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">b &larr; BitImage new fromrectangle:<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(Rectangle new origin: 0⌾200 extent: 100⌾100).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">defaultdocument insert: b.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">head &larr; Set new default.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">text &larr; &rsquo;HEADING&rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ char from: text do⦂ [ head add: char ].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">heading &larr; Heading new origin: 0⌾400 index: 9 charactercodes: head<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">currentcharacter: 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">defaultdocument insert: heading.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"defaultdocument insert: CurveIdiom new init."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self init: defaultdocument.<br>]</span></div>
<div class="line left">
<span class="bold small">init: document </span><span class="small">| i <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["This is the paragraph (subimage) level document editor."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self fixedwidthfromuser: document width.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">documentwindow &larr; Rectangle new origin: document rectangle origin<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">extent: (document width) ⌾ (self frame height).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self buildscreenimage.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">selection &larr; false.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user topWindow leave.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self takeCursor; enter.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user restartup: self<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold large"><br>DEFAULT EVENT RESPONSES</span></div>
<div class="line left">
<span class="bold small">close<br></span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">XeqCursor show.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">document close.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">document &larr; nil.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">screenimage &larr; Vector new: 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">NormalCursor show<br>]</span></div>
<div class="line left">
<span class="bold small">enter </span><span class="small">[selection &larr; false. self show]</span></div>
<div class="line left">
<span class="bold small">hardcopy<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["write a press file and hardcopy this document"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self leave.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self top.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">document hardcopy<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">kbd | c x y<br>[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">   c &larr; user kbd. <br> </span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">c = 120⇒<br> </span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ user clearshow: &rsquo;x gridding is &rsquo;. document xgrid print.<br> </span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user cr.<br> </span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">document xgrid: (x&larr;<br> </span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(user request: &rsquo;x gridding . . . &rsquo;) asInteger).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">screenimage xgrid: x. <br> </span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">] <br> </span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">c = 121⇒<br> </span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ user clearshow: &rsquo;y gridding is &rsquo;. document ygrid print.<br> </span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user cr.<br> </span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">document ygrid: (y&larr;<br> </span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(user request: &rsquo;y gridding . . . &rsquo;) asInteger).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">screenimage ygrid: y.<br> </span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">] <br>]<br></span></div>
<div class="line left">
<span class="bold small">leave<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">document ≡ nil ⇒ []<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[selection⇒ [ selection highlite]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self update ; buildscreenimage.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">selection &larr; false.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">print <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["write a press file and hardcopy this document"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">document hardcopy<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">redbug | pt rect newrect start t<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[pt &larr; user mp.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">start&larr;pt.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">rect&larr;newrect&larr;(Rectangle new origin: start corner: start).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[selection⇒ [selection highlite. self deselect. selection &larr; false.]]. <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ user anybug do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[rect&larr;newrect.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">rect comp.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">t&larr;user mp.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">newrect&larr;(Rectangle new origin: (start min: t) corner: (start max: t)).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">rect comp].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(rect width &lt; 10) ⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">selection &larr;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">screenimage smallestsubimageat:  pt- screenimage origin.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">selection⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">selection  translate: screenimage origin.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">selection edit: screenimage.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">selection translate: ((0⌾0) - screenimage origin).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">selection &larr; false.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">rect origin &larr; screenimage griddedpoint: (rect origin).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">selection &larr; screenimage subimageswithin: <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(rect translate: ((0⌾0)- screenimage origin)).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">selection ⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[selection translate: screenimage origin ; highlite]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">yellowbug | pt<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="bold small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">documentmenu bug<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=1⇒[self move];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=2⇒[self delete];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=3⇒[self place];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=4⇒[self cut];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=5⇒[self paste];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=6⇒[self copyselection];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=7⇒[self top];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=8⇒[self bottom];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=9⇒[self jump];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=10⇒[self addspace];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=11⇒[self deletespace];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=12⇒[self deselect. selection &larr; false. self show]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold large"><br>FRAMING</span></div>
<div class="line left">
<span class="bold small">newframe<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self update.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self fixedwidthfromuser: document width.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self buildscreenimage ; show.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">show </span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">XeqCursor show.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self outline .<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">growing⇒[]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">titleframe put: (Paragraph new text: self title runs: titlerun alignment: 0)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">at: frame origin+titleloc; window outline; show.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">screenimage  white.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">screenimage displayat: 0⌾0 effect: 1 clippedBy: self frame.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">selection ⇒ [ selection boxcomp].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">NormalCursor show<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">title </span><span class="small">[ ⇑ document name] </span></div>
<div class="line left">
<span class="bold large"><br>EDITING</span></div>
<div class="line left">
<span class="bold small">addspace </span><span class="small">| image i k r delta<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["add whitespace to the document  ."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self update. selection &larr; false.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">r &larr; document rectanglefromuser.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">i &larr; (document indexofsubimagebelow: (r top- screenimage top) + documentwindow top).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[i⇒ </span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">delta &larr; r height.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ k from: i to: document length do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(document◦k) translate: (0⌾(delta))<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">document resize<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self buildscreenimage ; show.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">bottom </span><span class="small">|  i delta <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["translate the current selection to the bottom of the window and update the document to reflect any changes in the subimages which are scrolled out of the screenimage."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">selection⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">delta &larr; (selection rectangle corner - screenimage rectangle corner).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self update. selection &larr; false.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">documentwindow translate: (0⌾ (delta y)). "move window on document"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self buildscreenimage ; show. <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"reconstruct screen image, including reestablishing  first and last indices"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self update.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">documentwindow &larr; Rectangle new origin:<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(document rectangle corner-self frame height)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">extent: (document width) ⌾ (self frame height).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self buildscreenimage ; show.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span></div>
<div class="line left">
<span class="bold small">closeScrap<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">scrap ≡ nil⇒ []<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">scrap close<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">copy </span><span class="small">| <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["copy the selection and put it in scrap"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self copyselection<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">copyselection </span><span class="small">| <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["copy the selection and put it in scrap"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">selection⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">XeqCursor show.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self closeScrap.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">scrap &larr; selection copy.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">NormalCursor show<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">frame flash<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">cut </span><span class="small">| t <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["delete subimage (paragraph) from the screenimage and save it in the scrap"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">selection⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">XeqCursor show.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self closeScrap.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">scrap &larr; selection.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self update.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ t from: selection do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">document bubbledelete: t.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">selection &larr; false.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self buildscreenimage ; show.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">NormalCursor show<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">frame flash<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">delete | t<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["delete subimage (paragraph) from the screenimage and save it in the scrap"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">selection⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">XeqCursor show.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self closeScrap.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">scrap &larr; selection.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">selection highlite ;  display: 3.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ t from: selection do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[screenimage delete: t<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]. <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">selection &larr; false.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">NormalCursor show.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">frame flash<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">deletespace </span><span class="small">| image i k r delta<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["delete whitespace from the document  ."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self update. selection &larr; false.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">r &larr; document rectanglefromuser.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">i &larr; (document indexofsubimagebelow: (r top - screenimage top) + documentwindow top).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[i⇒ </span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">delta &larr; r height.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ k from: i to: document length do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(document◦k) translate: (0⌾(0-delta))<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">document resize<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self buildscreenimage ; show.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">deselect </span><span class="small">| t<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[selection⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">selection translate: ((0⌾0) - screenimage origin).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ t from: selection do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[t translate: selection origin<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">].<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> ]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">] </span></div>
<div class="line left">
<span class="bold small">editTitle<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[titlepara&larr;document name asParagraph.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">super editTitle.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">document name: titlepara text]</span></div>
<div class="line left">
<span class="bold small">jump<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">|  y deltay yprime deltayprime rect pt newY scal r<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[user waitnobug.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">XeqCursor show.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self update.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">y &larr; document height.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">yprime &larr; frame height.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">deltay &larr; (documentwindow origin y) - (document  origin y).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">scal&larr;yprime asFloat/y.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">deltayprime &larr; (scal*deltay) asInteger.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pt &larr; ((screenimage leftside+((1.0-scal)*frame width/2))⌾((screenimage top) + deltayprime)).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">document quickDisplayAt: 0⌾0 scale: scal offset: (frame minX + ((1.0-scal)*frame width/2))⌾frame minY.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">rect&larr;0⌾0 rect: 1⌾1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">rect origin &larr; pt.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">rect corner x&larr;pt x +(scal*frame width) asInteger.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">rect corner y&larr;pt y + (scal*frame height) asInteger.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user cursorloc&larr;pt.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">OriginCursor show.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user waitbug.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[user redbug<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇒</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[rect comp.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ user redbug do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[r&larr;rect copy.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">newY&larr;user mp y.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[newY&lt;(frame minY- rect height) ⇒ [newY&larr;frame minY-rect height]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[newY&gt;frame maxY ⇒ [newY&larr;frame maxY]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">rect translateto: pt x⌾newY.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">r comp.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">rect comp].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">rect comp.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">XeqCursor show.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">deltayprime &larr; newY - (frame origin y).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">deltay &larr; y*deltayprime/yprime.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">documentwindow translateto: (0⌾deltay).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">selection &larr; false]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self buildscreenimage.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self show.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">NormalCursor show]</span></div>
<div class="line left">
<span class="bold small">move </span><span class="small">| pt t<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["used to place subimages (paragraphs) in the Image."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">selection<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇒</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[user waitnobug.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">OriginCursor show.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user waitbug. <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">selection highlite ; displayat: 0⌾0 effect: 3 clippedBy: frame.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ user redbug do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[pt &larr;screenimage mp + screenimage rectangle origin.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">selection translateto: pt.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">selection blink].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">XeqCursor show.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">selection displayat: 0⌾0 effect: 1 clippedBy: frame .<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self deselect.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">selection &larr; false.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">NormalCursor show]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">frame flash]</span></div>
<div class="line left">
<span class="bold small">paste </span><span class="small">| </span><span class="bold small">pt t</span><span class="small"><br><br>["add the subimage (paragraph) in the scrap to the screenimage."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">selection⇒ [selection highlite]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self update.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">selection &larr; scrap copy.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">OriginCursor showwhile⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user waitbug.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">until⦂ user nobug do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pt &larr;screenimage mp + screenimage rectangle origin.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">selection  translateto: pt ; blink<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">selection displayat: 0⌾0 effect: 1 clippedBy: self frame .<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self deselect.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ t from: selection do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">document bubbleinsert: (t translate: documentwindow origin).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">selection &larr; false.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self buildscreenimage ; show.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">place </span><span class="small">| pt tempimage t<br><br>["add the image in the scrap to the screenimage."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[selection⇒[selection highlite]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self deselect.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">selection &larr; scrap copy.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">OriginCursor showwhile⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user waitbug.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">until⦂ user nobug do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pt &larr;screenimage mp + screenimage rectangle origin.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">selection translateto: pt ; blink<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">selection  displayat: 0⌾0 effect: 1 clippedBy: self frame.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self deselect.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ t from: selection do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">screenimage add: t.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">selection &larr; false.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">top </span><span class="small">|  i delta <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["translate the current selection to the top of the window and update the document to reflect any changes in the subimages which are scrolled out of the screenimage."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">selection⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">delta &larr; (selection rectangle origin - screenimage rectangle origin).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self update. selection &larr; false.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">documentwindow translate: (0⌾ (delta y)). "move window on document"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> self buildscreenimage ; show. <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"reconstruct screen image, including reestablishing  first and last indices"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self update.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">documentwindow &larr; Rectangle new origin: document rectangle origin<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">extent: (document width) ⌾ (self frame height).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self buildscreenimage ; show.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span></div>
<div class="line left">
<span class="bold small">update </span><span class="small">|  i <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["update the document to reflect any changes in the subimages ."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">XeqCursor topage1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[selection⇒</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self deselect]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">document deleteI: firstindex to: lastindex. "update document"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: screenimage length  do⦂ <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[document insert: <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(screenimage◦i translate: (0⌾documentwindow origin y)).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">document resize.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">NormalCursor topage1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪DocumentEditor under: &rsquo;FPI Packages&rsquo;.</span></div>
<div class="line left">
<span class="small">DocumentEditor classInit</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"Heading"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;Heading&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: Image<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;formset index charactercodes currentcharacter&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;headingmenu &rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>This class has not yet been commented</span></div>
<div class="line left">
<span class="bold large"><br>INIT</span></div>
<div class="line left">
<span class="bold small">classInit <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["menu for the Heading edits."<br><br>headingmenu &larr; Menu new string:<br>&rsquo;right<br>left<br>up<br>down<br>font<br>&rsquo;.<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">origin: origin formset: formset currentcharacter: currentcharacter<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["initilization of a Heading (used in copy)"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[formset is: Integer⇒ [ formset &larr; FormSet new fromstyle:<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">DefaultTextStyle styleindex: formset.]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self origin: origin extent: (200⌾formset height).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">origin: origin index: index charactercodes: charactercodes<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold small">currentcharacter: currentcharacter | char w delta<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["initilization of a Heading (used in copy)"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">formset &larr; FormSet new fromstyle:<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">DefaultTextStyle styleindex: index.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ nil ≡ charactercodes ⇒ [ charactercodes &larr; Set new default]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self origin: origin extent: (200⌾formset height).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">w &larr; 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">delta &larr; origin copy.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self translate: (0⌾0 - delta).</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ char from: charactercodes do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">char &larr; formset asForm: char.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self addpath: w⌾0 andform: char.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">w &larr; w + char width.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self translate: delta.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ self<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold large"><br>EDIT</span></div>
<div class="line left">
<span class="bold small">down | delta<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["move the current character down one bit."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self boxcomp.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(self◦currentcharacter) translate: (0⌾1).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">delta &larr; origin copy.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self translate: (0⌾0 - delta) ; resize ; translate: delta.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self white ; display: 1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self boxcomp.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">edit: parentimage </span><span class="small">| pt <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["Simple Heading (line) editor for now."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self display: 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">until⦂ 1=2 do⦂ "forever for now"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user kbck⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ self typein ]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user yellowbug ⇒</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">headingmenu bug<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=1⇒</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self right]; "move current character right one bit"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=2⇒</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self left]; "move current character left one bit"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=3⇒</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self up]; "move current character up one bit"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=4⇒</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self down]; "move current character down one bit"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">=5⇒</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self newfont] "change fonts"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user redbug ⇒ </span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[(rectangle has: (pt&larr; user mp))⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[pt &larr; pt - (rectangle origin).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">currentcharacter&larr; self indexofsubimageat: pt.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">currentcharacter⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self◦currentcharacter displayat: self origin<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">effect: 2 clippedBy: user screenrect.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self◦currentcharacter displayat: self origin<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">effect: 2 clippedBy: user screenrect.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ self<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user bluebug ⇒ </span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ self.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">] "exit back to the parentimage" <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">left | i delta<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["move the current character and all those to the right of it to the left one bit."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self boxcomp.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i from: (currentcharacter to: self length) do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ (self◦i) translate: (0⌾0) -(1⌾0) ].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">delta &larr; origin copy.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self translate: (0⌾0 - delta) ; resize ; translate: delta.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self white ; display: 1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self boxcomp.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">newfont </span><span class="small">| w char charcount delta i<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">index &larr;(user request: &rsquo;index of new font . .  &rsquo; ) asInteger.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">formset &larr; FormSet new fromstyle: DefaultTextStyle styleindex: index.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self white.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: position do⦂ [ self◦i &larr; nil ].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">position &larr; 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">w &larr; 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">charcount &larr; 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">delta &larr; origin copy.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self translate: (0⌾0 - delta).</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ char from: charactercodes do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[nil≡ char ⇒ []<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">char &larr; formset asForm: char.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">char displayat: delta+ (w⌾0) effect: 0 clippedBy: user screenrect.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self addpath: w⌾0 andform: char.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">w &larr; w + char width.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">charcount &larr; charcount+1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self resize.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self translate: delta.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ self<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">right | i delta<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["move the current character and all those to the right of it to the right one bit."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self boxcomp.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i from: (currentcharacter to: self length) do⦂ [ (self◦i) translate: (1⌾0) ].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">delta &larr; origin copy.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self translate: (0⌾0 - delta) ; resize ; translate: delta.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self white ; display: 1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self boxcomp.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">typein </span><span class="small">| w char charcount delta i<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self white.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: position do⦂ [ self◦i &larr; nil ].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">position &larr; 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">w &larr; 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">charcount &larr; 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">charactercodes &larr; Set new default.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">delta &larr; origin copy.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self translate: (0⌾0 - delta).</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">until⦂ (char &larr; user kbd) = 13 do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(char = 8) ⇒"back space" <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[charcount ≠  0 ⇒ [ <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> </span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">w &larr; w - ( (self◦charcount) width).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(self◦charcount) white.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self deleteimage: charcount.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">charactercodes deleteI: charcount.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">charcount &larr; charcount -1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">charactercodes add: char.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">char &larr; formset asForm: char.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">char displayat: delta+ (w⌾0) effect: 0 clippedBy: user screenrect.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self addpath: w⌾0 andform: char.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">w &larr; w + char width.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">charcount &larr; charcount+1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self resize.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self translate: delta.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ self<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">up | delta<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["move the current character up one bit."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self boxcomp.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(self◦currentcharacter) translate: (0⌾0) - (0⌾1).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">delta &larr; origin copy.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self translate: (0⌾0 - delta) ; resize ; translate: delta.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self white ; display: 1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self boxcomp.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold large"><br>SYSTEM</span></div>
<div class="line left">
<span class="bold small">copy </span><span class="small">| h i<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">h&larr; Heading new origin: (rectangle origin) copy index: index charactercodes: (charactercodes copy)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">currentcharacter: currentcharacter copy.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">h rectangle: rectangle copy.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: self length do⦂ <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">h add: (self◦i) copy <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ h<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">fromPress: press value:  s </span><span class="small">| numberofcharacters  i <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["retrieves and builds an instance of class Heading from a press file"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">numberofcharacters&larr; s nextword.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">origin &larr; s nextPoint.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">index &larr; s nextword.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">charactercodes &larr; Set new default.<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: numberofcharacters do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ charactercodes add: s nextword ]</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ self origin: origin index: index charactercodes: charactercodes<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">currentcharacter: 1<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">hideData: complete </span><span class="small">| s i<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["stores an instance of class Heading on a press file"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s &larr; Stream new of: (String new: 100).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s nextword&larr; self length; "number of characters"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nextPoint&larr; origin;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nextword &larr; index.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: self length do⦂ [s nextword &larr; charactercodes◦i].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ s contents]</span></div>
<div class="line left">
<span class="bold small">pressCode </span><span class="small">[⇑2]</span></div>
<div class="line left">
<span class="bold small">presson: press in: r </span><span class="small">| hs y t i pressscale [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(hs  &larr; press scale*self height) &gt; r height⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"not enough room left on current page.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">assume for now that it will at least fit on an entire page"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ self]<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self hidePress: press complete: ¬1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pressscale &larr; press scale.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">press selectfont: (press fontindex: 16*index style: DefaultTextStyle) - 1.<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: self length  do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">press setx:  r leftside + ((self◦i) leftside*pressscale).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">press sety: r bottom - ((self◦i) top*pressscale).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">press showchar: (charactercodes◦i)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ r bottom - ((self height)*pressscale)]</span></div>
<div class="line left">
<span class="bold small">printon: strm </span><span class="small">| t [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">strm append: &rsquo;a Heading &rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪Heading under: &rsquo;FPI Packages&rsquo;.</span></div>
<div class="line left">
<span class="small">Heading classInit</span></div>
    <div class="line left">
<span class="small">&rsquo;From Smalltalk 5.5k XM November 24 on 22 November 1980 at 2:57:08 am.&rsquo;<br></span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large">"JuniperFileController"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;JuniperFileController&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: File<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fLongFileHandle<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fShortFileHandle<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;&rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">sharing: gJuniperConstants;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>JUNIPER FILE CONTROLLER</span></div>
<div class="line left">
<span class="bold large"><br>DOCUMENTATION</span></div>
<div class="line left">
<span class="bold small">implementationNotes<br></span><span class="small">[<br>"<br>FIELDS<br></span><span class="bold small">fLongFileHandle</span><span class="small"> : a LongInteger representing the unique identifier for the file.<br></span><span class="bold small">fShortFileHandle</span><span class="small"> : an Integer representing the identifier for the file during a particular transaction.<br>"<br>]</span></div>
<div class="line left">
<span class="bold large"><br>FILE REDEFINITIONS (restricted)</span></div>
<div class="line left">
<span class="bold small">allocatePage<br></span><span class="small">"...returns a new packet (Pacbuf) to be used as the data buffer in a JuniperPageBuffer."</span><span class="bold small"><br></span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ ((self interface) newPacket)<br>]</span></div>
<div class="line left">
<span class="bold small">close<br></span><span class="small">"...closes the file on the Juniper file system."</span><span class="bold small"><br></span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self doAction: sCloseFile requestPrs: nil.<br>]</span></div>
<div class="line left">
<span class="bold small">endFile: pPageBuffer<br></span><span class="small">"...adjusts the file length, writes pPageBuffer (a JuniperPageBuffer) on the file, and returns pPageBuffer."<br>[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self length: ( ((pPageBuffer pageNumber)-1)*(pPageBuffer dataLength)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">+ pPageBuffer length<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> ).  "1"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self writePage: pPageBuffer.  "2"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ pPageBuffer<br>]<br>"<br>1. Set the file length to the total number of bytes in the file.<br>2. Write the page on Juniper.<br>"</span></div>
<div class="line left">
<span class="bold small">entryClass<br></span><span class="small">"...returns the class of objects managed by JuniperFileController objects."</span><span class="bold small"><br></span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ JuniperPageBuffer<br>]</span></div>
<div class="line left">
<span class="bold small">Get: pPageBuffer<br></span><span class="small">"...reads the data from the page whose number is that specified by pPageBuffer (a JuniperPageBuffer) if such a page exists.  Otherwise pPageBuffer should contains data to be written on the file at the appropriate place."</span><span class="bold small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">| tNextPageNumber tNewPageNumber i<br>[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">tNewPageNumber &larr; pPageBuffer pageNumber.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">tNewPageNumber ≤ lastpn and⦂ (<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">lastpn &gt; 1 or⦂ self length &gt; 0)⇒ [ ⇑ (self Read: pPageBuffer) ]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">tNextPageNumber &larr; lastpn + 1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ tNewPageNumber = tNextPageNumber ⇒ [ ]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self length: (tNewPageNumber-1) * (pPageBuffer dataLength).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i from: tNextPageNumber to: (tNewPageNumber-1) do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ pPageBuffer pageNumber: i.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pPageBuffer &larr; self writePage: pPageBuffer.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">].<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pPageBuffer pageNumber: tNewPageNumber.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pPageBuffer length: 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ pPageBuffer<br>]</span></div>
<div class="line left">
<span class="bold small">lastFullPage </span><span class="small">[⇑self length / self entryClass new dataLength]</span></div>
<div class="line left">
<span class="bold small">length<br></span><span class="small">"...returns the number of bytes (an Integer) in the file."</span><span class="bold small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">| tResult</span><span class="bold small"><br></span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">tResult &larr; self doAction: sReadLength requestPrs: nil.  "1"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ (tResult longInteger: 1)  "2"<br>]<br>"<br>1. Issue a &rsquo;read length&rsquo; command to Juniper.<br>2. Return the length from the result parameter block.<br>"</span></div>
<div class="line left">
<span class="bold small">length: pLength<br></span><span class="small">"...sets the number of bytes in the file to the integer pLength (an Integer)."</span><span class="bold small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">| tRequest</span><span class="bold small"><br></span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">tRequest &larr; self newRequestParameterBlock.  "1"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">tRequest longInteger: 1 &larr; pLength.  "2"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self doAction: sSetLength requestPrs: tRequest.  "3"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">lastpn &larr; self pageFrom: pLength.  "4"<br>]<br>"<br>1. Create a new request parameter block.<br>2. Set the length parameter to pLength.<br>3. Issue a &rsquo;set length&rsquo; command to Juniper.<br>4. Determine the number of the last page of the file and assign it to the superClass field lastpn.<br>"</span></div>
<div class="line left">
<span class="bold small">open<br></span><span class="small">"...opens the file on the Juniper file system."</span><span class="bold small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">| tRequest tResult<br>[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">tRequest &larr; self newRequestParameterBlock.  "1"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">tRequest nextDataBlockString &larr; fLongFileHandle.  "2"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">tResult &larr; (self interface) doAction: sOpenFile requestPrs: tRequest.  "3"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">fShortFileHandle &larr; tResult parameter: 1.  "4"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self findLastPage.  "5"<br>]<br>"<br>1. Create a new request parameter block.<br>2. Set the long file handle parameter.<br>3. Issue an &rsquo;open file&rsquo; command to Juniper.<br>4. Set the superClass field serialNumber to the short file handle returned by Juniper in the result parameter block.<br>5. Set the number of the last page of the file.<br>"</span></div>
<div class="line left">
<span class="bold small">Read: pPageBuffer<br></span><span class="small">"...returns false if the page number of pPageBuffer (a JuniperPageBuffer) is greater than the page number of the last page of the file; otherwise, the data for that page is read from the Juniper file system into the packet of pPageBuffer."</span><span class="bold small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">| tRequest tResult pn</span><span class="bold small"><br></span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ (pn &larr; pPageBuffer pageNumber) &gt; lastpn  ⇒  [ ⇑ false ]  "1"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">lastpn=1 and⦂ self empty⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pPageBuffer length: 0. "⇑ self Get: pPageBuffer" ]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">tRequest &larr; self newRequestParameterBlock.  "2"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">tRequest parameter: 1 &larr; (pn - 1).  "3"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">tResult &larr; self doAction: sReadPage requestPrs: tRequest.  "4"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pPageBuffer page: (tResult packet).  "5"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pPageBuffer length: (tResult parameter: 1).  "6"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ pPageBuffer  "7"<br>]<br>"<br>1. Return false if the page number of pPageBuffer is greater than that of the last page of the file.<br>2. Create a new request parameter block.<br>3. Set the page number parameter to that of pPageBuffer less 1.  Juniper page numbers start at 0.<br>4. Issue a &rsquo;read page&rsquo; request.<br>5. Set the pPageBuffer packet to that of the result parameter block.<br>6. Set the length of pPageBuffer to that returned in the result parameter block.<br>7. Return pPageBuffer modified.<br>"</span></div>
<div class="line left">
<span class="bold small">Write: pPageBuffer<br></span><span class="small">"...adjusts the length of the file if pPageBuffer is the last page, sends the data buffered in pPageBuffer (a JuniperPageBuffer) to the Juniper file system, and returns pPageBuffer."</span><span class="bold small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">| tPageNumber<br>[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">tPageNumber &larr; pPageBuffer pageNumber.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ tPageNumber &lt; lastpn ⇒ [ ]  "1"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ tPageNumber &gt; (lastpn+1) ⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ ⇑ self error: &rsquo;invalid page number&rsquo; ]  "2"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self length:<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">( (tPageNumber-1)*(pPageBuffer dataLength)+(pPageBuffer length)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">).  "3"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self writePage: pPageBuffer.  "4"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ pPageBuffer  "5"<br>]<br>"<br>1. If the page number of pPageBuffer is less than the last page number of the file, do not readjust the file length.<br>2. If the page number of pPageBuffer is greater than the next available page number for the file, invoke error handling.<br>3. If pPageBuffer is the last page of the file or will immediately follow the last page of the file, adjust the file length.<br>4. Send the data to Juniper.<br>5. Return pPageBuffer unmodified.<br>"</span></div>
<div class="line left">
<span class="bold small">writePage: pPageBuffer<br></span><span class="small">"...sends the data buffered in pPageBuffer (a JuniperPageBuffer) to the Juniper file system provided the buffer is not empty."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">| tRequest<br>[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ (pPageBuffer length = 0) ⇒ [ ]  "1"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">tRequest &larr; JuniperRequestParameterBlock new.  "2"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">tRequest<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">packet &larr; pPageBuffer page;  "3"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">leader: 1 &larr; 0;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">leader: 2 &larr; 0;  "4"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">parameter: 1 &larr; ((pPageBuffer pageNumber) - 1).  "5"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self doAction: sWritePage requestPrs: tRequest.  "6"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">].<br>]<br>"<br>1. If there is no data in pPageBuffer do nothing.<br>2. Create a new request parameter block.<br>3. Set the packet to that of pPageBuffer.  This contains the data to be written on the Juniper file.<br>4. Set the authentication key and reserved word to 0.<br>5. Set the page number parameter to that of pPageBuffer less 1.  Juniper page numbers start at 0.<br>6. Issue a &rsquo;write page&rsquo; request.<br>"</span></div>
<div class="line left">
<span class="bold large"><br>MISC (internal)</span></div>
<div class="line left">
<span class="bold small">doAction: pAction requestPrs: pRequest<br></span><span class="small">"...the specified request, pAction, (selected from gJuniperConstants) with its corresponding request parameter block, pRequest ( a JuniperRequestParameter Block), is issued to the Juniper file server (through the file interface).  If no errors are found, a JuniperResultParameterBlock is returned; otherwise, error handling is invoked.  If no request parameters are required, pRequest can be specified as nil."</span><span class="bold small"><br></span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ pRequest ≡ nil ⇒ [ pRequest &larr; self newRequestParameterBlock. ]  "1"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pRequest shortFileHandle &larr; fShortFileHandle.  "2"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ ((self interface) doAction: pAction requestPrs: pRequest)  "3"<br>]<br>"<br>1. Create a new request parameter block if one is not specified.<br>2. Set the short file handle parameter.<br>3. Issue the request to the Juniper interface and return the result parameter block.<br>"</span></div>
<div class="line left">
<span class="bold small">interface<br></span><span class="small">"...returns the JuniperInterface controlling the file."</span><span class="bold small"><br></span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ directory<br>]</span></div>
<div class="line left">
<span class="bold small">longFileHandle: pLongFileHandle<br></span><span class="small">"...sets the file&rsquo;s long file handle."</span><span class="bold small"><br></span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">fLongFileHandle &larr; pLongFileHandle.<br>]</span></div>
<div class="line left">
<span class="bold small">newRequestParameterBlock<br></span><span class="small">"...initializes and returns a new JuniperRequestParameterBlock."</span><span class="bold small"><br></span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ ((self interface) newRequestParameterBlock)<br>]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪JuniperFileController under: &rsquo;Juniper&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"JuniperInterface"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;JuniperInterface&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: FileDirectory<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo; <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fName<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fPassword<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fDefaultDirectory<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fJuniperSocket<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fTimer<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fExceptionHandler<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fSpecialError<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fOpenIndicator<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;&rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">sharing: gJuniperConstants;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>JUNIPER INTERFACE</span></div>
<div class="line left">
<span class="bold large"><br>DOCUMENTATION</span></div>
<div class="line left">
<span class="bold small">implementationNotes<br></span><span class="small">[<br>"<br>FIELDS<br></span><span class="bold small">fName </span><span class="small">:</span><span class="bold small"> </span><span class="small">a String representing the name of an account on the Juniper file system.<br></span><span class="bold small">fPassword </span><span class="small">: a String representing the password of the same account.<br></span><span class="bold small">fDefaultDirectory</span><span class="small"> : a String representing the directory to be used as the default if one is not specified as part of a file name.<br></span><span class="bold small">fJuniperSocket</span><span class="small"> : a JuniperSocket used to interface to the etherWorld mechanism.<br></span><span class="bold small">fTimer</span><span class="small"> : a Timer used to periodically send noop commands when the interface is open to prevent timeout.<br></span><span class="bold small">fExceptionHandler</span><span class="small"> : an ExceptionHandler to invoke when a transaction is aborted.<br></span><span class="bold small">fSpecialError</span><span class="small"> : an error code to ignore on a command request.<br></span><span class="bold small">fOpenIndicator</span><span class="small"> : the interface status: true means open; nil means not open.<br>"<br>]</span></div>
<div class="line left">
<span class="bold large"><br>USER CALLABLE</span></div>
<div class="line left">
<span class="bold small">close<br></span><span class="small">"...ends the current transaction and closes the interface."</span><span class="bold small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">|  tResult</span><span class="bold small"><br></span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ fOpenIndicator ≡ nil ⇒ [ ]  "1"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">tResult &larr; self doAction: sLogout requestPrs: nil.  "2"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">cr;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">show: (tResult nextDataBlockString).  "3"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">super close.  "4"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">].<br>]<br>"<br>1. If the interface is not open, do nothing.<br>2. Issue a logout command.<br>3. Display the logout message returned by Juniper.<br>4. delete self from externalViews, Release timers, fields, etc.<br>"</span></div>
<div class="line left">
<span class="bold small">closeTransaction<br></span><span class="small">"...closes the current transaction leaving the user logged in with all open files still open, and all read and write locks still in effect."</span><span class="bold small"><br></span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self doAction: sCloseTransaction requestPrs: nil.<br>]</span></div>
<div class="line left">
<span class="bold small">directory: pDirectory<br></span><span class="small">"...specifies the directory name to be added to any file name that does not begin with a directory name."</span><span class="bold small"><br></span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">fDefaultDirectory &larr; pDirectory.<br>]</span></div>
<div class="line left">
<span class="bold small">exceptionHandler: pExceptionHandler<br></span><span class="small">"...specifies an exception handler to be invoked if any subsequent request discovers that the expected transaction has been closed.  If no exception handler is set, a notify window is displayed."</span><span class="bold small"><br></span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">fExceptionHandler &larr; pExceptionHandler.<br>]</span></div>
<div class="line left">
<span class="bold small">name: pName password: pPassword<br></span><span class="small">"...specifies the name and password of an account on the Juniper file system.  This account will be logged into whenever the interface is opened."</span><span class="bold small"><br></span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">fName &larr; pName.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">fPassword &larr; pPassword.<br>]</span></div>
<div class="line left">
<span class="bold small">obsolete </span><span class="small">[⇑fOpenIndicator ≡ nil]</span></div>
<div class="line left">
<span class="bold small">open<br></span><span class="small">"...opens the interface allowing access to files on the Juniper file system.  A new transaction is started."</span><span class="bold small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">| tResult</span><span class="bold small"><br></span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ fOpenIndicator ≡ true  ⇒ [ ]  "1"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">E wakeup.  "2"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self release.  "3"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">fJuniperSocket &larr; JuniperSocket new hostName: self server.  "4"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">tResult &larr; self login: (self userName) password: (self userPassword).  "5"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">cr;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">show: (tResult nextDataBlockString).  "6"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self timerOn.  "7"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">super open.  "8"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">fOpenIndicator &larr; true.  "9"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">].<br>]<br>"<br>1. If the interface is already open, do nothing.<br>2. Make sure that the EtherWorld mechanism is in a valid state.<br>3. Release the interface to insure a valid initial state.  (An invalid state can occur from  an error on some statement in a previous invocation of &rsquo;open&rsquo;).<br>4. Create and initialize a JuniperSocket (parameterize server name?).<br>5. Issue a login command.<br>6. Display the login message that is returned by Juniper.<br>7. Turn on a timer to issue periodic noop commands to prevent timeout.<br>8. Do predefined open operations.<br>9. Set the interface status to &rsquo;open&rsquo;.<br>"</span></div>
<div class="line left">
<span class="bold small">release<br></span><span class="small">"...leaves the interface in a valid state after an error."<br>[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">fOpenIndicator &larr; nil.  "1"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self timerOff.  "2"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ fJuniperSocket ≡ nil ⇒ [ ]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">fJuniperSocket close.  "3"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">fJuniperSocket &larr; nil.  "4"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">].<br>]<br>"<br>1. Set the interface status to &rsquo;not open&rsquo;.<br>2. Turn off the timer.<br>3. Close the JuniperSocket if it exists.<br>4. Release the JuniperSocket field.<br>"</span></div>
<div class="line left">
<span class="bold small">versionNumbers </span><span class="small">[⇑true]</span></div>
<div class="line left">
<span class="bold large"><br>FILE DIRECTORY (restricted)</span></div>
<div class="line left">
<span class="bold small">Delete: pFile<br></span><span class="small">"...deletes from the Juniper file system the file whose file name is specified by pFile (a JuniperFileController)."</span><span class="bold small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">| tRequest</span><span class="bold small"><br></span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">tRequest &larr; self newRequestParameterBlock.  "1"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">tRequest nextDataBlockString &larr; (self checkDirectory: (pFile name)).  "2"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self doAction: sDestroyFile requestPrs: tRequest.  "3"<br>]<br>"<br>1. Create a new request parameter block.<br>2. Get the file name from pFile, add the default directory name to it if necessary, and write it in the request parameter block.<br>3. Issue a &rsquo;destroy file&rsquo; request.<br>"</span></div>
<div class="line left">
<span class="bold small">entryClass<br></span><span class="small">"...returns the file class handled by the JuniperInterface."</span><span class="bold small"><br></span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ JuniperFileController<br>]</span></div>
<div class="line left">
<span class="bold small">Find: pFile<br></span><span class="small">"...sends a &rsquo;look up file&rsquo; request to the Juniper file server.  If the file is found, its name and long file handle are set in pFile (a JuniperFileController). Otherwise false is returned."</span><span class="bold small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">| tRequest tResult</span><span class="bold small"><br></span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">fSpecialError &larr; sFileNotFound.  "1"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">tRequest &larr; self newRequestParameterBlock.  "2"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">tRequest nextDataBlockString &larr; (self checkDirectory: (pFile name)).  "3"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">tResult &larr; self doAction: sLookupFile requestPrs: tRequest.  "4"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ fSpecialError ≡ true ⇒ [ fSpecialError &larr; nil.  ⇑ false ]  "5"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">fSpecialError &larr; nil.  "6"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pFile<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">longFileHandle: tResult nextDataBlockString;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">name: tResult nextDataBlockString.  "7"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">].<br>]<br>"<br>1. Set the error handling mechanism to ignore a &rsquo;file not found&rsquo; error.<br>2. Create a new request parameter block.<br>3. Get the file name from pFile, add the default directory name to it if necessary, and write it in the request parameter block.<br>4. Issue a &rsquo;look up file&rsquo; request and get the result parameter block.<br>5. If a &rsquo;file not found&rsquo; error was encountered, reset the error handling mechanism and return false.<br>6. (no error encountered) Reset the error handling mechanism.<br>7. Set the long file handle and name (from the result parameter block) in pFile.<br>"</span></div>
<div class="line left">
<span class="bold small">Insert: pFile<br></span><span class="small">"...issues a &rsquo;create file&rsquo; request to the Juniper file server and sets the returned long file handle and name in pFile (a JuniperFileController)."</span><span class="bold small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">| tRequest tResult</span><span class="bold small"><br></span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">tRequest &larr; self newRequestParameterBlock.  "1"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">tRequest longInteger: 2 &larr; 0 "user rawtotalsecs".  "1.5"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">tRequest nextDataBlockString &larr; (self checkDirectory: (pFile name)).  "2"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">tRequest nextDataBlockString &larr; &rsquo;&rsquo;.  "3"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">tResult &larr; self doAction: sCreateFile requestPrs: tRequest.  "4"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pFile<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">longFileHandle: tResult nextDataBlockString;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">name: tResult nextDataBlockString.  "5"<br>]<br>"<br>1. Create a new request parameter block.<br>1.5 Set creation date (to default (current) -- later some specific date&time?)<br>2. Get the file name from pFile, add the default directory name to it if necessary, and write it in the request parameter block.<br>3. Blank the file server field of the request parameter block.<br>4. Issue a &rsquo;create file&rsquo; request and get the result parameter block.<br>5. Set the long file handle and name (from the result parameter block) in pFile.<br>" </span></div>
<div class="line left">
<span class="bold small">Match: entries to: strm </span><span class="small">| entry pat ents name i p lastname [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"search for Files matching patterns"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ pat from: entries do⦂ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">name &larr; self checkDirectory: pat name.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">i &larr; name find: &rsquo;*&rsquo;◦1. p &larr; name find: &rsquo;#&rsquo;◦1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">i &larr; [p=0⇒ [i] i=0⇒ [p] i min: p].<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">i=0⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(self Find: pat)⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"exact name found"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">strm next &larr; pat]]<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"pattern match over range of first to last possible matches"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pat &larr; self makeEntry: name.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">entry &larr; self makeEntry: (name copy: 1 to: i-1).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">lastname &larr; name copy: 1 to: i.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">lastname◦i &larr; 0377.<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">while⦂ ((entry &larr; self nextFile: entry) and⦂ entry name &lt; lastname) do⦂ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pat match: entry⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">strm next &larr; entry.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"copy entry since nextFile smashes into it"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">entry &larr; self makeEntry: entry name]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]]</span></div>
<div class="line left">
<span class="bold small">nextFile: pFile<br></span><span class="small">"same as LookupFile (Find:), but it pertains to the file whose name is lexically next after the fileName specified in the request.  If the file is found, its name and long file handle are set in pFile (a JuniperFileController). Otherwise (no next file) false is returned."</span><span class="bold small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">| tRequest tResult</span><span class="bold small"><br></span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">fSpecialError &larr; sFileNotFound.  "1"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">tRequest &larr; self newRequestParameterBlock.  "2"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">tRequest nextDataBlockString &larr; (self checkDirectory: (pFile name)).  "3"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">tResult &larr; self doAction: sNextFile requestPrs: tRequest.  "4"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ fSpecialError ≡ true ⇒ [ fSpecialError &larr; nil.  ⇑ false ]  "5"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">fSpecialError &larr; nil.  "6"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pFile<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">longFileHandle: tResult nextDataBlockString;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">name: tResult nextDataBlockString.  "7"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑pFile<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">].<br>]</span></div>
<div class="line left">
<span class="bold small">Rename: oldFile from: newFile<br></span><span class="small">"renames a file on Juniper"</span><span class="bold small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">| tRequest newName</span><span class="bold small"><br></span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">tRequest &larr; self newRequestParameterBlock.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">tRequest nextDataBlockString &larr; oldFile name.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">tRequest nextDataBlockString &larr; (newName &larr; self checkDirectory: newFile name).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self doAction: sRenameFile requestPrs: tRequest.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">oldFile name: newName.<br>]</span></div>
<div class="line left">
<span class="bold small">server </span><span class="small">["should be an instance variable?" ⇑&rsquo;Juniper&rsquo;]</span></div>
<div class="line left">
<span class="bold large"><br>JUNIPER COMMAND INTERFACE (restricted)</span></div>
<div class="line left">
<span class="bold small">checkResult: pResult<br></span><span class="small">"...is sent by doAction and doLogin to check the result of a Juniper request.  pResult is a result parameter block (JuniperResultParameterBlock) containing the packet (Pacbuf) returned as a result of the request."</span><span class="bold small"><br></span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ ((pResult packet) ≡ false or⦂ pResult pupType = 4) or⦂ (pResult resultCode = sCommandNak and⦂ (pResult parameter: 1) = sTransactionAborting) ⇒  "3"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ [ fExceptionHandler ≡ nil ⇒ [ ]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">fExceptionHandler trap.  "4"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">  ].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self error: &rsquo;No Juniper Transaction&rsquo;.  "5"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ (pResult resultCode)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">= sCommandAck ⇒ [ ⇑ true ];  "6"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">= sCommandNak ⇒  "7"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ self checkRetry: (pResult parameter: 1) ⇒ [ ⇑ false ]  "8"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ (pResult parameter: 1) = fSpecialError ⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ fSpecialError &larr; true.  ⇑ true ]  "9"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self error: (pResult nextDataBlockString).  "10"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ true  "11"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">].<br>]<br>"<br>1. JuniperSocket sendRequest: and sendLogin: return false if no response is received from Juniper.<br>2. Invoke error handling if there is no response from Juniper.<br>3. Juniper returns an error pup (packet pup type  = 4) if the transaction has been aborted.<br>4. If the transaction has been aborted and there is an exception handler, then trap to the handler.<br>5. Invoke error handling if control is returned or if there is no exception handler.<br>6. Return true if a &rsquo;command acknowledged&rsquo; was returned (this means success with no result parameters).<br>7. If a &rsquo;command not acknowledged&rsquo; was returned,  an error condition exists.<br>8. Check for a retryable error and return false if so.<br>9. If the error is the same as that specified in the special error indicator, then indicate it and return true.<br>10. If not, invoke error handling.<br>11. Return true if a &rsquo;command not acknowledged&rsquo; was not returned (this means success with result parameters).<br>"</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: justify">
<span class="bold small">checkRetry: pErrorCode<br></span><span class="small">"...is sent by checkResult to test for a retryable error.  Returns true if so; false otherwise."</span><span class="bold small"><br></span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ pErrorCode<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">= sSequenceNumberGap ⇒ [ ⇑ true ];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">= sRecoveryUnderWay ⇒ [ ⇑ true ];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">= sTransactionClosing ⇒ [ ⇑ true ];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">= sCongestion ⇒ [ ⇑ true ]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ false<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">].<br>]</span></div>
<div class="line left">
<span class="bold small">doAction: pAction requestPrs: pRequest<br></span><span class="small">"...corresponds to the Pine Protocol function.  The specified request, pAction, (selected from gJuniperConstants) with its corresponding request parameter block, pRequest (a JuniperRequestParameterBlock), is issued to the Juniper file server (through JuniperSocket sendRequest:). A packet is returned and inserted into a result parameter block and checked for error conditions.  If no errors are found, the result parameter block (a JuniperResultParameterBlock) is returned; otherwise, error handling is invoked.  If no request parameters are required, pRequest can be specified as nil."</span><span class="bold small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">| tResult</span><span class="bold small"><br></span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ fOpenIndicator ≡ nil ⇒ [ self open. ]  "1"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ pRequest ≡ nil ⇒ [ pRequest &larr; self newRequestParameterBlock. ]  "2"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">fTimer disable.  "3"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pRequest opcode &larr; pAction.  "4"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pRequest pupType &larr; sRequest.  "5"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">tResult &larr; JuniperResultParameterBlock new.  "6"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">tResult packet &larr; (fJuniperSocket sendRequest: (pRequest packet)).  "7"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">fTimer reset.  "8"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ self checkResult: tResult ⇒ [ ⇑ tResult ]  "9"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ (self doAction: pAction requestPrs: pRequest)  "10"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">].<br>]<br>"<br>1. Make sure the JuniperInterface is open.<br>2. Create a request parameter block if none was specified.<br>3. Disable the timer to insure that a noop command is not sent while the current request is in progress.<br>4. Set the command code in the packet.<br>5. Set the packet pup type to &rsquo;request&rsquo;.<br>6. Create a result parameter block.<br>7. Send the request to the JuniperSocket with the packet from the request parameter block; set the result packet in the result parameter block.<br>8. Reset the timer.<br>9. Check the result; if valid, return it.<br>10. If false is returned, then a retryable error was encountered so retry the command.<br>" </span></div>
<div class="line left">
<span class="bold small">doLogin: pRequest<br></span><span class="small">"...is sent by login:password: with pRequest (a JuniperRequestParameter Block) set.  doLogin: issues a login request, checks for errors, and retries if necessary.  If no error occurs, a JuniperResultParameterBlock is returned; otherwise, error handling is invoked."</span><span class="bold small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">| tResult<br>[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">tResult &larr; JuniperResultParameterBlock new.  "1"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">tResult packet &larr; (fJuniperSocket sendLogin: (pRequest packet)).  "2"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ self checkResult: tResult ⇒ [ ⇑ tResult ]  "3"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ (self doLogin: pRequest)  "4"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">].<br>]<br>"<br>1. Create a new result parameter block.<br>2. Issue a login request and set the result packet in the result parameter block.<br>3. Check the result and return it if there is no error.<br>4. Retry the request if there is a retryable error.<br>"</span></div>
<div class="line left">
<span class="bold small">error:  pMessage<br></span><span class="small">"...is sent by checkResult if an error is encountered on a Juniper request.  (pMessage is a String containing an appropriate error message.)  The error message is formed and a notify window is displayed."</span><span class="bold small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">| tMessage<br>[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">tMessage &larr; Stream default.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">tMessage append: pMessage.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">super error: (tMessage contents).<br>]</span></div>
<div class="line left">
<span class="bold small">newPacket<br></span><span class="small">"...returns a new packet (Pacbuf) from the JuniperSocket."</span><span class="bold small"><br></span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ fJuniperSocket ≡ nil ⇒ [ self open. ]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ (fJuniperSocket freePacket)<br>]</span></div>
<div class="line left">
<span class="bold small">newRequestParameterBlock<br></span><span class="small">"...initializes and returns a new JuniperRequestParameterBlock."</span><span class="bold small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">| tRequestParameterBlock</span><span class="bold small"><br></span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ fJuniperSocket ≡ nil ⇒ [ self open. ]  "1"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">tRequestParameterBlock &larr; JuniperRequestParameterBlock new.  "2"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">tRequestParameterBlock<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">packet &larr; (fJuniperSocket freePacket);  "3"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">dataBlockLength &larr; 0;  "4"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">leader: 1 &larr; 0;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">leader: 2 &larr; 0.  "5"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ tRequestParameterBlock  "6"<br>]<br>"<br>1. Open the interface if it is not already.<br>2. Create a new request parameter block.<br>3. Create a new packet and set it in the request parameter block.<br>4. Set the data block length to 0.<br>5. Set the authentication key and reserved word to 0.<br>6. Return the initialized request parameter block.<br>"</span></div>
<div class="line left">
<span class="bold large"><br>TIMER (internal)</span></div>
<div class="line left">
<span class="bold small">noOp</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold small"><br></span><span class="small">"...sends a noop command to the Juniper file server.  It&rsquo;s only effect is to reset the timout mechanism of the server."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">| tPacket<br>[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">tPacket &larr; fJuniperSocket freePacket.  "1"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">tPacket pupType &larr; sNoop.  "2"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">tPacket dataString &larr; &rsquo;&rsquo;.  "3"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">fJuniperSocket setAddressesAndComplete: tPacket; timerOff.  "4"<br>]<br>"<br>1. Get a new packet (Pacbuf).<br>2. Set packet pup type to &rsquo;noop&rsquo;.<br>3. Set the dataString to the empty string.  This has the necessary effect of setting the packet length to 0.<br>4. Send the packet.  It is necessary to bypass the normal JuniperSocket interface (sendRequest:) because no acknowledgement is returned for the noop.<br>"</span></div>
<div class="line left">
<span class="bold small">timerOff<br></span><span class="small">"...disables fTimer and sets it to nil."<br>[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ fTimer ≡ nil ⇒ [ ]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">fTimer disable.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">fTimer &larr; nil.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">].<br>]</span></div>
<div class="line left">
<span class="bold small">timerOn<br></span><span class="small">"...assigns fTimer to a new timer object that wakes up every 100 seconds (6000 1/60 seconds) and issues a &rsquo;noop&rsquo; command to Juniper.  This  is used to prevent Juniper from timing out during periods of inactivity."<br>[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self timerOff.  "1"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">fTimer &larr; Timer new.  "2"  <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">fTimer for: 6000 action⦂ [ self noOp.  user show: &rsquo;.&rsquo;.  fTimer reset. ].  "3"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user cr.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">fTimer reset.  "4"<br>]<br>"<br>1. Make sure that the current timer is released.<br>2. Create a new timer.<br>3. Set the timer interval to 100 seconds.  The action of the timer is to send a noop, show a dot in the dispFrame, and reset.<br>4. Activate the timer.<br>" </span></div>
<div class="line left">
<span class="bold large"><br>MISC (internal)</span></div>
<div class="line left">
<span class="bold small">checkDirectory: pFileName </span><span class="small">| ps </span><span class="bold small"><br></span><span class="small">"...returns a string that has the default directory name added to the beginning of pFileName (a String) unless pFileName already begins with a directory name in which case it is returned unchanged. max length of ~58"</span><span class="bold small"><br></span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">ps &larr; (String new: 60) asStream.<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[pFileName length &gt; 0 and⦂ (pFileName◦1) = (&rsquo;&lt;&rsquo;◦1)⇒ []<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">ps append: &rsquo;&lt;&rsquo;; append: self directory; append: &rsquo;&gt;&rsquo;].<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">ps append: pFileName.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ps last = (&rsquo;.&rsquo;◦1)⇒ [ps skip: ¬1]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ps contents<br>]</span></div>
<div class="line left">
<span class="bold small">directory<br></span><span class="small">"...Returns a string specifying the default file name directory.  The default directory is fDefaultDirectory if it is not nil, otherwise it is self name"</span><span class="bold small"><br></span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ fDefaultDirectory ≡ nil ⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ ⇑ self userName<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ fDefaultDirectory<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">].<br>]</span></div>
<div class="line left">
<span class="bold small">hash: pString<br></span><span class="small">"...returns a hash value for pString (a String)."</span><span class="bold small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">| tHash1 tHash2 i<br>[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">tHash1 &larr; 0.  tHash2 &larr; 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i from: 1 to: (pString length) by: 2 do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ tHash1 &larr; tHash1 lxor: (UpperCase◦(pString◦i+1)).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">tHash2 &larr; tHash2 lxor:<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ i = (pString length) ⇒ [ 040 ]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">UpperCase◦(pString◦(i+1)+1)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ (tHash1*256 + tHash2)<br>]</span></div>
<div class="line left">
<span class="bold small">login: pName password: pPassword<br></span><span class="small">"...sets the necessary request parameters and invokes doLogin to issue a login request.  pName (a String) specifies the name of an account on the Juniper file system.  pPassword (a String) specifies the password of the account."</span><span class="bold small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">| tRequest</span><span class="bold small"><br></span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">tRequest &larr; self newRequestParameterBlock.  "1"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">tRequest<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">leader: 3 &larr; sLogin;  "2"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">leader: 4 &larr; 512;  "3"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">leader: 5 &larr; 7;  "4"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">leader: 6 &larr; (self hash: pPassword);  "5"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nextDataBlockString &larr; pName;  "6"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">pupType &larr; sCustodian.  "7"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ (self doLogin: tRequest)  "8"<br>]<br>"<br>1. Create a new request parameter block.<br>2. Set the command to Login.<br>3. Set the number of bytes per page to 512.<br>4. Set the Juniper version number to 7 (Nov 80).<br>5. Set the hashed account password to pPassword hashed.<br>6. Set the account name to pName.<br>7. Set the packet pup type to custodian.<br>8. Issue the request and return the result.<br>"</span></div>
<div class="line left">
<span class="bold small">userName<br></span><span class="small">"...returns the account name or a default (a String)."</span><span class="bold small"><br></span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ fName ≡ nil ⇒ [ ⇑ super userName ]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ fName<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">].<br>]</span></div>
<div class="line left">
<span class="bold small">userPassword<br></span><span class="small">"...returns the account password or a default (a String)."</span><span class="bold small"><br></span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ fPassword ≡ nil ⇒ [ ⇑ super userPassword ]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ fPassword<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">].<br>]</span></div>
<div class="line left">
<span class="bold large"><br>CLASS INIT</span></div>
<div class="line left">
<span class="bold small">classInit<br></span><span class="small">"...initializes the constants in gJuniperConstants<br>(see [ivy] &lt;Juniper&gt;4.4&gt; CommonPineDefs.mesa).<br>Do the following to initialize:<br>Smalltalk declare: ↪gJuniperConstants as: (SymbolTable new init: 256).<br>JuniperInterface classInit."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">| tIndex tConstant<br>[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ tConstant from: (self juniperConstants) do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ tConstant is: Integer ⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ tIndex &larr; tConstant. ]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">gJuniperConstants declare: tConstant as: tIndex.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">tIndex &larr; tIndex+1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">].<br>]</span></div>
<div class="line left">
<span class="bold small">juniperConstants<br></span><span class="small">"...returns the set of constants used to specify requests to and to  interpret results from the Juniper file system."<br>[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">↪(<br>0250  "PineMsgType (Pup types)"<br>sRequest sResult sUnsolicited sCustodian sSync sPineAck sNoop<br><br>5  "DataRequest"<br>sReadPage sWritePage sSetLength sReadLength sCloseFile sDestroyAnonymousFile sReadData sWriteData sReadAttribute sWriteAttribute sSetWriteLock sSetReadLock sReleaseReadLock<br><br>32  "TransactionRequest"<br>sChangePassword sRoom sOpenFile sCreateAnonymousFile sFindFile sLockQuery sTransCompletionQuery<br><br>42  "ActivityRequest"<br>sLogout sCloseTransaction sAbortTransaction sLoginRequest<br><br>60  "DirectoryRequest"<br>sLookupFile sCreateFile sDestroyFile sRenameFile sNextFile sNextFewFiles<br><br>1  "ResultCode"<br>sCommandNak sCommandAck sHeresData sHeresEntry sHeresFileList sHeresLFH sHeresFile sHeresLength sLoginResponse sLogoutResponse sTransactionClosed sTransCompletionInfo sResourceData sHeresRoom<br><br>0  "Unsolicited Code"<br>sTransactionAborted sReadLockBroken<br><br>8  "CustodianCode"<br>sLogin sAddServer sResourceLocation<br><br>42  "PineErrorCode"<br><br>"TransTroubleCode"<br>sUnimplementedFeature sIllegalLoginAttempt sSoftwareVersionMismatch sNoSuchUser sPasswordMismatch sBytesPerPageUnacceptable sServerTooBusy sOutOfSpace sNoFilesHere sNoDirectoryHere sIllegalFileName sFileNotFound sFileAlreadyExists sTransactionAborting sNoSuchOpenFile sBigFilesNotImplemented sIllegalAttribute sReadAttributeProtectionError sUserAskedForIt sWriteAttributeProtectionError sPackNotOnDrive sTooManyOpenFiles sProtectionViolation sFileNotOnPack sPackFull sFileRefOutOfBounds sFileSizeExcessive sByteRangeExcessive sPackNotOnMachine sNoSuchTransaction sBrokenLock sInconvenientUnwind<br><br>"Retryable"<br>sSequenceNumberGap sRecoveryUnderWay sTransactionClosing sCongestion<br><br>120 "UserDetected"<br>sBlockTooLarge sNoRouteToServer sServerUnknown sBadBytesPerPage sInvalidRequest sPupGlitch sUnableToDecrypt sNoResponseToRequest sNewServerUnwilling sTransactionInUnknownState sBadTimeForRequests<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">  )<br>]</span></div>
<div class="line left">
<span class="bold large"><br>TEST / DIAGNOSTIC</span></div>
<div class="line left">
<span class="bold small">test<br></span><span class="small">["<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">dpj &larr; nil.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">dpj &larr; JuniperInterface new.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">dpj release.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">dpj open.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">dpj close.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">| f  [ dpj open.  f &larr; dpj file: &rsquo;test.test&rsquo;.<br>until⦂ [ f end ] do⦂ [ user show: (f next) inString. ]. f close. dpj close. ]<br><br>JuniperSocket howMany 2 1 2 2 2  11 Timer howMany  33  NameUser howMany 1 1 1<br>"] </span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪JuniperInterface under: &rsquo;Juniper&rsquo;.</span></div>
<div class="line left">
<span class="small">JuniperInterface classInit</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"JuniperPageBuffer"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;JuniperPageBuffer&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: EtherFilePage<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fLength<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fPageNumber<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fSerialNumber<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;&rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>JUNIPER PAGE BUFFER</span></div>
<div class="line left">
<span class="bold large"><br>DOCUMENTATION</span></div>
<div class="line left">
<span class="bold small">implementationNotes<br></span><span class="small">[<br>"<br>FIELDS<br></span><span class="bold small">fLength</span><span class="small"> : an Integer specifiying the number of bytes in the page buffer.<br></span><span class="bold small">fPageNumber</span><span class="small"> : an Integer specifying the number of the page buffer.<br></span><span class="bold small">fSerialNumber</span><span class="small"> : an Integer specifying the serial number of the page buffer. <br>"]</span></div>
<div class="line left">
<span class="bold large"><br>FILE PAGE OPERATIONS</span></div>
<div class="line left">
<span class="bold small">length<br></span><span class="small">"...returns the number of bytes in the page buffer."<br>[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ fLength<br>]</span></div>
<div class="line left">
<span class="bold small">length: pLength<br></span><span class="small">"...sets the number of bytes in the page buffer."<br>[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">fLength &larr; pLength.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">super length: pLength.<br>]</span></div>
<div class="line left">
<span class="bold small">pageNumber<br></span><span class="small">"...returns the page number of the page buffer."<br>[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ fPageNumber<br>]</span></div>
<div class="line left">
<span class="bold small">pageNumber: pPageNumber<br></span><span class="small">"...sets the page number of the page buffer."<br>[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">fPageNumber &larr; pPageNumber.<br>]</span></div>
<div class="line left">
<span class="bold small">serialNumber<br></span><span class="small">"...returns the serial number of the page buffer."<br>[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ fSerialNumber<br>]</span></div>
<div class="line left">
<span class="bold small">serialNumber: pSerialNumber<br></span><span class="small">"...sets the serial number of the page buffer."<br>[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">fSerialNumber &larr; pSerialNumber.<br>]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪JuniperPageBuffer under: &rsquo;Juniper&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"JuniperParameterBlock"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;JuniperParameterBlock&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: Object<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fPacket<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fDataBlockPosition<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;&rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>JUNIPER PARAMETER BLOCK</span></div>
<div class="line left">
<span class="bold large"><br>DOCUMENTATION</span></div>
<div class="line left">
<span class="bold small">implementationNotes<br></span><span class="small">[<br>"<br>FIELDS<br></span><span class="bold small">fPacket</span><span class="small"> : a Pacbuf for sending request commands and parameters to the Juniper file server.<br></span><span class="bold small">fDataBlockPosition</span><span class="small"> : an Integer specifying the current position in the data block of fPacket.<br>"<br>]</span></div>
<div class="line left">
<span class="bold large"><br>OPERATIONS</span></div>
<div class="line left">
<span class="bold small">dataBlockAdvance: pIncrement<br></span><span class="small">"...advances the data block position by pIncrement (an Integer)."<br>[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">fDataBlockPosition &larr; fDataBlockPosition + pIncrement.<br>]</span></div>
<div class="line left">
<span class="bold small">dataBlockGet<br></span><span class="small">"...returns the current data block as a Stream."<br>[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ ( (Stream new)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">of: (fPacket pupString)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">from: fDataBlockPosition<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">to: ( 4 + (fPacket pupLength) - 2 )<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">)<br>]</span></div>
<div class="line left">
<span class="bold small">dataBlockLength<br></span><span class="small">"...returns the number of bytes (an Integer) in the data block."<br>[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ ((fPacket pupLength) - 42)<br>]</span></div>
<div class="line left">
<span class="bold small">dataBlockLength &larr; pLength<br></span><span class="small">"...sets the number of bytes in the data block to pLength (an Integer)."<br>[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">fPacket pupLength &larr; pLength + 42.<br>]</span></div>
<div class="line left">
<span class="bold small">leader: pIndex<br></span><span class="small">"...returns the leader word (an Integer) specified by pIndex (an Integer) from the packet."<br>[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ (fPacket word: (12 + pIndex))<br>]</span></div>
<div class="line left">
<span class="bold small">leader: pIndex &larr; pValue<br></span><span class="small">"...sets pValue (an Integer) in the packet at the leader word specified by pIndex (an Integer)."<br>[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">fPacket word: (12 + pIndex) &larr; pValue.<br>]</span></div>
<div class="line left">
<span class="bold small">packet<br></span><span class="small">"...returns the packet (a Pacbuf)."<br>[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ fPacket<br>]</span></div>
<div class="line left">
<span class="bold small">packet &larr; pPacket<br></span><span class="small">"...sets the packet to pPacket (a Pacbuf) and resets the data block position."<br>[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">fPacket &larr; pPacket.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">fDataBlockPosition &larr; 45.<br>]</span></div>
<div class="line left">
<span class="bold small">pupType<br></span><span class="small">"...returns the pup type (an Integer) of the packet."<br>[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ (fPacket pupType)<br>]</span></div>
<div class="line left">
<span class="bold small">pupType &larr; pPupType<br></span><span class="small">"...sets the pup type of the packet to pPupType (an Integer)."<br>[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">fPacket pupType &larr; pPupType.<br>]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪JuniperParameterBlock under: &rsquo;Juniper&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"JuniperRequestParameterBlock"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;JuniperRequestParameterBlock&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: JuniperParameterBlock<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;&rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>JUNIPER REQUEST PARAMETER BLOCK</span></div>
<div class="line left">
<span class="bold large"><br>OPERATIONS</span></div>
<div class="line left">
<span class="bold small">longInteger: pPosition &larr; pValue<br></span><span class="small">"...sets pValue (4 bytes of long integer) in the packet at the parameter position specified by pPosition (an Integer)."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">| tString tPosition<br>[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">tString &larr; fPacket pupString.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">tPosition &larr; (pPosition + 16)*2 - 1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">( (Stream new) of: tString from: tPosition to: (tPosition+3)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">) nextNumber: 4 &larr; pValue.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">tString<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">swap: tPosition with: tPosition+2;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">swap: tPosition+1 with: tPosition+3.<br>]<br>"<br>1. the two words of a Juniper long integers are stored in reverse order from those in Smalltalk.<br>"</span></div>
<div class="line left">
<span class="bold small">nextDataBlockString &larr; pString<br></span><span class="small">"...sets pString (a String) in the data block at the current position and advances the position."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">| tDataBlock tString tLength tMaxLength<br>[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">fPacket pupLength &larr; 554.  "1"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">tDataBlock &larr; self dataBlockGet.  "2"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">tLength &larr; pString length.  "3"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">tMaxLength &larr; (tLength+1) land: 0177776.  "4"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">tDataBlock<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nextword &larr; tLength;  "5"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nextword &larr; tMaxLength;  "6"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">append: pString;  "7"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">next: (tMaxLength - tLength) &larr; 0.  "8"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self dataBlockAdvance: (4 + tMaxLength).  "9"<br>]<br>"<br>1. Set the length of the packet to the maximum size.  The length of each string in the data block is specified in the data block itself.<br>2. Get the data block (as a Stream) from the current position to the end.<br>3. Get the length of pString.<br>4. Determine the length of pString including padding needed to make its length even.<br>5. Set the length of pString in the data block (2 bytes).<br>6. Set the length of pString with padding in the data block (2 bytes).<br>7. Set pString in the data block.<br>8. Add padding in the data block.<br>9. Advance the current data block position past length, maximum length, and pString.<br>"</span></div>
<div class="line left">
<span class="bold small">opcode &larr; pOpcode<br></span><span class="small">"...sets the request opcode field in the packet to pOpcode (an Integer)."<br>[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">fPacket word: 16 &larr; pOpcode.<br>]</span></div>
<div class="line left">
<span class="bold small">parameter: pIndex &larr; pValue<br></span><span class="small">"...sets pValue (an Integer) in the packet at the request parameter field specified by pIndex (an Integer)."<br>[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">fPacket word: (16+pIndex) &larr; pValue.<br>]</span></div>
<div class="line left">
<span class="bold small">shortFileHandle &larr; pShortFileHandle<br></span><span class="small">"...sets the request short file handle field in the packet to pShortFileHandle (an Integer)."<br>[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">fPacket word: 15 &larr; pShortFileHandle.<br>]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪JuniperRequestParameterBlock under: &rsquo;Juniper&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"JuniperResultParameterBlock"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;JuniperResultParameterBlock&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: JuniperParameterBlock<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;&rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>JUNIPER RESULT PARAMETER BLOCK</span></div>
<div class="line left">
<span class="bold large"><br>OPERATIONS</span></div>
<div class="line left">
<span class="bold small">longInteger: pPosition<br></span><span class="small">"...returns the 4 bytes of long integer in the packet at the parameter position specified by pPosition (an Integer)."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">| tArray tPosition<br>[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">tPosition &larr; (pPosition + 15)*2 - 1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">tArray &larr;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">( (Stream new)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">of: (fPacket pupString) from: tPosition to: (tPosition+3)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">) next: 4.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">tArray<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">swap: 1 with: 3;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">swap: 2 with: 4.  "1"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ ((tArray asStream) nextNumber: 4)<br>]<br>"<br>1. Juniper long integers are stored in reverse order from those in Smalltalk.<br>"</span></div>
<div class="line left">
<span class="bold small">nextDataBlockString<br></span><span class="small">"...returns the string in the data block at the current position and advances the position."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">| tDataBlock tString tLength tMaxLength<br>[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">tDataBlock &larr; self dataBlockGet.  "1"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">tLength &larr; tDataBlock nextword.  "2"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">tMaxLength &larr; tDataBlock nextword.  "3"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">tString &larr; tDataBlock next: tLength.  "4"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self dataBlockAdvance: (4 + tMaxLength).  "5"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ tString  "6"<br>]<br>"<br>1. Get the data block (as a Stream) from the current position to the end.<br>2. Get the length of the next string.<br>3. Get the length of the string including possible padding.<br>4. Get the next string from the data block.<br>5. Position the data block past the length, maximum length, string, and padding.<br>6. Return the string.<br>"</span></div>
<div class="line left">
<span class="bold small">parameter: pIndex<br></span><span class="small">"...returns from the packet the result parameter (an Integer) specified by pIndex (an Integer)."<br>[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ (fPacket word: (15+pIndex))<br>]</span></div>
<div class="line left">
<span class="bold small">resultCode<br></span><span class="small">"...returns the result code (an Integer) from the result packet."<br>[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ (fPacket word: 15)<br>]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪JuniperResultParameterBlock under: &rsquo;Juniper&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large"><br>"JuniperSocket"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;JuniperSocket&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: RetransmitSocket<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo;seqNum outPac loginPending notWaiting result outAck&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;&rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>A Socket for communicating with the Juniper File Server. <br>Derived from the class WSocket, jfs, 2/79.<br>see Classes WoodstockFile, WoodstockFilePage, and WoodstockFileDirectory</span></div>
<div class="line left">
<span class="bold large"><br>Initialization/Termination</span></div>
<div class="line left">
<span class="bold small">net: pNet host: pHost <br></span><span class="small">"start with the well known Juniper listener, leave filterInput false"</span><span class="bold small"><br></span><span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">super net: pNet host: pHost soc: 0100 asInt32.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self retransmit: 3 every: 500.  "8 sec"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">outAck &larr; self freePacket.  "for the outgoing pineAck"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">outAck pupType &larr; 0255.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">outAck pupID1 &larr; 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">outAck dataString &larr; &rsquo;&rsquo;.  "also sets length; need to set addresses later"<br>]</span></div>
<div class="line left">
<span class="bold large"><br>Socket</span></div>
<div class="line left">
<span class="bold small">sendLogin: outPac <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">Special routine to send login, wait for ack, retransmit.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">Need to reset seqNum, and get new Juniper socket number.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">Will return the Juniper response packet, or else a false.</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">frnSocNum high: 0 low: 0100.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self setOutAddBlock.  filterInput &larr; false.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">outPac pupID0 &larr; 0. outPac pupID1 &larr; seqNum &larr; 0.  <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">notWaiting &larr; false.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">loginPending &larr; true.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self setAddressesAndComplete: outPac.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">until⦂ [notWaiting] do⦂ [ ].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"all done"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑result.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">sendRequest: outPac <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">General routine to send request packets, wait for ack, retransmit.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">Will return the Juniper response packet, or else a false.</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">notWaiting &larr; false.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">outPac pupID0 &larr; (seqNum &larr; seqNum + 1).  <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self setAddressesAndComplete: outPac.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">until⦂ [notWaiting] do⦂ [ ].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"all done"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑result.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">socProcess: Ipac | temp<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["</span><span class="italic small">Juniper has responded, we&rsquo;re running at a high level"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">loginPending ⇒ "handle this special case"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["watch out, src has not been checked"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">((frnNet ≠ Ipac sourceNet) or⦂ (frnHost ≠ Ipac sourceHost)) or⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">((0251 ≠ Ipac pupType) or⦂ (0 ≠ Ipac pupID0)) ⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["discard it"  "Ipac &larr; self freePacket: Ipac"]<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"this must be it!"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">frnSocNum high: Ipac sourceSoc0 low: Ipac sourceSoc1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self setOutAddBlock. self setAddresses: outAck.  "for later use"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"generate an ack" outAck pupID0 &larr; 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self completePup: outAck.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">loginPending&larr;false.  notWaiting &larr; filterInput &larr; true.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">result &larr; Ipac.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"src. and dest. should have been checked ??)"<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">Ipac pupType = 0251⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"might be a retransmission of a previous Juniper response or what we want.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">acknowledge in either case then see whether we want to keep the result"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">outAck pupID0 &larr; Ipac pupID0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self completePup: outAck.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">notWaiting or⦂ seqNum ≠ Ipac pupID0⇒ ["Ipac &larr; self freePacket: Ipac"]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">notWaiting&larr;true.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">result &larr; Ipac]<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"Ipac pupType = 0255 ⇒ [Ipac&larr;self freePacket: Ipac]" "discard pineack"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">notWaiting≡false and⦂ ((Ipac pupType = 4) and⦂ (Ipac word: 23) = 2) ⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"no socket at Juniper"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self timerOff.  notWaiting&larr;true.   result&larr;Ipac. ].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"Ipac &larr; self freePacket: Ipac."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="bold small">timerFired  <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">This piece of code only runs when a timer fires!<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">Thus, there is mutual exclusion between this and other timer code.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">Runs below the ethernet input.   Don&rsquo;t do an active return<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="italic small">Timer sometimes fires even though its been disabled!</span><span class="small">"<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">notWaiting⇒ [] <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self timerOn⇒ [<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"</span><span class="italic small">go ahead and retransmit.....</span><span class="small">"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self completePup: outPac<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">notWaiting &larr; true. result &larr; false.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪JuniperSocket under: &rsquo;Juniper&rsquo;.</span></div>
    <div class="line left">
<span class="small">&rsquo;From Smalltalk 5.5k XM November 24 on 22 November 1980 at 2:57:08 am.&rsquo;<br></span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="bold large">"ExceptionHandler"</span></div>
<div class="line left">
<span class="bold large">Class new title: &rsquo;ExceptionHandler&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">subclassof: Object<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fields: &rsquo; <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fDoContext<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fCode<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fTrapCode<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fTrapCondition<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fResult<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fPostTrapIndicator<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">fStatusIndicator<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">declare: &rsquo;&rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="bold large">asFollows</span></div>
<div class="line left">
<span class="italic small"><br>EXCEPTION HANDLER  J.C. Althoff  7/79</span></div>
<div class="line left">
<span class="bold large"><br>DOCUMENTATION</span></div>
<div style="width: 442pt; margin-left: 84pt; margin-top: 0pt; text-align: justify">
<span class="bold small">description<br></span><span class="small">[<br>"</span><span class="monospace small"><br>This class provides some exception handling capabilities that can be used in a variety of applications.  It is intended to be used in the following way:<br><br>1. An ExceptionHandler object is created to supervise the execution of a block of statements.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">EH &larr; ExceptionHandler new.</span><span class="monospace small"><br>2. Each object that is capable of detecting an exception is informed of the existence of the ExceptionHandler object.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">dpj exceptionHandler: EH.</span><span class="monospace small"><br>3. The ExceptionHandler object is then sent the message </span><span class="small">&rsquo;do⦂ pCode onTrapDo⦂ pTrapCode&rsquo;</span><span class="monospace small">.  The parameter </span><span class="small">pCode</span><span class="monospace small"> is a block of statements that is to be supervised by the ExceptionHandler object.  The parameter </span><span class="small">pTrapCode</span><span class="monospace small"> is a block of statements that is to be executed whenever an exception is detected.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">EH do⦂ [ ... ] onTrapDo⦂ [ ... ].</span><span class="monospace small"><br>4. When an exception is detected during the execution of one of the statements in </span><span class="small">pCode</span><span class="monospace small"> the message </span><span class="small">&rsquo;trap&rsquo;</span><span class="monospace small"> can be sent to the ExceptionHandler object which will then take control.  If information about the exception is available, it can be relayed by sending the message </span><span class="small">&rsquo;trap:&rsquo;</span><span class="monospace small"> with the information specified as the parameter.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">EH trap. </span><span class="monospace small"> (or)  </span><span class="small">EH trap: information.</span><span class="monospace small"><br>5. When the ExceptionHandler object gets control it saves the parameter if one was sent, then executes </span><span class="small">pTrapCode</span><span class="monospace small">.  The saved parameter can be retrieved by sending the message </span><span class="small">&rsquo;trapCondition&rsquo;</span><span class="monospace small">.  The statements in </span><span class="small">pTrapCode</span><span class="monospace small"> should take any actions necessary to handle the exception. Messages can be included in </span><span class="small">pTrapCode</span><span class="monospace small"> that tell the ExceptionHandler object what to do when </span><span class="small">pTrapCode</span><span class="monospace small"> completes.  The available messages are:<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="monospace small">5.1 </span><span class="small">&rsquo;restart&rsquo;</span><span class="monospace small"> which restarts the execution of </span><span class="small">pCode</span><span class="monospace small">,<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="monospace small">5.2 </span><span class="small">&rsquo;continue&rsquo;</span><span class="monospace small"> which continues </span><span class="small">pCode</span><span class="monospace small"> at the point at which </span><span class="small">&rsquo;trap&rsquo; </span><span class="monospace small">was sent,<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="monospace small">5.3 </span><span class="small">&rsquo;abort&rsquo;</span><span class="monospace small"> which aborts the execution of </span><span class="small">pCode</span><span class="monospace small"> and returns control to the statement following </span><span class="small">&rsquo;do⦂ pCode onTrapDo⦂ pTrapCode&rsquo;</span><span class="monospace small">.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">EH restart.</span><span class="monospace small">  (or)  </span><span class="small">EH continue.</span><span class="monospace small">  (or)  </span><span class="small">EH abort.</span><span class="monospace small"><br>6. The message </span><span class="small">&rsquo;do⦂onTrapDo⦂&rsquo;</span><span class="monospace small"> returns a result which can be specified during the execution of either  </span><span class="small">pCode</span><span class="monospace small"> or </span><span class="small">pTrapCode</span><span class="monospace small"> by the message </span><span class="small">&rsquo;result &larr; pResult&rsquo;</span><span class="monospace small">.  This result value can be retrieved anytime after it has been specified by sending the message </span><span class="small">&rsquo;result&rsquo;</span><span class="monospace small">.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">EH result &larr; true.</span><span class="monospace small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ EH result ⇒ [ ... ] ].</span><span class="monospace small"><br>7. If </span><span class="small">pCode</span><span class="monospace small"> is terminated abnormally from a user notify window, the message </span><span class="small">&rsquo;release&rsquo;</span><span class="monospace small"> should be sent to return the ExceptionHandler object to its initial state.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">EH release.</span><span class="monospace small"><br>8. Special error checking is included in the ExceptionHandler object to detect calls to </span><span class="small">pTrapCode</span><span class="monospace small"> during the execution of </span><span class="small">pTrapCode</span><span class="monospace small"> and other invalid conditions.</span><span class="small"><br>"<br>]</span></div>
<div class="line left">
<span class="bold small">implementationNotes<br></span><span class="small">[<br>"<br>FIELDS<br></span><span class="bold small">fDoContext</span><span class="small"> : a Context that controls the execution of the message &rsquo;do⦂onTrapDo⦂&rsquo;.<br></span><span class="bold small">fCode</span><span class="small"> : a Context that controls the execution of the statements passed as the first parameter to &rsquo;do⦂onTrapDo⦂&rsquo;.<br></span><span class="bold small">fTrapCode</span><span class="small"> : a Context that controls the execution of the statements passed as the second parameter to &rsquo;do⦂onTrapDo⦂&rsquo;.<br></span><span class="bold small">fTrapCondition</span><span class="small"> : the object passed as the parameter to &rsquo;trap:&rsquo;.<br></span><span class="bold small">fResult</span><span class="small"> : the object that is the result of &rsquo;do⦂onTrapDo⦂&rsquo;.<br></span><span class="bold small">fPostTrapIndicator</span><span class="small"> : an Integer specifying the action to be taken after fTrapCode is executed.<br></span><span class="bold small">fStatusIndicator</span><span class="small"> : an Integer specifying the status of &rsquo;do⦂onTrapDo⦂&rsquo;; nil means &rsquo;do⦂onTrapDo⦂&rsquo; has not been invoked, 1 means fCode is active, 0 means fTrapCode is active.<br>"<br>]</span></div>
<div class="line left">
<span class="bold large"><br>CONTROL STRUCTURE</span></div>
<div class="line left">
<span class="bold small">do⦂ pCode onTrapDo⦂ pTrapCode<br></span><span class="small">"...executes the set of statements in the block pCode and, conditionally, the set of statements in the block pTrapCode.  If &rsquo;trap&rsquo; or &rsquo;trap:&rsquo; is invoked during the execution of pCode, the execution is interrupted and pTrapCode is started.  When pTrapCode completes, pCode is either continued, restarted, or aborted, depending on which of &rsquo;continue&rsquo;, &rsquo;restart&rsquo;, and &rsquo;abort&rsquo; is sent during the execution of pTrapCode.  A notify window is created if &rsquo;trap&rsquo; or &rsquo;trap:&rsquo; is sent when pCode is not active, or if &rsquo;do⦂onTrapDo⦂&rsquo; is sent again before the first invocation completes."<br>[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ fStatusIndicator ≠ nil ⇒ [ user notify: &rsquo;ExceptionHandler is active&rsquo;. ]  "1"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">fStatusIndicator &larr; 1.  "2"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">fCode &larr; pCode.  "3"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">fTrapCode &larr; pTrapCode.  "4"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">fDoContext &larr; thisContext.  "5"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">fTrapCondition &larr; nil.  "6"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">fResult &larr; true.  "7"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">fCode eval.  "8"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self release.  "9"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ fResult  "10"<br>]<br>"<br>1. If fStatusIndicator ≠ nil, then the previous invocation of &rsquo;do⦂onTrapDo⦂&rsquo; has not completed properly.  Create a notify window in this case.<br>2. Set fStatusIndicator to indicate pCode is active.<br>3. Save pCode for execution and restart.<br>4. Save pTrapCode for later execution.<br>5. Save the context of &rsquo;do⦂onTrapDo⦂&rsquo; for &rsquo;restart&rsquo; and &rsquo;abort&rsquo;.<br>6. Initialize the trap condition to nil.<br>7. Initialize the result of &rsquo;do⦂onTrapDo⦂ &rsquo; to true.<br>8. Execute pCode.<br>9. Set fields to nil to release saved contexts.<br>10. Return fResult (which may have been modified during the execution of pCode or pTrapCode).<br>"</span></div>
<div class="line left">
<span class="bold large"><br>TRAP HANDLER</span></div>
<div class="line left">
<span class="bold small">trap<br></span><span class="small">"...interrupts the execution of pCode and begins pTrapCode (from &rsquo;do⦂ pCode onTrapDo⦂ pTrapCode&rsquo;)."<br>[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self trap: nil.<br>]</span></div>
<div class="line left">
<span class="bold small">trap: pTrapCondition<br></span><span class="small">"...interrupts the execution of pCode and begins pTrapCode (from &rsquo;do⦂ pCode onTrapDo⦂ pTrapCode&rsquo;).  The trap condition is set to pTrapCondition."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">|tTrapCode i<br>[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ fStatusIndicator<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">≡ nil ⇒ [ user notify: &rsquo;ExceptionHandler is not active&rsquo; ];  "1"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">= 0  ⇒ [ user notify: &rsquo;ExceptionHandler trap code is already active&rsquo; ]  "2"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">fStatusIndicator &larr; 0.  "3"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">fTrapCondition &larr; pTrapCondition.  "4"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">fPostTrapIndicator &larr; 0.  "5"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">tTrapCode &larr; fTrapCode cleancopy.  "6"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">tTrapCode eval.  "7"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: tTrapCode totalPT do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ fTrapCode setPT: i to: (tTrapCode getPT: i). ].  "8"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">fStatusIndicator &larr; 1.  "9"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ fPostTrapIndicator  "10"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">= 0 ⇒ [ self restartCode. ];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">= 1 ⇒ [ self abortCode. ];<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">= 2 ⇒ [ ]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">].<br>]<br>"<br>1. If fStatusIndicator ≡ nil, then &rsquo;do⦂onTrapDo⦂&rsquo; has not been invoked and there is no trap code to execute.<br>2. if fStatusIndicator = 0, then fTrapCode is active.  This is an invalid state.<br>3. Set fStatusIndicator to indicate fTrapCode is active.<br>4. Set the trap condition to pTrapCondition.<br>5. Set the default post trap action to &rsquo;restart&rsquo;.<br>6. Make a new copy of the context, fTrapCode.<br>7. Execute the new copy of fTrapCode.<br>8. Set the parameters and temporaries in the context, fTrapCode to those of the executed copy.  This is done so that fCode will see any changes made to these variables by fTrapCode.<br>9. Set fStatusIndicator to indicate fTrapCode is not active.<br>10. Select the terminating action from the value of fPostTrapIndicator.<br>"</span></div>
<div class="line left">
<span class="bold large"><br>POST TRAP SPECIFICATION</span></div>
<div class="line left">
<span class="bold small">abort<br></span><span class="small">"...specifies that the code interrupted by &rsquo;trap&rsquo; or &rsquo;trap:&rsquo; will be aborted when the trap code completes.  Control will return to the statement that follows the invocation of &rsquo;do⦂onTrapDo⦂&rsquo;."<br>[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">fPostTrapIndicator &larr; 1.<br>]</span></div>
<div class="line left">
<span class="bold small">continue<br></span><span class="small">"...specifies that the code interrupted by &rsquo;trap&rsquo; or &rsquo;trap:&rsquo; will be continued when the trap code completes."<br>[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">fPostTrapIndicator &larr; 2.<br>]</span></div>
<div class="line left">
<span class="bold small">restart<br></span><span class="small">"...specifies that the code interrupted by &rsquo;trap&rsquo; or &rsquo;trap:&rsquo; will be restarted when the trap code completes."<br>[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">fPostTrapIndicator &larr; 0.<br>]</span></div>
<div class="line left">
<span class="bold large"><br>MISC</span></div>
<div class="line left">
<span class="bold small">result<br></span><span class="small">"...returns the result set by &rsquo;result&larr;&rsquo;."<br>[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ fResult<br>]</span></div>
<div class="line left">
<span class="bold small">result &larr; pResult<br></span><span class="small">"...sets the result value of &rsquo;do⦂onTrapDo⦂&rsquo; to pResult."<br>[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">fResult &larr; pResult.<br>]</span></div>
<div class="line left">
<span class="bold small">trapCondition<br></span><span class="small">"...returns the condition that was passed as the parameter to &rsquo;trap:&rsquo;."<br>[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑ fTrapCondition<br>]</span></div>
<div class="line left">
<span class="bold large"><br>POST TRAP ACTION (internal)</span></div>
<div class="line left">
<span class="bold small">abortCode<br></span><span class="small">"...releases the context chain and returns fResult to the caller of &rsquo;do⦂onTrapDo⦂&rsquo;."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">|tDoContextCaller<br>[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">tDoContextCaller &larr; fDoContext caller.  "1"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">thisContext caller releaseTo: tDoContextCaller.  "2"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self release.  "3"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">tDoContextCaller push: fResult.  "4"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">Top run: tDoContextCaller at: Top currentPriority.  "5"<br>]<br>"<br>1. Get the caller of &rsquo;do⦂onTrapDo⦂&rsquo;.<br>2. Release the context chain from the caller of thisContext up to the caller of &rsquo;do⦂onTrapDo⦂&rsquo;.<br>3. Set fields to nil to clean up pointers to unwanted contexts.<br>4. Return fResult to the caller of &rsquo;do⦂onTrapDo⦂&rsquo;.<br>5. Run the caller of &rsquo;do⦂onTrapDo⦂&rsquo;.<br>"</span></div>
<div class="line left">
<span class="bold small">release<br></span><span class="small">"...resets the exception handler to its initial condition."<br>[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">fCode &larr; nil.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">fTrapCode &larr; nil.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">fDoContext &larr; nil.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">fStatusIndicator &larr; nil.<br>]</span></div>
<div class="line left">
<span class="bold small">restartCode<br></span><span class="small">"...releases the context chain and restarts the block of statements passed as the first parameter to &rsquo;do⦂onTrapDo⦂&rsquo;."<br>[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">thisContext caller releaseTo: fCode.  "1"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">fCode restart.  "2"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">fCode push: fDoContext.  "3"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">Top run: fCode at: Top currentPriority.  "4"<br>]<br>"<br>1. Release the context chain from the caller of thisContext up to fCode.<br>2. Resets the pc and stack pointer of fCode.<br>3. Push the return context of fCode onto its tempframe.<br>4. Run fCode.<br>"</span></div>
<div class="line left">
<span class="bold large"><br>TEST AND DIAGNOSTIC</span></div>
<div class="line left">
<span class="bold small">test  </span><span class="small">"ExceptionHandler new test."</span><span class="bold small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">| guard i<br>[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">guard &larr; ExceptionHandler new.  user clear.  i &larr; 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">guard do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ user show: i asString.  i &larr; i+1.  guard trap: i.  user show: &rsquo; end&rsquo;. ]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">onTrapDo⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ i &lt; 10 ⇒ [ guard restart ]  guard continue ].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user show: &rsquo; done.&rsquo;.  user cr.  ⇑ guard result<br>]</span></div>
<div class="line left">
<span class="bold small">testTransaction  </span><span class="small">"ExceptionHandler new testTransaction."</span><span class="bold small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">| e i max f<br>[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">e &larr; ExceptionHandler new.  i &larr; 0.  max &larr; 5.  dpj exceptionHandler: e.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">dpj open.  f &larr; dpj file: &rsquo;test.test&rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">e do⦂ [f reset. until⦂ [ f end ] do⦂ [ user show: (f next) inString. ]. ]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">onTrapDo⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ user cr;  show: &rsquo;Juniper not responding&rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">f release.  dpj release.  i &larr; i+1.  [ i &lt; max ⇒ [ e restart. ] e abort ]. ].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user cr;  show: &rsquo;done&rsquo;.  f close.  dpj close.<br>]</span></div>
<div class="line left">
<span class="bold large"><br>EXAMPLES</span></div>
<div class="line left">
<span class="bold small">juniperTest  </span><span class="small">"ExceptionHandler new juniperTest."</span><span class="bold small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">| e i max f<br>[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">e &larr; ExceptionHandler new.  i &larr; 0.  max &larr; 5.  dpj exceptionHandler: e.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">dpj open.  f &larr; dpj file: &rsquo;test.test&rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">e do⦂ [f reset. until⦂ [ f end ] do⦂ [ user show: (f next) inString. ]. ]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">onTrapDo⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ user cr;  show: &rsquo;Juniper not responding&rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">f release.  dpj release.  i &larr; i+1.  [ i &lt; max ⇒ [ e restart. ] e abort ]. ].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user cr;  show: &rsquo;done&rsquo;.  f close.  dpj close.<br>]</span></div>
<div class="line left">
<span class="bold small">loopTest  </span><span class="small">"ExceptionHandler new loopTest."</span><span class="bold small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">| guard i<br>[<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">guard &larr; ExceptionHandler new.  user clear.  i &larr; 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">guard do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ user show: i asString.  i &larr; i+1.  guard trap: i.  user show: &rsquo; end&rsquo;. ]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">onTrapDo⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[ i &lt; 10 ⇒ [ guard restart ]  guard continue ].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user show: &rsquo; done.&rsquo;.  user cr.  ⇑ guard result<br>]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪ExceptionHandler under: &rsquo;ExceptionHandling&rsquo;.</span></div>

  </body>
</html>
