<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN">
<html>
  <head>
    <meta http-equiv="Content-type" content="text/html;charset=UTF-8">
    <title>Smalltalk76/Events.st</title>
	<link rel="stylesheet" type="text/css" href="font.css"/>
  </head>
  <body>
    <div class="line left">
<span class="small">&rsquo;From Smalltalk 5.5k XM November 24 on 22 November 1980 at 2:57:08 am.&rsquo;<br></span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="medium bold">"EventQueue"</span></div>
<div class="line left">
<span class="medium bold">Class new title: &rsquo;EventQueue&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="medium bold">subclassof: Queue<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="medium bold">fields: &rsquo;primitivequeue readwriteelapsed time&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="medium bold">declare: &rsquo;read elapsed write &rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="medium bold">asFollows</span></div>
<div class="line left">
<span class="small italic"><br>The EventQueue (Events) is a subclass of class Queue.  It contains a regular queue which is filled from a block of memory (currently 128 words long), updated during the 60HZ interrupt.  This block of memory is called the primitivequeue, and is unpacked into the regular queue when events are available upon receiving the message peek or next.  The fundamental difference between peek and next is that next dequeues the current event and peek does not.  Furthermore peek will return false when the queue is empty, and next, when the queue is empty, will create a time elapsed event and return that.  An event will be of class UserEvent as created by the primitiveDequeue and next  messages. The machine code thinks of events as a 4-word structure as follows:<br><br>Word 1:<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small italic">Left Byte:<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small italic">1 = Key down.  0 = Key up.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small italic">Right Byte:<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small italic">8-bit Ascii value.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small italic">Mouse Buttons:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small italic">Left/Top</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small italic">=</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small italic">0<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small italic">Middle</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small italic">=</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small italic">1<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small italic">Right/Bottom</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small italic">=</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small italic">2<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small italic">Keyset:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small italic">Leftmost</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small italic">=</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small italic">3<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small italic">=</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small italic">4<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small italic">=</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small italic">5<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small italic">=</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small italic">6<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small italic">Rightmost</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small italic">=</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small italic">7<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small italic">Values 8 - 255, keyboard decodings as expected by rawkbd.<br><br>Word 2:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small italic">Time (sixtieths of a second since last event).<br><br>Word 3:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small italic">Cursor x coordinate (UserView htab accounted for).<br><br>Word 4:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small italic">Cursor y coordinate (UserView vtab accounted for)..<br></span></div>
<div class="line left">
<span class="medium bold"><br>Initialization</span></div>
<div class="line left">
<span class="small bold">init</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small bold"> </span><span class="small italic">"sets up system wide event queue -- only one from the present"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="small italic">"***BEWARE, USED ONLY AT TIME OF SYSTEM GENERATION***"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">primitivequeue &larr; CoreLocs new base: (mem◦0114) length: (mem◦0115).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">readwriteelapsed &larr; CoreLocs new base: 0111 length: 3.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">read &larr; 0. write &larr; 1. elapsed &larr; 2.</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small italic">"offsets of read, write and elapsed pointers"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">time &larr; 0.</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small italic">"start time at 0"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">super of: (Vector new: 4). </span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small italic">"initialize Smalltalk queue"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="medium bold"><br>Public Access</span></div>
<div class="line left">
<span class="small bold">elapsedtime </span><span class="small">[⇑readwriteelapsed◦elapsed] </span><span class="small italic">"return elapsed time"</span><span class="small"><br></span></div>
<div class="line left">
<span class="small bold">next </span><span class="small">| event elapsedtime </span><span class="small italic">"return event from queue unless both queues empty,  when return null event"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[event &larr; self dequeue ⇒ [⇑event]</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small italic">"Queue not empty?"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">event &larr; self primitiveDequeue ⇒ [⇑event]</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small italic">"primitivequeue not empty?"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">elapsedtime &larr; readwriteelapsed◦elapsed.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑UserEvent new</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small italic">"when empty return null event"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">x:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user x</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small italic">"event x"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">y:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user y</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small italic">"event y"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">type:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">0</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small italic">"2=up, 1=down, 0=null, only time passed"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">stroke:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">0</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small italic">"0 stroke for null event"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">elapsed:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">elapsedtime</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small italic">"1-32767 sixtieths of a sec -- since last event"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">time:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(time + elapsedtime) asSmall</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small italic">"time since timer reset"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span></div>
<div class="line left">
<span class="small bold">peek </span><span class="small">| event </span><span class="small italic">"unless both queues empty, return event from queue, but dont dequeue"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[event &larr; super peek ⇒[ ⇑event]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">event &larr; self primitiveDequeue ⇒ [⇑self next &larr; event]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑false</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]<br></span></div>
<div class="line left">
<span class="small bold">reset </span><span class="small italic">"for the present, just reset time to 0"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[time &larr; 0]</span></div>
<div class="line left">
<span class="small bold">time </span><span class="small">[⇑time]</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> </span><span class="small italic">"return time"</span><span class="small"><br></span></div>
<div class="line left">
<span class="small bold">time &larr; time</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small bold"> </span><span class="small italic">"reset time"</span><span class="small"><br></span></div>
<div class="line left">
<span class="medium bold"><br>Private</span></div>
<div class="line left">
<span class="small bold">primitiveDequeue </span><span class="small">| rp tands nrp event elapsedtime<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"unless empty, return event from primitivequeue"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[(readwriteelapsed◦read) = (readwriteelapsed◦write) ⇒ </span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑false].</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"primitivequeue empty?"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"Build event from primitive queue and return it."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"first word has type and stroke packed"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">tands &larr; primitivequeue◦(rp &larr; readwriteelapsed◦read).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">elapsedtime &larr; primitivequeue◦(rp + 1).</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">event &larr; UserEvent new<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">x:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">primitivequeue◦(rp + 2)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"event x"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">y:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">primitivequeue◦(rp + 3)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"event y"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">type:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[tands &lt; 0 ⇒ [2] 1]</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"2=up, 1=down"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">stroke:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[tands &gt; 0 ⇒ [tands] 0 - tands]</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"1-336"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">elapsed:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">elapsedtime</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"1-32767 sixtieths of a second"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">time:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(time &larr; (time + elapsedtime) asSmall).<br><br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nrp &larr; rp + 4.</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"set bumped read pointer"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[nrp ≥ (primitivequeue length) ⇒ [nrp &larr; 1]].</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"Wrap-around?"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">readwriteelapsed◦read &larr; nrp.</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"bump read pointer"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑event</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">"Return event"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪EventQueue under: &rsquo;Events&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="medium bold"><br>"MessageTally"</span></div>
<div class="line left">
<span class="medium bold">Class new title: &rsquo;MessageTally&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="medium bold">subclassof: Object<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="medium bold">fields: &rsquo;class method tally rcvrs&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="medium bold">declare: &rsquo;timer &rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="medium bold">asFollows</span></div>
<div class="line left">
<span class="small italic"><br>The following statement analyzes the evaluation of &rsquo;user restore&rsquo;.  It checks every 10 sixtieths of a second to see what method is being executed.  It prints the analysis on file &rsquo;restore.spy&rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small italic">spy every: 10; on⦂ [user restore]; report: &rsquo;restore.spy&rsquo;; close.<br>Read further to learn of more flexible ways to use message tallies.<br><br>A message tally is a tally of how many times, according to some authority, a certain method or any of that method&rsquo;s callees has been invoked.  Message tallies for the callees are listed in the vector, rcvrs; thus, each message tally is a node in a tree.  The root of that tree is called the &rsquo;root tally&rsquo;; its method the &rsquo;root method&rsquo;; and the context that was running that method the &rsquo;root context&rsquo;.  Contexts that do not have the root context on their stack are tallied as if the root context were at the bottom of their stack.<br><br>The authority informs the root tally of invocations in either of two ways: &rsquo;explicitly&rsquo; or by &rsquo;spying&rsquo;.<br><br>To explicitly create the tallies from a root context, rc, a root tally is created with:<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small italic">mt &larr; MessageTally new from: rc<br>and is informed of the invocation of each context c with:<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small italic">mt tally: c<br><br>To spy on (periodically sample) the execution of a statement sequence, ss, every t sixtieths of a second (t&gt;1), a root tally is created with:<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small italic">mt &larr; MessageTally new every: t<br>and is informed of invocations with:<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small italic">valOfSS &larr; mt on⦂ [ss].<br>The context that executes the latter statement is the root context.  Its method should not be called recursively by ss.  Only one spying operation can be in progress at a time, and all spies share the most recently specified time interval.  Thus, there may as well be only one spying message tally in existence, and the global variable &rsquo;spy&rsquo; is predefined as such.<br><br>Spying typically adds 1/4 second per probe to execution.  Ctrl-shift-esc can be used to abort a spying operation.<br><br>Tallies can be printed by:<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small italic">mt report: &rsquo;filename.spy&rsquo;<br>which prints two tables of invocations sorted by tally, with tallies expressed as percentages and with methods described in terms of their defining class and selector.  In the first table, &rsquo;Leaves&rsquo;, tallies do not include time spent in submethods (this is like the spy in Swat).  In the second table, &rsquo;Tree&rsquo;, the percentages do include time spent in submethods, and those submethods are displayed indented.  In both tables, entries below a &rsquo;cutoff&rsquo; of 2 per cent are suppressed.<br><br>Different cutoffs can be specified for each table.  To cut off Leaves at 7.5 per cent and Tree at 3 per cent, use:<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small italic">mt report: &rsquo;filename.spy&rsquo; cutoff: 7.5,3<br>A cutoff of 100 or greater suppresses printing of that table completely.  To output to a specified stream, use the message &rsquo;fullprinton:cutoff:&rsquo;.<br><br>To release the storage occupied by the tally tree, use the message &rsquo;close&rsquo;.</span></div>
<div class="line left">
<span class="medium bold"><br>Public Tallying</span></div>
<div class="line left">
<span class="small bold">abort<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[timer is: Timer⇒ [timer disable]]</span></div>
<div class="line left">
<span class="small bold">classInit<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[Smalltalk define: ↪spy as: (MessageTally new every: 10)]</span></div>
<div class="line left">
<span class="small bold">close </span><span class="small italic">"release storage"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[class &larr; method &larr; tally &larr; rcvrs &larr; nil]</span></div>
<div class="line left">
<span class="small bold">every: sixtieths</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small bold">  </span><span class="small italic">"Create a spy that samples with the specified period"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self abort. timer &larr; Timer new for: sixtieths action⦂ [self tally: Top◦1. timer reset]]</span></div>
<div class="line left">
<span class="small bold">from: context  </span><span class="small italic">"Create a tallier from the specified root"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self class: context receiver class method: context method]</span></div>
<div class="line left">
<span class="small bold">moreon⦂ remote </span><span class="small">| val  </span><span class="small italic">"Spy on the specified evaluation without resetting"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["use as follows:<br></span><span class="small bold">eachtime  <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[spy every: 10.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑spy moreon⦂ [super eachtime].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">class &larr; remote receiver class.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">method &larr; remote method. <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">timer reset. val &larr; remote eval. timer disable. ⇑val]</span></div>
<div class="line left">
<span class="small bold">on⦂ remote </span><span class="small">| val  </span><span class="small italic">"Spy on the specified evaluation"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self from: remote. timer reset. val &larr; remote eval. timer disable. ⇑val]</span></div>
<div class="line left">
<span class="small bold">reset<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["reset stats"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">tally &larr; 0. rcvrs &larr; Vector new: 0]</span></div>
<div class="line left">
<span class="small bold">tally: context </span><span class="small">| root  </span><span class="small italic">"Explicitly tally the specified context and its stack"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[context method≡method⇒ [⇑self bump]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">(root &larr; context sender)≡nil⇒[⇑self bump tallyPath: context]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑(self tally: root) tallyPath: context]</span></div>
<div class="line left">
<span class="medium bold"><br>Public Reporting</span></div>
<div class="line left">
<span class="small bold">fullprinton: s cutoff: pct </span><span class="small">| set mt i t<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[user displayoffwhile⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[s print: tally; append: &rsquo; tallies&rsquo;; cr. tally=0⇒ []<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s cr; cr. [pct is: Vector⇒ [] pct &larr; pct, pct].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[pct◦1&lt;100⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[s append: &rsquo;**Leaves**&rsquo;; cr. t &larr; ((pct◦1)*(tally-1)/100) asInteger.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">set &larr; HashSet new init: 128. self leaves: set.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self cumprinton: s from: set total: tally over: t. s next&larr;12; cr.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">set &larr; nil]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[pct◦2&lt;100⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[s append: &rsquo;**Tree**&rsquo;; cr. t &larr; ((pct◦2)*(tally-1)/100) asInteger.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self treeprinton: s tab: 0 total: tally over: t. s next&larr;12; cr]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s skip: ¬2]]</span></div>
<div class="line left">
<span class="small bold">printon: s<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[class≡nil⇒ [super printon: s] self printon: s total: 100]</span></div>
<div class="line left">
<span class="small bold">report: filename<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[self report: filename cutoff: 2]</span></div>
<div class="line left">
<span class="small bold">report: filename cutoff: pct </span><span class="small">| f  </span><span class="small italic">"pct=(leaves,roots,tree) or one number for all"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[f &larr; dp0 file: filename. f append: filename; space.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self fullprinton: f cutoff: pct. f close]</span></div>
<div class="line left">
<span class="medium bold"><br>Private Tallying</span></div>
<div class="line left">
<span class="small bold">bump<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[tally &larr; tally+1]</span></div>
<div class="line left">
<span class="small bold">tallyPath: context </span><span class="small">| m path mt c<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[m &larr; context method. path&larr;false.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ mt from: rcvrs do⦂ [mt method≡m⇒ [path&larr;mt]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[path≡false⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[path &larr; MessageTally new class: context receiver class method: m. rcvrs &larr; rcvrs, path]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑path bump]</span></div>
<div class="line left">
<span class="medium bold"><br>Private Reporting</span></div>
<div class="line left">
<span class="small bold">&lt; mt<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑tally &gt; mt tally]</span></div>
<div class="line left">
<span class="small bold">= mt<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑mt method≡method]</span></div>
<div class="line left">
<span class="small bold">&gt; mt<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑tally &lt; mt tally]</span></div>
<div class="line left">
<span class="small bold">breakdown </span><span class="small">| n b mt<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[b &larr; rcvrs. b≡nil or⦂ b length=0⇒ [⇑↪()]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">n &larr; tally. for⦂ mt from: b do⦂ [n &larr; n - mt tally].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[n&gt;0⇒ [b &larr; b, [MessageTally new class: class method: method; primitives: n]]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑b]</span></div>
<div class="line left">
<span class="small bold">bump: n<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[tally &larr; tally+n]</span></div>
<div class="line left">
<span class="small bold">cumprinton: s from: set total: total over: threshold </span><span class="small">| mt<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[for⦂ mt from: set contents sort do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[mt tally&gt;threshold⇒ [mt printon: s total: total. s cr] ⇑self]]</span></div>
<div class="line left">
<span class="small bold">hash<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑method asOop]</span></div>
<div class="line left">
<span class="small bold">into: set </span><span class="small">| mt i<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[[i &larr; set find: self⇒ [mt &larr; set objects◦i]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">set insert: (mt &larr; MessageTally new class: class method: method)].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">mt bump: tally]</span></div>
<div class="line left">
<span class="small bold">leaves: ldict </span><span class="small">| b mt<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[b &larr; self breakdown. b length=0⇒ [self into: ldict] for⦂ mt from: b do⦂ [mt leaves: ldict]]</span></div>
<div class="line left">
<span class="small bold">primitives: tally<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[rcvrs &larr; nil]</span></div>
<div class="line left">
<span class="small bold">printon: s total: total </span><span class="small">| i v<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[v &larr; (0.0+tally/total*1000.0+0.5) asInteger asString. i &larr; v length.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s append: &rsquo;  &rsquo;◦(i to: 2); append: v◦(1 to: i-1); append: &rsquo;.&rsquo;; next&larr;v◦i; space.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">rcvrs≡nil⇒ [s append: &rsquo;primitives&rsquo;]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">class describe: method on: s]</span></div>
<div class="line left">
<span class="small bold">tally<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑tally]</span></div>
<div class="line left">
<span class="small bold">treeprinton: s tab: tab total: total over: threshold </span><span class="small">| i mt<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[tally≤threshold⇒ []<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[tab&gt;0⇒ [for⦂ i to: tab-1 do⦂ [s append: &rsquo;  |&rsquo;]. self printon: s total: total. s cr]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ mt from: self breakdown sort do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[mt treeprinton: s tab: tab+1 total: total over: threshold]]</span></div>
<div class="line left">
<span class="medium bold"><br>Private Common</span></div>
<div class="line left">
<span class="small bold">class: class method: method<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[tally &larr; 0. rcvrs &larr; Vector new: 0]</span></div>
<div class="line left">
<span class="small bold">method<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑method]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪MessageTally under: &rsquo;Events&rsquo;.</span></div>
<div class="line left">
<span class="small">MessageTally classInit</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="medium bold"><br>"PriorityInterrupt"</span></div>
<div class="line left">
<span class="medium bold">Class new title: &rsquo;PriorityInterrupt&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="medium bold">subclassof: Object<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="medium bold">fields: &rsquo;scheduler priority&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="medium bold">declare: &rsquo;&rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="medium bold">asFollows</span></div>
<div class="line left">
<span class="small italic"><br>PriorityInterrupts fill the need for (sched, level) pairs.  Most messages are simply passed on to the scheduler with the priority as an argument</span></div>
<div class="line left">
<span class="medium bold"><br>Initialization</span></div>
<div class="line left">
<span class="small bold">from: scheduler at: priority</span></div>
<div class="line left">
<span class="medium bold"><br>Level numbers</span></div>
<div class="line left">
<span class="small bold">+ arg<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑priority + arg]</span></div>
<div class="line left">
<span class="medium bold"><br>Scheduling</span></div>
<div class="line left">
<span class="small bold">deepsleep<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[scheduler deepsleep: priority]</span></div>
<div class="line left">
<span class="small bold">disable<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[scheduler disable: priority]</span></div>
<div class="line left">
<span class="small bold">enable<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[scheduler enable: priority]</span></div>
<div class="line left">
<span class="small bold">reset<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[scheduler reset: priority]</span></div>
<div class="line left">
<span class="small bold">restart<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[scheduler restart: priority]</span></div>
<div class="line left">
<span class="small bold">run: newContext<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[scheduler run: newContext at: priority] primitive: 87</span></div>
<div class="line left">
<span class="small bold">sleep<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[scheduler sleep: priority]</span></div>
<div class="line left">
<span class="small bold">swap: newContext<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small bold"> with: fieldReference<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[scheduler<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">swap: newContext<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">at: priority<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">with: fieldReference] primitive: 88</span></div>
<div class="line left">
<span class="small bold">terminate<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[scheduler terminate: priority]</span></div>
<div class="line left">
<span class="small bold">wakeup<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[scheduler wakeup: priority]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪PriorityInterrupt under: &rsquo;Events&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="medium bold"><br>"PriorityScheduler"</span></div>
<div class="line left">
<span class="medium bold">Class new title: &rsquo;PriorityScheduler&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="medium bold">subclassof: Object<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="medium bold">fields: &rsquo;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="medium bold">sourceIndirect<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="medium bold">"an indirect reference to the source of power,<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="medium bold">ie the source from which this scheduler was spawned,<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="medium bold">and who therefore holds the suspension if it is suspended."<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="medium bold">suspendedContexts<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="medium bold">"&lt;Vector of Contexts&gt; the suspended processes"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="medium bold">initialContexts<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="medium bold">"&lt;Vector of Contexts&gt; root processes for restarting"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="medium bold">enabledPriorities<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="medium bold">"&lt;Integer&gt; priorities which can receive control"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="medium bold">awakePriorities<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="medium bold">"&lt;Integer&gt; priorities which are requesting control"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="medium bold">interruptedPriorities<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="medium bold">"&lt;Integer&gt; new priorities which are requesting control"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="medium bold">currentPriority<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="medium bold">"&lt;Integer&gt; priority which currently has control"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="medium bold">usedPriorities<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="medium bold">"&lt;Integer&gt; priorities which have processes installed"&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="medium bold">declare: &rsquo;TimeInt CtlCDisp UserInt GRODSK CtlShftEscInt CtlCInt &rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="medium bold">sharing: BitMasks;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="medium bold">asFollows</span></div>
<div class="line left">
<span class="small italic"><br>The underlying machine has a pointer to the top-level scheduler (Top), so that physical interrupts can also cause interrupts in Smalltalk.  This they do by calling their own copy of wakeup and reselect.  This copy is also invoked (primitive 65) when reselect is sent to the top-level scheduler, since its source is the virtual machine itself.</span></div>
<div class="line left">
<span class="medium bold"><br>Initialization</span></div>
<div class="line left">
<span class="small bold">◦ priority<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑suspendedContexts◦priority]</span></div>
<div class="line left">
<span class="small bold">currentPriority </span><span class="small">[⇑currentPriority]</span></div>
<div class="line left">
<span class="small bold">fromSource: sourceIndirect<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="small italic">"Initialize a scheduler having 16 spaces for processes"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> suspendedContexts &larr; Vector new: 16.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> initialContexts &larr; Vector new: 16.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> enabledPriorities &larr; 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> awakePriorities &larr; 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> interruptedPriorities &larr; 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> usedPriorities &larr; 0.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> currentPriority &larr; 0.]</span></div>
<div class="line left">
<span class="small bold">replaceUser: stack<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[UserInt run: stack]</span></div>
<div class="line left">
<span class="medium bold"><br>Install and Terminate</span></div>
<div class="line left">
<span class="small bold">install⦂ newContext above: priority </span><span class="small">| i<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="small italic">"Install a process in the next empty level above &lt;priority&gt; which is initialized from &lt;newContext&gt; (a remote Context). If there is no empty level above that priority, tell the user and return false"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> newContext sender &larr; nil.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> for⦂ i from: (priority+1 to: 16) do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[(usedPriorities land: biton◦i) = 0⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑self<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">INSTALL⦂ [while⦂ true do⦂ [newContext cleancopy eval]]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">AT: i]]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> user show:<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">&rsquo;PriorityScheduler unable to install above level &rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">+priority asString<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">+&rsquo;. false returned&rsquo;. ⇑false]</span></div>
<div class="line left">
<span class="small bold">install⦂ newContext at: priority<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="small italic">"Install a process at level &lt;priority&gt; which is initialized from &lt;newContext&gt; (a remote Context). If there is already a process at that priority, tell the user and return false"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> newContext sender &larr; nil.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> (usedPriorities land: biton◦priority) = 0⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑self<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">INSTALL⦂ [while⦂ true do⦂ [newContext cleancopy eval]]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">AT: priority]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> user show:<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">&rsquo;PriorityScheduler unable to install at level &rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">+priority asString<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">+&rsquo;. false returned&rsquo;. ⇑false]</span></div>
<div class="line left">
<span class="small bold">run: newContext<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small bold"> at: priority<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="small italic">"replace the process at &lt;priority&gt; with &lt;newContext&gt;. If that is the currently running priority, abandon what is running and start from &lt;newContext&gt;"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> priority = currentPriority⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[sourceIndirect run: newContext]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> suspendedContexts◦priority &larr; newContext]</span></div>
<div class="line left">
<span class="small bold">swap: newContext<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small bold"> at: priority<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small bold"> with: fieldReference<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="small italic">"replace the process at &lt;priority&gt; with &lt;newContext&gt; and place the old contents in the field referred to by &lt;fieldReference&gt;"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> priority = currentPriority⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[sourceIndirect<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">swap: newContext<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">with: fieldReference]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> fieldReference value&larr; suspendedContexts◦priority.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> suspendedContexts◦priority &larr; newContext]</span></div>
<div class="line left">
<span class="small bold">terminate: priority<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="small italic">"Remove a process from the scheduler, allowing that level to be reused"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> enabledPriorities &larr; enabledPriorities land: bitoff◦priority.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> [suspendedContexts◦priority≠nil⇒[(suspendedContexts◦priority) releaseFully]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> [initialContexts◦priority≠nil⇒[(initialContexts◦priority) releaseFully]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> suspendedContexts◦priority &larr; initialContexts◦priority &larr; nil.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> awakePriorities &larr; awakePriorities land: bitoff◦priority.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> interruptedPriorities &larr; interruptedPriorities land: bitoff◦priority.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> usedPriorities &larr; usedPriorities land: bitoff◦priority.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> self reselect]</span></div>
<div class="line left">
<span class="medium bold"><br>Enable and Disable</span></div>
<div class="line left">
<span class="small bold">disable: priority<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="small italic">"Prevent the process at &lt;priority&gt; from being activated by a wakeup. Turn off the corresponding bit in enabledPriorities and check if that changes who should run"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> enabledPriorities &larr; enabledPriorities land: bitoff◦priority.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">self reselect]</span></div>
<div class="line left">
<span class="small bold">enable: priority<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="small italic">"Allow the process at &lt;priority&gt; to be activated by a wakeup. Turn on the corresponding bit in enabledPriorities and check if that changes who should run"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> enabledPriorities &larr; enabledPriorities lor: biton◦priority.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> self reselect]</span></div>
<div class="line left">
<span class="medium bold"><br>Wakeup and Sleep</span></div>
<div class="line left">
<span class="small bold">deepsleep: priority<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="small italic">"Request the process at &lt;priority&gt; to cease running and ignore any new wakeups. Turn off the corresponding bit in awakePriorities and interruptedPriorities and check if that changes who should run"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> awakePriorities &larr; awakePriorities land: bitoff◦priority.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> interruptedPriorities &larr; interruptedPriorities land: bitoff◦priority.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> self reselect]</span></div>
<div class="line left">
<span class="small bold">errorReset<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="small italic">"There has been an error. Initialize the state of the process that was running.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small italic">  If it was not the user process (priority 1), request it to cease running and<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small italic">  prevent its further running (i.e. disable it)"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> currentPriority=1⇒[self init: currentPriority]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> awakePriorities &larr; awakePriorities land: bitoff◦currentPriority.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> enabledPriorities &larr; enabledPriorities land: bitoff◦currentPriority.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> self init: currentPriority]</span></div>
<div class="line left">
<span class="small bold">reselect<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small bold"> </span><span class="small">| newPriority oldPriority newContext tempenabled tempinterrupts<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="small italic">"Switch to the highest priority enabled process"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> tempenabled &larr; self disable.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> tempinterrupts &larr; interruptedPriorities land: awakePriorities.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> awakePriorities &larr; interruptedPriorities lor: awakePriorities.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> interruptedPriorities &larr; tempinterrupts.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> newPriority &larr; (awakePriorities land: tempenabled) hibit.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> newPriority = 0⇒[enabledPriorities &larr; tempenabled. ⇑false]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> newPriority = currentPriority⇒[enabledPriorities &larr; tempenabled]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> newContext &larr; suspendedContexts◦newPriority.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> suspendedContexts◦newPriority &larr; nil.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> oldPriority &larr; currentPriority.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> currentPriority &larr; newPriority.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> enabledPriorities &larr; tempenabled.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> sourceIndirect<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">swap: newContext<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">with: (suspendedContexts ref: oldPriority)]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">primitive: 65</span></div>
<div class="line left">
<span class="small bold">reset: priority<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="small italic">"Initialize the state of the process at &lt;priority&gt; and request it to cease running"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> awakePriorities &larr; awakePriorities land: bitoff◦priority.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> self init: priority]</span></div>
<div class="line left">
<span class="small bold">resetCurrent<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="small italic">"Initialize the state of the process that is running. If it is not the<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small italic">  user process (priority 1), request it to cease running"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> currentPriority=1⇒[self init: currentPriority]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> awakePriorities &larr; awakePriorities land: bitoff◦currentPriority.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> self init: currentPriority]</span></div>
<div class="line left">
<span class="small bold">restart: priority<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="small italic">"Initialize the state of a suspended process and request it to run"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> interruptedPriorities &larr; interruptedPriorities lor: biton◦priority.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> self init: priority]</span></div>
<div class="line left">
<span class="small bold">sleep: priority<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="small italic">"Request the process at &lt;priority&gt; to cease running, if a new wakeup has arrived the process will be reawakened. Turn off the corresponding bit in awakePriorities and check if that changes who should run"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> awakePriorities &larr; awakePriorities land: bitoff◦priority.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> self reselect]</span></div>
<div class="line left">
<span class="small bold">wakeup: priority<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="small italic">"Request the process at &lt;priority&gt; to run. Turn on the corresponding bit in interruptedPriorities and check if that changes who should run"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> interruptedPriorities &larr; interruptedPriorities lor: biton◦priority.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> self reselect]</span></div>
<div class="line left">
<span class="medium bold"><br>Top level</span></div>
<div class="line left">
<span class="small bold">init1<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[UserInt &larr; Top<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">install⦂ [user restart]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">at: 1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> UserInt enable wakeup]</span></div>
<div class="line left">
<span class="small bold">init11</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">" Top terminate: 11; init11. "</span><span class="small bold"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[GRODSK &larr; Top<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">install⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[user displayoffwhile⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[user show: &rsquo;<br>Smalltalk needs more space.<br>Just a moment...&rsquo;.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">dp0 growSmalltalkBy: 100.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">user show: &rsquo;  Done.&rsquo;; cr].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">GRODSK deepsleep]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">at: 11.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">GRODSK enable]</span></div>
<div class="line left">
<span class="small bold">init8 </span><span class="small">| nw<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[CtlCInt &larr; Top<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">install⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[nw &larr; user notifier: &rsquo;Control c Interrupt&rsquo; level: 1 interrupt: true.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[nw⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[user schedule: nw.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> </span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nw takeCursor.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">nw &larr; nil.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> </span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">UserInt restart]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">CtlCInt sleep]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">at: 8.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> CtlCInt enable]</span></div>
<div class="line left">
<span class="small bold">init9  </span><span class="small">"Top terminate: 9; init9."</span><span class="small bold"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[CtlShftEscInt &larr; Top<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">install⦂ [spy abort. user restoredisplay. <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[user buttons=7⇒["dont release possible garbage"] (Top◦1) releaseFully].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">UserInt restart. CtlShftEscInt sleep]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">at: 9.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> CtlShftEscInt enable]</span></div>
<div class="line left">
<span class="small bold">initsched<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[Top &larr; self fromSource: (PriorityInterrupt new).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> self init1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> self init11.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> self init8.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> self init9.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> Top top]</span></div>
<div class="line left">
<span class="small bold">top<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="small italic">"Make this scheduler the top level one. It will receive all physical (non-Smalltalk) interrupts"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> enabledPriorities &larr; enabledPriorities lor: biton◦1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> awakePriorities &larr; awakePriorities lor: biton◦1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> currentPriority &larr; 1] primitive: 61</span></div>
<div class="line left">
<span class="medium bold"><br>Critical sections</span></div>
<div class="line left">
<span class="small bold">critical⦂ expr</span><span class="small">| t v<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="small italic">"Execute &lt;expr&gt; without allowing it to be interrupted"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> t &larr; self disable.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> v &larr; expr eval.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> enabledPriorities &larr; t.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> self reselect. ⇑v]</span></div>
<div class="line left">
<span class="medium bold"><br>Private</span></div>
<div class="line left">
<span class="small bold">disable </span><span class="small">| t<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="small italic">"This message should deffinitely be protected. Zero all the enabled flags and return the previous value of them"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> t &larr; enabledPriorities. enabledPriorities &larr; 0. ⇑t] primitive: 66</span></div>
<div class="line left">
<span class="small bold">init: priority<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small bold"> </span><span class="small">| newPriority oldPriority newContext tempenabled tempinterrupts<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="small italic">"This message should be protected. It is used by reset: and restart: to actually switch suspended processes"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> tempenabled &larr; self disable.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> tempinterrupts &larr; interruptedPriorities land: awakePriorities.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> awakePriorities &larr; interruptedPriorities lor: awakePriorities.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> interruptedPriorities &larr; tempinterrupts.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> newPriority &larr; (awakePriorities land: tempenabled) hibit max: 1.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> (newPriority = currentPriority)<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">and: (currentPriority = priority)⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[enabledPriorities &larr; tempenabled.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> sourceIndirect run: (initialContexts◦priority) cleancopy]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> suspendedContexts◦priority &larr; (initialContexts◦priority) cleancopy.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> newPriority = currentPriority⇒[enabledPriorities &larr; tempenabled.]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> newContext &larr; suspendedContexts◦newPriority.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> suspendedContexts◦newPriority &larr; nil.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> oldPriority &larr; currentPriority.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> currentPriority &larr; newPriority.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> enabledPriorities &larr; tempenabled.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> oldPriority = priority⇒<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[sourceIndirect run: newContext]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> sourceIndirect<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">swap: newContext<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">with: (suspendedContexts ref: oldPriority)]</span></div>
<div class="line left">
<span class="small bold">INSTALL⦂ newContext AT: priority<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="small italic">"This message should be protected, it is used by install:at: and install:above: to do the actual initialization of the process"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> newContext sender &larr; nil.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> usedPriorities &larr; usedPriorities lor: biton◦priority.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> initialContexts◦priority &larr; newContext.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> suspendedContexts◦priority &larr; newContext cleancopy.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> ⇑PriorityInterrupt new from: self at: priority]</span></div>
<div class="line left">
<span class="small bold">printon: s </span><span class="small">| i b2 j<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[super printon: s.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ i to: 5 do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[s cr.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">b2&larr; (usedPriorities, enabledPriorities, awakePriorities,<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">interruptedPriorities, (1 lshift: currentPriority-1))◦i base: 2.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">for⦂ j to: 16-b2 length do⦂ [s next&larr; &rsquo;0&rsquo;◦1].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">s append: b2; space;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">append: ↪(&rsquo;used&rsquo; &rsquo;enabled&rsquo; &rsquo;awake&rsquo; &rsquo;interrupted&rsquo; &rsquo;current&rsquo;)◦i]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">]</span></div>
<div class="line left">
<span class="medium bold"><br>Reclamation</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪PriorityScheduler under: &rsquo;Events&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="medium bold"><br>"Timer"</span></div>
<div class="line left">
<span class="medium bold">Class new title: &rsquo;Timer&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="medium bold">subclassof: Object<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="medium bold">fields: &rsquo;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="medium bold">activeTime</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="medium bold">"how long this Timer will be the active one"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="medium bold">nextTimer</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="medium bold">"the Timer which will fire after this one"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="medium bold">lastTimer</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="medium bold">"the Timer which will fire before this one"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="medium bold">delay</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="medium bold">"how long between setting and firing"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="medium bold">action</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="medium bold">"what happens when this timer fires"&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="medium bold">declare: &rsquo;currentTimer timerActions &rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="medium bold">asFollows</span></div>
<div class="line left">
<span class="small italic"><br>A Timer is an object which causes an action after an interval of time. The time interval is measured in units of a sixtieth of a second from when the instance was initialized with the message &lt;for: {time interval} action⦂ [{code for action}]&gt;. When the interval is over the Timer fires by placing the action on a queue to be evaluated before processing at the user level continues. There is no need to mantain a name for a Timer while it is active, but a named timer may be disabled or reused. The Timers waiting to fire form a doubly linked list whose first link is referred to by the class variable currentTimer. Each Timer knows how long it should run after the preceding Timer has fired</span></div>
<div class="line left">
<span class="medium bold"><br>Initialization</span></div>
<div class="line left">
<span class="small bold">classInit</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small italic">"Initialize the processes used by the Timers"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[timerActions &larr; Queue new of: (Vector new: 4).<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> self init16.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> self init12]</span></div>
<div class="line left">
<span class="small bold">for: delay action⦂ action<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="small italic">"Initialize a new Timer"</span><span class="small">]</span></div>
<div class="line left">
<span class="small bold">init12 </span><span class="small">| nextAction</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small italic">"Initialize the process which evals Timer actions"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[Top install⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[while⦂ true do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[while⦂ (nextAction &larr; timerActions next) do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[nextAction eval].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> Top sleep: 12]] at: 12.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> Top enable: 12]</span></div>
<div class="line left">
<span class="small bold">init16</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small italic">"Initialize the process wakened by a Timer timing out"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[Top install⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[while⦂ true do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[currentTimer fire.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> Top sleep: 16]] at: 16.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> Top enable: 16]</span></div>
<div class="line left">
<span class="small bold">reset </span><span class="small">| nextTimeout foundit<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="small italic">"Set up this Timer to add &lt;action&gt; to the Queue of remote Contexts to be evaled after an interval of &lt;delay&gt; sixtieths of a second. Find the proper place in the doubly linked list and calculate the amount of time to run after the preceeding timer fires"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> Top critical⦂ <br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[[activeTime≡nil⇒[]self disable].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> activeTime &larr; delay. nextTimer &larr; currentTimer. lastTimer &larr; nil.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> foundit &larr; false.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> until⦂ foundit do⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[nextTimer≡nil⇒[foundit &larr; true].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> (nextTimeout &larr; nextTimer activetime) &gt; activeTime⇒[foundit &larr; true].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> activeTime &larr; activeTime - nextTimeout.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> lastTimer &larr; nextTimer.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> nextTimer &larr; lastTimer nexttimer].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> [nextTimer≡nil⇒[] nextTimer insertlast: self].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> lastTimer≡nil⇒[self startup] lastTimer insertnext: self]]</span></div>
<div class="line left">
<span class="medium bold"><br>List Behavior</span></div>
<div class="line left">
<span class="small bold">deletelast<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="small italic">"Delete the Timer before this one. When deleting a Timer, the activeTime of the Timer after it must be increased by its activeTime"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> activeTime &larr; activeTime + lastTimer activetime.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> (lastTimer &larr; lastTimer lasttimer)≡nil⇒[self startup]]</span></div>
<div class="line left">
<span class="small bold">deletenext<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="small italic">"Delete the Timer after this one"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> nextTimer &larr; nextTimer nexttimer]</span></div>
<div class="line left">
<span class="small bold">insertlast: lastTimer<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="small italic">"Insert a new Timer before this one. When inserting a Timer in front of another, the activeTime of the later one must be reduced so it is the amount of time after the new Timers firing"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> activeTime &larr; self activetime - lastTimer activetime]</span></div>
<div class="line left">
<span class="small bold">insertnext: nextTimer</span></div>
<div class="line left">
<span class="small bold">lasttimer<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑lastTimer]</span></div>
<div class="line left">
<span class="small bold">nexttimer<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[⇑nextTimer]</span></div>
<div class="line left">
<span class="small bold">release </span><span class="small">[lastTimer &larr; nil. nextTimer &larr; nil. action &larr; nil]</span></div>
<div class="line left">
<span class="medium bold"><br>Timing Behavior</span></div>
<div class="line left">
<span class="small bold">activetime<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="small italic">"If this is the current Timer return the time until it fires, otherwise return activeTime"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> ⇑activeTime] primitive: 96</span></div>
<div class="line left">
<span class="small bold">disable</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small italic">"Remove this timer from the list"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[Top critical⦂<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[[self≡currentTimer and⦂ nextTimer≡nil⇒[self shutoff. Top deepsleep: 16]].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> [lastTimer≡nil⇒[] lastTimer deletenext].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> [nextTimer≡nil⇒[] nextTimer deletelast].<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> activeTime &larr; nil. lastTimer &larr; nil. nextTimer &larr; nil]]</span></div>
<div class="line left">
<span class="small bold">fire</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small italic">"Time is up, add the action to the Queue to be evaled"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[timerActions next&larr; action.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> Top wakeup: 12.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> activeTime &larr; nil.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> lastTimer &larr; nil.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> nextTimer≡nil⇒[self shutoff]<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> nextTimer startup.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> nextTimer &larr; nil]</span></div>
<div class="line left">
<span class="small bold">primstartup<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small italic">"this message informs the virtual machine that this is the next Timer to fire"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[] primitive: 95</span></div>
<div class="line left">
<span class="small bold">shutoff<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="small italic">"this message informs the virtual machine and class Timer that there are no more Timers to fire"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> currentTimer &larr; nil] primitive: 97</span></div>
<div class="line left">
<span class="small bold">startup<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="small italic">"make this the next Timer to fire"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> lastTimer &larr; nil.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> currentTimer &larr; self.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small"> self primstartup]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪Timer under: &rsquo;Events&rsquo;.</span></div>
<div class="line left">
<span class="small">Timer classInit</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="medium bold"><br>"UserEvent"</span></div>
<div class="line left">
<span class="medium bold">Class new title: &rsquo;UserEvent&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="medium bold">subclassof: Point<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="medium bold">fields: &rsquo;type stroke elapsed time&rsquo;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="medium bold">declare: &rsquo;&rsquo;;<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="medium bold">asFollows</span></div>
<div class="line left">
<span class="small italic"><br>This class is used by the Events queue (updated in the 60HZ interrupt routine) to package up and return an event every time the queue is popped.  The class provides easy access to various parts of the event.  Users may create their own events by pushing onto the Events queue, which is why the Initialization here is classified as private.</span></div>
<div class="line left">
<span class="medium bold"><br>Initialization</span></div>
<div class="line left">
<span class="small bold">x: x y: y type: type stroke: stroke elapsed: elapsed time: time <br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small italic">"make an event, usually called from EventQueue"</span><span class="small"><br></span></div>
<div class="line left">
<span class="medium bold"><br>Public Access</span></div>
<div class="line left">
<span class="small bold">elapsed </span><span class="small italic">"return an event stroke"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="small italic">"1 - 32767 sixtieths of second since previous non-time-elapsed event recorded"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑elapsed]</span></div>
<div class="line left">
<span class="small bold">isKbdDown<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">["if stroke a down stroke and not keyset or mouse button, return it,<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">otherwise return false"<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">type ≠ 1 ⇒ [⇑false] ⇑stroke &gt; 16]</span></div>
<div class="line left">
<span class="small bold">stroke </span><span class="small italic">"return an event stroke"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="small italic">"0-2 = top,middle,bottom mouse buttons, 3-7 = keyset left to right, 8-255 = keyboard"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑stroke]</span></div>
<div class="line left">
<span class="small bold">time </span><span class="small italic">"return an event stroke"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="small italic">"1 - 32767 sixtieths of second since Events time reset"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑time]</span></div>
<div class="line left">
<span class="small bold">type </span><span class="small italic">"return event type"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">[</span><span class="small italic">"2 = upstroke event, 1 = downstroke event, 0 = time-elapsed event"</span><span class="small"><br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="small">⇑type]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪UserEvent under: &rsquo;Events&rsquo;.</span></div>
  </body>
</html>
