<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN">
<html>
  <head>
    <meta http-equiv="Content-type" content="text/html;charset=UTF-8">
    <title>bootstrap2.st</title>
	<link rel="stylesheet" type="text/css" href="../font.css"/>
  </head>
  <body>
    <div class="line center">
<span class="small">↪</span><span class="medium bold">READ ROUTINE</span><span class="small">↪</span></div>
<div class="line left">
<span class="small">Smalltalk define "Readerstuff as "Readerstuff &larr; SymbolTable new.<br>Readerstuff insertall: "(typetable scantable dot<br></span><span class="tab"></span><span class="small">separ letter digit notapos notcomnt notcr).<br></span><span class="medium bold"><br>Class new title: &rsquo;Reader&rsquo;;<br></span><span class="tab"></span><span class="medium bold">fields: &rsquo;source sink token nextchar typetbl scantbl&rsquo;</span><span class="small">;<br></span><span class="tab"></span><span class="medium bold">sharing: &rsquo;Readerstuff&rsquo;<br></span><span class="small">Reader understands: &rsquo;</span><span class="small underline">of:</span><span class="small"> source<br></span><span class="tab"></span><span class="small">[typetbl &larr; typetable.  scantbl &larr; scantable.<br></span><span class="tab"></span><span class="small">sink &larr; (Vector new: 10) asStream. token &larr; Stream default.<br></span><span class="tab"></span><span class="small">self step]&rsquo;<br>Reader understands: &rsquo;</span><span class="small underline">step</span><span class="small"><br></span><span class="tab"></span><span class="small">[nextchar &larr; source next]&rsquo;</span><span class="tab"></span><span class="tab"></span><span class="small">↪</span><span class="small italic">nextchar avoids backing up</span><span class="small">↪<br>Reader understands: &rsquo;</span><span class="small underline">read</span><span class="small"> | x <br></span><span class="tab"></span><span class="small">[while⦂ nextchar do⦂<br></span><span class="tab"></span><span class="tab"></span><span class="small">[x &larr; typetbl◦(nextchar+1).<br></span><span class="tab"></span><span class="tab"></span><span class="small">x=1? [self scan: separ];</span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">↪</span><span class="small italic">separators</span><span class="small">↪<br></span><span class="tab"></span><span class="tab"></span><span class="small">=2? [sink next &larr; (self scan: letter+digit) unique];</span><span class="tab"></span><span class="small">↪</span><span class="small italic">identifiers</span><span class="small">↪<br></span><span class="tab"></span><span class="tab"></span><span class="small">=3? [sink next &larr; (self scan: 0) unique]; ↪</span><span class="small italic">1-char tokens</span><span class="small">↪<br></span><span class="tab"></span><span class="tab"></span><span class="small">=4? [sink next &larr; self rdnum. dot?[sink next&larr; ".]];</span><span class="tab"></span><span class="small">↪</span><span class="small italic">Numbers</span><span class="small">↪<br></span><span class="tab"></span><span class="tab"></span><span class="small">=5? [sink next &larr; self rdstr];</span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">↪</span><span class="small italic">Strings</span><span class="small">↪<br></span><span class="tab"></span><span class="tab"></span><span class="small">=6? [self step. sink next &larr; self subread];</span><span class="tab"></span><span class="small">↪</span><span class="small italic">sub-Vectors</span><span class="small">↪<br></span><span class="tab"></span><span class="tab"></span><span class="small">=7? [self step. !sink contents];</span><span class="tab"></span><span class="small">↪</span><span class="small italic">close-paren</span><span class="small">↪<br></span><span class="tab"></span><span class="tab"></span><span class="small">=8? [self rdcom];</span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">↪</span><span class="small italic">comments</span><span class="small">↪<br></span><span class="tab"></span><span class="tab"></span><span class="small">=9? [self scan: notcr];</span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">↪</span><span class="small italic">&uarr;Z format runs</span><span class="small">↪<br></span><span class="tab"></span><span class="tab"></span><span class="small">=10? [!sink contents];</span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">↪</span><span class="small italic">null and DOIT</span><span class="small">↪<br></span><span class="tab"></span><span class="tab"></span><span class="small">]<br></span><span class="tab"></span><span class="small">!sink contents]&rsquo;<br>Reader understands: &rsquo;</span><span class="small underline">scan:</span><span class="small"> mask | x<br></span><span class="tab"></span><span class="small">[mask=0 ?[x &larr; String new: 1. x◦1 &larr; nextchar. self step. !x]<br></span><span class="tab"></span><span class="small">token reset.<br></span><span class="tab"></span><span class="small">while⦂ nextchar do⦂<br></span><span class="tab"></span><span class="tab"></span><span class="small">[(mask land: scantbl◦(nextchar+1))=0? [!token contents]<br></span><span class="tab"></span><span class="tab"></span><span class="small">token next &larr; nextchar. nextchar &larr; source next]<br></span><span class="tab"></span><span class="small">!token contents]&rsquo;<br>Reader understand</span><span class="small underline">s: &rsquo;sub</span><span class="small">read | a b <br></span><span class="tab"></span><span class="small">[a &larr; sink.  sink &larr; (Vector new: 10) asStream.<br></span><span class="tab"></span><span class="small">b &larr; self read.  sink &larr; a.  !b]&rsquo;<br>Reader understand</span><span class="small underline">s: &rsquo;r</span><span class="small">dnum | sign val d <br></span><span class="tab"></span><span class="small">[sign &larr; [nextchar=025? [self step. ¬1] 1</span><span class="small italic">].</span><span class="tab"></span><span class="small italic">↪</span><span class="small">sign↪<br></span><span class="tab"></span><span class="small">d &larr; [nextchar=060? [8] 10].</span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small italic">↪</span><span class="small">base↪<br></span><span class="tab"></span><span class="small">val &larr; self mknum: (self scan: digit) base: </span><span class="small italic">d.</span><span class="tab"></span><span class="small italic">↪integer </span><span class="small">part↪<br></span><span class="tab"></span><span class="small">dot &larr; false.<br></span><span class="tab"></span><span class="small">nextchar=056</span><span class="small italic">?</span><span class="tab"></span><span class="tab"></span><span class="small italic">↪check for decimal p</span><span class="small">oint↪<br></span><span class="tab"></span><span class="tab"></span><span class="small">[self step.<br></span><span class="tab"></span><span class="tab"></span><span class="small">nextchar isdigit≡false?<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">[dot &larr; true. !sign*val</span><span class="small italic">]</span><span class="tab"></span><span class="tab"></span><span class="small italic">↪was &lt;Integer</span><span class="small">&gt; .  ↪<br></span><span class="tab"></span><span class="tab"></span><span class="small">d &larr; self scan: digit.<br></span><span class="tab"></span><span class="tab"></span><span class="small">val &larr; (self mknum: d base: 10)asFloat / (10.0 ipow: d length) + val.<br></span><span class="tab"></span><span class="tab"></span><span class="small">nextchar=0145</span><span class="small italic">?</span><span class="tab"></span><span class="tab"></span><span class="small italic">↪check for e&lt;expon</span><span class="small">ent&gt; ↪<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">[self step.  !val*(10.0 ipow: self rdnum)*sign]<br></span><span class="tab"></span><span class="tab"></span><span class="small">!val*sign]<br> </span><span class="tab"></span><span class="small">!sign*val]&rsquo;<br>Reader understand</span><span class="small underline">s: &rsquo;mk</span><span class="small">num: </span><span class="small underline">str b</span><span class="small">ase: base | val c <br></span><span class="tab"></span><span class="small">[val &larr; [str length&gt;4? [0.0] 0].<br></span><span class="tab"></span><span class="small">for⦂ c from: str do⦂<br></span><span class="tab"></span><span class="tab"></span><span class="small">[val &larr; val*base + (c-060)]<br> </span><span class="tab"></span><span class="small">!val]&rsquo;<br>Reader understand</span><span class="small underline">s: &rsquo;r</span><span class="small">dstr | a <br></span><span class="tab"></span><span class="small">[self step. a &larr; self scan: notapos.<br></span><span class="tab"></span><span class="small">nextchar ≡ false? [user notify: &rsquo;&rsquo;Unmatched String quote&rsquo;&rsquo;]<br></span><span class="tab"></span><span class="small">self step.<br></span><span class="tab"></span><span class="small">nextchar=04</span><span class="small italic">7?</span><span class="tab"></span><span class="small italic">↪imbedded String-q</span><span class="small">uote↪<br></span><span class="tab"></span><span class="tab"></span><span class="small">[token next &larr; 047. a&larr; token contents<br></span><span class="tab"></span><span class="tab"></span><span class="small">!a + self rdstr]<br></span><span class="tab"></span><span class="small">!a]&rsquo;<br>Reader understand</span><span class="small underline">s: &rsquo;r</span><span class="small">dcom <br></span><span class="tab"></span><span class="small">[self step.  self scan: notcomnt.<br></span><span class="tab"></span><span class="small">nextchar≡false? [user notify: &rsquo;&rsquo;Unmatched comment quote&rsquo;&rsquo;]<br></span><span class="tab"></span><span class="small">self step]&rsquo;<br><br>"Readerinit &larr; function (type bit asc1 asc2 typetbl scantbl i)</span><span class="tab"></span><span class="tab"></span><span class="small">↪init read tables in-line↪<br></span><span class="tab"></span><span class="small">("type &larr; :. "bit &larr; ⦂. (bit=0?() "bit &larr; Readerstuff◦bit).<br></span><span class="tab"></span><span class="small">"asc1 &larr; :. "asc2 &larr; (%to?(:) asc1).<br></span><span class="tab"></span><span class="small">"typetbl &larr; Readerstuff◦"typetable. "scantbl &larr; Readerstuff◦"scantable.<br></span><span class="tab"></span><span class="small">(type=0?() for i&larr; asc1+1 to asc2+1 do (typetbl[i]   &larr; type)).<br></span><span class="tab"></span><span class="small">for i&larr; asc1+1 to asc2+1 do<br></span><span class="tab"></span><span class="tab"></span><span class="small">(scantbl[i] &larr; scantbl[i] &- bit)<br></span><span class="tab"></span><span class="small">Readerstuff◦"typetable set typetbl. Readerstuff◦"scantable set scantbl.<br></span><span class="tab"></span><span class="small">!nil).<br>Readerstuff insertall: "(separ letter digit notapos notcr notcomnt)<br></span><span class="tab"></span><span class="small">with: "(1 2 4 8 16 32).<br>Readerstuff define "typetable as string 256.<br>Readerstuff◦"typetable[1 to 256] &larr; all 3.</span><span class="tab"></span><span class="tab"></span><span class="small">↪1-char tokens↪<br>Readerstuff define "scantable as string 256.<br>Readerstuff◦"scantable[1 to 256] &larr; all 8+16+32.<br>Readerinit 0  notcr  015. ↪cr↪<br>Readerinit 1  separ  011  ↪separators: tab, ↪<br>Readerinit 1  separ  012  ↪ LF, ↪<br>Readerinit 1  separ  014  ↪ FF, ↪<br>Readerinit 1  separ  015  ↪ CR, ↪<br>Readerinit 1  separ  040  ↪ blank ↪<br>Readerinit 2  letter  0101 to 0132  ↪letters↪<br>Readerinit 2  letter  0141 to 0172</span><span class="tab"></span><span class="small">↪lower-case↪<br>Readerinit 3  letter  072</span><span class="tab"></span><span class="small">↪colon↪<br>Readerinit 3  letter  03</span><span class="tab"></span><span class="tab"></span><span class="small">↪open colon↪<br>Readerinit 4  digit  060 to 071  ↪digits↪<br>Readerinit 4  0  025  ↪high-minus↪<br>Readerinit 5  notapos  047  ↪String-quote↪<br>Readerinit 6  0  050  ↪left-paren↪<br>Readerinit 7  0  051  ↪close-paren↪<br>Readerinit 8  notcomnt  017  ↪comments↪<br>Readerinit 9  0  032 ↪&uarr;Z format runs↪<br>Readerinit 10  0  036  ↪null and DO</span><span class="small">IT↪<br></span></div>
<div class="line center">
<span class="small"><br></span><span class="small">↪</span><span class="medium bold">BYTE COMPILER</span><span class="small">↪</span></div>
<div class="line left">
<span class="small">Smalltalk define "Compilerstuff as "Compilerstuff &larr; SymbolTable new.<br>Compilerstuff insertall: "(cdict opdict initcdict initopdict selector nargs ntemps maxtemp<br></span><span class="tab"></span><span class="tab"></span><span class="small">environment literals precode stack maxstack canoptpop).<br>Compilerstuff define "trace as false<br>Compilerstuff insertall: "(instcode tempcode litcode liticode areccode constcode selfcode nilcode<br></span><span class="tab"></span><span class="tab"></span><span class="small">smashpcode smashcode popcode returncode endcode curcode supercode<br></span><span class="tab"></span><span class="tab"></span><span class="small">shortjmp shortbfp jmpcode bfpcode minopcode opcode)<br></span><span class="tab"></span><span class="small">with: "(0 16 32 64 112 120 113 125<br></span><span class="tab"></span><span class="tab"></span><span class="small">128 129 130 131 132 133 134<br></span><span class="tab"></span><span class="tab"></span><span class="small">144 152 160 168 176 208).<br></span><span class="medium bold"><br>Class new title: &rsquo;Compiler&rsquo;;<br></span><span class="tab"></span><span class="medium bold">fields: &rsquo;source code cascading stackused fixups&rsquo;</span><span class="small">;<br></span><span class="tab"></span><span class="medium bold">sharing: &rsquo;Compilerstuff&rsquo;<br></span><span class="small">Compiler understands: &rsquo;</span><span class="small underline">compile:</span><span class="small"> b </span><span class="small underline">in:</span><span class="small"> class | a c i t<br></span><span class="tab"></span><span class="small">[self init: class.  a &larr; b asVector asStream.<br></span><span class="tab"></span><span class="small">self compilepattern: a.</span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">↪pattern and decls↪<br></span><span class="tab"></span><span class="small">self compileblock: a. self push.</span><span class="tab"></span><span class="tab"></span><span class="small">↪Smalltalk code↪<br></span><span class="tab"></span><span class="small">[self nofixups?[]</span><span class="tab"></span><span class="small">↪no redundant return↪<br></span><span class="tab"></span><span class="tab"></span><span class="small">[stack=maxstack?[self popopt]].<br></span><span class="tab"></span><span class="tab"></span><span class="small">code next&larr; selfcode. code next&larr; returncode].<br></span><span class="tab"></span><span class="small">[<br></span><span class="tab"></span><span class="small">c &larr; [a %"primitive: ?[a next] 0].</span><span class="tab"></span><span class="small">↪primitive: &lt;integer&gt; clause↪<br></span><span class="tab"></span><span class="small">a&larr; self qcodeck: c ? []</span><span class="tab"></span><span class="tab"></span><span class="small">↪ckeck for rd/wrt accessors↪<br></span><span class="tab"></span><span class="small">a &larr; Stream default.</span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">↪now make up code object↪<br></span><span class="tab"></span><span class="small">a next&larr; 0; next&larr; c; next&larr; maxtemp+maxstack.</span><span class="tab"></span><span class="tab"></span><span class="small">↪header↪<br></span><span class="tab"></span><span class="small">a next&larr; nargs; next&larr; maxtemp; next&larr; 6+(2*literals length).<br></span><span class="tab"></span><span class="small">for⦂ i from: literals do⦂</span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">↪literals↪<br></span><span class="tab"></span><span class="tab"></span><span class="small">[a next&larr; i PTR lshift: ¬8; next&larr; i PTR land: 0377]<br></span><span class="tab"></span><span class="small">a append: precode contents; append: code contents.</span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">↪code body↪<br></span><span class="tab"></span><span class="small">].<br></span><span class="tab"></span><span class="small">class install: selector<br></span><span class="tab"></span><span class="tab"></span><span class="small">method: (code&larr;a contents) literals: [literals length&gt;0?[literals] nil]<br></span><span class="tab"></span><span class="tab"></span><span class="small">code: b backpointers: nil.<br></span><span class="tab"></span><span class="small">!selector]&rsquo;<br>Compiler understands: &rsquo;</span><span class="small underline">qcodeck:</span><span class="small"> t | a b i</span><span class="tab"></span><span class="tab"></span><span class="small">↪fast read/write accessors↪<br></span><span class="tab"></span><span class="small">[t≠0?[!false] code loc≠2?[!false]<br></span><span class="tab"></span><span class="small">a &larr; Stream default. a next&larr; 0.<br></span><span class="tab"></span><span class="small">code◦2≠returncode? [!false]<br></span><span class="tab"></span><span class="small">code◦1≠selfcode?<br></span><span class="tab"></span><span class="tab"></span><span class="small">[code◦1&lt;tempcode?<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">[precode empty?<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">[a next&larr; 40; next&larr; 0; next&larr; 0; next&larr; code◦1. !a]</span><span class="tab"></span><span class="small">↪quick !inst var↪<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">!false]<br></span><span class="tab"></span><span class="tab"></span><span class="small">!false]<br></span><span class="tab"></span><span class="small">precode empty?[a next&larr; 1. !a]</span><span class="tab"></span><span class="tab"></span><span class="small">↪quick !self↪<br></span><span class="tab"></span><span class="small">b &larr; precode contents. nargs≠b length/3?[!false]<br></span><span class="tab"></span><span class="small">a next&larr; 41; next&larr; 0; next&larr;  b length/3.<br></span><span class="tab"></span><span class="small">for⦂ i from: (3 to: b length by: 3) do⦂<br></span><span class="tab"></span><span class="tab"></span><span class="small">[b◦i&lt;tempcode?[a next&larr; b◦i] !false]</span><span class="tab"></span><span class="tab"></span><span class="small">↪write inst vars↪<br></span><span class="tab"></span><span class="small">!a]&rsquo;<br>Compiler understands: &rsquo;</span><span class="small underline">init:</span><span class="small"> class | a i<br></span><span class="tab"></span><span class="small">[environment &larr; class environment.<br></span><span class="tab"></span><span class="small">[initcdict≡nil?</span><span class="tab"></span><span class="tab"></span><span class="small">↪initial symbol defs↪<br></span><span class="tab"></span><span class="tab"></span><span class="small">[initcdict &larr; Dictionary new init: 16.<br></span><span class="tab"></span><span class="tab"></span><span class="small">initcdict insertall: "(self thisContext super nil false true)<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">with: "(113 133 134 125 126 127).<br></span><span class="tab"></span><span class="tab"></span><span class="small">initopdict &larr; Dictionary new init: 64.<br></span><span class="tab"></span><span class="tab"></span><span class="small">initopdict insertall: "(+ - &lt; &gt; ≤ ≥ = ≠<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">* / \ | min: max: land: lor:<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">◦ '&#771;&rsquo;◦&larr;&rsquo;&rsquo;atomize) next '&#771;&rsquo;next&larr;&rsquo;&rsquo;atomize) length ≡<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">class and: or: new new: to: oneToMeAsStream asStream)<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">with: "(176 177 178 179 180 181 182 183<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">184 185 186 187 188 189 190 191<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">192 193 194 195 196 197<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">200 201 202 203 204 205 206 207)] ].<br></span><span class="tab"></span><span class="small">cdict &larr; Dictionary new copyfrom: initcdict.<br></span><span class="tab"></span><span class="small">opdict &larr; Dictionary new copyfrom: initopdict.<br></span><span class="tab"></span><span class="small">a &larr; class instvars. for⦂ i to: a length do⦂<br></span><span class="tab"></span><span class="tab"></span><span class="small">[cdict insert: a◦i with: instcode+i-1].<br></span><span class="tab"></span><span class="small">stack&larr; ntemps&larr; maxtemp&larr; 0. maxstack&larr; 1.<br></span><span class="tab"></span><span class="small">precode &larr; Stream default.<br></span><span class="tab"></span><span class="small">literals &larr; Vector new: 0]&rsquo;<br><br>Compiler understands: &rsquo;</span><span class="small underline">compilepattern:</span><span class="small"> a | c<br></span><span class="tab"></span><span class="small">[ntemps &larr; 0. selector &larr; a peek.<br></span><span class="tab"></span><span class="small">[selector iskeyword?</span><span class="tab"></span><span class="tab"></span><span class="small">↪selector and args↪<br></span><span class="tab"></span><span class="tab"></span><span class="small">[c &larr; nullString.<br></span><span class="tab"></span><span class="tab"></span><span class="small">until⦂ [a end or: a peek iskeyword ≡ false] do⦂</span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">↪keywords↪<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">[c &larr; c+ a next.<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">self compilearg: a next]<br></span><span class="tab"></span><span class="tab"></span><span class="small">selector &larr; c unique]<br></span><span class="tab"></span><span class="small">a next.<br></span><span class="tab"></span><span class="small">selector isinfix?</span><span class="tab"></span><span class="tab"></span><span class="small">↪infix↪<br></span><span class="tab"></span><span class="tab"></span><span class="small">[self compilearg: a next]<br></span><span class="tab"></span><span class="small">].<br></span><span class="tab"></span><span class="small">[a % "&larr; ?</span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">↪possible &larr; phrase↪<br></span><span class="tab"></span><span class="tab"></span><span class="small">[selector &larr; (selector + &rsquo;&rsquo;&larr;&rsquo;&rsquo;) unique.<br></span><span class="tab"></span><span class="tab"></span><span class="small">self compilearg: a next]<br></span><span class="tab"></span><span class="small">].<br></span><span class="tab"></span><span class="small">nargs &larr; ntemps.<br></span><span class="tab"></span><span class="small">a % "| ?</span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">↪further temp declarations↪<br></span><span class="tab"></span><span class="tab"></span><span class="small">[until⦂ [a end or: "[=a peek] do⦂<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">[self compiletemp: a next]]]&rsquo;<br>Compiler understands: &rsquo;</span><span class="small underline">compilearg:</span><span class="small"> a | b<br></span><span class="tab"></span><span class="small">[b &larr; self newtemp.<br></span><span class="tab"></span><span class="small">cdict has: a?<br></span><span class="tab"></span><span class="tab"></span><span class="small">[precode next&larr; b.</span><span class="tab"></span><span class="tab"></span><span class="small">↪compile assignments↪<br></span><span class="tab"></span><span class="tab"></span><span class="small">precode next&larr; smashpcode.</span><span class="tab"></span><span class="tab"></span><span class="small">↪for non-temp args↪<br></span><span class="tab"></span><span class="tab"></span><span class="small">precode next&larr; cdict◦a.  maxstack &larr; 1]<br></span><span class="tab"></span><span class="small">cdict insert: a with: b]&rsquo;<br>Compiler understands: &rsquo;</span><span class="small underline">compiletemp:</span><span class="small"> a | b<br></span><span class="tab"></span><span class="small">[b &larr; self newtemp.<br></span><span class="tab"></span><span class="small">cdict has: a?<br></span><span class="tab"></span><span class="tab"></span><span class="small">[user notify: &rsquo;&rsquo;temp name used elsewhere: &rsquo;&rsquo;+a asString]<br></span><span class="tab"></span><span class="small">cdict insert: a with: b]&rsquo;<br>Compiler understands: &rsquo;</span><span class="small underline">newtemp</span><span class="small"><br></span><span class="tab"></span><span class="small">[maxtemp &larr; maxtemp max: (ntemps &larr; ntemps+1).<br></span><span class="tab"></span><span class="small">!tempcode + ntemps-1]&rsquo;<br><br>Compiler understands: &rsquo;</span><span class="small underline">compileblock:</span><span class="small"> source | a b c inblock<br></span><span class="tab"></span><span class="small">[cascading &larr; false.<br></span><span class="tab"></span><span class="small">code &larr; Stream default. fixups &larr; (Vector new: 0) asStream.<br></span><span class="tab"></span><span class="small">source end?[!nullString] a &larr; stack.<br></span><span class="tab"></span><span class="small">[source %"[? [] <br></span><span class="tab"></span><span class="tab"></span><span class="small">user notify: &rsquo;&rsquo;[ missing before: &rsquo;&rsquo;+source peek asString].<br></span><span class="tab"></span><span class="small">while⦂ inblock do⦂<br></span><span class="tab"></span><span class="tab"></span><span class="small">[source end?[user notify: &rsquo;&rsquo;unbalanced brackets&rsquo;&rsquo;]<br></span><span class="tab"></span><span class="tab"></span><span class="small">source %"] ?[code next&larr; nilcode. self push. inblock &larr; false]<br></span><span class="tab"></span><span class="tab"></span><span class="small">source %"! ?[code append: (self compileexpr: source). self push.<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">code next&larr; returncode. source %". . source %"] ?[inblock &larr; false]<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small"> user show:  &rsquo;&rsquo;junk following return stmt&rsquo;&rsquo;. <br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">inblock &larr; false]<br></span><span class="tab"></span><span class="tab"></span><span class="small">self controlstmt ?[self uncascade. source %".]<br></span><span class="tab"></span><span class="tab"></span><span class="small">canoptpop &larr; true.<br></span><span class="tab"></span><span class="tab"></span><span class="small">code append: [cascading?[self compilecascade: source]<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">self compileexpr: source]. self push.<br></span><span class="tab"></span><span class="tab"></span><span class="small">source %"] ?[inblock &larr; false]<br></span><span class="tab"></span><span class="tab"></span><span class="small">source %"? ?[self pop. c &larr; Compiler new.<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">b &larr; c compileblock: source.<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">[source %"; ?[self cascade]<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">self uncascade. source %".].<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">c nofixups?<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">[code append: (self encodejmp: bfpcode by: b length); append: b]<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">fixups next&larr; code contents; next&larr; b. code reset]<br></span><span class="tab"></span><span class="tab"></span><span class="small">[source %"; ?[self cascade]<br></span><span class="tab"></span><span class="tab"></span><span class="small">self uncascade.  source %".?[]<br></span><span class="tab"></span><span class="tab"></span><span class="small"> user show: &rsquo;&rsquo;per missing before: &rsquo;&rsquo;+source peek asString ].<br></span><span class="tab"></span><span class="tab"></span><span class="small">self pop. self popopt]</span><span class="tab"></span><span class="tab"></span><span class="small">↪period pops stack↪<br></span><span class="tab"></span><span class="small">self pop. stack≠a?[user notify: &rsquo;&rsquo;unbalanced stack&rsquo;&rsquo;]<br></span><span class="tab"></span><span class="small">fixups empty? [!code contents] canoptpop&larr;false.<br></span><span class="tab"></span><span class="small">self fixup: code contents and: fixups contents.<br></span><span class="tab"></span><span class="small">!code contents]&rsquo;<br>Compiler understands: &rsquo;</span><span class="small underline">popopt</span><span class="small"> | t</span><span class="tab"></span><span class="tab"></span><span class="small">↪</span><span class="small italic">append pop and optimize</span><span class="small">↪<br></span><span class="tab"></span><span class="small">[2&gt;(t&larr;code loc)?[t=1?[code skip: ¬1]]<br></span><span class="tab"></span><span class="small">canoptpop≡false? [code next&larr; popcode]<br></span><span class="tab"></span><span class="small">code◦t=nilcode?</span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">↪</span><span class="small italic">jmp1-nil-pop -&gt; pop</span><span class="small">↪<br></span><span class="tab"></span><span class="tab"></span><span class="small">[[code◦(t-1)=shortjmp?[code skip: ¬2]]. code next&larr; popcode]<br></span><span class="tab"></span><span class="small">code◦(t-1)=smashcode?<br></span><span class="tab"></span><span class="tab"></span><span class="small">[code◦(t-1) &larr; smashpcode]</span><span class="tab"></span><span class="small">↪</span><span class="small italic">sto-var-pop -&gt; stopop var</span><span class="small">↪<br></span><span class="tab"></span><span class="small">code next&larr; popcode]&rsquo;<br>Compiler understands: &rsquo;</span><span class="small underline">cascade</span><span class="small"> | t<br></span><span class="tab"></span><span class="small">[cascading?[]</span><span class="tab"></span><span class="tab"></span><span class="small">↪</span><span class="small italic">cascading is either false</span><span class="small">↪<br></span><span class="tab"></span><span class="small">(t &larr; code◦code loc)&lt;minopcode?<br></span><span class="tab"></span><span class="tab"></span><span class="small">[user notify: &rsquo;&rsquo;improper cascading [...;].&rsquo;&rsquo;]<br></span><span class="tab"></span><span class="small">code◦(code loc-1)&lt;areccode?<br></span><span class="tab"></span><span class="tab"></span><span class="small">[cascading &larr; code◦(code loc-1)]</span><span class="tab"></span><span class="tab"></span><span class="small">↪</span><span class="small italic">or = temp code for receiver</span><span class="small">↪<br></span><span class="tab"></span><span class="small">code skip: ¬1. code next&larr; smashcode.</span><span class="tab"></span><span class="tab"></span><span class="small">↪</span><span class="small italic">alloc temp if not simple</span><span class="small">↪<br></span><span class="tab"></span><span class="small">code next&larr; cascading &larr; self newtemp. code next&larr; t]&rsquo;<br>Compiler understands: &rsquo;</span><span class="small underline">uncascade</span><span class="small"><br></span><span class="tab"></span><span class="small">[cascading?[cascading&lt;areccode?[cascading &larr; false]<br></span><span class="tab"></span><span class="tab"></span><span class="small">ntemps &larr; ntemps-1. cascading &larr; false]]&rsquo;<br>Compiler understands: &rsquo;</span><span class="small underline">nofixups</span><span class="tab"></span><span class="small">↪</span><span class="small italic">!true if no jmpout needed</span><span class="small">↪<br></span><span class="tab"></span><span class="small">[fixups empty?</span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">↪...meaning no internal branches↪<br></span><span class="tab"></span><span class="tab"></span><span class="small">[code loc=0?[!false]  !code◦code loc=returncode]</span><span class="tab"></span><span class="small">↪AND ends with !↪<br></span><span class="tab"></span><span class="small">!false]&rsquo;<br>Compiler understands: &rsquo;</span><span class="small underline">fixup:</span><span class="small"> a </span><span class="small underline">and:</span><span class="small"> b | c i t<br></span><span class="tab"></span><span class="tab"></span><span class="small">↪b◦odd=main code, c◦odd &larr; bfp around consequents,<br></span><span class="tab"></span><span class="tab"></span><span class="small">b◦even=consequents, c◦even &larr; jmp to end↪<br></span><span class="tab"></span><span class="small">[c &larr; Vector new: b length. t &larr; a length.<br></span><span class="tab"></span><span class="small">for⦂ i from: (b length-1 to: 1 by: ¬2) do⦂</span><span class="tab"></span><span class="tab"></span><span class="small">↪compute the jumps↪<br></span><span class="tab"></span><span class="tab"></span><span class="small">[c◦(i+1) &larr; self encodejmp: jmpcode by: t.<br></span><span class="tab"></span><span class="tab"></span><span class="small">c◦i &larr; self encodejmp: bfpcode by: ((b◦(i+1)) length+(c◦(i+1)) length).<br></span><span class="tab"></span><span class="tab"></span><span class="small">t &larr; t+(b◦i) length+(b◦(i+1)) length+(c◦i) length+(c◦(i+1)) length]<br></span><span class="tab"></span><span class="small">code reset. for⦂ i to: b length do⦂</span><span class="tab"></span><span class="tab"></span><span class="small">↪collate all back into code↪<br></span><span class="tab"></span><span class="tab"></span><span class="small">[code append: b◦i; append: c◦i]<br></span><span class="tab"></span><span class="small">code append: a]&rsquo;<br>Compiler understands: &rsquo;</span><span class="small underline">controlstmt</span><span class="small"><br></span><span class="tab"></span><span class="small">[source %"for⦂ ?[self compilefor]<br></span><span class="tab"></span><span class="small">source %"until⦂ ?[self compileuntil: true]<br></span><span class="tab"></span><span class="small">source %"while⦂ ?[self compileuntil: false]<br></span><span class="tab"></span><span class="small">!false]&rsquo;<br>Compiler understands: &rsquo;</span><span class="small underline">compilefactor:</span><span class="small"> s [!self compilephrase: 1 from: s]&rsquo;<br>Compiler understands: &rsquo;</span><span class="small underline">compileterm:</span><span class="small"> s [!self compilephrase: 2 from: s]&rsquo;<br>Compiler understands: &rsquo;</span><span class="small underline">compileexpr:</span><span class="small"> s [!self compilephrase: 3 from: s]&rsquo;<br>Compiler understands: &rsquo;</span><span class="small underline">compilecascade:</span><span class="small"> s [!self compilephrase: 4 from: s]&rsquo;<br>Compiler understands: &rsquo;</span><span class="small underline">compilephrase:</span><span class="small"> level </span><span class="small underline">from:</span><span class="small"> input | a b c i t stk more<br></span><span class="tab"></span><span class="small">[a &larr; Stream default.<br></span><span class="tab"></span><span class="tab"></span><span class="small">[level=4? [a next&larr; cascading. level&larr;3]<br></span><span class="tab"></span><span class="tab"></span><span class="small">self track⦂ (self compileprimary: input into: a level: level)?[↪no assign↪]<br></span><span class="tab"></span><span class="tab"></span><span class="small">!(self compileexpr: input) + a contents].<br></span><span class="tab"></span><span class="small">stk &larr; stack. b &larr; (Vector new: 4) asStream.</span><span class="tab"></span><span class="tab"></span><span class="small">↪arg stack↪<br></span><span class="tab"></span><span class="small">b next&larr; a; next&larr; stackused.  a &larr; Stream default.</span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">↪operators↪<br></span><span class="tab"></span><span class="small">for⦂ i to: level do⦂<br></span><span class="tab"></span><span class="tab"></span><span class="small">[more &larr; true.  while⦂ more do⦂<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">[input end?[more &larr; false] c&larr;input peek.<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">(c is: UniqueString) ≡ false?<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">[user notify: &rsquo;&rsquo;unexpected: &rsquo;&rsquo;+ c asString]<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">[i=1?[c isinfix?[more &larr; false]<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">c iskeyword?[more &larr; false]  c &larr; input next];<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">=2?[c iskeyword?[more &larr; false]<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">"( . ; ? [ ] &larr; !) has: c?[more &larr; false]<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">c &larr; input next.<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">b next&larr; self track⦂ (self compilefactor: input).<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">b next&larr; stackused];<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">=3?["(for⦂ until⦂ while⦂) has: c?[more &larr; false]<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">while⦂ [input end?[false] (c&larr;input peek) iskeyword] do⦂<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">[t &larr; [t ≡ nil?[input next] t + input next].<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">a append: [c isuneval?<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">[self remote⦂ (self compileterm: input)]<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">self compileterm: input].<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">self push]<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">t≡nil?[more &larr; false] c &larr; t unique]].<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">more≡false?[]<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">[level=3?[input %"&larr; ?</span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">↪check here for  &larr; clause↪<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">[c&larr;(c+&rsquo;&rsquo;&larr;&rsquo;&rsquo;)unique.<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">[i=2?[self exstack: b pop. a append: b pop. self push]].<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">a append: (self compileexpr: input). self push]]].<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">(b◦1) next&larr; self encodeop: c. i=3?[more &larr; false]]]<br></span><span class="tab"></span><span class="small">b◦1 &larr; (b◦1) contents.  until⦂ b empty do⦂<br></span><span class="tab"></span><span class="tab"></span><span class="small">[self exstack: b pop. a append: b pop. self push]<br></span><span class="tab"></span><span class="small">stack &larr; stk. !a contents]&rsquo;<br>Compiler understands: &rsquo;</span><span class="small underline">compileprimary:</span><span class="small"> input </span><span class="small underline">into:</span><span class="small"> a </span><span class="small underline">level:</span><span class="small"> n | c<br></span><span class="tab"></span><span class="small">["[ = input peek ?[c &larr; Compiler new. a append: (c compileblock: input)]<br></span><span class="tab"></span><span class="small">c &larr; input next.<br></span><span class="tab"></span><span class="small">c is: Vector?[a append: (self compileexpr: (c&larr; Stream new of: c)).<br></span><span class="tab"></span><span class="tab"></span><span class="small">c end?[] user notify: &rsquo;&rsquo;extra suff in parens: &rsquo;&rsquo;+ a asString]<br></span><span class="tab"></span><span class="small">c &larr; [""=c?[self encodelit: input next] self encoderef: c]. <br></span><span class="tab"></span><span class="small">[n=3?[input %"&larr; ?</span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">↪expr-level call checks for &larr; ↪<br></span><span class="tab"></span><span class="tab"></span><span class="small">[c&lt;(areccode+8)?[a next&larr; smashcode; next&larr; c. !false]</span><span class="tab"></span><span class="tab"></span><span class="small">↪assignment↪<br></span><span class="tab"></span><span class="tab"></span><span class="small">user notify: &rsquo;&rsquo;assigning into read-only field&rsquo;&rsquo;]]].<br></span><span class="tab"></span><span class="small">self exstack: 1.<br></span><span class="tab"></span><span class="small">c=supercode?[a next&larr; selfcode; next&larr; supercode] a next&larr; c]&rsquo;<br>Compiler understands: &rsquo;</span><span class="small underline">encoderef:</span><span class="small"> a | t<br></span><span class="tab"></span><span class="small">[[trace?[user show: a asString]].<br></span><span class="tab"></span><span class="small">a is: UniqueString?<br></span><span class="tab"></span><span class="tab"></span><span class="small">[t &larr; cdict lookup: a ? [!t]<br></span><span class="tab"></span><span class="tab"></span><span class="small">a isinfix or: a iskeyword?<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">[user notify: &rsquo;&rsquo;missing receiver before: &rsquo;&rsquo; + a asString]<br></span><span class="tab"></span><span class="tab"></span><span class="small">cdict insert: a with: (t&larr; self newref: a).  !t]<br></span><span class="tab"></span><span class="small">!self encodelit: a]&rsquo;<br>Compiler understands: &rsquo;</span><span class="small underline">newref:</span><span class="small"> a | i<br></span><span class="tab"></span><span class="small">[for⦂ i from: environment,Undeclared  do⦂<br></span><span class="tab"></span><span class="tab"></span><span class="small">[i has: a?<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">[!liticode + (self addlit: (i ref: a))]]<br></span><span class="tab"></span><span class="small">user show: a asString + &rsquo;&rsquo; is undeclared.&rsquo;&rsquo;.<br></span><span class="tab"></span><span class="small">Undeclared define: a  as: nil.<br></span><span class="tab"></span><span class="small">!liticode + (self addlit: (Undeclared ref: a))]&rsquo;<br>Compiler understands: &rsquo;</span><span class="small underline">encodelit:</span><span class="small"> a | b i<br></span><span class="tab"></span><span class="small">[</span><span class="tab"></span><span class="small">[a class≡Integer?[0≠(i&larr; "(¬1 0 1 2 10) find: a)?<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">[!constcode+i-1]<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">for⦂ i to: (32 min: literals length) do⦂<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">[literals◦i is: Integer?[literals◦i=a?[!litcode+i-1]]]];<br></span><span class="tab"></span><span class="tab"></span><span class="small">≡Float?[for⦂ i to: (32 min: literals length) do⦂<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">[literals◦i is: Float?[literals◦i=a?[!litcode+i-1]]]]].<br></span><span class="tab"></span><span class="small">literals length&lt;32?[!litcode +(self addlit: a)]<br></span><span class="tab"></span><span class="small">b &larr; ObjectReference new. b value&larr; a.<br></span><span class="tab"></span><span class="small">!liticode + (self addlit: b)]&rsquo;<br>Compiler understands: &rsquo;</span><span class="small underline">addlit:</span><span class="small"> a | b<br></span><span class="tab"></span><span class="small">[b &larr; literals length.<br></span><span class="tab"></span><span class="small">b≥48?[user notify: &rsquo;&rsquo;too many literals&rsquo;&rsquo;]<br></span><span class="tab"></span><span class="small">literals &larr; literals , a. !b]&rsquo;<br>Compiler understands: &rsquo;</span><span class="small underline">encodeop:</span><span class="small"> a<br></span><span class="tab"></span><span class="small">[[trace?[user show: a asString]].<br></span><span class="tab"></span><span class="small">opdict has: a?[!opdict◦a]<br></span><span class="tab"></span><span class="small">opdict insert: a with: (opcode + (self addlit: a)).<br></span><span class="tab"></span><span class="small">!opdict◦a]&rsquo;<br>Compiler understands: &rsquo;</span><span class="small underline">remote⦂</span><span class="small"> b | a t<br></span><span class="tab"></span><span class="small">[a&larr;Stream default.<br></span><span class="tab"></span><span class="small">self push. b &larr; b eval. self pop.</span><span class="tab"></span><span class="tab"></span><span class="small">↪</span><span class="small italic">extra stack to push caller</span><span class="small">↪<br></span><span class="tab"></span><span class="small">a next&larr; curcode; next&larr; self encodeop: "remoteCopy.<br></span><span class="tab"></span><span class="small">t &larr; b length+3. a next&larr; t/256+jmpcode+4; next&larr; t\256.<br></span><span class="tab"></span><span class="small">a append: b; next&larr; endcode; append: (self encodejmp: jmpcode by: 0-t).<br></span><span class="tab"></span><span class="small">!a contents]&rsquo;<br>Compiler understands: &rsquo;</span><span class="small underline">push</span><span class="small"><br></span><span class="tab"></span><span class="small">[maxstack &larr; maxstack max: (stack &larr; stack+1).<br></span><span class="tab"></span><span class="small">trace?[stack print]]&rsquo;<br>Compiler understands: &rsquo;</span><span class="small underline">pop</span><span class="small"><br></span><span class="tab"></span><span class="small">[0&gt;(stack &larr; stack-1)?[user notify: &rsquo;&rsquo;negative stack&rsquo;&rsquo;]]&rsquo;<br>Compiler understands: &rsquo;</span><span class="small underline">track⦂</span><span class="small"> expr | a b val<br></span><span class="tab"></span><span class="small">[a&larr;maxstack.  maxstack&larr; b&larr; stack.<br></span><span class="tab"></span><span class="small">val &larr; expr eval.<br></span><span class="tab"></span><span class="small">b≠stack?[user notify: &rsquo;&rsquo;unbalanced stack&rsquo;&rsquo;]<br></span><span class="tab"></span><span class="small">stackused &larr; maxstack-stack.  maxstack &larr; a.<br></span><span class="tab"></span><span class="small">!val]&rsquo;<br>Compiler understands: &rsquo;</span><span class="small underline">exstack:</span><span class="small"> x<br></span><span class="tab"></span><span class="small">[maxstack &larr; maxstack max: stack + x]&rsquo;<br>Compiler understands: &rsquo;</span><span class="small underline">encodejmp:</span><span class="small"> a </span><span class="small underline">by:</span><span class="small"> n | b<br></span><span class="tab"></span><span class="small">[1≤n and: n≤8?[b&larr;String new: 1.<br></span><span class="tab"></span><span class="tab"></span><span class="small">b◦1 &larr; n+[a=bfpcode?[shortbfp] shortjmp]-1. !b]<br></span><span class="tab"></span><span class="small">[n&lt;0?[n&larr;n+1024. n&lt;0?[user notify: &rsquo;&rsquo;block too long.&rsquo;&rsquo;]]<br></span><span class="tab"></span><span class="tab"></span><span class="small">a &larr; a+4. n&gt;1023?[user notify: &rsquo;&rsquo;block too long.&rsquo;&rsquo;]].<br></span><span class="tab"></span><span class="small">b &larr; String new: 2.<br></span><span class="tab"></span><span class="small">b◦1 &larr; n/256+ a.  b◦2 &larr; n\256.  !b]&rsquo;<br>Compiler understands: &rsquo;</span><span class="small underline">compilefor</span><span class="small"> | a b<br></span><span class="tab"></span><span class="small">[a &larr; source next.<br></span><span class="tab"></span><span class="small">[cdict has: a?[cdict◦a&lt;litcode?[]<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">user show: a asString+&rsquo;&rsquo; is not local.&rsquo;&rsquo;]<br></span><span class="tab"></span><span class="small">user show: a asString+&rsquo;&rsquo; is not local.&rsquo;&rsquo;].<br></span><span class="tab"></span><span class="small">[source %"to: ?<br></span><span class="tab"></span><span class="tab"></span><span class="small">[code append: (self compileterm: source). self push.<br></span><span class="tab"></span><span class="tab"></span><span class="small">code next&larr; self encodeop: "oneToMeAsStream]<br></span><span class="tab"></span><span class="small">source %"from: ?<br></span><span class="tab"></span><span class="tab"></span><span class="small">[code append: (self compileterm: source). self push.<br></span><span class="tab"></span><span class="tab"></span><span class="small">code next&larr; self encodeop: "asStream]<br></span><span class="tab"></span><span class="small">user notify: &rsquo;&rsquo;to: or from: expected at &rsquo;&rsquo;+source peek asString].<br></span><span class="tab"></span><span class="small">code next&larr; smashcode.<br></span><span class="tab"></span><span class="small">b&larr; code loc. code next&larr; self newtemp. </span><span class="tab"></span><span class="small">↪reentry point↪<br></span><span class="tab"></span><span class="small">code next&larr; self encodeop: "next; next&larr; smashcode.<br></span><span class="tab"></span><span class="small">code next&larr; self encoderef: a. self compileloop: b.<br></span><span class="tab"></span><span class="small">ntemps &larr; ntemps-1]&rsquo;<br>Compiler understands: &rsquo;compileuntil: a | b<br></span><span class="tab"></span><span class="small">[b &larr; code loc.<br></span><span class="tab"></span><span class="small">code append: (self compileterm: source). self push.<br></span><span class="tab"></span><span class="small">[a?[code next&larr; self encoderef: "false. self push.<br></span><span class="tab"></span><span class="tab"></span><span class="small">code next&larr; self encodeop: "≡. self pop]].<br></span><span class="tab"></span><span class="small">self compileloop: b]&rsquo;<br>Compiler understands: &rsquo;</span><span class="small underline">compileloop:</span><span class="small"> b|a c<br></span><span class="tab"></span><span class="small">[self pop.<br></span><span class="tab"></span><span class="small">[source %"do⦂ ?[] <br></span><span class="tab"></span><span class="tab"></span><span class="small">user notify: &rsquo;&rsquo;do⦂ expected before &rsquo;&rsquo;+source peek asString].<br></span><span class="tab"></span><span class="small">c &larr; Compiler new. c compileblock: source.<br></span><span class="tab"></span><span class="small">c popopt. a &larr; c code.</span><span class="tab"></span><span class="tab"></span><span class="small">↪end with pop [opt]↪<br></span><span class="tab"></span><span class="small">code append: (self encodejmp: bfpcode by: 2+a length).</span><span class="tab"></span><span class="small">↪2 for jmp ¬n↪<br></span><span class="tab"></span><span class="small">code append: a; append: (self encodejmp: jmpcode by: b-code loc-2)]&rsquo;<br>Compiler understands: &rsquo;</span><span class="small underline">code</span><span class="small"> [!code contents]&rsquo;<br><br></span></div>
<div class="line center">
<span class="small"><br></span><span class="small">↪</span><span class="medium bold">SCHEDULING</span><span class="small">↪</span></div>
<div class="line left">
<span class="medium bold"><br>Class new title:&rsquo;PriorityScheduler&rsquo;;<br>fields: &rsquo;source</span><span class="tab"></span><span class="small">↪</span><span class="small italic">the source of power, ie the source from which<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small italic">this scheduler was spawned, and who therefore holds<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small italic">the suspension if it is suspended.</span><span class="small">↪</span><span class="medium bold"><br></span><span class="tab"></span><span class="tab"></span><span class="medium bold">processes </span><span class="small">↪</span><span class="small italic">&lt;Vector of Contexts&gt; the suspended processes</span><span class="small">↪</span><span class="medium bold"><br></span><span class="tab"></span><span class="tab"></span><span class="medium bold">rootprocesses </span><span class="small">↪</span><span class="small italic">&lt;Vector of Contexts&gt; root processes for restarting</span><span class="small">↪</span><span class="medium bold"><br></span><span class="tab"></span><span class="tab"></span><span class="medium bold">enabled </span><span class="small">↪</span><span class="small italic">&lt;Integer&gt; bits for each level; bit0=level0=lowest prio</span><span class="small">↪</span><span class="medium bold"><br></span><span class="tab"></span><span class="tab"></span><span class="medium bold">active </span><span class="small">↪</span><span class="small italic">&lt;Integer&gt; bits for each level; bit0=1, bit15=sign bit</span><span class="small">↪</span><span class="medium bold"><br></span><span class="tab"></span><span class="tab"></span><span class="medium bold">currentlevel </span><span class="small">↪</span><span class="small italic">&lt;Integer&gt; this level is currently selected</span><span class="small">↪</span><span class="medium bold">&rsquo;<br></span><span class="small">↪</span><span class="small italic">The underlying machine has a pointer to the top level scheduler, so that physical interrupts can also cause interrupts in Smalltalk.  This they do by calling their own copy of </span><span class="small italic underline">wakeup</span><span class="small italic"> and </span><span class="small italic underline">reselect</span><span class="small italic">.  This copy is also invoked (primitive 65) when </span><span class="small italic underline">reselect</span><span class="small italic"> is sent to the top-level scheduler, since its source is the virtual machine itself.</span><span class="small">↪<br>PriorityScheduler understands: &rsquo;</span><span class="small underline">install⦂</span><span class="small"> context </span><span class="small underline">at:</span><span class="small"> level<br></span><span class="tab"></span><span class="small">[context sender &larr; nil.  rootprocesses◦level &larr; context.<br></span><span class="tab"></span><span class="small">processes◦level &larr; context copy]&rsquo;<br>PriorityScheduler understands: &rsquo;</span><span class="small underline">enable:</span><span class="small"> level<br></span><span class="tab"></span><span class="small">[enabled &larr; enabled lor: biton◦level]&rsquo;<br>PriorityScheduler understands: &rsquo;</span><span class="small underline">disable:</span><span class="small"> level<br></span><span class="tab"></span><span class="small">[enabled &larr; enabled land: bitoff◦level]&rsquo;<br>PriorityScheduler understands: &rsquo;</span><span class="small underline">wakeup:</span><span class="small"> level<br></span><span class="tab"></span><span class="small">[active &larr; active lor: biton◦level.<br></span><span class="tab"></span><span class="small">self reselect]&rsquo;<br>PriorityScheduler understands: &rsquo;</span><span class="small underline">sleep:</span><span class="small"> level<br></span><span class="tab"></span><span class="small">[active &larr; active land: bitoff◦level.<br></span><span class="tab"></span><span class="small">self reselect]&rsquo;<br>PriorityScheduler understands: &rsquo;</span><span class="small underline">reset:</span><span class="small"> level<br></span><span class="tab"></span><span class="small">[processes◦level &larr; rootprocesses◦level copy.<br></span><span class="tab"></span><span class="small">self sleep: level]&rsquo;<br>PriorityScheduler understands: &rsquo;</span><span class="small underline">restart:</span><span class="small"> level<br></span><span class="tab"></span><span class="small">[processes◦level &larr; rootprocesses◦level copy.<br></span><span class="tab"></span><span class="small">self wakeup: level]&rsquo;<br>PriorityScheduler understands: &rsquo;</span><span class="small underline">terminate:</span><span class="small"> level<br></span><span class="tab"></span><span class="small">[active &larr; active land: bitoff◦level.<br></span><span class="tab"></span><span class="small">processes◦level &larr; rootprocesses◦level &larr; nil.<br></span><span class="tab"></span><span class="small">active &larr; active land: bitoff◦level.<br></span><span class="tab"></span><span class="small">self reselect]&rsquo;<br>PriorityScheduler understands: &rsquo;</span><span class="small underline">reselect</span><span class="small"><br></span><span class="tab"></span><span class="small">[processes◦currentlevel &larr; source current.<br></span><span class="tab"></span><span class="small">currentlevel &larr; (active land: enabled) hibit.<br></span><span class="tab"></span><span class="small">source current &larr; processes◦currentlevel] primitive: </span><span class="small italic">65</span><span class="small">&rsquo;<br>PriorityScheduler understands: &rsquo;</span><span class="small underline">current</span><span class="small"><br></span><span class="tab"></span><span class="small">[!processes◦currentlevel]&rsquo;<br>PriorityScheduler understands: &rsquo;</span><span class="small underline">current &larr;</span><span class="small"> context<br></span><span class="tab"></span><span class="small">[!processes◦currentlevel &larr; context]&rsquo;<br>PriorityScheduler understands: &rsquo;</span><span class="small underline">critical⦂</span><span class="small"> expr| t v<br></span><span class="tab"></span><span class="small">[t &larr; self disable.<br></span><span class="tab"></span><span class="small">v &larr; expr eval.</span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">↪</span><span class="small italic">evaluate with no interrupts</span><span class="small">↪<br></span><span class="tab"></span><span class="small">enabled &larr; t. !v]&rsquo;<br>PriorityScheduler understands: &rsquo;</span><span class="small underline">disable</span><span class="small"> | t<br></span><span class="tab"></span><span class="small">[t &larr; enabled. enabled &larr; 0. !t] primitive: 66&rsquo;<br>↪remaining here:<br></span><span class="tab"></span><span class="small">wakeup source on wakeup<br></span><span class="tab"></span><span class="small">sleep source on sleep<br></span><span class="tab"></span><span class="small">arrange to sleep or restart when a process returns<br></span><span class="tab"></span><span class="small">what does an empty scheduler do↪<br></span></div>
  </body>
</html>
