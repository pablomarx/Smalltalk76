<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN">
<html>
  <head>
    <meta http-equiv="Content-type" content="text/html;charset=UTF-8">
    <title>Smalltalk76/Kernel-Classes.st</title>
	<link rel="stylesheet" type="text/css" href="font.css"/>
  </head>
  <body>
    <div class="line left">
<span class="small">&rsquo;From Smalltalk 5.5k XM November 24 on 22 November 1980 at 2:57:08 am.&rsquo;<br></span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="medium bold">"Object"</span></div>
<div class="line left">
<span class="medium bold">Class new title: &rsquo;Object&rsquo;<br></span><span class="tab"></span><span class="medium bold">subclassof: nil<br></span><span class="tab"></span><span class="medium bold">fields: &rsquo;&rsquo;<br></span><span class="tab"></span><span class="medium bold">declare: &rsquo;&rsquo;;<br></span><span class="tab"></span><span class="medium bold">asFollows</span></div>
<div class="line left">
<span class="small italic"><br>Object is the superclass of all classes.  It is an abstract class, meaning that it has no state, and its main function is to provide a foundation message protocol for its subclasses.  Three instances of this class are defined: nil, true, and false.</span></div>
<div class="line left">
<span class="medium bold"><br>Comparison</span></div>
<div class="line left">
<span class="small bold">≤ x </span><span class="small">[⇑self&gt;x≡false]</span></div>
<div class="line left">
<span class="small bold">≡ x </span><span class="small">[⇑self≡x </span><span class="small italic">"In case this is reached by perform:"</span><span class="small">] primitive: 4</span></div>
<div class="line left">
<span class="small bold">≠ x </span><span class="small">[⇑self=x≡false]</span></div>
<div class="line left">
<span class="small bold">≥ x </span><span class="small">[⇑self&lt;x≡false]</span></div>
<div class="line left">
<span class="small bold">= x </span><span class="small">[⇑self≡x]</span></div>
<div class="line left">
<span class="small bold">and⦂ x </span><span class="small">[self⇒[⇑x eval] ⇑false]</span></div>
<div class="line left">
<span class="small bold">and: x </span><span class="small">[self⇒[⇑x] ⇑false]</span></div>
<div class="line left">
<span class="small bold">empty </span><span class="small">[⇑self length = 0]</span></div>
<div class="line left">
<span class="small bold">eqv: x </span><span class="small">[x⇒[⇑self] ⇑self≡false]</span></div>
<div class="line left">
<span class="small bold">or⦂ x </span><span class="small">[self⇒[⇑true] ⇑x eval]</span></div>
<div class="line left">
<span class="small bold">or: x </span><span class="small">[self⇒[⇑true] ⇑x]</span></div>
<div class="line left">
<span class="small bold">sameAs: object<br></span><span class="tab"></span><span class="small">[⇑self≡object]</span></div>
<div class="line left">
<span class="small bold">xor: x </span><span class="small">[x⇒[⇑self≡false] ⇑self]</span></div>
<div class="line left">
<span class="medium bold"><br>Classification</span></div>
<div class="line left">
<span class="small bold">class </span><span class="small">[user croak] primitive: 27</span></div>
<div class="line left">
<span class="small bold">is: x </span><span class="small">[⇑self class≡x]</span></div>
<div class="line left">
<span class="small bold">Is: x  </span><span class="small">"Is the class x a superclass or class of self"<br></span><span class="tab"></span><span class="small">[self class ≡ x ⇒[⇑true]<br></span><span class="tab"></span><span class="small">⇑self class Isa: x]</span></div>
<div class="line left">
<span class="small bold">isArray<br></span><span class="tab"></span><span class="small">[⇑false]</span></div>
<div class="line left">
<span class="small bold">isnt: x </span><span class="small">[⇑(self class≡x) ≡ false]</span></div>
<div class="line left">
<span class="small bold">Isnt: x<br></span><span class="tab"></span><span class="small">[⇑(self Is: x)≡false]</span></div>
<div class="line left">
<span class="small bold">isNumber<br></span><span class="tab"></span><span class="small">[⇑false]</span></div>
<div class="line left">
<span class="medium bold"><br>Construction</span></div>
<div class="line left">
<span class="small bold">, x </span><span class="small">| v<br></span><span class="tab"></span><span class="small">[v &larr; Vector new: 2.<br></span><span class="tab"></span><span class="small">v◦1 &larr; self. v◦2 &larr; x.  ⇑v]</span></div>
<div class="line left">
<span class="small bold">asParagraph </span><span class="small">[⇑self asString asParagraph]</span></div>
<div class="line left">
<span class="small bold">asStream </span><span class="small">[⇑self asVector asStream]</span></div>
<div class="line left">
<span class="small bold">asVector </span><span class="small">| v<br></span><span class="tab"></span><span class="small">[self≡nil⇒[⇑Vector new: 0]<br></span><span class="tab"></span><span class="small">v &larr; Vector new: 1. v◦1 &larr; self. ⇑v]</span></div>
<div class="line left">
<span class="small bold">copy</span><span class="tab"></span><span class="tab"></span><span class="small italic">"create new copy of self"</span><span class="small"><br></span><span class="tab"></span><span class="small">[self is: Object⇒[⇑self]<br></span><span class="tab"></span><span class="small">⇑self class copy: self]</span></div>
<div class="line left">
<span class="small bold">inVector </span><span class="small">| vec<br></span><span class="tab"></span><span class="small">[</span><span class="small italic">"Return me as the sole element of a new Vector."</span><span class="small"><br></span><span class="tab"></span><span class="small">vec &larr; Vector new: 1.<br></span><span class="tab"></span><span class="small">vec◦1 &larr; self.<br></span><span class="tab"></span><span class="small">⇑vec]</span></div>
<div class="line left">
<span class="small bold">recopy</span><span class="tab"></span><span class="small italic">"recursively copy whole structure"</span><span class="small"><br></span><span class="tab"></span><span class="small">[self is: Object⇒[⇑self]<br></span><span class="tab"></span><span class="small">⇑self class recopy: self]</span></div>
<div class="line left">
<span class="medium bold"><br>Aspects</span></div>
<div class="line left">
<span class="small bold">asOop </span><span class="small">[user croak] primitive: 46</span></div>
<div class="line left">
<span class="small bold">canunderstand: selector<br></span><span class="tab"></span><span class="small">[⇑self class canunderstand: selector]</span></div>
<div class="line left">
<span class="small bold">error: s </span><span class="small">[⇑user notify: s]</span></div>
<div class="line left">
<span class="small bold">fields<br></span><span class="tab"></span><span class="small">[</span><span class="small italic">"Return an Array of all my field names or many of my subscripts."</span><span class="small"><br></span><span class="tab"></span><span class="small">self class is: VariableLengthClass⇒<br></span><span class="tab"></span><span class="tab"></span><span class="small">[self length ≤ 50⇒ [⇑1 to: self length]<br></span><span class="tab"></span><span class="tab"></span><span class="small">⇑ (1 to: 20) concat: (self length-20 to: self length)]<br></span><span class="tab"></span><span class="small">⇑self class instvars]</span></div>
<div class="line left">
<span class="small bold">hash </span><span class="small">[user croak] primitive: 46</span></div>
<div class="line left">
<span class="small bold">inspect<br></span><span class="tab"></span><span class="small">[user leaveTop; restartup: (InspectWindow new of: self)]</span></div>
<div class="line left">
<span class="small bold">inspectfield: n</span><span class="tab"></span><span class="small italic">"used by variable panes"</span><span class="small"><br></span><span class="tab"></span><span class="small">[self class is: VariableLengthClass⇒ [⇑self◦(self fields◦n)]<br></span><span class="tab"></span><span class="small">⇑self instfield: n]</span></div>
<div class="line left">
<span class="small bold">instfield: n </span><span class="small">[user croak] primitive: 38</span></div>
<div class="line left">
<span class="small bold">instfield: n &larr; val </span><span class="small">[user croak] primitive: 39</span></div>
<div class="line left">
<span class="small bold">instfields </span><span class="small">| vec size  i<br></span><span class="tab"></span><span class="small">[</span><span class="small italic">"Return an Array of all my field values or many of my elements."</span><span class="small"><br></span><span class="tab"></span><span class="small">self class is: VariableLengthClass⇒ [⇑self◦self fields]<br></span><span class="tab"></span><span class="small">size &larr; self class instsize.<br></span><span class="tab"></span><span class="small">vec &larr; Vector new: size.<br></span><span class="tab"></span><span class="small">for⦂ i to: size do⦂ [vec◦i &larr; self instfield: i].<br></span><span class="tab"></span><span class="small">⇑vec]</span></div>
<div class="line left">
<span class="small bold">itself </span></div>
<div class="line left">
<span class="small bold">ref: index<br></span><span class="tab"></span><span class="small">[⇑FieldReference new object: self offset: index]</span></div>
<div class="line left">
<span class="small bold">subError </span><span class="small">[self error: &rsquo;message not defined by subclass&rsquo;]</span></div>
<div class="line left">
<span class="small bold">title<br></span><span class="tab"></span><span class="small">[⇑self class title + &rsquo;.&rsquo; + self asOop base8]</span></div>
<div class="line left">
<span class="medium bold"><br>Printing</span></div>
<div class="line left">
<span class="small bold">asFullString </span><span class="small">| strm<br></span><span class="tab"></span><span class="small">[strm &larr; (String new: 20) asStream.<br></span><span class="tab"></span><span class="small">self fullprinton: strm. ⇑strm contents]</span></div>
<div class="line left">
<span class="small bold">asString </span><span class="small">| strm<br></span><span class="tab"></span><span class="small">[strm &larr; (String new: 16) asStream.<br></span><span class="tab"></span><span class="small">self printon: strm. ⇑strm contents]</span></div>
<div class="line left">
<span class="small bold">filout </span><span class="small">| file<br></span><span class="tab"></span><span class="small">[⇑user displayoffwhile⦂ <br></span><span class="tab"></span><span class="tab"></span><span class="small">[file &larr; dp0 file: self title asFileName.<br></span><span class="tab"></span><span class="tab"></span><span class="small">self fullprinton: file.<br></span><span class="tab"></span><span class="tab"></span><span class="small">file close]]</span></div>
<div class="line left">
<span class="small bold">fullprint </span><span class="small">| strm<br></span><span class="tab"></span><span class="small">[strm &larr; Stream default. self fullprinton: strm.<br></span><span class="tab"></span><span class="small">user show: strm contents]</span></div>
<div class="line left">
<span class="small bold">fullprinton: strm<br></span><span class="tab"></span><span class="small">[self≡nil⇒ [strm append: &rsquo;nil&rsquo;]<br></span><span class="tab"></span><span class="small">self≡false⇒ [strm append: &rsquo;false&rsquo;]<br></span><span class="tab"></span><span class="small">self≡true⇒ [strm append: &rsquo;true&rsquo;]<br></span><span class="tab"></span><span class="small">self class print: self on: strm]</span></div>
<div class="line left">
<span class="small bold">print<br></span><span class="tab"></span><span class="small">[user show: self asString]</span></div>
<div class="line left">
<span class="small bold">printon: strm </span><span class="small">| t [<br></span><span class="tab"></span><span class="small">strm append: [self≡nil⇒ [&rsquo;nil&rsquo;]; ≡false⇒ [&rsquo;false&rsquo;]; ≡true⇒ [&rsquo;true&rsquo;]<br></span><span class="tab"></span><span class="tab"></span><span class="small">t &larr; self class title.<br></span><span class="tab"></span><span class="tab"></span><span class="small">strm append: [&rsquo;AEIO&rsquo; has: t◦1⇒ [&rsquo;an &rsquo;] &rsquo;a &rsquo;].<br></span><span class="tab"></span><span class="tab"></span><span class="small">t]]</span></div>
<div class="line left">
<span class="medium bold"><br>Compiler Defaults</span></div>
<div class="line left">
<span class="small bold">ⓢ code<br></span><span class="tab"></span><span class="small">[⇑Generator new evaluate: code asStream in: false to: self notifying: self]</span></div>
<div class="line left">
<span class="small bold">argsOff: stack<br></span><span class="tab"></span><span class="small">[self⇒ [stack pop: 1]]</span></div>
<div class="line left">
<span class="small bold">asRemoteCode: generator<br></span><span class="tab"></span><span class="small">[⇑ParsedRemote new expr: self]</span></div>
<div class="line left">
<span class="small bold">emitForEffect: code on: stack</span></div>
<div class="line left">
<span class="small bold">emitForTruth: trueSkip falsity: falseSkip into: code on: stack<br></span><span class="tab"></span><span class="small">[self emitForValue: code on: stack.<br></span><span class="tab"></span><span class="small">(trueSkip jmpSize + falseSkip) emitBfp: code on: stack.<br></span><span class="tab"></span><span class="small">trueSkip emitJmp: code on: stack]</span></div>
<div class="line left">
<span class="small bold">emitForValue: code on: stack</span></div>
<div class="line left">
<span class="small bold">emitsLoad<br></span><span class="tab"></span><span class="small">[⇑false]</span></div>
<div class="line left">
<span class="small bold">emittedReceiver<br></span><span class="tab"></span><span class="small">[⇑false]</span></div>
<div class="line left">
<span class="small bold">emittedVariable<br></span><span class="tab"></span><span class="small">[⇑false]</span></div>
<div class="line left">
<span class="small bold">findMacros: macros compilerTemps: compilerTemps</span></div>
<div class="line left">
<span class="small bold">firstPush<br></span><span class="tab"></span><span class="small">[⇑¬1]</span></div>
<div class="line left">
<span class="small bold">interactive<br></span><span class="tab"></span><span class="small">[⇑false]</span></div>
<div class="line left">
<span class="small bold">isField<br></span><span class="tab"></span><span class="small">[⇑false]</span></div>
<div class="line left">
<span class="small bold">notify: errorString at: position in: stream<br></span><span class="tab"></span><span class="small">[⇑self notify: errorString at: position in: stream for: self class]</span></div>
<div class="line left">
<span class="small bold">notify: errorString at: position in: stream for: class </span><span class="small">| syntaxWindow<br></span><span class="tab"></span><span class="small">[NotifyFlag⇒<br></span><span class="tab"></span><span class="tab"></span><span class="small">[syntaxWindow &larr; SyntaxWindow new of: errorString at: position in: stream for: class from: thisContext sender.<br></span><span class="tab"></span><span class="tab"></span><span class="small">thisContext sender &larr; nil.<br></span><span class="tab"></span><span class="tab"></span><span class="small">user restartup: syntaxWindow]<br></span><span class="tab"></span><span class="small"> user notify: errorString. ⇑false]</span></div>
<div class="line left">
<span class="small bold">printon: strm indent: level precedence: p forValue: v decompiler: decompiler</span></div>
<div class="line left">
<span class="small bold">remote: generator</span></div>
<div class="line left">
<span class="small bold">returns<br></span><span class="tab"></span><span class="small">[⇑false]</span></div>
<div class="line left">
<span class="small bold">sizeForEffect: nextPush <br></span><span class="tab"></span><span class="small">[⇑0]</span></div>
<div class="line left">
<span class="small bold">sizeForTruth: trueSkip falsity: falseSkip<br></span><span class="tab"></span><span class="tab"></span><span class="small">| jump<br></span><span class="tab"></span><span class="small">[jump &larr; trueSkip jmpSize.<br></span><span class="tab"></span><span class="small">⇑self sizeForValue + (jump+falseSkip) bfpSize + jump]</span></div>
<div class="line left">
<span class="small bold">sizeForValue<br></span><span class="tab"></span><span class="small">[⇑0]</span></div>
<div class="line left">
<span class="medium bold"><br>System Primitives</span></div>
<div class="line left">
<span class="small bold">error </span><span class="small">| sender op n args i</span><span class="tab"></span><span class="tab"></span><span class="small">"after compiling execute: nil installError.  "<br></span><span class="tab"></span><span class="small">[sender &larr; thisContext sender.<br></span><span class="tab"></span><span class="small">op &larr; sender thisop.<br></span><span class="tab"></span><span class="small">n &larr; op numArgs.<br></span><span class="tab"></span><span class="small">args &larr; Vector new: n.<br></span><span class="tab"></span><span class="small">for⦂ i from: (n to: 1 by: ¬1) do⦂<br></span><span class="tab"></span><span class="tab"></span><span class="small">[args◦i &larr; sender pop].<br></span><span class="tab"></span><span class="small">⇑self messageNotUnderstood: op withArgs: args from: sender]</span></div>
<div class="line left">
<span class="small bold">installError </span><span class="small">| code old<br></span><span class="tab"></span><span class="small">[code &larr; Object md method: ↪error.<br></span><span class="tab"></span><span class="small">old &larr; SpecialOops◦1.<br></span><span class="tab"></span><span class="small">old asOop≠(mem◦3)⇒ [user notify: &rsquo;Object installError failed&rsquo;]<br></span><span class="tab"></span><span class="small">Top critical⦂<br></span><span class="tab"></span><span class="tab"></span><span class="small">[mem◦3 &larr; code asOop.<br></span><span class="tab"></span><span class="tab"></span><span class="small">SpecialOops◦1 &larr; code]]</span></div>
<div class="line left">
<span class="small bold">messageNotUnderstood: op withArgs: args from: sender<br></span><span class="tab"></span><span class="small">[thisContext sender &larr; sender.<br></span><span class="tab"></span><span class="small">user notify: &rsquo;Message not understood: &rsquo;+op]</span></div>
<div class="line left">
<span class="small bold">nail </span><span class="small">[user croak] primitive: 31</span><span class="tab"></span><span class="tab"></span><span class="small">"Nail me in core and return my core address"</span></div>
<div class="line left">
<span class="small bold">perform: selector </span><span class="tab"></span><span class="small italic">"Send the unary message, selector, to self"</span><span class="small"><br></span><span class="tab"></span><span class="small">[selector mustTake: 0. ⇑self performDangerously: selector]</span></div>
<div class="line left">
<span class="small bold">perform: selector with: arg1 </span><span class="tab"></span><span class="small italic">"Send the 1-argument message, selector, to self"</span><span class="small"><br></span><span class="tab"></span><span class="small">[selector mustTake: 1. ⇑self performDangerously: selector with: arg1]</span></div>
<div class="line left">
<span class="small bold">perform: selector with: arg1 with: arg2 </span><span class="tab"></span><span class="small italic">"Send the 2-argument message, selector, to self"</span><span class="small"><br></span><span class="tab"></span><span class="small">[selector mustTake: 2. ⇑self performDangerously: selector with: arg1 with: arg2]</span></div>
<div class="line left">
<span class="small bold">perform: selector with: arg1 with: arg2 with: arg3 </span><span class="tab"></span><span class="small italic">"Send the 3-argument message, selector, to self"</span><span class="small"><br></span><span class="tab"></span><span class="small">[selector mustTake: 3. ⇑self performDangerously: selector with: arg1 with: arg2 with: arg3]</span></div>
<div class="line left">
<span class="small bold">perform: selector withArgs: vec<br></span><span class="tab"></span><span class="small">[selector mustTake: vec length.<br></span><span class="tab"></span><span class="small">⇑self performDangerously: selector withArgs: vec]</span></div>
<div class="line left">
<span class="small bold">performDangerously: selector </span><span class="small italic">"Send self the message, selector; it had better be unary"</span><span class="small"><br></span><span class="tab"></span><span class="small">[user notify: &rsquo;can&rsquo;&rsquo;t perform: nil&rsquo;] primitive: 102</span></div>
<div class="line left">
<span class="small bold">performDangerously: selector with: arg1  </span><span class="small italic">"selector had better take 1 arg"</span><span class="small"><br></span><span class="tab"></span><span class="small">[user notify: &rsquo;can&rsquo;&rsquo;t perform: nil with:&rsquo;] primitive: 102</span></div>
<div class="line left">
<span class="small bold">performDangerously: selector with: arg1 with: arg2  </span><span class="small italic">"selector had better take 2 args"</span><span class="small"><br></span><span class="tab"></span><span class="small">[user notify: &rsquo;can&rsquo;&rsquo;t perform: nil with:with:&rsquo;] primitive: 102</span></div>
<div class="line left">
<span class="small bold">performDangerously: selector with: arg1 with: arg2 with: arg3  </span><span class="small italic">"selector had better take 3 args"</span><span class="small"><br></span><span class="tab"></span><span class="small">[user notify: &rsquo;can&rsquo;&rsquo;t perform: nil with:with:with:&rsquo;] primitive: 102</span></div>
<div class="line left">
<span class="small bold">performDangerously: selector withArgs: vec<br></span><span class="tab"></span><span class="small">[vec length=0⇒ [⇑self performDangerously: selector];<br></span><span class="tab"></span><span class="tab"></span><span class="small">=1⇒ [⇑self performDangerously: selector with: vec◦1];<br></span><span class="tab"></span><span class="tab"></span><span class="small">=2⇒ [⇑self performDangerously: selector with: vec◦1 with: vec◦2];<br></span><span class="tab"></span><span class="tab"></span><span class="small">=3⇒ [⇑self performDangerously: selector with: vec◦1 with: vec◦2 with: vec◦3]<br></span><span class="tab"></span><span class="small">user notify: &rsquo;More than 3 args for perform:&rsquo;]</span></div>
<div class="line left">
<span class="small bold">PTR </span><span class="small">[] primitive: 46</span></div>
<div class="line left">
<span class="small bold">refct </span><span class="small">[user croak] primitive: 45</span></div>
<div class="line left">
<span class="small bold">startup</span><span class="tab"></span><span class="tab"></span><span class="small italic">"loopless scheduling"</span><span class="small"><br></span><span class="tab"></span><span class="small">[self firsttime⇒<br></span><span class="tab"></span><span class="tab"></span><span class="small">[while⦂ self eachtime do⦂ [].<br></span><span class="tab"></span><span class="tab"></span><span class="small">⇑self lasttime]<br></span><span class="tab"></span><span class="small">⇑false]</span></div>
<div class="line left">
<span class="small bold">swap⦂ variable </span><span class="small">| x  </span><span class="small italic">"assign me to variable and return its old value"</span><span class="small"><br></span><span class="tab"></span><span class="small">[x &larr; variable value. variable value &larr; self. ⇑x]</span></div>
<div class="line left">
<span class="small bold">unNail </span><span class="small">[user croak] primitive: 32</span><span class="tab"></span><span class="tab"></span><span class="small">"Release me from being nailed"</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪Object under: &rsquo;Kernel Classes&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="medium bold"><br>"Class"</span></div>
<div class="line left">
<span class="medium bold">Class new title: &rsquo;Class&rsquo;<br></span><span class="tab"></span><span class="medium bold">subclassof: Object<br></span><span class="tab"></span><span class="medium bold">fields: &rsquo;title</span><span class="tab"></span><span class="medium bold">"&lt;String&gt; for identification, printing"<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="medium bold">myinstvars "&lt;String&gt; partnames for compiling, printing"<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="medium bold">instsize "&lt;Integer&gt; for storage management"<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="medium bold">messagedict "&lt;MessageDict&gt; for communication, compiling"<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="medium bold">classvars "&lt;Dictionary/nil&gt; compiler checks here"<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="medium bold">superclass "&lt;Class&gt; for execution of inherited behavior"<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="medium bold">environment "&lt;Vector of SymbolTables&gt; for external refs"<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="medium bold">fieldtype&rsquo;<br></span><span class="tab"></span><span class="medium bold">declare: &rsquo;lastClass lastSelector lastParagraph &rsquo;;<br></span><span class="tab"></span><span class="medium bold">veryspecial: 1;<br></span><span class="tab"></span><span class="medium bold">asFollows</span></div>
<div class="line left">
<span class="small italic"><br>Classes are the molecules of Smalltalk.  The instance fields specify the number and naming of fields for each instance, and the messages define the protocol with which these objects may be communicated.  Classes inherit the fields and message protocol of their superclass.  Locally defined messages will override inherited ones of the same name, and overriden ones may be accessed through the use of super in place of self.  A typical class definition looks like:<br></span><span class="tab"></span><span class="small italic">Class new title: &rsquo;CodeEditor&rsquo;;<br></span><span class="tab"></span><span class="tab"></span><span class="small italic">subclassof: Window;<br></span><span class="tab"></span><span class="tab"></span><span class="small italic">fields: &rsquo;pared class selector&rsquo;;<br></span><span class="tab"></span><span class="tab"></span><span class="small italic">declare: &rsquo;editmenu&rsquo;<br>This ordering is required, though the subclassof: and declare: messages are optional.  A class definition may be re-executed but, if the fields: clause has changed, all instances of the old class will become obsolete (they will fail to respond to any messages).</span></div>
<div class="line left">
<span class="medium bold"><br>Initialization</span></div>
<div class="line left">
<span class="small bold">abstract<br></span><span class="tab"></span><span class="small">[self fields: nullString]</span></div>
<div class="line left">
<span class="small bold">bytesize: n</span><span class="tab"></span><span class="small italic">"non-pointer declaration"</span><span class="small"><br></span><span class="tab"></span><span class="small">[self≠self realself⇒[self realself bytesize: n]<br></span><span class="tab"></span><span class="small">fieldtype &larr; 32+ [n=8⇒ [8] 16]]</span></div>
<div class="line left">
<span class="small bold">classInit</span><span class="tab"></span><span class="tab"></span><span class="small italic">"gets propagated to a dummy instance"</span><span class="small"><br></span><span class="tab"></span><span class="small">[self new classInit]</span></div>
<div class="line left">
<span class="small bold">copyof: oldClass subclassof: newSubClass<br></span><span class="tab"></span><span class="small">[title &larr; oldClass title.<br></span><span class="tab"></span><span class="small"> self subclassof: newSubClass.<br></span><span class="tab"></span><span class="small"> classvars &larr; oldClass classvars.<br></span><span class="tab"></span><span class="small"> environment &larr; oldClass environment.<br></span><span class="tab"></span><span class="small"> self newFieldsForSubClass: oldClass myinstvars]</span></div>
<div class="line left">
<span class="small bold">declare: v </span><span class="small">| var recom</span><span class="small bold"><br></span><span class="tab"></span><span class="small">[self≠self realself⇒[self realself declare: v]<br></span><span class="tab"></span><span class="small"> [classvars≡nil⇒[classvars &larr; SymbolTable init]].<br></span><span class="tab"></span><span class="small"> v is: String⇒[self declare: v asVector]<br></span><span class="tab"></span><span class="small"> recom &larr; false.<br></span><span class="tab"></span><span class="small"> [v is: Vector⇒<br></span><span class="tab"></span><span class="tab"></span><span class="small">[for⦂ var from: v do⦂<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">[(Smalltalk has: var) or: (Undeclared has: var)⇒[recom &larr; true]]]<br></span><span class="tab"></span><span class="small">  (Smalltalk has: v) or: (Undeclared has: v)⇒[recom &larr; true]].<br></span><span class="tab"></span><span class="small"> [recom⇒<br></span><span class="tab"></span><span class="tab"></span><span class="small">[user notify: &rsquo;Methods recompile if you proceed, global became local&rsquo;]].<br></span><span class="tab"></span><span class="small"> [v is: Vector⇒<br></span><span class="tab"></span><span class="tab"></span><span class="small">[for⦂ var from: v do⦂<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">[classvars insert: var with: nil]]<br></span><span class="tab"></span><span class="small">  classvars insert: v with: nil].<br></span><span class="tab"></span><span class="small"> recom⇒[self compileall]]</span></div>
<div class="line left">
<span class="small bold">environment &larr; environment </span><span class="small">[] </span><span class="small italic">"for resetting to reread sharing clauses"</span></div>
<div class="line left">
<span class="small bold">fields: myinstvars </span><span class="small">| r a b s h</span><span class="tab"></span><span class="tab"></span><span class="small italic">"list of instance variables"</span><span class="small"><br></span><span class="tab"></span><span class="small">[messagedict &larr; MessageDict init.<br></span><span class="tab"></span><span class="small"> r &larr; self realself.<br></span><span class="tab"></span><span class="small">a &larr; self instvars.<br></span><span class="tab"></span><span class="small">h&larr; HashSet init.<br></span><span class="tab"></span><span class="small">for⦂ s from: a do⦂<br></span><span class="tab"></span><span class="tab"></span><span class="small">[h has: s⇒<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">[user notify: s+&rsquo; is used already (maybe in superclass)&rsquo;]<br></span><span class="tab"></span><span class="tab"></span><span class="small">h insert: s].<br></span><span class="tab"></span><span class="small"> self=r⇒[self initClass]<br></span><span class="tab"></span><span class="small"> a=(b&larr; r instvars)⇒<br></span><span class="tab"></span><span class="tab"></span><span class="small">[r environment&larr; nil; myinstvars&larr; myinstvars; subclassof: superclass]<br><br></span><span class="tab"></span><span class="small"> [r howMany&gt;0⇒[user notify: &rsquo;All &rsquo;+title+&rsquo;s become obsolete if you proceed...&rsquo;]].<br><br></span><span class="tab"></span><span class="small"> classvars &larr; r classvars.<br></span><span class="tab"></span><span class="small"> messagedict &larr; r md copy.<br><br></span><span class="tab"></span><span class="small"> </span><span class="tab"></span><span class="small">[a length≤b length or⦂ a◦(1 to: b length)≠b⇒</span><span class="tab"></span><span class="tab"></span><span class="small italic">"just adding new inst fields"</span><span class="small"><br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">[user notify: title+ &rsquo; methods recompile if you proceed...&rsquo;.<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small"> self compileall]].<br><br></span><span class="tab"></span><span class="small"> r md init.<br></span><span class="tab"></span><span class="small"> self fixSubClassesOf: r.<br></span><span class="tab"></span><span class="small"> r obsolete.<br></span><span class="tab"></span><span class="small"> Smalltalk◦title unique &larr; self.<br></span><span class="tab"></span><span class="small"> self initClass]</span></div>
<div class="line left">
<span class="small bold">fixSubClassesOf: oldClass </span><span class="small">| n subClass<br></span><span class="tab"></span><span class="small">[for⦂ n from: user classNames do⦂<br></span><span class="tab"></span><span class="tab"></span><span class="small">[subClass &larr; Smalltalk◦n.<br></span><span class="tab"></span><span class="tab"></span><span class="small"> subClass superclass≡oldClass⇒<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">[Class new copyof: subClass subclassof: self]]]</span></div>
<div class="line left">
<span class="small bold">initClass<br></span><span class="tab"></span><span class="small">[fieldtype &larr; 16.<br></span><span class="tab"></span><span class="small">instsize &larr; self instvars length.<br></span><span class="tab"></span><span class="small">instsize&gt;256⇒<br></span><span class="tab"></span><span class="tab"></span><span class="small">[user notify: &rsquo;too many instance variables&rsquo;]<br></span><span class="tab"></span><span class="small">self organization]</span></div>
<div class="line left">
<span class="small bold">myinstvars &larr; myinstvars</span></div>
<div class="line left">
<span class="small bold">newFieldsForSubClass: myinstvars </span><span class="small">| r a b</span><span class="tab"></span><span class="tab"></span><span class="small italic">"list of instance variables"<br></span><span class="tab"></span><span class="small">[messagedict &larr; MessageDict init.<br></span><span class="tab"></span><span class="small"> r &larr; self realself.<br></span><span class="tab"></span><span class="small"> self=r⇒<br></span><span class="tab"></span><span class="tab"></span><span class="small">[user notify: &rsquo;problem in class redefinition. See coment at end of method&rsquo;]<br></span><span class="tab"></span><span class="small"> (a&larr; self instvars)=(b&larr; r instvars)⇒<br></span><span class="tab"></span><span class="tab"></span><span class="small">[user notify: &rsquo;problem in class redefinition. See coment at end of method&rsquo;]<br></span><span class="tab"></span><span class="small"> [r howMany&gt;0⇒[user cr show: &rsquo;All &rsquo;+title+&rsquo;s are obsolete.&rsquo;]].<br></span><span class="tab"></span><span class="small"> classvars &larr; r classvars.<br></span><span class="tab"></span><span class="small"> messagedict &larr; r md copy.<br></span><span class="tab"></span><span class="small"> r md init.<br></span><span class="tab"></span><span class="small"> </span><span class="tab"></span><span class="small">[a length≤b length or⦂ a◦(1 to: b length)≠b⇒</span><span class="tab"></span><span class="tab"></span><span class="small italic">"changing inst fields"</span><span class="small"><br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">[user cr show: title+ &rsquo; recompiled.&rsquo;.<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small"> self compileall]].<br></span><span class="tab"></span><span class="small"> self fixSubClassesOf: r.<br></span><span class="tab"></span><span class="small"> r obsolete.<br></span><span class="tab"></span><span class="small"> Smalltalk◦title unique &larr; self.<br></span><span class="tab"></span><span class="small"> self initClass]<br></span><span class="tab"></span><span class="tab"></span><span class="small">"Regarding the notifys in this method: It is my understanding<br></span><span class="tab"></span><span class="tab"></span><span class="small"> that this method will only be invoked when the conditions<br></span><span class="tab"></span><span class="tab"></span><span class="small"> leading to the notifys are false. If I&rsquo;m available, I&rsquo;d like to see<br></span><span class="tab"></span><span class="tab"></span><span class="small"> any case that results in notification.<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">Dave Robson"<br></span></div>
<div class="line left">
<span class="small bold">obsolete</span><span class="tab"></span><span class="tab"></span><span class="small italic">"invalidate further communication"</span><span class="small"><br></span><span class="tab"></span><span class="small">[title &larr; &rsquo;AnObsolete&rsquo;+title.<br></span><span class="tab"></span><span class="small">classvars &larr; nil.</span><span class="tab"></span><span class="tab"></span><span class="small italic">"recycle class variables"</span><span class="small"><br></span><span class="tab"></span><span class="small">messagedict close.</span><span class="tab"></span><span class="tab"></span><span class="small italic">"invalidate and recycle local messages"</span><span class="small"><br></span><span class="tab"></span><span class="small">environment &larr; self.</span><span class="tab"></span><span class="tab"></span><span class="small italic">"keep me around for old instances"</span><span class="small"><br></span><span class="tab"></span><span class="small">superclass &larr; Object.</span><span class="tab"></span><span class="tab"></span><span class="small italic">"invalidate superclass messages"</span><span class="small">]<br></span></div>
<div class="line left">
<span class="small bold">realself </span><span class="small">[⇑Smalltalk◦title unique]</span><span class="tab"></span><span class="tab"></span><span class="small italic">"as opposed to possible filin ghost"</span></div>
<div class="line left">
<span class="small bold">rename: newtitle<br></span><span class="tab"></span><span class="tab"></span><span class="small">| name newname oldclass category<br></span><span class="tab"></span><span class="small">[name &larr; title unique.  newname &larr; newtitle unique.<br></span><span class="tab"></span><span class="tab"></span><span class="small">[Smalltalk has: newname⇒<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">[oldclass &larr; Smalltalk◦newname.<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">user notify: &rsquo;All &rsquo; + newtitle + &rsquo;s will become obsolete if you proceed&rsquo;.<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">oldclass obsolete]<br></span><span class="tab"></span><span class="tab"></span><span class="small">category &larr; SystemOrganization invert: name.<br></span><span class="tab"></span><span class="tab"></span><span class="small">AllClassNames &larr; AllClassNames insertSorted: newname.<br></span><span class="tab"></span><span class="tab"></span><span class="small">SystemOrganization classify: newname under: category].<br></span><span class="tab"></span><span class="small">Smalltalk delete: name.<br></span><span class="tab"></span><span class="small">AllClassNames &larr; AllClassNames delete: name.<br></span><span class="tab"></span><span class="small">SystemOrganization delete: name.<br></span><span class="tab"></span><span class="small">title &larr; newtitle.<br></span><span class="tab"></span><span class="small">Smalltalk declare: newname as: self]<br></span></div>
<div class="line left">
<span class="small bold">sharing: table<br></span><span class="tab"></span><span class="small">[self≠self realself⇒[self realself sharing: table]<br></span><span class="tab"></span><span class="small">environment &larr; environment asVector , table]</span></div>
<div class="line left">
<span class="small bold">subclassof: superclass<br></span><span class="tab"></span><span class="small">[(superclass isnt: Class) and⦂ (superclass isnt: VariableLengthClass)⇒<br></span><span class="tab"></span><span class="tab"></span><span class="small">[user notify: &rsquo;Superclass is not yet defined or not a Class&rsquo;]]</span></div>
<div class="line left">
<span class="small bold">title: title<br></span><span class="tab"></span><span class="small">[self title: (title &larr; title unique) insystem: Smalltalk]</span></div>
<div class="line left">
<span class="small bold">title: name insystem: system </span><span class="small">| cl<br></span><span class="tab"></span><span class="small">[superclass &larr; Object.<br></span><span class="tab"></span><span class="small">[system has: name⇒<br></span><span class="tab"></span><span class="tab"></span><span class="small">[cl &larr; (system◦name) class.<br></span><span class="tab"></span><span class="tab"></span><span class="small">cl≡self class⇒ [⇑self]<br></span><span class="tab"></span><span class="tab"></span><span class="small">user notify: name + &rsquo; will change from a &rsquo; + cl title + &rsquo; to a &rsquo; + self class title + &rsquo; if you proceed...&rsquo;]].<br></span><span class="tab"></span><span class="small">system declare: name as: self.<br></span><span class="tab"></span><span class="small">AllClassNames &larr; AllClassNames insertSorted: name.<br></span><span class="tab"></span><span class="small">SystemOrganization classify: name under: &rsquo;As yet unclassified&rsquo;]</span></div>
<div class="line left">
<span class="small bold">title: t subclassof: s fields: f declare: d<br></span><span class="tab"></span><span class="small">[t◦1≠((t◦1) asUppercase)⇒<br></span><span class="tab"></span><span class="tab"></span><span class="small">[user notify: &rsquo;Please capitalize each word in class title: &rsquo; + t. ⇑false]<br></span><span class="tab"></span><span class="small">self title: t; subclassof: s; fields: f; declare: d]</span></div>
<div class="line left">
<span class="small bold">veryspecial: n</span><span class="tab"></span><span class="tab"></span><span class="small italic">"inaccessible fields"</span><span class="small"><br></span><span class="tab"></span><span class="small">[instsize &larr; self instvars length + n]</span></div>
<div class="line left">
<span class="medium bold"><br>Access to parts</span></div>
<div class="line left">
<span class="small bold">◦x </span><span class="small">[⇑classvars◦x]</span></div>
<div class="line left">
<span class="small bold">◦x &larr; val </span><span class="small">[⇑classvars◦x &larr; val]</span></div>
<div class="line left">
<span class="small bold">fieldNamesInto: collector<br></span><span class="tab"></span><span class="small">[[superclass≡nil⇒ [] superclass fieldNamesInto: collector].<br></span><span class="tab"></span><span class="small">⇑(Reader new of: myinstvars) readInto: collector]</span></div>
<div class="line left">
<span class="small bold">instsize<br></span><span class="small">[</span><span class="small italic">"Return the number of user accessable instance fields (self instvars length)."</span><span class="small"><br>⇑[fieldtype≥32⇒ [0] <br></span><span class="tab"></span><span class="small">self≡Class⇒ [instsize-1]<br></span><span class="tab"></span><span class="small">self≡VariableLengthClass ⇒[instsize-20]<br></span><span class="tab"></span><span class="small">instsize]]</span></div>
<div class="line left">
<span class="small bold">instvars<br></span><span class="tab"></span><span class="small">[⇑self fieldNamesInto: FieldNameCollector default]</span></div>
<div class="line left">
<span class="small bold">invertRef: refs </span><span class="small">"Refs may be a vector (to allow batching)" <br></span><span class="tab"></span><span class="tab"></span><span class="small">| cl env source ref inv sym t<br></span><span class="tab"></span><span class="small">[refs isnt: Vector⇒ [⇑(self invert: refs inVector)◦1]<br></span><span class="tab"></span><span class="small">env &larr; (self wholeEnvironment concat: (Undeclared, Smalltalk)) asStream.<br></span><span class="tab"></span><span class="small">source &larr; Dictionary init.<br></span><span class="tab"></span><span class="small">⇑refs transform⦂ ref to⦂<br></span><span class="tab"></span><span class="tab"></span><span class="small">[cl &larr; self. env reset.<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">until⦂<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">[(sym &larr; env next)≡false⇒ [inv &larr; &rsquo;unknown &rsquo; concat: ref asOop base8]<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">[cl≠nil and⦂ sym≡cl classvars⇒ [t &larr; cl title. cl &larr; cl superclass] t &larr; false].<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">(inv &larr; sym invertRef: ref)≡false⇒ [false]<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">[t⇒ []<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small"> t &larr; source lookup: sym⇒ []<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small"> source insert: sym with: (t &larr; Smalltalk invert: sym)].<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">inv &larr; (t concat: &rsquo; &rsquo;) concat: inv]<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small"> do⦂ [].<br></span><span class="tab"></span><span class="tab"></span><span class="small">inv]<br></span><span class="tab"></span><span class="small">]</span></div>
<div class="line left">
<span class="small bold">Isa: x  </span><span class="small italic">"is x on my superclass chain?"</span><span class="small"><br></span><span class="tab"></span><span class="small">[superclass ≡ x ⇒[⇑true]; ≡ nil ⇒[⇑false]<br></span><span class="tab"></span><span class="small">⇑superclass Isa: x]</span></div>
<div class="line left">
<span class="small bold">md </span><span class="small">[⇑messagedict]</span></div>
<div class="line left">
<span class="small bold">myinstvars<br></span><span class="tab"></span><span class="small">[⇑myinstvars]</span></div>
<div class="line left">
<span class="small bold">superclass </span><span class="small">[⇑superclass]</span></div>
<div class="line left">
<span class="small bold">title </span><span class="small">[⇑title]</span></div>
<div class="line left">
<span class="medium bold"><br>Organization</span></div>
<div class="line left">
<span class="small bold">classvars </span><span class="small">[⇑classvars]</span></div>
<div class="line left">
<span class="small bold">clean </span><span class="small">| name</span><span class="tab"></span><span class="small">"release unreferenced classvars"<br></span><span class="tab"></span><span class="small">[for⦂ name from: classvars do⦂<br></span><span class="tab"></span><span class="tab"></span><span class="small">[name≠↪ClassOrganization and⦂ (classvars ref: name) refct=1⇒<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">[classvars delete: name]]]</span></div>
<div class="line left">
<span class="small bold">environment<br></span><span class="tab"></span><span class="small">[⇑environment]</span></div>
<div class="line left">
<span class="small bold">organization </span><span class="small">| o<br></span><span class="tab"></span><span class="small">[</span><span class="tab"></span><span class="small">[classvars ≡ nil⇒[self declare: ↪ClassOrganization]].<br></span><span class="tab"></span><span class="small">o &larr; classvars lookup: ↪ClassOrganization.<br></span><span class="tab"></span><span class="small">o is: ClassOrganizer⇒[⇑o]<br></span><span class="tab"></span><span class="small">o &larr; ClassOrganizer new init: messagedict contents sort.<br></span><span class="tab"></span><span class="small">classvars insert: ↪ClassOrganization with: o.  ⇑o]</span></div>
<div class="line left">
<span class="small bold">wholeEnvironment<br></span><span class="tab"></span><span class="small">[⇑(classvars asVector concat: environment asVector) concat:<br></span><span class="tab"></span><span class="tab"></span><span class="small">[superclass≡nil⇒ [↪()] superclass wholeEnvironment]]</span></div>
<div class="line left">
<span class="medium bold"><br>Editing</span></div>
<div class="line left">
<span class="small bold">ed: selector </span><span class="small">| c s<br></span><span class="tab"></span><span class="small">[c&larr; self code: selector. user clearshow: c.<br></span><span class="tab"></span><span class="small">while⦂ (s&larr; user request: &rsquo;substitute: &rsquo;) do⦂<br></span><span class="tab"></span><span class="tab"></span><span class="small">[c &larr; c subst: s for: (user request: &rsquo;for: &rsquo;).<br></span><span class="tab"></span><span class="tab"></span><span class="small">user clearshow: c]<br></span><span class="tab"></span><span class="small">self understands: c]</span></div>
<div class="line left">
<span class="small bold">edit: selector </span><span class="small">| para s v<br></span><span class="tab"></span><span class="small">[para &larr;<br></span><span class="tab"></span><span class="tab"></span><span class="small">[selector=↪ClassOrganization⇒<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">[self organization asParagraph]<br></span><span class="tab"></span><span class="tab"></span><span class="small">messagedict has: selector⇒[self code: selector]<br></span><span class="tab"></span><span class="tab"></span><span class="small">nullString asParagraph].<br></span><span class="tab"></span><span class="small">self edit: selector para: para formerly: false]</span></div>
<div class="line left">
<span class="small bold">edit: selector para: para formerly: oldpara<br></span><span class="tab"></span><span class="small">[user leaveTop.<br></span><span class="tab"></span><span class="small">user restartup: (CodeWindow new class: self selector: selector para: para formerly: oldpara)]</span></div>
<div class="line left">
<span class="small bold">execute: code</span><span class="tab"></span><span class="tab"></span><span class="small italic">"disposable methods"</span><span class="small"><br></span><span class="tab"></span><span class="small">[self understands: &rsquo;doit [⇑&rsquo; + code + &rsquo;]&rsquo;.<br></span><span class="tab"></span><span class="small">⇑self new doit]</span></div>
<div class="line left">
<span class="medium bold"><br>Message access</span></div>
<div class="line left">
<span class="small bold">archiveOn: file changesOnly: ch </span><span class="small">| org m [<br></span><span class="tab"></span><span class="small">"</span><span class="small italic">this should be called only by the system releaser<br></span><span class="tab"></span><span class="small italic">(via </span><span class="small bold">UserView file:classes:changesOnly:</span><span class="small italic">) !!!<br><br></span><span class="tab"></span><span class="small italic">if you want to archive your own classes (useful only if you have stable code<br></span><span class="tab"></span><span class="small italic">and intend to clean up afterwards with a vmem write), see Steve.<br><br></span><span class="tab"></span><span class="small italic">write comment and method text on a FileStream for some file.<br></span><span class="tab"></span><span class="small italic">ch⇒ [write only changes (non-remote String/Paraagraphs)] write everything</span><span class="small">"<br><br></span><span class="tab"></span><span class="small">user cr; show: title.<br></span><span class="tab"></span><span class="small">org &larr; self organization.<br></span><span class="tab"></span><span class="small">["</span><span class="small italic">org globalComment always yields a String, so a small kludge is in order</span><span class="small">"<br></span><span class="tab"></span><span class="small">ch and⦂ (org globalCommentItself is: RemoteParagraph)⇒ []<br></span><span class="tab"></span><span class="small">org globalComment &larr;<br></span><span class="tab"></span><span class="tab"></span><span class="small">(RemoteParagraph new on: file) fromString: org globalComment].<br><br></span><span class="tab"></span><span class="small">"</span><span class="small italic">archive in category&alphabetical rather than hash order (messagedict)</span><span class="small">"<br></span><span class="tab"></span><span class="small">for⦂ m from: org do⦂ [<br></span><span class="tab"></span><span class="tab"></span><span class="small">ch and⦂ ((messagedict code: m) is: RemoteParagraph)⇒ []<br></span><span class="tab"></span><span class="tab"></span><span class="small">messagedict code: m &larr;<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">(RemoteParagraph new on: file) fromParagraph: (self code: m).<br></span><span class="tab"></span><span class="tab"></span><span class="small">ch⇒ [user space; show: m]]]</span></div>
<div class="line left">
<span class="small bold">bytesof: sel<br></span><span class="tab"></span><span class="small">[⇑(messagedict method: sel) asBytes]</span></div>
<div class="line left">
<span class="small bold">canUnderstand: selector<br></span><span class="tab"></span><span class="small">[messagedict has: selector⇒ [⇑self]<br></span><span class="tab"></span><span class="small">superclass≡nil⇒ [⇑false]<br></span><span class="tab"></span><span class="small">⇑superclass canUnderstand: selector]</span></div>
<div class="line left">
<span class="small bold">canunderstand: selector<br></span><span class="tab"></span><span class="small">[⇑messagedict has: selector]</span></div>
<div class="line left">
<span class="small bold">code: sel </span><span class="small">[ <br></span><span class="tab"></span><span class="small">"</span><span class="small italic">last paragraph returned is cached (mainly for NotifyWindows)</span><span class="small">"<br></span><span class="tab"></span><span class="small">[sel ≡ lastSelector and⦂ self ≡ lastClass ⇒ []<br></span><span class="tab"></span><span class="small">lastParagraph &larr; ([<br></span><span class="tab"></span><span class="tab"></span><span class="small">sel = ↪ClassOrganization ⇒ [self organization]<br></span><span class="tab"></span><span class="tab"></span><span class="small">"</span><span class="small italic">if left shift key is down, decompile</span><span class="small">"</span><span class="tab"></span><span class="small"><br></span><span class="tab"></span><span class="tab"></span><span class="small">user leftShiftKey⇒ [self decompile: sel]<br></span><span class="tab"></span><span class="tab"></span><span class="small">"</span><span class="small italic">Paragraph or RemoteParagraph</span><span class="small">"<br></span><span class="tab"></span><span class="tab"></span><span class="small">messagedict code: sel]) asParagraph.<br><br></span><span class="tab"></span><span class="small">lastClass &larr; self.<br></span><span class="tab"></span><span class="small">lastSelector &larr; sel].<br></span><span class="tab"></span><span class="small">⇑lastParagraph]</span></div>
<div class="line left">
<span class="small bold">compileall </span><span class="small">| s c "does not modify code, just compiles it"<br></span><span class="tab"></span><span class="small">[for⦂ s from: messagedict do⦂<br></span><span class="tab"></span><span class="tab"></span><span class="small">[c &larr; messagedict code: s.<br></span><span class="tab"></span><span class="tab"></span><span class="small"> self understands: c asParagraph.<br></span><span class="tab"></span><span class="tab"></span><span class="small"> messagedict code: s &larr; c "leave it as a remote paragraph"].<br></span><span class="tab"></span><span class="small"> self≡Object⇒[nil installError]]<br></span><span class="small italic">"to recompile the whole system (check out big changes) execute:<br></span><span class="tab"></span><span class="small italic">| n [for⦂ n from: AllClassNames do⦂<br></span><span class="tab"></span><span class="tab"></span><span class="small italic">[user show: n; cr. (Smalltalk◦n) compileall.<br></span><span class="tab"></span><span class="tab"></span><span class="small italic">Changes init. MessageDict new freeMethods]] "</span></div>
<div class="line left">
<span class="small bold">copy: sel from: class<br></span><span class="tab"></span><span class="small">[self copy: sel from: class classified: nil]</span></div>
<div class="line left">
<span class="small bold">copy: sel from: class classified: cat </span><span class="small">"Useful when modifying an existing class"<br></span><span class="tab"></span><span class="tab"></span><span class="small">| s code<br></span><span class="tab"></span><span class="small">[sel is: Vector⇒ [for⦂ s from: sel do⦂ [self copy: s from: class classified: cat]]<br></span><span class="tab"></span><span class="small">sel is: String⇒ [self copy: (class organization category: sel) from: class classified: cat]<br></span><span class="tab"></span><span class="small">code &larr; class code: sel.  code≡nil⇒ []<br></span><span class="tab"></span><span class="small">[cat≡nil⇒ [cat &larr; class organization invert: sel]].<br></span><span class="tab"></span><span class="small">[messagedict has: sel⇒<br></span><span class="tab"></span><span class="tab"></span><span class="small">[code text=(self code: sel) text⇒ []<br></span><span class="tab"></span><span class="tab"></span><span class="small">user notify: title+&rsquo; &rsquo;+sel+&rsquo; will be redefined if you proceed.&rsquo;]].<br></span><span class="tab"></span><span class="small">self understands: code classified: cat]</span></div>
<div class="line left">
<span class="small bold">decompile: t1 <br></span><span class="tab"></span><span class="small">[⇑user displayoffwhile⦂ [Decompiler new decompile: t1 class: self]]</span></div>
<div class="line left">
<span class="small bold">derstands: selector </span><span class="small">| c</span><span class="tab"></span><span class="tab"></span><span class="small italic">"overstands?  undersits? - forget it"</span><span class="small"><br></span><span class="tab"></span><span class="small">[selector is: Vector⇒[for⦂ c from: selector do⦂ [self derstands: c]]<br></span><span class="tab"></span><span class="small">(messagedict has: selector)≡false⇒[] <br></span><span class="tab"></span><span class="small">messagedict &larr; messagedict delete: selector.<br></span><span class="tab"></span><span class="small">self organization delete: selector.<br></span><span class="tab"></span><span class="small">lastClass &larr; lastSelector &larr; lastParagraph &larr; nil.<br></span><span class="tab"></span><span class="small">[Changes has: (c&larr;title+&rsquo; &rsquo;+selector)⇒ [Changes delete: c]].<br></span><span class="tab"></span><span class="small">Changes insert: (c&larr;&rsquo;~&rsquo;+c).<br></span><span class="tab"></span><span class="small">⇑c]</span></div>
<div class="line left">
<span class="small bold">describe: method on: strm </span><span class="small">| sel cls  </span><span class="small italic">"append mclass and selector"</span><span class="small"><br></span><span class="tab"></span><span class="small">[cls &larr; self.<br></span><span class="tab"></span><span class="small">until⦂ [cls≡nil⇒ [cls&larr;self. sel&larr;↪?] sel &larr; cls md invert: method] do⦂<br></span><span class="tab"></span><span class="tab"></span><span class="small">[cls &larr; cls superclass].<br></span><span class="tab"></span><span class="small">strm append: cls title; space; append: sel]</span></div>
<div class="line left">
<span class="small bold">install: name method: method literals: literals<br></span><span class="tab"></span><span class="tab"></span><span class="small bold">code: code backpointers: backpointers | c<br></span><span class="tab"></span><span class="small">[messagedict &larr; messagedict insert: name method: method<br></span><span class="tab"></span><span class="tab"></span><span class="small">literals: literals code: code makeBoldPattern backpointers: backpointers.<br></span><span class="tab"></span><span class="small">lastClass &larr; self.<br></span><span class="tab"></span><span class="small">lastSelector &larr; name.<br></span><span class="tab"></span><span class="small">lastParagraph &larr; code.<br></span><span class="tab"></span><span class="small">Changes insert: (c&larr;title+&rsquo; &rsquo;+name).<br></span><span class="tab"></span><span class="small">Changes has: (c&larr;&rsquo;~&rsquo;+c)⇒[Changes delete: c]]</span></div>
<div class="line left">
<span class="small bold">messages </span><span class="small">[⇑messagedict contents , ↪ClassOrganization]</span></div>
<div class="line left">
<span class="small bold">method: sel<br></span><span class="tab"></span><span class="small">[⇑messagedict methodorfalse: sel]</span></div>
<div class="line left">
<span class="small bold">notify: errorString at: position in: stream<br></span><span class="tab"></span><span class="small">[⇑self notify: errorString at: position in: stream for: self]</span></div>
<div class="line left">
<span class="small bold">selectors</span><span class="tab"></span><span class="tab"></span><span class="small italic">"Return a Vector of all my selectors."</span><span class="small"><br></span><span class="tab"></span><span class="small">[⇑self messages]</span></div>
<div class="line left">
<span class="small bold">shrink </span><span class="small">[messagedict &larr; messagedict shrink]</span></div>
<div class="line left">
<span class="small bold">space </span><span class="small">| a s<br></span><span class="tab"></span><span class="small">[s &larr; 0. for⦂ a from: messagedict do⦂<br></span><span class="tab"></span><span class="tab"></span><span class="small">[s &larr; s + (messagedict method: a) length]<br></span><span class="tab"></span><span class="small">⇑s]</span></div>
<div class="line left">
<span class="small bold">textLocal </span><span class="small">| s [<br></span><span class="tab"></span><span class="small">"</span><span class="small italic">makes comment and methods local</span><span class="small">"<br></span><span class="tab"></span><span class="small">s &larr; self organization.<br></span><span class="tab"></span><span class="small">s globalComment &larr; s globalComment.<br></span><span class="tab"></span><span class="small">for⦂ s from: messagedict do⦂ [messagedict code: s &larr; self code: s]]</span></div>
<div class="line left">
<span class="small bold">understands: code </span><span class="small">| selector old</span><span class="tab"></span><span class="tab"></span><span class="small italic">"install method"</span><span class="small"><br></span><span class="tab"></span><span class="small">[⇑self understands: code classified: &rsquo;As yet unclassified&rsquo;]</span></div>
<div class="line left">
<span class="small bold">understands: code classified: heading</span><span class="tab"></span><span class="tab"></span><span class="small italic">"compile and install method"</span><span class="small"><br></span><span class="tab"></span><span class="small">[⇑Generator new compile: code asParagraph<br></span><span class="tab"></span><span class="tab"></span><span class="small">in: self under: heading notifying: self]</span></div>
<div class="line left">
<span class="small bold">whosends: selector </span><span class="small">| s l a<br></span><span class="tab"></span><span class="small">[s &larr; Stream default.<br></span><span class="tab"></span><span class="small">for⦂ a from: messagedict do⦂<br></span><span class="tab"></span><span class="tab"></span><span class="small">[for⦂ l from: (messagedict literals: a) do⦂<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">[selector≡l⇒[s append: a; space]]]<br></span><span class="tab"></span><span class="small">⇑s contents]</span></div>
<div class="line left">
<span class="medium bold"><br>Instance access</span></div>
<div class="line left">
<span class="small bold">allInstances </span><span class="small">[⇑self allInstancesEver notNil]</span></div>
<div class="line left">
<span class="small bold">allInstancesEver </span><span class="small">| indx vec PCLs i </span><span class="small italic">"returns a vector containing all instances of this class mixed with nils"</span><span class="small"><br></span><span class="tab"></span><span class="small">[</span><span class="small italic">"Works for all classes.  Some additional instances may be created after the<br></span><span class="tab"></span><span class="small italic">vector is filled but before you get to use it."</span><span class="small"><br></span><span class="tab"></span><span class="small">PCLs &larr; Vmem pclassesOf: self.  </span><span class="small italic">"vector of PCLs"</span><span class="small"><br></span><span class="tab"></span><span class="small">vec &larr; Vector new: 128*PCLs length.<br></span><span class="tab"></span><span class="small">for⦂ i to: PCLs length do⦂ <br></span><span class="tab"></span><span class="tab"></span><span class="small">[(vec◦[i-1*128+1 to: i*128]) all&larr; PCLs◦i].<br></span><span class="tab"></span><span class="small">thisContext destroyAndReturn: (self fromFreelist: Class instsize fill: vec)]</span></div>
<div class="line left">
<span class="small bold">copy: inst </span><span class="small">| t i<br></span><span class="tab"></span><span class="small">[t &larr; self new.<br></span><span class="tab"></span><span class="small">for⦂ i to: self instsize do⦂<br></span><span class="tab"></span><span class="tab"></span><span class="small">[t instfield: i &larr; inst instfield: i]<br></span><span class="tab"></span><span class="small">⇑t]</span></div>
<div class="line left">
<span class="small bold">default<br></span><span class="tab"></span><span class="small">[⇑self new default]</span></div>
<div class="line left">
<span class="small bold">fromFreelist: i fill: vec </span><span class="small italic">"i = zero order index of freelist in class instance.<br></span><span class="tab"></span><span class="small italic">vec = vector in pclasses of all possible instances."</span><span class="small"><br></span><span class="tab"></span><span class="small">[user croak] primitive: 60</span></div>
<div class="line left">
<span class="small bold">howMany </span><span class="small">| v </span><span class="small italic">"how many instances of this class are in use now?"</span><span class="small"><br></span><span class="tab"></span><span class="small">[v &larr; self allInstancesEver.<br></span><span class="tab"></span><span class="small">thisContext destroyAndReturn: v length-(v count: nil)]</span></div>
<div class="line left">
<span class="small bold">init</span><span class="tab"></span><span class="tab"></span><span class="small italic">"init and default get propagated to instances"</span><span class="small"><br></span><span class="tab"></span><span class="small">[⇑self new init]</span></div>
<div class="line left">
<span class="small bold">init: n</span><span class="tab"></span><span class="tab"></span><span class="small italic">"init and default get propagated to instances"</span><span class="small"><br></span><span class="tab"></span><span class="small">[⇑self new init: n]</span></div>
<div class="line left">
<span class="small bold">instfield:</span><span class="tab"></span><span class="small bold"> i</span><span class="tab"></span><span class="small italic">"prevent user from getting freelist"</span><span class="small"><br></span><span class="tab"></span><span class="small">[i &gt; Class instsize ⇒[user notify: &rsquo;arg too big&rsquo;]<br></span><span class="tab"></span><span class="small">⇑super instfield: i]</span></div>
<div class="line left">
<span class="small bold">new </span><span class="small">[user croak] primitive: 28</span></div>
<div class="line left">
<span class="small bold">new: length </span><span class="small">"To allow fixed-length classes to simulate variable-length ones"<br></span><span class="tab"></span><span class="small">[⇑self new init: length] "By convention"</span></div>
<div class="line left">
<span class="small bold">print: inst on: strm </span><span class="small">| ivars i<br></span><span class="tab"></span><span class="small">[ivars &larr; self instvars.<br></span><span class="tab"></span><span class="small">strm append: &rsquo;(&rsquo;; append: title; append: &rsquo; new &rsquo;.<br></span><span class="tab"></span><span class="small">for⦂ i to: instsize do⦂<br></span><span class="tab"></span><span class="tab"></span><span class="small">[strm append: ivars◦i; append: &rsquo;: &rsquo;;<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">print: (inst instfield: i); space]<br></span><span class="tab"></span><span class="small">strm append: &rsquo;)&rsquo;]</span></div>
<div class="line left">
<span class="small bold">printon: strm<br></span><span class="tab"></span><span class="small">[strm append: &rsquo;Class &rsquo; + title]</span></div>
<div class="line left">
<span class="small bold">recopy: inst </span><span class="small">| t i<br></span><span class="tab"></span><span class="small">[t &larr; self new.<br></span><span class="tab"></span><span class="small">for⦂ i to: self instsize do⦂<br></span><span class="tab"></span><span class="tab"></span><span class="small">[t instfield: i &larr; (inst instfield: i) recopy]<br></span><span class="tab"></span><span class="small">⇑t]</span></div>
<div class="line left">
<span class="medium bold"><br>Filin and Filout</span></div>
<div class="line left">
<span class="small bold">asFollows </span><span class="small">| s heading selector p [<br></span><span class="tab"></span><span class="small">self≠self realself⇒[self realself asFollows]<br></span><span class="tab"></span><span class="small">heading &larr; &rsquo;As yet unclassified&rsquo;.<br><br></span><span class="tab"></span><span class="small">"</span><span class="small italic">handles Bravo or Press (Smalltalk generated) files</span><span class="small">"<br></span><span class="tab"></span><span class="small">while⦂ ((p &larr; FilinSource nextParagraph) and⦂ (s &larr; p text) ≠ &rsquo;&rsquo;) do⦂ [<br></span><span class="tab"></span><span class="tab"></span><span class="small">[s◦1 = 015⇒ [<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">"</span><span class="small italic">throw away initial cr before comment and headings</span><span class="small">"<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">s &larr; s copy: 2 to: s length]].<br></span><span class="tab"></span><span class="tab"></span><span class="small">p runs◦2<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">= 2 "</span><span class="small italic">italic</span><span class="small">"⇒ [self organization globalComment &larr; s];<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">= 0121 "</span><span class="medium bold">5, bold</span><span class="small">"⇒ [heading &larr; s]<br></span><span class="tab"></span><span class="tab"></span><span class="small">self canunderstand: (<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">selector &larr; self understands: p classified: heading)⇒ [<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">user show: selector; space. messagedict purge: selector]<br></span><span class="tab"></span><span class="tab"></span><span class="small">user show: &rsquo;(an uncompiled method) &rsquo;]]</span></div>
<div class="line left">
<span class="small bold">changelist: cat </span><span class="small">[⇑title unique, (self organization category: cat)]</span></div>
<div class="line left">
<span class="small bold">definition </span><span class="small">| strm</span><span class="tab"></span><span class="tab"></span><span class="small italic">"return a string that defines me (Class new title etc.)"</span><span class="small"><br></span><span class="tab"></span><span class="small">[strm &larr; (String new: 50) asStream.<br></span><span class="tab"></span><span class="small">self printdefon: strm.<br></span><span class="tab"></span><span class="small">⇑strm contents]</span></div>
<div class="line left">
<span class="small bold">endCategoryOn: pstrm</span></div>
<div class="line left">
<span class="small bold">endChangesOn: pstrm<br></span><span class="tab"></span><span class="small">[pstrm print: &rsquo;&rsquo; asParagraph]</span></div>
<div class="line left">
<span class="small bold">filout </span><span class="small">[user displayoffwhile⦂ [<br></span><span class="tab"></span><span class="small">(dp1 file: title+&rsquo;.st.&rsquo;) filoutclass: self.<br></span><span class="tab"></span><span class="small">self noChanges]]</span></div>
<div class="line left">
<span class="small bold">filoutCategory: cat<br></span><span class="tab"></span><span class="small">[(dp1 file: (title+&rsquo;-&rsquo;+cat+&rsquo;.st&rsquo;) asFileName) filout: (self changelist: cat)]</span></div>
<div class="line left">
<span class="small bold">filoutOrganization</span><span class="tab"></span><span class="small italic">"So we can merge separate work on organization"</span><span class="small"><br></span><span class="tab"></span><span class="small">[user show: title; cr.<br></span><span class="tab"></span><span class="small">user displayoffwhile⦂<br></span><span class="tab"></span><span class="tab"></span><span class="small">[(dp0 file: title+&rsquo;.org.&rsquo;)<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">append: title+&rsquo; organization fromParagraph:&rsquo;; cr;<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">append: self organization asParagraph text asString;<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">append: &rsquo;asParagraph&rsquo;; close]]</span></div>
<div class="line left">
<span class="small bold">noChanges </span><span class="small">| s t<br></span><span class="tab"></span><span class="small">[t&larr; title+&rsquo; *&rsquo;.<br></span><span class="tab"></span><span class="small">for⦂ s from: Changes contents do⦂<br></span><span class="tab"></span><span class="tab"></span><span class="small">[(s◦1=126 "~" and⦂ (t match: s◦(2 to: s length)))<br></span><span class="tab"></span><span class="tab"></span><span class="small"> or⦂ (t match: s)⇒<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">[Changes delete: s]]]</span></div>
<div class="line left">
<span class="small bold">paraprinton: strm</span><span class="tab"></span><span class="tab"></span><span class="small italic">"Strm is actually a ParagraphPrinter"</span><span class="small"><br></span><span class="tab"></span><span class="tab"></span><span class="small">| para frame s heading org<br></span><span class="tab"></span><span class="small">[para &larr; (&rsquo;"&rsquo;+title+&rsquo;"&rsquo;) asParagraph.<br></span><span class="tab"></span><span class="small">para maskrunsunder: 0361 to: 0121.</span><span class="tab"></span><span class="small italic">"Font &larr; 5, Bold"</span><span class="small"><br></span><span class="tab"></span><span class="small">frame &larr; strm defaultframe.<br></span><span class="tab"></span><span class="small">strm frame &larr; 15000⌾frame origin y rect: 20000⌾frame corner y.<br></span><span class="tab"></span><span class="small">strm print: para.<br></span><span class="tab"></span><span class="small">strm frame &larr; frame.<br></span><span class="tab"></span><span class="small">strm print: ((self definition+&rsquo;;<br></span><span class="tab"></span><span class="small">asFollows&rsquo;) asParagraph maskrunsunder: 0361 to: 0121).<br></span><span class="tab"></span><span class="small">org &larr; self organization.<br></span><span class="tab"></span><span class="small">strm print: (&rsquo;<br>&rsquo;+org globalComment) asParagraph allItalic.<br></span><span class="tab"></span><span class="small">for⦂ heading from: org categories do⦂<br></span><span class="tab"></span><span class="tab"></span><span class="small">[self printCategory: heading on: strm]<br></span><span class="tab"></span><span class="small">self endChangesOn: strm.<br></span><span class="tab"></span><span class="small">strm print: (&rsquo;SystemOrganization classify: ↪&rsquo;+title+&rsquo; under: &rsquo;&rsquo;&rsquo;+<br></span><span class="tab"></span><span class="tab"></span><span class="small">(SystemOrganization invert: title unique)+&rsquo;&rsquo;&rsquo;.&rsquo;) asParagraph.<br></span><span class="tab"></span><span class="small">[self ≡ Class or: self ≡ VariableLengthClass⇒ [] self canunderstand: ↪classInit⇒<br></span><span class="tab"></span><span class="tab"></span><span class="small">[strm print: (title+&rsquo; classInit&rsquo;) asParagraph]].<br></span><span class="tab"></span><span class="small">]</span></div>
<div class="line left">
<span class="small bold">printCategory: s on: pstrm </span><span class="small">| sel<br></span><span class="tab"></span><span class="small">[self startCategory: s on: pstrm.<br></span><span class="tab"></span><span class="small">for⦂ sel from: (self organization category: s) do⦂<br></span><span class="tab"></span><span class="tab"></span><span class="small">[self printMethod: sel on: pstrm].<br></span><span class="tab"></span><span class="small">self endCategoryOn: pstrm]</span></div>
<div class="line left">
<span class="small bold">printdefon: strm </span><span class="small">| s</span><span class="tab"></span><span class="tab"></span><span class="small italic">"print my definition on strm"</span><span class="small"><br></span><span class="tab"></span><span class="small">[strm append: self class title;<br></span><span class="tab"></span><span class="tab"></span><span class="small">append: &rsquo; new title: &rsquo;;<br></span><span class="tab"></span><span class="tab"></span><span class="small">"title is probably unique, but make sure. then we want it as a &rsquo;String&rsquo; "<br></span><span class="tab"></span><span class="tab"></span><span class="small">print: title unique asString.<br></span><span class="tab"></span><span class="small">strm cr; tab; append: &rsquo;subclassof: &rsquo;;<br></span><span class="tab"></span><span class="tab"></span><span class="small">append: [superclass≡nil⇒[&rsquo;nil&rsquo;] superclass title].<br></span><span class="tab"></span><span class="small">strm cr; tab; append: &rsquo;fields: &rsquo;; print: myinstvars.<br></span><span class="tab"></span><span class="small">strm cr; tab; append: &rsquo;declare: &rsquo;&rsquo;&rsquo;.<br></span><span class="tab"></span><span class="small">for⦂ s from: classvars contents do⦂<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">[s=↪ClassOrganization⇒[]<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">strm append: s; space]<br></span><span class="tab"></span><span class="small">strm append: &rsquo;&rsquo;&rsquo;&rsquo;.<br></span><span class="tab"></span><span class="small">[fieldtype=16⇒[]<br></span><span class="tab"></span><span class="tab"></span><span class="small">strm semicrtab; append: &rsquo;bytesize: &rsquo;; print: fieldtype-32].<br></span><span class="tab"></span><span class="small">[instsize = (s&larr; self instvars) length⇒[]<br></span><span class="tab"></span><span class="tab"></span><span class="small">strm semicrtab; append: &rsquo;veryspecial: &rsquo;; print: instsize-s length].<br></span><span class="tab"></span><span class="small">[environment≡nil⇒[]<br></span><span class="tab"></span><span class="tab"></span><span class="small">for⦂ s from: environment do⦂<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">[strm semicrtab; append: &rsquo;sharing: &rsquo;; append: (Smalltalk invert: s)]]]</span></div>
<div class="line left">
<span class="small bold">printMethod: sel on: pstrm<br></span><span class="tab"></span><span class="small">[pstrm print: (self code: sel).<br></span><span class="tab"></span><span class="small">messagedict purge: sel]</span></div>
<div class="line left">
<span class="small bold">printout </span><span class="small">[user displayoffwhile⦂ [<br></span><span class="tab"></span><span class="small">(dp0 file: title+&rsquo;.press.&rsquo;) printoutclass: self]]</span></div>
<div class="line left">
<span class="small bold">printoutCategory: cat<br></span><span class="tab"></span><span class="small">[(dp0 file: (title+&rsquo;-&rsquo;+cat+&rsquo;.press&rsquo;) asFileName) printout: (self changelist: cat)]</span></div>
<div class="line left">
<span class="small bold">readfrom: strm </span><span class="small">[⇑self readfrom: strm format: nil]</span></div>
<div class="line left">
<span class="small bold">readfrom: strm format: f </span><span class="small">[<br></span><span class="tab"></span><span class="small">⇑self new readfrom: strm format: f]</span></div>
<div class="line left">
<span class="small bold">startCategory: s on: pstrm<br></span><span class="tab"></span><span class="small">[pstrm print: ((&rsquo;<br>&rsquo;+s) asParagraph maskrunsunder: 0361 to: 0121).</span><span class="tab"></span><span class="tab"></span><span class="small italic">"Font 5, Bold"</span><span class="small"><br></span><span class="tab"></span><span class="small">]</span></div>
<div class="line left">
<span class="small bold">startChangesOn: pstrm<br></span><span class="tab"></span><span class="small">[pstrm print: ((&rsquo;<br>&rsquo;+title+&rsquo; asFollows&rsquo;) asParagraph maskrunsunder: 0361 to: 0121).</span><span class="tab"></span><span class="tab"></span><span class="small italic">"Font 5, Bold"</span><span class="small"><br></span><span class="tab"></span><span class="small">]</span></div>
<div class="line left">
<span class="medium bold"><br>System Organization</span></div>
<div class="line left">
<span class="small bold">category </span><span class="small">[⇑SystemOrganization invert: self title unique]</span></div>
<div class="line left">
<span class="small bold">category: cat<br></span><span class="tab"></span><span class="small">[cat is: String ⇒[SystemOrganization add: self title unique under: cat]<br></span><span class="tab"></span><span class="tab"></span><span class="small">user notify: &rsquo;Category name must be a String&rsquo;]</span></div>
<div class="line left">
<span class="small bold">moveFromCat: cat1 to: cat2<br></span><span class="tab"></span><span class="small">[(cat1 is: String) and⦂ (cat2 is: String) ⇒<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">[SystemOrganization move: self title unique from: cat1 to: cat2]<br></span><span class="tab"></span><span class="tab"></span><span class="small">user notify: &rsquo;Category name must be a String&rsquo;]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪Class under: &rsquo;Kernel Classes&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="medium bold"><br>"Context"</span></div>
<div class="line left">
<span class="medium bold">Class new title: &rsquo;Context&rsquo;<br></span><span class="tab"></span><span class="medium bold">subclassof: Object<br></span><span class="tab"></span><span class="medium bold">fields: &rsquo;sender "&lt;Context&gt; from which this message was sent"<br></span><span class="tab"></span><span class="tab"></span><span class="medium bold">receiver "&lt;Object&gt; to which this message was sent"<br></span><span class="tab"></span><span class="tab"></span><span class="medium bold">keep "&lt;true, nil&gt; nil means reclaimable"<br></span><span class="tab"></span><span class="tab"></span><span class="medium bold">method "&lt;String&gt;, the encoded method"<br></span><span class="tab"></span><span class="tab"></span><span class="medium bold">tempframe "&lt;Vector&gt; to hold temporaries and a stack"<br></span><span class="tab"></span><span class="tab"></span><span class="medium bold">pc "&lt;Integer&gt; marks progress of execution in method"<br></span><span class="tab"></span><span class="tab"></span><span class="medium bold">stackptr "&lt;Integer&gt; offset of stack top in tempframe"&rsquo;<br></span><span class="tab"></span><span class="medium bold">declare: &rsquo;arrayFld positionFld limitFld &rsquo;;<br></span><span class="tab"></span><span class="medium bold">asFollows</span></div>
<div class="line left">
<span class="small italic"><br>A context keeps track of the progress of a method</span></div>
<div class="line left">
<span class="medium bold"><br>Initialization</span></div>
<div class="line left">
<span class="small bold">cleancopy<br></span><span class="tab"></span><span class="small">[⇑Context new<br></span><span class="tab"></span><span class="tab"></span><span class="small">sender: sender<br></span><span class="tab"></span><span class="tab"></span><span class="small">receiver: receiver<br></span><span class="tab"></span><span class="tab"></span><span class="small">method: method<br></span><span class="tab"></span><span class="tab"></span><span class="small">tempframe: tempframe copy<br></span><span class="tab"></span><span class="tab"></span><span class="small">pc: pc<br></span><span class="tab"></span><span class="tab"></span><span class="small">stackptr: stackptr]</span></div>
<div class="line left">
<span class="small bold">copy<br></span><span class="small">[<br></span><span class="tab"></span><span class="small">⇑ Context new<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">sender: sender<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">receiver: receiver<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">method: method<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">tempframe: tempframe<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">pc: pc<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">stackptr: stackptr<br>]</span></div>
<div class="line left">
<span class="small bold">sender: sender receiver: receiver<br></span><span class="tab"></span><span class="tab"></span><span class="small bold">method: method tempframe: tempframe pc: pc stackptr: stackptr</span></div>
<div class="line left">
<span class="medium bold"><br>Access to parts</span></div>
<div class="line left">
<span class="small bold">caller </span><span class="small">[⇑sender]<br></span></div>
<div class="line left">
<span class="small bold">getPT: i  </span><span class="small">[ ⇑ tempframe◦i ]</span></div>
<div class="line left">
<span class="small bold">mclass </span><span class="small">| selector mclass</span><span class="tab"></span><span class="tab"></span><span class="small italic">"return the class in which method was found"</span><span class="small"><br></span><span class="tab"></span><span class="small">[sender ≡ nil ⇒ [⇑receiver class]<br></span><span class="tab"></span><span class="small">selector &larr; self selector.<br></span><span class="tab"></span><span class="small">mclass &larr; receiver class.<br></span><span class="tab"></span><span class="small">until⦂ mclass ≡ nil do⦂<br></span><span class="tab"></span><span class="tab"></span><span class="small">[(mclass method: selector) ≡ method ⇒ [⇑mclass]<br></span><span class="tab"></span><span class="tab"></span><span class="small">mclass &larr; mclass superclass].<br></span><span class="tab"></span><span class="small">⇑receiver class]</span></div>
<div class="line left">
<span class="small bold">method<br></span><span class="tab"></span><span class="small">[⇑method]</span></div>
<div class="line left">
<span class="small bold">pc </span><span class="small">[⇑pc]</span></div>
<div class="line left">
<span class="small bold">receiver<br></span><span class="tab"></span><span class="small">[⇑receiver]</span></div>
<div class="line left">
<span class="small bold">selector </span><span class="small">| mclass selector</span><span class="tab"></span><span class="tab"></span><span class="small italic">"return the selector for my method"</span><span class="small"><br></span><span class="tab"></span><span class="small">[selector &larr; sender thisop.<br></span><span class="tab"></span><span class="small">selector◦(1~19)=&rsquo;performDangerously:&rsquo;⇒<br></span><span class="tab"></span><span class="tab"></span><span class="small">[mclass &larr; receiver class.</span><span class="tab"></span><span class="tab"></span><span class="small italic">"special work for perform"</span><span class="small"><br></span><span class="tab"></span><span class="tab"></span><span class="small">until⦂ [mclass ≡ nil or⦂ (selector&larr;mclass md invert: method)] do⦂<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">[mclass &larr; mclass superclass]<br></span><span class="tab"></span><span class="tab"></span><span class="small">selector≡false⇒[⇑↪confused] ⇑selector]<br></span><span class="tab"></span><span class="small">⇑selector]</span></div>
<div class="line left">
<span class="small bold">sender </span><span class="small">[⇑sender]</span></div>
<div class="line left">
<span class="small bold">sender&larr; sender </span><span class="small">[]</span></div>
<div class="line left">
<span class="small bold">setPT: i to: n  </span><span class="small">[ tempframe◦i &larr; n ]</span></div>
<div class="line left">
<span class="small bold">stackIndex </span><span class="small italic">"Return the subscript in tempframe of my top of stack."</span><span class="small"><br></span><span class="tab"></span><span class="small">[⇑stackptr+1]</span></div>
<div class="line left">
<span class="small bold">swapSender: coroutine </span><span class="small">| oldSender<br></span><span class="tab"></span><span class="small">[oldSender &larr; sender. sender &larr; coroutine. ⇑oldSender]</span><span class="tab"></span></div>
<div class="line left">
<span class="small bold">tempframe<br></span><span class="tab"></span><span class="small">[⇑tempframe]</span></div>
<div class="line left">
<span class="small bold">totalPT </span><span class="small">[⇑ (method◦5)+1 ]</span></div>
<div class="line left">
<span class="medium bold"><br>Control structures</span></div>
<div class="line left">
<span class="small bold">for⦂ var1 from: expr1 with⦂ var2 from: expr2 do⦂ stmt </span><span class="small">| s1 s2<br></span><span class="tab"></span><span class="small">[s1 &larr; expr1 asStream. s2 &larr; expr2 asStream.<br></span><span class="tab"></span><span class="small">while⦂ [(var1 value &larr; s1 next) and⦂ (var2 value &larr; s2 next)] do⦂ stmt eval]<br></span></div>
<div class="line left">
<span class="medium bold"><br>Debugging</span></div>
<div class="line left">
<span class="small bold">debug </span><span class="small">| t v<br></span><span class="tab"></span><span class="small">[self print.<br></span><span class="tab"></span><span class="small">while⦂ [user cr. t &larr; user request: &rsquo;*&rsquo;] do⦂  </span><span class="small italic">"until ctrl-d"</span><span class="small"><br></span><span class="tab"></span><span class="tab"></span><span class="small">[v &larr; Generator new evaluate: t asStream in: false to: self notifying: nil.<br></span><span class="tab"></span><span class="tab"></span><span class="small">↪debugret=v⇒[self print] v print]<br></span><span class="tab"></span><span class="small">⇑↪debugret]</span></div>
<div class="line left">
<span class="small bold">printon: strm </span><span class="small">| mc<br></span><span class="tab"></span><span class="small">[</span><span class="small italic">"Print the selector which invoked this Context<br></span><span class="tab"></span><span class="small italic">  and the class in which code was found for that selector"</span><span class="small"><br></span><span class="tab"></span><span class="small"> mc &larr; self mclass.<br></span><span class="tab"></span><span class="small"> strm append: mc title. sender≡nil⇒ []<br></span><span class="tab"></span><span class="small"> [receiver is: mc⇒[] strm append: &rsquo;(&rsquo;+receiver class title+&rsquo;)&rsquo;].<br></span><span class="tab"></span><span class="small"> strm append: &rsquo;⇒&rsquo;; print: self selector]</span></div>
<div class="line left">
<span class="small bold">restartWith: method<br></span><span class="tab"></span><span class="small">[tempframe &larr; tempframe copy: 1 to: method◦3.<br></span><span class="tab"></span><span class="small">self restart]</span></div>
<div class="line left">
<span class="small bold">stack </span><span class="small">| a strm<br></span><span class="tab"></span><span class="small">[</span><span class="small italic">"Return a Vector of me and all my derivative contexts."</span><span class="small"><br></span><span class="tab"></span><span class="small">strm &larr; (Vector new: 20) asStream.<br></span><span class="tab"></span><span class="small">strm next &larr; a &larr; self.<br></span><span class="tab"></span><span class="small">"</span><span class="small italic">when user notifty is fixed,</span><span class="small"> a sender </span><span class="small italic">can become</span><span class="small"> a caller"<br></span><span class="tab"></span><span class="small">until⦂ (a&larr;a sender)≡nil do⦂ [strm next &larr; a].<br></span><span class="tab"></span><span class="small">⇑strm contents.]</span></div>
<div class="line left">
<span class="small bold">thisop </span><span class="small">| a</span><span class="tab"></span><span class="tab"></span><span class="small italic">"return the message selector just sent"</span><span class="small"><br></span><span class="tab"></span><span class="small">[a &larr; method◦pc.<br></span><span class="tab"></span><span class="small">a≥0320⇒ [⇑self litof: a-0320]<br></span><span class="tab"></span><span class="small">a≥0260⇒ [⇑SpecialOops◦(10+a-0260)]<br></span><span class="tab"></span><span class="small">method◦(pc-1)=0214⇒ [⇑self litof: a]<br></span><span class="tab"></span><span class="small">⇑↪confused]</span></div>
<div class="line left">
<span class="small bold">trace </span><span class="small">| strm a<br></span><span class="tab"></span><span class="small">[strm &larr; Stream default. self printon: strm.<br></span><span class="tab"></span><span class="small">a &larr; sender. until⦂ a≡nil do⦂<br></span><span class="tab"></span><span class="tab"></span><span class="small">[strm cr. a printon: strm. a &larr; a sender]<br></span><span class="tab"></span><span class="small">⇑strm contents]</span></div>
<div class="line left">
<span class="small bold">variableNamesInto: dest with: block </span><span class="small">| class selector parser<br></span><span class="tab"></span><span class="small">[</span><span class="small italic">"For each method variable name, call<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small italic">dest declaration: block name: string asArg: &lt;true or false&gt;<br></span><span class="tab"></span><span class="tab"></span><span class="small italic">If cant find source code, call dest notify: "</span><span class="small"><br></span><span class="tab"></span><span class="small">class &larr; self mclass.<br></span><span class="tab"></span><span class="small">selector &larr; class md invert: method⇒<br></span><span class="tab"></span><span class="tab"></span><span class="small">[parser &larr; Parser new from: (class code: selector) asStream to: dest.<br></span><span class="tab"></span><span class="tab"></span><span class="small">parser pattern: block; temporaries: block; terminate]<br></span><span class="tab"></span><span class="small">dest notify: &rsquo;thisContext is not running a currently defined method&rsquo;]</span></div>
<div class="line left">
<span class="small bold">verifyFrames  </span><span class="small">| c </span><span class="small italic">"be sure frames on stack aren&rsquo;t nil"</span><span class="small"><br></span><span class="tab"></span><span class="small">[c &larr; self.<br></span><span class="tab"></span><span class="small"> until⦂ c≡nil do⦂<br></span><span class="tab"></span><span class="tab"></span><span class="small">[c tempframe≡nil⇒<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">[user notify: &rsquo;Sorry, that stack has been released -- proceeding is impossible&rsquo;; restart]<br></span><span class="tab"></span><span class="tab"></span><span class="small"> c &larr; c sender]]</span></div>
<div class="line left">
<span class="medium bold"><br>Simulation</span></div>
<div class="line left">
<span class="small bold">docode: code toclass: class </span><span class="small">| i v<br></span><span class="tab"></span><span class="small">[[(i&larr;code◦2)≠ 0 ⇒<br></span><span class="tab"></span><span class="tab"></span><span class="small">[i = 1  ⇒ [⇑self];<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">= 30 ⇒ [v &larr; self pop. v push: self. ⇑v];<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">= 40 ⇒ [v &larr; self pop instfield: code◦5 + 1. ⇑self push: v];<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">= 41 ⇒ [user notify: &rsquo;Field&larr; primitive unimplemented&rsquo;];<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">= 87 ⇒ [⇑ receiver "PriorityInterrupt run: newContext"];<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">= 101 ⇒ [user notify: &rsquo;Doprimitive unimplemented&rsquo;];<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">= 102 ⇒ [⇑self performing: code◦4 toclass: tempframe◦(stackptr+1)]<br></span><span class="tab"></span><span class="tab"></span><span class="small"> (v &larr; self doprimitive: code) ≡ ↪failed ⇒[]<br></span><span class="tab"></span><span class="tab"></span><span class="small"> stackptr &larr; stackptr-(code◦4+1). ⇑self push: v]].<br></span><span class="tab"></span><span class="small"> ⇑self newToRun: code]</span></div>
<div class="line left">
<span class="small bold">dojump: displacement<br></span><span class="tab"></span><span class="small">[pc &larr; pc+displacement]</span></div>
<div class="line left">
<span class="small bold">dopop<br></span><span class="tab"></span><span class="small">[stackptr &larr; stackptr-1]</span></div>
<div class="line left">
<span class="small bold">doprimitive: code<br></span><span class="tab"></span><span class="small">[⇑↪failed] primitive: 101</span></div>
<div class="line left">
<span class="small bold">doremotereturn </span><span class="small">| t f<br></span><span class="tab"></span><span class="small">[t &larr; self pop. f &larr; self pop. ⇑f push: t]</span></div>
<div class="line left">
<span class="small bold">doreturn </span><span class="small">| t<br></span><span class="tab"></span><span class="small">[t &larr; tempframe◦(stackptr+1). tempframe &larr; nil. ⇑sender push: t]</span></div>
<div class="line left">
<span class="small bold">dostore </span><span class="small">| byte<br></span><span class="tab"></span><span class="small">[byte &larr; method◦(pc&larr; pc+1).<br></span><span class="tab"></span><span class="small"> byte&lt;020⇒ [self smashField: byte];<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">&lt;040⇒ [self smashTemp: byte-020];<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">&lt;0100⇒ [user notify: &rsquo;Store into literal&rsquo;];<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">&lt;0160⇒ [self smashLitInd: byte-0100];<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">&lt;0170⇒ [self instfield: (byte-0157) &larr; tempframe◦(stackptr+1)];<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">=0210⇒ [self smashField: self nextByte];<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">=0211⇒ [self smashTemp: self nextByte];<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">=0213⇒ [self smashLitInd: self nextByte]<br></span><span class="tab"></span><span class="small"> user notify: &rsquo;Illegal store&rsquo;<br></span><span class="tab"></span><span class="small">]</span></div>
<div class="line left">
<span class="small bold">dosuper </span><span class="small">| byte<br></span><span class="tab"></span><span class="small">[byte &larr; self nextByte.<br></span><span class="tab"></span><span class="small">[byte=0214⇒ [byte &larr; self nextByte+0320]].<br></span><span class="tab"></span><span class="small">byte&lt;0260⇒ [user notify: &rsquo;non-selector after super&rsquo;]<br></span><span class="tab"></span><span class="small">⇑self sendmess: nil byte: byte toclass: <br></span><span class="tab"></span><span class="tab"></span><span class="small">(self litof: method◦6-8/2) value superclass]</span></div>
<div class="line left">
<span class="small bold">doUnique </span><span class="small">| r e "cause ◦ &larr; to be done for a UniqueString inside str: inside intern:"<br></span><span class="tab"></span><span class="small">[r &larr; tempframe◦(2+stackptr). "receiver"<br></span><span class="tab"></span><span class="small">"already know class is UniqueString"<br></span><span class="tab"></span><span class="small">e &larr; &rsquo;bad special message in super&rsquo;.<br></span><span class="tab"></span><span class="small">(method ≡ (UniqueString md method: ↪str:)) ≡ false ⇒[user notify: e]<br></span><span class="tab"></span><span class="small">"ours, now put result of str: on the stack"<br></span><span class="tab"></span><span class="small">self push: (r &larr; r str: tempframe◦1 "arg").<br></span><span class="tab"></span><span class="small">method◦(method length) ≠ 0203 "return" ⇒[user notify: e]<br></span><span class="tab"></span><span class="small">"trick this method into returning"<br></span><span class="tab"></span><span class="small">pc &larr; method length -1.<br></span><span class="tab"></span><span class="small">⇑self]</span></div>
<div class="line left">
<span class="small bold">help<br></span><span class="tab"></span><span class="small">["Here is how to use the Smalltalk simulator.<br><br></span><span class="tab"></span><span class="small">thisContext runsimulated⦂ [ </span><span class="small bold">place here the code you to simulate</span><span class="small"> ].<br><br></span><span class="tab"></span><span class="small">Some classes in Smalltalk may not be subclassed.  Some messages<br></span><span class="tab"></span><span class="small">may not be overridden.  initSimulator tells the details. "]</span></div>
<div class="line left">
<span class="small bold">initSimulator </span><span class="small">| i "these class variables of Context are used by instfield: to simulate what the microcode does to objects."<br></span><span class="tab"></span><span class="small">["  Context declare: &rsquo;positionFld arrayFld limitFld&rsquo;.    "<br></span><span class="tab"></span><span class="small">"Rules:  There may not be a subclass of Integer.<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">(This is so +, -, &lt;, &gt;, ≤, ≥, =, ≠ may not be overridden).<br></span><span class="tab"></span><span class="small">The following messages may NOT be redefined by any class.<br></span><span class="tab"></span><span class="tab"></span><span class="small">≡ (from class Object).<br></span><span class="tab"></span><span class="tab"></span><span class="small">class (from class Object).<br></span><span class="tab"></span><span class="small">The following messages may NOT be redefined by any VariableLengthClass.<br></span><span class="tab"></span><span class="tab"></span><span class="small">length (from Vector, String)"<br><br></span><span class="tab"></span><span class="small">i &larr; Stream instvars.  "We need to peek inside instances of Stream"<br></span><span class="tab"></span><span class="small">positionFld &larr; i find: &rsquo;position&rsquo;.<br></span><span class="tab"></span><span class="small">arrayFld &larr; i find: &rsquo;array&rsquo;.<br></span><span class="tab"></span><span class="small">limitFld &larr; i find: &rsquo;limit&rsquo;.<br></span><span class="tab"></span><span class="small">]</span></div>
<div class="line left">
<span class="small bold">litof: a<br></span><span class="tab"></span><span class="small">[⇑(method word: a+4) asObject]</span></div>
<div class="line left">
<span class="small bold">newToRun: code </span><span class="small">| r v i</span><span class="small bold"><br></span><span class="tab"></span><span class="small">[r &larr; self pop. v &larr; Vector new: code◦3.<br></span><span class="tab"></span><span class="small"> for⦂ i from: (code◦4 to: 1 by: ¬1) do⦂ "Move args to new tframe"<br></span><span class="tab"></span><span class="tab"></span><span class="small">[v◦i &larr; tempframe◦(2+(stackptr &larr; stackptr-1)).<br></span><span class="tab"></span><span class="tab"></span><span class="small">tempframe◦(stackptr+2) &larr; nil</span><span class="tab"></span><span class="small">"Nil args on caller&rsquo;s stack"<br></span><span class="tab"></span><span class="tab"></span><span class="small">].<br></span><span class="tab"></span><span class="small"> ⇑self class new sender: self receiver: r method: code<br></span><span class="tab"></span><span class="tab"></span><span class="small">tempframe: v pc: code◦6 stackptr: code◦5 - 1. "Allocate a new Context"<br></span><span class="tab"></span><span class="small">]</span></div>
<div class="line left">
<span class="small bold">nextByte<br></span><span class="tab"></span><span class="small">[⇑method◦(pc &larr; pc+1)]</span></div>
<div class="line left">
<span class="small bold">nonEmptyStack<br></span><span class="tab"></span><span class="small">[⇑(stackptr≠¬1)]</span></div>
<div class="line left">
<span class="small bold">performing: nargs toclass: class </span><span class="small">| i sel<br></span><span class="tab"></span><span class="small">[i &larr; stackptr-nargs.<br></span><span class="tab"></span><span class="small">sel &larr; tempframe◦(i+1).</span><span class="tab"></span><span class="small">"Selector is first arg"<br></span><span class="tab"></span><span class="small">while⦂ i&lt;stackptr do⦂<br></span><span class="tab"></span><span class="tab"></span><span class="small">[tempframe◦(i+1) &larr; tempframe◦(i+2).<br></span><span class="tab"></span><span class="tab"></span><span class="small">i &larr; i+1].<br></span><span class="tab"></span><span class="small">stackptr &larr; stackptr-1.<br></span><span class="tab"></span><span class="small">⇑self sendmess: sel byte: 0320 toclass: class]</span></div>
<div class="line left">
<span class="small bold">pop<br></span><span class="tab"></span><span class="small">[⇑tempframe◦(2+ (stackptr&larr; stackptr-1))]</span></div>
<div class="line left">
<span class="small bold">push: n </span><span class="small">"Push n on top of stack"<br></span><span class="tab"></span><span class="small">[tempframe◦(1+(stackptr&larr;stackptr+1)) &larr; n]</span></div>
<div class="line left">
<span class="small bold">pushField: i<br></span><span class="tab"></span><span class="small">[tempframe◦(1+(stackptr&larr;stackptr+1)) &larr; receiver instfield: i+1]</span></div>
<div class="line left">
<span class="small bold">pushLit: i<br></span><span class="tab"></span><span class="small">[tempframe◦(1+(stackptr&larr;stackptr+1)) &larr; (method word: i+4) asObject]</span></div>
<div class="line left">
<span class="small bold">pushLitInd: i<br></span><span class="tab"></span><span class="small">[tempframe◦(1+(stackptr&larr;stackptr+1)) &larr; (method word: i+4) asObject value]</span></div>
<div class="line left">
<span class="small bold">pushTemp: i<br></span><span class="tab"></span><span class="small">[tempframe◦(1+(stackptr&larr;stackptr+1)) &larr; tempframe◦(i+1)]</span></div>
<div class="line left">
<span class="small bold">restart<br></span><span class="tab"></span><span class="small">[pc &larr; method◦6. stackptr &larr; method◦5-1]</span></div>
<div class="line left">
<span class="small bold">runsimulated⦂ cntxt </span><span class="small">| ctx b i "To use the simulator say...<br></span><span class="tab"></span><span class="tab"></span><span class="small">thisContext runsimulated⦂ [your code]. "<br></span><span class="tab"></span><span class="small">["turn off use of BitBlt by Strings"<br></span><span class="tab"></span><span class="small">b &larr; String◦↪StringBlter.<br></span><span class="tab"></span><span class="small">String◦↪StringBlter &larr; false.<br><br></span><span class="tab"></span><span class="small">cntxt push: self.  ctx &larr; cntxt.<br></span><span class="tab"></span><span class="small">until⦂ ctx≡self do⦂ [ctx &larr; ctx step].<br><br></span><span class="tab"></span><span class="small">"restore state of StringBlter"<br></span><span class="tab"></span><span class="small">String◦↪StringBlter &larr; b.<br></span><span class="tab"></span><span class="small">⇑self pop]</span></div>
<div class="line left">
<span class="small bold">sendmess: sel byte: byte toclass: class </span><span class="small">| cl code</span><span class="small bold"><br></span><span class="tab"></span><span class="small">[cl &larr; class.  until⦂ cl≡nil do⦂<br></span><span class="tab"></span><span class="tab"></span><span class="small">[[byte&lt;0320⇒ "Is it a special message?"<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">[self specialmess: byte toclass: cl⇒ [⇑self] "Can we perform it?"<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small"> sel &larr; SpecialOops◦(byte-0246)] "Send the special message selector"<br></span><span class="tab"></span><span class="tab"></span><span class="small">  sel≡nil⇒ [sel &larr; self litof: byte-0320]]. "Send the selector from the literals"<br></span><span class="tab"></span><span class="tab"></span><span class="small"> code &larr; cl md methodorfalse: sel⇒ [⇑self docode: code toclass: cl]<br></span><span class="tab"></span><span class="small">  </span><span class="tab"></span><span class="small"> cl &larr; cl superclass]. "Try up the superclass chain"<br></span><span class="tab"></span><span class="small"> user notify: (&rsquo;Simulated message not understood: &rsquo; concat: sel asString)]</span></div>
<div class="line left">
<span class="small bold">simulate⦂ cntxt<br></span><span class="tab"></span><span class="small">[cntxt push: thisContext.  ⇑cntxt inspect]</span></div>
<div class="line left">
<span class="small bold">smashField: i<br></span><span class="tab"></span><span class="small">[receiver instfield: i+1 &larr; tempframe◦(stackptr+1)]</span></div>
<div class="line left">
<span class="small bold">smashLitInd: i<br></span><span class="tab"></span><span class="small">[(self litof: i) value &larr; tempframe◦(stackptr+1)]</span></div>
<div class="line left">
<span class="small bold">smashTemp: i<br></span><span class="tab"></span><span class="small">[tempframe◦(i+1) &larr; tempframe◦(stackptr+1)]</span></div>
<div class="line left">
<span class="small bold">specialmess: byte toclass: class </span><span class="small">| "Return false if cannot do it here, else do exactly what the microcode does."<br></span><span class="tab"></span><span class="small">[byte&lt;0270⇒  "+, -, &lt;, &gt;, ≤, ≥, =, ≠"<br></span><span class="tab"></span><span class="tab"></span><span class="small">[⇑self specialmess: byte toclassInteger: class];<br></span><span class="tab"></span><span class="tab"></span><span class="small">&lt;0300⇒[⇑false];  "unused"<br></span><span class="tab"></span><span class="tab"></span><span class="small">&lt;0304⇒   " ◦, ◦&larr;, next, next&larr; "<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">[⇑self specialmess: byte toclassArray: class];<br></span><span class="tab"></span><span class="tab"></span><span class="small">=0304⇒ "length"<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">[ [class≡String⇒[] class≡Vector⇒[] ⇑false]. self push: (self pop length)];<br></span><span class="tab"></span><span class="tab"></span><span class="small">=0305⇒ "≡"  [self push: self pop≡self pop]<br></span><span class="tab"></span><span class="small">⇑false]</span></div>
<div class="line left">
<span class="small bold">specialmess: byte toclassArray: class </span><span class="small">| r n d i s l easy "cause ◦, ◦&larr;, next, next&larr;  to happen"<br></span><span class="tab"></span><span class="small">[d &larr; stackptr.  r &larr; self pop.<br></span><span class="tab"></span><span class="small">[byte=0301 or⦂ byte=0303 ⇒[n &larr; self pop]]. " ◦&larr; or next&larr; "<br></span><span class="tab"></span><span class="small">[byte&lt;0302⇒<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">[   " ◦ or ◦&larr; "<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">[class≡Vector⇒[] class≡String⇒[] stackptr &larr; d. ⇑false].<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">i &larr; self pop. l &larr; r length]<br></span><span class="tab"></span><span class="tab"></span><span class="small">class≡Stream⇒ " next or next&larr; "<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">[s &larr; r. i &larr; (s instfield: positionFld)+1.<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">l &larr; (s instfield: limitFld). r &larr; (s instfield: arrayFld).<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small"> [r class≡Vector⇒[]; ≡String⇒[]; ≡Interval⇒[] stackptr &larr; d. ⇑false].<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">]<br></span><span class="tab"></span><span class="tab"></span><span class="small">stackptr &larr; d. ⇑false].<br></span><span class="tab"></span><span class="small"><br></span><span class="tab"></span><span class="small">easy &larr; [r class≡Vector⇒[true]; ≡String⇒[true]; ≡Interval⇒[true] false].<br></span><span class="tab"></span><span class="small">[(i class ≡ Integer) and⦂ (l class ≡ Integer)⇒<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">[1≤i and⦂ i≤l⇒  " bounds check "<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">[[easy ⇒[byte=0301 or⦂ byte=0303⇒ "in the easy case, we cheat for speed"<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">[r◦i &larr; n]  " ◦&larr; or next&larr; "<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">n &larr; r◦i]  " ◦ or next "<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">"subclass of Vector or String"<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">byte=0301 or⦂ byte =0303 ⇒[r instfield: i &larr; n] " ◦&larr; or next&larr; "<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">n &larr; r instfield: i].<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small"> self push: n.<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small"> [byte&gt;0301⇒[s instfield: positionFld &larr; i]]. ⇑self]]].<br></span><span class="tab"></span><span class="small">stackptr &larr; d. ⇑false]</span></div>
<div class="line left">
<span class="small bold">specialmess: byte toclassInteger: class </span><span class="small">| r n "If class is Integer, do arithmetic"<br></span><span class="tab"></span><span class="small">[class ≡ Integer⇒<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">[r &larr; self pop. n &larr; self pop.<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small"> r class ≡ Integer⇒<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">[⇑self push: [byte<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">=0260⇒ [r+n];  =0261⇒ [r-n];<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">=0262⇒ [r&lt;n];  =0263⇒ [r&gt;n]; =0264⇒ [r≤n];  =0265⇒ [r≥n];<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">=0266⇒ [r=n];  =0267⇒ [r≠n]]]<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small"> stackptr &larr; stackptr+2. ⇑false]<br></span><span class="tab"></span><span class="small">⇑false]</span></div>
<div class="line left">
<span class="small bold">step </span><span class="small">| byte t "Execute the next byte code and return the current Context"<br></span><span class="tab"></span><span class="small">[byte &larr; method◦(pc &larr; pc+1).<br></span><span class="tab"></span><span class="small">⇑[byte&lt;0200⇒ "load"<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">[byte&lt;020⇒ [self pushField: byte];<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">&lt;040⇒ [self pushTemp: byte-020];<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">&lt;0100⇒ [self pushLit: byte-040];<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">&lt;0160⇒ [self pushLitInd: byte-0100];<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">&lt;0170⇒ [self push: (self instfield: byte-0160+1)]<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small"> self push: SpecialOops◦(byte-0170+2)];<br></span><span class="tab"></span><span class="tab"></span><span class="small">&lt;0220⇒<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">[byte=0200⇒ [self dostore; dopop];<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">=0201⇒ [self dostore];<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">=0202⇒ [self dopop];<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">=0203⇒ [self doreturn];<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">=0204⇒ [self doremotereturn];<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">=0205⇒ [self push: self];<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">=0206⇒ [self dosuper];<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">=0210⇒ [self pushField: self nextByte];<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">=0211⇒ [self pushTemp: self nextByte];<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">=0212⇒ [self pushLit: self nextByte];<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">=0213⇒ [self pushLitInd: self nextByte];<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">=0214⇒ [self sendmess: nil byte: self nextByte+0320<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small"> toclass: (tempframe◦(stackptr+1)) class]<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small"> user notify: &rsquo;Unimplemented instruction code&rsquo;];<br></span><span class="tab"></span><span class="tab"></span><span class="small">&lt;0260⇒ "jump"<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">[t &larr; [byte&lt;0240⇒[(byte land: 7)+1]<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">"short, just mask off bfp bit for displacement"<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small"> (byte land: 7)-4*256+self nextByte].</span><span class="tab"></span><span class="small">"long, calculate displacement"<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">[(byte land: 010)≠0⇒[self pop≡false⇒[self dojump: t]]<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">"bfp, do branch if top is false"<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small"> self dojump: t].</span><span class="tab"></span><span class="small">"unconditional, do the branch"<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">self]<br></span><span class="tab"></span><span class="small"> self sendmess: nil byte: byte toclass: (tempframe◦(stackptr+1)) class]<br></span><span class="tab"></span><span class="small">]</span></div>
<div class="line left">
<span class="medium bold"><br>Remote evaluation</span></div>
<div class="line left">
<span class="small bold">eval </span><span class="small">[user croak] primitive: 30</span></div>
<div class="line left">
<span class="small bold">remoteCopy<br></span><span class="tab"></span><span class="small">| tResult</span><span class="small bold"><br></span><span class="small">[<br></span><span class="tab"></span><span class="small">tResult &larr; RemoteContext new<br></span><span class="tab"></span><span class="tab"></span><span class="small">sender: sender<br></span><span class="tab"></span><span class="tab"></span><span class="small">receiver: receiver<br></span><span class="tab"></span><span class="tab"></span><span class="small">method: method<br></span><span class="tab"></span><span class="tab"></span><span class="small">tempframe: tempframe<br></span><span class="tab"></span><span class="tab"></span><span class="small">pc: pc+2<br></span><span class="tab"></span><span class="tab"></span><span class="small">stackptr: stackptr.<br></span><span class="tab"></span><span class="small">tResult initialize.<br></span><span class="tab"></span><span class="small">⇑ tResult<br>]</span></div>
<div class="line left">
<span class="medium bold"><br>Interpretation</span></div>
<div class="line left">
<span class="small bold">have: receiver interpret: method<br></span><span class="tab"></span><span class="small">[</span><span class="small italic">"Warning -- someone must be holding methodⓢ literals."</span><span class="small"><br></span><span class="tab"></span><span class="small italic">"Warning -- do not call as self have:interpret: or cycle will result"</span><span class="small"><br></span><span class="tab"></span><span class="small">tempframe &larr; (Vector new: method◦3).<br></span><span class="tab"></span><span class="small">self restart. ⇑self interpretFor: thisContext sender]</span></div>
<div class="line left">
<span class="small bold">interpret: objectCode with: tframe<br></span><span class="tab"></span><span class="small">[</span><span class="small italic">"interpret in new context with tempframe tframe"</span><span class="small"><br></span><span class="tab"></span><span class="small italic">"Warning -- someone must be holding objectCodeⓢ literals."</span><span class="small"><br></span><span class="tab"></span><span class="small italic">"Warning -- do not call as self interpret:with: or cycle will result"</span><span class="small"><br></span><span class="tab"></span><span class="small">⇑(Context new<br></span><span class="tab"></span><span class="tab"></span><span class="small">sender: nil receiver: receiver<br></span><span class="tab"></span><span class="tab"></span><span class="small">method: objectCode tempframe: tframe<br></span><span class="tab"></span><span class="tab"></span><span class="small">pc: objectCode◦6 stackptr: objectCode◦5-1)<br></span><span class="tab"></span><span class="small">  interpretFor: thisContext sender]</span></div>
<div class="line left">
<span class="small bold">interpretFor: sender  </span><span class="small italic">"resume execution"</span><span class="small"><br></span><span class="tab"></span><span class="small">[PriorityInterrupt new run: self]</span></div>
<div class="line left">
<span class="medium bold"><br>Deallocation</span></div>
<div class="line left">
<span class="small bold">destroyAndReturn: value<br></span><span class="tab"></span><span class="small">[thisContext sender &larr; sender.<br></span><span class="tab"></span><span class="small">tempframe all &larr; nil.<br></span><span class="tab"></span><span class="small">⇑value]</span></div>
<div class="line left">
<span class="small bold">eraseFully<br></span><span class="tab"></span><span class="small">[tempframe≡nil⇒ []<br></span><span class="tab"></span><span class="small">tempframe all &larr; nil. tempframe &larr; nil]</span></div>
<div class="line left">
<span class="small bold">release | s</span><span class="tab"></span><span class="tab"></span><span class="small italic">"release frames to break cycles"</span><span class="small"><br></span><span class="tab"></span><span class="small">[ [tempframe≡nil⇒[] tempframe all&larr; nil. tempframe &larr; nil].<br></span><span class="tab"></span><span class="small">receiver&larr; nil.<br></span><span class="tab"></span><span class="small">sender≡nil⇒[] <br></span><span class="tab"></span><span class="small">"</span><span class="small italic">not sure if this works correctly</span><span class="small">"<br></span><span class="tab"></span><span class="small">"[sender Isnt: Context⇒[<br></span><span class="tab"></span><span class="tab"></span><span class="small">until⦂ (sender Is: Context) do⦂<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">[s&larr; sender instfield: 1.<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">sender instfield: 5&larr; nil.<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">s≡nil⇒[⇑self] sender&larr; s]]]."<br></span><span class="tab"></span><span class="small">sender release]</span></div>
<div class="line left">
<span class="small bold">releaseFully </span><span class="small">| c </span><span class="tab"></span><span class="small italic">"nullify frames to break cycles"</span><span class="small"><br></span><span class="tab"></span><span class="small">[c &larr; self.<br></span><span class="tab"></span><span class="small"> until⦂ c≡nil do⦂ [c eraseFully. c &larr; c sender]]</span></div>
<div class="line left">
<span class="small bold">releaseTo: pContext<br></span><span class="small">[<br></span><span class="tab"></span><span class="small">sender ≡ pContext ⇒ [ sender &larr; nil. ]<br></span><span class="tab"></span><span class="tab"></span><span class="small">sender releaseTo: pContext.<br></span><span class="tab"></span><span class="tab"></span><span class="small">sender &larr; nil.<br>]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪Context under: &rsquo;Kernel Classes&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="medium bold"><br>"RemoteContext"</span></div>
<div class="line left">
<span class="medium bold">Class new title: &rsquo;RemoteContext&rsquo;<br></span><span class="tab"></span><span class="medium bold">subclassof: Context<br></span><span class="tab"></span><span class="medium bold">fields: &rsquo; <br></span><span class="tab"></span><span class="tab"></span><span class="medium bold">fSavedPC<br></span><span class="tab"></span><span class="tab"></span><span class="medium bold">fSavedStackptr<br></span><span class="tab"></span><span class="medium bold">&rsquo;<br></span><span class="tab"></span><span class="medium bold">declare: &rsquo;&rsquo;;<br></span><span class="tab"></span><span class="medium bold">asFollows</span></div>
<div class="line left">
<span class="small italic"><br>CONTEXT FOR REMOTE CODE</span></div>
<div class="line left">
<span class="medium bold"><br>REMOTE CONTEXT</span></div>
<div class="line left">
<span class="small bold">caller<br></span><span class="small">[<br></span><span class="tab"></span><span class="small">⇑ tempframe ◦ (fSavedStackptr+2)<br>]</span></div>
<div class="line left">
<span class="small bold">cleancopy<br></span><span class="tab"></span><span class="small">| tResult<br>[<br></span><span class="tab"></span><span class="small">tResult &larr; RemoteContext new<br></span><span class="tab"></span><span class="tab"></span><span class="small">sender: sender<br></span><span class="tab"></span><span class="tab"></span><span class="small">receiver: receiver<br></span><span class="tab"></span><span class="tab"></span><span class="small">method: method<br></span><span class="tab"></span><span class="tab"></span><span class="small">tempframe: tempframe copy<br></span><span class="tab"></span><span class="tab"></span><span class="small">pc: pc<br></span><span class="tab"></span><span class="tab"></span><span class="small">stackptr: stackptr.<br></span><span class="tab"></span><span class="small">tResult initialize.<br></span><span class="tab"></span><span class="small">⇑ tResult<br>]</span></div>
<div class="line left">
<span class="small bold">initialize<br></span><span class="small">[<br></span><span class="tab"></span><span class="small">fSavedPC &larr; pc.<br></span><span class="tab"></span><span class="small">fSavedStackptr &larr; stackptr.<br>]</span></div>
<div class="line left">
<span class="small bold">releaseTo: pContext<br></span><span class="small">[<br></span><span class="tab"></span><span class="small">tempframe ◦ (fSavedStackptr+2) ≡ pContext ⇒<br></span><span class="tab"></span><span class="tab"></span><span class="small">[ tempframe ◦ (fSavedStackptr+2) &larr; nil. ]<br></span><span class="tab"></span><span class="tab"></span><span class="small">tempframe ◦ (fSavedStackptr+2) releaseTo: pContext.<br></span><span class="tab"></span><span class="tab"></span><span class="small">tempframe ◦ (fSavedStackptr+2) &larr; nil.<br>]</span></div>
<div class="line left">
<span class="small bold">restart<br></span><span class="small">[<br></span><span class="tab"></span><span class="small">pc &larr; fSavedPC.<br></span><span class="tab"></span><span class="small">stackptr &larr; fSavedStackptr.<br>]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪RemoteContext under: &rsquo;Kernel Classes&rsquo;.</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="medium bold"><br>"UserView"</span></div>
<div class="line left">
<span class="medium bold">Class new title: &rsquo;UserView&rsquo;<br></span><span class="tab"></span><span class="medium bold">subclassof: Object<br></span><span class="tab"></span><span class="medium bold">fields: &rsquo;screenrect "&lt;Rectangle&gt; current screen size"<br></span><span class="tab"></span><span class="tab"></span><span class="medium bold">vtab "&lt;Integer=0mod2&gt; offset from hardware top"<br></span><span class="tab"></span><span class="tab"></span><span class="medium bold">htab "&lt;Integer=0mod16&gt; offset from hardware left"<br></span><span class="tab"></span><span class="tab"></span><span class="medium bold">scale "&lt;Integer=1 or 2&gt; 2 means double bits mode"<br></span><span class="tab"></span><span class="tab"></span><span class="medium bold">color "&lt;Integer=0 or 1&gt; 1 means reverse field"<br></span><span class="tab"></span><span class="tab"></span><span class="medium bold">projectWindow "my representative in an overview"<br></span><span class="tab"></span><span class="tab"></span><span class="medium bold">disp "&lt;dispframe&gt; default message stream"<br></span><span class="tab"></span><span class="tab"></span><span class="medium bold">sched "&lt;Vector&gt; Windows in this view"&rsquo;<br></span><span class="tab"></span><span class="medium bold">declare: &rsquo;currentCursor mxoffset myoffset screenMenu &rsquo;;<br></span><span class="tab"></span><span class="medium bold">asFollows</span></div>
<div class="line left">
<span class="small italic"><br>This is a melting-pot, incorporating the notions of user interaction (mouse, keyboard), display context (current screen view), and global operations (reading the clock, leaving the system).</span></div>
<div class="line left">
<span class="medium bold"><br>Mouse, Cursor, Keys</span></div>
<div class="line left">
<span class="small bold">anybug </span><span class="small">[⇑self buttons &gt;0 or⦂ (mem◦0177100) &lt; 0]</span></div>
<div class="line left">
<span class="small bold">anykeys </span><span class="small">[⇑self keyset&gt;0]</span></div>
<div class="line left">
<span class="small bold">bluebug </span><span class="small">[⇑self buttons=2]</span></div>
<div class="line left">
<span class="small bold">buttons<br></span><span class="tab"></span><span class="small">[⇑7-(mem◦0177030 land: 7)]</span></div>
<div class="line left">
<span class="small bold">currentCursor </span><span class="small">[⇑currentCursor]</span></div>
<div class="line left">
<span class="small bold">currentCursor: c </span><span class="small">| coff oldpt [<br></span><span class="tab"></span><span class="small">oldpt &larr; self mp.<br></span><span class="tab"></span><span class="small">currentCursor &larr; c.<br></span><span class="tab"></span><span class="small">coff &larr; c offset.<br></span><span class="tab"></span><span class="small">mxoffset &larr; coff x - htab.<br></span><span class="tab"></span><span class="small">myoffset &larr; coff y - vtab.<br></span><span class="tab"></span><span class="small">self cursorloc &larr; oldpt]</span></div>
<div class="line left">
<span class="small bold">cursorloc &larr; pt <br></span><span class="tab"></span><span class="small">[mem◦0424 &larr; pt x - mxoffset*scale.<br></span><span class="tab"></span><span class="small">mem◦0425 &larr; pt y - myoffset*scale]</span></div>
<div class="line left">
<span class="small bold">kbck </span><span class="small">| t<br></span><span class="tab"></span><span class="small">[t &larr; self rawkbck⇒[⇑kbMap◦t] self purgealittle. ⇑false ]</span></div>
<div class="line left">
<span class="small bold">kbd </span><span class="small">[until⦂ self rawkbck do⦂ [self purgealittle]<br></span><span class="tab"></span><span class="small">⇑kbMap◦self rawkbd]</span></div>
<div class="line left">
<span class="small bold">kbd: char<br></span><span class="tab"></span><span class="small">[</span><span class="small italic">"stuff char into the event queue"</span><span class="small"><br></span><span class="tab"></span><span class="small">[char is: String ⇒[char &larr; char◦1]].<br></span><span class="tab"></span><span class="small">Events next &larr;<br></span><span class="tab"></span><span class="tab"></span><span class="small">UserEvent new<br></span><span class="tab"></span><span class="tab"></span><span class="small">x:</span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">self x</span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small italic">"event x"</span><span class="small"><br></span><span class="tab"></span><span class="tab"></span><span class="small">y:</span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">self y</span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small italic">"event y"</span><span class="small"><br></span><span class="tab"></span><span class="tab"></span><span class="small">type:</span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">1</span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small italic">"2=up, 1=down"</span><span class="small"><br></span><span class="tab"></span><span class="tab"></span><span class="small">stroke:</span><span class="tab"></span><span class="tab"></span><span class="small">(kbMap find: char)</span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small italic">"1-336"</span><span class="small"><br></span><span class="tab"></span><span class="tab"></span><span class="small">elapsed:</span><span class="tab"></span><span class="tab"></span><span class="small">Events</span><span class="tab"></span><span class="small">elapsedtime</span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small italic">"1-32767 sixtieths of a sec"</span><span class="small"><br></span><span class="tab"></span><span class="tab"></span><span class="small">time:</span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">Events time + Events elapsedtime.]</span></div>
<div class="line left">
<span class="small bold">kbdnext </span><span class="small">| event</span><span class="small bold"> </span><span class="small">[<br></span><span class="tab"></span><span class="small">"returns next character (mapped) if any; otherwise false"<br></span><span class="tab"></span><span class="small">while⦂ [<br></span><span class="tab"></span><span class="tab"></span><span class="small">(event &larr; Events dequeue) or⦂<br></span><span class="tab"></span><span class="tab"></span><span class="small">(event &larr; Events primitiveDequeue)] do⦂ [<br></span><span class="tab"></span><span class="tab"></span><span class="small">event isKbdDown⇒ [⇑kbMap◦event stroke]].<br></span><span class="tab"></span><span class="small">"self rawkbck⇒ [⇑kbMap◦Events next stroke]"<br></span><span class="tab"></span><span class="small">⇑false]</span></div>
<div class="line left">
<span class="small bold">keyset<br></span><span class="tab"></span><span class="small">[</span><span class="small italic">"Fix a bug in sysdefs."</span><span class="small"><br></span><span class="tab"></span><span class="small">⇑037 - ((mem◦0177030 lshift: ¬3) land: 037)]</span></div>
<div class="line left">
<span class="small bold">leftShiftKey </span><span class="small">["left shift key down?" ⇑(mem◦0177036 land: 0100) = 0]</span></div>
<div class="line left">
<span class="small bold">mp<br></span><span class="tab"></span><span class="small">[scale=2⇒<br></span><span class="tab"></span><span class="tab"></span><span class="small">[⇑Point new<br></span><span class="tab"></span><span class="tab"></span><span class="small">x: mem◦0424 + mxoffset / 2<br></span><span class="tab"></span><span class="tab"></span><span class="small">y: mem◦0425 + myoffset / 2]<br></span><span class="tab"></span><span class="small">⇑Point new<br></span><span class="tab"></span><span class="tab"></span><span class="small">x: mem◦0424 + mxoffset<br></span><span class="tab"></span><span class="tab"></span><span class="small">y: mem◦0425 + myoffset]</span></div>
<div class="line left">
<span class="small bold">mpnext </span><span class="small">[<br></span><span class="tab"></span><span class="small">"</span><span class="small italic">return next mouse point if red button or tablet is down; otherwise false</span><span class="small">"<br></span><span class="tab"></span><span class="small">self redbug⇒ [⇑self mp]<br></span><span class="tab"></span><span class="small">⇑false]</span></div>
<div class="line left">
<span class="small bold">nobug<br></span><span class="tab"></span><span class="small">[⇑self anybug ≡ false]</span></div>
<div class="line left">
<span class="small bold">rawkbck </span><span class="small">| event</span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small italic">"flush event queue until down keyboard event or queue empty."</span><span class="small"><br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">[while⦂ (event &larr; Events peek) do⦂<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">[event isKbdDown ⇒[⇑event stroke] Events next].<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">⇑false</span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small italic">"if queue empty, return false"</span><span class="small"><br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">]</span></div>
<div class="line left">
<span class="small bold">rawkbd </span><span class="small">| stroke<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">[until⦂ (stroke &larr; self rawkbck) do⦂ [].</span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small italic">"wait for activity"</span><span class="small"><br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">Events next.  ⇑stroke</span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small italic">"if key down, pop queue and return stroke"</span><span class="small"><br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">]</span></div>
<div class="line left">
<span class="small bold">redbug </span><span class="small">[⇑self buttons=4 or⦂ (mem◦0177100) &lt; 0]</span></div>
<div class="line left">
<span class="small bold">tablet </span><span class="small">[⇑(mem◦0177100) ≠ 0]</span></div>
<div class="line left">
<span class="small bold">tabletabsolute </span><span class="small">[mem◦0126 &larr; 1]</span></div>
<div class="line left">
<span class="small bold">tabletbug </span><span class="small">[⇑(mem◦0177100) &lt; 0]</span></div>
<div class="line left">
<span class="small bold">tabletrelative </span><span class="small">[mem◦0126 &larr; ¬1]</span></div>
<div class="line left">
<span class="small bold">waitbug<br></span><span class="tab"></span><span class="small">[until⦂ self anybug do⦂ [] ⇑self mp]</span></div>
<div class="line left">
<span class="small bold">waitclickbug<br></span><span class="tab"></span><span class="small">[self waitnobug. ⇑self waitbug]</span></div>
<div class="line left">
<span class="small bold">waitnobug<br></span><span class="tab"></span><span class="small">[while⦂ self anybug do⦂ [] ⇑self mp]</span></div>
<div class="line left">
<span class="small bold">waitnokey </span><span class="small">[until⦂ self keyset=0 do⦂ [self rawkbck]]</span></div>
<div class="line left">
<span class="small bold">x </span><span class="small">[⇑mem◦0426 - htab</span><span class="tab"></span><span class="tab"></span><span class="small italic">"cursorx, horiz tab adjusted"</span><span class="small">]</span></div>
<div class="line left">
<span class="small bold">y </span><span class="small">[⇑mem◦0427 - vtab</span><span class="tab"></span><span class="tab"></span><span class="small italic">"cursory, vert tab adjusted"</span><span class="small">]</span></div>
<div class="line left">
<span class="small bold">yellowbug </span><span class="small">[⇑self buttons=1]</span></div>
<div class="line left">
<span class="medium bold"><br>Screen Views</span></div>
<div class="line left">
<span class="small bold">bugScreenMenu<br></span><span class="tab"></span><span class="small">["see classInit"<br></span><span class="tab"></span><span class="small">screenMenu bug<br></span><span class="tab"></span><span class="tab"></span><span class="small">=1⇒[projectWindow≡nil⇒[] projectWindow runParent];<br></span><span class="tab"></span><span class="tab"></span><span class="small">=2⇒[user quit];<br></span><span class="tab"></span><span class="tab"></span><span class="small">=3⇒[self restartup: ProjectWindow init];<br></span><span class="tab"></span><span class="tab"></span><span class="small">=4⇒[self restartup: BrowseWindow default];<br></span><span class="tab"></span><span class="tab"></span><span class="small">=5⇒[self restartup: (CodeWindow new class: UserView selector: ↪workspace<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">para: (UserView code: ↪workspace) formerly: false)];<br></span><span class="tab"></span><span class="tab"></span><span class="small">=6⇒[user displayoffwhile⦂ [self reclaim]]<br></span><span class="tab"></span><span class="small">]</span></div>
<div class="line left">
<span class="small bold">color: color scale: scale</span><span class="tab"></span><span class="small">[self install]</span></div>
<div class="line left">
<span class="small bold">copyIn: p<br></span><span class="tab"></span><span class="small">[⇑UserView new<br></span><span class="tab"></span><span class="tab"></span><span class="small">screenrect: screenrect copy<br></span><span class="tab"></span><span class="tab"></span><span class="small">vtab: vtab htab: htab scale: scale color: color<br></span><span class="tab"></span><span class="tab"></span><span class="small">projectWindow: p<br></span><span class="tab"></span><span class="tab"></span><span class="small">disp: disp sched: ↪()]</span></div>
<div class="line left">
<span class="small bold">displayoffwhile⦂ expr </span><span class="small">| t v<br></span><span class="tab"></span><span class="small">["t &larr; mem◦0420. mem◦0420 &larr; 0."<br></span><span class="tab"></span><span class="small">t &larr; mem◦067. mem◦067 &larr; 58 "disp text frame maxY/2 ?".<br></span><span class="tab"></span><span class="small">v &larr; expr eval.<br></span><span class="tab"></span><span class="small">mem◦067 "0420" &larr; t. ⇑v]</span></div>
<div class="line left">
<span class="small bold">install<br></span><span class="tab"></span><span class="small">[self screenextent: screenrect extent tab: htab⌾vtab]</span></div>
<div class="line left">
<span class="small bold">projectWindow </span><span class="small">[<br></span><span class="tab"></span><span class="small">[projectWindow≡nil⇒<br></span><span class="tab"></span><span class="tab"></span><span class="small">[projectWindow &larr; ProjectWindow new.<br></span><span class="tab"></span><span class="tab"></span><span class="small">projectWindow userview: self changes: Changes parent: projectWindow]].<br></span><span class="tab"></span><span class="small">⇑projectWindow]</span></div>
<div class="line left">
<span class="small bold">reconfigure </span><span class="small">[] primitive: 62</span></div>
<div class="line left">
<span class="small bold">restoredisplay<br></span><span class="tab"></span><span class="small">[mem◦0420 &larr; 060. mem◦067 &larr; screenrect height/2]</span></div>
<div class="line left">
<span class="small bold">screenextent: extent tab: tab </span><span class="small">[<br></span><span class="tab"></span><span class="small">mem◦065 &larr;<br></span><span class="tab"></span><span class="tab"></span><span class="small">(color*040000)+[scale=2⇒[0100000] 0]+(tab x/16*0400)+(extent x/16|2).<br></span><span class="tab"></span><span class="small">mem◦067 &larr; extent y*scale/2.<br></span><span class="tab"></span><span class="small">mem◦063 &larr; 1 max: tab y/2.<br></span><span class="tab"></span><span class="small">htab &larr; tab x|16.<br></span><span class="tab"></span><span class="small">vtab &larr; mem◦063*2.<br></span><span class="tab"></span><span class="small">screenrect &larr; 0⌾0 rect: (extent x|32)⌾(extent y|2).<br></span><span class="tab"></span><span class="small">self currentCursor: currentCursor;<br></span><span class="tab"></span><span class="tab"></span><span class="small">reconfigure; restore]</span></div>
<div class="line left">
<span class="small bold">screenrect </span><span class="small">[⇑screenrect]</span></div>
<div class="line left">
<span class="small bold">screenrect: screenrect vtab: vtab htab: htab scale: scale color: color projectWindow: projectWindow disp: disp sched: sched</span></div>
<div class="line left">
<span class="medium bold"><br>Window Scheduling</span></div>
<div class="line left">
<span class="small bold">leaveTop</span><span class="tab"></span><span class="tab"></span><span class="small">"</span><span class="small italic">leave the top window if there is one</span><span class="small">"<br></span><span class="tab"></span><span class="small">[sched length=0⇒[]<br></span><span class="tab"></span><span class="small">(sched◦1) leave]</span></div>
<div class="line left">
<span class="small bold">promote: window<br></span><span class="tab"></span><span class="small">[sched promote: window]</span></div>
<div class="line left">
<span class="small bold">restart </span><span class="small">| i <br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">[[Events ≡ nil ⇒<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">[Events &larr; EventQueue init. </span><span class="small italic">"Top init3.  initialize Event queue and Time interrupt"</span><span class="small">]].<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">NormalCursor topage1.<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">self restart⦂ [user run]]</span></div>
<div class="line left">
<span class="small bold">restart⦂ code </span><span class="small">| u<br></span><span class="tab"></span><span class="small">[u &larr; code cleancopy. u sender &larr; nil.<br></span><span class="tab"></span><span class="small">thisContext sender releaseFully.<br></span><span class="tab"></span><span class="small">thisContext sender &larr; nil.</span><span class="tab"></span><span class="small">code &larr; nil. </span><span class="tab"></span><span class="small italic">"release caller chain"</span><span class="small"><br></span><span class="tab"></span><span class="small">MessageDict new freeMethods.</span><span class="tab"></span><span class="tab"></span><span class="small italic">"release held code"</span><span class="small"><br></span><span class="tab"></span><span class="small">disp frame flash.<br></span><span class="tab"></span><span class="small">while⦂ true do⦂ [u eval]]</span></div>
<div class="line left">
<span class="small bold">restartup: window<br></span><span class="tab"></span><span class="small">[ </span><span class="small italic">"Equivalent to schedule new window, restart, and redbug in window, except firsttime is already done."</span><span class="small"><br></span><span class="tab"></span><span class="small">thisContext sender releaseFully. thisContext sender &larr; nil.<br></span><span class="tab"></span><span class="small">NormalCursor topage1.<br></span><span class="tab"></span><span class="small">self schedule: window.<br></span><span class="tab"></span><span class="small">thisContext tempframe all &larr; nil.<br></span><span class="tab"></span><span class="small">self run: true]</span></div>
<div class="line left">
<span class="small bold">restore </span><span class="small">| w<br></span><span class="tab"></span><span class="small">[screenrect clear.<br></span><span class="tab"></span><span class="small">[projectWindow≡nil⇒[] projectWindow putTitle].<br></span><span class="tab"></span><span class="small">for⦂ w from: (sched length to: 1 by: ¬1) do⦂<br></span><span class="tab"></span><span class="tab"></span><span class="small">[(sched◦w) show]]</span></div>
<div class="line left">
<span class="small bold">run<br></span><span class="tab"></span><span class="small">[self run: false]</span></div>
<div class="line left">
<span class="small bold">run: topFlag </span><span class="small">| i w forward</span><span class="tab"></span><span class="small italic">"topFlag means sched◦1 already is awake"</span><span class="small"><br></span><span class="tab"></span><span class="small">[forward &larr; [topFlag⇒ [w&larr;sched◦1. while⦂ w eachtime do⦂ []. w lasttime] true].<br></span><span class="tab"></span><span class="small">while⦂ true do⦂<br></span><span class="tab"></span><span class="tab"></span><span class="small">[i&larr;0.<br></span><span class="tab"></span><span class="tab"></span><span class="small">until⦂ [(i&larr;i+1)&gt;sched length⇒[]<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">w&larr; [forward⇒[sched◦i] sched◦(sched length+1-i)].<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">w firsttime] do⦂ []<br></span><span class="tab"></span><span class="tab"></span><span class="small">i&gt;sched length⇒</span><span class="tab"></span><span class="tab"></span><span class="small italic">"check for bug in empty space"</span><span class="small"><br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">[user yellowbug⇒[self bugScreenMenu]]<br></span><span class="tab"></span><span class="tab"></span><span class="small">sched promote: w.<br></span><span class="tab"></span><span class="tab"></span><span class="small">while⦂ w eachtime do⦂ []<br></span><span class="tab"></span><span class="tab"></span><span class="small">forward&larr; w lasttime]]</span></div>
<div class="line left">
<span class="small bold">sched </span><span class="small">[⇑sched]</span></div>
<div class="line left">
<span class="small bold">schedule: window<br></span><span class="tab"></span><span class="small">[sched≡nil⇒[sched &larr; window inVector]<br></span><span class="tab"></span><span class="small">sched &larr; window inVector concat: sched]</span></div>
<div class="line left">
<span class="small bold">scheduleOnBottom: window<br></span><span class="tab"></span><span class="small">[sched≡nil⇒[sched &larr; window asVector]<br></span><span class="tab"></span><span class="small">sched &larr; sched concat: window asVector]</span></div>
<div class="line left">
<span class="small bold">topWindow </span><span class="small">[⇑sched◦1]</span></div>
<div class="line left">
<span class="small bold">unschedule: window </span><span class="small">| t<br></span><span class="tab"></span><span class="small">[0&lt;(t&larr; sched find: window)⇒<br></span><span class="tab"></span><span class="tab"></span><span class="small">[sched &larr; sched◦(1 to: t-1) concat: sched◦(t+1 to: sched length)]]</span></div>
<div class="line left">
<span class="medium bold"><br>Notify Window</span></div>
<div class="line left">
<span class="small bold">notifier: titleString level: lev interrupt: flag<br></span><span class="tab"></span><span class="small">[</span><span class="small italic">"Restore the full display.  Schedule a one-paned window to notify the user that errorString happened."</span><span class="small"><br></span><span class="tab"></span><span class="small">self restoredisplay.<br></span><span class="tab"></span><span class="small">NotifyFlag≡false⇒<br></span><span class="tab"></span><span class="tab"></span><span class="small">[disp cr;<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">append: &rsquo;NotifyFlag is false...&rsquo;; cr;<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">append: &rsquo; top-blank shows stack, user restart aborts,&rsquo;; cr;<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">append: &rsquo; tempframe shows args, ctrl-d proceeds&rsquo;; cr;<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">append: titleString; cr; show.<br></span><span class="tab"></span><span class="tab"></span><span class="small">(Top◦lev) debug. ⇑false]<br></span><span class="tab"></span><span class="small">⇑NotifyWindow new of: titleString level: lev interrupt: flag]</span></div>
<div class="line left">
<span class="small bold">notifier: titleString stack: stack interrupt: flag<br></span><span class="tab"></span><span class="small">[</span><span class="small italic">"Restore the full display.  Schedule a one-paned window to notify the user that errorString happened."</span><span class="small"><br></span><span class="tab"></span><span class="small">self restoredisplay.<br></span><span class="tab"></span><span class="small">NotifyFlag≡false⇒<br></span><span class="tab"></span><span class="tab"></span><span class="small">[disp cr;<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">append: &rsquo;NotifyFlag is false...&rsquo;; cr;<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">append: &rsquo; sender debug shows stack, user restart aborts,&rsquo;; cr;<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">append: &rsquo; tempframe shows args, ctrl-d proceeds&rsquo;; cr;<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">append: titleString; cr; show.<br></span><span class="tab"></span><span class="tab"></span><span class="small">stack debug. ⇑false]<br></span><span class="tab"></span><span class="small">⇑NotifyWindow new of: titleString stack: stack interrupt: flag]</span></div>
<div class="line left">
<span class="small bold">notify: errorString </span><span class="small">| notifyWindow<br></span><span class="tab"></span><span class="small">[</span><span class="small italic">"Create a notify window looking at the Context stack"</span><span class="small"><br></span><span class="tab"></span><span class="small">notifyWindow &larr; self notifier: errorString stack: thisContext sender interrupt: false.<br></span><span class="tab"></span><span class="small">notifyWindow⇒<br></span><span class="tab"></span><span class="tab"></span><span class="small">[thisContext sender &larr; nil.<br></span><span class="tab"></span><span class="tab"></span><span class="small"> Top currentPriority=1⇒<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">[self restartup: notifyWindow]<br></span><span class="tab"></span><span class="tab"></span><span class="small"> self scheduleOnBottom: notifyWindow.<br></span><span class="tab"></span><span class="tab"></span><span class="small"> Top errorReset]<br></span><span class="tab"></span><span class="small">⇑nil]</span></div>
<div class="line left">
<span class="medium bold"><br>Dialog Window</span></div>
<div class="line left">
<span class="small bold">clear</span><span class="tab"></span><span class="tab"></span><span class="small italic">"clear disp of debris and characters"</span><span class="small"><br></span><span class="tab"></span><span class="small">[disp clear]</span></div>
<div class="line left">
<span class="small bold">clearshow: str<br></span><span class="tab"></span><span class="small">[disp clear; append: str; show]</span></div>
<div class="line left">
<span class="small bold">cr </span><span class="small">[disp cr]</span></div>
<div class="line left">
<span class="small bold">croak<br></span><span class="tab"></span><span class="small">[self notify: &rsquo;A primitive has failed.&rsquo;]</span></div>
<div class="line left">
<span class="small bold">ev<br></span><span class="tab"></span><span class="small">[disp ev]</span></div>
<div class="line left">
<span class="small bold">frame</span><span class="tab"></span><span class="tab"></span><span class="small italic">"return rectangle of dialogue window"</span><span class="small"><br></span><span class="tab"></span><span class="small">[⇑disp text frame]</span></div>
<div class="line left">
<span class="small bold">newdisp </span><span class="small italic">"for when some class associated with running Dispframe  changed"</span><span class="small"><br></span><span class="tab"></span><span class="small">[<br></span><span class="tab"></span><span class="small">self unschedule: disp.<br></span><span class="tab"></span><span class="small">disp &larr; Dispframe new rect: (8⌾0 rect: 150⌾96).<br></span><span class="tab"></span><span class="small">self schedule: disp ; clearshow: &rsquo;New Dialogue window created.<br>&rsquo;]</span></div>
<div class="line left">
<span class="small bold">newdisploc: origin and: corner </span><span class="small italic">"for moving disp"</span><span class="small"><br></span><span class="tab"></span><span class="small">[</span><span class="small italic">"user newdisploc: 8⌾0 and: 150⌾96"</span><span class="small"><br></span><span class="tab"></span><span class="small">(disp text frame inset: ¬2⌾¬2) clear.<br></span><span class="tab"></span><span class="small">disp text frame &larr; origin rect: corner.<br></span><span class="tab"></span><span class="small">disp show]</span></div>
<div class="line left">
<span class="small bold">next &larr; x </span><span class="small">["simulate a Vector Stream"</span><span class="tab"></span><span class="small">disp cr; print: x; show]</span></div>
<div class="line left">
<span class="small bold">print: x </span><span class="small">[disp print: x; show]</span></div>
<div class="line left">
<span class="small bold">read </span><span class="small">[⇑disp read]</span></div>
<div class="line left">
<span class="small bold">request: s</span><span class="small">[⇑disp request: s]</span></div>
<div class="line left">
<span class="small bold">show </span><span class="small">[disp outline; show]</span></div>
<div class="line left">
<span class="small bold">show: str<br></span><span class="tab"></span><span class="small">[disp append: str; show]</span></div>
<div class="line left">
<span class="small bold">space<br></span><span class="tab"></span><span class="small">[disp space]</span></div>
<div class="line left">
<span class="small bold">tab </span><span class="small">[disp tab]</span></div>
<div class="line left">
<span class="medium bold"><br>Time</span></div>
<div class="line left">
<span class="small bold">convertTime: s returnSecs: format </span><span class="small">| d dd t dfirst dlast m570 m571 [<br></span><span class="tab"></span><span class="small">"</span><span class="small italic">s is total seconds from midnight Jan 1 1901 GMT (Greenwich mean time).<br></span><span class="tab"></span><span class="small italic">see maxc &lt;AltoDocs&gt;AltoTime.Press for details</span><span class="small">"<br><br></span><span class="tab"></span><span class="small">"</span><span class="small italic">time zone specific parameters</span><span class="small">"<br></span><span class="tab"></span><span class="small">m570 &larr; mem◦0570. m571 &larr; mem◦0571.<br><br></span><span class="tab"></span><span class="small">"</span><span class="small italic">adjust for time zone</span><span class="small">"<br></span><span class="tab"></span><span class="small">s &larr; s + (([m570 ≥ 0⇒ ["</span><span class="small italic">west</span><span class="small">" ¬1] "</span><span class="small italic">east</span><span class="small">" 1]) * (<br></span><span class="tab"></span><span class="tab"></span><span class="small">(3600 * ("</span><span class="small italic">hours</span><span class="small">" m570 bits: (1 to: 4))) +<br></span><span class="tab"></span><span class="tab"></span><span class="small">(60 * ("</span><span class="small italic">additonal minutes</span><span class="small">" m571 bits: (1 to: 6))))).<br><br></span><span class="tab"></span><span class="small">t &larr; s intdiv: 86400.<br></span><span class="tab"></span><span class="small">"</span><span class="small italic">current day (in local standard time)</span><span class="small">"<br></span><span class="tab"></span><span class="small">d &larr; Date new fromDays: t◦1.<br></span><span class="tab"></span><span class="small">[format⇒ [] t &larr; Time new fromSeconds: t◦2].<br><br></span><span class="tab"></span><span class="small">"</span><span class="small italic">check for DST. correct DST parameters for nonleap years and<br></span><span class="tab"></span><span class="small italic">round to previous Sunday if necessary</span><span class="small">"<br><br></span><span class="tab"></span><span class="small">"</span><span class="small italic">day of the year on or before which DST takes effect</span><span class="small">"<br></span><span class="tab"></span><span class="small">dfirst &larr; m570 land: 0777 "bits: (7 to: 15)".<br><br></span><span class="tab"></span><span class="small">[[dfirst = 366⇒ ["</span><span class="small italic">DST not in effect</span><span class="small">" false]<br></span><span class="tab"></span><span class="small">(dd &larr; d day) ≥ (dfirst &larr; dfirst + d leap - 1)⇒ [<br><br></span><span class="tab"></span><span class="tab"></span><span class="small">"</span><span class="small italic">day of the year on or before which DST ends</span><span class="small">"<br></span><span class="tab"></span><span class="tab"></span><span class="small">dlast &larr; (m571 land: 0777 "bits: (7 to: 15)") + d leap - 1.<br></span><span class="tab"></span><span class="tab"></span><span class="small">dd &lt; dlast "</span><span class="small italic">if false, definitely after</span><span class="small">" and⦂<br></span><span class="tab"></span><span class="tab"></span><span class="small">dd &lt; ((Date new day: dlast year: d year) previous: 6) day]<br></span><span class="tab"></span><span class="small">"</span><span class="small italic">possibly earlier than or at beginning of range</span><span class="small">"<br></span><span class="tab"></span><span class="small">dd ≥ ((Date new day: dfirst year: d year) previous: 6) day]⇒ [<br><br></span><span class="tab"></span><span class="tab"></span><span class="small">"</span><span class="small italic">daylight savings time in effect. add an hour</span><span class="small">"<br></span><span class="tab"></span><span class="tab"></span><span class="small">format⇒ [s &larr; s + 3600]<br></span><span class="tab"></span><span class="tab"></span><span class="small">t hours = 23⇒ [<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">d &larr; d+1.<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">t hours: 0]<br></span><span class="tab"></span><span class="tab"></span><span class="small">t hours: t hours+1]].<br><br></span><span class="tab"></span><span class="small">"</span><span class="small italic">return either total seconds or Date and Time</span><span class="small">"<br></span><span class="tab"></span><span class="small">format⇒ [⇑s] ⇑d,t]</span></div>
<div class="line left">
<span class="small bold">dateAndTime: secs </span><span class="small">[<br></span><span class="tab"></span><span class="small">"</span><span class="small italic">secs is a String of 4 characters representing seconds (in GMT) since Jan 1 1901.<br></span><span class="tab"></span><span class="small italic">convert it to a LargeInteger (rawtotalsecs:), then return a Vector (Date, Time),<br></span><span class="tab"></span><span class="small italic">which is corrected for local time zone and daylight savings</span><span class="small">"<br><br></span><span class="tab"></span><span class="small">⇑self convertTime: (self rawtotalsecs: secs) returnSecs: false]</span></div>
<div class="line left">
<span class="small bold">now </span><span class="small">[⇑self dateAndTime: self timewords]</span></div>
<div class="line left">
<span class="small bold">rawtotalsecs </span><span class="small">[⇑self rawtotalsecs: self timewords]</span></div>
<div class="line left">
<span class="small bold">rawtotalsecs: secs </span><span class="small">| s [<br></span><span class="tab"></span><span class="small">"</span><span class="small italic">secs is a String of 4 characters representing seconds (in GMT) since Jan 1 1901.<br></span><span class="tab"></span><span class="small italic">copy (in reverse order) to a Natural string, then return a LargeInteger"<br><br></span><span class="tab"></span><span class="small">s &larr; Natural new: 4.<br></span><span class="tab"></span><span class="small">s◦1 &larr; secs◦4.<br></span><span class="tab"></span><span class="small">s◦2 &larr; secs◦3.<br></span><span class="tab"></span><span class="small">s◦3 &larr; secs◦2.<br></span><span class="tab"></span><span class="small">s◦4 &larr; secs◦1.<br></span><span class="tab"></span><span class="small">⇑LargeInteger new bytes: s neg: false]</span></div>
<div class="line left">
<span class="small bold">ticks </span><span class="small">"Return the 38.08-millisecond interval timer"<br></span><span class="tab"></span><span class="small">[⇑mem◦0430]</span></div>
<div class="line left">
<span class="small bold">time </span><span class="small">[⇑self now◦2]</span></div>
<div class="line left">
<span class="small bold">time⦂ expr </span><span class="small">| t<br></span><span class="tab"></span><span class="small">[t &larr; self ticks.  expr eval.  ⇑self ticks-t]</span></div>
<div class="line left">
<span class="small bold">timewords </span><span class="small">| s [<br></span><span class="tab"></span><span class="small">"</span><span class="small italic">seconds (in GMT) since Jan 1 1901: as a String</span><span class="small">"<br></span><span class="tab"></span><span class="small">s &larr; String new: 4.<br></span><span class="tab"></span><span class="small">s word: 1 &larr; mem◦0572; word: 2 &larr; mem◦0573.<br></span><span class="tab"></span><span class="small">⇑s]</span></div>
<div class="line left">
<span class="small bold">today </span><span class="small">[⇑self now◦1]</span></div>
<div class="line left">
<span class="small bold">totalsecs </span><span class="small">[⇑self totalsecs: self timewords]</span></div>
<div class="line left">
<span class="small bold">totalsecs: secs </span><span class="small">[<br></span><span class="tab"></span><span class="small">"</span><span class="small italic">convert from GMT to local and correct for Daylight Savings</span><span class="small">"<br></span><span class="tab"></span><span class="small">⇑self convertTime: (self rawtotalsecs: secs) returnSecs: true]</span></div>
<div class="line left">
<span class="medium bold"><br>Changes</span></div>
<div class="line left">
<span class="small bold">changedCategories </span><span class="small">| titles space str<br></span><span class="tab"></span><span class="small">["return a vector of the names of class categories which have been changed"<br></span><span class="tab"></span><span class="small">space &larr; &rsquo; &rsquo;◦1.<br></span><span class="tab"></span><span class="small">titles &larr; HashSet new init.<br></span><span class="tab"></span><span class="small">for⦂ str from: Changes contents do⦂<br></span><span class="tab"></span><span class="tab"></span><span class="small">[titles insert: (<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">SystemOrganization invert: ((Stream new of: str) upto: space) unique)].<br></span><span class="tab"></span><span class="small">⇑titles contents<br></span><span class="tab"></span><span class="small">]</span></div>
<div class="line left">
<span class="small bold">changedClasses </span><span class="small">| titles space str<br></span><span class="tab"></span><span class="small">["return a vector of the names of classes which have been changed"<br></span><span class="tab"></span><span class="small">space &larr; &rsquo; &rsquo;◦1.<br></span><span class="tab"></span><span class="small">titles &larr; HashSet new init.<br></span><span class="tab"></span><span class="small">for⦂ str from: Changes contents do⦂<br></span><span class="tab"></span><span class="tab"></span><span class="small">[titles insert: ((Stream new of: str) upto: space). "class title"].<br></span><span class="tab"></span><span class="small">⇑titles contents<br></span><span class="tab"></span><span class="small">]</span></div>
<div class="line left">
<span class="small bold">changedMessages </span><span class="small">[⇑Changes contents sort]</span></div>
<div class="line left">
<span class="small bold">noChanges </span><span class="small">[Changes init]</span></div>
<div class="line left">
<span class="medium bold"><br>System quit/resume</span></div>
<div class="line left">
<span class="small bold">backup   </span><span class="small italic">"back up smalltalk on ivy and resume"</span><span class="small"><br></span><span class="tab"></span><span class="small">[ivy open; delete: &rsquo;small.boot&rsquo;; store: &rsquo;small.boot&rsquo;; close]</span></div>
<div class="line left">
<span class="small bold">hasXM<br></span><span class="tab"></span><span class="small">["return true if this is XM Smalltalk"<br></span><span class="tab"></span><span class="small">⇑(mem◦0147)≠0 </span><span class="small italic">"1 for XM, 0 for normal"</span><span class="small"><br></span><span class="tab"></span><span class="small">]</span></div>
<div class="line left">
<span class="small bold">InLd: fileid  "write out the core image, then load in OS"<br></span><span class="tab"></span><span class="small">[user notify: &rsquo;file problem&rsquo;] primitive: 85</span></div>
<div class="line left">
<span class="small bold">overlay: fileid </span><span class="small">| t [<br></span><span class="tab"></span><span class="small">dp0 stampBoot.<br></span><span class="tab"></span><span class="small">self releaseExternalViews.<br><br></span><span class="tab"></span><span class="small">"</span><span class="small italic">put the ethernet to sleep</span><span class="small">"<br></span><span class="tab"></span><span class="small">[E≡nil⇒ [] E sleep].<br><br></span><span class="tab"></span><span class="small">"</span><span class="small italic">turn off display during quit/resume</span><span class="small">"<br></span><span class="tab"></span><span class="small">t &larr; mem◦0420. mem◦0420 &larr; 0.<br></span><span class="tab"></span><span class="small">self InLd: fileid.<br><br></span><span class="tab"></span><span class="small">"</span><span class="small italic">we start here after a resume</span><span class="small">"<br></span><span class="tab"></span><span class="small">mem◦0420 &larr; t.<br></span><span class="tab"></span><span class="small">while⦂ user keyset&gt;0 do⦂ [user show: &rsquo;The keyset is stuck&rsquo;; cr]]</span></div>
<div class="line left">
<span class="small bold">quit <br></span><span class="tab"></span><span class="small">[self quitFrom: self </span><span class="small italic">"yup"</span><span class="small">]</span></div>
<div class="line left">
<span class="small bold">quitFrom: controller<br></span><span class="tab"></span><span class="small">[self overlay: ↪(0 0 0 0 0).<br></span><span class="tab"></span><span class="small">self hasXM⇒[<br></span><span class="tab"></span><span class="tab"></span><span class="small">screenrect clear.<br></span><span class="tab"></span><span class="tab"></span><span class="small">controller restore]]</span></div>
<div class="line left">
<span class="small bold">quitThen: str </span><span class="small">| rem rest ["</span><span class="small italic">quit, then have OS execute str</span><span class="small">"<br></span><span class="tab"></span><span class="small">rem &larr; (dp0 file: &rsquo;rem.cm&rsquo;) readonly.<br></span><span class="tab"></span><span class="small">rest &larr; rem next: rem length.<br></span><span class="tab"></span><span class="small">rem readwrite; reset; append: str; cr; append: rest; close.<br></span><span class="tab"></span><span class="small">self quit]</span></div>
<div class="line left">
<span class="small bold">quitThen: s continue: r </span><span class="small">[<br></span><span class="tab"></span><span class="small">[s⇒ [<br></span><span class="tab"></span><span class="tab"></span><span class="small">"</span><span class="small italic">something for O.S. to do</span><span class="small">"<br></span><span class="tab"></span><span class="tab"></span><span class="small">(dp0 oldFile: &rsquo;rem.cm.&rsquo;) settoend;<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">append: s; append: &rsquo;; &rsquo;;<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">append: [r⇒ [&rsquo;Resume.~ small.boot&rsquo;] &rsquo;Quit.~; Resume.~ small.boot&rsquo;];<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">cr; flush]].<br></span><span class="tab"></span><span class="small">self quit]</span></div>
<div class="line left">
<span class="small bold">releaseExternalViews </span><span class="small">| t [<br></span><span class="tab"></span><span class="small">"</span><span class="small italic">close some things that we know about, everything else gets released</span><span class="small">"<br></span><span class="tab"></span><span class="small">Sources close. dp0 close. dp1 close.<br><br></span><span class="tab"></span><span class="small">"</span><span class="small italic">release (obsolete) some external views, usually File related</span><span class="small">"<br></span><span class="tab"></span><span class="small">for⦂ t from: externalViews length to: 1 by: ¬1 do⦂ [<br></span><span class="tab"></span><span class="tab"></span><span class="small">(externalViews◦t) release. externalViews◦t &larr; nil].<br></span><span class="tab"></span><span class="small">externalViews reset]</span></div>
<div class="line left">
<span class="small bold">Swat </span><span class="small">[] primitive: 90</span></div>
<div class="line left">
<span class="medium bold"><br>Misc System Stuff</span></div>
<div class="line left">
<span class="small bold">classInit </span><span class="small">[<br></span><span class="tab"></span><span class="small">screenMenu &larr; Menu new string:<br>&rsquo;exit to overview<br>quit<br>open a subview<br>open a browser<br>open a workspace<br>reclaim&rsquo;]</span></div>
<div class="line left">
<span class="small bold">classNames</span><span class="tab"></span><span class="tab"></span><span class="small italic">"an alphabetized Vector of all Smalltalk class titles uniqued"</span><span class="small"><br></span><span class="tab"></span><span class="tab"></span><span class="small">| classes x c<br></span><span class="tab"></span><span class="small">[<br></span><span class="tab"></span><span class="small">AllClassNames≡nil⇒<br></span><span class="tab"></span><span class="tab"></span><span class="small">[<br></span><span class="tab"></span><span class="tab"></span><span class="small">classes &larr; (Vector new: 20) asStream.<br></span><span class="tab"></span><span class="tab"></span><span class="small">for⦂ x from: Smalltalk do⦂<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">[<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">c &larr; Smalltalk ◦ x.<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">(c is: Class) or⦂ (c is: VariableLengthClass)⇒ [classes next &larr; x].<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">].<br></span><span class="tab"></span><span class="tab"></span><span class="small">AllClassNames &larr; classes contents sort.<br></span><span class="tab"></span><span class="tab"></span><span class="small">].<br></span><span class="tab"></span><span class="small">⇑AllClassNames<br></span><span class="tab"></span><span class="small">]</span></div>
<div class="line left">
<span class="small bold">file: file classes: classes changesOnly: ch </span><span class="small">| cl [<br></span><span class="tab"></span><span class="small">"</span><span class="small italic">called by </span><span class="small bold">UserView release</span><span class="small italic"> to write just changes or entire system on a<br></span><span class="tab"></span><span class="small italic">new file.  also, see comment in </span><span class="small bold">Class archiveOn:changesOnly:</span><span class="small">.</span><span class="small italic"><br><br></span><span class="tab"></span><span class="small italic">write class comment and message text onto a </span><span class="small bold">FileStream</span><span class="small italic"> (which could refer<br></span><span class="tab"></span><span class="small italic">to an </span><span class="small bold">AltoFile, ILFile</span><span class="small italic">, etc.). either just changes or everything are<br></span><span class="tab"></span><span class="small italic">written and replaced with </span><span class="small bold">RemoteParagraph</span><span class="small italic"> references</span><span class="small">"<br><br></span><span class="tab"></span><span class="small">[ch⇒ [file settoend] file reset].<br></span><span class="tab"></span><span class="small">file readwriteshorten.<br></span><span class="tab"></span><span class="small">for⦂ cl from: classes do⦂ [Smalltalk◦cl archiveOn: file changesOnly: ch].<br></span><span class="tab"></span><span class="small">file close; readonly]</span></div>
<div class="line left">
<span class="small bold">growSmalltalk: numberofdiskpages<br></span><span class="tab"></span><span class="small">"</span><span class="small italic">for preemptive growth of Small.boot on disk</span><span class="small">"<br></span><span class="tab"></span><span class="small">[dp0 growSmalltalkBy: numberofdiskpages]</span></div>
<div class="line left">
<span class="small bold">initCompiler  </span><span class="small italic">"Initialize shared variables of parser and generators"</span><span class="small"><br></span><span class="tab"></span><span class="tab"></span><span class="small">| code sel c t<br></span><span class="tab"></span><span class="small">[<br></span><span class="tab"></span><span class="small">Smalltalk declare: ↪(TokenCodes ByteCodes).<br></span><span class="tab"></span><span class="small">[TokenCodes≡nil⇒ [TokenCodes&larr;SymbolTable new init: 32]].<br></span><span class="tab"></span><span class="small">[ByteCodes≡nil⇒ [ByteCodes&larr;SymbolTable new init: 32. Integer sharing: ByteCodes]].<br></span><span class="tab"></span><span class="small">TokenCodes<br></span><span class="tab"></span><span class="tab"></span><span class="small">declare:<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">↪(aRightBrack aPeriod </span><span class="small italic">"First 2 in this order"</span><span class="small"><br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">aLeftPar aSemicolon aCondArrow aHand aReturnArrow<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">aLeftBrack aRightPar aLeftArrow<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">aBinary </span><span class="small italic">"All above must be less, all below must be greater"</span><span class="small"><br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">aNumber aString </span><span class="small italic">"All below must be in that order"</span><span class="small"><br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">aKeyword aGibberish aColon aDigit aWord)<br></span><span class="tab"></span><span class="tab"></span><span class="small">as:<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">↪(1 2<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">3 4 5 6 7<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">8 9 10<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">20<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">30 31<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">41 42 43 44 45<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">).<br></span><span class="tab"></span><span class="small">ByteCodes<br></span><span class="tab"></span><span class="tab"></span><span class="small">declare:<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">↪(toLoadField toLoadTemp toLoadLit toLoadLitInd<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">toLoadCtxt toLoadTempframe<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">toLoadConst toLoad0 toLoad1 toLoadSelf toLoadNil toLoadFalse toLoadTrue<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">toSmashPop toSmash toPop toReturn toEnd toLoadThisCtxt toSuper<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">toShortJmp toShortBfp toLongJmp toLongBfp<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">toPlus toMinus toGtr toGeq toNext toEq toNew toAsStream<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">toSendLit)<br></span><span class="tab"></span><span class="tab"></span><span class="small">as:<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">↪(0 16 32 64<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">112 116<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">120 121 122 113 125 126 127<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">128 129 130 131 132 133 134<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">144 152 160 168<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">176 177 179 181 194 197 203 207<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">208).<br></span><span class="tab"></span><span class="small">c &larr; Dictionary new init: 16.<br></span><span class="tab"></span><span class="small">c insertall: ↪(&rsquo;self&rsquo; &rsquo;thisContext&rsquo; &rsquo;super&rsquo; &rsquo;nil&rsquo; &rsquo;false&rsquo; &rsquo;true&rsquo;)<br></span><span class="tab"></span><span class="tab"></span><span class="small">with: ↪(113 133 134 125 126 127).<br></span><span class="tab"></span><span class="small">ByteCodes declare: ↪stdPrimaries as: c.<br></span><span class="tab"></span><span class="small">c &larr; Dictionary new init: 64.<br></span><span class="tab"></span><span class="small">code &larr; 175.<br></span><span class="tab"></span><span class="small">for⦂ sel from: SpecialOops ◦(10 to: SpecialOops length) do⦂<br></span><span class="tab"></span><span class="tab"></span><span class="small">[ </span><span class="small italic">"Atoms not wanted here -- only strings and characters"</span><span class="small"><br></span><span class="tab"></span><span class="tab"></span><span class="small">code &larr; code+1.<br></span><span class="tab"></span><span class="tab"></span><span class="small">sel≡nil ⇒ []<br></span><span class="tab"></span><span class="tab"></span><span class="small">sel &larr; [sel length=1 and⦂ (sel◦1) isletter ≡ false ⇒ [sel◦1] sel asString].<br></span><span class="tab"></span><span class="tab"></span><span class="small">c insert: sel with: code.<br></span><span class="tab"></span><span class="tab"></span><span class="small">].<br></span><span class="tab"></span><span class="small">ByteCodes declare: ↪stdSelectors as: c.<br></span><span class="tab"></span><span class="small">c &larr; Dictionary new init: 8.<br></span><span class="tab"></span><span class="small">c insertall: ↪(&rsquo;while⦂do⦂&rsquo; &rsquo;until⦂do⦂&rsquo; &rsquo;for⦂to:do⦂&rsquo; &rsquo;for⦂from:do⦂&rsquo; &rsquo;for⦂from:to:by:do⦂&rsquo; &rsquo;for⦂from:to:do⦂&rsquo; &rsquo;if⦂then⦂else⦂&rsquo; &rsquo;if⦂then⦂&rsquo;)<br></span><span class="tab"></span><span class="tab"></span><span class="small">with: ↪(whiledo:args: untildo:args: fortodo:args: forfromdo:args: forfromtobydo:args: forfromtodo:args: ifthenelse:args: ifthen:args:).<br></span><span class="tab"></span><span class="small">ByteCodes declare: ↪inLineMsgs as: c.<br></span><span class="tab"></span><span class="small">for⦂ t from: ↪((toLoadFieldLong 0210) (toLoadTempLong 0211) (toLoadLitLong 0212)<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">(toLoadLitIndLong 0213) (toSendLitLong 0214)<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">(codeLoadField 0400) (codeLoadTemp 01000) (codeLoadLit 01400)<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">(codeLoadLitInd 02000) (codeSendLit 02400)) do⦂<br></span><span class="tab"></span><span class="tab"></span><span class="small">[ByteCodes declare: t◦1 as: t◦2]]</span></div>
<div class="line left">
<span class="small bold">oopsToFile </span><span class="small">| a c i t s cs f ts<br></span><span class="tab"></span><span class="small">[f &larr; dp0 file: &rsquo;oops&rsquo;.<br></span><span class="tab"></span><span class="small">cs &larr; user classNames transform⦂ a to⦂ Smalltalk◦a.<br></span><span class="tab"></span><span class="small">t &larr; cs transform⦂ a to⦂ a asOop.<br></span><span class="tab"></span><span class="small">ts &larr; t permutationToSort.<br></span><span class="tab"></span><span class="small">for⦂ i from: ts do⦂<br></span><span class="tab"></span><span class="tab"></span><span class="small">[f append: (t◦i) base8; tab; append: (cs◦i) title; cr].<br></span><span class="tab"></span><span class="small">for⦂ c from: cs◦ts do⦂<br></span><span class="tab"></span><span class="tab"></span><span class="small">[f cr; append: c title; cr.<br></span><span class="tab"></span><span class="tab"></span><span class="small">s &larr; c md contents.</span><span class="tab"></span><span class="small italic">"selectors"</span><span class="small"><br></span><span class="tab"></span><span class="tab"></span><span class="small">t &larr; s transform⦂ a to⦂ (c md method: a) asOop.  </span><span class="small italic">"method oops"</span><span class="small"><br></span><span class="tab"></span><span class="tab"></span><span class="small">for⦂ i from: t permutationToSort do⦂<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">[f tab; append: (t◦i) base8; tab; append: s◦i; cr]<br></span><span class="tab"></span><span class="tab"></span><span class="small">user show: c title; cr]<br></span><span class="tab"></span><span class="small">f close]</span></div>
<div class="line left">
<span class="small bold">printCrossReference: classNames on: f </span><span class="small">| dict m md frame l each s class<br>"user displayoffwhile⦂ [<br></span><span class="tab"></span><span class="small">user printCrossReference: user classNames<br></span><span class="tab"></span><span class="tab"></span><span class="small">on: (dp0 file: &rsquo;CrossReference.Press&rsquo;)].<br><br></span><span class="tab"></span><span class="tab"></span><span class="small">user classNames<br></span><span class="tab"></span><span class="tab"></span><span class="small">(SystemOrganization category: &rsquo;xyz&rsquo;)<br></span><span class="tab"></span><span class="tab"></span><span class="small">↪(class1 class2)"<br><br></span><span class="tab"></span><span class="small">[dict &larr; Dictionary init: 200.<br></span><span class="tab"></span><span class="small">for⦂ m to: 32 do⦂<br></span><span class="tab"></span><span class="tab"></span><span class="small">[dict insert: SpecialOops◦(9+m) with: ↪((Primitives) ()) copy].<br></span><span class="tab"></span><span class="small">classNames transform⦂ each to⦂<br></span><span class="tab"></span><span class="tab"></span><span class="small">[user show: each; space.<br></span><span class="tab"></span><span class="tab"></span><span class="small">md&larr; (Smalltalk◦each) md.<br></span><span class="tab"></span><span class="tab"></span><span class="small">for⦂ m from: md do⦂</span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small italic">"Tally all the UniqueString literals"</span><span class="small"><br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">[</span><span class="tab"></span><span class="small">[s&larr; dict lookup: m⇒[] dict insert: m with: (s&larr; ↪(()()) copy)].<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">s◦1 has: each⇒[] s◦1&larr; s◦1, each.<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">for⦂ l from: (md literals: m) do⦂<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">[l is: UniqueString⇒<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">[</span><span class="tab"></span><span class="small">[s&larr; dict lookup: l⇒[] dict insert: l with: (s&larr; ↪(()()) copy)].<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">s◦2 has: each⇒[] s◦2&larr; s◦2, (each,m)]]]].<br><br></span><span class="tab"></span><span class="small">f&larr; f asPressPrinter.<br></span><span class="tab"></span><span class="small">f stamp.<br></span><span class="tab"></span><span class="small">frame&larr; f defaultframe.</span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small italic">"Print the messages out sorted"</span><span class="small"><br></span><span class="tab"></span><span class="small">for⦂ m from: dict contents sort do⦂<br></span><span class="tab"></span><span class="tab"></span><span class="small">[user show: m; space.<br></span><span class="tab"></span><span class="tab"></span><span class="small">f frame&larr; frame.<br></span><span class="tab"></span><span class="tab"></span><span class="small">md&larr; dict◦m.<br></span><span class="tab"></span><span class="tab"></span><span class="small">s&larr; (String new: 200) asStream.<br></span><span class="tab"></span><span class="tab"></span><span class="small">s append: m; append: [(md◦1) length=0⇒[&rsquo; ( - undefined -  &rsquo;] &rsquo; (&rsquo;].<br></span><span class="tab"></span><span class="tab"></span><span class="small">for⦂ l from: (md◦1) sort do⦂ [s append: l; append: &rsquo;, &rsquo;].<br></span><span class="tab"></span><span class="tab"></span><span class="small">s skip: ¬2; append: &rsquo;)&rsquo;.<br></span><span class="tab"></span><span class="tab"></span><span class="small">f print: (s contents asParagraph maskrun: 1 to: m length under: 1 to: 1).<br></span><span class="tab"></span><span class="tab"></span><span class="small">f frame&larr; (frame minX+500)⌾frame minY rect: frame corner.<br></span><span class="tab"></span><span class="tab"></span><span class="small">s reset.<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">[md◦1 has: ↪Primitives⇒[s append: &rsquo;untallied.&rsquo;. md◦2&larr; ↪()]<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">(md◦2) length=0⇒[s append: &rsquo;- unreferenced -&rsquo;]].<br></span><span class="tab"></span><span class="tab"></span><span class="small">class&larr; ↪-.<br></span><span class="tab"></span><span class="tab"></span><span class="small">for⦂ l from: (md◦2) sort do⦂<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">[</span><span class="tab"></span><span class="small">[l◦1=class⇒[s append: &rsquo;, &rsquo;]<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">[class≠↪-⇒[s cr]]. s append: &rsquo;(&rsquo;; append: l◦1; append: &rsquo;) &rsquo;.<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">class&larr; l◦1].<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">s append: l◦2].<br></span><span class="tab"></span><span class="tab"></span><span class="small">f print: s contents asParagraph].<br></span><span class="tab"></span><span class="small">f close; toPrinter]</span></div>
<div class="line left">
<span class="small bold">purgealittle </span><span class="small">[] primitive: 89</span></div>
<div class="line left">
<span class="small bold">reclaim </span><span class="small">| c cl cv</span><span class="tab"></span><span class="tab"></span><span class="small">" Should only be called from bugScreenMenu !! "<br></span><span class="tab"></span><span class="small">[user cr; show: &rsquo;Reclaiming... &rsquo;.<br></span><span class="tab"></span><span class="small">cl&larr; CodePane, ScrollBar, PanedWindow, ListPane, Generator, Parser, BitImage, Document, DocumentEditor, Image.<br></span><span class="tab"></span><span class="small">cv&larr; Context allInstances.<br></span><span class="tab"></span><span class="small">user print: cv length.<br></span><span class="tab"></span><span class="small">for⦂ c from: cv do⦂ [cl has: c mclass⇒[c release]]. cv all&larr; nil.<br></span><span class="tab"></span><span class="small">user show: &rsquo; reduced to &rsquo; + Context howMany asString + &rsquo;.&rsquo;]</span></div>
<div class="line left">
<span class="small bold">release </span><span class="small">| m [<br></span><span class="tab"></span><span class="small">"</span><span class="small italic">prepare to release this version</span><span class="small"> (</span><span class="small bold underline">after</span><span class="small"> editing </span><span class="small bold">UserView version</span><span class="small">)<br></span><span class="tab"></span><span class="small">and possibly copying Sources file (see </span><span class="small bold">writeSources:</span><span class="small">)"<br><br></span><span class="tab"></span><span class="small">(m&larr; Undeclared contents) length&gt;0⇒<br></span><span class="tab"></span><span class="tab"></span><span class="small">[user notify: &rsquo;Undeclared contains &rsquo;+ m asString]<br><br></span><span class="tab"></span><span class="small">user displayoffwhile⦂ [<br></span><span class="tab"></span><span class="tab"></span><span class="small">"</span><span class="small italic">either create a new Sources file (write all messages) or append only changes</span><span class="small">"<br></span><span class="tab"></span><span class="tab"></span><span class="small">m &larr; Sources directory checkName:<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">&rsquo;&lt;Smalltalk&gt;Smalltalk.Sources.&rsquo; + user versionName.<br></span><span class="tab"></span><span class="tab"></span><span class="small">"for repeated releases in same version.<br></span><span class="tab"></span><span class="tab"></span><span class="small">should also work for Sources local (if renamed)"<br></span><span class="tab"></span><span class="tab"></span><span class="small">user writeSources: [m = Sources name⇒ [Sources] Sources directory file: m].<br><br></span><span class="tab"></span><span class="tab"></span><span class="small">"</span><span class="small italic">make workspace local</span><span class="small">"<br></span><span class="tab"></span><span class="tab"></span><span class="small">UserView md code: ↪workspace &larr; UserView code: ↪workspace.<br></span><span class="tab"></span><span class="small"><br></span><span class="tab"></span><span class="tab"></span><span class="small">user writeChangedMessages: (phylum file: &rsquo;&lt;Smalltalk&gt;ChangedMessages&rsquo;).].<br><br></span><span class="tab"></span><span class="small">user noChanges. user releaseMessage.]</span></div>
<div class="line left">
<span class="small bold">releaseMessage </span><span class="small">[user clearshow: &rsquo;Welcome to &rsquo; + user version]</span></div>
<div class="line left">
<span class="small bold">systemStartup </span><span class="small italic">"To do after system flush and installation of new core image"</span><span class="small"><br></span><span class="tab"></span><span class="small">[Top top.<br></span><span class="tab"></span><span class="small">Window classInit.<br><br></span><span class="tab"></span><span class="small italic">"The following screen extent seems to really fill the screen in x,<br></span><span class="tab"></span><span class="small italic">the Alto Hardware Manual to the contrary notwithstanding."</span><span class="small"><br></span><span class="tab"></span><span class="small">[self hasXM⇒ ["</span><span class="small italic">XM</span><span class="small">" self screenextent: 640⌾800 tab: 0⌾2]<br></span><span class="tab"></span><span class="small">self screenextent: 640⌾480 tab: 0⌾50].<br><br></span><span class="tab"></span><span class="small">Sources release. dp0 release. dp1 release.<br></span><span class="tab"></span><span class="small">self releaseExternalViews.<br></span><span class="tab"></span><span class="small">[E≡nil⇒ [] "</span><span class="small italic">ignore broadcasts</span><span class="small">" E broadcastFilter: true].<br><br></span><span class="tab"></span><span class="small">(VirtualMemory new) thisvmem.<br></span><span class="tab"></span><span class="small">Vmem afterBirth]</span></div>
<div class="line left">
<span class="small bold">systemworkspace1</span><span class="tab"></span><span class="tab"></span><span class="small">"</span><span class="small italic">for system releasers only!!!<br><br>this has been partitioned into three workspaces for editing convenience:<br></span><span class="tab"></span><span class="small italic">systemworkspace1<br></span><span class="tab"></span><span class="tab"></span><span class="small italic">steps 0-4: general comments, handling Sources, creating a release.<br></span><span class="tab"></span><span class="small italic">systemworkspace2<br></span><span class="tab"></span><span class="tab"></span><span class="small italic">steps 5-7: doing a vmem write or surgery, storing finished files on Phylum<br></span><span class="tab"></span><span class="small italic">systemworkspace3<br></span><span class="tab"></span><span class="tab"></span><span class="small italic">step 8: after a release, e.g. updating press files</span><span class="small"><br><br><br></span><span class="small bold">0.</span><span class="small italic"> This boot file should be named small.boot for vmem writing, surgery, and command file purposes.  If you made changes to the Sources disk be sure to update the current versions of (Xm)Smalltalk.Run, (Xm)Smalltalk.Syms, and (Xm)Byterp.mb on [Ivy]&lt;Smalltalk&gt;. This procedure works best on a Dorado for speed and disk space reasons, and it also can be done on an Alto (double disk O.S. required for vmem write).  Microcode changes (including making non-xm versions) must(?) be done on an Alto.  Step 5 (vmem writing) assumes enough space for another boot file.  To turn off display during execution, hold down left shift key while selecting &rsquo;doit&rsquo;.<br><br>For those who want to vmem write their own versions, do not execute steps 4, 7 or 8 without further editing of file and directory names. </span><span class="small italic underline">Underlined items</span><span class="small italic"> are typical values and normally must be edited to be useful.<br><br></span><span class="small"><br></span><span class="small bold">1.</span><span class="small italic"> to create an xm version:  filin changes and selected goodies. Undeclared must be empty for release to work (step 4). copy the categories of classes which have changed to systemworkspace3 (for later printing) and recompile it.<br></span><span class="tab"></span><span class="small">dp0 filin: ↪(&rsquo;</span><span class="small underline">changes.st</span><span class="small">&rsquo;).<br></span><span class="tab"></span><span class="small">phylum filin: ↪(&rsquo;&lt;Small-goodies&gt;</span><span class="small underline">xx.st</span><span class="small">&rsquo;).<br></span><span class="tab"></span><span class="small">Undeclared contents inVector, user changedCategories<br><br><br></span><span class="small bold">2.</span><span class="small italic"> update version number/letter and comments in UserView version<br><br><br></span><span class="small bold">3.</span><span class="small italic"> the Sources file will be ordinarily be created in step 4. if only a few changes are involved, it may be somewhat faster to copy the old sources file to the new sources file (this step). then step 4 will only append changes.<br></span><span class="tab"></span><span class="small">phylum store: Sources reset as: &rsquo;Smalltalk.Sources.&rsquo; + user versionName.<br><br></span><span class="small italic"><br></span><span class="small bold">4. </span><span class="small italic">checks Undeclared, writes all or appends changed messages to Sources file, updates ChangedMessages, inits Changes, puts up greeting, and sets the default user name & password. note: this is only to be executed for releasing the Smalltalk system itself (supply the proper password!!). if you plan to do a vmem write next, better to do this as first line of step 5.<br></span><span class="tab"></span><span class="small">user releaseExternalViews.<br></span><span class="tab"></span><span class="small">phylum name: &rsquo;Smalltalk&rsquo; password: &rsquo;</span><span class="small underline">password</span><span class="small">&rsquo;.<br></span><span class="tab"></span><span class="small">user release.<br></span><span class="tab"></span><span class="small">phylum name: &rsquo;Smalltalk-User&rsquo; password: &rsquo;Smalltalk&rsquo;.<br><br></span><span class="tab"></span><span class="small italic">to write out the sources for a private version, specify which directory to use (don&rsquo;t leave Smalltalk as the default) and which categories and/or classes are to be included.<br></span><span class="tab"></span><span class="small">| c classes. user releaseExternalViews. classes &larr; (Vector new: 50) asStream.<br></span><span class="tab"></span><span class="small">phylum name: &rsquo;</span><span class="small underline">name</span><span class="small">&rsquo; password: &rsquo;</span><span class="small underline">password</span><span class="small">&rsquo;.<br></span><span class="tab"></span><span class="small">for⦂ c from: ↪(</span><span class="small underline">&rsquo;category1&rsquo; class1</span><span class="small">) do⦂ [<br></span><span class="tab"></span><span class="tab"></span><span class="small">c is: String⇒ [classes append: (SystemOrganization category: c)]<br></span><span class="tab"></span><span class="tab"></span><span class="small">classes next &larr; c].<br></span><span class="tab"></span><span class="small">user file: (phylum file: &rsquo;</span><span class="small underline">&lt;ddd&gt;xx</span><span class="small">.Sources.&rsquo; + user versionName)<br></span><span class="tab"></span><span class="tab"></span><span class="small">classes: classes contents changesOnly: false.<br>"</span></div>
<div class="line left">
<span class="small bold">systemworkspace2</span><span class="tab"></span><span class="tab"></span><span class="small">"</span><span class="small italic">for system releasers only!!!<br><br><br></span><span class="small bold">5.</span><span class="small italic"> if no surgery or vmem write involved, skip to step 7. start here with an xm version to make a non-xm version.  specify option below:<br></span><span class="tab"></span><span class="small italic">1 vmem write (includes xm surgery)<br></span><span class="tab"></span><span class="small italic">2 xm surgery<br></span><span class="tab"></span><span class="small italic">3 non-xm surgery<br>to make things totally automatic, edit in your valid Maxc name and password, otherwise Ftp will ask you later. in the case of surgery only, at the end you will have to hit a key after safing.<br></span><span class="small"><br></span><span class="tab"></span><span class="small">| option prefix dir file.<br>option &larr; </span><span class="small underline">1</span><span class="small">.<br>dir &larr; phylum asFtpDirectory.<br>dir directoryName: &rsquo;Smalltalk-76&rsquo;.<br>prefix &larr; [option=3⇒ [&rsquo;&rsquo;] &rsquo;Xm&rsquo;].<br>for⦂ file from: ↪(&rsquo;Smalltalk.Run&rsquo; &rsquo;Smalltalk.Syms&rsquo; &rsquo;Byterp.Mb&rsquo;) do⦂ [<br></span><span class="tab"></span><span class="small">dir retrieve: prefix + file as: file].<br>dir closeThen: ([option=1⇒ [&rsquo;delete oldsmall.boot;<br>copy newsmall.boot &larr; small.boot; &rsquo;] &rsquo;&rsquo;]) + <br>&rsquo;ftp maxc Login/c </span><span class="small underline">yourname yourpassword</span><span class="small"> directory/c alto retrieve/c packmu.run ramload.run;<br>Resume small.boot;<br>Ramload/N Byterp.mb/F 1000/A;<br>Smalltalk.run&rsquo;.<br><br>option=1⇒ [(VirtualMemory new) giveBirth3. user quit]<br>Vmem ramwrite: (dp0 oldFile: &rsquo;byterp.mb&rsquo;).<br>Vmem surgery: (dp0 oldFile: &rsquo;Smalltalk.run&rsquo;).<br><br><br></span><span class="small bold">6</span><span class="small italic">. after a successful vmem write or surgery, execute this (selecting here is tricky or type in a Dispframe)<br></span><span class="tab"></span><span class="small">user systemStartup.<br><br><br></span><span class="small bold">7</span><span class="small italic">. edit lastversion (and Smalltalk password) and execute the following, then close this window (clean up screen for non-xm?), and quit. it then renames old versions of files, stores new versions of files, e.g. remote XmSmall.Boot becomes XmSmall.Boot.5.5g and local Small.Boot becomes remote XmSmall.Boot<br></span><span class="tab"></span><span class="small">| lastversion dir file remotefile.<br></span><span class="tab"></span><span class="small">lastversion &larr; &rsquo;</span><span class="small underline">5.5j</span><span class="small">&rsquo;.<br></span><span class="tab"></span><span class="small">dir &larr; phylum asFtpDirectory.<br></span><span class="tab"></span><span class="small">dir login: &rsquo;Smalltalk&rsquo; password: &rsquo;</span><span class="small underline">password</span><span class="small">&rsquo;.<br></span><span class="tab"></span><span class="small">for⦂ file from: ↪(&rsquo;Small.Boot&rsquo; &rsquo;Smalltalk.Syms&rsquo;) do⦂ [<br></span><span class="tab"></span><span class="tab"></span><span class="small">remotefile &larr; ([user hasXM⇒ [&rsquo;Xm&rsquo;] &rsquo;&rsquo;]) + file.<br></span><span class="tab"></span><span class="tab"></span><span class="small">dir rename: remotefile newName: remotefile + &rsquo;.&rsquo; + lastversion;<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">store: file as: remotefile].<br></span><span class="tab"></span><span class="small">(dp0 file: &rsquo;rem.cm&rsquo;) append: dir commands; cr; close.<br></span><span class="tab"></span><span class="small">user releaseMessage.<br>"</span></div>
<div class="line left">
<span class="small bold">systemworkspace3</span><span class="tab"></span><span class="tab"></span><span class="small">"</span><span class="small italic">for system releasers only!!!<br></span><span class="small"><br><br></span><span class="small bold">8.</span><span class="small italic"> to update press files for system categories or cross reference listing directly on Phylum, browse or spawn this window.  edit pf to specify a list of system categories to print, usually from step 1, e.g. user changedCategories: ↪(&rsquo;Basic Data Structures&rsquo; ...) or SystemOrganization categories (for all); delete toPrinter if you don&rsquo;t want the press files printed. edit xref to be user classNames if you want to generate a cross reference listing.<br></span><span class="tab"></span><span class="small"> | pf xref cat.<br></span><span class="tab"></span><span class="small">pf &larr; </span><span class="small underline">↪  (&rsquo;Text Objects&rsquo; &rsquo;Kernel Classes&rsquo; &rsquo;Press File Support&rsquo; &rsquo;IFS File System&rsquo; &rsquo;Alto File System&rsquo; &rsquo;Panes and Menus&rsquo; &rsquo;Files&rsquo; &rsquo;Juniper&rsquo; &rsquo;Windows&rsquo; &rsquo;Graphical Objects&rsquo; &rsquo;Numbers&rsquo; &rsquo;Basic Data Structures&rsquo; )</span><span class="small">.<br></span><span class="tab"></span><span class="small">xref &larr; </span><span class="small underline">↪()</span><span class="small">.<br><br></span><span class="tab"></span><span class="small">user releaseExternalViews.<br></span><span class="tab"></span><span class="small">phylum name: &rsquo;Smalltalk&rsquo; password: &rsquo;</span><span class="small underline">password</span><span class="small">&rsquo;.<br></span><span class="tab"></span><span class="small">for⦂ cat from: pf do⦂ [<br></span><span class="tab"></span><span class="tab"></span><span class="small">((phylum file: (cat + &rsquo;.Press&rsquo;) asFileName) asPressPrinter) stamp;<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">printclass: (SystemOrganization category: cat); close</span><span class="small underline">; toPrinter</span><span class="small">].<br></span><span class="tab"></span><span class="small">xref empty⇒ []<br></span><span class="tab"></span><span class="small">user printCrossReference: xref on: (phylum file: &rsquo;CrossReference.Press&rsquo;).<br>"</span></div>
<div class="line left">
<span class="small bold">version </span><span class="small">[⇑&rsquo;Smalltalk </span><span class="small bold">5.5k</span><span class="small"> &rsquo; + [user hasXM⇒ [&rsquo;XM &rsquo;] &rsquo;&rsquo;] + &rsquo;</span><span class="small bold">November 24</span><span class="small">&rsquo;]<br>"user version<br><br>low level disk address calculations are more general (necessary for 14-sector Dorado/Dolphin file systems)<br>better error recovery for broken and timed out Leaf connections<br>AltoFileDirectory disk page allocation/deallocation bugs fixed<br>miscellaneous printing fixes<br>Juniper fixes (2)<br>goodie: again-del-forget.st<br>create/write dates on boot file are updated at quit time<br>primitives for reading/writing 3K CRAM<br>Phylum account changes <br></span><span class="tab"></span><span class="small">default Leaf connection is logged in to &lt;Smalltalk-User&gt;<br></span><span class="tab"></span><span class="small">system release uses [Phylum]&lt;Smalltalk-76&gt; instead of [Ivy]&lt;Smalltalk&gt;<br>see UserView workspace for logging into your account on Phylum, changing default printer -- for information on [Phylum]&lt;Smalltalk&gt;Release-5.5k.Bravo, .Press<br><br></span><span class="small bold">September 3, 5.5j<br></span><span class="tab"></span><span class="small">duplicate packet fix<br></span><span class="tab"></span><span class="small">fixes to ether (routing table, name lookup, phylum, Int32), printer names,<br></span><span class="tab"></span><span class="tab"></span><span class="small">files, UserView time messages, context simulation,<br></span><span class="tab"></span><span class="tab"></span><span class="small">replace in BitBlt & Paragraph, NotifyWindow cleanup,<br></span><span class="tab"></span><span class="tab"></span><span class="small">Class code: always decompiles with left shift key, window printing fixes,<br></span><span class="tab"></span><span class="tab"></span><span class="small">SystemOrganization globalComment contains no nulls<br></span><span class="tab"></span><span class="small">the following changes files were included:<br></span><span class="tab"></span><span class="small">[phylum]&lt;small-goodies&gt;<br></span><span class="tab"></span><span class="tab"></span><span class="small">5.5i.changes.st, notifychange.st, window-print-changes.st<br></span><span class="tab"></span><span class="small">[phylum]&lt;findit&gt;5.5i.more.changes.st<br></span><span class="tab"></span><span class="small">[maxc]&lt;dolbec&gt;int32change.st<br></span><span class="tab"></span><span class="small">[maxc&gt;ingalls&gt;fixes.st<br></span><span class="tab"></span><span class="small">[ivy]&lt;kaehler&gt;context-simulation.st<br></span><span class="tab"></span><span class="small">[ivy]&lt;borning&gt;context-changes.st<br><br></span><span class="small bold">May 1, 5.5i<br></span><span class="tab"></span><span class="small">obscure file bugs eliminated; version features added (goody: File-version.st).<br></span><span class="tab"></span><span class="small">Ifs multiple connections fixed; Ifs error numbers looked up in Ifs.Errors.<br></span><span class="tab"></span><span class="small">duplicate packets eliminated at lowest level.<br></span><span class="tab"></span><span class="small">Int32 primitive fix. Juniper retransmit parameters increased<br></span><span class="tab"></span><span class="small">Integer compare: LargeInteger now works<br></span><span class="tab"></span><span class="small">CodePane/FilePane &rsquo;print&rsquo; (within a CodeWindow) now prints entire Paragraph<br></span><span class="tab"></span><span class="tab"></span><span class="small">rather than only part within window<br></span><span class="tab"></span><span class="small">ScrollBars hide during CodePane </span><span class="small italic">again & cancel</span><span class="small">. </span><span class="small italic">cancel</span><span class="small"> saves your old text, so<br></span><span class="tab"></span><span class="tab"></span><span class="small">an immediate </span><span class="small italic">undo</span><span class="small"> will replace the current selection with your previous text.<br><br></span><span class="small bold">April 11, 5.5h<br></span><span class="tab"></span><span class="small">Alto file names limited to 39 characters (&rsquo;somestring&rsquo; asFileName will fix<br></span><span class="tab"></span><span class="tab"></span><span class="small">name, truncating if necessary). other misc. file, ether, simulator fixes.<br></span><span class="tab"></span><span class="small">BitBlt fixed so that BitRects don&rsquo;t lose their bits<br></span><span class="tab"></span><span class="small">BitBlt used to speedup reading&writing files, sending Press files to printers<br></span><span class="tab"></span><span class="small">ParagraphScanner puts underlining into Press files<br></span><span class="tab"></span><span class="small">printer names updated (PressFile classInit). hashing-changes.st included.<br></span><span class="tab"></span><span class="small">after font cataclysm, get new version of Fonts.Widths before printing<br></span><span class="tab"></span><span class="small">system release procedure modified<br><br></span><span class="small bold">March 6, 5.5g</span><span class="small"><br></span><span class="tab"></span><span class="small">ether, file, vmem writing fixes.  cursor clipping on screen boundary.<br></span><span class="tab"></span><span class="small">BitBlt used for String growing, copying, replacing<br></span><span class="tab"></span><span class="small">goodies included: display-off-after-notify.st, CodePane-doit.st,<br></span><span class="tab"></span><span class="tab"></span><span class="small">context-simfix2.st, ILchanges.st, string-changes.st<br><br>see [Phylum]&lt;Smalltalk&gt; for the following files.  () surround an optional prefix or suffix.<br></span><span class="tab"></span><span class="small">Document.Press<br></span><span class="tab"></span><span class="tab"></span><span class="small">mini-guide to Smalltalk system and user interface<br></span><span class="tab"></span><span class="small">VersionHistory<br></span><span class="tab"></span><span class="tab"></span><span class="small">information about versions up to 5.5g<br></span><span class="tab"></span><span class="small">ChangedMessages<br></span><span class="tab"></span><span class="tab"></span><span class="small">a list of  messages which have changed<br></span><span class="tab"></span><span class="small">xxx.Press<br></span><span class="tab"></span><span class="tab"></span><span class="small">press file for CrossReference or for system category &rsquo;xxx&rsquo; in current version<br></span><span class="tab"></span><span class="tab"></span><span class="small">to save paper, consider consulting the LRG alcove copies<br></span><span class="tab"></span><span class="small">(Xm)Small.Boot(.version)<br></span><span class="tab"></span><span class="small">(Xm)Smalltalk.Syms(.version)<br></span><span class="tab"></span><span class="tab"></span><span class="small">older versions of .Boot and .Syms are explicitly named.<br></span><span class="tab"></span><span class="small">Smalltalk.Sources.version<br></span><span class="tab"></span><span class="tab"></span><span class="small">all Smalltalk.Sources (including the current one) are explicitly named<br><br>[Phylum]&lt;Small-Goodies&gt; contains miscellaneous bug fixes and new features (and even some documentation: goodies.bravo, .press) offered by the community of Smalltalk Users.<br>"</span></div>
<div class="line left">
<span class="small bold">versionName </span><span class="small">| s [<br></span><span class="tab"></span><span class="small">s &larr; self version asStream.<br></span><span class="tab"></span><span class="small">"skip Smalltalk"<br></span><span class="tab"></span><span class="small">s skipTo: 040.<br></span><span class="tab"></span><span class="small">"return version identification, e.g. 5.5f"<br></span><span class="tab"></span><span class="small">⇑s upto: 040]</span></div>
<div class="line center">
<span class="small bold">workspace<br></span><span class="tab"></span><span class="small">[user notify: &rsquo;Not meant to be executed&rsquo;]<br>"<br></span><span style="font: 18pt monospace">XEROX</span><span class="small"> - </span><span class="small bold">Learning Research Group</span><span class="small"><br> <br>user screenextent: 640⌾580 tab: 0⌾50.<br>NotifyFlag &larr; true.</span><span class="small italic"><br></span><span class="small">Changes init.<br>user changedMessages<br>user changedClasses<br>user changedCategories<br>Undeclared contents<br></span><span class="small italic"><br>to set the default printer</span><span class="small"><br>PrinterName&larr;&rsquo;Menlo&rsquo;.<br>PrinterName&larr;(PressFile new) selectPrinter: PrinterName.<br><br></span><span class="small italic">to change phylum to access your account<br></span><span class="small">user releaseExternalViews. phylum name: &rsquo;name&rsquo; password: &rsquo;password&rsquo;.<br><br>dp0 filin: ↪(&rsquo;Changes.st&rsquo;).<br>(dp0 file: &rsquo;changes.st&rsquo;) filout.<br>(dp0 file: &rsquo;xxx&rsquo;) edit.<br>dp0 pressfilin: ↪(&rsquo;xxx.press&rsquo;).<br>(dp0 filesMatching: &rsquo;*.st&rsquo;) sort<br>dp0 list. dp0 freePages<br>dp0 delete: &rsquo;old&rsquo;<br>dp0 rename: &rsquo;old&rsquo; newName: &rsquo;new&rsquo;<br><br></span><span class="small italic">for reinitializing Sources and phylum<br></span><span class="small">Sources release. phylum release. Sources reopen.<br><br></span><span class="small italic">to make Smalltalk Sources local</span><span class="small"><br> | s. s &larr; &rsquo;Smalltalk.Sources.&rsquo;.<br>(phylum asFtpDirectory) retrieve: &rsquo;&lt;Smalltalk&gt;&rsquo; + s + user versionName as: s; close.<br>Sources on: (dp0 file: s).<br><br></span><span class="small italic">to switch back to remote Sources</span><span class="small"><br>Sources close; on: (phylum file: &rsquo;&lt;Smalltalk&gt;Smalltalk.Sources.&rsquo; + user versionName).<br><br><br></span><span class="small italic">to filin a remote Smalltalk file</span><span class="small"><br>phylum filin: ↪(&rsquo;&lt;Small-goodies&gt;xxx.st&rsquo;).<br><br></span><span class="small italic">to print a remote/local press file</span><span class="small"><br>(phylum pressfile: &rsquo;&lt;Smalltalk&gt;xxx.press&rsquo;) toPrinter.<br>(dp0 pressfile: &rsquo;xxx.press&rsquo;) toPrinter: &rsquo;Lilac&rsquo;.<br><br>File noChanges.<br>BitRect new fromuser; edit.<br>user schedule: (defaultBitRectEditor newframe).<br><br>DocumentEditor new defaultdocument: &rsquo;test&rsquo;.<br>DocumentEditor new init: (Document new fromPress: &rsquo;test.document&rsquo;).<br><br></span><span class="small italic"><br></span><span class="small">user releaseExternalViews.<br>E sleep. E kill. E &larr; nil.<br>E &larr; Etherworld new. E broadcastFilter: true. E wakeup.<br>Sources reopen.<br><br></span><span class="small italic">for primary Smalltalk access to file servers and printers at other sites.<br>substitute yourserver for phylum above, compile this workspace<br></span><span class="small">PrinterName &larr; &rsquo;name-of-your-printer&rsquo;.<br>Smalltalk declare: ↪yourserver.<br>yourserver &larr; ILFileDirectory new directory: &rsquo;name-of-your-server&rsquo;.<br>yourserver name: &rsquo;Smalltalk-User&rsquo; password: &rsquo;Smalltalk&rsquo;.<br>Sources on: (yourserver file: &rsquo;&lt;Smalltalk&gt;Smalltalk.Sources.&rsquo; + user versionName).<br>Changes init.<br><br>user Swat.<br>"</span></div>
<div class="line left">
<span class="small bold">writeChangedMessages: ChangedMessages </span><span class="small">| class m ms [<br></span><span class="tab"></span><span class="small">"append changed messages to a file (usually on [phylum])"<br></span><span class="tab"></span><span class="small">ChangedMessages settoend; cr; cr; asParagraphPrinter stamp.<br></span><span class="tab"></span><span class="small">class &larr; &rsquo;&rsquo;.<br></span><span class="tab"></span><span class="small">for⦂ m from: user changedMessages do⦂<br></span><span class="tab"></span><span class="tab"></span><span class="small">[ms&larr; m asStream.<br></span><span class="tab"></span><span class="tab"></span><span class="small">(ms upto: 040)=class⇒<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">[ChangedMessages append: &rsquo;, &rsquo;; append: (ms upto: 040)]<br></span><span class="tab"></span><span class="tab"></span><span class="small">ChangedMessages cr; append: m.<br></span><span class="tab"></span><span class="tab"></span><span class="small">class&larr; m asStream upto: 040].<br></span><span class="tab"></span><span class="small">ChangedMessages close]</span></div>
<div class="line left">
<span class="small bold">writeSources: newSources </span><span class="small">[<br></span><span class="tab"></span><span class="small">"write a new Sources file (usually on [phylum]Smalltalk.Sources.xxx<br></span><span class="tab"></span><span class="tab"></span><span class="small">(i.e. xxx = user versionName))<br></span><span class="tab"></span><span class="small">if it&rsquo;s a new file or empty, write all Sources. otherwise it better be a copy of<br></span><span class="tab"></span><span class="small">the previous Sources file (only changes will be appended. do the copy with ftp)"<br><br></span><span class="tab"></span><span class="small">user file: newSources classes: SystemOrganization<br></span><span class="tab"></span><span class="tab"></span><span class="small">changesOnly: (newSources end ≡ false).<br></span><span class="tab"></span><span class="small">Sources close.<br></span><span class="tab"></span><span class="small">Sources &larr; newSources]<br></span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪UserView under: &rsquo;Kernel Classes&rsquo;.</span></div>
<div class="line left">
<span class="small">UserView classInit</span></div>
<div style="width: 141pt; margin-left: 425pt; margin-top: 0pt; text-align: left">
<span class="medium bold"><br>"VariableLengthClass"</span></div>
<div class="line left">
<span class="medium bold">Class new title: &rsquo;VariableLengthClass&rsquo;<br></span><span class="tab"></span><span class="medium bold">subclassof: Class<br></span><span class="tab"></span><span class="medium bold">fields: &rsquo;&rsquo;<br></span><span class="tab"></span><span class="medium bold">declare: &rsquo;&rsquo;;<br></span><span class="tab"></span><span class="medium bold">veryspecial: 20;<br></span><span class="tab"></span><span class="medium bold">asFollows</span></div>
<div class="line left">
<span class="small italic"><br>I am a class whose instances have numbered elements instead of named fields.</span></div>
<div class="line left">
<span class="medium bold"><br>Initialization</span></div>
<div class="line left">
<span class="small bold">classInit</span><span class="tab"></span><span class="tab"></span><span class="small italic">"gets propagated to a dummy instance"</span><span class="small"><br></span><span class="tab"></span><span class="small">[(self new: 1) classInit]</span></div>
<div class="line left">
<span class="medium bold"><br>Instance access</span></div>
<div class="line left">
<span class="small bold">allInstances </span><span class="small">[user notify: &rsquo;use allInstances: instead to specify the length range&rsquo;<br></span><span class="tab"></span><span class="small italic">"the length ranges are 0,1,2,3,4,5,6,7,8 individually and groups 9 (to 16), 17 (to 32), 33 (to 64), 65, 129, 257, 513, 1025, 2049, and 4197"</span><span class="small">]</span></div>
<div class="line left">
<span class="small bold">allInstances: len </span><span class="small">[⇑(self allInstancesEver: len) notNil]</span></div>
<div class="line left">
<span class="small bold">allInstancesEver: len </span><span class="small">| indx vec PCLs i </span><span class="small italic">"returns a vector containing all instances of this class and length mixed with nils"</span><span class="small"><br></span><span class="tab"></span><span class="small">[</span><span class="small italic">"for large lengths, instances come in groups with lengths within a single power of 2"</span><span class="small"><br></span><span class="tab"></span><span class="small">PCLs &larr; Vmem pclassesOf: self length: len.  </span><span class="small italic">"vector of PCLs"</span><span class="small"><br></span><span class="tab"></span><span class="small">vec &larr; Vector new: 128*PCLs length.<br></span><span class="tab"></span><span class="small">for⦂ i to: PCLs length do⦂ <br></span><span class="tab"></span><span class="tab"></span><span class="small">[(vec◦[i-1*128+1 to: i*128]) all&larr; PCLs◦i].<br></span><span class="tab"></span><span class="small">thisContext destroyAndReturn:<br></span><span class="tab"></span><span class="tab"></span><span class="small">(self fromFreelist: (Vmem freelistOffset: len) fill: vec)]</span></div>
<div class="line left">
<span class="small bold">copy: inst </span><span class="small">| t i<br></span><span class="tab"></span><span class="small">[t &larr; self new: inst length.<br></span><span class="tab"></span><span class="small">for⦂ i to: inst length do⦂<br></span><span class="tab"></span><span class="tab"></span><span class="small">[t◦i &larr; inst◦i]<br></span><span class="tab"></span><span class="small">⇑t]</span></div>
<div class="line left">
<span class="small bold">howMany: len </span><span class="small">| v </span><span class="small italic">"how many instances of this class and length are in use now?"</span><span class="small"><br></span><span class="tab"></span><span class="small">[v &larr; self allInstancesEver: len.<br></span><span class="tab"></span><span class="small">thisContext destroyAndReturn: v length - (v count: nil)]</span></div>
<div class="line left">
<span class="small bold">new<br></span><span class="tab"></span><span class="small">[user notify: &rsquo;use new: &lt;Integer=length&gt; here.&rsquo;]</span></div>
<div class="line left">
<span class="small bold">new: length<br></span><span class="tab"></span><span class="small">[length&gt;16384 ⇒[user notify: length asString+<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">&rsquo; is too big a String&rsquo;]<br></span><span class="tab"></span><span class="small">length&gt;8192 ⇒[user notify: length asString+<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">&rsquo; is too big a Vector&rsquo;]<br></span><span class="tab"></span><span class="small">length&lt;0 ⇒[user notify: length asString+<br></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="tab"></span><span class="small">&rsquo; -- negative length is invalid&rsquo;]<br></span><span class="tab"></span><span class="small">⇑self new: length asInteger] primitive: 29</span></div>
<div class="line left">
<span class="small bold">recopy: inst </span><span class="small">| t i<br></span><span class="tab"></span><span class="small">[t &larr; self new: inst length.<br></span><span class="tab"></span><span class="small">for⦂ i to: inst length do⦂<br></span><span class="tab"></span><span class="tab"></span><span class="small">[t◦i &larr; (inst◦i) recopy]<br></span><span class="tab"></span><span class="small">⇑t]</span></div>
<div class="line left">
<span class="small"></span></div>
<div class="line left">
<span class="small">SystemOrganization classify: ↪VariableLengthClass under: &rsquo;Kernel Classes&rsquo;.</span></div>
  </body>
</html>
